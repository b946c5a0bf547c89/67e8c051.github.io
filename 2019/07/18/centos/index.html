<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Linux | 无常无形无功;不动不破不空</title><meta name="keywords" content="centos"><meta name="author" content="寸劲"><meta name="copyright" content="寸劲"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="audit1234567891011121314151617181920212223242526272829$ auditctl -e0## &#x2F;etc&#x2F;audit&#x2F;auditd.conf$ systemctl start auditd$ auditctl -b 8192 #buff$ auditctl -f 2 # Set  failure  mode  0&#x3D;silent 1&#x3D;printk 2&#x3D;p">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux">
<meta property="og:url" content="http://yoursite.com/2019/07/18/centos/index.html">
<meta property="og:site_name" content="无常无形无功;不动不破不空">
<meta property="og:description" content="audit1234567891011121314151617181920212223242526272829$ auditctl -e0## &#x2F;etc&#x2F;audit&#x2F;auditd.conf$ systemctl start auditd$ auditctl -b 8192 #buff$ auditctl -f 2 # Set  failure  mode  0&#x3D;silent 1&#x3D;printk 2&#x3D;p">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg">
<meta property="article:published_time" content="2019-07-18T07:37:02.000Z">
<meta property="article:modified_time" content="2021-11-02T03:17:18.392Z">
<meta property="article:author" content="寸劲">
<meta property="article:tag" content="centos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg"><link rel="shortcut icon" href="/img/stout-shield.png"><link rel="canonical" href="http://yoursite.com/2019/07/18/centos/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-11-02 11:17:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="无常无形无功;不动不破不空" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/fighting-spiri-logot.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#audit"><span class="toc-number">1.</span> <span class="toc-text">audit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rsync-debug"><span class="toc-number">2.</span> <span class="toc-text">rsync debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chrome-enable-dns-over-https"><span class="toc-number">3.</span> <span class="toc-text">chrome enable dns over https</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call"><span class="toc-number">4.</span> <span class="toc-text">call</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#traceroute"><span class="toc-number">5.</span> <span class="toc-text">traceroute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mapping-file-to-loop-dev"><span class="toc-number">6.</span> <span class="toc-text">mapping file to loop dev</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vi-paste-not-auto-inherit-the-file-type"><span class="toc-number">7.</span> <span class="toc-text">vi paste not auto inherit the file type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ubuntu-20-04"><span class="toc-number">8.</span> <span class="toc-text">ubuntu 20.04</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#install-newer-glibc-deb-packages-and-apt-source-not-update-cause-the-deps-issue"><span class="toc-number">9.</span> <span class="toc-text">install newer glibc deb packages and apt source not update cause the deps issue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setup-vnc"><span class="toc-number">9.1.</span> <span class="toc-text">setup vnc</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#centos"><span class="toc-number">10.</span> <span class="toc-text">centos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#printk-messages"><span class="toc-number">10.1.</span> <span class="toc-text">printk messages</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#centos-7-7-not-report-kenrel-symbols"><span class="toc-number">10.2.</span> <span class="toc-text">centos 7.7 not report kenrel symbols</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kill-sockets"><span class="toc-number">10.3.</span> <span class="toc-text">kill sockets</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#compress-by-xz"><span class="toc-number">10.4.</span> <span class="toc-text">compress by xz</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#systemd-rc-local"><span class="toc-number">10.5.</span> <span class="toc-text">systemd rc.local</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#date"><span class="toc-number">10.6.</span> <span class="toc-text">date</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dd"><span class="toc-number">10.7.</span> <span class="toc-text">dd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#selinux"><span class="toc-number">10.8.</span> <span class="toc-text">selinux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Software-Collections-SCL-Repository"><span class="toc-number">10.9.</span> <span class="toc-text">Software Collections ( SCL ) Repository</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#centos-8"><span class="toc-number"></span> <span class="toc-text">centos 8</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nofile"><span class="toc-number">1.</span> <span class="toc-text">Nofile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pidstat"><span class="toc-number">2.</span> <span class="toc-text">pidstat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfsstat"><span class="toc-number">3.</span> <span class="toc-text">nfsstat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#user-space-pipe-size"><span class="toc-number">4.</span> <span class="toc-text">user space pipe size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rand-file"><span class="toc-number">5.</span> <span class="toc-text">rand file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#samba"><span class="toc-number">6.</span> <span class="toc-text">samba</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Account"><span class="toc-number">6.1.</span> <span class="toc-text">Account</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#config"><span class="toc-number">6.2.</span> <span class="toc-text">config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-status"><span class="toc-number">6.3.</span> <span class="toc-text">Show status</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update-kernel-moduels-in-lib-moduels-uname-r"><span class="toc-number">7.</span> <span class="toc-text">update kernel moduels in &#x2F;lib&#x2F;moduels&#x2F;$(uname -r)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#syscalls"><span class="toc-number">8.</span> <span class="toc-text">syscalls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filter-syslog"><span class="toc-number">9.</span> <span class="toc-text">filter syslog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xfs"><span class="toc-number">10.</span> <span class="toc-text">xfs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Check-fragmentation"><span class="toc-number">10.1.</span> <span class="toc-text">Check fragmentation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tmp-permission"><span class="toc-number">11.</span> <span class="toc-text">tmp permission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#taskset"><span class="toc-number">12.</span> <span class="toc-text">taskset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh"><span class="toc-number">13.</span> <span class="toc-text">ssh</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ssh-key-not-work"><span class="toc-number">13.1.</span> <span class="toc-text">ssh key not work</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssh-config-allow-users"><span class="toc-number">13.2.</span> <span class="toc-text">ssh config allow users</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#strace"><span class="toc-number">14.</span> <span class="toc-text">strace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Calculated-CPU-usage"><span class="toc-number">15.</span> <span class="toc-text">Calculated CPU usage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tuna"><span class="toc-number">16.</span> <span class="toc-text">tuna</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS-client"><span class="toc-number">17.</span> <span class="toc-text">NFS client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitor"><span class="toc-number">18.</span> <span class="toc-text">Monitor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ps"><span class="toc-number">18.1.</span> <span class="toc-text">ps</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#selinux-1"><span class="toc-number">19.</span> <span class="toc-text">selinux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handle-overflow-in-jiffies"><span class="toc-number">20.</span> <span class="toc-text">handle overflow in jiffies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prevent-the-data-be-deleted"><span class="toc-number">21.</span> <span class="toc-text">Prevent the data be deleted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#errno"><span class="toc-number">22.</span> <span class="toc-text">errno</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tc"><span class="toc-number">23.</span> <span class="toc-text">tc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VNC"><span class="toc-number">24.</span> <span class="toc-text">VNC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vncserer-was-runing-but-there-is-no-desktop-in-centos-7"><span class="toc-number">25.</span> <span class="toc-text">Vncserer was runing, but there is no desktop in centos 7</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#screen"><span class="toc-number">26.</span> <span class="toc-text">screen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VLC"><span class="toc-number">27.</span> <span class="toc-text">VLC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Not-show-media-title"><span class="toc-number">27.1.</span> <span class="toc-text">Not show media title</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Not-resize-interface"><span class="toc-number">27.2.</span> <span class="toc-text">Not resize interface</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grub"><span class="toc-number">28.</span> <span class="toc-text">grub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS"><span class="toc-number">29.</span> <span class="toc-text">NFS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nolock"><span class="toc-number">29.1.</span> <span class="toc-text">nolock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file-lock"><span class="toc-number">29.2.</span> <span class="toc-text">file lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-could-I-found-which-file-cause-pipe-hang"><span class="toc-number">30.</span> <span class="toc-text">How could I found which file cause pipe hang</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#If-pipe-change-to-socket"><span class="toc-number">30.1.</span> <span class="toc-text">If pipe change to socket</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcpdump"><span class="toc-number">31.</span> <span class="toc-text">tcpdump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#calculate-upload-download-speed-by-ping"><span class="toc-number">32.</span> <span class="toc-text">calculate upload&#x2F;download speed by ping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MTU-problem-check"><span class="toc-number">33.</span> <span class="toc-text">MTU problem check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yum"><span class="toc-number">34.</span> <span class="toc-text">yum</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exclude-packages"><span class="toc-number">34.1.</span> <span class="toc-text">Exclude packages</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Switch-version"><span class="toc-number">34.2.</span> <span class="toc-text">Switch version</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Download-to-local"><span class="toc-number">34.3.</span> <span class="toc-text">Download to local</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Resolve-dependency-resolution-errors"><span class="toc-number">34.4.</span> <span class="toc-text">Resolve dependency resolution errors</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Uninstall-rpm-packages-from-rpmdb"><span class="toc-number">34.5.</span> <span class="toc-text">Uninstall rpm packages from rpmdb</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upgrade-kernel"><span class="toc-number">35.</span> <span class="toc-text">upgrade kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BBR"><span class="toc-number">35.1.</span> <span class="toc-text">BBR</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reinstall-grub2-from-boot-livecd"><span class="toc-number">36.</span> <span class="toc-text">reinstall grub2 from boot livecd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LVM-partition"><span class="toc-number">36.1.</span> <span class="toc-text">LVM partition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-in-ubuntu"><span class="toc-number">36.2.</span> <span class="toc-text">Test in ubuntu</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-in-CentOS-7-set-boot-menu"><span class="toc-number">36.3.</span> <span class="toc-text">Test in CentOS 7, set boot menu</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Re-install-EFI"><span class="toc-number">36.4.</span> <span class="toc-text">Re-install EFI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rdesktop-to-win10"><span class="toc-number">37.</span> <span class="toc-text">rdesktop to win10</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Enable-remote-desktop"><span class="toc-number">37.1.</span> <span class="toc-text">Enable remote desktop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Modify-registry-from-win10"><span class="toc-number">37.2.</span> <span class="toc-text">Modify registry from win10</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#record-and-replay-linux-terminal"><span class="toc-number">38.</span> <span class="toc-text">record and replay linux terminal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#traceroute-error"><span class="toc-number">39.</span> <span class="toc-text">traceroute error</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-Error-su-cannot-set-user-id-Resource-temporarily-unavailable"><span class="toc-number">40.</span> <span class="toc-text">Getting Error su: cannot set user id: Resource temporarily unavailable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lshw"><span class="toc-number">41.</span> <span class="toc-text">lshw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS8"><span class="toc-number">42.</span> <span class="toc-text">CentOS8</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bonding"><span class="toc-number">42.1.</span> <span class="toc-text">bonding</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#bonding-parameters"><span class="toc-number">42.1.1.</span> <span class="toc-text">bonding parameters</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fio-test-multiple-nodes"><span class="toc-number">43.</span> <span class="toc-text">fio test multiple nodes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Permission"><span class="toc-number">44.</span> <span class="toc-text">Permission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#screen-1"><span class="toc-number">45.</span> <span class="toc-text">screen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Add-systemd-service"><span class="toc-number">46.</span> <span class="toc-text">Add systemd service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#route-config"><span class="toc-number">47.</span> <span class="toc-text">route config</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#static-route"><span class="toc-number">47.1.</span> <span class="toc-text">static route</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Check-NIC-driver-err"><span class="toc-number">48.</span> <span class="toc-text">Check NIC driver err</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#collectl"><span class="toc-number">49.</span> <span class="toc-text">collectl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#process-mointor"><span class="toc-number">50.</span> <span class="toc-text">process mointor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#time"><span class="toc-number">51.</span> <span class="toc-text">time</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#youtube-download"><span class="toc-number">52.</span> <span class="toc-text">youtube download</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uptime-and-vmstat-running"><span class="toc-number">53.</span> <span class="toc-text">uptime and vmstat running</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-do-IRQ-X-Y-No-irq-handler-for-vector-irq-1"><span class="toc-number">54.</span> <span class="toc-text">kernel: do_IRQ: X.Y No irq handler for vector (irq -1)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#multipath-issue"><span class="toc-number">55.</span> <span class="toc-text">multipath issue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sshfs"><span class="toc-number">56.</span> <span class="toc-text">sshfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scan-file-size"><span class="toc-number">57.</span> <span class="toc-text">scan file size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#System-err-for-monitor"><span class="toc-number">58.</span> <span class="toc-text">System err for monitor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cgroup-limit-resource"><span class="toc-number">59.</span> <span class="toc-text">cgroup limit resource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#About-WB-SYNC-NONE-and-WB-SYNC-ALL"><span class="toc-number">60.</span> <span class="toc-text">About WB_SYNC_NONE and WB_SYNC_ALL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tools"><span class="toc-number">61.</span> <span class="toc-text">Tools</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ldd"><span class="toc-number">61.1.</span> <span class="toc-text">ldd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Read-ELF-Executable-and-Linking-Format"><span class="toc-number">61.2.</span> <span class="toc-text">Read ELF(Executable and Linking Format)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#objdump"><span class="toc-number">61.3.</span> <span class="toc-text">objdump</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nm"><span class="toc-number">61.4.</span> <span class="toc-text">nm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#size"><span class="toc-number">61.5.</span> <span class="toc-text">size</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#process-schduler"><span class="toc-number">62.</span> <span class="toc-text">process schduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vim-jump-cursor"><span class="toc-number">63.</span> <span class="toc-text">vim jump cursor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpart-recovery-partition-table"><span class="toc-number">64.</span> <span class="toc-text">gpart recovery partition table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ffmpeg"><span class="toc-number">65.</span> <span class="toc-text">ffmpeg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iptables"><span class="toc-number">66.</span> <span class="toc-text">iptables</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fail2ban"><span class="toc-number">66.1.</span> <span class="toc-text">fail2ban</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lsof"><span class="toc-number">66.2.</span> <span class="toc-text">lsof</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-accounting-on-Linux"><span class="toc-number">67.</span> <span class="toc-text">Process accounting on Linux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partition-table-loss"><span class="toc-number">68.</span> <span class="toc-text">Partition table loss</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#By-mount-offset"><span class="toc-number">68.1.</span> <span class="toc-text">By mount offset</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Recovery-the-partition-table-by-gdisk"><span class="toc-number">68.2.</span> <span class="toc-text">Recovery the partition table by gdisk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#backup-partition-table-by-sgdisk"><span class="toc-number">68.3.</span> <span class="toc-text">backup partition table by sgdisk</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#git"><span class="toc-number">69.</span> <span class="toc-text">git</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jemalloc-TCMalloc"><span class="toc-number">70.</span> <span class="toc-text">Jemalloc TCMalloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tuned-adm"><span class="toc-number">71.</span> <span class="toc-text">tuned-adm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tick"><span class="toc-number">72.</span> <span class="toc-text">Tick</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Two%E2%80%99s-Complement-and-the-negative-number"><span class="toc-number">73.</span> <span class="toc-text">Two’s Complement and the negative number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iostat"><span class="toc-number">74.</span> <span class="toc-text">iostat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proc-pid-smaps-vmflags"><span class="toc-number">75.</span> <span class="toc-text">&#x2F;proc&#x2F;pid&#x2F;smaps vmflags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#not-loading-kernel-module"><span class="toc-number">76.</span> <span class="toc-text">not loading kernel module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-signal"><span class="toc-number">77.</span> <span class="toc-text">Process signal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iftop"><span class="toc-number">78.</span> <span class="toc-text">iftop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MacOS"><span class="toc-number">79.</span> <span class="toc-text">MacOS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shadowsocks"><span class="toc-number">79.1.</span> <span class="toc-text">shadowsocks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#use-proxychains"><span class="toc-number">79.2.</span> <span class="toc-text">use proxychains</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NMI"><span class="toc-number">80.</span> <span class="toc-text">NMI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dmidecode-number"><span class="toc-number">81.</span> <span class="toc-text">dmidecode number</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-got-the-info-from-the-pipe-fd-and-socke-fd"><span class="toc-number">82.</span> <span class="toc-text">How to got the info from the pipe fd and socke fd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#process-schdule"><span class="toc-number">82.1.</span> <span class="toc-text">process schdule</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://homerl.github.io/img/operting_system_a32c6f.svg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">无常无形无功;不动不破不空</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Linux</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2019-07-18T07:37:02.000Z" title="Created 2019-07-18 15:37:02">2019-07-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-11-02T03:17:18.392Z" title="Updated 2021-11-02 11:17:18">2021-11-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/OS/">OS</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="audit"><a href="#audit" class="headerlink" title="audit"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/security_guide/sec-understanding_audit_log_files">audit</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ auditctl -e0</span><br><span class="line"></span><br><span class="line"><span class="comment">## /etc/audit/auditd.conf</span></span><br><span class="line">$ systemctl start auditd</span><br><span class="line">$ auditctl -b 8192 <span class="comment">#buff</span></span><br><span class="line">$ auditctl -f 2 <span class="comment"># Set  failure  mode  0=silent 1=printk 2=panic. This option lets you determine how you want the kernel to handle critical errors</span></span><br><span class="line">$ auditctl -r 0 <span class="comment"># not limit speed</span></span><br><span class="line">$ auditctl -e 2 <span class="comment"># Set enabled flag. When 0 is passed, this can be used to temporarily disable auditing. When 1 is passed as an argument, it will enable auditing.  To  lock the  audit  configuration  so  that  it  can&#x27;t  be  changed,  pass  a  2 as the argument</span></span><br><span class="line">$ auditctl -s <span class="comment"># Report  the  kernel&#x27;s  audit  subsystem status</span></span><br><span class="line">$ auditctl -l <span class="comment"># list rule</span></span><br><span class="line">$ auditctl -D <span class="comment"># del all policy</span></span><br><span class="line">$ auditctl -w path_to_file -p permissions -k key_name</span><br><span class="line"><span class="comment">#&quot;a&quot; means change the dir/file attribute, the others same with r w x</span></span><br><span class="line">$ auditctl -w /etc/passwd -p wa -k passwd_changes</span><br><span class="line">$ auditctl -w /etc/selinux/ -p wa -k selinux_changes</span><br><span class="line">$ auditctl -w /sbin/insmod -p x -k module_insertion</span><br><span class="line">$ auditctl -a always,<span class="built_in">exit</span> -F arch=b64 -S adjtimex -S settimeofday -k time_change</span><br><span class="line">$ auditctl -a always,<span class="built_in">exit</span> -S unlink -S unlinkat -S rename -S renameat -F auid&gt;=500 -F auid!=4294967295 -k delete</span><br><span class="line">$ auditctl -a always,<span class="built_in">exit</span> -F path=/etc/shadow -F perm=wa</span><br><span class="line">$ auditctl -R /usr/share/doc/audit-version/stig.rules <span class="comment"># Read rules from a file</span></span><br><span class="line"></span><br><span class="line">$ auditctl -w /etc/ssh/sshd_config -p warx -k sshd_config</span><br><span class="line"></span><br><span class="line">$ tail audit.log </span><br><span class="line"><span class="built_in">type</span>=SYSCALL msg=audit(1364481363.243:24287): arch=c000003e syscall=2 success=no <span class="built_in">exit</span>=-13 a0=7fffd19c5592 a1=0 a2=7fffd19c4b50 a3=a items=1 ppid=2686 pid=3538 auid=500 uid=500 gid=500 euid=500 suid=500 fsuid=500 egid=500 sgid=500 fsgid=500 tty=pts0 ses=1 comm=<span class="string">&quot;cat&quot;</span> exe=<span class="string">&quot;/bin/cat&quot;</span> subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key=<span class="string">&quot;sshd_config&quot;</span></span><br><span class="line"><span class="built_in">type</span>=CWD msg=audit(1364481363.243:24287):  cwd=<span class="string">&quot;/home/shadowman&quot;</span></span><br><span class="line"><span class="built_in">type</span>=PATH msg=audit(1364481363.243:24287): item=0 name=<span class="string">&quot;/etc/ssh/sshd_config&quot;</span> inode=409248 dev=fd:00 mode=0100600 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:etc_t:s0</span><br><span class="line"></span><br><span class="line"><span class="comment">#may be the ausearch is not a good choice</span></span><br></pre></td></tr></table></figure>

<h3 id="rsync-debug"><a href="#rsync-debug" class="headerlink" title="rsync debug"></a>rsync debug</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -h --debug=<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Use OPT or OPT1 <span class="keyword">for</span> level 1 output, OPT2 <span class="keyword">for</span> level 2, etc.; OPT0 silences.</span><br><span class="line"></span><br><span class="line">ACL        Debug extra ACL info</span><br><span class="line">BACKUP     Debug backup actions (levels 1-2)</span><br><span class="line">BIND       Debug socket <span class="built_in">bind</span> actions</span><br><span class="line">CHDIR      Debug when the current directory changes</span><br><span class="line">CONNECT    Debug connection events (levels 1-2)</span><br><span class="line">CMD        Debug commands+options that are issued (levels 1-2)</span><br><span class="line">DEL        Debug delete actions (levels 1-3)</span><br><span class="line">DELTASUM   Debug delta-transfer checksumming (levels 1-4)</span><br><span class="line">DUP        Debug weeding of duplicate names</span><br><span class="line">EXIT       Debug <span class="built_in">exit</span> events (levels 1-3)</span><br><span class="line">FILTER     Debug filter actions (levels 1-2)</span><br><span class="line">FLIST      Debug file-list operations (levels 1-4)</span><br><span class="line">FUZZY      Debug fuzzy scoring (levels 1-2)</span><br><span class="line">GENR       Debug generator <span class="built_in">functions</span></span><br><span class="line">HASH       Debug hashtable code</span><br><span class="line">HLINK      Debug hard-link actions (levels 1-3)</span><br><span class="line">ICONV      Debug iconv character conversions (levels 1-2)</span><br><span class="line">IO         Debug I/O routines (levels 1-4)</span><br><span class="line">OWN        Debug ownership changes <span class="keyword">in</span> users &amp; groups (levels 1-2)</span><br><span class="line">PROTO      Debug protocol information</span><br><span class="line">RECV       Debug receiver <span class="built_in">functions</span></span><br><span class="line">SEND       Debug sender <span class="built_in">functions</span></span><br><span class="line">TIME       Debug setting of modified <span class="built_in">times</span> (levels 1-2)</span><br><span class="line"></span><br><span class="line">ALL        Set all --debug options (e.g. all4)</span><br><span class="line">NONE       Silence all --debug options (same as all0)</span><br><span class="line">HELP       Output this <span class="built_in">help</span> message</span><br><span class="line"></span><br><span class="line">Options added <span class="keyword">for</span> each increase <span class="keyword">in</span> verbose level:</span><br><span class="line">2) BIND,CONNECT,CMD,DEL,DELTASUM,DUP,FILTER,FLIST,ICONV</span><br><span class="line">3) ACL,BACKUP,CONNECT2,DEL2,DELTASUM2,EXIT,FILTER2,FLIST2,FUZZY,GENR,OWN,RECV,SEND,TIME</span><br><span class="line">4) CMD2,DEL3,DELTASUM3,EXIT2,FLIST3,ICONV2,OWN2,PROTO,TIME2</span><br><span class="line">5) CHDIR,DELTASUM4,FLIST4,FUZZY2,HASH,HLINK</span><br></pre></td></tr></table></figure>

<h3 id="chrome-enable-dns-over-https"><a href="#chrome-enable-dns-over-https" class="headerlink" title="chrome enable dns over https"></a>chrome enable dns over https</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome://flags/<span class="comment">#dns-over-https</span></span><br></pre></td></tr></table></figure>

<h3 id="call"><a href="#call" class="headerlink" title="call"></a>call</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### kernel read/write lock</span></span><br><span class="line">rwsem_down_failed_common</span><br></pre></td></tr></table></figure>

<h3 id="traceroute"><a href="#traceroute" class="headerlink" title="traceroute"></a>traceroute</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ traceroute -q 1 -m 16 12.34.56.78 <span class="comment"># avoid linux kernel peer limit</span></span><br><span class="line">$ mtr -c 50 -i 0.2 -rw 12.34.56.78</span><br></pre></td></tr></table></figure>

<h3 id="mapping-file-to-loop-dev"><a href="#mapping-file-to-loop-dev" class="headerlink" title="mapping file to loop dev"></a>mapping file to loop dev</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ losetup /dev/loop0 /opt/test_file</span><br><span class="line">$ losetup -D <span class="comment">## remove all loop dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### export tcmalloc</span></span><br><span class="line">```bash</span><br><span class="line">$ yum install gperftools-libs</span><br><span class="line">$ <span class="built_in">export</span> LD_PRELOAD=/usr/lib64/libtcmalloc.so.4</span><br></pre></td></tr></table></figure>

<h3 id="vi-paste-not-auto-inherit-the-file-type"><a href="#vi-paste-not-auto-inherit-the-file-type" class="headerlink" title="vi paste not auto inherit the file type"></a>vi paste not auto inherit the file type</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:<span class="built_in">set</span> paste</span><br><span class="line">:<span class="built_in">set</span> nopaste</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> TERM=xterm-256color</span><br><span class="line">$ <span class="built_in">export</span> TERM=screen-256color</span><br></pre></td></tr></table></figure>

<h3 id="ubuntu-20-04"><a href="#ubuntu-20-04" class="headerlink" title="ubuntu 20.04"></a>ubuntu 20.04</h3><p>take screenshot of selected Area in Ubuntu 20.04<br>shortcut key, shift + Print screen</p>
<p>disable fstrim service</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm /var/lib/systemd/timers/stamp-fstrim.timer</span><br><span class="line">systemctl stop fstrim.service fstrim.timer</span><br><span class="line">systemctl <span class="built_in">disable</span> fstrim.service fstrim.timer</span><br><span class="line">systemctl mask fstrim.service fstrim.timer</span><br></pre></td></tr></table></figure>

<p>Delete the conection</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /etc/NetworkManager/system-connections</span><br><span class="line">delete the wifi connection </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">system program problem detected</span><br><span class="line">```bash</span><br><span class="line">sudo rm /var/crash/*</span><br></pre></td></tr></table></figure>

<p>installation</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">$ apt update</span><br><span class="line">$ apt install gcc make automake autoconf perl ethtool bpfcc-tools fio gdb crash python3-bpfcc smartmontools sg3-utils nfs-kernel-server tcpdump screen sysstat iotop iftop openssh-server linux-tools-5.4.0-58-generic atop collectl net-tools axel remmina tightvncserver ffmpeg gimp gimp-resynthesizer</span><br><span class="line"></span><br><span class="line">$ vi /etc/ssh/sshd_config</span><br><span class="line"><span class="comment">#PermitRootLogin prohibit-password</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">$ systemctl restart sshd</span><br><span class="line">$ passwd root <span class="comment"># set root passwd</span></span><br><span class="line">$ apt remove libreoffice-core</span><br><span class="line">$ apt upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment">##bridge network config example</span></span><br><span class="line">vi /etc/network/interfaces </span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet static</span><br><span class="line">        address 192.168.0.10</span><br><span class="line">        network 192.168.0.0</span><br><span class="line">        netmask 255.255.255.0</span><br><span class="line">        broadcast 192.168.0.255</span><br><span class="line">        gateway 192.168.0.1</span><br><span class="line">        dns-nameservers 192.168.0.5 8.8.8.8</span><br><span class="line">        dns-search example.com</span><br><span class="line">        bridge_ports eth0</span><br><span class="line">        bridge_stp off</span><br><span class="line">        bridge_fd 0</span><br><span class="line">        bridge_maxwait 0</span><br><span class="line"></span><br><span class="line"><span class="comment">### debug-info</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;deb http://ddebs.ubuntu.com <span class="subst">$(lsb_release -cs)</span> main restricted universe multiverse</span></span><br><span class="line"><span class="string">      deb http://ddebs.ubuntu.com <span class="subst">$(lsb_release -cs)</span>-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">      deb http://ddebs.ubuntu.com <span class="subst">$(lsb_release -cs)</span>-proposed main restricted universe multiverse&quot;</span> | \</span><br><span class="line">      sudo tee -a /etc/apt/sources.list.d/ddebs.list</span><br><span class="line"></span><br><span class="line">$ apt install ubuntu-dbgsym-keyring</span><br><span class="line">$ apt update</span><br><span class="line">$ apt install debian-goodies</span><br><span class="line"></span><br><span class="line"><span class="comment">### kernel source</span></span><br><span class="line">$ apt-get install linux-source linux-crashdump</span><br><span class="line">$ kdump-config show</span><br><span class="line">$ dmesg | grep -i crash</span><br><span class="line">$ cat /proc/sys/kernel/sysrq</span><br><span class="line">176</span><br><span class="line"></span><br><span class="line">$ sysctl -w kernel.sysrq=1</span><br><span class="line">$ <span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br><span class="line">$ cat /etc/default/grub.d/kdump-tools.cfg</span><br><span class="line">$ update-grub</span><br><span class="line">$ kdump-config load</span><br><span class="line">$ kdump-config unload</span><br><span class="line"></span><br><span class="line">find-dbgsym-packages [core_path|running_pid|binary_path]</span><br><span class="line">$ find-dbgsym-packages /bin/ls</span><br><span class="line">coreutils-dbgsym libpcre2-8-0-dbgsym libselinux1-dbgsym</span><br><span class="line"></span><br><span class="line">$ apt-get install coreutils-dbgsym </span><br><span class="line"></span><br><span class="line">$ crash  /usr/lib/debug/boot/vmlinux-5.4.0-58-generic</span><br><span class="line"></span><br><span class="line">$ apt install linux-image-5.4.0-58-generic-dbgsym</span><br><span class="line"></span><br><span class="line">$ vi /etc/apt/sources.list <span class="comment"># Enable src </span></span><br><span class="line">$ apt-get <span class="built_in">source</span> linux-image-unsigned-$(uname -r)</span><br><span class="line"><span class="comment">### ubuntu </span></span><br><span class="line">http://ddebs.ubuntu.com/ubuntu/pool/main/l/linux/linux-image-unsigned-5.4.0-58-generic-dbgsym_5.4.0-58.64_amd64.ddeb</span><br><span class="line"></span><br><span class="line"><span class="comment">### debain</span></span><br><span class="line">http://mirrors.ustc.edu.cn/debian/pool/main/l/linux/linux-image-4.19.0-13-amd64-dbg_4.19.160-2_amd64.deb</span><br><span class="line"></span><br><span class="line"><span class="comment">### cat /etc/apt/sources.list</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ buster main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ buster-updates main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ buster-backports main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian-security buster/updates main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### add dbgsym</span></span><br><span class="line"><span class="comment">#deb http://deb.debian.org/debian-debug/ buster-debug main</span></span><br><span class="line">deb http://debug.mirrors.debian.org/debian-debug/ buster-debug main</span><br><span class="line"><span class="comment"># for security updates</span></span><br><span class="line"><span class="comment">#deb http://deb.debian.org/debian-debug/ buster-proposed-updates-debug main</span></span><br><span class="line">deb http://debug.mirrors.debian.org/debian-debug/ buster-proposed-updates-debug main</span><br><span class="line"></span><br><span class="line">$ apt install linux-image-4.19.0-13-amd64-dbg</span><br></pre></td></tr></table></figure>

<p>Install wechat</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://deepin-wine.i-m.dev/</span><br><span class="line">$ wget -O- https://deepin-wine.i-m.dev/setup.sh | sh</span><br><span class="line">$ sudo apt install com.qq.weixin.deepin</span><br><span class="line">$ sudo apt-get install -y libjpeg62:i386</span><br></pre></td></tr></table></figure>

<h3 id="install-newer-glibc-deb-packages-and-apt-source-not-update-cause-the-deps-issue"><a href="#install-newer-glibc-deb-packages-and-apt-source-not-update-cause-the-deps-issue" class="headerlink" title="install newer glibc deb packages and apt source not update cause the deps issue"></a><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1315906/unmet-dependencies-libc6-the-package-system-is-broken">install newer glibc deb packages and apt source not update cause the deps issue</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## apt install specify version</span></span><br><span class="line">$ sudo apt install libc6=2.31-0ubuntu9.2 libc-bin=2.31-0ubuntu9.2</span><br><span class="line"></span><br><span class="line"><span class="comment">## snap remove </span></span><br><span class="line">$ sudo snap remove chromium</span><br></pre></td></tr></table></figure>

<h4 id="setup-vnc"><a href="#setup-vnc" class="headerlink" title="setup vnc"></a><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-20-04">setup vnc</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># change the vnc default port</span></span><br><span class="line">$ grep <span class="string">&quot;59&quot;</span> /usr/bin/vncserver -n </span><br><span class="line"><span class="comment">#modify 5900 to xxxx</span></span><br><span class="line"></span><br><span class="line">$ apt update</span><br><span class="line">$ apt install xfce4 xfce4-goodies tightvncserver</span><br><span class="line">$ vncpasswd</span><br><span class="line">Password:</span><br><span class="line">Verify:</span><br><span class="line"></span><br><span class="line">$ vncserver</span><br><span class="line">$ vncserver -<span class="built_in">kill</span> :1</span><br><span class="line"></span><br><span class="line"><span class="comment">#or delete the vnc lock</span></span><br><span class="line">$ rm -f /tmp/.X11-unix/X1</span><br><span class="line"></span><br><span class="line">$ mv ~/.vnc/xstartup ~/.vnc/xstartup.bak</span><br><span class="line">$ cat ~/.vnc/xstartup</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">xrdb <span class="variable">$HOME</span>/.Xresources</span><br><span class="line">startxfce4 &amp;</span><br><span class="line">$ chmod +x ~/.vnc/xstartup</span><br><span class="line"></span><br><span class="line">$ ssh -L 59000:localhost:5901 -C -N -l <span class="variable">$username</span> <span class="variable">$your_server_ip</span></span><br><span class="line">-L 59000:localhost:5901: The -L switch specifies that the given port on the <span class="built_in">local</span> computer (59000) is to be forwarded to the given host and port on the destination server (localhost:5901, meaning port 5901 on the destination server, defined as your_server_ip). Note that the <span class="built_in">local</span> port you specify is somewhat arbitrary; as long as the port isn’t already bound to another service, you can use it as the forwarding port <span class="keyword">for</span> your tunnel.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="centos"><a href="#centos" class="headerlink" title="centos"></a>centos</h3><h4 id="printk-messages"><a href="#printk-messages" class="headerlink" title="printk messages"></a><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/13019/description-of-kernel-printk-values">printk messages</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta"># linux/kernel.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_EMERG <span class="meta-string">&quot;&lt;0&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ALERT <span class="meta-string">&quot;&lt;1&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_CRIT <span class="meta-string">&quot;&lt;2&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ERR <span class="meta-string">&quot;&lt;3&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_WARNING <span class="meta-string">&quot;&lt;4&gt;&quot;</span> <span class="comment">//default level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_NOTICE <span class="meta-string">&quot;&lt;5&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_INFO <span class="meta-string">&quot;&lt;6&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEBUG <span class="meta-string">&quot;&lt;7&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line">#<span class="meta"># <span class="meta-keyword">define</span> in kernel/printk.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEFAULT <span class="meta-string">&quot;&lt;d&gt;&quot;</span> </span></span><br></pre></td></tr></table></figure>
<p>DEFAULT_MESSAGE_LOGLEVEL </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/kernel/printk</span><br><span class="line">4(console level) 4(default) 1 7</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">kernel.printk = 4 4 1 7</span><br><span class="line"></span><br><span class="line"><span class="comment">#modify the console log level</span></span><br><span class="line">$ <span class="built_in">echo</span> 5 &gt; /proc/sys/kernel/printk</span><br><span class="line">or</span><br><span class="line">$ <span class="built_in">echo</span> 8 &gt; /proc/sys/kernel/printk</span><br><span class="line"></span><br><span class="line"><span class="comment">## Some warning messages are rate limited. printk_ratelimit specifies the minimum length of time between these messages (in jiffies), by default we allow one every 5 seconds</span></span><br><span class="line">$ cat /proc/sys/kernel/printk_ratelimit</span><br><span class="line">5</span><br><span class="line"></span><br><span class="line"><span class="comment">## While long term we enforce one message per printk_ratelimit seconds, we do allow a burst of messages to pass through</span></span><br><span class="line">$ cat /proc/sys/kernel/printk_ratelimit_burst</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line"><span class="comment">#set the log level</span></span><br><span class="line">$ dmesg -n 5 </span><br><span class="line">$ dmesg --follow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The four values <span class="keyword">in</span> printk denote: console_loglevel, default_message_loglevel, minimum_console_loglevel and default_console_loglevel respectively.</span><br><span class="line">console_loglevel: messages with a higher priority than this will be printed to the console</span><br><span class="line">default_message_loglevel: messages without an explicit priority will be printed with this priority</span><br><span class="line">minimum_console_loglevel: minimum (highest) value to <span class="built_in">which</span> console_loglevel can be <span class="built_in">set</span></span><br><span class="line">default_console_loglevel: default value <span class="keyword">for</span> console_loglevel</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;0&quot;</span> → Emergency messages, system is about to crash or is unstable pr_emerg</span><br><span class="line"><span class="string">&quot;1&quot;</span> → Something bad happened and action must be taken immediately pr_alert</span><br><span class="line"><span class="string">&quot;2&quot;</span> → A critical condition occurred like a serious hardware/software failure pr_crit</span><br><span class="line"><span class="string">&quot;3&quot;</span> → An error condition, often used by drivers to indicate difficulties with the hardware pr_err</span><br><span class="line"><span class="string">&quot;4&quot;</span> → A warning, meaning nothing serious by itself but might indicate problems pr_warning</span><br><span class="line"><span class="string">&quot;5&quot;</span> → Nothing serious, but notably nevertheless. Often used to report security events. pr_notice</span><br><span class="line"><span class="string">&quot;6&quot;</span> → Informational message e.g. startup information at driver initialization pr_info</span><br><span class="line"><span class="string">&quot;7&quot;</span> → Debug messages pr_debug, pr_devel <span class="keyword">if</span> DEBUG is defined</span><br><span class="line">KERN_DEFAULT <span class="string">&quot;d&quot;</span> The default kernel loglevel</span><br><span class="line">KERN_CONT <span class="string">&quot;&quot;</span> <span class="string">&quot;continued&quot;</span> line of <span class="built_in">log</span> printout (only <span class="keyword">done</span> after a line that had no enclosing)</span><br></pre></td></tr></table></figure>



<h4 id="centos-7-7-not-report-kenrel-symbols"><a href="#centos-7-7-not-report-kenrel-symbols" class="headerlink" title="centos 7.7 not report kenrel symbols"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/4797281">centos 7.7 not report kenrel symbols</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure>

<h4 id="kill-sockets"><a href="#kill-sockets" class="headerlink" title="kill sockets"></a><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/71940/killing-tcp-connection-in-linux">kill sockets</a></h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ss -K dst 192.168.1.214 dport = 49029</span><br><span class="line">       -K, --kill</span><br><span class="line">              Attempts <span class="keyword">to</span> forcibly close sockets. This option displays sockets that are successfully closed <span class="keyword">and</span> silently skips sockets that the kernel does <span class="keyword">not</span> support closing. It sup‐</span><br><span class="line">              ports IPv4 <span class="keyword">and</span><span class="built_in"> IPv6 </span>sockets only. </span><br></pre></td></tr></table></figure>

<h4 id="compress-by-xz"><a href="#compress-by-xz" class="headerlink" title="compress by xz"></a>compress by xz</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar cf - <span class="variable">$dir</span> | xz -T 8 &gt; <span class="variable">$&#123;dir&#125;</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h4 id="systemd-rc-local"><a href="#systemd-rc-local" class="headerlink" title="systemd rc.local"></a>systemd rc.local</h4><p>set ubuntu shutdown slow</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/systemd/system.conf</span><br><span class="line">DefaultTimeoutStartSec=10s</span><br><span class="line">DefaultTimeoutStopSec=5s</span><br><span class="line"></span><br><span class="line">$ sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/systemd/system/rc-local.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=/etc/rc.local Compatibility</span><br><span class="line">ConditionPathExists=/etc/rc.local</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/etc/rc.local start</span><br><span class="line">TimeoutSec=0</span><br><span class="line">StandardOutput=tty</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line">SysVStartPriority=99</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;exit 0&quot;</span> &gt; /etc/rc.local</span><br><span class="line"></span><br><span class="line">$ sudo chmod +x /etc/rc.local</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> rc-local</span><br></pre></td></tr></table></figure>

<h4 id="date"><a href="#date" class="headerlink" title="date"></a>date</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## a week ago</span></span><br><span class="line">today=$(date -d <span class="string">&quot;<span class="subst">$(date +%Y%m%d)</span> 00:00:00&quot;</span> +%s)</span><br><span class="line">aweekago=$(date -d <span class="string">&quot;@<span class="subst">$((today-3600*24*7)</span>)&quot;</span> <span class="string">&quot;+%Y%m%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ date -s <span class="string">&quot;2 OCT 2018 18:18:18&quot;</span></span><br><span class="line">$ date -d <span class="string">&quot;@1595260885&quot;</span> +<span class="string">&quot;%m/%d/%Y %H:%M:%S&quot;</span></span><br><span class="line">07/21/2020 00:01:25</span><br><span class="line"></span><br><span class="line">$ date -d <span class="string">&quot;07/21/2020 00:01:25&quot;</span> +%s</span><br><span class="line">159526088</span><br><span class="line"></span><br><span class="line">$ date -d @12345 -u +%H:%M:%S</span><br><span class="line">03:25:45</span><br><span class="line"></span><br><span class="line">$ date -d <span class="string">&quot;09/04/2020 03:25:45&quot;</span> +%s</span><br><span class="line">1599186345</span><br><span class="line">$ date -d <span class="string">&quot;09/04/2020 00:00:00&quot;</span> +%s</span><br><span class="line">1599174000</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">1599186345</span>-<span class="number">1599174000</span>))</span><br><span class="line">12345</span><br></pre></td></tr></table></figure>

<h4 id="dd"><a href="#dd" class="headerlink" title="dd"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8554568/add-a-big-buffer-to-a-pipe-between-two-commands">dd</a></h4><p>dd modify pipe buffer block size</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ commandA | dd status=none iflag=fullblock bs=1M | commandB</span><br><span class="line">$ process1 | mbuffer -m 1024M | process2</span><br></pre></td></tr></table></figure>

<h4 id="selinux"><a href="#selinux" class="headerlink" title="selinux"></a>selinux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ setenforce 0</span><br><span class="line">$ getenforce</span><br><span class="line">Permissive</span><br></pre></td></tr></table></figure>
<h4 id="Software-Collections-SCL-Repository"><a href="#Software-Collections-SCL-Repository" class="headerlink" title="Software Collections ( SCL ) Repository"></a>Software Collections ( SCL ) Repository</h4><p>$ yum install centos-release-scl-rh<br>$ yum install devtoolset-9-toolchain</p>
<h1 id="centos-8"><a href="#centos-8" class="headerlink" title="centos 8"></a>centos 8</h1><p>$ dnf install gcc-toolset-9</p>
<p>$ gfortran –version | head -2<br>GNU Fortran (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36)<br>Copyright (C) 2015 Free Software Foundation, Inc.</p>
<p>$ scl enable devtoolset-9 bash</p>
<p>$  gfortran –version | head -2<br>GNU Fortran (GCC) 8.2.1 20180905 (Red Hat 8.2.1-3)<br>Copyright (C) 2018 Free Software Foundation, Inc.</p>
<a id="more"></a>

<h3 id="Nofile"><a href="#Nofile" class="headerlink" title="Nofile"></a><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/447583/ulimit-vs-file-max">Nofile</a></h3><p>/proc/sys/fs/file-max<br>ulimit -n</p>
<p>file-max is the maximum File Descriptors (FD) enforced on a kernel level, which cannot be surpassed by all processes without increasing.<br>The ulimit is enforced on a process level, which can be less than the file-max.</p>
<p>/proc/sys/fs/file-nr<br>This will return three values denote the number of allocated file handles the number of allocated but unused file handles, and the maximum number of file handles. </p>
<h3 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pidstat -C <span class="string">&#x27;linpack|stream&#x27;</span> -d 2 -rsuw</span><br></pre></td></tr></table></figure>

<h3 id="nfsstat"><a href="#nfsstat" class="headerlink" title="nfsstat"></a>nfsstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nfsiostat -d /mount 2</span><br></pre></td></tr></table></figure>

<h3 id="user-space-pipe-size"><a href="#user-space-pipe-size" class="headerlink" title="user space pipe size"></a>user space pipe size</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># F_SETPIPE_SZ F_GETPIPE_SZ</span></span><br><span class="line"><span class="comment"># echo 104857600 &gt; /proc/sys/fs/pipe-max-size</span></span><br><span class="line"><span class="comment"># fs.pipe-max-size=104857600</span></span><br><span class="line"><span class="comment"># ulimit pipe size            (512 bytes, -p) 8 = 4096 bytes, it &#x27;s pipe buffer size in the ulimit, not pipe size</span></span><br><span class="line"><span class="comment">## POSIX.1-2001 says that write(2)s of less than PIPE_BUF  bytes  must  be atomic:  the  output  data  is  written  to  the  pipe  as a contiguous sequence.  Writes of more than PIPE_BUF bytes may  be  non-atomic:  the kernel  may  interleave the data with data written by other processes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here 2 tools for pipe</span></span><br><span class="line"><span class="comment"># pv - Pipe Viewer - is a terminal-based tool for monitoring the progress of data through a pipeline.</span></span><br><span class="line"><span class="comment"># process1 | pv -pterbTCB 1G | process2</span></span><br><span class="line"></span><br><span class="line">$ pv -cN sources linux-image-unsigned-4.15.0-65-generic-dbgsym_4.15.0-65.74_amd64.ddeb | dd of=/tmp/tmp bs=512 | pv -cN cat</span><br><span class="line"></span><br><span class="line">$ mkfifo -m 777 /tmp/lfs.log</span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.log</span><br><span class="line"></span><br><span class="line"><span class="comment">## lfs 40MB log</span></span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.80.bin 80</span><br></pre></td></tr></table></figure>

<h3 id="rand-file"><a href="#rand-file" class="headerlink" title="rand file"></a>rand file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -out 1G.file 1073741824</span><br></pre></td></tr></table></figure>

<h3 id="samba"><a href="#samba" class="headerlink" title="samba"></a>samba</h3><h4 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /bin/<span class="literal">false</span>  <span class="variable">$USER</span></span><br><span class="line">PASSINPUT=`<span class="built_in">echo</span> <span class="variable">$USER</span>|cut -c1-3`123 </span><br><span class="line">(<span class="built_in">echo</span> <span class="variable">$PASSINPUT</span> ; <span class="built_in">echo</span> <span class="variable">$PASSINPUT</span>)  | smbpasswd -s -a <span class="variable">$USER</span></span><br></pre></td></tr></table></figure>
<h4 id="config"><a href="#config" class="headerlink" title="config"></a>config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">	workgroup = MYGROUP</span><br><span class="line">	server string = Samba Server Version %v</span><br><span class="line">	<span class="built_in">log</span> file = /var/<span class="built_in">log</span>/samba/<span class="built_in">log</span>.%m</span><br><span class="line">	max <span class="built_in">log</span> size = 50</span><br><span class="line">	security = user</span><br><span class="line">	passdb backend = tdbsam</span><br><span class="line">load printers = no</span><br><span class="line">printing = bsd</span><br><span class="line">printcap name = /dev/null</span><br><span class="line"><span class="built_in">disable</span> spoolss = yes</span><br><span class="line"></span><br><span class="line">[SMB_DATA]</span><br><span class="line">path = /samba/data</span><br><span class="line">valid users =  test1,test2,test3,test4</span><br><span class="line">create mask = 0744</span><br><span class="line">force create mode = 0744</span><br><span class="line">security mask = 0744</span><br><span class="line">force security mode = 0744</span><br><span class="line">directory mask = 0755</span><br><span class="line">force directory mode = 0755</span><br><span class="line">directory security mask = 0755</span><br><span class="line">force directory security mode = 0755</span><br><span class="line">writable = yes</span><br><span class="line">fileid:mapping = smb_data</span><br><span class="line">use mmap = no</span><br><span class="line">nt acl support = yes</span><br><span class="line">ea support = yes</span><br></pre></td></tr></table></figure>

<h4 id="Show-status"><a href="#Show-status" class="headerlink" title="Show status"></a>Show status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient -L localhost <span class="comment">#show share point</span></span><br><span class="line">$ pdbedit -L <span class="comment"># show users</span></span><br><span class="line">$ mount.cifs //<span class="variable">$domain_addr</span>/SMB_DATA -o username=test1,password=<span class="variable">$your_pass</span> /mnt</span><br><span class="line"></span><br><span class="line">$ ls -l /var/lib/samba/private/</span><br><span class="line">total 936</span><br><span class="line">-rw------- 1 root root 528384 Aug 22 10:36 passdb.tdb</span><br><span class="line">-rw------- 1 root root 430080 Dec 29  2013 secrets.tdb</span><br><span class="line"><span class="comment"># backup data</span></span><br><span class="line">$ pdbedit -e smbpasswd:/root/samba-users.backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># import </span></span><br><span class="line">$ pdbedit -i smbpasswd:/root/samba-users.backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># Please backup all users from /etc/passwd too</span></span><br></pre></td></tr></table></figure>

<h3 id="update-kernel-moduels-in-lib-moduels-uname-r"><a href="#update-kernel-moduels-in-lib-moduels-uname-r" class="headerlink" title="update kernel moduels in /lib/moduels/$(uname -r)"></a>update kernel moduels in /lib/moduels/$(uname -r)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># re-generate modules.alias modules.dep</span></span><br><span class="line">$ depmod -a</span><br></pre></td></tr></table></figure>

<h3 id="syscalls"><a href="#syscalls" class="headerlink" title="syscalls"></a>syscalls</h3><p>Get these names from <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/linux/syscalls.h">syscalls.h</a></p>
<h3 id="filter-syslog"><a href="#filter-syslog" class="headerlink" title="filter syslog"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/1564823">filter syslog</a></h3><p>Created slice user-0.slice.<br>Starting Session 150 of user root.<br>Started Session 150 of user root.<br>Created slice user-0.slice.<br>Starting Session 151 of user root.<br>Started Session 151 of user root.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;if $programname == &quot;l_getidentity.*&quot; then stop&#x27;</span> &gt;/etc/rsyslog.d/ignore-lustre-id-session.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;if $programname == &quot;systemd&quot; and ($msg contains &quot;Starting Session&quot; or $msg contains &quot;Started Session&quot; or $msg contains &quot;Created slice&quot; or $msg contains &quot;Starting user-&quot; or $msg contains &quot;Starting User Slice of&quot; or $msg contains &quot;Removed session&quot; or $msg contains &quot;Removed slice User Slice of&quot; or $msg contains &quot;Stopping User Slice of&quot;) then stop&#x27;</span> &gt;/etc/rsyslog.d/ignore-systemd-session-slice.conf</span><br><span class="line"></span><br><span class="line">$ systemctl restart rsyslog</span><br></pre></td></tr></table></figure>

<h3 id="xfs"><a href="#xfs" class="headerlink" title="xfs"></a>xfs</h3><h4 id="Check-fragmentation"><a href="#Check-fragmentation" class="headerlink" title="Check fragmentation"></a>Check fragmentation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xfs_db -r -c frag /dev/md127</span><br><span class="line">actual 310296, ideal 306296, fragmentation factor 1.29%</span><br><span class="line">Note, this number is largely meaningless.</span><br><span class="line">Files on this filesystem average 1.01 extents per file</span><br></pre></td></tr></table></figure>

<h3 id="tmp-permission"><a href="#tmp-permission" class="headerlink" title="tmp permission"></a>tmp permission</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 1777 /tmp</span><br></pre></td></tr></table></figure>

<h3 id="taskset"><a href="#taskset" class="headerlink" title="taskset"></a>taskset</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ taskset -p a 205344</span><br><span class="line">pid 205344<span class="string">&#x27;s current affinity mask: ffffffffff</span></span><br><span class="line"><span class="string">pid 205344&#x27;</span>s new affinity mask: a</span><br><span class="line"></span><br><span class="line">$ taskset -c -p 205344</span><br><span class="line">pid 205344<span class="string">&#x27;s current affinity list: 1,3</span></span><br><span class="line"><span class="string">$ taskset -cp 0-3 $pid</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ echo &quot;obase=2; ibase=16; A&quot; | bc</span></span><br><span class="line"><span class="string">1010 # core 1,3</span></span><br></pre></td></tr></table></figure>

<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><h4 id="ssh-key-not-work"><a href="#ssh-key-not-work" class="headerlink" title="ssh key not work"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6377009/adding-public-key-to-ssh-authorized-keys-does-not-log-me-in-automatically">ssh key not work</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 700 ~/.ssh</span><br><span class="line">$ chmod 600 ~/.ssh/authorized_keys</span><br><span class="line">$ chmod go-w ~</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bind $vnc_server_ip:5910 to localhost:7910</span></span><br><span class="line">$ ssh -L 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># to 0.0.0.0:7910</span></span><br><span class="line">$ ssh -L 7910:0.0.0.0:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"><span class="comment"># same with 0.0.0.0</span></span><br><span class="line">$ ssh -g -L 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"><span class="comment"># limit the client ip</span></span><br><span class="line">$ ssh -g -L 7910:<span class="variable">$&#123;ssh_client_ip&#125;</span>:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># bind $vnc_server_ip:5910 to $vnc_server_ip:7910 by $ssh_client</span></span><br><span class="line"><span class="comment"># modify -L to -R</span></span><br><span class="line">$ ssh -R 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># share all ip addr</span></span><br><span class="line"><span class="comment"># modify /etc/ssh/sshd_config &#x27;GatewayPorts clientspecified&#x27;</span></span><br><span class="line">$ ssh -R 7910:0.0.0.0:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># vnc_server_ip2 and ip1 in the same LAN, bind vnc_server_ip2 5910 to ssh client 7910 and forward by vnc_server_ip1</span></span><br><span class="line">$ ssh -L 7910:<span class="variable">$&#123;vnc_server_ip2&#125;</span>:5910 user@<span class="variable">$&#123;vnc_server_ip1&#125;</span></span><br><span class="line">vnc_server_ip1 $ vncview localhost:7910</span><br><span class="line"><span class="comment"># Enable all ip access</span></span><br><span class="line">$ ssh -L 7910:0.0.0.0:5910 user@<span class="variable">$&#123;vnc_server_ip1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vnc_server_ip1 access ssh_client_ip2 vnc service</span></span><br><span class="line">$ ssh -R 7910:ssh_client_ip2:5910 user@vnc_server_ip1</span><br><span class="line">vnc_server_ip1 $ vncviewer localhost::7910 </span><br><span class="line"><span class="comment"># Enable all ip access</span></span><br><span class="line">$ ssh -R 7910:0.0.0.0:5910 user@vnc_server_ip1</span><br><span class="line"></span><br><span class="line"><span class="comment">#### [pass through another machine to forward sock5](https://superuser.com/questions/332850/ssh-as-socks-proxy-through-multiple-hosts)</span></span><br><span class="line">A-&gt;B-&gt;C  </span><br><span class="line">C could connecnt internet, A and B could not, A pass through B to forward sock5 port to <span class="variable">$A_local_sock_port</span></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># make these port have not block by firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### In A, you could set sock5 localhost:$A_local_sock_port to connect internnet</span></span><br><span class="line">client $ ssh -C -f -N -D <span class="variable">$local_sock_port</span> -oProxyCommand=<span class="string">&quot;ssh -C -W %h:%p username@<span class="variable">$B_ipaddr</span>&quot;</span> username@<span class="variable">$C_ipaddr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or </span></span><br><span class="line">client $ ssh -L <span class="variable">$local_sock_port</span>:localhost:<span class="variable">$PORT2</span> <span class="variable">$B_IPADDR</span></span><br><span class="line">A $ ssh -f -N -D <span class="variable">$PORT2</span> <span class="variable">$C_IPADDR</span></span><br><span class="line"><span class="comment">#merge dual command to single command</span></span><br><span class="line">client $ ssh -f -L <span class="variable">$local_sock_port</span>:localhost:<span class="variable">$PORT2</span> liyan@192.168.210.3 <span class="string">&quot;ssh -f -N -D <span class="variable">$PORT2</span> liyan@<span class="variable">$C_IPADDR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># forward remote port to local</span></span><br><span class="line">client $ ssh -fNT -R 1025:127.0.0.1:1025 -J user@<span class="variable">$B_IP</span> user@<span class="variable">$C_IP</span></span><br><span class="line">AllowTcpForwarding yes</span><br><span class="line">GatewayPorts yes</span><br></pre></td></tr></table></figure>

<h4 id="ssh-config-allow-users"><a href="#ssh-config-allow-users" class="headerlink" title="ssh config allow users"></a>ssh config allow users</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AllowUsers *@192.168.1.0/24 *@*.example.com *@1.2.3.4</span><br><span class="line">AllowGroups ssh</span><br></pre></td></tr></table></figure>

<h3 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h3><p>-ttt If given thrice, the time printed will include the microseconds and the leading portion will be printed as the number of seconds since the epoch</p>
<p>-s strsize  Specify the maximum string size to print (the default is 32).  Note that filenames are not considered strings and are always printed in full.</p>
<p>-f Trace child processes as they are created by currently traced processes  as  a  result  of  the  fork(2),  vfork(2)  and clone(2)  system  calls. Note that -p PID -f will attach all threads of process PID if it is multi-threaded, not only thread with thread_id = PID</p>
<p>-T Show the time spent in system calls.  This records the time difference between the beginning and the end of each  system call</p>
<p>-c Count time, calls, and errors for each system call and report a summary on program exit, suppressing the regular output. This attempts to show system time (CPU time spent running in the kernel) independent of wall clock time.  If -c is used with -f, only aggregate totals for all traced processes are kept.<br>-C Like -c but also print regular output while processes are running.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ strace -f -c -p 49285 </span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"> 92.89   69.955928        2530     27640      1203 futex</span><br><span class="line">  2.33    1.754302       70172        25        25 restart_syscall</span><br><span class="line">  1.56    1.172474          52     22512           write</span><br><span class="line">  1.54    1.156547          63     18080           <span class="built_in">read</span></span><br><span class="line">  1.09    0.821847         119      6873           unlink</span><br><span class="line">  0.28    0.211894          30      6874           open</span><br><span class="line">  0.14    0.108041          15      6859           munmap</span><br><span class="line">  0.07    0.049564           7      6874           close</span><br><span class="line">  0.05    0.035222           2     13733           fstat</span><br><span class="line">  0.03    0.024198           3      6859           mmap</span><br><span class="line">  0.02    0.015568           2      5522           clock_gettime</span><br><span class="line">  0.01    0.006484           2      2208           getrusage</span><br><span class="line">  0.00    0.001998           3       552           mprotect</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00   75.314067                124611      1228 total</span><br><span class="line"></span><br><span class="line">$ strace -k cmd  <span class="comment">#show backtrace for each syscall</span></span><br><span class="line">$ strace -t cmd  <span class="comment">#prefix each syscall with walllock time</span></span><br><span class="line">$ strace -D cmd  strace process runs as detached grandchild of cmd</span><br><span class="line">$ strace -p 1234 -f <span class="comment">#addatch to all threads in process-group 1234</span></span><br><span class="line"></span><br><span class="line">strace -Tfe trace=open,<span class="built_in">read</span>,write  ./program</span><br><span class="line">$ strace -f -FF -tt -T -s 128 -p <span class="variable">$pid</span></span><br><span class="line">$ strace -ttt -T -s 1024 -e trace=%memory -C -o ~/memory.log -f -p <span class="variable">$pid</span></span><br><span class="line">$ strace -ttt -T -s 1024 -e trace=%desc -C -o ~/desc.log -f -p <span class="variable">$pid</span></span><br></pre></td></tr></table></figure>

<h3 id="Calculated-CPU-usage"><a href="#Calculated-CPU-usage" class="headerlink" title="Calculated CPU usage"></a><a target="_blank" rel="noopener" href="https://github.com/Leo-G/DevopsWiki/wiki/How-Linux-CPU-Usage-Time-and-Percentage-is-calculated">Calculated CPU usage</a></h3><p>cpu usage=(idle2-idle1)/(cpu2-cpu1)*100 # script example<br>cpu usage=[(user_2 +sys_2+nice_2) - (user_1 + sys_1+nice_1)]/(total_2 - total_1)*100</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> cat /proc/<span class="built_in">stat</span></span><br><span class="line">     user nice system idle iowait  irq  softirq steal guest guest_nice</span><br><span class="line">cpu  4705 356  584    3699   23    23     0       0     0          0</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"> <span class="comment"># by Paul Colby (http://colby.id.au), no rights reserved ;)</span></span><br><span class="line"></span><br><span class="line"> PREV_TOTAL=0</span><br><span class="line"> PREV_IDLE=0</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">   <span class="comment"># Get the total CPU statistics, discarding the &#x27;cpu &#x27; prefix.</span></span><br><span class="line">   CPU=(`sed -n <span class="string">&#x27;s/^cpu\s//p&#x27;</span> /proc/<span class="built_in">stat</span>`)</span><br><span class="line">   IDLE=<span class="variable">$&#123;CPU[3]&#125;</span> <span class="comment"># Just the idle CPU time.</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Calculate the total CPU time.</span></span><br><span class="line">   TOTAL=0</span><br><span class="line">   <span class="keyword">for</span> VALUE <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;CPU[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">     ((TOTAL=<span class="variable">$TOTAL</span>+<span class="variable">$VALUE</span>))</span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Calculate the CPU usage since we last checked.</span></span><br><span class="line">   ((DIFF_IDLE=<span class="variable">$IDLE</span>-<span class="variable">$PREV_IDLE</span>))</span><br><span class="line">   ((DIFF_TOTAL=<span class="variable">$TOTAL</span>-<span class="variable">$PREV_TOTAL</span>))</span><br><span class="line">    </span><br><span class="line">   <span class="comment">## </span></span><br><span class="line">   DIFF_USAGE=$(awk -v diff_idle=<span class="variable">$DIFF_IDLE</span> -v diff_total=<span class="variable">$DIFF_TOTAL</span> <span class="string">&#x27;BEGIN&#123;printf &quot;%.2f&quot;, (diff_total-diff_idle)/diff_total*100&#125;&#x27;</span>)</span><br><span class="line">   <span class="built_in">echo</span> -en <span class="string">&quot;\rCPU: <span class="variable">$DIFF_USAGE</span>%  \b\b&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Remember the total and idle CPU times for the next check.</span></span><br><span class="line">   PREV_TOTAL=<span class="string">&quot;<span class="variable">$TOTAL</span>&quot;</span></span><br><span class="line">   PREV_IDLE=<span class="string">&quot;<span class="variable">$IDLE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Wait before checking again.</span></span><br><span class="line">   usleep 100000</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## the lib messages</span></span><br><span class="line">$ <span class="built_in">read</span>(3, <span class="string">&quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\273\0\0\0\0\0\0&quot;</span>..., 832) = 832</span><br><span class="line"></span><br><span class="line">$ od -bc /lib/x86_64-linux-gnu/libc.so.6 | head -n4</span><br><span class="line">0000000 177 105 114 106 002 001 001 003 000 000 000 000 000 000 000 000</span><br><span class="line">        177   E   L   F 002 001 001 003  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000020 003 000 076 000 001 000 000 000 260 034 002 000 000 000 000 000</span><br><span class="line">        003  \0   &gt;  \0 001  \0  \0  \0 260 034 002  \0  \0  \0  \0  \0</span><br></pre></td></tr></table></figure>

<h3 id="tuna"><a href="#tuna" class="headerlink" title="tuna"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/2144921">tuna</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check kernel threads</span></span><br><span class="line">$ tuna -U -P</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  2      OTHER     0    0xfff 386420266      1048922        kthreadd</span><br><span class="line">  4      OTHER     0        0         7            0    kworker/0:0H</span><br><span class="line">  6      OTHER     0        0   4030025         3019     ksoftirqd/0</span><br><span class="line">  7       FIFO    99        0    155252            0     migration/0</span><br><span class="line"></span><br><span class="line">$ tuna --threads=7861 --priority=RR:40</span><br><span class="line">$ tuna --threads=sshd --show_threads --priority=RR:40 --show_threads</span><br><span class="line"></span><br><span class="line"><span class="comment"># Got the voluntary and nonvoluntary ctxt switch</span></span><br><span class="line"><span class="comment"># pid is the io test app</span></span><br><span class="line">grep ctxt_switches /proc/<span class="variable">$&#123;pid&#125;</span>/status</span><br><span class="line">voluntary_ctxt_switches:        2940930 (I/O bound)</span><br><span class="line">nonvoluntary_ctxt_switches:     9042</span><br><span class="line"></span><br><span class="line"><span class="comment"># 147095 is the cpu test app</span></span><br><span class="line">grep ctxt_switches /proc/147095/status</span><br><span class="line">voluntary_ctxt_switches:	478</span><br><span class="line">nonvoluntary_ctxt_switches:	1565 (CPU bound)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling automatic IRQ balancing</span></span><br><span class="line">$ systemctl stop irqbalance.service</span><br><span class="line">$ systemctl <span class="built_in">disable</span> irqbalance.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#  the kernel will automatically try to balance the load based on its understanding of the hardware&#x27;s NUMA layout</span></span><br><span class="line">$  <span class="built_in">echo</span> kernel.numa_balancing=0 &gt;&gt; /etc/sysctl.conf ; sysctl -p</span><br><span class="line"></span><br><span class="line">j$ cat /sys/class/net/eth0/device/numa_node</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Isolating CPUs from the process scheduler</span></span><br><span class="line">This step involves setting isolcpus on the kernel<span class="string">&#x27;s cmdline. This removes cores from the process scheduler that you would like to dedicate to your application, so other userland processes do not migrate to them. Please see this solutions document for more information: https://access.redhat.com/solutions/480473</span></span><br><span class="line"><span class="string">NOTE: kernel threads are not able to be disabled and will always be visible on all cores. In ps -eLf output, these show up in brackets, like [ksoftirqd/0]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grubby --update-kernel=ALL --args=&#x27;</span>isolcpus=1-3,5-31, iommu=pt<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ grubby --update-kernel=ALL --args=&#x27;</span>intel_pstate=<span class="built_in">disable</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ grubby --update-kernel=ALL --remove-args=&#x27;</span>mem=66G<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## disable the irqbalance</span></span><br><span class="line"><span class="string">$ systemctl stop irqbalance</span></span><br><span class="line"><span class="string">## Show numa node for dev </span></span><br><span class="line"><span class="string">$ numactl -a -N netdev:em1 grep allowed /proc/self/status</span></span><br><span class="line"><span class="string">Cpus_allowed:	00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000055,55555555</span></span><br><span class="line"><span class="string">Cpus_allowed_list:	0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38</span></span><br><span class="line"><span class="string">Mems_allowed:	00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span></span><br><span class="line"><span class="string">Mems_allowed_list:	0-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## bind to 0,2,4 cores</span></span><br><span class="line"><span class="string">$ numactl -a -N netdev:em1 -C 0,2,4 grep allowed /proc/self/status</span></span><br><span class="line"><span class="string">Cpus_allowed:	00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000015</span></span><br><span class="line"><span class="string">Cpus_allowed_list:	0,2,4</span></span><br><span class="line"><span class="string">Mems_allowed:	00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span></span><br><span class="line"><span class="string">Mems_allowed_list:	0-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lspci  | grep Ethernet</span></span><br><span class="line"><span class="string">01:00.0 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span></span><br><span class="line"><span class="string"> | |  |</span></span><br><span class="line"><span class="string"> | |  ---func</span></span><br><span class="line"><span class="string"> | ---slot</span></span><br><span class="line"><span class="string"> ---bus</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#show dev</span></span><br><span class="line"><span class="string">$ numactl --prefer netdev:em1 --show</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#not work</span></span><br><span class="line"><span class="string">$ numactl --prefer pci:01:00 --show</span></span><br><span class="line"><span class="string">                        |  |</span></span><br><span class="line"><span class="string">                        |  ---slot</span></span><br><span class="line"><span class="string">                        ---bus</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## write the it to systemd service config file</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">...other lines...</span></span><br><span class="line"><span class="string">ExecStart=/bin/numactl -aN netdev:em1 -C 6 /path/to/ptpd</span></span><br><span class="line"><span class="string">...other lines...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Instead of a number a node can also be:</span></span><br><span class="line"><span class="string">  netdev:DEV the node connected to network device DEV</span></span><br><span class="line"><span class="string">  file:PATH  the node the block device of path is connected to</span></span><br><span class="line"><span class="string">  ip:HOST    the node of the network device host routes through</span></span><br><span class="line"><span class="string">  block:PATH the node of block device path</span></span><br><span class="line"><span class="string">  pci:[seg:]bus:dev[:func] The node of a PCI device</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Dell H330 IR</span></span><br><span class="line"><span class="string">$ lspci -ttv | grep &quot;MegaRAID SAS-3 3008&quot; -B 1</span></span><br><span class="line"><span class="string"> \-[0000:00]-+-00.0  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D DMI2</span></span><br><span class="line"><span class="string">             +-01.0-[02]----00.0  LSI Logic / Symbios Logic MegaRAID SAS-3 3008 [Fury]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ls -l /sys/class/block</span></span><br><span class="line"><span class="string">sda -&gt; ../../devices/pci0000:00/0000:00:01.0/0000:02:00.0/host0/target0:0:0/0:0:0:0/block/sda</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU ID</span></span><br><span class="line"><span class="string">Zero-based CPU ID	0	1	2	3	4	5	6	7	8	9	10	11	12</span></span><br><span class="line"><span class="string">Decimal Value	        1	2	4	8	16	32	64	128	256	512	1024	2048	4096</span></span><br><span class="line"><span class="string">Hexadecimal Value	1	2	4	8	10	20	40	80	100	200	400	800	1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Zero-based CPU ID	13	14	15	16	17	18	19	20	21	22	23</span></span><br><span class="line"><span class="string">Decimal Value	        8192    16384   32768   65536   131072  262144  524288  1048576 2097152 4194304 8388608</span></span><br><span class="line"><span class="string">Hexadecimal Value	2000    4000    8000    10000   20000   40000   80000   100000  200000  400000  800000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">printf &#x27;</span>%x %x\n<span class="string">&#x27; 1024 4096</span></span><br><span class="line"><span class="string">400 1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ awk -F &#x27;</span>[ :]+<span class="string">&#x27; &#x27;</span><span class="variable">$0</span>!~/CPU/ &amp;&amp; <span class="variable">$0</span>~/em1/&#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;<span class="string">&#x27; /proc/interrupts</span></span><br><span class="line"><span class="string">88</span></span><br><span class="line"><span class="string">90</span></span><br><span class="line"><span class="string">91</span></span><br><span class="line"><span class="string">92</span></span><br><span class="line"><span class="string">93</span></span><br><span class="line"><span class="string">94</span></span><br><span class="line"><span class="string">95</span></span><br><span class="line"><span class="string">96</span></span><br><span class="line"><span class="string">97</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ echo 400 &gt; /proc/irq/88/smp_affinitya</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">$ echo 1000 &gt; /proc/irq/97/smp_affinity</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ seq 63 88 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span></span><br><span class="line"><span class="string">/proc/irq/63/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000001</span></span><br><span class="line"><span class="string">/proc/irq/64/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000004</span></span><br><span class="line"><span class="string">/proc/irq/65/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000010</span></span><br><span class="line"><span class="string">/proc/irq/66/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000040</span></span><br><span class="line"><span class="string">/proc/irq/67/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000100</span></span><br><span class="line"><span class="string">/proc/irq/68/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000400</span></span><br><span class="line"><span class="string">/proc/irq/69/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00001000</span></span><br><span class="line"><span class="string">/proc/irq/70/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00004000</span></span><br><span class="line"><span class="string">/proc/irq/71/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00010000</span></span><br><span class="line"><span class="string">/proc/irq/72/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00aaaaaa</span></span><br><span class="line"><span class="string">/proc/irq/73/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00aaaaaa</span></span><br><span class="line"><span class="string">/proc/irq/74/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00040000</span></span><br><span class="line"><span class="string">/proc/irq/75/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00100000</span></span><br><span class="line"><span class="string">/proc/irq/76/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00400000</span></span><br><span class="line"><span class="string">/proc/irq/77/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000002</span></span><br><span class="line"><span class="string">/proc/irq/78/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000008</span></span><br><span class="line"><span class="string">/proc/irq/79/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000020</span></span><br><span class="line"><span class="string">/proc/irq/80/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000080</span></span><br><span class="line"><span class="string">/proc/irq/81/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000200</span></span><br><span class="line"><span class="string">/proc/irq/82/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000800</span></span><br><span class="line"><span class="string">/proc/irq/83/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00002000</span></span><br><span class="line"><span class="string">/proc/irq/84/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00008000</span></span><br><span class="line"><span class="string">/proc/irq/85/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00020000</span></span><br><span class="line"><span class="string">/proc/irq/86/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00080000</span></span><br><span class="line"><span class="string">/proc/irq/87/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00200000</span></span><br><span class="line"><span class="string">/proc/irq/88/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00800000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=72 --show_irqs</span></span><br><span class="line"><span class="string">   # users            affinity</span></span><br><span class="line"><span class="string">  72 dmar0            0xaaaaaa</span></span><br><span class="line"><span class="string">0xaaaaaa = 101010101010101010101010  == numa1 all cores</span></span><br><span class="line"><span class="string">                                          -----------------------------cpu23</span></span><br><span class="line"><span class="string">                                          |                     -------cpu1</span></span><br><span class="line"><span class="string">$ tuna --irqs=88 --show_irqs              |                     |------cpu0</span></span><br><span class="line"><span class="string">   # users            affinity            |                     ||</span></span><br><span class="line"><span class="string">  88 mpt3sas0-msix23        23  (0x800000=100000000000000000000000) </span></span><br><span class="line"><span class="string">$ tuna --irqs=77 --show_irqs</span></span><br><span class="line"><span class="string">   # users            affinity            </span></span><br><span class="line"><span class="string">  77 mpt3sas0-msix12         1  (0x00000002=10), cpu1 not cpu0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lspci | grep 3008</span></span><br><span class="line"><span class="string">82:00.0 Serial Attached SCSI controller: Broadcom / LSI SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /sys/devices/pci0000:80/0000:80:03.0/0000:82:00.0/numa_node</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lspcu</span></span><br><span class="line"><span class="string">NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19,21,23</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=mpt3sas1\* --cpus=0,1 --move </span></span><br><span class="line"><span class="string">$ echo 0xff &gt; /proc/irq/125/smp_affinity</span></span><br><span class="line"><span class="string">-bash: echo: write error: Input/output error</span></span><br><span class="line"><span class="string">### mpt3sas could not be modified that why tuna not work</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grep em3 /proc/interrupts</span></span><br><span class="line"><span class="string">114 116 117 118 119 120 121 122 123</span></span><br><span class="line"><span class="string">$ seq 114 123 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span></span><br><span class="line"><span class="string">/proc/irq/114/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000040</span></span><br><span class="line"><span class="string">grep: /proc/irq/115/smp_affinity: No such file or directory</span></span><br><span class="line"><span class="string">/proc/irq/116/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000400</span></span><br><span class="line"><span class="string">/proc/irq/117/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00001000</span></span><br><span class="line"><span class="string">/proc/irq/118/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00040000</span></span><br><span class="line"><span class="string">/proc/irq/119/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00100000</span></span><br><span class="line"><span class="string">/proc/irq/120/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00400000</span></span><br><span class="line"><span class="string">/proc/irq/121/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000001</span></span><br><span class="line"><span class="string">/proc/irq/122/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000004</span></span><br><span class="line"><span class="string">/proc/irq/123/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000010</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=114 --show_irqs                                                   -----------cpu6, seventh cpu core, 0,1,2,3,4,5,6</span></span><br><span class="line"><span class="string">   # users            affinity                                                  |</span></span><br><span class="line"><span class="string"> 114 em3                     6  bnx2x  6 not means 110,,,,, it &#x27;</span>s means cpu6   0x40 = 1000000 </span><br><span class="line"></span><br><span class="line">$ tuna --irqs=em3\* --show_irqs</span><br><span class="line">   <span class="comment"># users            affinity</span></span><br><span class="line"> 114 em3                     6  bnx2x      --------------cpu12</span><br><span class="line"> 116 em3-fp-0               10  bnx2x      |</span><br><span class="line"> 117 em3-fp-1               12  bnx2x  eg: 1000000000000 = 0x1000</span><br><span class="line"> 118 em3-fp-2               18  bnx2x</span><br><span class="line"> 119 em3-fp-3               20  bnx2x</span><br><span class="line"> 120 em3-fp-4               22  bnx2x</span><br><span class="line"> 121 em3-fp-5                0  bnx2x</span><br><span class="line"> 122 em3-fp-6                2  bnx2x</span><br><span class="line"> 123 em3-fp-7                4  bnx2x</span><br><span class="line"></span><br><span class="line">$ cat /sys/class/net/em3/device/numa_node </span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18,20,22</span><br><span class="line"></span><br><span class="line">$ tuna --irqs=em3\* --cpus=0,1,2,3,4,5,6,7 --move <span class="comment">## it &#x27;s 0xff and it &#x27;s worked</span></span><br><span class="line">$ seq 114 123 | xargs -I% grep -H . /proc/irq/%/smp_affinity </span><br><span class="line">/proc/irq/114/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">grep: /proc/irq/115/smp_affinity: No such file or directory</span><br><span class="line">/proc/irq/116/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/117/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/118/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/119/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/120/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/121/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/122/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/123/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line"></span><br><span class="line">$ tuna --threads=watchdog\* \</span><br><span class="line">        --show_threads \</span><br><span class="line">        --cpus=0 \</span><br><span class="line">        --move \</span><br><span class="line">        --show_threads \</span><br><span class="line">        --cpus=1 \</span><br><span class="line">        --move \</span><br><span class="line">        --show_threads \</span><br><span class="line">        --cpus=+0 \</span><br><span class="line">        --move \</span><br><span class="line">        --show_threads</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## show pid numa stats</span></span><br><span class="line">$ perl numa-maps-summary.pl &lt; /proc/1/numa_maps</span><br><span class="line">N0        :          676 (  0.00 GB)</span><br><span class="line">N1        :          230 (  0.00 GB)</span><br><span class="line">active    :          385 (  0.00 GB)</span><br><span class="line">anon      :          443 (  0.00 GB)</span><br><span class="line">dirty     :          443 (  0.00 GB)</span><br><span class="line">kernelpagesize_kB:          268 (  0.00 GB)</span><br><span class="line">mapmax    :          146 (  0.00 GB)</span><br><span class="line">mapped    :          463 (  0.00 GB)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ numastat -mczs</span><br><span class="line"></span><br><span class="line">Per-node system memory usage (<span class="keyword">in</span> MBs):</span><br><span class="line">                 Node 0 Node 1  Total</span><br><span class="line">                 ------ ------ ------</span><br><span class="line">MemTotal          64230  64448 128678</span><br><span class="line">MemUsed           45328  34761  80089</span><br><span class="line">FilePages         42949  32954  75903</span><br><span class="line">Inactive          42669  31659  74328</span><br><span class="line">Inactive(file)    42668  29360  72028</span><br><span class="line">MemFree           18901  29687  48589</span><br><span class="line">Shmem                 1   3530   3531</span><br><span class="line">Inactive(anon)        2   2298   2300</span><br><span class="line">Slab                872   1168   2041</span><br><span class="line">SReclaimable        669   1027   1695</span><br><span class="line">Active              285   1332   1617</span><br><span class="line">Active(anon)          5   1272   1277</span><br><span class="line">SUnreclaim          204    142    345</span><br><span class="line">Active(file)        280     60    341</span><br><span class="line">AnonPages             5     37     42</span><br><span class="line">Mapped                6     20     26</span><br><span class="line">KernelStack           5      5     10</span><br><span class="line">AnonHugePages         0     10     10</span><br><span class="line">PageTables            2      3      5</span><br><span class="line">Dirty                 0      0      0</span><br><span class="line"></span><br><span class="line">https://gist.github.com/sitano/c2269ed158e15ab97829</span><br></pre></td></tr></table></figure>

<h3 id="NFS-client"><a href="#NFS-client" class="headerlink" title="NFS client"></a>NFS client</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options sunrpc tcp_slot_table_entries=128&quot;</span> &gt;&gt; /etc/modprobe.d/sunrpc.conf</span><br><span class="line"><span class="comment"># the value default only 2</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><h4 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">nwchan     WCHAN     address of the kernel <span class="keyword">function</span> <span class="built_in">where</span> the process</span><br><span class="line">                     is sleeping (use wchan <span class="keyword">if</span> you want the kernel</span><br><span class="line">                     <span class="keyword">function</span> name).  Running tasks will display a</span><br><span class="line">                     dash (<span class="string">&#x27;-&#x27;</span>) <span class="keyword">in</span> this column.</span><br><span class="line">wchan      WCHAN     name of the kernel <span class="keyword">function</span> <span class="keyword">in</span> <span class="built_in">which</span> the process</span><br><span class="line">                     is sleeping, a <span class="string">&quot;-&quot;</span> <span class="keyword">if</span> the process is running, or</span><br><span class="line">                     a <span class="string">&quot;*&quot;</span> <span class="keyword">if</span> the process is multi-threaded and ps is</span><br><span class="line">                     not displaying threads.</span><br><span class="line"><span class="comment"># show full username</span></span><br><span class="line">$ ps axo user:20,pid,pcpu,pmem,vsz,rss,tty,<span class="built_in">stat</span>,start,time,comm</span><br><span class="line"></span><br><span class="line"><span class="comment"># show thread and whan</span></span><br><span class="line">$ ps axHo <span class="built_in">stat</span>,pid,tid,pgid,ppid,comm,cls,cmd,wchan</span><br><span class="line">S&lt;      139    139      0      2 kblockd          TS [kblockd]                   rescuer_thread</span><br><span class="line">S&lt;      141    141      0      2 md               TS [md]                        rescuer_thread</span><br><span class="line">S&lt;      142    142      0      2 edac-poller      TS [edac-poller]               rescuer_thread</span><br><span class="line">S&lt;      143    143      0      2 watchdogd        TS [watchdogd]                 rescuer_thread</span><br><span class="line">S       152    152      0      2 kswapd0          TS [kswapd0]                   kswapd</span><br><span class="line">S       153    153      0      2 kswapd1          TS [kswapd1]                   kswapd</span><br><span class="line"></span><br><span class="line"><span class="comment">#show the pid info process schdule and show the parent id ppid</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -r 99</span><br><span class="line">$ <span class="built_in">setcap</span>  cap_sys_nice=eip  /usr/bin/chrt <span class="comment">## for the non-root user</span></span><br><span class="line">$ chrt -p <span class="variable">$pid</span></span><br><span class="line">$ chrt -b -p <span class="variable">$priority</span> <span class="variable">$pid</span> <span class="comment">## the number higher ,the highest prority is 99</span></span><br><span class="line">$ chrt -m</span><br><span class="line">$ nice -n 5 ./a.out -20~19 <span class="comment"># -19 is the highest prority , it not real-time</span></span><br><span class="line">$ renice 10 <span class="variable">$pid</span></span><br><span class="line">$ pstree -aps <span class="variable">$pid</span></span><br><span class="line">$ ps -efj </span><br><span class="line">$ ps -eo pid,ppid,cmd,%mem,rss,%cpu,policy,ni --sort=-%cpu | head</span><br><span class="line">$ ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head</span><br><span class="line"></span><br><span class="line"><span class="comment"># check the process on which cpu cores</span></span><br><span class="line">$ ps -mo pid,tid,%cpu,psr -p 198851 | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span> | sort -n  | uniq -c</span><br><span class="line">   PID    TID %CPU PSR</span><br><span class="line">198851      -  0.1   -</span><br><span class="line">     - 198851  0.1  15</span><br></pre></td></tr></table></figure>

<h3 id="selinux-1"><a href="#selinux-1" class="headerlink" title="selinux"></a>selinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setroubleshoot</span><br></pre></td></tr></table></figure>

<h3 id="handle-overflow-in-jiffies"><a href="#handle-overflow-in-jiffies" class="headerlink" title="handle overflow in jiffies"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8206762/how-does-linux-handle-overflow-in-jiffies">handle overflow in jiffies</a></h3><p>1ms = millisecond<br>1us = microsecond !=ms, microsecond = us<br>1ns = billisecond = nanosecond<br>1ps = picosecond</p>
<p>/usr/src/kernels/$(uname -r)/include/linux/jiffies.h</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">These inlines deal with timer wrapping correctly. You are </span><br><span class="line">strongly encouraged to use them</span><br><span class="line">1. Because people otherwise forget</span><br><span class="line">2. Because <span class="keyword">if</span> the timer wrap changes <span class="keyword">in</span> future you won<span class="string">&#x27;t have to</span></span><br><span class="line"><span class="string">   alter your driver code.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">time_after(a,b) returns true if the time a is after time b.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>time_before(jiffies, timeout)<br>#define time_before(jiffies, timeout) ((long)(jiffies) - (long)(timeout) &lt; 0)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (time_before(jiffies, timeout)</span><br><span class="line">&#123;</span><br><span class="line">    /* we did not time out, good ... */</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    /* we timed out, error ...*</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,time_before(jiffies,timeout));   </span><br></pre></td></tr></table></figure>


<p>/usr/src/kernels/3.10.0-862.11.6.el7.x86_64/include/generated/autoconf.h</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define CONFIG_HZ 1000</span></span><br></pre></td></tr></table></figure>

<p>/usr/src/kernels/$(uname -r)/include/asm-generic/param.h<br>1GHz=1000,000,000 Hz<br>1 second/1000000000<br>awk ‘BEGIN{printf “%.9f\n”,1/1000000000}’<br>0.000000001 (1ns/Hz system precision)</p>
<p>Linux kenrel CONFIG_HZ = 1000</p>
<p>Tick = 1sec / CONFIG_HZ= 1ms<br>average 1ms with once interrput, 1000 time interrupt in single second</p>
<p>The timer tick is a timer interrupt that is usually generated HZ times per second<br>jiffies means the unit of time</p>
<p>the kernel use some macros prevent an overflow, eg: time_before</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#incldue <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> i,j,k</span><br><span class="line">j = jiffies;</span><br><span class="line">i = j + HZ;</span><br><span class="line">k = j + HZ*<span class="number">1000</span>;</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uapi/asm-generic/param.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">undef</span> HZ</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> HZ		CONFIG_HZ	<span class="comment">/* Internal kernel timer frequency */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> USER_HZ	100		<span class="comment">/* some user interfaces are */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CLOCKS_PER_SEC	(USER_HZ)       <span class="comment">/* in &quot;ticks&quot; like times() */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __ASM_GENERIC_PARAM_H */</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Prevent-the-data-be-deleted"><a href="#Prevent-the-data-be-deleted" class="headerlink" title="Prevent the data be deleted"></a>Prevent the data be deleted</h3><p>If you files system support attr</p>
<ul>
<li>: Adds the attribute to the existing attribute of the files.<br>– : Removes the attribute to the existing attribute of the files.<br>= : Keep the existing attributes that the files have.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ chattr +i -R demo</span><br><span class="line">$ rm -rf demo/</span><br><span class="line">rm: cannot remove ‘demo/0’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/1’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/2’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/3’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/4’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/5’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/6’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/7’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/8’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/9’: Permission denied</span><br><span class="line"></span><br><span class="line">$ lsattr demo/</span><br><span class="line">----i----------- demo/0</span><br><span class="line">----i----------- demo/1</span><br><span class="line">----i----------- demo/2</span><br><span class="line">----i----------- demo/3</span><br><span class="line">----i----------- demo/4</span><br><span class="line">----i----------- demo/5</span><br><span class="line">----i----------- demo/6</span><br><span class="line">----i----------- demo/7</span><br><span class="line">----i----------- demo/8</span><br><span class="line">----i----------- demo/9</span><br><span class="line">$ chattr -i -R demo/</span><br><span class="line">$ rm -f demo/*</span><br><span class="line"></span><br><span class="line"><span class="comment">### could be append</span></span><br><span class="line">$ chattr -R +a demo/</span><br><span class="line">$ <span class="built_in">cd</span> demo/</span><br><span class="line">$ ls</span><br><span class="line">0  1  2  3  4  5  6  7  8  9</span><br><span class="line">$ cat 0</span><br><span class="line">0</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; 0</span><br><span class="line">-bash: 0: Operation not permitted</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt;&gt; 0</span><br><span class="line">$ cat 0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">$ lsattr 0</span><br><span class="line">-----a---------- 0</span><br><span class="line">$ rm -f 0</span><br><span class="line">rm: cannot remove ‘0’: Operation not permitted</span><br><span class="line"></span><br><span class="line">$ chattr -R -a demo</span><br><span class="line">$ rm -f demo/*</span><br></pre></td></tr></table></figure>

<h3 id="errno"><a href="#errno" class="headerlink" title="errno"></a>errno</h3><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/errno.h">https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/errno.h</a><br>$ man 3 erron</p>
<h3 id="tc"><a href="#tc" class="headerlink" title="tc"></a><a target="_blank" rel="noopener" href="https://colobu.com/2017/04/21/tc-introduction/">tc</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## fixed delay</span></span><br><span class="line">$ tc qdisc add dev eth0 root netem delay 100ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## fixed delay range 100ms ± 10ms</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 10ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## This causes the added delay to be 100ms ± 10ms with the next random element depending 25% on the last one. This isn&#x27;t true statistical correlation, but an approximation.</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 10ms 25%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 0.1% package loss</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem loss 0.1%</span><br><span class="line"></span><br><span class="line">$ tc qdisc change dev eth0 root netem loss 0.3% 25%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 1% duplicate package</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem duplicate 1%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 0.1% randomly modify single bit</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem corrupt 0.1%</span><br><span class="line"></span><br><span class="line"><span class="comment">## out of order, 5,10,15,20,25... package send right now, the others delay 10ms, it &#x27;s fixed, not random</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem gap 5 delay 10ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## out of order randomly, 25% will be transmit, the others will be delay 10ms, next and previos has the 50% relevance ??</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 10ms reorder 25% 50%</span><br><span class="line"></span><br><span class="line"><span class="comment">## delay time range at 100ms ± 75ms, it could cause the package out of order</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 75ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## flow control </span></span><br><span class="line">$ tc qdisc add dev eth0 root handle 1:0 netem delay 100ms</span><br><span class="line">$ tc qdisc add dev eth0 parent 1:1 handle 10: tbf rate 256kbit buffer 1600 <span class="built_in">limit</span> 3000</span><br><span class="line">$ tc -s qdisc ls dev eth0</span><br></pre></td></tr></table></figure>

<h3 id="VNC"><a href="#VNC" class="headerlink" title="VNC"></a>VNC</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall -y <span class="string">&quot;GNOME Desktop&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#if there is no another data in this file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;exec gnome-session&quot;</span> &gt; ~/.xinitrc</span><br><span class="line"></span><br><span class="line">systemctl is-enabled vncserver@.service</span><br><span class="line">systemctl <span class="built_in">enable</span> vncserver@.service</span><br><span class="line"></span><br><span class="line">systemctl get-default</span><br><span class="line">systemctl set-default multi-user.target</span><br><span class="line"></span><br><span class="line">cp /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@:4.service</span><br><span class="line">vi /etc/systemd/system/vncserver@:4.service <span class="comment">## replace root user to normal user</span></span><br><span class="line">ExecStart=/usr/sbin/runuser -l root -c <span class="string">&quot;/usr/bin/vncserver %i&quot;</span></span><br><span class="line">PIDFile=/root/.vnc/%H%i.pid</span><br><span class="line"></span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">ln -s <span class="string">&#x27;/etc/systemd/system/vncserver@:4.service&#x27;</span> <span class="string">&#x27;/etc/systemd/system/multi-user.target.wants/vncserver@:4.service&#x27;</span></span><br><span class="line">systemctl <span class="built_in">enable</span> vncserver@:4.service</span><br><span class="line">systemctl start vncserver@:4.service</span><br></pre></td></tr></table></figure>

<h3 id="Vncserer-was-runing-but-there-is-no-desktop-in-centos-7"><a href="#Vncserer-was-runing-but-there-is-no-desktop-in-centos-7" class="headerlink" title="Vncserer was runing, but there is no desktop in centos 7"></a>Vncserer was runing, but there is no desktop in centos 7</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ yum groupinstall Xfce</span><br><span class="line">$ yum install xorg-x11-twm xterm xorg-x11-xinit </span><br><span class="line">$ chmod  755 ~/.vnc/xstartup</span><br><span class="line">$ cat ~/.vnc/xstartup</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> SESSION_MANAGER</span><br><span class="line"><span class="built_in">unset</span> DBUS_SESSION_BUS_ADDRESS</span><br><span class="line"><span class="built_in">exec</span> startxfce4</span><br></pre></td></tr></table></figure>

<h3 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h3><p>copy mode<br>ctrl + A + esc, press space, scroll up and select the text you want<br>and press “space/blank” to copied<br>ctrl + A + c, create a new session, and use vim open a file, press i go to insert mode, and press ctrl + a + ], it will copy all text to vim.<br>background running by screen</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;screen -dmS collectl su -s /bin/bash nobody -c &quot;</span>\<span class="string">&#x27;&quot;collectl --export graphite,10.53.20.206:2003,d=1 -i60 -s CMDN --netfilt &quot;\&quot;&quot;eth|en|p[0-9]|em&quot;\&quot;&quot; --dskfilt &quot;\&quot;&quot;nvme|sd&quot;\&quot;\&#x27;</span></span><br><span class="line">$ ssh -n <span class="variable">$line</span> <span class="string">&quot;sh /home/test001/kill.sh;&quot;</span></span><br><span class="line">$ cat /home/test001/kill.sh</span><br><span class="line">pstree -p | awk -F <span class="string">&#x27;[)( ]+&#x27;</span> <span class="string">&#x27;$0~/screen/&#123;print $3&#125;&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;to kill &quot;</span><span class="variable">$line</span></span><br><span class="line">   pkill -9 -P <span class="variable">$line</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ ssh -n <span class="variable">$line</span> <span class="string">&quot;top -n 3 -b | head&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ssh and awk</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;timeout 60 ssh <span class="variable">$line</span> \&quot;echo ps auxn \\| awk \&#x27;\\\\\\\$1!=0\&#x27; | bash \&quot;&quot;</span></span><br><span class="line">$ ssh root@test_node1 <span class="string">&quot;echo cat /tmp/tmp  \| awk \&#x27;\\\$1!=0\&#x27; | bash &quot;</span></span><br><span class="line">1 1 1</span><br><span class="line"></span><br><span class="line">$ cat hosts | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$line</span> ; ssh -n <span class="variable">$line</span> <span class="string">&quot;pkill lustre_exporter; ps aux | grep run.sh&quot;</span>; scp run.sh <span class="variable">$line</span>:/root/; ssh -n <span class="variable">$line</span> <span class="string">&quot;screen -dmS test_screen /root/run.sh&quot;</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">i=1</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$line</span></span><br><span class="line">ssh <span class="variable">$line</span> <span class="string">&quot;screen -dmS test su -s /bin/bash -c \&quot;cd /<span class="variable">$&#123;i&#125;</span>/test/; source test.sh;sh ./run.sh;\&quot;&quot;</span> &amp;</span><br><span class="line">((i++))</span><br><span class="line"><span class="keyword">done</span> &lt; test_hosts</span><br></pre></td></tr></table></figure>

<h3 id="VLC"><a href="#VLC" class="headerlink" title="VLC"></a>VLC</h3><h4 id="Not-show-media-title"><a href="#Not-show-media-title" class="headerlink" title="Not show media title"></a>Not show media title</h4><p><a target="_blank" rel="noopener" href="https://forum.videolan.org/viewtopic.php?t=50202">Same question</a><br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Show media title on media start (disable it)<br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Enable on screen display (disable it)</p>
<h4 id="Not-resize-interface"><a href="#Not-resize-interface" class="headerlink" title="Not resize interface"></a>Not resize interface</h4><p><img src="/img/vlc-set1.png"></p>
<h3 id="grub"><a href="#grub" class="headerlink" title="grub"></a>grub</h3><p>CentOS 7 add kernel parameter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disable pcie power save</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;pcie_aspm=off scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y consoleblank=0&#x27;</span></span><br><span class="line"></span><br><span class="line">grubby --remove-args=<span class="string">&quot;argX argY&quot;</span> --args=<span class="string">&quot;argA argB&quot;</span> --update-kernel /boot/kernel</span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## kernel boot blacklist</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;modprobe.blacklist=mpt2sas&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## disable screen saver,  The console blank (screen saver) timeout in seconds. </span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;consoleblank=0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## debug boot information, Enabling this can be very useful for tracking down hardware issues.</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;earlyprintk=[ vga | serial ][,ttyS n [, baudrate ]][,keep]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Disable consistent network device naming</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;biosdevname=0&#x27;</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;net.ifnames=0&#x27;</span></span><br><span class="line">or</span><br><span class="line">ln -s /dev/null /etc/udev/rules.d/80-net-name-slot.rules</span><br><span class="line"></span><br><span class="line"><span class="comment">## disable hugepage and avoid vmware hang in ubuntu 20.04</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;transparent_hugepage=never&#x27;</span></span><br><span class="line">$ sysctl -w vm.swappiness=5</span><br><span class="line">And Add swap to 2GB and <span class="built_in">disable</span> nvme write cache <span class="keyword">in</span> vmware disk setting, not the nvme block device</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## set boot order</span></span><br><span class="line">grubby --default-kernel</span><br><span class="line">grubby --default-index</span><br><span class="line">grubby --set-default /boot/vmlinuz-4.2.0-1.fc23.x86_64</span><br><span class="line">grubby --info=ALL</span><br><span class="line">grubby --info /boot/vmlinuz-4.2.0-1.fc23.x86_64</span><br></pre></td></tr></table></figure>

<p>set default boot</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">grubby --info=ALL</span><br><span class="line">index=0</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-514.6.1.el7.x86_64</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-514.6.1.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-514.6.1.el7.x86_64) 7 (Core)</span><br><span class="line">index=1</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-327.el7.x86_64</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-327.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)</span><br><span class="line">index=2</span><br><span class="line">kernel=/boot/vmlinuz-0-rescue-f614a3c482eb4b21add5ae750b3871bb</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-0-rescue-f614a3c482eb4b21add5ae750b3871bb.img</span><br><span class="line">title=CentOS Linux (0-rescue-f614a3c482eb4b21add5ae750b3871bb) 7 (Core)</span><br><span class="line">index=3</span><br><span class="line">non linux entry</span><br><span class="line"></span><br><span class="line">grubby --set-default /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br><span class="line">grubby --info /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br></pre></td></tr></table></figure>
<p>set debug parameters    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;mem=66G&#x27;</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;rd.debug rdudevdebug systemd.log_level=debug systemd.log_target=console console=ttyS1,115200n8&#x27;</span></span><br></pre></td></tr></table></figure>

<p>set kdump</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grubby --update-kernel=ALL --remove-args=<span class="string">&quot;crashkernel=auto&quot;</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;crashkernel=256M@16M&#x27;</span></span><br><span class="line"><span class="comment">#an additional 64MB added for each TB of physical RAM present in the system. So for example if a system has 1TB of memory 192MB (128MB + 64MB) will be reserved</span></span><br><span class="line"><span class="comment">#after you set 256M@16M</span></span><br><span class="line">$ cat /sys/kernel/kexec_crash_size</span><br><span class="line">268435456</span><br></pre></td></tr></table></figure>
<p>crashkernel=X@Y<br>X: denotes how much memory to reserve for the second kernel(capture kernel)<br>Y: denotes what physical address the reserved memory section starts<br>X-Y=Z: Capture kernel runs form reserved memory location(Z)    </p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/3700611">set the early kdump in RHEL 8</a></p>
<ul>
<li>Early kdump is a new feature of the kdump mechanism to capture the kernel crash dump of the booting kernel</li>
<li>In earlier releases of RHEL(5/6/7), the kdump service starts too late during the boot sequence, so early crashes will have no chance to get kdump kernel booting, this will cause crash information to be lost.</li>
<li>Early Kdump stores the vmlinuz and initramfs of the crash kernel inside the initramfs of the booting kernel and load them directly into the reserved memory (crashkernel) during early boot stage.</li>
<li>Two dracut modules are added in the kexec-tools package in order to load crash kernel and initramfs as early as possible during the boot sequence to capture the kernel crash dump of the booting kernel.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> kdump</span><br><span class="line">$ systemctl start kdump</span><br><span class="line">$ dracut --list-modules | grep earlykdump</span><br><span class="line">$ touch /etc/systemd/system/sysrq.service</span><br><span class="line">$ chmod 664 /etc/systemd/system/sysrq.service</span><br><span class="line">$ cat /etc/systemd/system/sysrq.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Custom SysRq Service to <span class="built_in">test</span> early kdump</span><br><span class="line">Before=kdump.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/early-kdump-test.sh</span><br><span class="line">Type=simple</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line"></span><br><span class="line">$ cat /usr/<span class="built_in">local</span>/early-kdump-test.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">/usr/bin/grep <span class="string">&quot;early_panic&quot;</span> /proc/cmdline&gt; /dev/null</span><br><span class="line">output=$(<span class="built_in">echo</span> $?)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$output</span> -eq <span class="string">&quot;0&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/early-kdump-test.sh</span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> sysrq.service</span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;early_panic&#x27;</span></span><br><span class="line">or</span><br><span class="line">$ dracut -f --add earlykdump </span><br><span class="line">$ journalctl -x | grep early-kdump </span><br></pre></td></tr></table></figure>

<h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><h4 id="nolock"><a href="#nolock" class="headerlink" title="nolock"></a><a target="_blank" rel="noopener" href="https://linux.die.net/man/5/nfs">nolock</a></h4><p>NLM locking is used for this mount point. When using the nolock option, applications can lock files, but such locks provide exclusion only against other applications running on the same client. Remote applications are not affected by these locks.</p>
<h4 id="file-lock"><a href="#file-lock" class="headerlink" title="file lock"></a><a target="_blank" rel="noopener" href="https://docstore.mik.ua/orelly/networking_2ndEd/nfs/ch11_02.htm">file lock</a></h4><p>The NFS (Versions 2 and 3) protocol does not support file locking, but the NFS environment supports an ancillary protocol called NLM, which originally stood for “Network Lock Manager.” When an NFS filesystem on an NFS client gets a request to lock a file, instead of an NFS remote procedure call, it generates an NLM remote procedure call.</p>
<p>The NLM protocol consists of remote procedure calls that pattern fcntl arguments and results. Because blocking locks are supported (a process blocks waiting for a lock that conflicts with another holder), the NLM protocol has the notion of callbacks, from the file server to the NLM client to notify that a lock is available. In this way, the NLM client sometimes acts as an RPC server in order to receive delayed results from lock calls.</p>
<h3 id="How-could-I-found-which-file-cause-pipe-hang"><a href="#How-could-I-found-which-file-cause-pipe-hang" class="headerlink" title="How could I found which file cause pipe hang"></a>How could I found which file cause pipe hang</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat /dev/zero | tee /tank/the_file</span><br><span class="line">$ ps aux | grep 63488</span><br><span class="line">root      63488  5.2  0.0 107972   676 pts/9    S+   04:32   0:19 cat /dev/zero</span><br><span class="line"></span><br><span class="line">$ strace -p 63488</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536</span><br><span class="line">strace: Process 63488 detached</span><br><span class="line"></span><br><span class="line">$ ls -l /proc/63488/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 0 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 1 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 3 -&gt; /dev/zero</span><br><span class="line">$ lsof | grep 36710085</span><br><span class="line">cat        63488           root    1w     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line">tee        63489           root    0r     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line">$ ls -l /proc/63489/fd</span><br><span class="line">total 0</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 0 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 1 -&gt; /dev/pts/9</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 3 -&gt; /tank/the_file</span><br></pre></td></tr></table></figure>
<h4 id="If-pipe-change-to-socket"><a href="#If-pipe-change-to-socket" class="headerlink" title="If pipe change to socket"></a>If pipe change to socket</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ll /proc/333709/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 0 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 10 -&gt; socket:[326105]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 11 -&gt; socket:[326106]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 3 -&gt; socket:[304292]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 4 -&gt; socket:[304294]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 5 -&gt; socket:[304295]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 6 -&gt; socket:[304296]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 7 -&gt; socket:[304297]</span><br><span class="line">lr-x------ 1 root root 64 Mar 20 03:24 8 -&gt; /run/rpcbind.lock</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 9 -&gt; socket:[334786]</span><br><span class="line"></span><br><span class="line"><span class="comment">#304294 is inode</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/net/tcp | grep -Ei <span class="string">&#x27;local_address|304294&#x27;</span></span><br><span class="line">sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode</span><br><span class="line">8: 00000000:006F 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 304294 1 ffff9ac0e2f8be00 100 0 0 10 0</span><br></pre></td></tr></table></figure>

<h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a><a target="_blank" rel="noopener" href="https://gist.github.com/tuxfight3r/9ac030cb0d707bb446c7">tcpdump</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define ETH_P_PAUSE 0x8808 /* IEEE Pause frames</span></span><br><span class="line">$ tcpdump -w test.pcap -i bond0 ether proto 0x8808</span><br><span class="line"></span><br><span class="line"><span class="comment"># get ack and syn packet</span></span><br><span class="line">$ tcpdump <span class="string">&quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">$ tcpdump -n -i eth0 -A -x dst port 443 and greater 100</span><br><span class="line">$ tcpdump -i eth0 -nt -s 500 port 53 and udp</span><br><span class="line">$ tcpdump -ni enp97s0f0 -s0 -w /tmp/capture.pcap host <span class="variable">$hostname1</span></span><br><span class="line"></span><br><span class="line">$ <span class="comment">##TCP FLAGS##</span></span><br><span class="line"></span><br><span class="line">Unskilled Attackers Pester Real Security Folks</span><br><span class="line">==============================================</span><br><span class="line">                     TCPDUMP FLAGS</span><br><span class="line">Unskilled =  URG  =  (Not Displayed <span class="keyword">in</span> Flag Field, Displayed elsewhere) </span><br><span class="line">Attackers =  ACK  =  (Not Displayed <span class="keyword">in</span> Flag Field, Displayed elsewhere)</span><br><span class="line">Pester    =  PSH  =  [P] (Push Data)</span><br><span class="line">Real      =  RST  =  [R] (Reset Connection)</span><br><span class="line">Security  =  SYN  =  [S] (Start Connection)</span><br><span class="line">Folks     =  FIN  =  [F] (Finish Connection)</span><br><span class="line">          SYN-ACK =  [S.] (SynAcK Packet)</span><br><span class="line">                     [.] (No Flag Set)</span><br><span class="line"></span><br><span class="line"><span class="comment">##USAGE##</span></span><br><span class="line">Basic communication // see the basics without many options</span><br><span class="line"><span class="comment"># tcpdump -nS</span></span><br><span class="line"></span><br><span class="line">Basic communication (very verbose) // see a good amount of traffic, with verbosity and no name <span class="built_in">help</span></span><br><span class="line"><span class="comment"># tcpdump -nnvvS</span></span><br><span class="line"></span><br><span class="line">A deeper look at the traffic // adds -X <span class="keyword">for</span> payload but doesn’t grab any more of the packet</span><br><span class="line"><span class="comment"># tcpdump -nnvvXS</span></span><br><span class="line"></span><br><span class="line">Heavy packet viewing // the final “s” increases the snaplength, grabbing the whole packet</span><br><span class="line"><span class="comment"># tcpdump -nnvvXSs 1514</span></span><br><span class="line"></span><br><span class="line">host // look <span class="keyword">for</span> traffic based on IP address (also works with hostname <span class="keyword">if</span> you’re not using -n) </span><br><span class="line"><span class="comment"># tcpdump host 1.2.3.4</span></span><br><span class="line"></span><br><span class="line">src, dst // find traffic from only a <span class="built_in">source</span> or destination (eliminates one side of a host conversation) </span><br><span class="line"><span class="comment"># tcpdump src 2.3.4.5 </span></span><br><span class="line"><span class="comment"># tcpdump dst 3.4.5.6</span></span><br><span class="line"></span><br><span class="line">net // capture an entire network using CIDR notation </span><br><span class="line"><span class="comment"># tcpdump net 1.2.3.0/24</span></span><br><span class="line"></span><br><span class="line">proto // works <span class="keyword">for</span> tcp, udp, and icmp. Note that you don’t have to <span class="built_in">type</span> proto </span><br><span class="line"><span class="comment"># tcpdump icmp</span></span><br><span class="line"></span><br><span class="line">port // see only traffic to or from a certain port </span><br><span class="line"><span class="comment"># tcpdump port 3389</span></span><br><span class="line"></span><br><span class="line">src, dst port // filter based on the <span class="built_in">source</span> or destination port </span><br><span class="line"><span class="comment"># tcpdump src port 1025 # tcpdump dst port 389</span></span><br><span class="line"></span><br><span class="line">src/dst, port, protocol // combine all three </span><br><span class="line"><span class="comment"># tcpdump src port 1025 and tcp </span></span><br><span class="line"><span class="comment"># tcpdump udp and src port 53</span></span><br><span class="line"></span><br><span class="line">You also have the option to filter by a range of ports instead of declaring them individually, and to only see packets that are above or below a certain size.</span><br><span class="line"></span><br><span class="line">Port Ranges // see traffic to any port <span class="keyword">in</span> a range </span><br><span class="line">tcpdump portrange 21-23</span><br><span class="line"></span><br><span class="line">Packet Size Filter // only see packets below or above a certain size (<span class="keyword">in</span> bytes) </span><br><span class="line">tcpdump less 32 </span><br><span class="line">tcpdump greater 128</span><br><span class="line">[ You can use the symbols <span class="keyword">for</span> less than, greater than, and less than or equal / greater than or equal signs as well. ]</span><br><span class="line"></span><br><span class="line">// filtering <span class="keyword">for</span> size using symbols </span><br><span class="line">tcpdump &gt; 32 </span><br><span class="line">tcpdump &lt;= 128</span><br><span class="line"></span><br><span class="line">[ Note: Only the PSH, RST, SYN, and FIN flags are displayed <span class="keyword">in</span> tcpdump‘s flag field output. URGs and ACKs are displayed, but they are shown elsewhere <span class="keyword">in</span> the output rather than <span class="keyword">in</span> the flags field ]</span><br><span class="line"></span><br><span class="line">Keep <span class="keyword">in</span> mind the reasons these filters work. The filters above find these various packets because tcp[13] looks at offset 13 <span class="keyword">in</span> the TCP header, the number represents the location within the byte, and the !=0 means that the flag <span class="keyword">in</span> question is <span class="built_in">set</span> to 1, i.e. it’s on.</span><br><span class="line"></span><br><span class="line">Show all URG packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 32 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all ACK packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 16 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all PSH packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 8 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all RST packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 4 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all SYN packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 2 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all FIN packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 1 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all SYN-ACK packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] = 18&#x27;</span></span><br><span class="line"></span><br><span class="line">Show icmp <span class="built_in">echo</span> request and reply</span><br><span class="line"><span class="comment">#tcpdump -n icmp and &#x27;icmp[0] != 8 and icmp[0] != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all IP packets with a non-zero TOS field (one byte TOS field is at offset 1 <span class="keyword">in</span> IP header):</span><br><span class="line"><span class="comment"># tcpdump -v -n ip and ip[1]!=0</span></span><br><span class="line"></span><br><span class="line">Show all IP packets with TTL less than some value (on byte TTL field is at offset 8 <span class="keyword">in</span> IP header):</span><br><span class="line"><span class="comment"># tcpdump -v ip and &#x27;ip[8]&lt;2&#x27;</span></span><br><span class="line"></span><br><span class="line">Show TCP SYN packets:</span><br><span class="line"><span class="comment"># tcpdump -n tcp and port 80 and &#x27;tcp[tcpflags] &amp; tcp-syn == tcp-syn&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump tcp and port 80 and &#x27;tcp[tcpflags] == tcp-syn&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-syn) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show TCP ACK packets:</span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-ack) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show TCP SYN/ACK packets (typically, responses from servers):</span><br><span class="line"><span class="comment"># tcpdump -n tcp and &#x27;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) == (tcp-syn|tcp-ack)&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump -n tcp and &#x27;tcp[tcpflags] &amp; tcp-syn == tcp-syn&#x27; and &#x27;tcp[tcpflags] &amp; tcp-ack == tcp-ack&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show TCP FIN packets:</span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-fin) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show ARP Packets with MAC address</span><br><span class="line"><span class="comment"># tcpdump -vv -e -nn ether proto 0x0806</span></span><br><span class="line"></span><br><span class="line">Show packets of a specified length (IP packet length (16 bits) is located at offset 2 <span class="keyword">in</span> IP header):</span><br><span class="line"><span class="comment"># tcpdump -l icmp and &#x27;(ip[2:2]&gt;50)&#x27; -w - |tcpdump -r - -v ip and &#x27;(ip[2:2]&lt;60)&#x27;</span></span><br><span class="line"></span><br><span class="line">http://danielmiessler.com/study/tcpdump/</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.wains.be/pub/networking/tcpdump_advanced_filters.txt">tcpdump_advanced_filters</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- This rule will match any TCP traffic on port 80 (web) with 192.168.1.254 or 192.168.1.200 as destination host</span><br><span class="line"><span class="comment"># tcpdump -i eth1 &#x27;((tcp) and (port 80) and ((dst host 192.168.1.254) or (dst host 192.168.1.200)))&#x27;</span></span><br><span class="line"></span><br><span class="line">- Will match any ICMP traffic involving the destination with physical/MAC address 00:01:02:03:04:05</span><br><span class="line"><span class="comment"># tcpdump -i eth1 &#x27;((icmp) and ((ether dst host 00:01:02:03:04:05)))&#x27;</span></span><br><span class="line"></span><br><span class="line">- Will match any traffic <span class="keyword">for</span> the destination network 192.168 except destination host 192.168.1.200</span><br><span class="line"><span class="comment"># tcpdump -i eth1 &#x27;((tcp) and ((dst net 192.168) and (not dst host 192.168.1.200)))&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="calculate-upload-download-speed-by-ping"><a href="#calculate-upload-download-speed-by-ping" class="headerlink" title="calculate upload/download speed by ping"></a><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/4575537/calculate-upload-download-speed-by-ping">calculate upload/download speed by ping</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ping -f -c 10000 -s 1472 10.100.100.100</span><br></pre></td></tr></table></figure>
<p>At the end of the result i get: round-trip min/avg/max/stddev = 0.174/0.219/2.078/0.020 ms<br>so in average it takes 0.219 ms to send 1500 bytes and receive 1500 bytes, that’s 24 kb. 24 kb / 0.219 ms = 110 Mb/s<br>If you want to use that to a server on the internet, you need to lower the packet size to something like 1464 (for MTU 1492), drop the -f option and lower the count so it won’t take too long to finish.</p>
<p>1500 TX Bytes + 1500 RX Bytes= 3000 Bytes = 3000 * 8 = 24000 bits<br>24000 / 0.219 = 109.589 Mb/s</p>
<p>It ‘s not represent full throughput. just test single link in your ethernet adapter. not parallel.</p>
<h3 id="MTU-problem-check"><a href="#MTU-problem-check" class="headerlink" title="MTU problem check"></a>MTU problem check</h3><p>Level 3 network, between 2 nodes pass through gateway<br>Tcpdump show some packets loss, nmap show 10.xx.xx.clent port is “open”.<br>There are some packages return, some will not. Does it MTU problem ? ping could check it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping -f -c 20000 -M <span class="keyword">do</span> -s 8972 10.xx.xx.client</span><br><span class="line">PING 10.xx.xx.client (10.xx.xx.client) 8972(9000) bytes of data.</span><br><span class="line">...................................................................^C</span><br><span class="line">--- 10.xx.xx.client ping statistics ---</span><br><span class="line">67 packets transmitted, 0 received, 100% packet loss, time 1076ms</span><br></pre></td></tr></table></figure>
<p>You can got the issue from tcpdump, all larger than 1500 packets are loss.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">client <span class="comment"># tcpdump -v host 10.53.19.52 and greater 1500</span></span><br><span class="line">tcpdump: listening on bond0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">11:23:58.134708 IP (tos 0x0, ttl 63, id 27071, offset 0, flags [DF], proto TCP (6), length 8532)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [P.], cksum 0x496d (incorrect -&gt; 0x5fe6), seq 2359537411:2359545891, ack 3804990367, win 53, options [nop,nop,TS val 1203816317 ecr 81802289], length 8480</span><br><span class="line">11:23:58.136045 IP (tos 0x0, ttl 63, id 27077, offset 0, flags [DF], proto TCP (6), length 7292)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [.], cksum 0x4495 (incorrect -&gt; 0xe386), seq 8480:15720, ack 1, win 53, options [nop,nop,TS val 1203816318 ecr 81802294], length 7240</span><br><span class="line">11:23:58.148023 IP (tos 0x0, ttl 63, id 27083, offset 0, flags [DF], proto TCP (6), length 8588)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [P.], cksum 0x49a5 (incorrect -&gt; 0x4006), seq 17016:25552, ack 1, win 53, options [nop,nop,TS val 1203816330 ecr 81802295], length 8536</span><br></pre></td></tr></table></figure>
<p>If client MTU is 1500, tcpdump(client) will not receive any large packages. they are loss in switch.</p>
<h3 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h3><h4 id="Exclude-packages"><a href="#Exclude-packages" class="headerlink" title="Exclude packages"></a>Exclude packages</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install --enablerepo=<span class="string">&quot;epel&quot;</span> iotop</span><br><span class="line">$ yum update --exclude=kernel*</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">cachedir=/var/cache/yum/<span class="variable">$basearch</span>/<span class="variable">$releasever</span></span><br><span class="line">keepcache=0</span><br><span class="line">debuglevel=2</span><br><span class="line">logfile=/var/<span class="built_in">log</span>/yum.log</span><br><span class="line">exclude=kernel* redhat-release* *.i?86</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/10185">reference</a></p>
<h4 id="Switch-version"><a href="#Switch-version" class="headerlink" title="Switch version"></a>Switch version</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ yum --showduplicates list kernel</span><br><span class="line">Installed Packages</span><br><span class="line">Installed Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       @anaconda-CentOS-201508042137.x86_64/6.7</span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   @update                                 </span><br><span class="line">Available Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       base                                    </span><br><span class="line">kernel.x86_64       2.6.32-573.1.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.3.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.7.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.12.1.el6  update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.18.1.el6  update  </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### Yum.conf</span></span><br><span class="line">```apacheconf</span><br><span class="line">keepcache = 1</span><br></pre></td></tr></table></figure>

<h4 id="Download-to-local"><a href="#Download-to-local" class="headerlink" title="Download to local"></a>Download to local</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">yum-plugin-downloadonly</span></span><br><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">--downloadonly</span> <span class="string">--downloaddir=&lt;directory&gt;</span> <span class="string">&lt;package&gt;</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/10154">reference</a></p>
<h4 id="Resolve-dependency-resolution-errors"><a href="#Resolve-dependency-resolution-errors" class="headerlink" title="Resolve dependency resolution errors"></a>Resolve dependency resolution errors</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum update</span></span><br><span class="line">** Found 5 pre-existing rpmdb problem(s), <span class="string">&#x27;yum check&#x27;</span> output follows:</span><br><span class="line">MegaCli-8.04.10-1.noarch is a duplicate with MegaCli-8.04.07-1.noarch</span><br><span class="line">kernel-2.6.32-279.5.1.el6_lustre.gb16fe80.x86_64 has missing requires of kernel-firmware &gt;= (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2.6.32&#x27;</span>, <span class="string">&#x27;279.5.1.el6_lustre.gb16fe80&#x27;</span>)</span><br><span class="line">kernel-firmware-2.6.32-279.5.1.el6.noarch is a duplicate with kernel-firmware-2.6.32-279.el6.noarch</span><br><span class="line">kernel-headers-2.6.32-279.5.1.el6.x86_64 is a duplicate with kernel-headers-2.6.32-279.el6.x86_64</span><br><span class="line">libcom_err-1.42.3.wc3-7.el6.x86_64 is a duplicate with libcom_err-1.41.12-12.el6.i686</span><br><span class="line">......</span><br><span class="line">You could try using --skip-broken to work around the problem</span><br><span class="line">You could try running: rpm -Va --nofiles --nodigest</span><br></pre></td></tr></table></figure>

<h4 id="Uninstall-rpm-packages-from-rpmdb"><a href="#Uninstall-rpm-packages-from-rpmdb" class="headerlink" title="Uninstall rpm packages from rpmdb"></a>Uninstall rpm packages from rpmdb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -e --justdb --nodeps <span class="string">&quot;bad rpm packages&quot;</span></span><br><span class="line">$ rpm -ivh --force <span class="string">&quot;replace normal rpm packages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rebuild rpmdb</span></span><br><span class="line">$ <span class="built_in">cd</span> /var/lib/rpm</span><br><span class="line">$ rm  -f __db*</span><br><span class="line">$ rpm --rebuilddb </span><br><span class="line"></span><br><span class="line">$ yum clean all</span><br><span class="line">$ yum -y update</span><br></pre></td></tr></table></figure>

<h3 id="upgrade-kernel"><a href="#upgrade-kernel" class="headerlink" title="upgrade kernel"></a>upgrade kernel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://sourceware.org/elfutils/ftp/0.170/elfutils-0.170.tar.bz2</span><br><span class="line">$ tar xjvf elfutils-0.170.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> ./elfutils-0.170</span><br><span class="line">$ ./configire; make -j 8; make install</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=/sources/kernel/elfutils-0.170/libelf:/sources/lib/el7/mpich-3.2.1/include/:<span class="variable">$C_INCLUDE_PATH</span></span><br><span class="line">$ cp -v /boot/config-3.10.0-693.21.1.el7.x86_64 .config</span><br><span class="line">make menuconfig</span><br><span class="line">make rpm-pkg</span><br><span class="line"><span class="comment">### enable what your want</span></span><br></pre></td></tr></table></figure>

<h4 id="BBR"><a href="#BBR" class="headerlink" title="BBR"></a>BBR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;net.core.default_qdisc=fq&#x27;</span> | sudo tee -a /etc/sysctl.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.tcp_congestion_control=bbr&#x27;</span> | sudo tee -a /etc/sysctl.conf</span><br><span class="line">sudo sysctl -p</span><br><span class="line"></span><br><span class="line">$ sysctl net.ipv4.tcp_available_congestion_control</span><br><span class="line">net.ipv4.tcp_available_congestion_control = cubic bbr reno</span><br><span class="line"></span><br><span class="line">$ sysctl -n net.ipv4.tcp_congestion_control</span><br><span class="line">bbr</span><br></pre></td></tr></table></figure>

<h3 id="reinstall-grub2-from-boot-livecd"><a href="#reinstall-grub2-from-boot-livecd" class="headerlink" title="reinstall grub2 from boot livecd"></a>reinstall grub2 from boot livecd</h3><p>/dev/sdd2 is my linux root partition, OS is pinguyos(ubuntu)</p>
<h4 id="LVM-partition"><a href="#LVM-partition" class="headerlink" title="LVM partition"></a>LVM partition</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vgscan</span><br><span class="line">$ lvscan</span><br><span class="line">$ lvchange -a y /dev/centos_vg/lv_root</span><br></pre></td></tr></table></figure>

<h4 id="Test-in-ubuntu"><a href="#Test-in-ubuntu" class="headerlink" title="Test in ubuntu"></a>Test in ubuntu</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdd2 /opt</span><br><span class="line">mount --<span class="built_in">bind</span> /dev/ /opt/dev</span><br><span class="line">mount --<span class="built_in">bind</span> /sys/ /opt/sys</span><br><span class="line">mount --<span class="built_in">bind</span> /proc /opt/proc</span><br><span class="line">chroot /opt</span><br><span class="line">grub-install /dev/sdd</span><br><span class="line">grub-install --root-directory=/mnt/sysimages/boot/efi /dev/sdd</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>

<h4 id="Test-in-CentOS-7-set-boot-menu"><a href="#Test-in-CentOS-7-set-boot-menu" class="headerlink" title="Test in CentOS 7, set boot menu"></a>Test in CentOS 7, set boot menu</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat   /boot/grub2/grub.cfg | grep Windows</span><br><span class="line">menuentry <span class="string">&quot;Windows 7 (loader) (on /dev/sda1)&quot;</span></span><br><span class="line">grub2-set-default  <span class="string">&quot;Windows 7 (loader) (on /dev/sda1)&quot;</span></span><br><span class="line">grub2-editenv list</span><br><span class="line">saved_entry=Windows 7 (loader) (on /dev/sda1)</span><br><span class="line">or </span><br><span class="line">grub2-set-default <span class="string">&quot;windows&quot;</span></span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.conf</span><br></pre></td></tr></table></figure>

<h4 id="Re-install-EFI"><a href="#Re-install-EFI" class="headerlink" title="Re-install EFI"></a>Re-install EFI</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /opt/boot /opt/root</span><br><span class="line">$ mount /dev/sda1 /opt/root</span><br><span class="line">$ mount /dev/sda2 /opt/root/boot/efi</span><br><span class="line"></span><br><span class="line">$ mount --<span class="built_in">bind</span> /dev/ /opt/dev</span><br><span class="line">$ mount --<span class="built_in">bind</span> /sys/ /opt/sys</span><br><span class="line">$ mount --<span class="built_in">bind</span> /proc /opt/proc</span><br><span class="line"></span><br><span class="line">$ chroot /opt</span><br><span class="line"></span><br><span class="line">$ grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class="line">$ yum install grub2-efi</span><br><span class="line">$ efibootmgr -c --disk /dev/sda --part 2 -l <span class="string">&#x27;\EFI\centos\shimx64.efi&#x27;</span> -L <span class="string">&quot;CentOS Linux&quot;</span>    </span><br><span class="line">// --part 2 point EFI partition number,-l \\EFI\\FEDORA\\GRUBX64.EFI point the GRUB EFI boot loader</span><br></pre></td></tr></table></figure>

<h3 id="rdesktop-to-win10"><a href="#rdesktop-to-win10" class="headerlink" title="rdesktop to win10"></a>rdesktop to win10</h3><h4 id="Enable-remote-desktop"><a href="#Enable-remote-desktop" class="headerlink" title="Enable remote desktop"></a>Enable remote desktop</h4><p><img src="/img/e_desktop.png"><br><img src="/img/e_firewall.png"></p>
<h4 id="Modify-registry-from-win10"><a href="#Modify-registry-from-win10" class="headerlink" title="Modify registry from win10"></a>Modify registry from win10</h4><p>\HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\SecurityLayer<br>from DWORD Hex ‘2’ to a value of ‘1’</p>
<p><a target="_blank" rel="noopener" href="http://ubuntuforums.org/showthread.php?t=2287213">reference</a></p>
<h3 id="record-and-replay-linux-terminal"><a href="#record-and-replay-linux-terminal" class="headerlink" title="record and replay linux terminal"></a>record and replay linux terminal</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ script --timing=time.txt script.log</span><br><span class="line"><span class="comment"># record what you do</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ scriptreplay --timing=time.txt script.log</span><br><span class="line"><span class="comment"># replay</span></span><br></pre></td></tr></table></figure>

<h3 id="traceroute-error"><a href="#traceroute-error" class="headerlink" title="traceroute error"></a><a target="_blank" rel="noopener" href="https://www.ibm.com/support/knowledgecenter/TI0003M/p8hcg/p8hcg_traceroute.htm">traceroute error</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">!H</span><br><span class="line">Host unreachable</span><br><span class="line">!N</span><br><span class="line">Network unreachable</span><br><span class="line">!P</span><br><span class="line">Protocol unreachable</span><br><span class="line">!S</span><br><span class="line">Source route failed</span><br><span class="line">!F</span><br><span class="line">Fragmentation needed</span><br></pre></td></tr></table></figure>

<h3 id="Getting-Error-su-cannot-set-user-id-Resource-temporarily-unavailable"><a href="#Getting-Error-su-cannot-set-user-id-Resource-temporarily-unavailable" class="headerlink" title="Getting Error su: cannot set user id: Resource temporarily unavailable"></a>Getting Error su: cannot set user id: Resource temporarily unavailable</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -u </span><br><span class="line"><span class="number">1024</span></span><br><span class="line"></span><br><span class="line">$ ulimit -u <span class="number">10240</span></span><br><span class="line"></span><br><span class="line">$ <span class="regexp">/etc/</span>security/limits.conf</span><br><span class="line">testuser         -      nproc          <span class="number">10240</span></span><br><span class="line"></span><br><span class="line">$ cat <span class="regexp">/proc/</span>sys<span class="regexp">/kernel/</span>threads-max</span><br><span class="line"><span class="number">1026188</span></span><br></pre></td></tr></table></figure>

<h3 id="lshw"><a href="#lshw" class="headerlink" title="lshw"></a>lshw</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lshw -c network -businfo</span><br><span class="line">Bus info          Device      Class          Description</span><br><span class="line">========================================================</span><br><span class="line">pci@0000:04:00.0  em1         network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe</span><br><span class="line">pci@0000:04:00.1  em2         network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe</span><br><span class="line">pci@0000:65:00.0  p2p1        network        Ethernet 10G 2P X520 Adapter</span><br><span class="line">pci@0000:65:00.1  p2p2        network        Ethernet 10G 2P X520 Adapter</span><br><span class="line">                  bond0       network        Ethernet interface</span><br></pre></td></tr></table></figure>

<h3 id="CentOS8"><a href="#CentOS8" class="headerlink" title="CentOS8"></a>CentOS8</h3><h4 id="bonding"><a href="#bonding" class="headerlink" title="bonding"></a>bonding</h4><p>Because my ansible was generate the config file in network-scripts, but restart NetworkManger centos 8 not work.<br>I got the compatible mode.</p>
<p>Load the config same with centos 7, after loading, it will work in centos 8<br>Please don’t add “NM_CONTROLLED=no”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-bond0</span><br><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-enp1s0f0</span><br><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-enp1s0f1</span><br><span class="line">$ nmcli connection reload</span><br></pre></td></tr></table></figure>

<h5 id="bonding-parameters"><a href="#bonding-parameters" class="headerlink" title="bonding parameters"></a>bonding parameters</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BONDING_OPTS=<span class="string">&quot;mode=4 miimon=100 lacp_rate=fast xmit_hash_policy=layer3+4 arp_validate=0 updelay=30000&quot;</span></span><br><span class="line"></span><br><span class="line">BONDING_OPTS=<span class="string">&quot;mode=1 arp_interval=1000 arp_ip_target=&#123;&#123; gateway &#125;&#125; arp_validate=all&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/30732">none (0)</a><ul>
<li>active<ul>
<li>MII Status is UP as long as any network frame is received within arp_interval × 2</li>
</ul>
</li>
<li>inactive<ul>
<li>MII Status is UP as long as any network frame is received within arp_interval × 2</li>
</ul>
</li>
</ul>
</li>
<li>active (1)<ul>
<li>active<ul>
<li>MII Status is UP as long as an ARP Response is received from the arp_ip_target within arp_interval × 2</li>
</ul>
</li>
<li>inactive<ul>
<li>MII Status is UP as long as any network frame is received within arp_interval × 2</li>
</ul>
</li>
</ul>
</li>
<li>backup (2)<ul>
<li>active<ul>
<li>MII Status is UP as long as any network frame is received within arp_interval × 2</li>
</ul>
</li>
<li>inactive<ul>
<li>MII Status is UP as long as the broadcast ARP Requests sent to the arp_ip_target by the Active Slave are seen within arp_interval × 2</li>
</ul>
</li>
</ul>
</li>
<li>all (3)<ul>
<li>active<ul>
<li>MII Status is UP as long as an ARP Response is received from the arp_ip_target within arp_interval × 2</li>
</ul>
</li>
<li>inactive<ul>
<li>MII Status is UP as long as the broadcast ARP Requests sent to the arp_ip_target by the Active Slave are seen within arp_interval × 2</li>
</ul>
</li>
</ul>
</li>
<li>filter (4)<ul>
<li>active<ul>
<li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li>
</ul>
</li>
<li>inactive<ul>
<li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li>
</ul>
</li>
</ul>
</li>
<li>filter_active (5)<ul>
<li>active<ul>
<li>MII Status is UP as long as an ARP Response is received from the arp_ip_target within arp_interval × 2</li>
</ul>
</li>
<li>inactive<ul>
<li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li>
</ul>
</li>
</ul>
</li>
<li>filter_backup (6)<ul>
<li>active<ul>
<li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li>
</ul>
</li>
<li>inactive<ul>
<li>MII Status is UP as long as the broadcast ARP Requests sent to the arp_ip_target by the Active Slave are seen within arp_interval × 2</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="fio-test-multiple-nodes"><a href="#fio-test-multiple-nodes" class="headerlink" title="fio test multiple nodes"></a>fio test multiple nodes</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ fio --server</span><br><span class="line"><span class="comment">## start fio process in each test server</span></span><br><span class="line"></span><br><span class="line">$ cat fio-test</span><br><span class="line">Server-A-ip</span><br><span class="line">Server-B-ip</span><br><span class="line">Server-C-ip</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ fio --client=fio_hosts.list /mnt/fio.cfg</span><br><span class="line"></span><br><span class="line">All clients: (groupid=0, <span class="built_in">jobs</span>=8): err= 0: pid=0: Fri Mar  6 17:08:04 2020</span><br><span class="line">   <span class="built_in">read</span>: IOPS=1147, BW=1148Mi (1203M)(1011GiB/902172msec)</span><br><span class="line">    slat (nsec): min=58, max=368519, avg=450.92, stdev=799.19</span><br><span class="line">    clat (usec): min=1355, max=4778.4k, avg=58198.62, stdev=114448.04</span><br><span class="line">     lat (usec): min=1356, max=4778.4k, avg=58199.07, stdev=114448.07</span><br><span class="line">   bw (  KiB/s): min= 2043, max=2654208, per=12.74%, avg=149910.02, stdev=178032.72, samples=14109</span><br><span class="line">   iops        : min=    1, max= 2592, avg=146.33, stdev=173.87, samples=14109</span><br><span class="line">  write: IOPS=1146, BW=1146Mi (1202M)(1010GiB/902172msec)</span><br><span class="line">    slat (nsec): min=162, max=916488, avg=799.05, stdev=783.74</span><br><span class="line">    clat (usec): min=1345, max=3839.9k, avg=52775.15, stdev=105530.38</span><br><span class="line">     lat (usec): min=1346, max=3839.9k, avg=52775.95, stdev=105530.41</span><br></pre></td></tr></table></figure>

<h3 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SUID (Set owner User ID up on execution)</span><br><span class="line">chmod 4555/u+s /<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">ls -l /usr/bin/passwd  /etc/shadow</span><br><span class="line">----------  1 root root  1005 Feb 14 14:15 /etc/shadow</span><br><span class="line">-rwsr-xr-x. 1 root root 27856 Aug  9  2019 /usr/bin/passwd</span><br><span class="line"></span><br><span class="line">SUID is defined as giving temporary permissions to a user to run a program/file with the permissions of the file owner rather that the user who runs it</span><br><span class="line"></span><br><span class="line">SGID</span><br><span class="line">chmod 2555/g+s /dir </span><br><span class="line">similar with SUID, it <span class="string">&#x27;s the group bit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Sticky Bit</span></span><br><span class="line"><span class="string">chmod 1777/chmod +t /tmp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- T refers to when the execute permissions are off.</span></span><br><span class="line"><span class="string">- t refers to when the execute permissions are on.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The sticky bit is primarily used on shared directories. </span></span><br><span class="line"><span class="string">[For example if user bob creates a file named /tmp/bob, other user tom can not delete this file even when the /tmp directory has permission of 777. If sticky bit is not set then tom can delete /tmp/bob, as the /tmp/bob file inherits the parent directory permissions.](https://www.thegeekdiary.com/what-is-suid-sgid-and-sticky-bit/)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### set time</span></span><br><span class="line"><span class="string">#### back access time</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">$ atime=$(stat -c%X $filename)</span></span><br><span class="line"><span class="string">$ touch -a --date=@$&#123;atime&#125; $newpath</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ mtime=$(stat -c%Z $filename)</span></span><br><span class="line"><span class="string">$ touch -m --date=@$&#123;mtime&#125; $newpath</span></span><br></pre></td></tr></table></figure>

<h3 id="screen-1"><a href="#screen-1" class="headerlink" title="screen"></a>screen</h3><p>background run command</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;screen -dmS collectl su -s /bin/bash nobody -c &quot;</span>\<span class="string">&#x27;&quot;collectl --export graphite,$ip,d=2 -i60 -s CMDN --netfilt &quot;\&quot;&quot;eth|en|p[0-9]|em&quot;\&quot;&quot; --dskfilt &quot;\&quot;&quot;nvme|sd&quot;\&quot;\&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Add-systemd-service"><a href="#Add-systemd-service" class="headerlink" title="Add systemd service"></a>Add systemd service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/etc/systemd/system/apm.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Local system resume actions</span><br><span class="line">After=suspend.target hybrid-sleep.target hibernate.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/hdparm -B 254 /dev/sda</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sleep.target</span><br></pre></td></tr></table></figure>

<h3 id="route-config"><a href="#route-config" class="headerlink" title="route config"></a>route config</h3><h4 id="static-route"><a href="#static-route" class="headerlink" title="static route"></a>static route</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">subnet mask could be</span><br><span class="line">01011000  255.255.255.88</span><br><span class="line"></span><br><span class="line">just recommend against using noncontiguous subnet masks.</span><br><span class="line"></span><br><span class="line">cat /etc/sysconfig/network-scripts/route-em1</span><br><span class="line">ADDRESS0=10.64.0.0</span><br><span class="line">NETMASK0=255.240.0.0</span><br><span class="line">GATEWAY0=192.168</span><br><span class="line">ADDRESS1=10.200.0.0</span><br><span class="line">NETMASK1=255.252.0.0</span><br><span class="line">GATEWAY1=10.64.64.247</span><br><span class="line">ADDRESS2=10.236.0.0</span><br><span class="line">NETMASK2=255.255.0.0</span><br><span class="line">GATEWAY2=10.64.64.247</span><br></pre></td></tr></table></figure>

<h3 id="Check-NIC-driver-err"><a href="#Check-NIC-driver-err" class="headerlink" title="Check NIC driver err"></a>Check NIC driver err</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S enp129s0f0 | grep -Ei <span class="string">&#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="collectl"><a href="#collectl" class="headerlink" title="collectl"></a>collectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ collectl --top iokb</span><br><span class="line">$ collectl --vmstat</span><br><span class="line">$ collectl -sZ</span><br><span class="line">$ collectl -c10 -f /opt</span><br><span class="line"></span><br><span class="line"><span class="comment">## replay collectl</span></span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT</span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT --from 15:02:00 --thru 15:02:05</span><br><span class="line">$ collectl --<span class="built_in">export</span> graphite,locahost,d=9 -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz</span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT --from <span class="string">&quot;03:30:18&quot;</span> --thru <span class="string">&quot;06:32:08&quot;</span></span><br><span class="line"></span><br><span class="line">$ collectl --showoptions</span><br><span class="line">$ collectl --showsubsys</span><br><span class="line">$ collectl --showsubopts</span><br><span class="line">$ collectl --showtopopts</span><br><span class="line">$ collectl -i3 --<span class="built_in">export</span> graphite,192.168.1.1:2003,b=test-node -sCMDNt --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -m -r00:00,7 -f /var/<span class="built_in">log</span>/collectl --rawtoo</span><br><span class="line">$ collectl -i3 -P -sCMDNt --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -m -r00:00,7 -f /var/<span class="built_in">log</span>/collectl --rawtoo</span><br><span class="line">$ collectl -i3 --<span class="built_in">export</span> graphite,192.168.1.1:2003,d=1,s=dn -sCMDNT --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -rawtoo -f /var/<span class="built_in">log</span>/collectl</span><br><span class="line">$ collectl -i3 --<span class="built_in">export</span> graphite,192.168.1.1:2003,b=test-node -s CMDNt --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> --rawtoo -f /var/<span class="built_in">log</span>/collectl/</span><br><span class="line"><span class="comment">### tip - if you add 8 to the debug flag, eg d=9, this tells the graphite module not to actually establish the connection with graphite&#x27;s carbon listener but to only echo the data that would have been sent.</span></span><br><span class="line">$ collectl --all --<span class="built_in">export</span> graphite,locahost,d=9 --rawtoo -f /var/<span class="built_in">log</span>/collectl/</span><br><span class="line">$ collectl -i3 -sCDNMJFt --<span class="built_in">export</span> graphite,locahost,d=9 --rawtoo -f /var/<span class="built_in">log</span>/collectl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># collectl.conf</span></span><br><span class="line">DaemonCommands = collectl -i30 -sCDEFJMNTXYZs --netfilt <span class="string">&quot;eth|en|p[0-9]|em&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -f /var/<span class="built_in">log</span>/collectl -r00:00,7 -m -F60 --rawtoo -P</span><br></pre></td></tr></table></figure>

<h3 id="process-mointor"><a href="#process-mointor" class="headerlink" title="process mointor"></a>process mointor</h3><p>atop -PMEM not got the right value, do it by yourself</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##process memory overhead</span></span><br><span class="line">awk <span class="string">&#x27;$0~/Pss/&#123;mem+=$2&#125;; END &#123;printf &quot;%.2f GiB\n&quot;, mem/1024/1024&#125;&#x27;</span> /proc/44833/smaps</span><br><span class="line"></span><br><span class="line"><span class="comment">##the system memory overhead</span></span><br><span class="line">awk <span class="string">&#x27;$0~/Pss/&#123;mem+=$2&#125;; END &#123;printf &quot;%.2f GiB\n&quot;, mem/1024/1024&#125;&#x27;</span> /proc/[1-9]*/smaps</span><br></pre></td></tr></table></figure>

<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">## Kill all processes with the ppid</span><br><span class="line">$ pkill -P $$ </span><br><span class="line">$ kill $(ps -o pid= --ppid $$)</span><br><span class="line"></span><br><span class="line">$ top -<span class="keyword">n</span> 3 -b</span><br><span class="line">$ top -b -p 12345</span><br><span class="line">$ pstree -sg 25153 # get process tree</span><br><span class="line">systemd(1)───sshd(3266)───sshd(32704)───hydra_pmi_proxy(32706)───<span class="keyword">test</span>.<span class="keyword">sh</span>(32725)</span><br><span class="line"></span><br><span class="line">$ pstree -sga 32725</span><br><span class="line">systemd,1 --switched-root --system --deserialize 22</span><br><span class="line">  └─sshd,3266 -<span class="keyword">D</span></span><br><span class="line">      └─sshd,32704</span><br><span class="line">          └─hydra_pmi_proxy,32706 --control-port centos7-<span class="keyword">test</span>:38001 --rmk user --launcher ssh --demux poll --pgid 0 --retries 10--<span class="keyword">u</span></span><br><span class="line">              └─<span class="keyword">test</span>.<span class="keyword">sh</span>,32725 /root/<span class="keyword">test</span>.<span class="keyword">sh</span> /mnt</span><br><span class="line"></span><br><span class="line">$ pidstat -drsuw</span><br><span class="line"><span class="comment">    * CPU utilization</span></span><br><span class="line"><span class="comment">    * IO</span></span><br><span class="line"><span class="comment">    * page faults and memory utilization</span></span><br><span class="line"><span class="comment">    * stack utilization</span></span><br><span class="line"><span class="comment">    * task switching</span></span><br><span class="line">$ collectl -i:1 -sZ --procopts wt --procfilt p<span class="variable">$pid</span> -oT</span><br><span class="line">$ collectl -i:1 -sZ --procopts wt --procfilt <span class="keyword">u</span><span class="variable">$uid</span> -oT</span><br><span class="line"></span><br><span class="line">$ iotop -b -n1 -o -P</span><br><span class="line"></span><br><span class="line">sys%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> <span class="variable">$9</span>/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line"><span class="keyword">use</span>%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> (<span class="variable">$10</span>+<span class="variable">$11</span>)/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line"></span><br><span class="line">idle%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> <span class="variable">$12</span>/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line">wait%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> <span class="variable">$13</span>/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line"></span><br><span class="line">$ atop -<span class="keyword">d</span> -c -PPRD 1 1  | <span class="keyword">sort</span> -nr -k 13 -k 15  | head</span><br><span class="line">                                                                           reads    <span class="keyword">read</span> sec     writes write sec(512B)</span><br><span class="line">PRD kvm-manager-a23-1 1585239068 2020/03/27 00:11:08 4256 4006 (bash) S <span class="keyword">n</span> y 1758081744 1758081744 64      64              48 4006 <span class="keyword">n</span> y</span><br><span class="line">last <span class="keyword">line</span> &#x27;y&#x27; <span class="keyword">means</span> not thread</span><br><span class="line">															 (2097152/1024=2048KB)</span><br><span class="line">$ atop -c -<span class="keyword">m</span> 5 # show cpu and mem, interval 5s                                                                          huge page size (bytes)</span><br><span class="line">$ atop -PCPU,MEM 5 # Batch-mode output cpu and <span class="keyword">memory</span>                                                                               |</span><br><span class="line">                                                        interval   <span class="keyword">total</span>(page)          cache       slab  slab-rec  shmem  shswp hugesz hpfre</span><br><span class="line">                                                             |         |                  |           |          |      |     |    |      |</span><br><span class="line">MEM cngb-compute-h3c-amd-<span class="keyword">test</span> 1608821373 2020/12/24 22:49:33 2 4096 264131575 217895897 230834 13135 222600 16 44190 0 2598 8 0 2097152 0 0 0</span><br><span class="line">                                                                |               |               |           |        |      |           |   |</span><br><span class="line">                                                             pagesize         free            fsbuff      dirty  vmball  shrss       hptot arc</span><br><span class="line">                                <span class="keyword">total</span>       free           cache buff   slap dirty</span><br><span class="line">awk &#x27;BEGIN&#123;printf <span class="string">&quot;%f GB\n&quot;</span>, ((264131575-217895897)*4096-(230834+13135+222600+16+44190+2598)*4096)/1024/1024/1024&#125;&#x27;</span><br><span class="line"></span><br><span class="line">## <span class="keyword">man</span> page is wrong, source code is right, and I make sure with /proc/meminfo </span><br><span class="line">print_MEM(<span class="keyword">char</span> *hp, struct sstat *ss, struct tstat *ps, int nact)</span><br><span class="line">&#123;</span><br><span class="line">	printf(	<span class="string">&quot;%s %u %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld\n&quot;</span>,</span><br><span class="line">			hp,</span><br><span class="line">			pagesize,</span><br><span class="line">			ss-&gt;mem.physmem,</span><br><span class="line">			ss-&gt;mem.freemem,</span><br><span class="line">			ss-&gt;mem.cachemem,</span><br><span class="line">			ss-&gt;mem.buffermem,</span><br><span class="line">			ss-&gt;mem.slabmem,</span><br><span class="line">			ss-&gt;mem.cachedrt,</span><br><span class="line">			ss-&gt;mem.slabreclaim,</span><br><span class="line">        		ss-&gt;mem.vmwballoon,</span><br><span class="line">        		ss-&gt;mem.shmem,</span><br><span class="line">        		ss-&gt;mem.shmrss,</span><br><span class="line">        		ss-&gt;mem.shmswp,</span><br><span class="line">        		ss-&gt;mem.hugepagesz,</span><br><span class="line">        		ss-&gt;mem.tothugepage,</span><br><span class="line">        		ss-&gt;mem.freehugepage,</span><br><span class="line">        		ss-&gt;mem.zfsarcsize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ atop -<span class="keyword">d</span> -c -PPRD 1 1  | awk &#x27;NF&gt;10 &#123;<span class="keyword">if</span>($(NF-6)+$(NF-4)&gt;120000) &#123;<span class="keyword">if</span>(<span class="variable">$NF</span>==<span class="string">&quot;y&quot;</span>) <span class="keyword">print</span> <span class="variable">$0&#125;</span>&#125;&#x27; </span><br><span class="line"># show the proc/thread <span class="keyword">read</span> or write &gt; 60MB</span><br></pre></td></tr></table></figure>

<h3 id="time"><a href="#time" class="headerlink" title="time"></a>time</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/time -f <span class="string">&quot;%E real,%U user,%S sys&quot;</span> sleep 2</span><br><span class="line">0:02.00 real,0.00 user,0.00 sys</span><br><span class="line"></span><br><span class="line">$ /usr/bin/time -f <span class="string">&quot;%e real&quot;</span> sleep 70</span><br><span class="line">70.00 real</span><br></pre></td></tr></table></figure>

<h3 id="youtube-download"><a href="#youtube-download" class="headerlink" title="youtube download"></a>youtube download</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 youtube-dl -F https://www.youtube.com/watch?v=_xxxxxx</span><br><span class="line">[info] Available formats <span class="keyword">for</span> _12OJxATpsA:</span><br><span class="line">format code  extension  resolution note</span><br><span class="line">249          webm       audio only tiny   62k , opus @ 50k (48000Hz), 51.86MiB</span><br><span class="line">250          webm       audio only tiny   81k , opus @ 70k (48000Hz), 68.24MiB</span><br><span class="line">140          m4a        audio only tiny  136k , m4a_dash container, mp4a.40.2@128k (44100Hz), 139.88MiB</span><br><span class="line">251          webm       audio only tiny  158k , opus @160k (48000Hz), 136.13MiB</span><br><span class="line">278          webm       256x144    144p  103k , webm container, vp9, 30fps, video only, 100.43MiB</span><br><span class="line">160          mp4        256x144    144p  115k , avc1.4d400c, 30fps, video only, 83.46MiB</span><br><span class="line">242          webm       426x240    240p  250k , vp9, 30fps, video only, 202.66MiB</span><br><span class="line">133          mp4        426x240    240p  257k , avc1.4d4015, 30fps, video only, 168.64MiB</span><br><span class="line">243          webm       640x360    360p  611k , vp9, 30fps, video only, 377.13MiB</span><br><span class="line">134          mp4        640x360    360p  665k , avc1.4d401e, 30fps, video only, 442.58MiB</span><br><span class="line">244          webm       854x480    480p 1052k , vp9, 30fps, video only, 677.08MiB</span><br><span class="line">135          mp4        854x480    480p 1343k , avc1.4d401f, 30fps, video only, 868.67MiB</span><br><span class="line">247          webm       1280x720   720p 2410k , vp9, 30fps, video only, 1.35GiB</span><br><span class="line">136          mp4        1280x720   720p 2678k , avc1.4d401f, 30fps, video only, 1.66GiB</span><br><span class="line">248          webm       1920x1080  1080p 4356k , vp9, 30fps, video only, 2.42GiB</span><br><span class="line">137          mp4        1920x1080  1080p 4525k , avc1.640028, 30fps, video only, 3.06GiB</span><br><span class="line">271          webm       2560x1440  1440p 9330k , vp9, 30fps, video only, 7.15GiB</span><br><span class="line">18           mp4        640x360    360p  622k , avc1.42001E, mp4a.40.2@ 96k (44100Hz), 685.04MiB</span><br><span class="line">22           mp4        1280x720   720p 1673k , avc1.64001F, mp4a.40.2@192k (44100Hz) (best)</span><br><span class="line"></span><br><span class="line">$ proxychains4 youtube-dl -f 137+bestaudio --merge-output-format mkv https://www.youtube.com/watch?v=_xxxxxx</span><br></pre></td></tr></table></figure>

<h3 id="uptime-and-vmstat-running"><a href="#uptime-and-vmstat-running" class="headerlink" title="uptime and vmstat running"></a>uptime and vmstat running</h3><ul>
<li><p>(uptime) number of processes that are either in a runnable or uninterruptable state.</p>
<ul>
<li>runnable state is either using the CPU or waiting to use the  CPU. <ul>
<li>A process in uninterruptable state is waiting for some I/O access.</li>
</ul>
</li>
</ul>
</li>
<li><p>(vmstat) Procs r: The number of runnable processes (running or waiting for run time, no contains uninterruptable state)</p>
</li>
</ul>
<h3 id="kernel-do-IRQ-X-Y-No-irq-handler-for-vector-irq-1"><a href="#kernel-do-IRQ-X-Y-No-irq-handler-for-vector-irq-1" class="headerlink" title="kernel: do_IRQ: X.Y No irq handler for vector (irq -1)"></a>kernel: do_IRQ: X.Y No irq handler for vector (irq -1)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * do_IRQ handles all normal device IRQ&#x27;s (the special</span></span><br><span class="line"><span class="comment"> * SMP cross-CPU interrupts have their own specific</span></span><br><span class="line"><span class="comment"> * handlers).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">__visible <span class="keyword">void</span> __irq_entry <span class="title">do_IRQ</span><span class="params">(struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> *<span class="title">old_regs</span> = <span class="title">set_irq_regs</span>(<span class="title">regs</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> * <span class="title">desc</span>;</span></span><br><span class="line">	<span class="comment">/* high bit used in ret_from_ code  */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="built_in">vector</span> = ~regs-&gt;orig_ax;</span><br><span class="line"></span><br><span class="line">	entering_irq();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* entering_irq() tells RCU that we&#x27;re not quiescent.  Check it. */</span></span><br><span class="line">	RCU_LOCKDEP_WARN(!rcu_is_watching(), <span class="string">&quot;IRQ failed to wake up RCU&quot;</span>);</span><br><span class="line"></span><br><span class="line">	desc = __this_cpu_read(vector_irq[<span class="built_in">vector</span>]);</span><br><span class="line">	<span class="keyword">if</span> (likely(!IS_ERR_OR_NULL(desc))) &#123;</span><br><span class="line">		<span class="keyword">if</span> (IS_ENABLED(CONFIG_X86_32))</span><br><span class="line">			handle_irq(desc, regs);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			generic_handle_irq_desc(desc);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ack_APIC_irq();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (desc == VECTOR_UNUSED) &#123;</span><br><span class="line">			pr_emerg_ratelimited(<span class="string">&quot;%s: %d.%d No irq handler for vector\n&quot;</span>,</span><br><span class="line">					     __func__, smp_processor_id(),</span><br><span class="line">					     <span class="built_in">vector</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			__this_cpu_write(vector_irq[<span class="built_in">vector</span>], VECTOR_UNUSED);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	exiting_irq();</span><br><span class="line"></span><br><span class="line">	set_irq_regs(old_regs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>system log</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Tue Apr 28 09:09:19 2020] do_IRQ: 6.95 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:23:21 2020] do_IRQ: 2.163 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:38:13 2020] do_IRQ: 2.151 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:48:55 2020] do_IRQ: 0.155 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:49:25 2020] do_IRQ: 2.205 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:51:51 2020] do_IRQ: 4.123 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:53:05 2020] do_IRQ: 2.208 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 10:29:52 2020] do_IRQ: 6.180 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 10:41:23 2020] do_IRQ: 2.133 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:30:06 2020] do_IRQ: 6.191 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:39:22 2020] do_IRQ: 4.234 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:42:23 2020] do_IRQ: 0.137 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:46:53 2020] do_IRQ: 2.38 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:57:25 2020] do_IRQ: 6.98 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 12:35:11 2020] do_IRQ: 4.121 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 12:39:12 2020] do_IRQ: 2.163 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 13:05:26 2020] do_IRQ: 0.223 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:00:30 2020] do_IRQ: 6.91 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:08:06 2020] do_IRQ: 0.159 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:26:09 2020] do_IRQ: 6.110 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line"></span><br><span class="line">$ grep -wEi <span class="string">&#x27;95|98|38|91|121|163&#x27;</span> /proc/interrupts</span><br><span class="line">  38:   98081083          0  142920345          0  123688922          0  172399026          0   PCI-MSI-edge      0000:00:11.4</span><br><span class="line">  91:         34          0         11          0         23          0         18          0   PCI-MSI-edge      em4-fp-7</span><br><span class="line"></span><br><span class="line">00:11.4 SATA controller: Intel Corporation C610/X99 series chipset sSATA Controller [AHCI mode] (rev 05)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Hardware issue # ipmi elist is ok</p>
</li>
<li><p>The hardware driver register num overflow</p>
</li>
<li><p>The hardware driver/firmware bug cause responds hobbledown</p>
</li>
<li><p>The bad APIC(programmable interrupt controller) got the wrong IRQ number</p>
<ul>
<li>disable APIC,  noapic pci=nomsi,noaer,acpi=off</li>
</ul>
</li>
</ul>
<h3 id="multipath-issue"><a href="#multipath-issue" class="headerlink" title="multipath issue"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/2437991">multipath issue</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: device-mapper: multipath: Failing path 70:64.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: device-mapper: multipath: Failing path 71:80.</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: 70:64: mark as failed</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: nsd_crs_04: remaining active paths: 1</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: 71:80: mark as failed</span><br><span class="line"></span><br><span class="line">$ cat /etc/udev/rules.d/99-custom.rules <span class="comment"># lfs must set to 16383</span></span><br><span class="line">ACTION!=<span class="string">&quot;add|change&quot;</span>, GOTO=<span class="string">&quot;rule_end&quot;</span> ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;NETAPP*&quot;</span>,  RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 16383 &gt; /sys%p/queue/max_sectors_kb&#x27;&quot;</span> LABEL=<span class="string">&quot;rule_end&quot;</span></span><br><span class="line"></span><br><span class="line">or you could add <span class="string">&quot; max_sectors_kb          16383 &quot;</span> to multipath.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">### add to initramfs</span></span><br><span class="line">$ cp  -av  /boot/initramfs-$(uname -r).img  /boot/initramfs-$(uname -r).img.bak</span><br><span class="line">dracut -f -v -i /etc/udev/rules.d/99-custom.rules /etc/udev/rules.d/99-custom.rules</span><br><span class="line">or</span><br><span class="line">dracut -f -v -i /etc/udev/rules.d/99-custom.rules /etc/multipath.conf</span><br></pre></td></tr></table></figure>

<h3 id="sshfs"><a href="#sshfs" class="headerlink" title="sshfs"></a>sshfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sshfs -p <span class="variable">$port</span> <span class="variable">$&#123;user&#125;</span>@<span class="variable">$&#123;ipaddr&#125;</span>:/mnt/sshfs ~/Downloads -o noatime,nonempty,reconnect,ServerAliveInterval=15,ServerAliveCountMax=3</span><br></pre></td></tr></table></figure>

<h3 id="scan-file-size"><a href="#scan-file-size" class="headerlink" title="scan file size"></a>scan file size</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## the diff performance in the diff file system</span></span><br><span class="line">$ find /tank -<span class="built_in">printf</span> <span class="string">&#x27;%p\t%Y\t%b\t%s\t%U\t%G\t%A@\n&#x27;</span></span><br><span class="line">$ ls -flsR --time=atime --time-style=<span class="string">&#x27;+%s&#x27;</span> /root/rpmbuild | awk <span class="string">&#x27;/:$/&amp;&amp;f&#123;f=0;&#125;;/:$/&amp;&amp;!f&#123;sub(/:$/,&quot;&quot;);s=$0;f=1;next&#125;;NF&amp;&amp;f&#123; print $0&quot; &quot;s &#125;&#x27;</span></span><br><span class="line">       |                                                               |                   |</span><br><span class="line">       |                                                               |                   --- first line trigger</span><br><span class="line">       |                                                               |</span><br><span class="line">       |                                                               ----- just change f value <span class="keyword">for</span> parent <span class="built_in">dirs</span> <span class="string">&quot;the last char is : , means no file, the next dir&quot;</span></span><br><span class="line">       |                                                                     next change the f value and try to the <span class="string">&quot;first line trigger&quot;</span> part to record the s val</span><br><span class="line">       --- the parameter could not out of order</span><br><span class="line"></span><br><span class="line"><span class="comment">## you should find too many &quot;.&quot; files </span></span><br><span class="line">$ find /tank -name <span class="string">&quot;.*&quot;</span> -<span class="built_in">printf</span> <span class="string">&#x27;%P\t%Y\t%b\t%s\t%U\t%G\t%A@\n&#x27;</span> &gt; tank.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#exclude 2 dirs</span></span><br><span class="line">$ find /opt/test1 -<span class="built_in">type</span> f -not -path <span class="string">&quot;/opt/test1/linux1/*&quot;</span> -not -path <span class="string">&quot;/opt/test1/linux2/*&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="System-err-for-monitor"><a href="#System-err-for-monitor" class="headerlink" title="System err for monitor"></a>System err for monitor</h3><p>scsi:<br>has been suspended<br>attempting host reset<br>mpt.*sas_cm.*Command Timeout<br>Medium.*Error<br>Unrecovered</p>
<p>kernel:<br>Got BUG: soft lockup<br>NMI watchdog.*BUG</p>
<p>mem:<br>page allocation failure<br>Err.*bit ECC</p>
<p>irq:<br>No irq handler for vector</p>
<p>nvme:<br>nvme nvme.*I/O.*timeout, aborting<br>reset controller<br>Device not ready; aborting reset<br>probe failure status</p>
<p>kernel:<br>INFO: task xxx:xxx blocked for more than 120 seconds.<br>kernel process or thread hang, could not be wake up at 120s<br>    hungtask<br>        hung_task_panic        0<br>        hung_task_check_count  32768<br>        hung_task_timeout_secs 120s<br>        hung_task_warnings     10x times</p>
<p>softlockup<br>NMI watchdog: BUG: soft lockup - CPU#0 stuck for 23s! [cat:153]<br>softlockup deadlock, check the kernel schdule is ok, if trigger the softlockup, the kernel could not be schduled.<br>When hrtimer wake up the kernel thread and update watchdog_touch_ts, if time now - watchdog_touch_ts &gt; timeout value, it will show this error, that mean schdule timeout.<br>/proc/sys/kernel/nmi_watchdog      hard lockup<br>/proc/sys/kernel/soft_watchdog     soft lockup<br>/proc/sys/kernel/watchdog          watchdog<br>/proc/sys/kernel/watchdog_cpumask  watchdog cpumaks，<br>/proc/sys/kernel/watchdog_thresh   watchdog timeoout</p>
<p>softlockup : the kernel loop in kernel mode without giving other tasks a chance to run, a kernel task won’t be unlock the CPU.<br>             A soft lockup is when a running task is executing kernel code and wont yield the CPU to allow other tasks to run.<br>             The default soft lockup threshold is 60 seconds for RHEL5/6 and 20 seconds on RHEL7.<br>hardlockup : the kernel loop in kernel mode without letting other interrupts have change to run, the interrupts aren’t being processes.<br>             A hard lockup is when a CPU has interrupts disabled for a long time, which might block important communication between processes or hardware.<br>             The default hard lockup threshold is 30 second on RHEL5/6 and 10 seconds on RHEL7.</p>
<p>In redhat <a target="_blank" rel="noopener" href="https://access.redhat.com/articles/1353303">doc</a><br>Each CPU has registered it’s own high resolution timer and both hard and soft lockup detection are closely connected with it.<br>This timer is fired approximately every [watchdog_thresh * 2 / 5]-seconds and does mainly three things:</p>
<ol>
<li><p>Wakes up a CPU specific watchdog task with the highest possible priority, in order to get scheduled as soon as possible. This task’s main job is to update a PER_CPU timestamp called watchdog_touch_ts.</p>
</li>
<li><p>Checks if watchdog_touch_ts + watchdog_thresh is smaller than current actual time. If yes, or in other words, if the watchdog task didn’t run for longer than watchdog_thresh, then a soft lockup is reported.</p>
</li>
<li><p>Increments a CPU specific interrupt counter called hrtimer_interrupts, denoting that an interrupt happened on the CPU.</p>
</li>
</ol>
<p>Detecting a hard lockup is a bit trickier, since the CPU is stuck and has disabled interrupts. In order to detect it, each CPU has registered a watchdog perf event, which ensures that the CPU hardware issues an NMI (non-maskable interrupt) every [hard lockup threshold]-seconds. Generally approximately 2-3 high resolution timer interrupts are supposed to happen in-between 2 of these NMIs.<br>The handler function of this NMI will check the hrtimer_interrupts counter and copy-save it’s current value. If it sees the same value as it has saved before, it reports a hard lockup, because it means that no interrupt happened during [hard lockup threshold]-seconds.</p>
<p>Usually a CPU lockup is caused by a task stuck in a loop. Sometimes it’s due to a code loop where the termination condition has not yet been met. For example it may be an unbounded list (ie while !list_empty()). In cases like this the code should limit the maximum iterations of the loop before voluntarily yielding the CPU (ie cond_resched()).</p>
<p>Often CPU lockups are caused by tasks trying to acquire a spinlock that for some reason cannot be acquired in a reasonable time. This could be due to current owner of the lock not relinquishing the lock or it may be a case of starvation where excessive activity on the lock delays some tasks long enough to exceed the watchdog threshold (ie RHEL5 spinlocks on numa).</p>
<p>Other cases involve a loop where the termination condition is never going to be met. For example the code expects a state change that isn’t going to happen.</p>
<p>It’s also possible to get false reports from the watchdog on virtual machines where the host system stalls the guest for longer than the watchdog threshold period. The watchdog will think the guest has been running during that time but the CPUs have not been able to make progress.</p>
<p>##default is enabled<br>$ sysctl kernel.softlockup_panic kernel.hardlockup_panic<br>kernel.softlockup_panic = 0<br>kernel.hardlockup_panic = 0</p>
<p>##disable, there is no soft lockup watchdog here<br>echo 1 &gt; /proc/sys/kernel/softlockup_panic</p>
<p><a target="_blank" rel="noopener" href="https://blog.seibert-media.com/2018/01/04/log-book-linux-cpu-lockups/#:~:text=A%20'hard%20lockup'%20is%20defined,the%20good%20old%20DOS%20days.">Provoke lockups with your own kernel module</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hog.c</span></span><br><span class="line"><span class="comment">#include &lt;linux/init.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/module.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/kernel.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/kthread.h&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="string">MODULE_LICENSE(&quot;GPL&quot;);</span></span><br><span class="line"> </span><br><span class="line"><span class="string">static</span> <span class="string">int</span></span><br><span class="line"><span class="string">hog_thread(void</span> <span class="string">*data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">printk(KERN_INFO</span> <span class="string">&quot;Hogging a CPU now\n&quot;</span><span class="string">);</span></span><br><span class="line">    <span class="string">while</span> <span class="string">(1);</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">/*</span> <span class="string">unreached</span> <span class="string">*/</span></span><br><span class="line">    <span class="string">return</span> <span class="number">0</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">static</span> <span class="string">int</span> <span class="string">__init</span></span><br><span class="line"><span class="string">hog_init(void)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">kthread_run(hog_thread</span>, <span class="literal">NULL</span>, <span class="string">&quot;hog&quot;</span><span class="string">);</span></span><br><span class="line">    <span class="string">return</span> <span class="number">0</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">module_init(hog_init);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#makefile</span></span><br><span class="line"><span class="string">obj-m</span> <span class="string">+=</span> <span class="string">hog.o</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">    <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(shell</span> <span class="string">uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(PWD)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">clean:</span></span><br><span class="line">    <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(shell</span> <span class="string">uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(PWD)</span> <span class="string">clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in centos </span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">Makefile</span></span><br><span class="line"><span class="string">obj-m</span> <span class="string">+=</span> <span class="string">hog.o</span></span><br><span class="line"></span><br><span class="line"><span class="attr">all:</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">clean:</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">clean</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">Entering</span> <span class="string">directory</span> <span class="string">`/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span></span><br><span class="line">  <span class="string">CC</span> [<span class="string">M</span>]  <span class="string">/root/hog/hog.o</span></span><br><span class="line">  <span class="string">Building</span> <span class="string">modules,</span> <span class="string">stage</span> <span class="number">2</span><span class="string">.</span></span><br><span class="line">  <span class="string">MODPOST</span> <span class="number">1</span> <span class="string">modules</span></span><br><span class="line">  <span class="string">CC</span>      <span class="string">/root/hog/hog.mod.o</span></span><br><span class="line">  <span class="string">LD</span> [<span class="string">M</span>]  <span class="string">/root/hog/hog.ko</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">Leaving</span> <span class="string">directory</span> <span class="string">`/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ls</span> </span><br><span class="line"><span class="string">hog.c</span>  <span class="string">hog.ko</span>  <span class="string">hog.mod.c</span>  <span class="string">hog.mod.o</span>  <span class="string">hog.o</span>  <span class="string">Makefile</span>  <span class="string">modules.order</span>  <span class="string">Module.symvers</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">insmod</span> <span class="string">hog.ko</span></span><br><span class="line"><span class="string">$</span> <span class="string">lsmod</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">hog</span></span><br><span class="line"><span class="string">hog</span>                    <span class="number">12386</span>  <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">kernel:NMI watchdog: BUG:</span> <span class="string">soft</span> <span class="string">lockup</span> <span class="bullet">-</span> <span class="string">CPU#0</span> <span class="string">stuck</span> <span class="string">for</span> <span class="string">23s!</span> [<span class="string">hog:2308</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">NMI watchdog: BUG:</span> <span class="string">soft</span> <span class="string">lockup</span> <span class="bullet">-</span> <span class="string">CPU#0</span> <span class="string">stuck</span> <span class="string">for</span> <span class="string">23s!</span> [<span class="string">hog:2308</span>]</span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Modules linked in:</span> <span class="string">hog(OE)</span> <span class="string">dell_rbu</span> <span class="string">dcdbas</span> <span class="string">sunrpc</span> <span class="string">nfit</span> <span class="string">libnvdimm</span> <span class="string">zfs(POE)</span> <span class="string">zunicode(POE)</span> <span class="string">zavl(POE)</span> <span class="string">icp(POE)</span> <span class="string">ppdev</span> <span class="string">iosf_mbi</span> <span class="string">crc32_pclmul</span> <span class="string">ghash_clmulni_intel</span> <span class="string">joydev</span> <span class="string">zcommon(POE)</span> <span class="string">znvpair(POE)</span> <span class="string">spl(OE)</span> <span class="string">sg</span> <span class="string">aesni_intel</span> <span class="string">virtio_balloon</span> <span class="string">virtio_rng</span> <span class="string">lrw</span> <span class="string">gf128mul</span> <span class="string">glue_helper</span> <span class="string">ablk_helper</span> <span class="string">cryptd</span> <span class="string">pcspkr</span> <span class="string">i2c_piix4</span> <span class="string">parport_pc</span> <span class="string">parport</span> <span class="string">binfmt_misc</span> <span class="string">ip_tables</span> <span class="string">xfs</span> <span class="string">libcrc32c</span> <span class="string">sr_mod</span> <span class="string">sd_mod</span> <span class="string">cdrom</span> <span class="string">crc_t10dif</span> <span class="string">crct10dif_generic</span> <span class="string">ata_generic</span> <span class="string">pata_acpi</span> <span class="string">virtio_console</span> <span class="string">virtio_net</span> <span class="string">virtio_blk</span> <span class="string">virtio_scsi</span> <span class="string">qxl</span> <span class="string">drm_kms_helper</span> <span class="string">syscopyarea</span> <span class="string">sysfillrect</span> <span class="string">sysimgblt</span> <span class="string">fb_sys_fops</span> <span class="string">ttm</span> <span class="string">drm</span> <span class="string">crct10dif_pclmul</span> <span class="string">crct10dif_common</span> <span class="string">crc32c_intel</span> <span class="string">ata_piix</span> <span class="string">ahci</span> <span class="string">libahci</span> <span class="string">libata</span> <span class="string">serio_raw</span> <span class="string">virtio_pci</span> <span class="string">virtio_ring</span> <span class="string">virtio</span> <span class="string">floppy</span> <span class="string">drm_panel_orientation_quirks</span> <span class="string">dm_mirror</span> <span class="string">dm_region_hash</span> <span class="string">dm_log</span> <span class="string">dm_mod</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CPU: 0 PID: 2308 Comm: hog Kdump: loaded Tainted:</span> <span class="string">P</span>           <span class="string">OE</span>  <span class="string">------------</span>   <span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span><span class="string">.el7.x86_64</span> <span class="comment">#1</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Hardware name:</span> <span class="string">Red</span> <span class="string">Hat</span> <span class="string">KVM,</span> <span class="string">BIOS</span> <span class="number">1.11</span><span class="number">.1</span><span class="number">-4.</span><span class="string">module_el8.0.0+189+f9babebb</span> <span class="number">04</span><span class="string">/01/2014</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">task: ffff9c0335878000 ti: ffff9c03356a4000 task.ti:</span> <span class="string">ffff9c03356a4000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RIP:</span> <span class="number">0010</span><span class="string">:[&lt;ffffffffc0721017&gt;]</span>  [<span class="string">&lt;ffffffffc0721017&gt;</span>] <span class="string">hog_thread+0x17/0x1000</span> [<span class="string">hog</span>]</span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RSP: 0018:ffff9c03356a7ec0  EFLAGS:</span> <span class="number">00000246</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RAX: 0000000000000011 RBX: ffff9c03356a7e50 RCX:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RDX: 0000000000000000 RSI: ffff9c033dc13898 RDI:</span> <span class="string">ffff9c033dc13898</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RBP: ffff9c03356a7ec0 R08: 0000000000000000 R09:</span> <span class="number">0000000000000040</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">R10: 000000000000029a R11: 0000000000aaaaaa R12:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">R13: ffffffffc0721000 R14: 0000000000000000 R15:</span> <span class="string">ffff9c03352ebc90</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">FS:</span>  <span class="number">0000000000000000</span><span class="string">(0000)</span> <span class="string">GS:ffff9c033dc00000(0000)</span> <span class="string">knlGS:0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CS:  0010 DS: 0000 ES: 0000 CR0:</span> <span class="number">0000000080050033</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CR2: 0000561560589e20 CR3: 0000000006010000 CR4:</span> <span class="string">00000000003606f0</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">DR0: 0000000000000000 DR1: 0000000000000000 DR2:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7:</span> <span class="number">0000000000000400</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Call Trace:</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c50d1&gt;</span>] <span class="string">kthread+0xd1/0xe0</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c5000&gt;</span>] <span class="string">?</span> <span class="string">insert_kthread_work+0x40/0x40</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa0f8cd37&gt;</span>] <span class="string">ret_from_fork_nospec_begin+0x21/0x21</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c5000&gt;</span>] <span class="string">?</span> <span class="string">insert_kthread_work+0x40/0x40</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Code:</span> <span class="string">&lt;eb&gt;</span> <span class="string">fe</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>


<p>Enable nmi_watchdog=1 in kernel</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat hard.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"> </span><br><span class="line">static int</span><br><span class="line">hog_thread(void *data)</span><br><span class="line">&#123;</span><br><span class="line">    static DEFINE_SPINLOCK(lock);</span><br><span class="line">    unsigned long flags;</span><br><span class="line"> </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hogging a CPU now\n&quot;</span>);</span><br><span class="line">    spin_lock_irqsave(<span class="variable">&amp;lock</span>, flags);</span><br><span class="line">    while (<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* unreached */</span></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static int __init</span><br><span class="line">hog_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    kthread_run(hog_thread, NULL, <span class="string">&quot;hog&quot;</span>);</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hog_init);</span><br><span class="line"></span><br><span class="line">obj-m += hard.o</span><br><span class="line"></span><br><span class="line"><span class="symbol">all:</span> make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) modules</span><br><span class="line"><span class="symbol">clean:</span> make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) clean</span><br><span class="line"></span><br><span class="line">$  make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) modules</span><br><span class="line"><span class="symbol">make:</span> Entering directory `<span class="meta-keyword">/usr/</span>src<span class="meta-keyword">/kernels/</span><span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span>.el7.x86_64&#x27;</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>hardhog/hard.o</span><br><span class="line">  Building modules, stage <span class="number">2.</span></span><br><span class="line">  MODPOST <span class="number">1</span> modules</span><br><span class="line">  CC      <span class="meta-keyword">/root/</span>hardhog/hard.mod.o</span><br><span class="line">  LD [M]  <span class="meta-keyword">/root/</span>hardhog/hard.ko</span><br><span class="line"></span><br><span class="line">$ insmod hard.ko</span><br><span class="line"></span><br><span class="line"><span class="meta"># after insmod, the KVM ssh not respond too.</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kernelnewbies.org/FAQ/FastpathAndSlowpath">In general</a>, “fast path” is the commonly run code that should finish very quickly. For example, when it comes to spinlocks the fast path is that nobody is holding the spinlock and the CPU that wants it can just take it.<br>Conversely, the slow path for spinlocks is that the lock is already taken by somebody else and the CPU will have to wait for the lock to be freed.<br>The first case is the common one that should be optimized.<br>The second one is not as important and does not need to be optimized much at all.</p>
<h3 id="cgroup-limit-resource"><a href="#cgroup-limit-resource" class="headerlink" title="cgroup limit resource"></a>cgroup limit resource</h3><p>command line mode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /sys/fs/cgroup/memory/</span><br><span class="line">$ mkdir <span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">cd</span> /sys/fs/cgroup/memory/<span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">echo</span> 5M &gt; memory.limit_in_bytes</span><br><span class="line">$ <span class="built_in">echo</span> $$ &gt;&gt; cgroup.procs <span class="comment">## add local bash </span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; memory.swappiness</span><br><span class="line"></span><br><span class="line">$ cat memory.oom_control</span><br><span class="line"><span class="comment"># disable oom</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt;&gt; memory.oom_control<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>


<p>limit memory size</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cgcreate -g memory:DBLimitedGroup</span><br><span class="line">$ <span class="built_in">echo</span> 16G &gt; /sys/fs/cgroup/memory/DBLimitedGroup/memory.limit_in_bytes</span><br><span class="line">$ sync; <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ cgclassify -g memory:DBLimitedGroup $(pid)</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=<span class="string">&quot;test&quot;</span></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/<span class="built_in">test</span>/<span class="built_in">test</span> 1234</span><br><span class="line">MemoryAccounting=<span class="literal">true</span></span><br><span class="line">MemoryHigh=1024K</span><br><span class="line">MemoryMax=4096K</span><br></pre></td></tr></table></figure>

<h3 id="About-WB-SYNC-NONE-and-WB-SYNC-ALL"><a href="#About-WB-SYNC-NONE-and-WB-SYNC-ALL" class="headerlink" title="About WB_SYNC_NONE and WB_SYNC_ALL"></a>About WB_SYNC_NONE and WB_SYNC_ALL</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v3.10.108/source/fs/fs-writeback.c#L140">https://elixir.bootlin.com/linux/v3.10.108/source/fs/fs-writeback.c#L140</a><br>/**</p>
<ul>
<li>bdi_start_writeback - start writeback</li>
<li>@bdi: the backing device to write from</li>
<li>@nr_pages: the number of pages to write</li>
<li>@reason: reason why some writeback work was initiated</li>
<li></li>
<li>Description:</li>
<li>This does WB_SYNC_NONE opportunistic writeback. The IO is only</li>
<li>started when this function returns, we make no guarantees on</li>
<li>completion. Caller need not hold sb s_umount semaphore.</li>
<li></li>
<li>/</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/writeback.h#L34">https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/writeback.h#L34</a></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">writeback_sync_modes</span> &#123;</span></span><br><span class="line">	WB_SYNC_NONE,	<span class="regexp">/* Don&#x27;t wait on anything */</span></span><br><span class="line">	WB_SYNC_ALL,	<span class="regexp">/* Wait on every mapping */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><h4 id="ldd"><a href="#ldd" class="headerlink" title="ldd"></a>ldd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ldd /bin/ls</span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007fff59353000)</span><br><span class="line">	libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007fa12b999000)</span><br><span class="line">	libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007fa12b794000)</span><br><span class="line">	libacl.so.1 =&gt; /lib64/libacl.so.1 (0x00007fa12b58b000)</span><br><span class="line">	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fa12b1bd000)</span><br><span class="line">	libpcre.so.1 =&gt; /lib64/libpcre.so.1 (0x00007fa12af5b000)</span><br><span class="line">	libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007fa12ad57000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007fa12bbc0000)</span><br><span class="line">	libattr.so.1 =&gt; /lib64/libattr.so.1 (0x00007fa12ab52000)</span><br><span class="line">	libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fa12a936000)</span><br></pre></td></tr></table></figure>

<h4 id="Read-ELF-Executable-and-Linking-Format"><a href="#Read-ELF-Executable-and-Linking-Format" class="headerlink" title="Read ELF(Executable and Linking Format)"></a>Read ELF(Executable and Linking Format)</h4><p>Relocatable file (eg: xx.o)<br>Executable file<br>Dynamic Linking Library (eg: xx.so)<br>Static Linking Library  (eg: xx.a)</p>
<p>ELF Header<br>ELF Program Header Table/Program Headers<br>ELF Section Header Table/Section Headers<br>ELF Sections<br>multiple sections merge to a segment</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -h /bin/ls</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              EXEC (Executable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x404324</span></span><br><span class="line"><span class="string">  Start of program headers:          64 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          115688 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           56 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         9</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         30</span></span><br><span class="line"><span class="string">  Section header string table index: 29</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$  readelf -S /bin/ls | grep debug</span></span><br><span class="line"><span class="string">  [27] .gnu_debuglink    PROGBITS         0000000000000000  0001b600</span></span><br><span class="line"><span class="string">  [28] .gnu_debugdata    PROGBITS         0000000000000000  0001b610 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf -all /bin/ls</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>

<h4 id="objdump"><a href="#objdump" class="headerlink" title="objdump"></a>objdump</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -i </span><br><span class="line"><span class="comment"># Display a list showing all architectures and object formats available for specification with -b or -m.</span></span><br><span class="line">...</span><br><span class="line">$ gcc -O2 -ggdb3 -c -o sort.o sort.c</span><br><span class="line">$ objdump -d sort.o</span><br><span class="line"><span class="comment">#Display the assembler mnemonics for the machine instructions from objfile</span></span><br><span class="line"></span><br><span class="line">sort.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;sort&gt;:</span><br><span class="line">   0:	31 c0                	xor    %eax,%eax</span><br><span class="line">   2:	b9 01 00 00 00       	mov    <span class="variable">$0x1</span>,%ecx</span><br><span class="line">   7:	83 f8 1e             	cmp    <span class="variable">$0x1e</span>,%eax</span><br><span class="line">   a:	7e 0b                	jle    17 &lt;sort+0x17&gt;</span><br><span class="line">   c:	84 c9                	<span class="built_in">test</span>   %cl,%cl</span><br><span class="line">   e:	75 36                	jne    46 &lt;sort+0x46&gt;</span><br><span class="line">  10:	b9 01 00 00 00       	mov    <span class="variable">$0x1</span>,%ecx</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ objdump -t sort.o</span><br><span class="line"><span class="comment"># Print the symbol table entries of the file</span></span><br><span class="line"></span><br><span class="line">sort.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line">0000000000000000 l    df *ABS*	0000000000000000 sort.c</span><br><span class="line">0000000000000000 l    d  .text	0000000000000000 .text</span><br><span class="line">0000000000000000 l    d  .data	0000000000000000 .data</span><br><span class="line">0000000000000000 l    d  .bss	0000000000000000 .bss</span><br><span class="line">0000000000000000 l    d  .rodata.str1.1	0000000000000000 .rodata.str1.1</span><br><span class="line">0000000000000000 l    d  .text.startup	0000000000000000 .text.startup</span><br><span class="line">0000000000000000 l    d  .debug_info	0000000000000000 .debug_info</span><br><span class="line">0000000000000000 l    d  .debug_abbrev	0000000000000000 .debug_abbrev</span><br><span class="line">0000000000000000 l    d  .debug_loc	0000000000000000 .debug_loc</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="nm"><a href="#nm" class="headerlink" title="nm"></a>nm</h4><p>list symbols from object files</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ nm ./walk</span><br><span class="line">                 U <span class="symbol">atoi@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a4 B __bss_start</span><br><span class="line">                 U <span class="symbol">closedir@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a8 b completed<span class="number">.6355</span></span><br><span class="line"><span class="number">00000000006020</span>a0 D __data_start</span><br><span class="line"><span class="number">00000000006020</span>a0 W data_start</span><br><span class="line"><span class="number">0000000000400880</span> t deregister_tm_clones</span><br><span class="line"><span class="number">00000000004008f</span>0 t __do_global_dtors_aux</span><br><span class="line"><span class="number">0000000000601e18</span> t __do_global_dtors_aux_fini_array_entry</span><br><span class="line"><span class="number">0000000000400</span>d18 R __dso_handle</span><br><span class="line"></span><br><span class="line">$ nm -e ./walk</span><br><span class="line">                 U <span class="symbol">atoi@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a4 B __bss_start</span><br><span class="line">                 U <span class="symbol">closedir@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a8 b completed<span class="number">.6355</span></span><br><span class="line"><span class="number">00000000006020</span>a0 D __data_start</span><br><span class="line"><span class="number">00000000006020</span>a0 W data_start</span><br><span class="line"><span class="number">0000000000400880</span> t deregister_tm_clones</span><br><span class="line"><span class="number">00000000004008f</span>0 t __do_global_dtors_aux</span><br><span class="line"><span class="number">0000000000601e18</span> t __do_global_dtors_aux_fini_array_entry</span><br><span class="line"><span class="number">0000000000400</span>d18 R __dso_handle</span><br></pre></td></tr></table></figure>

<p>kernel symbol table</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$  grep CONFIG_KALLSYMS /boot/config<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1062.18</span><span class="number">.1</span>.el7.x86_64</span><br><span class="line">CONFIG_KALLSYMS=y</span><br><span class="line">CONFIG_KALLSYMS_ALL=y</span><br><span class="line"></span><br><span class="line">$ grep <span class="string">&quot; tcp_v4_do_rcv&quot;</span>  /<span class="keyword">proc</span>/kallsyms</span><br><span class="line">ffffffff936c0c70<span class="title"> T</span> tcp_v4_do_rcv</span><br><span class="line">##<span class="title"> Why</span> addr<span class="title"> is</span> change ?</span><br><span class="line"></span><br><span class="line">$<span class="title"> grep</span> CONFIG_RANDOMIZE_BASE /boot/config-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">CONFIG_RANDOMIZE_BASE=y</span><br><span class="line"></span><br><span class="line">##<span class="title"> ALL</span> info,<span class="title"> the</span> compiler<span class="title"> optimize</span> cause<span class="title"> some</span> symbols<span class="title"> missing</span> in<span class="title"> kallsyms</span></span><br><span class="line"><span class="title">$</span> grep &quot;<span class="title"> tcp_v4_do_rcv&quot;</span>  /boot/System.map-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">ffffffff816c0c70<span class="title"> T</span> tcp_v4_do_rcv</span><br></pre></td></tr></table></figure>



<p>uppercase: global(external) symbol<br>lowercase: local symbol<br>T The symbol is in the text(code) section<br>D The symbol is in the initialized data section<br>R The sysbol is in a read only data section<br>t static<br>d static<br>R const<br>r static const</p>
<h4 id="size"><a href="#size" class="headerlink" title="size"></a>size</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">size add_lock</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   5008	    660	      4	   5672	   1628	add_lock</span><br></pre></td></tr></table></figure>

<p>代码段： 只读，可共享; 代码段（code segment/text segment ）通常是指用来存放程序执行代码的一块内存区域。这部分区域的大小在程序运行前就已经确定，并且内存区域通常属于只读, 某些架构也允许代码段为可写，即允许修改程序。在代码段中，也有可能包含一些只读的常数变量，例如字符串常量等。<br>数据段： 储存已被初始化了的静态数据。数据段（data segment ）通常是指用来存放程序中已初始化的全局变量的一块内存区域。数据段属于静态内存分配。<br>BSS 段：未初始化的数据段. BSS 段（bss segment ）通常是指用来存放程序中未初始化的全局变量的一块内存区域。BSS 是英文Block Started by Symbol 的简称。BSS 段属于静态内存分配。<br>堆（heap ）：low to high, 堆是用于存放进程运行中被动态分配的内存段，它的大小并不固定，可动态扩张或缩减。当进程调用malloc 等函数分配内存时，新分配的内存就被动态添加到堆上（堆被扩张）；当利用free 等函数释放内存时，被释放的内存从堆中被剔除（堆被缩减）<br>栈(stack) ： high to low, 栈又称堆栈，是用户存放程序临时创建的局部变量，也就是说我们函数括弧“{} ”中定义的变量（但不包括static 声明的变量，static 意味着在数据段中存放变量）。除此以外，在函数被调用时，其参数也会被压入发起调用的进程栈中，并且待到调用结束后，函数的返回值也会被存放回栈中。由于栈的先进先出特点，所以栈特别方便用来保存/ 恢复调用现场。从这个意义上讲，我们可以把堆栈看成一个寄存、交换临时数据的内存区。<br>另外, 在高地址还储存了命令行参数及环境变量.</p>
<p>The heap is, generally speaking, one specific memory region created by the C runtime, and managed by malloc (which in turn uses the brk and sbrk system calls to grow and shrink).<br>mmap is a way of creating new memory regions, independently of malloc (and so independently of the heap). munmap is simply its inverse, it releases these regions.<br>Some picture show mmap high addr to low addr, same direction with stack</p>
<h3 id="process-schduler"><a href="#process-schduler" class="headerlink" title="process schduler"></a>process schduler</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ chrt -p <span class="variable">$pid</span></span><br><span class="line">$ chrt -m</span><br><span class="line">$ chrt [-b/-f/-o/-r/-i/-d] -p <span class="variable">$priority</span> <span class="variable">$pid</span></span><br><span class="line">-b SCHED_BATCH</span><br><span class="line">-f SCHED_FIFO</span><br><span class="line">-o SCHED_OTHER</span><br><span class="line">-r SCHED_RR</span><br><span class="line">-i SCHED_IDLE</span><br><span class="line">-d SCHED_DEADLINE</span><br></pre></td></tr></table></figure>

<h3 id="vim-jump-cursor"><a href="#vim-jump-cursor" class="headerlink" title="vim jump cursor"></a>vim jump cursor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:cal cursor(30, 5)</span><br></pre></td></tr></table></figure>

<h3 id="gpart-recovery-partition-table"><a href="#gpart-recovery-partition-table" class="headerlink" title="gpart recovery partition table"></a>gpart recovery partition table</h3><p>boot by freebsd livecd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gpart disk list</span><br><span class="line">$ gpart recover /dev/sda</span><br></pre></td></tr></table></figure>

<h3 id="ffmpeg"><a href="#ffmpeg" class="headerlink" title="ffmpeg"></a>ffmpeg</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ffmpeg -i twiz-1080p.mkv -s 1280x720 -vcodec libx264 -crf 24 twiz-720p.mkv</span><br></pre></td></tr></table></figure>

<h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><p><a target="_blank" rel="noopener" href="https://serverfault.com/questions/763582/how-to-configure-iptables-so-an-unwanted-port-is-not-reported-as-filtered">let namp show filter, you could pretend 22 is the ssh port :) </a><br>change the ssh default port and set </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j drop</span><br><span class="line"></span><br><span class="line"><span class="comment"># Don&#x27;t use DROP, that&#x27;s easily identified as &quot;filtered&quot; if you know the box is up. Instead, you may use the following to send a RST. (as if there is a service listening, but it doesn&#x27;t accept connections from you)</span></span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j REJECT --reject-with tcp-reset</span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j REJECT</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run &#x27;chmod +x /etc/rc.d/rc.local&#x27; to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reset to a sane state, even if just temporarily</span></span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># Erase all the rules</span></span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables --delete-chain</span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables -t nat -X</span><br><span class="line"></span><br><span class="line">nic=ems3</span><br><span class="line"><span class="comment"># disable icmp</span></span><br><span class="line"><span class="comment">#iptables -A INPUT  -p icmp --icmp-type echo-request -j DROP</span></span><br><span class="line"><span class="comment">#iptables -A OUTPUT -p icmp --icmp-type echo-reply -j DROP</span></span><br><span class="line">iptables -A INPUT -p icmp --icmp-type any -j DROP</span><br><span class="line">iptables -A OUTPUT -p icmp -j DROP</span><br><span class="line"></span><br><span class="line">iptables -A INPUT -m state --state INVALID -j LOG --log-prefix <span class="string">&quot;DROP INVALID &quot;</span> --log-ip-options --log-tcp-options</span><br><span class="line">iptables -A INPUT -m state --state INVALID -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">## same with iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP</span></span><br><span class="line"><span class="comment"># Log attack</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; Null scan &quot;</span></span><br><span class="line"><span class="comment"># Drop and blacklist for 60 seconds IP of attacker</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE  -m recent --name blacklist_60 --<span class="built_in">set</span> -m comment --comment <span class="string">&quot;Drop/Blacklist Null scan&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">## nmap -sX 192.168.0.2</span></span><br><span class="line"><span class="comment"># Log attacks</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; XMAS scan &quot;</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; XMAS-PSH scan &quot;</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; XMAS-ALL scan &quot;</span></span><br><span class="line"><span class="comment"># Drop and blacklist for 60 seconds IP of attacker</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist Xmas/PSH scan&quot;</span> -j DROP <span class="comment"># Xmas-PSH scan</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist Xmas scan&quot;</span> -j DROP <span class="comment"># Against nmap -sX (Xmas tree scan)</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist Xmas/All scan&quot;</span> -j DROP <span class="comment"># Xmas All scan</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### fin scan nmap -sF 192.168.0.2</span></span><br><span class="line"><span class="comment">#Log attack</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; FIN scan &quot;</span></span><br><span class="line"><span class="comment"># Drop and blacklist for 60 seconds IP of attacker</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist FIN scan&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">###ACK scan nmap -sA 192.168.0.2</span></span><br><span class="line">iptables   -A INPUT -p tcp ! --syn -m state --state NEW  -m comment --comment <span class="string">&quot;Drop TCP connection not starting by SYN&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">### SYN scan and TCP connect scan, nmap -sS 192.168.0.2, nmap -sT 192.168.0.2</span></span><br><span class="line"><span class="comment"># log  probable sS and full connect tcp scan</span></span><br><span class="line">iptables -A INPUT -p tcp  -m multiport --dports 23,79 --tcp-flags ALL SYN -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt;SYN scan trap:&quot;</span></span><br><span class="line"><span class="comment"># blacklist for three minuts</span></span><br><span class="line">iptables -A  INPUT -p tcp  -m multiport --dports 23,79 --tcp-flags ALL SYN -m recent --name blacklist_180 --<span class="built_in">set</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">### UDP scan</span></span><br><span class="line">iptables -A INPUT -p udp  -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 6/h --limit-burst 1 -m length --length 0:28 -j LOG --log-prefix <span class="string">&quot;Firewall&gt;0 length udp &quot;</span></span><br><span class="line">iptables -A INPUT -p udp -m length --length 0:28 -m comment --comment <span class="string">&quot;Drop UDP packet with no content&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># Simple NAT rule for outgoing traffic</span></span><br><span class="line"><span class="comment">#iptables -t nat -A POSTROUTING -o $nic -j MASQUERADE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># allow established connections</span></span><br><span class="line"><span class="comment"># iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow loopback</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow the return half of established connections</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow incoming and outgoing ssh</span></span><br><span class="line"><span class="comment">####  from Foreign ssh to this, eg: ssh port is 10000</span></span><br><span class="line">iptables -A INPUT -p tcp  --sport 30000:65535 --dport 10000 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">####  from this node ssh to the others</span></span><br><span class="line">iptables -A OUTPUT -p tcp --sport 30000:65535 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#### vnc for 5901</span></span><br><span class="line">iptables -A INPUT -p tcp  --sport 30000:65535 --dport 5901 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#### ipmi web</span></span><br><span class="line">iptables -A OUTPUT -p tcp  --sport 30000:65535 --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p tcp  --sport 30000:65535 --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p tcp  --sport 30000:65535 --dport 5900 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># You probably want other stuff permitted here such as DNS on 53/udp and 53/tcp</span></span><br><span class="line"><span class="comment"># and maybe NTP on 123/udp</span></span><br><span class="line"><span class="comment"># iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT</span></span><br><span class="line"><span class="comment"># iptables -A OUTPUT -p udp --dport 123 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default policy is to discard all traffic</span></span><br><span class="line">iptables -P INPUT  DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">systemctl start fail2ban.service</span><br><span class="line"></span><br><span class="line">--------------------------------------------</span><br><span class="line"><span class="comment">### block-scan </span></span><br><span class="line">iptables -N block-scan</span><br><span class="line">iptables -A block-scan -p tcp —tcp-flags SYN,ACK,FIN,RST RST -m <span class="built_in">limit</span> —<span class="built_in">limit</span> 1/s -j RETURN</span><br><span class="line">iptables -A block-scan -j DROP</span><br><span class="line"><span class="comment">### reset tcp</span></span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 2049 -j REJECT --reject-with tcp-reset</span><br></pre></td></tr></table></figure>
<p>[defeating Nmap OS-Fingerprinting]<a target="_blank" rel="noopener" href="https://nmap.org/misc/defeat-nmap-osdetect.html">https://nmap.org/misc/defeat-nmap-osdetect.html</a>)<br><a target="_blank" rel="noopener" href="https://linuxhint.com/traceroute_nmap/">nmap traceroute</a><br><a target="_blank" rel="noopener" href="http://blog.sevagas.com/?Iptables-firewall-versus-nmap-and,31">iptabls vs namp</a></p>
<h4 id="fail2ban"><a href="#fail2ban" class="headerlink" title="fail2ban"></a>fail2ban</h4><p>Default firewalld policy maybe will conflicte with my iptables policy, disable firewalld and reset the policy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y fail2ban</span><br><span class="line">$ cat /etc/fail2ban/jail.local</span><br><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># Ban hosts for one hour:</span></span><br><span class="line">bantime = 900</span><br><span class="line">ignoreip = 127.0.0.1/8</span><br><span class="line">maxretry = 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Override /etc/fail2ban/jail.d/00-firewalld.conf:</span></span><br><span class="line"><span class="comment"># banaction = iptables-multiport</span></span><br><span class="line">banaction = iptables</span><br><span class="line"></span><br><span class="line">[sshd]</span><br><span class="line">port    = 10000</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">logpath = /var/<span class="built_in">log</span>/fail2ban.log</span><br><span class="line">filter    = sshd</span><br><span class="line"></span><br><span class="line">$ sudo fail2ban-client status sshd</span><br><span class="line">Status <span class="keyword">for</span> the jail: sshd</span><br><span class="line">|- Filter</span><br><span class="line">|  |- Currently failed:	0</span><br><span class="line">|  |- Total failed:	7</span><br><span class="line">|  `- Journal matches:	_SYSTEMD_UNIT=sshd.service + _COMM=sshd</span><br><span class="line">`- Actions</span><br><span class="line">   |- Currently banned:	1</span><br><span class="line">   |- Total banned:	1</span><br><span class="line">   `- Banned IP list:	192.168.1.10</span><br><span class="line"></span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/fail2ban.log</span><br><span class="line">2021-01-22 10:42:38,088 fail2ban.actions        [1191]: INFO      banTime: 600</span><br><span class="line">2021-01-22 10:42:38,091 fail2ban.jail           [1191]: INFO    Jail <span class="string">&#x27;sshd&#x27;</span> started</span><br><span class="line">2021-01-22 10:43:27,767 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:57</span><br><span class="line">2021-01-22 10:43:27,768 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:58</span><br><span class="line">2021-01-22 10:43:27,768 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:58</span><br><span class="line">2021-01-22 10:43:27,769 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:59</span><br><span class="line">2021-01-22 10:43:27,769 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:43:00</span><br><span class="line">2021-01-22 10:43:27,770 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:43:02</span><br><span class="line">2021-01-22 10:43:27,770 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:43:02</span><br><span class="line">2021-01-22 10:43:28,158 fail2ban.actions        [1191]: NOTICE  [sshd] Ban 192.168.1.10</span><br></pre></td></tr></table></figure>

<h4 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ lsof </span><br><span class="line">COMMAND    PID   USER   FD   TYPE        DEVICE SIZE/OFF      NODE NAME</span><br><span class="line"><span class="built_in">sched</span>        0   root  cwd   VDIR         136,8     1024         2 /</span><br><span class="line">init         1   root  cwd   VDIR         136,8     1024         2 /</span><br><span class="line">init         1   root  txt   VREG         136,8    49016      1655 /sbin/init</span><br><span class="line">init         1   root  txt   VREG         136,8    51084      3185 /lib/libuutil.so.1</span><br><span class="line">vi        2013   root    3u  VREG         136,8        0      8501 /var/tmp/ExXDaO7d</span><br><span class="line"></span><br><span class="line"><span class="comment"># show the unix socket info</span></span><br><span class="line">$ lsof -aUc sshd</span><br><span class="line">COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF   NODE NAME</span><br><span class="line">sshd     3199 root    1u  unix 0xffff8a8b39f96a40      0t0  43211 socket</span><br><span class="line">sshd     3199 root    2u  unix 0xffff8a8b39f96a40      0t0  43211 socket</span><br><span class="line">sshd    33510 root    4u  unix 0xffff8a7be8dac400      0t0 283548 socket</span><br><span class="line">sshd    78493 root    4u  unix 0xffff8a8b3a24d940      0t0 443790 socket</span><br><span class="line"></span><br><span class="line">$ ss -xp</span><br><span class="line"> ss -xp | grep sshd</span><br><span class="line">u_str  ESTAB      0      0       * 43211                 * 18675                 users:((<span class="string">&quot;sshd&quot;</span>,pid=3199,fd=2),(<span class="string">&quot;sshd&quot;</span>,pid=3199,fd=1))</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/16300/whos-got-the-other-end-of-this-unix-socketpair">example to debug</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lsof | grep whatever</span></span><br><span class="line">mysqld 14450 (...) unix 0xffff8801011e9600 (...) /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb /usr/lib/debug/boot/vmlinux-3.2.0-4-amd64 /proc/kcore</span></span><br><span class="line">(gdb) <span class="built_in">print</span> ((struct unix_sock*)0xffff8801011e9600)-&gt;peer</span><br><span class="line"><span class="variable">$1</span> = (struct sock *) 0xffff880171f078c0</span><br><span class="line"></span><br><span class="line"><span class="comment"># lsof | grep 0xffff880171f078c0</span></span><br><span class="line">mysql 14815 (...) unix 0xffff880171f078c0 (...) socket</span><br></pre></td></tr></table></figure>

<h3 id="Process-accounting-on-Linux"><a href="#Process-accounting-on-Linux" class="headerlink" title="Process accounting on Linux"></a><a target="_blank" rel="noopener" href="https://www.networkworld.com/article/3571465/managing-process-accounting-on-linux.html">Process accounting on Linux</a></h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/accton <span class="keyword">on</span></span><br><span class="line">Turning <span class="keyword">on</span> process accounting, <span class="keyword">file</span> <span class="keyword">set</span> to the default &#x27;/<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct&#x27;.</span><br><span class="line">dump-acct /<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct | tail</span><br><span class="line">echo <span class="string">&quot;Command         vers  runtime   systime   elapsed    UID    GID   mem_use     chars      PID     PPID  ?    retcode  term     date/time&quot;</span> &quot;</span><br><span class="line">sudo dump-acct /<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct | tail -5</span><br><span class="line">dump-acct /<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct | awk -F&#x27;|&#x27; &#x27;<span class="variable">$6</span> ~ / 1000$/&#x27;</span><br><span class="line"><span class="keyword">ls</span> -ltr /<span class="keyword">var</span>/<span class="keyword">log</span>/account | tail -6</span><br><span class="line">/usr/sbin/accton off</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://developer.ibm.com/articles/au-lsof/">The Device, SIZE/OFF, Node, and Name columns refer to the file itself, specifying the name of the disk, size of the file, inode (the file’s identification on the disk)</a></p>
<h3 id="Partition-table-loss"><a href="#Partition-table-loss" class="headerlink" title="Partition table loss"></a>Partition table loss</h3><p>First xfs file system no partition table, it ‘s direct use by /dev/vdx<br>Some guy add the partition by ?? parted ?? after the machine reboot, the parted only show xfs and no parttion<br>but gdisk show the gpt partition, the udev show the vdb1</p>
<h4 id="By-mount-offset"><a href="#By-mount-offset" class="headerlink" title="By mount offset"></a>By mount offset</h4><p>When the partition table not show, the partition message not damaged, because some XFS metadata ahead of the GPT partition info cause the partition not be probed, I use offset avoid the partition identify failed</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ parted /dev/sdg <span class="string">&quot;unit s print&quot;</span></span><br><span class="line">Model: QEMU QEMU HARDDISK (scsi)</span><br><span class="line">Disk /dev/sdg: 31251759104s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start  End          Size         File system  Name  Flags</span><br><span class="line"> 1      2048s  7812499455s  7812497408s  ext4</span><br><span class="line"></span><br><span class="line">$ mkfs.ext4 /dev/sdg1</span><br><span class="line">mke2fs 1.45.2.wc1 (27-May-2019)</span><br><span class="line">/dev/sdg1 contains a ext4 file system</span><br><span class="line">	created on Fri Feb  5 20:59:59 2021</span><br><span class="line">Proceed anyway? (y,N) y</span><br><span class="line">Suggestion: Use Linux kernel &gt;= 3.18 <span class="keyword">for</span> improved stability of the metadata and journal checksum features.</span><br><span class="line">Discarding device blocks: <span class="keyword">done</span></span><br><span class="line">Creating filesystem with 976562176 4k blocks and 244146176 inodes</span><br><span class="line">Filesystem UUID: a7a95474-5c9c-4f2d-8c57-fe95e7c20d17</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span><br><span class="line">	4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968,</span><br><span class="line">	102400000, 214990848, 512000000, 550731776, 644972544</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span></span><br><span class="line">Writing inode tables: <span class="keyword">done</span></span><br><span class="line">Creating journal (262144 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ mount /dev/sdg1 /mnt</span><br><span class="line">$ df -h /mnt</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdg1       3.6T   89M  3.4T   1% /mnt</span><br><span class="line"></span><br><span class="line">$ umount /mnt</span><br><span class="line">$ parted /dev/sdg rm 1</span><br><span class="line">Information: You may need to update /etc/fstab.</span><br><span class="line"></span><br><span class="line">$ parted /dev/sdg p</span><br><span class="line">Model: QEMU QEMU HARDDISK (scsi)</span><br><span class="line">Disk /dev/sdg: 16.0TB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start  End  Size  File system  Name  Flags</span><br><span class="line"><span class="comment">## the partition is gone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x38  __le16  s_magic  Magic signature, 0xEF53</span></span><br><span class="line"></span><br><span class="line">$ hexdump -C /dev/sdg  | head -n 4000 | grep <span class="string">&quot;53 ef&quot;</span></span><br><span class="line">00100430  bd 78 1d 60 01 00 ff ff  53 ef 01 00 01 00 00 00  |.x.`....S.......|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 0x100000 = 1048576 bytes = 2048s</span></span><br><span class="line"><span class="comment">### 0x430 + 8 bytes (hexdump) = 0x438 = 0x400 (1024 bytes ext4 pading) + 0x38 (ext4 superblock offset Magic signature, 0xEF53)</span></span><br><span class="line">$ <span class="built_in">echo</span> $(($((<span class="number">16#100438</span>))-$((<span class="number">16#438</span>))))</span><br><span class="line"></span><br><span class="line">$ mount /dev/sdg /mnt -o offset=1048576</span><br><span class="line">$ df -hT /mnt</span><br><span class="line">Filesystem     Type  Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/loop0     ext4  3.6T   89M  3.4T   1% /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment">## check the align</span></span><br><span class="line">$ (parted) align-check optimal 1 </span><br></pre></td></tr></table></figure>

<h4 id="Recovery-the-partition-table-by-gdisk"><a href="#Recovery-the-partition-table-by-gdisk" class="headerlink" title="Recovery the partition table by gdisk"></a>Recovery the partition table by gdisk</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ $ parted /dev/vdb &#x27;unit s print&#x27;</span><br><span class="line">Model: Virtio Block Device (virtblk)</span><br><span class="line">Disk /dev/vdb: 8388874240s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: loop</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  <span class="keyword">Start</span>  <span class="keyword">End</span>          <span class="keyword">Size</span>         <span class="keyword">File</span> <span class="keyword">system</span>  Flags</span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>s     <span class="number">8388874239</span>s  <span class="number">8388874240</span>s  xfs</span><br><span class="line"></span><br><span class="line">$ ls -l /dev/sdg</span><br><span class="line">brw-rw<span class="comment">---- 1 root disk 8, 96 Feb  7 12:24 /dev/sdg</span></span><br><span class="line">$ ls -l /dev/sdg1</span><br><span class="line">ls: cannot <span class="keyword">access</span> /dev/sdg1: <span class="keyword">No</span> such <span class="keyword">file</span> <span class="keyword">or</span> <span class="keyword">directory</span></span><br><span class="line"></span><br><span class="line">Command (? <span class="keyword">for</span> <span class="keyword">help</span>): p</span><br><span class="line">Disk /dev/sdg: <span class="number">31251759104</span> sectors, <span class="number">14.6</span> TiB</span><br><span class="line"><span class="keyword">Logical</span> sector <span class="keyword">size</span>: <span class="number">512</span> <span class="keyword">bytes</span></span><br><span class="line">Disk identifier (GUID): F372D874-C734<span class="number">-49</span>A1-A634<span class="number">-87</span>DD80602FD9</span><br><span class="line"><span class="keyword">Partition</span> <span class="keyword">table</span> holds up <span class="keyword">to</span> <span class="number">128</span> entries</span><br><span class="line"><span class="keyword">First</span> <span class="keyword">usable</span> sector <span class="keyword">is</span> <span class="number">34</span>, <span class="keyword">last</span> <span class="keyword">usable</span> sector <span class="keyword">is</span> <span class="number">8388874206</span></span><br><span class="line"><span class="keyword">Partitions</span> will be aligned <span class="keyword">on</span> <span class="number">8</span>-sector boundaries</span><br><span class="line">Total free <span class="keyword">space</span> <span class="keyword">is</span> <span class="number">1919</span> sectors (<span class="number">959.5</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Number</span>  <span class="keyword">Start</span> (sector)    <span class="keyword">End</span> (sector)  <span class="keyword">Size</span>       Code  <span class="keyword">Name</span></span><br><span class="line">   <span class="number">1</span>              <span class="number">34</span>      <span class="number">8388872287</span>   <span class="number">3.9</span> TiB     <span class="number">0700</span>  primary</span><br><span class="line"></span><br><span class="line">Command (? <span class="keyword">for</span> <span class="keyword">help</span>): w</span><br><span class="line"><span class="keyword">Warning</span>! Secondary header <span class="keyword">is</span> placed too early <span class="keyword">on</span> the disk! <span class="keyword">Do</span> you want <span class="keyword">to</span></span><br><span class="line">correct this problem? (Y/N): Y</span><br><span class="line">Have moved <span class="keyword">second</span> header <span class="keyword">and</span> <span class="keyword">partition</span> <span class="keyword">table</span> <span class="keyword">to</span> correct location.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Final</span> checks complete. About <span class="keyword">to</span> write GPT data. THIS WILL OVERWRITE EXISTING</span><br><span class="line"><span class="keyword">PARTITIONS</span>!!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Do</span> you want <span class="keyword">to</span> proceed? (Y/N): Y</span><br><span class="line">OK; writing new GUID partition table (GPT) to /dev/sdg.</span><br><span class="line">The operation has completed successfully.</span><br><span class="line">$ ls -l /dev/sdg</span><br><span class="line">sdg   sdg1</span><br><span class="line">$ ls -l /dev/sdg1</span><br><span class="line">brw-rw<span class="comment">---- 1 root disk 8, 97 Feb  7 12:24 /dev/sdg1</span></span><br></pre></td></tr></table></figure>

<h4 id="backup-partition-table-by-sgdisk"><a href="#backup-partition-table-by-sgdisk" class="headerlink" title="backup partition table by sgdisk"></a>backup partition table by sgdisk</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sgdisk --backup=vdb_part_1 /dev/vdb</span><br><span class="line">$ sgdisk --load-backup=vdb_part_1 /dev/vdb</span><br></pre></td></tr></table></figure>

<h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modify pass</span></span><br><span class="line">$ git config --global --<span class="built_in">unset</span> user.password</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/35942754/how-to-save-username-and-password-in-git/51164322#51164322">Use token replace password</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ git add README.md</span><br><span class="line">$ git commit -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line">$ git remote add origin https://github.com/xxxx/xxxx.git</span><br><span class="line">$ git pull</span><br><span class="line">$ git push -u origin master </span><br><span class="line"></span><br><span class="line"><span class="comment">## got the token from the web</span></span><br><span class="line">$ git remote add tools https://<span class="variable">$&#123;username&#125;</span>:<span class="variable">$&#123;token_key&#125;</span>@github.com/xxxx/xxxx</span><br><span class="line">$ vi README.md</span><br><span class="line">$ git add --all</span><br><span class="line">$ git commit -m <span class="string">&quot;update readme&quot;</span></span><br><span class="line">$ git push tools master</span><br><span class="line"></span><br><span class="line"><span class="comment">## show repo</span></span><br><span class="line">$ git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment">## delete</span></span><br><span class="line">$ git remote rm tools</span><br></pre></td></tr></table></figure>

<h3 id="Jemalloc-TCMalloc"><a href="#Jemalloc-TCMalloc" class="headerlink" title="Jemalloc TCMalloc"></a>Jemalloc TCMalloc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ yum install gperftools-libs</span><br><span class="line">$ exprot TCMALLOC_RELEASE_RATE = 0~10 (10 means the fastest reclaim)</span><br><span class="line">$ LD_PRELOAD=/usr/lib64/libtcmalloc.so.4 sh ./test.sh</span><br><span class="line"></span><br><span class="line">$ LD_PRELOAD=/usr/<span class="built_in">local</span>/lib/libjemalloc.so.2 sh ./test.sh</span><br><span class="line">$ LD_PRELOAD=mimalloc-2.0.0-src/out/release/libmimalloc.so.2.0 sh ./test.sh</span><br></pre></td></tr></table></figure>

<h3 id="tuned-adm"><a href="#tuned-adm" class="headerlink" title="tuned-adm"></a>tuned-adm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default config files</span></span><br><span class="line">$ ls /usr/lib/tuned</span><br><span class="line">balanced  desktop  <span class="built_in">functions</span>  latency-performance  network-latency  network-throughput  powersave  recommend.d  throughput-performance  virtual-guest  virtual-host</span><br><span class="line"></span><br><span class="line">$ tuned-adm list</span><br><span class="line">$ tuned-adm profile network-throughput</span><br><span class="line">$ tuned-adm active</span><br><span class="line"></span><br><span class="line">$ /etc/tuned/my-variables.conf</span><br><span class="line"></span><br><span class="line">[variables]</span><br><span class="line">include=/etc/tuned/my-variables.conf</span><br><span class="line"></span><br><span class="line">[bootloader]</span><br><span class="line">cmdline=isolcpus=0,1,2,3</span><br></pre></td></tr></table></figure>

<h3 id="Tick"><a href="#Tick" class="headerlink" title="Tick"></a>Tick</h3><p>Disable Tick to save power in some embedded device</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NO_HZ</span><br><span class="line">CONFIG_NO_HZ_IDLE</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">cat</span> /boot/config-<span class="number">3.10</span>.<span class="number">0</span>-<span class="number">1127</span>.el7.x86_64 | <span class="keyword">grep</span> -Ei <span class="string">&quot;CONFIG_NO_HZ | CONFIG_NO_HZ_IDLE&quot;</span></span><br><span class="line"># CONFIG_NO_HZ_IDLE <span class="keyword">is</span> not <span class="keyword">set</span></span><br></pre></td></tr></table></figure>

<h3 id="Two’s-Complement-and-the-negative-number"><a href="#Two’s-Complement-and-the-negative-number" class="headerlink" title="Two’s Complement and the negative number"></a><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2009/08/twos_complement.html">Two’s Complement and the negative number</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">0000 1000 = 8</span><br><span class="line"></span><br><span class="line">inverted</span><br><span class="line">1111 0111</span><br><span class="line"></span><br><span class="line">Add 1</span><br><span class="line">1111 1000 = -8</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">-8=0-8</span><br><span class="line"> 0000 0000</span><br><span class="line">-0000 1000</span><br><span class="line"></span><br><span class="line">borrow</span><br><span class="line">10000 0000</span><br><span class="line">-0000 1000</span><br><span class="line">----------</span><br><span class="line"> 1111 1000 = -8</span><br><span class="line"></span><br><span class="line">10000 0000 - 0000 1000 could be split</span><br><span class="line"></span><br><span class="line">first step: inverted</span><br><span class="line"> 1111 1111</span><br><span class="line">-0000 1000</span><br><span class="line">----------</span><br><span class="line"> 1111 0111</span><br><span class="line"></span><br><span class="line">Second step: Add 1</span><br><span class="line"> 1111 0111</span><br><span class="line">+0000 0001</span><br><span class="line">----------</span><br><span class="line"> 1111 1000 = -8</span><br></pre></td></tr></table></figure>

<h3 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a><a target="_blank" rel="noopener" href="https://bean-li.github.io/dive-into-iostat/">iostat</a></h3><p>io_ticks: the IO service wall-clock time in this device<br>in_flight: The number of I/Os incomplete in the queue, entry the queue +1, when the IO fininshed -1.<br>time_in_queue = in_flight * wall-clock time</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">time</span>=<span class="number">100</span>ms, nothing, in_flight=<span class="number">0</span>, stamp=<span class="number">100</span>, stamp_delta=nothing, io_tickes=<span class="number">0</span>, time_in_queue=<span class="number">0</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">100</span>.<span class="number">1</span>ms, the request in the queue, in_flight=<span class="number">1</span>, stamp=<span class="number">100</span>, stamp_delta=<span class="number">100</span>.<span class="number">1</span>-<span class="number">100</span>=<span class="number">0</span>.<span class="number">1</span>, io_tickes=<span class="number">0</span>.<span class="number">1</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>=<span class="number">0</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">101</span>.<span class="number">2</span>ms, the request in the queue, in_flight=<span class="number">2</span>, stamp=<span class="number">100</span>.<span class="number">1</span>, stamp_delta=<span class="number">101</span>.<span class="number">2</span>-<span class="number">100</span>.<span class="number">1</span>=<span class="number">1</span>.<span class="number">1</span>, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>=<span class="number">1</span>.<span class="number">2</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>=<span class="number">2</span>.<span class="number">3</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">103</span>.<span class="number">6</span>ms, <span class="number">1</span>x request finish, in_flight=<span class="number">1</span>, stamp=<span class="number">101</span>.<span class="number">2</span>, stamp_delta=<span class="number">103</span>.<span class="number">6</span>-<span class="number">101</span>.<span class="number">2</span>=<span class="number">2</span>.<span class="number">4</span>, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>+<span class="number">2</span>.<span class="number">4</span>=<span class="number">3</span>.<span class="number">6</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>+<span class="number">2</span>.<span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>.<span class="number">7</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">153</span>.<span class="number">6</span>ms, <span class="number">1</span>x request finish, in_flight=<span class="number">0</span>, stamp=<span class="number">103</span>.<span class="number">6</span>, stamp_delta=nothing, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>+<span class="number">2</span>.<span class="number">4</span>=<span class="number">3</span>.<span class="number">6</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>+<span class="number">2</span>.<span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>.<span class="number">7</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">153</span>.<span class="number">9</span>ms, <span class="number">1</span>x request in, in_flight=<span class="number">1</span>, stamp=<span class="number">153</span>.<span class="number">6</span>, stamp_delta=<span class="number">153</span>.<span class="number">9</span>-<span class="number">153</span>.<span class="number">6</span>=<span class="number">0</span>.<span class="number">3</span>, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>+<span class="number">2</span>.<span class="number">4</span>+<span class="number">0</span>.<span class="number">3</span>=<span class="number">3</span>.<span class="number">9</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>+<span class="number">2</span>.<span class="number">4</span>*<span class="number">1</span>+<span class="number">0</span>.<span class="number">3</span>*<span class="number">1</span>=<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>In this case, the time_in_queue = sum(in_flight)<br>The_wall-clock_total_time means the interval time for this calculate<br>The iostat utils = io_tickes/The_wall-clock_total_time = utils xx %</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux-3.10.0-1127.el7/include/linux/genhd.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">disk_stats</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> sectors[<span class="number">2</span>];       <span class="comment">/* READs and WRITEs */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ios[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> merges[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ticks[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> io_ticks;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> time_in_queue;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">diskstats_show</span><span class="params">(struct seq_file *seqf, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *<span class="title">gp</span> = <span class="title">v</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">disk_part_iter</span> <span class="title">piter</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hd_struct</span> *<span class="title">hd</span>;</span></span><br><span class="line">        <span class="keyword">char</span> buf[BDEVNAME_SIZE];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> inflight[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> cpu;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if (&amp;disk_to_dev(gp)-&gt;kobj.entry == block_class.devices.next)</span></span><br><span class="line"><span class="comment">                seq_puts(seqf,  &quot;major minor name&quot;</span></span><br><span class="line"><span class="comment">                                &quot;     rio rmerge rsect ruse wio wmerge &quot;</span></span><br><span class="line"><span class="comment">                                &quot;wsect wuse running use aveq&quot;</span></span><br><span class="line"><span class="comment">                                &quot;\n\n&quot;);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        disk_part_iter_init(&amp;piter, gp, DISK_PITER_INCL_EMPTY_PART0);</span><br><span class="line">        <span class="keyword">while</span> ((hd = disk_part_iter_next(&amp;piter))) &#123;</span><br><span class="line">                cpu = part_stat_lock();</span><br><span class="line">                part_round_stats(gp-&gt;<span class="built_in">queue</span>, cpu, hd);</span><br><span class="line">                part_stat_unlock();</span><br><span class="line">                part_in_flight(gp-&gt;<span class="built_in">queue</span>, hd, inflight);</span><br><span class="line">                seq_printf(seqf, <span class="string">&quot;%4d %7d %s %lu %lu %lu &quot;</span></span><br><span class="line">                           <span class="string">&quot;%u %lu %lu %lu %u %u %u %u\n&quot;</span>,</span><br><span class="line">                           MAJOR(part_devt(hd)), MINOR(part_devt(hd)),</span><br><span class="line">                           disk_name(gp, hd-&gt;partno, buf),</span><br><span class="line">                           part_stat_read(hd, ios[READ]),</span><br><span class="line">                           part_stat_read(hd, merges[READ]),</span><br><span class="line">                           part_stat_read(hd, sectors[READ]),</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, ticks[READ])),</span><br><span class="line">                           part_stat_read(hd, ios[WRITE]),</span><br><span class="line">                           part_stat_read(hd, merges[WRITE]),</span><br><span class="line">                           part_stat_read(hd, sectors[WRITE]),</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, ticks[WRITE])),</span><br><span class="line">                           inflight[<span class="number">0</span>],</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, io_ticks)),</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, time_in_queue))</span><br><span class="line">                        );</span><br><span class="line">        &#125;</span><br><span class="line">        disk_part_iter_exit(&amp;piter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="proc-pid-smaps-vmflags"><a href="#proc-pid-smaps-vmflags" class="headerlink" title="/proc/pid/smaps vmflags"></a>/proc/pid/smaps vmflags</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rd	readable</span><br><span class="line">wr	writeable</span><br><span class="line">ex	executable</span><br><span class="line">sh	shared</span><br><span class="line">mr	may read</span><br><span class="line">mw	may write</span><br><span class="line">me	may execute</span><br><span class="line">ms	may share</span><br><span class="line">gd	stack segment growns down</span><br><span class="line">pf	pure PFN range</span><br><span class="line">dw	disabled write <span class="keyword">to</span> the mapped file</span><br><span class="line">lo	pages are locked <span class="keyword">in</span> memory</span><br><span class="line">io	memory mapped I/O area</span><br><span class="line">sr	sequential read advise provided</span><br><span class="line">rr	random read advise provided</span><br><span class="line">dc	<span class="keyword">do</span> <span class="keyword">not</span> copy<span class="built_in"> area </span>on fork</span><br><span class="line">de	<span class="keyword">do</span> <span class="keyword">not</span> expand<span class="built_in"> area </span>on remapping</span><br><span class="line">ac<span class="built_in">	area </span>is accountable</span><br><span class="line">nr	swap space is <span class="keyword">not</span> reserved <span class="keyword">for</span> the area</span><br><span class="line">ht<span class="built_in">	area </span>uses huge tlb pages</span><br><span class="line">nl	non-linear mapping</span><br><span class="line">ar	architecture specific flag</span><br><span class="line">dd	<span class="keyword">do</span> <span class="keyword">not</span> include<span class="built_in"> area </span>into core dump</span><br><span class="line">mm	mixed map area</span><br><span class="line">hg	huge<span class="built_in"> page </span>advise flag</span><br><span class="line">nh	no-huge<span class="built_in"> page </span>advise flag</span><br><span class="line">mg	mergable advise flag</span><br></pre></td></tr></table></figure>

<h3 id="not-loading-kernel-module"><a href="#not-loading-kernel-module" class="headerlink" title="not loading kernel module"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/41278">not loading kernel module</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## kernel boot blacklist</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;modprobe.blacklist=mpt2sas&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># modprobe -r module_name                                                      #step1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;blacklist module_name&quot;</span> &gt;&gt; /etc/modprobe.d/local-dontload.conf            <span class="comment">#step2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;install module_name /bin/false&quot;</span> &gt;&gt; /etc/modprobe.d/local-dontload.conf   <span class="comment">#step3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak                       #step4</span></span><br><span class="line"><span class="comment"># dracut --omit-drivers module_name -f                                                                               #step5</span></span><br><span class="line"><span class="comment"># grub2-editenv - list | grep kernelopts                                                                             #step6</span></span><br><span class="line"><span class="comment"># grub2-editenv - set kernelopts=&quot;&lt;&gt; module_name.blacklist=1 rd.driver.blacklist=module_name&quot;                        #step7</span></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r)kdump.img /boot/initramfs-$(uname -r)kdump.img.$(date +%m-%d-%H%M%S).bak             #step8</span></span><br><span class="line"><span class="comment"># sed -i &#x27;/^KDUMP_COMMANDLINE_APPEND=/s/&quot;$/ rd.driver.blacklist=module_name&quot;/&#x27; /etc/sysconfig/kdump                  #step9</span></span><br><span class="line"><span class="comment"># kdumpctl restart                                                                                                   #step10</span></span><br><span class="line"><span class="comment"># mkdumprd -f /boot/initramfs-$(uname -r)kdump.img                                                                   #step11</span></span><br><span class="line"><span class="comment"># reboot                                                                                                             #step12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak                       #step4</span></span><br><span class="line"><span class="comment"># dracut --omit-drivers module_name -f                                                                               #step5</span></span><br><span class="line"><span class="comment"># sed -i &#x27;/^GRUB_CMDLINE_LINUX=/s/&quot;$/ module_name.blacklist=1 rd.driver.blacklist=module_name&quot;/&#x27; /etc/default/grub   #step6</span></span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg                                                                             #step7</span></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r)kdump.img /boot/initramfs-$(uname -r)kdump.img.$(date +%m-%d-%H%M%S).bak             #step8</span></span><br><span class="line"><span class="comment"># sed -i &#x27;/^KDUMP_COMMANDLINE_APPEND=/s/&quot;$/ rd.driver.blacklist=module_name&quot;/&#x27; /etc/sysconfig/kdump                  #step9</span></span><br><span class="line"><span class="comment"># kdumpctl restart                                                                                                   #step10</span></span><br><span class="line"><span class="comment"># mkdumprd -f /boot/initramfs-$(uname -r)kdump.img                                                                   #step11</span></span><br><span class="line"><span class="comment"># reboot                                                                                                             #step12</span></span><br></pre></td></tr></table></figure>

<h3 id="Process-signal"><a href="#Process-signal" class="headerlink" title="Process signal"></a>Process signal</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> 1) SIGHUP	 2) SIGINT	 3) SIGQUIT	 4) SIGILL</span><br><span class="line"> 5) SIGTRAP	 6) SIGABRT	 7) SIGBUS	 8) SIGFPE</span><br><span class="line"> 9) SIGKILL	10) SIGUSR1	11) SIGSEGV	12) SIGUSR2</span><br><span class="line">13) SIGPIPE	14) SIGALRM	15) SIGTERM	16) SIGSTKFLT</span><br><span class="line">17) SIGCHLD	18) SIGCONT	19) SIGSTOP	20) SIGTSTP</span><br><span class="line">21) SIGTTIN	22) SIGTTOU	23) SIGURG	24) SIGXCPU</span><br><span class="line">25) SIGXFSZ	26) SIGVTALRM	27) SIGPROF	28) SIGWINCH</span><br><span class="line">29) SIGIO	30) SIGPWR	31) SIGSYS	34) SIGRTMIN</span><br><span class="line">35) SIGRTMIN+1	36) SIGRTMIN+2	37) SIGRTMIN+3	38) SIGRTMIN+4</span><br><span class="line">39) SIGRTMIN+5	40) SIGRTMIN+6	41) SIGRTMIN+7	42) SIGRTMIN+8</span><br><span class="line">43) SIGRTMIN+9	44) SIGRTMIN+10	45) SIGRTMIN+11	46) SIGRTMIN+12</span><br><span class="line">47) SIGRTMIN+13	48) SIGRTMIN+14	49) SIGRTMIN+15	50) SIGRTMAX-14</span><br><span class="line">51) SIGRTMAX-13	52) SIGRTMAX-12	53) SIGRTMAX-11	54) SIGRTMAX-10</span><br><span class="line">55) SIGRTMAX-9	56) SIGRTMAX-8	57) SIGRTMAX-7	58) SIGRTMAX-6</span><br><span class="line">59) SIGRTMAX-5	60) SIGRTMAX-4	61) SIGRTMAX-3	62) SIGRTMAX-2</span><br><span class="line">63) SIGRTMAX-1	64) SIGRTMAX	</span><br><span class="line"></span><br><span class="line"><span class="comment">## send STOP signal for this user</span></span><br><span class="line">$ pkill --signal 19 -U testuser</span><br><span class="line"></span><br><span class="line"><span class="comment">## send CONT signal for this user</span></span><br><span class="line">$ pkill --signal 18 -U testuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bypass the lfs read deadlock !!!, good job</span></span><br></pre></td></tr></table></figure>

<h3 id="iftop"><a href="#iftop" class="headerlink" title="iftop"></a>iftop</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ timeout 5 iftop  -F 192.168.* -i bond0 -t  -B -n</span><br><span class="line">Got the top10</span><br><span class="line">$ awk <span class="string">&#x27;&#123;if($1~/10.[0-9]+/) &#123;a[$1]++&#125;; if($2~/10.[0-9]+/) &#123;a[$2]++&#125;&#125; END&#123;for(i in a) &#123;if(a[i]!=20) &#123;print i&#125;&#125;&#125;&#x27;</span> /tmp/tmp1</span><br></pre></td></tr></table></figure>

<h3 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h3><h4 id="shadowsocks"><a href="#shadowsocks" class="headerlink" title="shadowsocks"></a>shadowsocks</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&#x27;s/cleanup/cleanup/g&#x27;</span> /usr/<span class="built_in">local</span>/lib/pythonX.X/dist-packages/shadowsocks/crypto/openssl.py</span><br></pre></td></tr></table></figure>

<h4 id="use-proxychains"><a href="#use-proxychains" class="headerlink" title="use proxychains"></a>use proxychains</h4><p>Disable the system Integrity Protection</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">⌘ + R go to recovery mode</span><br><span class="line">Utilities -&gt; Terminal -&gt; $ csrutil <span class="built_in">enable</span> --without debug</span><br><span class="line">or</span><br><span class="line">Utilities -&gt; Terminal -&gt; $ csrutil <span class="built_in">disable</span> </span><br><span class="line">reboot </span><br><span class="line">$ csrutil status</span><br><span class="line">System Integrity Protection status: disabled</span><br><span class="line"></span><br><span class="line"><span class="comment">#not comment this line in proxychains-ng</span></span><br><span class="line">quiet_mode <span class="comment">#</span></span><br><span class="line">[ProxyList]</span><br><span class="line">socks5 127.0.0.1 1080</span><br><span class="line"></span><br><span class="line">$ proxychains /bin/bash</span><br><span class="line">$ wget https://www.google.com</span><br></pre></td></tr></table></figure>

<h3 id="NMI"><a href="#NMI" class="headerlink" title="NMI"></a>NMI</h3><p>Non-Maskable Interrupt(NMI) is the highest priority interrupt that can not be masked by any software<br>The NMI watchdog base the APIC(Advanced Programmable Interrupt Controller) protocol  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kernel.nmi_watchdog=1 →(I/O APIC)</span><br><span class="line">kernel.nmi_watchdog=2 → (Locall APIC)</span><br><span class="line"></span><br><span class="line"><span class="comment">## or add the parameter to grub</span></span><br><span class="line">nmi_watchdog=0</span><br></pre></td></tr></table></figure>

<h3 id="dmidecode-number"><a href="#dmidecode-number" class="headerlink" title="dmidecode number"></a>dmidecode number</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Type	Information</span><br><span class="line">0	BIOS</span><br><span class="line">1	System</span><br><span class="line">2	Baseboard</span><br><span class="line">3	Chassis</span><br><span class="line">4	Processor</span><br><span class="line">5	Memory Controller</span><br><span class="line">6	Memory Module</span><br><span class="line">7	Cache</span><br><span class="line">8	Port Connector</span><br><span class="line">9	System Slots</span><br><span class="line">10	On Board Devices</span><br><span class="line">11	OEM Strings</span><br><span class="line">12	System Configuration Options</span><br><span class="line">13	BIOS Language</span><br><span class="line">14	Group Associations</span><br><span class="line">15	System Event Log</span><br><span class="line">16	Physical Memory Array</span><br><span class="line">17	Memory Device</span><br><span class="line">18	32-bit Memory Error</span><br><span class="line">19	Memory Array Mapped Address</span><br><span class="line">20	Memory Device Mapped Address</span><br><span class="line">21	Built-in Pointing Device</span><br><span class="line">22	Portable Battery</span><br><span class="line">23	System Reset</span><br><span class="line">24	Hardware Security</span><br><span class="line">25	System Power Controls</span><br><span class="line">26	Voltage Probe</span><br><span class="line">27	Cooling Device</span><br><span class="line">28	Temperature Probe</span><br><span class="line">29	Electrical Current Probe</span><br><span class="line">30	Out-of-band Remote Access</span><br><span class="line">31	Boot Integrity Services</span><br><span class="line">32	System Boot</span><br><span class="line">33	64-bit Memory Error</span><br><span class="line">34	Management Device</span><br><span class="line">35	Management Device Component</span><br><span class="line">36	Management Device Threshold Data</span><br><span class="line">37	Memory Channel</span><br><span class="line">38	IPMI Device</span><br><span class="line">39	Power Supply</span><br><span class="line">40	Additional Information</span><br><span class="line">41	Onboard Devices Extended Information</span><br><span class="line">42	Management Controller Host Interface</span><br></pre></td></tr></table></figure>

<h3 id="How-to-got-the-info-from-the-pipe-fd-and-socke-fd"><a href="#How-to-got-the-info-from-the-pipe-fd-and-socke-fd" class="headerlink" title="How to got the info from the pipe fd and socke fd"></a>How to got the info from the pipe fd and socke fd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ strace ls -l /proc/pid/fd</span><br><span class="line">readlink(<span class="string">&quot;6&quot;</span>, <span class="string">&quot;socket:[4248017]&quot;</span>, 65)   = 16</span><br><span class="line">lrwx------ 1 nobody nobody 64 Apr 25 11:04 6 -&gt; socket:[4248017]</span><br><span class="line"></span><br><span class="line">$ netstat -alep | grep 4248017</span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode      PID/Program name</span><br><span class="line">unix  3      [ ]         STREAM                                   CONNECTED               4248017     31233/<span class="built_in">test</span></span><br><span class="line"><span class="comment">## it &#x27;s means unix domain socket connectted with another local inter-process</span></span><br><span class="line"><span class="comment">## if it &#x27;s the remote socket connection you could see the ip adddr, grep xxx /proc/net/tcp /proc/net/udp</span></span><br><span class="line">```bash</span><br><span class="line">$ netstat -alep | grep 5522546</span><br><span class="line">tcp        0      0 0.0.0.0:chimera-hwm     0.0.0.0:*               LISTEN      root       5522546    160890/qperf</span><br><span class="line">$ grep 5522546 /proc/net/tcp</span><br><span class="line">   0: 00000000:0FA9 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 5522546 1 ffff952fb5be07c0 100 0 0 10 0</span><br><span class="line"><span class="comment">## local </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## remote</span></span><br><span class="line">$ netstat -alep | grep 5866595</span><br><span class="line">tcp        0      0 test-2643-2:ssh         10.0.0.73:47702         ESTABLISHED root       5866595    147135/sshd: root@p</span><br><span class="line">$ grep 5866595 /proc/net/tcp</span><br><span class="line">  31: 0x0100a8c1:0016 0200a8c1:BA56 01 00000000:00000000 02:000AC753 00000000     0        0 5866595 4 ffff95283ca10f80 20 4 25 10 22</span><br><span class="line"></span><br><span class="line">cat dec2ip</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">dec2ip ()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">local</span> v=<span class="variable">$1</span></span><br><span class="line">   <span class="built_in">local</span> i1=$((v&gt;&gt;<span class="number">24</span>&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">local</span> i2=$((v&gt;&gt;<span class="number">16</span>&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">local</span> i3=$((v&gt;&gt;<span class="number">8</span>&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">local</span> i4=$((v&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">&#x27;%d.%d.%d.%d\n&#x27;</span> <span class="variable">$i4</span> <span class="variable">$i3</span> <span class="variable">$i2</span> <span class="variable">$i1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dec2ip <span class="variable">$1</span></span><br><span class="line"><span class="comment">#### </span></span><br><span class="line"></span><br><span class="line">$ sh dec2ip $(<span class="built_in">printf</span> <span class="string">&quot;%d \n&quot;</span> 0x0200a8c1)</span><br><span class="line">193.168.0.2</span><br><span class="line"></span><br><span class="line">// https://gist.github.com/jkstill/5095725</span><br><span class="line">31: 0x0100a8c1:0016 0200a8c1:BA56 01 00000000:00000000 02:000AC753 00000000     0        0 5866595 4 ffff95283ca10f80 20 4 25 10 22</span><br><span class="line">31:0x0100a8c1:0016 0200a8c1:BA56 01</span><br><span class="line"> |   |         |   |        |    |--&gt; connection state</span><br><span class="line"> |   |         |   |        |------&gt; remote TCP port number</span><br><span class="line"> |   |         |   |-------------&gt; remote IPv4 address</span><br><span class="line"> |   |         |--------------------&gt; <span class="built_in">local</span> TCP port number</span><br><span class="line"> |   |---------------------------&gt; <span class="built_in">local</span> IPv4 address</span><br><span class="line"> |----------------------------------&gt; number of entry</span><br><span class="line"></span><br><span class="line">00000000:00000000 02:000AC753 00000000</span><br><span class="line"> |        |        |  |        |--&gt; number of unrecovered RTO timeouts</span><br><span class="line"> |        |        |  |----------&gt; number of jiffies until timer expires</span><br><span class="line"> |        |        |----------------&gt; timer_active (see below)</span><br><span class="line"> |        |----------------------&gt; receive-queue</span><br><span class="line"> |-------------------------------&gt; transmit-queue</span><br><span class="line"></span><br><span class="line">0        0 5866595 4 ffff95283ca10f80 20 4 25 10 22</span><br><span class="line">|        | |                | |        |  | |  |  |--&gt; slow start size threshold, </span><br><span class="line">|        | |                | |        |  | |  |       or -1 <span class="keyword">if</span> the treshold</span><br><span class="line">|        | |                | |        |  | |  |       is &gt;= 0xFFFF</span><br><span class="line">|        | |                | |        |  | |  |----&gt; sending congestion window</span><br><span class="line">|        | |                | |        |  | |-------&gt; (ack.quick&lt;&lt;1)|ack.pingpong</span><br><span class="line">|        | |                | |        |  |---------&gt; Predicted tick of soft clock</span><br><span class="line">|        | |                | |        |               (delayed ACK control data)</span><br><span class="line">|        | |                | |        |------------&gt; retransmit timeout</span><br><span class="line">|        | |                | |------------------&gt; location of socket <span class="keyword">in</span> memory</span><br><span class="line">|        | |                |-----------------------&gt; socket reference count</span><br><span class="line">|        | |-----------------------------&gt; inode</span><br><span class="line">|        |----------------------------------&gt; unanswered 0-window probes</span><br><span class="line">|---------------------------------------------&gt; uid</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net/socket.c </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sockfs_dname() is called from d_path().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">sockfs_dname</span><span class="params">(struct dentry *dentry, <span class="keyword">char</span> *buffer, <span class="keyword">int</span> buflen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> dynamic_dname(dentry, buffer, buflen, <span class="string">&quot;socket:[%lu]&quot;</span>,</span><br><span class="line">dentry-&gt;d_inode-&gt;i_ino);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<pre><code>                                      ----&gt; you get the inode number from pipe or socketfs, you could these processes list
                                      |</code></pre>
<p>$ strace ls -lR /proc 2&gt;&amp;1 | grep -Ei ‘4301922|4248015’</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">### process schdule</span></span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">$ awk &#x27;NF &gt; <span class="number">7</span> &#123; <span class="keyword">if</span> ($<span class="number">1</span> == <span class="string">&quot;task&quot;</span>) &#123; <span class="keyword">if</span> (h == <span class="number">0</span>) &#123; <span class="keyword">print</span>; h=<span class="number">1</span> &#125; &#125; <span class="keyword">else</span> &#123; <span class="keyword">print</span> &#125; &#125;&#x27; /<span class="function"><span class="keyword">proc</span>/<span class="title">sched_debug</span></span></span><br></pre></td></tr></table></figure>

<h4 id="process-schdule"><a href="#process-schdule" class="headerlink" title="process schdule"></a><a target="_blank" rel="noopener" href="http://abcdxyzk.github.io/blog/2014/05/22/kernel-sched-tick/">process schdule</a></h4><p><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/2988101">sched: RT throttling activated</a><br>Enable RT_RUNTIME_GREED with the following command:<br>Raw</p>
<pre><code>/proc/sys/kernel/sched_rt_period_us
Defines the period in μs (microseconds) to be considered as 100% of CPU bandwidth. The default value is 1,000,000 μs (1 second). Changes to the value of the period must be very well thought out as a period too long or too small are equally dangerous. 

/proc/sys/kernel/sched_rt_runtime_us
The total bandwidth available to all real-time tasks. The default values is 950,000 μs (0.95 s) or, in other words, 95% of the CPU bandwidth. Setting the value to -1 means that real-time tasks may use up to 100% of CPU times. This is only adequate when the real-time tasks are well engineered and have no obvious caveats such as unbounded polling loops. 


$ echo RT_RUNTIME_GREED &gt; /sys/kernel/debug/sched_features

To keep all CPUs with the same rt_runtime, disable the NO_RT_RUNTIME_SHARE logic:
$ echo NO_RT_RUNTIME_SHARE &gt; /sys/kernel/debug/sched_features

### it could cause some issue in pin the linux process to cpu core
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">That means some guy enable the linux process real-<span class="built_in">time</span> schdule</span><br><span class="line">```bash</span><br><span class="line">## interval </span><br><span class="line"></span><br><span class="line">|<span class="type">----&gt;do_timer</span>()   更新jiffies_64</span><br><span class="line">|<span class="type">----&gt;update_process_times</span>()</span><br><span class="line">	|<span class="type">----&gt;scheduler_tick</span>()</span><br><span class="line">	|<span class="type">----&gt;update_rq_clock</span>()  更新当前调度队列rq的clock</span><br><span class="line">	|<span class="type">----&gt;curr</span>-&gt;sched_class-&gt;task_tick() </span><br><span class="line">	|         <span class="type">对于普通进程，即task_tick_fair</span>()</span><br><span class="line">	|         <span class="type">task_struct</span>: struct sched_class *sched_class</span><br><span class="line"></span><br><span class="line">update_rq_clock()----delta = sched_clock_cpu(cpu_of(rq)) - rq-&gt;clock</span><br><span class="line">	|<span class="type">-----两次相邻两次周期性调度器运行的时间差</span></span><br><span class="line"><span class="type">	|----rq</span>-&gt;clock += delta; 更新运行队列上的时钟</span><br><span class="line">		|<span class="type">----&gt;update_rq_clock_task</span>(rq, delta)</span><br><span class="line">		|     <span class="type">即rq</span>-&gt;clock_task += delta</span><br><span class="line"></span><br><span class="line">## normal</span><br><span class="line">task_tick_fair()----&gt;entity_tick()   没有考虑组调度</span><br><span class="line">  |<span class="type">----&gt;update_curr</span>() 更新相关统计量</span><br><span class="line">  |<span class="type">----&gt;check_preempt_tick</span>()   </span><br><span class="line">  |        <span class="type">检查进程本次获得CPU</span>使用权的执行时间是否超过了</span><br><span class="line">  |        <span class="type">它对应的ideal_runtime</span>值，如果超过了，则将当前进</span><br><span class="line">  |        <span class="type">程的TIF_NEED_RESCHED</span>标志位置位</span><br><span class="line"></span><br><span class="line">update_curr()</span><br><span class="line">  |<span class="type">----delta_exec</span> = (unsigned long)(now - curr-&gt;exec_start);  </span><br><span class="line">  |            <span class="type">exec_start</span>当前进程开始获得</span><br><span class="line">  |            <span class="type">cpu</span>使用权时的时间戳;</span><br><span class="line">  |            <span class="type">进程本次所获得的CPU</span>执行权的时间;</span><br><span class="line">  |<span class="type">----&gt;__update_curr</span>(cfs_rq, curr, delta_exec);</span><br><span class="line">      |<span class="type">----&gt;curr</span>-&gt;sum_exec_runtime += delta_exec; </span><br><span class="line">      |     <span class="type">更新该进程获得CPU</span>执行权总时间</span><br><span class="line">      |<span class="type"></span></span><br><span class="line"><span class="type">      |----&gt;curr</span>-&gt;vruntime += delta_exec_weighted;</span><br><span class="line">      |     <span class="type">更新该进程获得CPU</span>执行权的虚拟时间</span><br><span class="line">      |<span class="type"></span></span><br><span class="line"><span class="type">      |----&gt;update_min_vruntime</span>()</span><br><span class="line">      |     <span class="type">更新cfs_rq</span>-&gt;min_vruntime</span><br><span class="line">      |<span class="type"></span></span><br><span class="line"><span class="type">  |----&gt;curr</span>-&gt;exec_start = now    </span><br><span class="line">  |        <span class="type">更新进程下次运行起始时间</span></span><br><span class="line"><span class="type">  |        (如果被抢占，下次被调度时将会更新)</span></span><br><span class="line"><span class="type"></span></span><br><span class="line"><span class="type">check_preempt_tick</span>()</span><br><span class="line">  |<span class="type">----ideal_runtime</span> = sched_slice(cfs_rq, curr);</span><br><span class="line">  |<span class="type">----delta_exec</span> = curr-&gt;sum_exec_runtime </span><br><span class="line">  |                 <span class="type">- curr</span>-&gt;prev_sum_exec_runtime;</span><br><span class="line">  |<span class="type">----if</span>(delta_exec &gt; ideal_runtime)  </span><br><span class="line">  |          <span class="type">resched_task</span>(rq_of(cfs_rq)-&gt;curr);</span><br><span class="line">  |          <span class="type">把当前进程的TIF_NEED_RESCHED</span>标志位置位</span><br><span class="line">  |<span class="type">----else</span></span><br><span class="line">  |    <span class="type">delta</span> = curr-&gt;vruntime - se-&gt;vruntime;  //这是什么？</span><br><span class="line">  |    <span class="type">if</span> (delta &gt; ideal_runtime)  </span><br><span class="line">  |        <span class="type">resched_task</span>(rq_of(cfs_rq)-&gt;curr);</span><br><span class="line">  |        <span class="type">把当前进程的TIF_NEED_RESCHED</span>标志位置位</span><br><span class="line"></span><br><span class="line">## real <span class="built_in">time</span></span><br><span class="line">task_tick_rt()</span><br><span class="line">  |<span class="type">----&gt;update_curr_rt</span>();</span><br><span class="line">  |<span class="type">----&gt;if</span> (p-&gt;policy != SCHED_RR) <span class="keyword">return</span>;  SCHED_FIFO只有主动放弃CPU使用权</span><br><span class="line">  |<span class="type">----&gt;rt</span>.timeslice值减一，若没有运行完时间则直接返回，</span><br><span class="line">  |     <span class="type">否则再次分配时间片，加入队列尾部，设置TIF_NEED_RESCHED</span></span><br><span class="line"></span><br><span class="line">update_curr_rt()</span><br><span class="line">  |<span class="type">----delta_exec</span> = rq-&gt;clock - curr-&gt;se.exec_start; //本次运行时间</span><br><span class="line">  |<span class="type">----curr</span>-&gt;se.sum_exec_runtime += delta_exec; //更新总得运行时间</span><br><span class="line">  |<span class="type">----curr</span>-&gt;se.exec_start = rq-&gt;clock; //更新下次进程运行的起始时间</span><br><span class="line">  |<span class="type">----if</span> (sched_rt_runtime(rt_rq) != RUNTIME_INF)</span><br><span class="line">  |<span class="type">-------&#123;</span></span><br><span class="line"><span class="type">  |           rt_rq</span>-&gt;rt_time += delta_exec;</span><br><span class="line">  |                <span class="type">if</span> (sched_rt_runtime_exceeded(rt_rq))</span><br><span class="line">  |                   <span class="type">resched_task</span>(curr);</span><br><span class="line">  |       <span class="type">&#125;</span></span><br></pre></td></tr></table></figure>


[in non real time linux kernel, dmesg show the &quot;sched: RT throttling activated&quot;](http://abcdxyzk.github.io/blog/2014/05/22/kernel-sched-tick/)
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">##<span class="meta"># looks like someone set the real-time process group by cgroup</span></span><br><span class="line">##<span class="meta"># linux-3.10.0-1127.el7/kernel/sched/rt.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sched_rt_runtime_exceeded</span><span class="params">(struct rt_rq *rt_rq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u64 runtime = sched_rt_runtime(rt_rq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rt_rq-&gt;rt_throttled)</span><br><span class="line">                <span class="keyword">return</span> rt_rq_throttled(rt_rq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runtime &gt;= sched_rt_period(rt_rq))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        balance_runtime(rt_rq);</span><br><span class="line">        runtime = sched_rt_runtime(rt_rq);</span><br><span class="line">        <span class="keyword">if</span> (runtime == RUNTIME_INF)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rt_rq-&gt;rt_time &gt; runtime) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">rt_bandwidth</span> *<span class="title">rt_b</span> = <span class="title">sched_rt_bandwidth</span>(<span class="title">rt_rq</span>);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Don&#x27;t actually throttle groups that have no runtime assigned</span></span><br><span class="line"><span class="comment">                 * but accrue some time due to boosting.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (likely(rt_b-&gt;rt_runtime)) &#123;</span><br><span class="line">                        rt_rq-&gt;rt_throttled = <span class="number">1</span>;</span><br><span class="line">                        printk_deferred_once(<span class="string">&quot;sched: RT throttling activated\n&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         * In case we did anyway, make it go away,</span></span><br><span class="line"><span class="comment">                         * replenishment is a joke, since it will replenish us</span></span><br><span class="line"><span class="comment">                         * with exactly 0 ns.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        rt_rq-&gt;rt_time = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##<span class="meta"># linux-3.10.0-1127.el7/kernel/sched/sched.h</span></span><br><span class="line"><span class="comment">/* task group related information */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> <span class="title">css</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FAIR_GROUP_SCHED</span></span><br><span class="line">	<span class="comment">/* schedulable entities of this group on each cpu */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> **<span class="title">se</span>;</span></span><br><span class="line">	<span class="comment">/* runqueue &quot;owned&quot; by this group on each cpu */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cfs_rq</span> **<span class="title">cfs_rq</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> shares;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">atomic_t</span> load_weight;</span><br><span class="line">	RH_KABI_DEPRECATE(<span class="keyword">atomic64_t</span>, load_avg)</span><br><span class="line">	RH_KABI_DEPRECATE(<span class="keyword">atomic_t</span>, runnable_avg)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RT_GROUP_SCHED</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> **<span class="title">rt_se</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span> **<span class="title">rt_rq</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rt_bandwidth</span> <span class="title">rt_bandwidth</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *<span class="title">parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">siblings</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SCHED_AUTOGROUP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">autogroup</span> *<span class="title">autogroup</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cfs_bandwidth</span> <span class="title">cfs_bandwidth</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FAIR_GROUP_SCHED)</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Put load_avg/runnable_avg in its own cacheline to avoid</span></span><br><span class="line"><span class="comment">	 * interfering with the other fields in this structure.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	RH_KABI_EXTEND(<span class="keyword">atomic64_t</span> load_avg ____cacheline_aligned_in_smp)</span><br><span class="line">	RH_KABI_EXTEND(<span class="keyword">atomic_t</span> runnable_avg)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FAIR_GROUP_SCHED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROOT_TASK_GROUP_LOAD	NICE_0_LOAD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A weight of 0 or 1 can cause arithmetics problems.</span></span><br><span class="line"><span class="comment"> * A weight of a cfs_rq is the sum of weights of which entities</span></span><br><span class="line"><span class="comment"> * are queued on this cfs_rq, so a weight of a entity should not be</span></span><br><span class="line"><span class="comment"> * too large, so as the shares value of a task group.</span></span><br><span class="line"><span class="comment"> * (The default weight is 1024 - so there&#x27;s no practical</span></span><br><span class="line"><span class="comment"> *  limitation from this.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_SHARES	(1UL &lt;&lt;  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SHARES	(1UL &lt;&lt; 18)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

### About loading avg
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/loadavg</span><br><span class="line">47.36 46.22 43.95 53/1682 249686</span><br><span class="line">                     |      |</span><br><span class="line">                     |      -------- the PID of the process that was most recently created on the system. </span><br><span class="line">                     --------------- it consists of two numbers separated by a slash (/)</span><br><span class="line">                                     The first of these is the number of currently runnable(active) kernel scheduling entities </span><br><span class="line">                                     (active task = nr_running + nr_uninterruptible, processes, threads) </span><br><span class="line">                                     The value after the slash is the number of kernel scheduling entities that currently exist on the system </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">/proc/loadavg</span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/fs/proc/loadavg.c</span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadavg_proc_show</span><span class="params">(struct seq_file *m, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">linux-3.10.0-1127.el7/include/linux/sched.h</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These are the constant used to fake the fixed-point load-average</span></span><br><span class="line"><span class="comment"> * counting. Some notes:</span></span><br><span class="line"><span class="comment"> *  - 11 bit fractions expand to 22 bits by the multiplies: this gives</span></span><br><span class="line"><span class="comment"> *    a load-average precision of 10 bits integer + 11 bits fractional</span></span><br><span class="line"><span class="comment"> *  - if you want to count load-averages more often, you need more</span></span><br><span class="line"><span class="comment"> *    precision, or rounding will get you. With 2-second counting freq,</span></span><br><span class="line"><span class="comment"> *    the EXP_n values would be 1981, 2034 and 2043 if still using only</span></span><br><span class="line"><span class="comment"> *    11 bit fractions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> avenrun[];         <span class="comment">/* Load averages */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">get_avenrun</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> *loads, <span class="keyword">unsigned</span> <span class="keyword">long</span> offset, <span class="keyword">int</span> shift)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FSHIFT          11              <span class="comment">/* nr of bits of precision */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIXED_1         (1&lt;&lt;FSHIFT)     <span class="comment">/* 1.0 as fixed-point */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOAD_FREQ       (5*HZ+1)        <span class="comment">/* 5 sec intervals */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_1           1884            <span class="comment">/* 1/exp(5sec/1min) as fixed-point */</span>  1mins weights</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_5           2014            <span class="comment">/* 1/exp(5sec/5min) */</span>    5 mins weights</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_15          2037            <span class="comment">/* 1/exp(5sec/15min) */</span>  15 mins weights</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CALC_LOAD(load,exp,n) \</span></span><br><span class="line">        load *= <span class="built_in">exp</span>; \</span><br><span class="line">        load += n*(FIXED_1-<span class="built_in">exp</span>); \</span><br><span class="line">        load &gt;&gt;= FSHIFT;</span><br><span class="line"></span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/kernel/sched/core.c</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * get_avenrun - get the load average array</span></span><br><span class="line"><span class="comment"> * @loads:      pointer to dest load array</span></span><br><span class="line"><span class="comment"> * @offset:     offset to add</span></span><br><span class="line"><span class="comment"> * @shift:      shift count to shift the result left</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These values are estimates at best, so no need for locking.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_avenrun</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> *loads, <span class="keyword">unsigned</span> <span class="keyword">long</span> offset, <span class="keyword">int</span> shift)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        loads[<span class="number">0</span>] = (avenrun[<span class="number">0</span>] + offset) &lt;&lt; shift;</span><br><span class="line">...</span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/kernel/sched/core.c</span><br><span class="line">  calc_global_load</span><br><span class="line">    calc_load - update the avenrun load estimates <span class="number">10</span> ticks after the CPUs have updated calc_load_tasks</span><br><span class="line">``` </span><br><span class="line">avenrun[<span class="number">0</span>]_&#123;t&#125; = frac&#123;load_&#123;t&#125; + load_&#123;t+<span class="number">5</span>&#125; + load_&#123;t+<span class="number">10</span>&#125; + <span class="string">&#x27;.&#x27;</span> + load_&#123;t+<span class="number">55</span>&#125;&#125;&#123;<span class="number">60</span> / <span class="number">5</span>&#125;</span><br><span class="line">avenrun[<span class="number">0</span>]_&#123;t+<span class="number">5</span>&#125; = avenrun[<span class="number">0</span>]_&#123;t&#125; - frac&#123;<span class="number">1</span>&#125;&#123;<span class="number">60</span> / <span class="number">5</span>&#125; times load_&#123;t&#125; + frac&#123;<span class="number">1</span>&#125;&#123;<span class="number">60</span> / <span class="number">5</span>&#125;times load_&#123;t+<span class="number">60</span>&#125;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">for</span> more loading avg1](https:<span class="comment">//blog.csdn.net/xiaoqiaoq0/article/details/106932338)</span></span><br><span class="line">[<span class="keyword">for</span> more loading avg2](http:<span class="comment">//brytonlee.github.io/blog/2014/05/07/linux-kernel-load-average-calc/)</span></span><br><span class="line">[<span class="keyword">for</span> more loading avg3](https:<span class="comment">//www.ffutop.com/posts/2019-09-16-load-average/)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### [Linux watchdog](https:<span class="comment">//blog.csdn.net/ericstarmars/article/details/81750919)</span></span><br><span class="line">The kernel code <span class="keyword">and</span> the SCHED_FIFO(pro=<span class="number">99</span>) process cause the lockup, <span class="keyword">and</span> the kernel preemption disabled</span><br><span class="line">- softlockup</span><br><span class="line">  - The kernel code <span class="keyword">not</span> release the CPU resource in the time interval</span><br><span class="line">  - [watchdog/<span class="number">0</span>] [watchdog/<span class="number">1</span>], it depends hrtimer interrupts could be responded</span><br><span class="line">- hardlockup</span><br><span class="line">  - It depends the NMI perf event of x86 PMU, CPU lockup <span class="keyword">and</span> <span class="keyword">not</span> respond the hrtimer interrupt</span><br><span class="line">  - NMI interrupt Watchdog</span><br><span class="line">- hardware watchdog</span><br><span class="line">  - systemctl start ipmidog</span><br><span class="line">  - You could custom the timeout action</span><br><span class="line">  - ipmitool mc watchdog get; /dev/watchdog</span><br><span class="line">- Intel TCO WatchDog Timer Driver</span><br><span class="line">  - lsmod | grep wdt</span><br><span class="line">- userspace watchdog</span><br><span class="line">  - /usr/sbin/watchdog</span><br><span class="line"></span><br><span class="line">### [lockdep](http:<span class="comment">//www.lenky.info/archives/2013/04/2253)</span></span><br><span class="line">CONFIG_LOCKDEP_SUPPORT=y</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> hardirq-safe lock is discovered, we check whether it took any hardirq-unsafe lock in the past.</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> softirq-safe lock is discovered, we check whether it took any softirq-unsafe lock in the past.</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> hardirq-unsafe lock is discovered, we check whether any hardirq-safe lock took it in the past.</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> softirq-unsafe lock is discovered, we check whether any softirq-safe lock took it in the past. </span><br><span class="line"></span><br><span class="line">### [IO type](https:<span class="comment">//lzz5235.github.io/2015/08/25/block.html)</span></span><br><span class="line">- Synchronous blocking (normal)</span><br><span class="line">```c</span><br><span class="line"><span class="keyword">char</span> buf;</span><br><span class="line">fd = open(<span class="string">&quot;/dev/ttyS1&quot;</span>,O_RDWR);</span><br><span class="line">...</span><br><span class="line">res = read(fd,&amp;buf,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;%c\n&quot;</span>,buf);</span><br></pre></td></tr></table></figure>
- Synchronous non-blocking (intel loved)
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf;</span><br><span class="line">fd = open(<span class="string">&quot;/dev/ttyS1&quot;</span>,O_RDWR | O_NONBLOCK);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">while</span>(read(fd,&amp;buf,<span class="number">1</span>)!= <span class="number">1</span>)</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;%c\n&quot;</span>,buf);</span><br></pre></td></tr></table></figure>
- Asynchronous blocking
- Asynchronous non-blocking (AIO)
   - 异步通知的全程是“信号驱动的异步I/O”，也就是说一旦设备准备就绪，主动通知应用程序，这样应用程序根本就不需要查询设备状态。
   - O_ASYNC
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; sys/types.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; sys/stat.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; stdio.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; fcntl.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; signal.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; unistd.h &gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LEN 100</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">input_handler</span><span class="params">(<span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> data[MAX_LEN];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line"> </span><br><span class="line">        len = read(STDIN_FILENO,&amp;data,MAX_LEN);</span><br><span class="line">        data[len] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;input:%s\n&quot;</span>,data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> oflags;</span><br><span class="line">        signal(SIGIO,input_handler);</span><br><span class="line">        fcntl(STDIN_FILENO,F_SETOWN,getpid());</span><br><span class="line">        oflags = fcntl(STDIN_FILENO,F_GETFL);</span><br><span class="line">        fcntl(STDIN_FILENO,F_SETFL,oflags | O_ASYNC);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### [DynTicks](http://www.lenky.info/archives/2013/07/2317)
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NO_HZ_COMMON=y</span><br><span class="line"><span class="comment"># CONFIG_HZ_PERIODIC is not set</span></span><br><span class="line"><span class="comment"># CONFIG_NO_HZ_IDLE is not set</span></span><br><span class="line">CONFIG_NO_HZ_FULL=y</span><br><span class="line"><span class="comment"># CONFIG_NO_HZ_FULL_ALL is not set</span></span><br><span class="line">CONFIG_NO_HZ=y</span><br><span class="line"><span class="comment"># CONFIG_RCU_FAST_NO_HZ is not set</span></span><br><span class="line"><span class="comment"># CONFIG_HZ_100 is not set</span></span><br><span class="line"><span class="comment"># CONFIG_HZ_250 is not set</span></span><br><span class="line"><span class="comment"># CONFIG_HZ_300 is not set</span></span><br><span class="line">CONFIG_HZ_1000=y</span><br><span class="line">CONFIG_HZ=1000</span><br></pre></td></tr></table></figure>
- DynTicks, NOHZ, tickless
  - reduce overhead, better performance
http://www.wowotech.net/timer_subsystem/tick-device-layer.html

### [rpm spec](https://www.golinuxhub.com/2018/05/how-to-execute-script-at-pre-post-preun-postun-spec-file-rpm/)
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">$ rpm --<span class="built_in">eval</span> <span class="string">&quot;%&#123;_usr&#125;&quot;</span></span><br><span class="line">/usr</span><br><span class="line"></span><br><span class="line">$ rpm --<span class="built_in">eval</span> <span class="string">&quot;%&#123;_libdir&#125;&quot;</span></span><br><span class="line">/usr/lib64</span><br><span class="line"></span><br><span class="line"><span class="comment">#modify /usr/lib/rpm/macros from lib64 to lib</span></span><br><span class="line"><span class="comment">#%_lib                   lib64</span></span><br><span class="line">%_lib                   lib</span><br><span class="line">%_libdir                %&#123;_exec_prefix&#125;/%&#123;_lib&#125;</span><br><span class="line"></span><br><span class="line">$ rpm --<span class="built_in">eval</span> <span class="string">&quot;%&#123;_libdir&#125;&quot;</span></span><br><span class="line">/usr/lib</span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is pre&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line">%post</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is post&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"></span><br><span class="line">%preun</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is preun&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"></span><br><span class="line">%postun</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is postun&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -ivh /tmp/rpmbuild/RPMS/x86_64/deepak-1.0.0-1.x86_64.rpm</span></span><br><span class="line">Preparing...                          <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is pre</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:deepak-1.0.0-1                   <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is post</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -Uvh /tmp/rpmbuild/RPMS/x86_64/deepak-2.0.0-1.x86_64.rpm</span></span><br><span class="line">Preparing...                          <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is pre</span><br><span class="line">Install Value: 2</span><br><span class="line">Upgrade Value: 2</span><br><span class="line">Uninstall Value: 2</span><br><span class="line">-------------</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:deepak-2.0.0-1                   <span class="comment">################################# [ 50%]</span></span><br><span class="line">-------------</span><br><span class="line">This is post</span><br><span class="line">Install Value: 2</span><br><span class="line">Upgrade Value: 2</span><br><span class="line">Uninstall Value: 2</span><br><span class="line">-------------</span><br><span class="line">-------------</span><br><span class="line">This is preun</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line">Cleaning up / removing...</span><br><span class="line">   2:deepak-1.0.0-1                   <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is postun</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -e deepak</span></span><br><span class="line">-------------</span><br><span class="line">This is preun</span><br><span class="line">Install Value: 0</span><br><span class="line">Upgrade Value: 0</span><br><span class="line">Uninstall Value: 0</span><br><span class="line">-------------</span><br><span class="line">-------------</span><br><span class="line">This is postun</span><br><span class="line">Install Value: 0</span><br><span class="line">Upgrade Value: 0</span><br><span class="line">Uninstall Value: 0</span><br><span class="line">-------------</span><br></pre></td></tr></table></figure>

### Patch kernel
[patch](http://bbs.chinaunix.net/thread-2230170-1-1.html)  
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-p[n] 的 n 值, 只要取消多少條 / 及其左邊的路逕</span><br><span class="line">以 <span class="regexp">/usr/</span>src/linux 為例,</span><br><span class="line">若 -p0 就是不取消任何路經</span><br><span class="line">-p1 則將 <span class="regexp">/ 取消, 得 usr/</span>src/linux</span><br><span class="line">-p2 則是將 <span class="regexp">/usr/</span> 取消, 得 src/linux</span><br><span class="line">再以 src/linux 為例:</span><br><span class="line">-p0 依然為 src/linux</span><br><span class="line">-p1 則為 linux</span><br></pre></td></tr></table></figure>

#### patch the kernel
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.10.tar.xz</span><br><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/patch-5.10.22.xz    <span class="comment">## size: 718K</span></span><br><span class="line"><span class="comment">## it &#x27;s the full patch from 5.10, not incr</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> linux-5.10</span><br><span class="line">$ patch -p1 --dry-run &lt; ../patch-5.10.22</span><br><span class="line"><span class="comment">### from 5.10 direct to 5.10.22</span></span><br><span class="line">$ patch -p1 &lt; ../path-5.10.22</span><br><span class="line">$ patch -p1 -R &lt; ../path-5.10.22</span><br><span class="line"></span><br><span class="line"><span class="comment">### from 5.10.21 to 5.10.22</span></span><br><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.10.21.tar.xz</span><br><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/incr/patch-5.10.21-22.xz <span class="comment">## incr size: 15K</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> linux-5.10.21</span><br><span class="line">$ patch -p1 --dry-run &lt; ../patch-5.10.21-22</span><br><span class="line">...</span><br><span class="line">checking file security/tomoyo/network.c</span><br><span class="line">checking file sound/hda/intel-nhlt.c</span><br><span class="line">checking file sound/pci/ctxfi/cthw20k2.c</span><br><span class="line">checking file sound/pci/hda/patch_realtek.c</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 6406 (offset -2 lines).</span></span><br><span class="line">Hunk <span class="comment">#2 succeeded at 7854 (offset -11 lines).</span></span><br><span class="line">Hunk <span class="comment">#3 succeeded at 7890 (offset -11 lines).</span></span><br><span class="line">checking file sound/usb/mixer.c</span><br><span class="line">checking file sound/usb/mixer_maps.c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ tail -n 100 ../patch-5.10.21-22</span><br><span class="line">.....</span><br><span class="line">diff --git a/sound/usb/mixer_maps.c b/sound/usb/mixer_maps.c</span><br><span class="line">index a7212f16660ec..646deb6244b15 100644</span><br><span class="line">--- a/sound/usb/mixer_maps.c</span><br><span class="line">+++ b/sound/usb/mixer_maps.c</span><br><span class="line">@@ -536,6 +536,16 @@ static const struct usbmix_ctl_map usbmix_ctl_maps[] = &#123;</span><br><span class="line">                .id = USB_ID(0x05a7, 0x1020),</span><br><span class="line">                .map = bose_companion5_map,</span><br><span class="line">        &#125;,</span><br><span class="line">+       &#123;</span><br><span class="line">+               /* Corsair Virtuoso SE (wired mode) */</span><br><span class="line">+               .id = USB_ID(0x1b1c, 0x0a3d),</span><br><span class="line">+               .map = corsair_virtuoso_map,</span><br><span class="line">+       &#125;,</span><br><span class="line">+       &#123;</span><br><span class="line">+               /* Corsair Virtuoso SE (wireless mode) */</span><br><span class="line">+               .id = USB_ID(0x1b1c, 0x0a3e),</span><br><span class="line">+               .map = corsair_virtuoso_map,</span><br><span class="line">+       &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                /* Corsair Virtuoso (wired mode) */</span><br><span class="line">                .id = USB_ID(0x1b1c, 0x0a41),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$  grep -A 6 <span class="string">&quot;USB_ID(0x05a7, 0x1020)&quot;</span> sound/usb/mixer_maps.c</span><br><span class="line">		.id = USB_ID(0x05a7, 0x1020),</span><br><span class="line">		.map = bose_companion5_map,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		/* Corsair Virtuoso (wired mode) */  </span><br><span class="line">		.id = USB_ID(0x1b1c, 0x0a41),</span><br><span class="line">		.map = corsair_virtuoso_map,</span><br><span class="line"></span><br><span class="line">$  patch -p1 &lt; ../patch-5.10.21-22</span><br><span class="line"></span><br><span class="line">$  grep -A 6 <span class="string">&quot;USB_ID(0x05a7, 0x1020)&quot;</span> sound/usb/mixer_maps.c</span><br><span class="line">		.id = USB_ID(0x05a7, 0x1020),</span><br><span class="line">		.map = bose_companion5_map,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		/* Corsair Virtuoso SE (wired mode) */  <span class="comment">### Add Virtuoso SE </span></span><br><span class="line">		.id = USB_ID(0x1b1c, 0x0a3d),</span><br><span class="line">		.map = corsair_virtuoso_map,</span><br></pre></td></tr></table></figure>

#### [gen the patch, if you modify the kernel source](https://lzz5235.github.io/2015/09/01/kernelpatch.html)
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ diff -urN arch/x86/include/ ../linux-5.10.21/arch/x86/include/ &gt; patch-5.10.21-update</span><br><span class="line">or </span><br><span class="line">$ <span class="built_in">echo</span> patch1 &gt;&gt; patch2</span><br></pre></td></tr></table></figure>
### compile linux kernel
For debug
You could disable randomize the address of the kernel image (KASLR)
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_RANDOMIZE_BASE</span>=n</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">$ dnf install nss nss-devel nspr nspr-devel file file-devel popt popt-devel libdb-devel libdb lua lua-devel libdb-devel libdb-cxx-devel libarchive-devel lua-devel redhat-rpm-config  rpmdevtools dwarves perl-ExtUtils-Embed asciidoc newt-devel xmlto audit-libs-devel libcap-devel numactl-devel slang-devel  pciutils-devel binutils-devel kernel-rpm-macros ncurses-devel elfutils-libelf-devel openssl-devel libgcrypt-devel  popt-devel lzo-devel lz4-devel</span><br><span class="line">$ cp /boot/config-4.18.0-240.el8.x86_64 .config</span><br><span class="line">$ vi scripts/package/mkspec  </span><br><span class="line"><span class="comment">## replace the line  %define debug_package %&#123;nil&#125; to %define with_debuginfo</span></span><br><span class="line">        %define __spec_install_post /usr/lib/rpm/brp-compress || :</span><br><span class="line">        %define with_debug 0</span><br><span class="line">        %define _enable_debug_packages 0</span><br><span class="line">        %define debuginfodir /usr/lib/debug <span class="comment">## not working</span></span><br><span class="line"></span><br><span class="line">try to</span><br><span class="line">        MAKE=<span class="string">&quot;<span class="variable">$MAKE</span> -j 8 -f <span class="variable">$srctree</span>/Makefile&quot;</span></span><br><span class="line">%build</span><br><span class="line">MAKE=<span class="string">&quot;<span class="variable">$MAKE</span> -j 8 -f <span class="variable">$srctree</span>/Makefile&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### update dwarves-1.20</span></span><br><span class="line">$ dnf install cmake elfutils-devel elfutils-libs libbpf libdwarf</span><br><span class="line">$ </span><br><span class="line"></span><br><span class="line">$ vi .config</span><br><span class="line"><span class="comment">#CONFIG_MODULE_SIG_KEY=&quot;certs/signing_key.pem&quot;</span></span><br><span class="line"><span class="comment">#CONFIG_SYSTEM_TRUSTED_KEYRING=n</span></span><br><span class="line"><span class="comment">#CONFIG_SYSTEM_TRUSTED_KEYS=&quot;certs/rhel.pem&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## at the last</span></span><br><span class="line">$ make menuconfig <span class="comment"># just save once, no many question</span></span><br><span class="line">Add <span class="built_in">enable</span> the compressed cache <span class="keyword">for</span> swap page by default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## rebuild rpm</span></span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure --prefix=/opt/rpm-4.16.1.3</span><br><span class="line">$ make -j 8</span><br><span class="line"></span><br><span class="line">$ make <span class="built_in">help</span></span><br><span class="line">$ make vmlinux -j 8</span><br><span class="line">$ make bzImage</span><br><span class="line">$ make modules -j 8</span><br><span class="line">$ make modules_install -j 8</span><br><span class="line">$ make install -j 8</span><br><span class="line">$ dracut -f /boot/initramfs-5.10.41.el8.x86_64.img 5.10.41 <span class="comment">#default path is /lib/modules</span></span><br><span class="line">$ make install</span><br><span class="line">$ grubby --set-default /boot/vmlinuz-5.10.41</span><br><span class="line">$ grubby --info=ALL</span><br><span class="line">or</span><br><span class="line">$ grub2-set-default 0  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="comment"># mrproper clean all</span></span><br><span class="line">$ sudo make mrproper</span><br><span class="line">$ sudo make clean</span><br><span class="line"></span><br><span class="line"><span class="comment">## contine complie kernel</span></span><br><span class="line">Add env to bashrc</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/opt/rpm-4.16.1.3/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=/opt/rpm-4.16.1.3/bin:<span class="variable">$PATH</span></span><br><span class="line">$ make rpm-pkg</span><br><span class="line"><span class="comment">## make kernel tools</span></span><br><span class="line">$ make -C tools/testing/selftests TARGETS=dma run_tests</span><br><span class="line">$ ls tools/testing/selftests | grep dma_map_benchmark</span><br><span class="line"><span class="comment">## bind driver or you could not bind too</span></span><br><span class="line">$ <span class="built_in">echo</span> dma_map_benchmark &gt; /sys/bus/pci/devices/0000:00:01.0/driver_override</span><br><span class="line">$ <span class="built_in">echo</span> 0000:00:01.0 &gt; /sys/bus/pci/drivers/xxx/unbind</span><br><span class="line">$ <span class="built_in">echo</span> 0000:00:01.0 &gt; /sys/bus/pci/drivers/dma_map_benchmark/<span class="built_in">bind</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">$ dma_map_benchmark -s 120 -t 16</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --remove-args=<span class="string">&quot;crashkernel=256M@16M&quot;</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;crashkernel=384M-2G:64M,2G-:128M&quot;</span></span><br></pre></td></tr></table></figure>

install crash-7.3.0  
copy the gdb-7.6.0.tar.gz to the source code dir  

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make lzo</span><br></pre></td></tr></table></figure>

### setcap - set file capabilities

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wireshark work for non-root user</span></span><br><span class="line">$ <span class="built_in">setcap</span> <span class="string">&#x27;CAP_NET_RAW+eip CAP_NET_ADMIN+eip&#x27;</span> /usr/sbin/dumpcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># set uid</span></span><br><span class="line">$ chmod u+s /path/to/application </span><br><span class="line"></span><br><span class="line"><span class="comment"># use ping</span></span><br><span class="line">$ <span class="built_in">setcap</span> <span class="string">&#x27;cap_net_admin,cap_net_raw+ep&#x27;</span> /bin/ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear</span></span><br><span class="line">$ <span class="built_in">setcap</span> -r /bin/ping</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">setcap</span> cap_net_bind_service=+eip /opt/openport_under1024.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## found all setcap files</span></span><br><span class="line">$ <span class="built_in">getcap</span> -r  /  </span><br><span class="line"></span><br><span class="line">$ chmod u+s /bin/vi</span><br><span class="line">$ find /bin -perm -u=s -<span class="built_in">type</span> f </span><br><span class="line"></span><br><span class="line"><span class="comment">### if you set CAP_SETUID cause python switch to root shell</span></span><br><span class="line"><span class="comment"># ALL the capabilites permitted (p) and effective (e) </span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">setcap</span> CAP_SETUID+ep /usr/bin/python</span><br><span class="line">$ python -c <span class="string">&#x27;import os;os.setuid(0);os.system(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>

### windows
#### terminal
change the colorScheme in json config
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">                <span class="attr">&quot;guid&quot;</span>: <span class="string">&quot;&#123;58ad8b0c-3ef8-5f4d-bc6f-13e4c00f2530&#125;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;hidden&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Debian&quot;</span>,</span><br><span class="line">                &quot;colorScheme&quot;: &quot;One Half Dark&quot;,  &lt;-------- add this line</span><br><span class="line">                &quot;source&quot;: &quot;Windows.Terminal.Wsl&quot;          </span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

### aws command
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.0.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.1.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.2.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.3.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.4.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.5.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.6.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.7.0</span><br></pre></td></tr></table></figure>

### [rclone](https://bruxy.regnet.cz/web/linux/EN/rsync-rclone/)
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat ~/.config/rclone/rclone.conf</span><br><span class="line">[remote_server]</span><br><span class="line"><span class="built_in">type</span> = sftp</span><br><span class="line">host = 172.102.0.123</span><br><span class="line">user = bruxy</span><br><span class="line">key_file = /home/bruxy/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line">$ rclone -v sync <span class="built_in">source</span>/directory/ remote_server:/destination/directory/</span><br></pre></td></tr></table></figure>

### interrput the tcp link
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tcpkill -i eth0 host 192.168.0.1</span><br><span class="line">$ ss -K dst 192.168.0.1 dport = 2049</span><br><span class="line">$ iptables -A INPUT -p tcp -m tcp --dport 2049 -j REJECT --reject-with tcp-reset</span><br></pre></td></tr></table></figure>

### bash history
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HISTSIZE=10000</span><br><span class="line"><span class="built_in">export</span> HISTFILESIZE=100000</span><br></pre></td></tr></table></figure>

### delete file by inode
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . -inum [inode-number] -<span class="built_in">exec</span> rm -i &#123;&#125; \;</span><br></pre></td></tr></table></figure>

### got the node ip addr
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip r g 1.1.1.1 | awk <span class="string">&#x27;/src/&#123;print $NF&#125;&#x27;</span></span><br><span class="line">$ ip r g 1.1.1.1 | awk <span class="string">&#x27;/src/&#123;print $(NF-2)&quot;_&quot;$NF&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

### route info
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl net.ipv&#123;4,6&#125;.route.max_size</span><br><span class="line">$ ip route show table all</span><br><span class="line">$ ip route show cache</span><br><span class="line">$ ip -6 route show cache</span><br></pre></td></tr></table></figure>

### C LANG
[C symbol](https://www.runoob.com/cprogramming/c-operators.html)
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TMOD |= <span class="number">0x20</span>; (<span class="number">0x20</span>= <span class="number">32</span>=<span class="number">100000</span>, 按位或 C |= <span class="number">2</span> 等同于 C = C | <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

C if
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(x) = <span class="keyword">if</span>(x != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>(x != <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span>) = <span class="keyword">if</span>(<span class="number">1</span> != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span> != <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

### java parameters
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ jmap -J-d64 -dump:format=b,file=dump.bin PID</span><br><span class="line">$ jstat -gcold</span><br><span class="line">$ jstat -gcnew [pid]</span><br><span class="line">$ jstat -gc [pid]</span><br><span class="line">$ jmap -histo [pid]</span><br><span class="line">-XX:+HeapDumpOnOutOfMemeryError</span><br><span class="line">-XX:HeapDumpPath=/home/logs -Xloggc:/home/<span class="built_in">log</span>/gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps</span><br><span class="line">-server -Xms4000m -Xmx4000m -Xmn1500m -Xss256k -XX:PermSize=340m -XX:MaxPermSize=340m -XX:+UseConcMarkSweepGC</span><br><span class="line">XX:+DisableAttachMechanism</span><br><span class="line"></span><br><span class="line"><span class="comment">## java temp file</span></span><br><span class="line">/tmp/.java_pid217893</span><br><span class="line">/tmp/hsperfdata_yourname</span><br></pre></td></tr></table></figure>

### ISO
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### this function</span></span><br><span class="line">$ mkisofs -J -l -R -V <span class="string">&quot;Label CD&quot;</span> -iso-level 4 -o output.iso input_directory</span><br></pre></td></tr></table></figure>

### linux services
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sadc - System activity data collector.</span><br></pre></td></tr></table></figure>

### [intel boot agent message](https://www.supermicro.com/wdl/ISO_Extracted/CDR-APLUS2_2.02_for_A+_AMD_SP5100_platform/Intel/LAN/v18.0.1/APPS/BOOTAGNT/DOCS/ba_msgs.htm)
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## uefi set bootutil64e</span></span><br><span class="line">FS0:\&gt;bootutil64e -up=efi -all</span><br></pre></td></tr></table></figure></code></pre>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">寸劲</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/07/18/centos/">http://yoursite.com/2019/07/18/centos/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/centos/">centos</a></div><div class="post_share"><div class="social-share" data-image="https://homerl.github.io/img/operting_system_a32c6f.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/10/10/golang/"><img class="prev-cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">golang</div></div></a></div><div class="next-post pull-right"><a href="/2019/07/18/ubuntu/"><img class="next-cover" src="https://homerl.github.io/img/operting_system_a32c6f.svg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">ubuntu</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2021 By 寸劲</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '0b9d5b98d0a972b33cf7',
      clientSecret: '769efc11b32f6c0d03bcbf3ee800dfc4e2690459',
      repo: 'homerl.github.io',
      owner: 'homerl',
      admin: ['homerl'],
      id: '35e7a85fd9d838d3cbc4dd6b66c05120',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>