<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>TCP | 己不由心，身又岂能由己</title><meta name="keywords" content="network,tcp"><meta name="author" content="Ginger"><meta name="copyright" content="Ginger"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="TCP timerRTT three typesMeasured RTT(RTTm) – The measured round-trip time for a segment is the time required for the segment to reach the destination and be acknowledged, although the acknowledgment">
<meta property="og:type" content="article">
<meta property="og:title" content="TCP">
<meta property="og:url" content="http://yoursite.com/2017/01/08/tcp/index.html">
<meta property="og:site_name" content="己不由心，身又岂能由己">
<meta property="og:description" content="TCP timerRTT three typesMeasured RTT(RTTm) – The measured round-trip time for a segment is the time required for the segment to reach the destination and be acknowledged, although the acknowledgment">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg">
<meta property="article:published_time" content="2017-01-08T15:26:29.000Z">
<meta property="article:modified_time" content="2020-10-11T09:53:59.771Z">
<meta property="article:author" content="Ginger">
<meta property="article:tag" content="network">
<meta property="article:tag" content="tcp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg"><link rel="shortcut icon" href="/img/stout-shield.png"><link rel="canonical" href="http://yoursite.com/2017/01/08/tcp/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-10-11 17:53:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/huohuan.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">58</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-timer"><span class="toc-number">1.</span> <span class="toc-text">TCP timer</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#RTT-three-types"><span class="toc-number">1.1.</span> <span class="toc-text">RTT three types</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Retransmission-Timeout"><span class="toc-number">1.2.</span> <span class="toc-text">Retransmission Timeout</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Delayed-ACK-Timer"><span class="toc-number">1.3.</span> <span class="toc-text">Delayed ACK Timer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Persist-Timer"><span class="toc-number">1.4.</span> <span class="toc-text">Persist Timer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Keepalive-Timer"><span class="toc-number">1.5.</span> <span class="toc-text">Keepalive Timer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#FIN-WAIT-2-Timer"><span class="toc-number">1.6.</span> <span class="toc-text">FIN_WAIT_2 Timer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TIME-WAIT-Timer"><span class="toc-number">1.7.</span> <span class="toc-text">TIME_WAIT Timer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-kernel"><span class="toc-number"></span> <span class="toc-text">Linux kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tcp-tw-reuse"><span class="toc-number">1.</span> <span class="toc-text">tcp_tw_reuse</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ethtool"><span class="toc-number"></span> <span class="toc-text">ethtool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SLE-and-SER-in-SACK-RFC2018"><span class="toc-number"></span> <span class="toc-text">SLE and SER in SACK(RFC2018)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spurious-retransmission-timeouts"><span class="toc-number"></span> <span class="toc-text">Spurious retransmission timeouts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thin-stream"><span class="toc-number"></span> <span class="toc-text">Thin-stream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-retrans"><span class="toc-number"></span> <span class="toc-text">tcp retrans</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-retrans-1"><span class="toc-number"></span> <span class="toc-text">tcp retrans</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Make-sure-retrans-type"><span class="toc-number">1.</span> <span class="toc-text">Make sure retrans type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Analysis-wireshark-log"><span class="toc-number">2.</span> <span class="toc-text">Analysis wireshark log</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcpdump-802-3-header"><span class="toc-number"></span> <span class="toc-text">tcpdump 802.3 header</span></a></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://homerl.github.io/img/operting_system_a32c6f.svg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">己不由心，身又岂能由己</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">TCP</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2017-01-08T15:26:29.000Z" title="Created 2017-01-08 23:26:29">2017-01-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-10-11T09:53:59.771Z" title="Updated 2020-10-11 17:53:59">2020-10-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/OS/">OS</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><a href="/img/Tcp_state_diagram.png"></a></p>
<h4 id="TCP-timer"><a href="#TCP-timer" class="headerlink" title="TCP timer"></a><a target="_blank" rel="noopener" href="http://blog.qiusuo.im/blog/2014/03/19/tcp-timeout/">TCP timer</a></h4><h5 id="RTT-three-types"><a href="#RTT-three-types" class="headerlink" title="RTT three types"></a><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/tcp-timers/">RTT three types</a></h5><p>Measured RTT(RTTm) – The measured round-trip time for a segment is the time required for the segment to reach the destination and be acknowledged, although the acknowledgment may include other segments.</p>
<p>Smoothed RTT(RTTs) – It is the weighted average of RTTm. RTTm is likely to change and its fluctuation is so high that a single measurement cannot be used to calculate RTO.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Initially -&gt; No value</span><br><span class="line">After the first measurement -&gt; RTTs=RTTm</span><br><span class="line">After each measurement -&gt; RTTs= (1-t)*RTTs + t*RTTm</span><br><span class="line">Note: t=1/8 (default <span class="keyword">if</span> not given)</span><br></pre></td></tr></table></figure>

<p>Deviated RTT(RTTd) – Most implementation do not use RTTs alone so RTT deviated is also calculated to find out RTO.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Initially</span> -&gt; <span class="keyword">No</span> <span class="keyword">value</span></span><br><span class="line"><span class="keyword">After</span> the first measurement -&gt; RTTd=RTTm/<span class="number">2</span></span><br><span class="line"><span class="keyword">After</span> <span class="keyword">each</span> measurement -&gt; RTTd= (<span class="number">1</span>-k)*RTTd + k*(RTTm-RTTs)</span><br><span class="line">Note: k=<span class="number">1</span>/<span class="number">4</span> (<span class="keyword">default</span> <span class="keyword">if</span> <span class="keyword">not</span> given)</span><br></pre></td></tr></table></figure>

<h5 id="Retransmission-Timeout"><a href="#Retransmission-Timeout" class="headerlink" title="Retransmission Timeout"></a>Retransmission Timeout</h5><p>RTO calculation – The value of RTO is based on the smoothed round-trip time and its deviation. Most implementations use the following formula to calculate the RTO:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Initial value -&gt; Original (given <span class="keyword">in</span> question)</span><br><span class="line">After any measurement -&gt; <span class="attribute">RTO</span>=RTTs + 4*RTTd</span><br><span class="line"><span class="comment">#<span class="doctag">NOTE:</span> At every retransmission the value of RTO doubles. ( RTO(new) = RTO(before retransmission) *2 ) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## in linux</span></span><br><span class="line">tcp_retries1 (integer; default: 3; since Linux 2.2)</span><br><span class="line"></span><br><span class="line">The number of times TCP will attempt <span class="keyword">to</span> retransmit a packet on an established<span class="built_in"> connection </span>normally, without the extra effort of getting the<span class="built_in"> network </span>layers involved. Once we exceed this number of retransmits, we first have the<span class="built_in"> network </span>layer update the<span class="built_in"> route </span><span class="keyword">if</span> possible before each new retransmit. The<span class="built_in"> default </span>is the RFC specified minimum of 3.</span><br><span class="line"></span><br><span class="line">tcp_retries2 (integer; default: 15; since Linux 2.2)</span><br><span class="line"></span><br><span class="line">The maximum number of times a TCP packet is retransmitted <span class="keyword">in</span> established state before giving up. The<span class="built_in"> default </span>value is 15, which corresponds <span class="keyword">to</span> a duration of approxi‐mately between 13 <span class="keyword">to</span> 30 minutes, depending on the retransmission timeout. The RFC 1122 specified minimum limit of 100 seconds is typically deemed too short.</span><br></pre></td></tr></table></figure>

<h5 id="Delayed-ACK-Timer"><a href="#Delayed-ACK-Timer" class="headerlink" title="Delayed ACK Timer"></a>Delayed ACK Timer</h5><p>If reach the timeout, reply the ACK, if in the timeout range, it will wait data to transmit, 200 ms in Microsoft Windows by default</p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/reducing_the_tcp_delayed_ack_timeout">In real time system</a></p>
<ul>
<li>This mode is used at the start of a TCP connection so that the congestion window can grow quickly.</li>
<li>The acknowledgment (ACK) timeout interval (ATO) is set to tcp_ato_min, the minimum timeout value.</li>
<li>To change the default TCP ACK timeout value, write the required value in milliseconds to the /proc/sys/net/ipv4/tcp_ato_min file<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo <span class="number">4</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4/tcp_ato_min</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>Delayed ACK</p>
<ul>
<li>After the connection is established, TCP assumes this mode, in which ACKs for multiple received packets can be sent in a single packet.</li>
<li>ATO is set to tcp_delack_min to restart or reset the timer.</li>
<li>To change the default TCP Delayed ACK value, write the required value in milliseconds to the /proc/sys/net/ipv4/tcp_delack_min file:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 4 &gt; /proc/sys/net/ipv4/tcp_delack_min</span><br></pre></td></tr></table></figure>
TCP switches between the two modes depending on the current congestion.<br>Some applications that send small network packets could experience latencies due to the TCP quick and delayed acknowledgment timeouts, which previously were 40 ms by default. That means small packets from an application that seldom sends information through the network could experience a delay up to 40 ms to receive the acknowledgment that a packet has been received by the other side. To minimize this issue, both tcp_ato_min and tcp_delack_min timeouts are now 4 ms by default.</li>
</ul>
<h5 id="Persist-Timer"><a href="#Persist-Timer" class="headerlink" title="Persist Timer"></a>Persist Timer</h5><p>When receive the zero window, stop to transmit data.<br>In tcp, just confirm data package, it ‘s not confirm the ack (no data) package. if the B transmit the ack(no data) loss, the B is waitting to get some data from A(the ack loss, and it tell A that it ‘s not the zero window ),but the A is waitting the data for update window size from B. It ‘s the deadlock case.<br>When the A receive the zero window notice, the A will start a persist timer to send the ack in the time interval. the segment to detect TCP Zero Window</p>
<p>The RFC1122 suggest the window probe timer is RTO</p>
<h5 id="Keepalive-Timer"><a href="#Keepalive-Timer" class="headerlink" title="Keepalive Timer"></a>Keepalive Timer</h5><p>In the tcp_keepalive_intvl, the server will send the Probe Segment to make sure the other side is online ? if no respond, it will resend until timeout, if timeout that means the other side has crash.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tcp_keepalive_intvl (<span class="built_in">integer</span>; default: 75; since Linux 2.4)</span><br><span class="line">The number of seconds between TCP keep-alive probes.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_probes (<span class="built_in">integer</span>; default: 9; since Linux 2.2)</span><br><span class="line">The maximum number of TCP keep-alive probes to send before giving up and killing the connection <span class="keyword">if</span> no response is obtained from the other end.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_time (<span class="built_in">integer</span>; default: 7200; since Linux 2.2)</span><br><span class="line">The number of seconds a connection needs to be idle before TCP begins sending out keep-alive probes. Keep-alives are only sent when the SO_KEEPALIVE socket option is enabled. The default value is 7200 seconds (2 hours). An idle connection is terminated after approximately an additional 11 minutes (9 probes an interval of 75 sec‐onds apart) when keep-alive is enabled.</span><br></pre></td></tr></table></figure>

<h5 id="FIN-WAIT-2-Timer"><a href="#FIN-WAIT-2-Timer" class="headerlink" title="FIN_WAIT_2 Timer"></a>FIN_WAIT_2 Timer</h5><p>The activer try to disable the tcp connection, send the FIN and get the ACK, the activer to convert the FIN_WAIT_1 to FIN_WAIT_2 and it could not send any data, just wait the FIN from the client. if the client down or don’t send the FIN to the activer, same with Dos attack.<br>If timeout, give up the tcp connection.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcp_fin_timeout (<span class="built_in">integer</span>; default: 60; since Linux 2.2)</span><br><span class="line">This specifies how many seconds to <span class="built_in">wait</span> <span class="keyword">for</span> a final FIN packet before the socket is forcibly closed. This is strictly a violation of the TCP specification, but required to prevent denial-of-service attacks. In Linux 2.2, the default value was 180.</span><br></pre></td></tr></table></figure>

<h5 id="TIME-WAIT-Timer"><a href="#TIME-WAIT-Timer" class="headerlink" title="TIME_WAIT Timer"></a>TIME_WAIT Timer</h5><p>timeout = 2xMSL<br>Linux was net.ipv4.tcp_fin_timeout = 60</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCP_TIMEWAIT_LEN (60*HZ) <span class="comment">/* how long to wait to destroy TIME-WAIT</span></span></span><br><span class="line"><span class="meta"><span class="comment">                              * state, about 60 seconds     */</span></span></span><br></pre></td></tr></table></figure>

<p>the server(FIN_WAIT_2) receive the FIN from the client, after the server reply the ACK,the server will convert FIN_WAIT_2 to TIME_WAIT and start the TIME_WAIT timer<br>and the ack loss, when the client will retrans the FIN to the server. </p>
<ol>
<li><p>if the server not in TIME_WAIT, if the port re-use for another application, maybe the application will go to the wrong state. if the connection in the TIME_WAIT state, it ‘s OK.<br>So the TIME_WAIT must be a long time enough, to avoid the wandering duplicates</p>
</li>
<li><p>because the ack package loss, if the activer has disable the A tcp connection, the client is waitting the ack. if the activer want create a new tcp connection to use the same port, the activer will send the SYN packet, the client is waitting the ack, the client will reply the RST cause the new connection interrupt </p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">When the persist timer expires, 1 byte of data is sent(segment 6). The receiving application has <span class="built_in">read</span> 256 bytes from the receivebuffer (at time 3.99), so the byte is accepted and acknowledged (segment 7).But the advertised window is still 0, since the receiver does not have room foreither one full-sized segment or one-half of its buffer. This is silly windowavoidance by the receiver.</span><br><span class="line"></span><br><span class="line">tcp_rcv_state_process</span><br><span class="line">    |--&gt;tcp_time_wait</span><br><span class="line">           |--&gt;inet_twsk_alloc</span><br><span class="line">           |      |--&gt;setup_pinned_timer(&amp;tw-&gt;tw_timer, tw_timer_handler,(unsigned long)tw);</span><br><span class="line">           |--&gt;__inet_twsk_schedule(tw, timeo, <span class="literal">false</span>);</span><br><span class="line">                  |--&gt;mod_timer(&amp;tw-&gt;tw_timer, jiffies + timeo);</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"><span class="comment"># TIME_WAIT port use the new tcp connection</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line"><span class="comment"># In some NAT/loading balancing env cause DROP the SYN packet and reply the RST</span></span><br><span class="line"><span class="comment"># remove from linux kernel 4.10</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_fin_timeout = 60</span><br><span class="line">net.ipv4.ip_local_port_range = 32768 60999</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000</span><br><span class="line"><span class="comment"># TIME_WAIT socket max number</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line"><span class="comment">##### MSL (Maximum Segment Lifetime)</span></span><br><span class="line">	2MSL server/client send the close request <span class="keyword">in</span> the last ack(time <span class="built_in">wait</span> status), timewait = 2MSL ? after timeout ,send fin ? <span class="keyword">in</span> this time, the port could not be used.</span><br><span class="line">	<span class="keyword">if</span> you <span class="built_in">set</span> SO_REUSEPORT, don <span class="string">&#x27;t to wait 2MSL to use the port </span></span><br><span class="line"><span class="string">        SO_REUSEPORT (since Linux 3.9)</span></span><br><span class="line"><span class="string">        Permits multiple AF_INET or AF_INET6 sockets to be bound to an identical socket address.  This option must be set on each socket (including the first socket) prior to calling bind(2) on the socket.  To prevent port hijacking, all of the processes binding to the same address must have the same effective UID.  This option can be employed with both TCP an UDP sockets.</span></span><br><span class="line"><span class="string">        the SO_REUSEPORT socket option support was implemented in a series of patches by Tom Herbert. The new socket option allows multiple sockets on the same host to bind to the same port, and is intended to improve the performance of multithreaded network server applications running on top of multicore systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tcp segment (报文) + tcp datagram (data)</span></span><br><span class="line"><span class="string">TTL (time to live) in ip head</span></span><br><span class="line"><span class="string">MSL &gt; TTL ?</span></span><br><span class="line"><span class="string">RTT (round-trip time)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">URG: Urget pointer is valid</span></span><br><span class="line"><span class="string">SYN: </span></span><br><span class="line"><span class="string">FIN: </span></span><br><span class="line"><span class="string">ACK:</span></span><br><span class="line"><span class="string">PSH:</span></span><br><span class="line"><span class="string">RST:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RST+ACK</span></span><br><span class="line"><span class="string">only RST</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">packets per second (pps)</span></span><br><span class="line"><span class="string">bytes per second (bps)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;!-- more --&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### [tcp_fin_timeout and tcp_max_tw_buckets](https://access.redhat.com/solutions/41776)</span></span><br><span class="line"><span class="string">If you set too large value to tcp_fin_timeout, the system may become out of port, file-descripter and memory. If you set too small value, the system may leak delayed packets.</span></span><br><span class="line"><span class="string">If you set too large value to tcp_max_tw_buckets, the system may become out of port, file-descripter and memory. If you set too small value, the system may not communicate another host.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TCP(7)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       tcp_fin_timeout (integer; default: 60)</span></span><br><span class="line"><span class="string">              This  specifies  how many seconds to wait for a final FIN packet</span></span><br><span class="line"><span class="string">              before the socket is forcibly closed.  This is strictly a viola-</span></span><br><span class="line"><span class="string">              tion  of  the TCP specification, but required to prevent denial-</span></span><br><span class="line"><span class="string">              of-service attacks.  In Linux 2.2, the default value was 180.</span></span><br><span class="line"><span class="string">&lt;snip&gt;</span></span><br><span class="line"><span class="string">       tcp_max_tw_buckets (integer; default: see below)</span></span><br><span class="line"><span class="string">              The  maximum number of sockets in TIME_WAIT state allowed in the</span></span><br><span class="line"><span class="string">              system.  This limit exists only to prevent simple denial-of-ser-</span></span><br><span class="line"><span class="string">              vice  attacks.   The  default  value  of  NR_FILE*2  is adjusted</span></span><br><span class="line"><span class="string">              depending on the memory  in  the  system.   If  this  number  is</span></span><br><span class="line"><span class="string">              exceeded, the socket is closed and a warning is printed.</span></span><br><span class="line"><span class="string">&lt;snip&gt;</span></span><br><span class="line"><span class="string">       TCP_LINGER2</span></span><br><span class="line"><span class="string">              The  lifetime  of orphaned FIN_WAIT2 state sockets.  This option</span></span><br><span class="line"><span class="string">              can be used to override the system wide  sysctl  tcp_fin_timeout</span></span><br><span class="line"><span class="string">              on  this  socket.  This is not to be confused with the socket(7)</span></span><br><span class="line"><span class="string">              level option SO_LINGER.  This option should not be used in  code</span></span><br><span class="line"><span class="string">              intended to be portable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### tcpdump</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">tcpdump -n -i eth0 -A -x dst port 443 and greater 100</span></span><br></pre></td></tr></table></figure>

<h3 id="Linux-kernel"><a href="#Linux-kernel" class="headerlink" title="Linux kernel"></a>Linux kernel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">don<span class="string">&#x27;t cache ssthresh from previous connection</span></span><br><span class="line"><span class="string">Disable cache metrics so the initial conditions of the closed connections will not be saved to be used in near future connections:</span></span><br><span class="line"><span class="string">net.ipv4.tcp_no_metrics_save = 1</span></span><br><span class="line"><span class="string">&#x27;</span>1<span class="string">&#x27; means disable caching.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tcp_slow_start_after_idle = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tcp_slow_start_after_idle (Boolean; default: enabled(1); since Linux 2.6.18),If enabled, provide RFC 2861 behavior and time out the congestion window after an idle period. An idle period is defined as the current RTO (retransmission timeout). If disabled, the congestion window will not be timed out after an idle period.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># Vendors settings live in /usr/lib/sysctl.d/.</span></span><br><span class="line"><span class="string"># To override a whole file, create a new file with the same in</span></span><br><span class="line"><span class="string"># /etc/sysctl.d/ and put new settings there. To override</span></span><br><span class="line"><span class="string"># only specific settings, add a file with a lexically later</span></span><br><span class="line"><span class="string"># name in /etc/sysctl.d/ and put new settings there.</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># For more information, see sysctl.conf(5) and sysctl.d(5).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># each socket will use some fd</span></span><br><span class="line"><span class="string">fs.file-max = 1048576 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># tcp short connection will cause a lot of TIME_WAIT</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 7000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># disable tcp source trace</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.accept_source_route = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 30 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#TIMEOUT socket re-use</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse= 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_timestamps = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 8388608</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 8388608</span></span><br><span class="line"><span class="string">net.core.somaxconn = 8388608</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># in our internal LAN, a lots of out of range and tcp retrans</span></span><br><span class="line"><span class="string">net.ipv4.tcp_sack = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.core.netdev_budget=600</span></span><br><span class="line"><span class="string">net.ipv4.tcp_low_latency = 1</span></span><br><span class="line"><span class="string"># socket buffer to 256MB</span></span><br><span class="line"><span class="string">net.core.rmem_max = 268435456</span></span><br><span class="line"><span class="string">net.core.wmem_max = 268435456</span></span><br><span class="line"><span class="string"># allow tcp ipv4 buffer auto-tuning up to 256MB</span></span><br><span class="line"><span class="string"># min,init,maxinum size</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 65536 134217728 268435456</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 65536 134217728 268435456</span></span><br><span class="line"><span class="string">net.ipv4.tcp_mem = 65536 134217728 268435456</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_adv_win_scale= 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_window_scaling = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_mtu_probing= 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.core.default_qdisc = pfifo_fast</span></span><br><span class="line"><span class="string">net.ipv4.tcp_congestion_control = cubic</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kernel.numa_balancing=0</span></span><br><span class="line"><span class="string">net.ipv4.tcp_frto=1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_no_metrics_save = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_slow_start_after_idle = 0</span></span><br><span class="line"><span class="string">net.ipv4.tcp_mtu_probing = 1</span></span><br><span class="line"><span class="string">#net.ipv4.tcp_syn_retries = 8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># works best with &gt;= 500 client computers ##</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_interval = 3600</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_stale_time = 3600</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 8192</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 2048</span></span><br><span class="line"><span class="string"># Keep alive</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 60</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 7200</span></span><br><span class="line"><span class="string">#net.ipv4.tcp_syn_retries=8</span></span><br><span class="line"><span class="string">##net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">###net.ipv4.tcp_keepalive_probes = 25</span></span><br><span class="line"><span class="string">###net.ipv4.tcp_keepalive_time = 360</span></span><br></pre></td></tr></table></figure>

<h4 id="tcp-tw-reuse"><a href="#tcp-tw-reuse" class="headerlink" title="tcp_tw_reuse"></a><a target="_blank" rel="noopener" href="https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux">tcp_tw_reuse</a></h4><p>NOTE: net.ipv4.tcp_tw_recycle has been removed from Linux 4.12<br>Linux will randomize timestamp offsets for each connection, making this option completely broken, with or without NAT. It has been completely removed from Linux 4.12.<br>The LAST-ACK state is handled in the exact same way as for net.ipv4.tcp_tw_recycle.</p>
<p>By enabling net.ipv4.tcp_tw_reuse, Linux will reuse an existing connection in the TIME-WAIT state for a new outgoing connection if the new timestamp is strictly bigger than the most recent timestamp recorded for the previous connection: an outgoing connection in the TIME-WAIT state can be reused after just one second.</p>
<p>   Allow to reuse TIME-WAIT sockets for new connections when it is safe from protocol viewpoint. Default value is 0. It should not be changed without advice/request of technical experts.<br>   The mere result of this lack of documentation is that we find numerous tuning guides advising to set both these settings to 1 to reduce the number of entries in the TIME-WAIT state. However, as stated by tcp(7) manual page, the net.ipv4.tcp_tw_recycle option is quite problematic for public-facing servers as it won’t handle connections from two different computers behind the same NAT device, which is a problem hard to detect and waiting to bite you:<br>   Enable fast recycling of TIME-WAIT sockets. Enabling this option is not recommended since this causes problems when working with NAT (Network Address Translation).<br><img src="/img/tcp-state-diagram-v2.svg"></p>
<p><img src="/img/duplicate-segment.svg"><br>Due to a shortened TIME-WAIT state, a delayed TCP segment has been accepted in an unrelated connection.</p>
<p>The other purpose is to ensure the remote end has closed the connection. When the last ACK is lost, the remote end stays in the LAST-ACK state. Without the TIME-WAIT state, a connection could be reopened while the remote end still thinks the previous connection is valid. When it receives a SYN segment (and the sequence number matches), it will answer with a RST as it is not expecting such a segment. The new connection will be aborted with an error<br><img src="/img/last-ack.svg"><br>If the remote end stays in LAST-ACK state because the last ACK was lost, opening a new connection with the same quadruplet will not work.</p>
<p>RFC 793 requires the TIME-WAIT state to last twice the time of the MSL. On Linux, this duration is not tunable and is defined in include/net/tcp.h as one minute:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define TCP_TIMEWAIT_LEN (60*HZ) /* how long to wait to destroy TIME-WAIT</span></span><br><span class="line">				  * state, about 60 seconds	*/</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ss -tan state time-wait</span><br></pre></td></tr></table></figure>

<p>A hash table of connections, named the “TCP established hash table” (despite containing connections in other states) is used to locate an existing connection, for example when receiving a new segment.</p>
<p>the TIME-WAIT connection in this table</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg | grep <span class="string">&quot;TCP established hash table&quot;</span></span><br><span class="line">[    1.041036] TCP established <span class="built_in">hash</span> table entries: 524288 (order: 10, 4194304 bytes)</span><br><span class="line">$ dmesg | grep <span class="string">&quot;TCP bind hash table&quot;</span></span><br><span class="line">[    1.041724] TCP <span class="built_in">bind</span> <span class="built_in">hash</span> table entries: 65536 (order: 8, 1048576 bytes)</span><br></pre></td></tr></table></figure>

<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slabtop -o | <span class="type">grep</span> -E &#x27;(^  OBJS|<span class="type">tw_sock_TCP</span>|<span class="type">tcp_bind_bucket</span>)&#x27;</span><br></pre></td></tr></table></figure>

<p>If the FIN segments are received in a timely manner, the local end socket will still be in the TIME-WAIT state and the expected ACK segments will be sent.</p>
<p>Once a new connection replaces the TIME-WAIT entry, the SYN segment of the new connection is ignored (thanks to the timestamps) and won’t be answered by a RST but only by a retransmission of the FIN segment. The FIN segment will then be answered with a RST (because the local connection is in the SYN-SENT state) which will allow the transition out of the LAST-ACK state. The initial SYN segment will eventually be resent (after one second) because there was no answer and the connection will be established without apparent error, except a slight delay:<br><img src="/img/last-ack-reuse.svg"></p>
<h3 id="ethtool"><a href="#ethtool" class="headerlink" title="ethtool"></a><a target="_blank" rel="noopener" href="https://voipmagazine.wordpress.com/tag/tcp_no_metrics_save/">ethtool</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -s p4p2 speed 1000 duplex full autoneg off</span><br><span class="line">$ grep ETHTOOL_OPTS /etc/sysconfig/network-scripts/ifcfg-p4p1</span><br><span class="line">ETHTOOL_OPTS=speed 1000 duplex full</span><br><span class="line">$ systemctl restart network</span><br><span class="line">$ ifconfig eth0 txqueuelen 3000 </span><br></pre></td></tr></table></figure>

<h3 id="SLE-and-SER-in-SACK-RFC2018"><a href="#SLE-and-SER-in-SACK-RFC2018" class="headerlink" title="SLE and SER in SACK(RFC2018)"></a>SLE and SER in SACK(RFC2018)</h3><p>tcpdump will show some packet show “SLE=20480 SER=24576”</p>
<p>SLE: Sequence Left Edge of already acknowledged data when Selective Acknowledgments are used<br>SRE: Sequence Right Edge of already acknowledged data when Selective Acknowledgments are used</p>
<p>When server send the package length from 1<del>24576, the client just return ack=$((seq+18736))<br>The client receive 18736 bytes, and recevice the out of order packets from 20480</del>24576 bytes, and just loss from 18737<del>20479 Bytes<br>The server don ‘t need to retrans 20480 to 24576 bytes. if the system not enable sack, it will retrans from 18737</del>24576</p>
<h3 id="Spurious-retransmission-timeouts"><a href="#Spurious-retransmission-timeouts" class="headerlink" title="Spurious retransmission timeouts"></a>Spurious retransmission timeouts</h3><p>Because packets out of order or another issue trigger the packet RTO, but the packet was not loss, it ‘s misjudging, that means Spurious retransmission timeouts.</p>
<p>Active F-RTO<br>net.ipv4.tcp_frto=2</p>
<h3 id="Thin-stream"><a href="#Thin-stream" class="headerlink" title="Thin-stream"></a><a target="_blank" rel="noopener" href="https://nnc3.com/mags/LJ_1994-2014/LJ/219/11180.html">Thin-stream</a></h3><p>For latency env</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default eq 0</span></span><br><span class="line">sysctl -w net.ipv4.tcp_thin_linear_timeouts=1</span><br><span class="line">sysctl -w net.ipv4.tcp_thin_dupack=1</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /proc/sys/net/ipv4/tcp_thin_linear_timeouts</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /proc/sys/net/ipv4/tcp_thin_dupack</span><br></pre></td></tr></table></figure>

<h3 id="tcp-retrans"><a href="#tcp-retrans" class="headerlink" title="tcp retrans"></a><a target="_blank" rel="noopener" href="http://perthcharles.github.io/2015/09/07/wiki-tcp-retries/">tcp retrans</a></h3><p>RTO(retransmission timeout)<br>RRT(round-trip time)<br>TCP keep the weight value SRTT(smoothed RRT)</p>
<p>The latest RRTS = (1-a) * ( last RTTS) + a * (the lastest RRT)<br>In RFC2988, a = 1/8<br>RTTD was the RTT deviation weight value<br>First get RTTD, RTTD value = RRT/2<br>Next the RTTD=(1-B)<em>(the last RTTD) + B(RTTS-the lastest RRT)<br>RFC B=1/4<br>RTO= RTTS + 4</em>RTTD<br>The RFC suggest if the message retrans, this RRT value will be drop<br>When the trigger tcp retrans, the latest RTO * 2 = the last RTO until the maximum</p>
<p>But RFC != the real implementation</p>
<p><a target="_blank" rel="noopener" href="https://ms2008.github.io/2017/04/14/tcp-timeout/">tcp_syn_retries 三次握手</a><br>net.ipv4.tcp_syn_retries retrans interval was [1,3,7,15,31]s </p>
<p>tcp_syn_retries2</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> tcp_retries2=<span class="number">15</span>，<span class="keyword">the</span> <span class="keyword">timeout</span> was <span class="number">924600</span>ms。</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> If RTT <span class="keyword">is</span> tiny <span class="keyword">that</span> <span class="keyword">the</span> RTO init value was <span class="keyword">about</span> <span class="number">200</span>ms</span><br><span class="line">   The total <span class="keyword">timeout</span> was <span class="number">924600</span>ms，looks like retrans <span class="number">15</span> <span class="keyword">times</span> cause <span class="keyword">over</span> <span class="keyword">the</span> <span class="keyword">timeout</span> value <span class="keyword">and</span> <span class="keyword">end</span> <span class="keyword">the</span> tcp stream</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> If RTT <span class="keyword">is</span> large,<span class="keyword">the</span> RTO calculate value was <span class="number">1000</span>ms</span><br><span class="line">   <span class="keyword">it</span> doesn&#x27; t need retrans <span class="number">15</span> <span class="keyword">times</span>，<span class="keyword">the</span> <span class="keyword">timeout</span> value will <span class="keyword">over</span> <span class="number">924600</span>ms.</span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">the</span> RTT=<span class="number">400</span>ms,<span class="keyword">set</span> tcp_retries2=<span class="number">10</span>, only <span class="number">3</span> <span class="keyword">times</span> <span class="keyword">the</span> tcp stream will <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="tcp-retrans-1"><a href="#tcp-retrans-1" class="headerlink" title="tcp retrans"></a>tcp retrans</h3><p>There are 3 server in test env</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ numactl --physcpubind=2 iperf3 -c <span class="variable">$serverC</span> -P 1 -M 8960 -S 0x08 -t 36000 -p 5201 -l 512k</span><br><span class="line">Connecting to host 10.53.19.52, port 5201</span><br><span class="line">[  4] <span class="built_in">local</span> <span class="variable">$ServerB</span> port 58064 connected to <span class="variable">$ServerC</span> port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd</span><br><span class="line">[  4]   0.00-1.00   sec  1.15 GBytes  9.92 Gbits/sec    0    690 KBytes</span><br><span class="line">...</span><br><span class="line">[  4]  66.00-67.00  sec  1.15 GBytes  9.90 Gbits/sec    0    717 KBytes</span><br><span class="line">... always no retrans, cwnd increase slowly</span><br><span class="line">[  4] 189.00-190.00 sec  1.15 GBytes  9.89 Gbits/sec    0    725 KBytes</span><br><span class="line">...</span><br><span class="line">[  4] 418.00-419.00 sec  1.15 GBytes  9.89 Gbits/sec    0    909 KBytes</span><br><span class="line">...</span><br><span class="line">[  4] 4195.00-4196.00 sec  1.15 GBytes  9.90 Gbits/sec    0    909 KBytes</span><br><span class="line">[  4] 4196.00-4197.00 sec  1.15 GBytes  9.90 Gbits/sec    0    909 KBytes</span><br><span class="line">[  4] 4197.00-4198.00 sec  1.15 GBytes  9.89 Gbits/sec    0    909 KBytes</span><br><span class="line">[  4] 4198.00-4198.51 sec   606 MBytes  9.91 Gbits/sec    0    909 KBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-4198.51 sec  0.00 (null)s  9.90 Gbits/sec    6             sender</span><br><span class="line">[  4]   0.00-4198.51 sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line">iperf3: interrupt - the client has terminated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ numactl --physcpubind=2 iperf3 -c <span class="variable">$serverA</span> -P 1 -M 8960 -S 0x08 -t 36000 -p 5201 -l 512k</span><br><span class="line"></span><br><span class="line">[  4] 188.00-189.00 sec  1.15 GBytes  9.89 Gbits/sec   10   2.04 MBytes</span><br><span class="line">[  4] 189.00-190.00 sec  1.15 GBytes  9.87 Gbits/sec   14   1.97 MBytes</span><br><span class="line">[  4] 190.00-191.00 sec  1.15 GBytes  9.87 Gbits/sec   38   1.65 MBytes</span><br><span class="line">[  4] 191.00-192.00 sec  1.15 GBytes  9.89 Gbits/sec   18   1.59 MBytes</span><br><span class="line">[  4] 192.00-193.00 sec  1.15 GBytes  9.86 Gbits/sec   12   2.20 MBytes</span><br><span class="line">[  4] 193.00-194.00 sec  1.15 GBytes  9.90 Gbits/sec    8   2.01 MBytes</span><br><span class="line">[  4] 194.00-195.00 sec  1.15 GBytes  9.86 Gbits/sec    9   1.70 MBytes</span><br><span class="line">[  4] 195.00-196.00 sec  1.15 GBytes  9.87 Gbits/sec    8   2.26 MBytes</span><br><span class="line">[  4] 196.00-196.72 sec   851 MBytes  9.88 Gbits/sec    4   1.99 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-196.72 sec   226 GBytes  9.87 Gbits/sec  3776             sender</span><br><span class="line">[  4]   0.00-196.72 sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line">iperf3: interrupt - the client has terminated</span><br></pre></td></tr></table></figure>

<h4 id="Make-sure-retrans-type"><a href="#Make-sure-retrans-type" class="headerlink" title="Make sure retrans type"></a>Make sure retrans type</h4><p><a target="_blank" rel="noopener" href="https://github.com/brendangregg/perf-tools">tcpretrans</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">$ nstat -rsz | grep -Ei <span class="string">&#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb&#x27;</span></span><br><span class="line">TcpExtTCPSackFailures           559232             0.0</span><br><span class="line">TcpExtTCPLossFailures           44575              0.0</span><br><span class="line">TcpExtTCPRenoRecoveryFail       0                  0.0</span><br><span class="line">TcpExtTCPSackRecoveryFail       400237             0.0</span><br><span class="line">TcpExtTCPSchedulerFailed        0                  0.0</span><br><span class="line">TcpExtTCPAbortFailed            3                  0.0</span><br><span class="line">TcpExtTCPSACKDiscard            0                  0.0</span><br><span class="line">TcpExtTCPBacklogDrop            0                  0.0</span><br><span class="line">TcpExtPFMemallocDrop            0                  0.0</span><br><span class="line">TcpExtTCPMinTTLDrop             0                  0.0</span><br><span class="line">TcpExtTCPDeferAcceptDrop        0                  0.0</span><br><span class="line">TcpExtTCPReqQFullDrop           0                  0.0</span><br><span class="line">TcpExtTCPRetransFail            631                0.0</span><br><span class="line">TcpExtTCPOFODrop                15819              0.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ netstat -s | grep -i retrans</span><br><span class="line">    36900 segments retransmited</span><br><span class="line">    TCPLostRetransmit: 135</span><br><span class="line">    36854 fast retransmits</span><br><span class="line">    32 forward retransmits</span><br><span class="line">    9 retransmits <span class="keyword">in</span> slow start</span><br><span class="line">    5 SACK retransmits failed</span><br><span class="line">$ netstat -s | grep -i retrans</span><br><span class="line">    36963 segments retransmited</span><br><span class="line">    TCPLostRetransmit: 135</span><br><span class="line">    36917 fast retransmits</span><br><span class="line">    32 forward retransmits</span><br><span class="line">    9 retransmits <span class="keyword">in</span> slow start</span><br><span class="line">    5 SACK retransmits failed</span><br><span class="line"></span><br><span class="line">17:18:03 0      10.53.19.2:40770     R&gt; 10.53.19.1:5201      ESTABLISHED</span><br><span class="line"> =&gt; tcp_retransmit_skb</span><br><span class="line"> =&gt; tcp_fastretrans_alert</span><br><span class="line"> =&gt; tcp_ack</span><br><span class="line"> =&gt; tcp_rcv_established</span><br><span class="line"> =&gt; tcp_v4_do_rcv</span><br><span class="line"> =&gt; tcp_v4_rcv</span><br><span class="line"> =&gt; ip_local_deliver_finish</span><br><span class="line"> =&gt; ip_local_deliver</span><br><span class="line"> =&gt; ip_rcv_finish</span><br><span class="line"> =&gt; ip_rcv</span><br><span class="line"> =&gt; __netif_receive_skb_core</span><br><span class="line"> =&gt; __netif_receive_skb</span><br><span class="line"> =&gt; netif_receive_skb_internal</span><br><span class="line"> =&gt; napi_gro_receive</span><br><span class="line"> =&gt; i40e_clean_rx_irq</span><br><span class="line"> =&gt; i40e_napi_poll</span><br><span class="line"> =&gt; net_rx_action</span><br><span class="line"> =&gt; __do_softirq</span><br><span class="line"> =&gt; call_softirq</span><br><span class="line"> =&gt; do_softirq</span><br><span class="line"> =&gt; irq_exit</span><br><span class="line"> =&gt; do_IRQ</span><br><span class="line"> =&gt; ret_from_intr</span><br><span class="line"> =&gt; cpuidle_enter_state</span><br><span class="line"> =&gt; cpuidle_idle_call</span><br><span class="line"> =&gt; arch_cpu_idle</span><br><span class="line"> =&gt; cpu_startup_entry</span><br><span class="line"> =&gt; start_secondary</span><br><span class="line"> =&gt; start_cpu</span><br><span class="line">17:18:03 11610  10.53.19.2:40770     R&gt; 10.53.19.1:5201      ESTABLISHED</span><br><span class="line"> =&gt; tcp_retransmit_skb</span><br><span class="line"> =&gt; tcp_fastretrans_alert</span><br><span class="line"> =&gt; tcp_ack</span><br><span class="line"> =&gt; tcp_rcv_established</span><br><span class="line"> =&gt; tcp_v4_do_rcv</span><br><span class="line"> =&gt; release_sock</span><br><span class="line"> =&gt; tcp_sendmsg</span><br><span class="line"> =&gt; inet_sendmsg</span><br><span class="line"> =&gt; sock_aio_write</span><br><span class="line"> =&gt; do_sync_write</span><br><span class="line"> =&gt; vfs_write</span><br><span class="line"> =&gt; SyS_write</span><br><span class="line"> =&gt; system_call_fastpath</span><br><span class="line"></span><br><span class="line">$ ps aux | grep 11610</span><br><span class="line">root     11610 11.9  0.0  10084  1524 pts/1    S+   17:15   0:28 iperf3 -c 10.53.19.1 -P 1 -M 8960 -S 0x08 -t 36000 -p 5201 -l 512k</span><br></pre></td></tr></table></figure>

<h4 id="Analysis-wireshark-log"><a href="#Analysis-wireshark-log" class="headerlink" title="Analysis wireshark log"></a>Analysis wireshark log</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ tshark -r first.pcapng <span class="string">&quot;tcp.analysis.retransmission&quot;</span></span><br><span class="line">no output</span><br><span class="line"></span><br><span class="line">$ tshark -r first.pcapng <span class="string">&quot;tcp.analysis.duplicate_ack&quot;</span></span><br><span class="line"></span><br><span class="line">21801 0.710632534   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#1] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794721 TSecr=61820560 SLE=777178578 SRE=777375434</span></span><br><span class="line">21804 0.710733730   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#2] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794721 TSecr=61820560 SLE=777178578 SRE=777500706</span></span><br><span class="line">21811 0.711034519   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#3] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=777867574</span></span><br><span class="line">21814 0.711153496   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#4] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778010742</span></span><br><span class="line">21816 0.711206308   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#5] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778082326</span></span><br><span class="line">21818 0.711259113   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#6] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778144962</span></span><br><span class="line">21820 0.711369837   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#7] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778279182</span></span><br><span class="line">21823 0.711477980   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#8] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778413402</span></span><br><span class="line">21826 0.711584396   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#9] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778547622</span></span><br><span class="line">21829 0.711695472   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#10] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778681842</span></span><br><span class="line">21831 0.711749935   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#11] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778753426</span></span><br><span class="line">21834 0.711911211   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#12] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=778950282</span></span><br><span class="line">21837 0.712018290   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#13] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779084502</span></span><br><span class="line">21839 0.712073239   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#14] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779147138</span></span><br><span class="line">21842 0.712182142   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#15] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779281358</span></span><br><span class="line">21844 0.712229813   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#16] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779317150</span></span><br><span class="line">21846 0.712343529   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#17] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779487162</span></span><br><span class="line">21848 0.712400110   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#18] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779549798</span></span><br><span class="line">21851 0.712507000   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#19] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779684018</span></span><br><span class="line">28272 1.007961111   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#1] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1144672938</span></span><br><span class="line">28276 1.008232476   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#2] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145012962</span></span><br><span class="line">28278 1.008288165   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#3] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145075598</span></span><br><span class="line">28284 1.008612213   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#4] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145478258</span></span><br><span class="line">28287 1.008719487   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#5] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145612478</span></span><br><span class="line">28290 1.008945676   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#6] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1145898814</span></span><br><span class="line">28292 1.008995223   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#7] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1145961450</span></span><br><span class="line">28294 1.009095692   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#8] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146077774</span></span><br><span class="line">28296 1.009144335   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#9] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146140410</span></span><br><span class="line">28298 1.009194590   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#10] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146203046</span></span><br><span class="line">28300 1.009296391   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#11] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146328318</span></span><br><span class="line">28303 1.009447610   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#12] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146516226</span></span><br><span class="line">28305 1.009498110   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#13] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146578862</span></span><br><span class="line">28307 1.009544808   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#14] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146632550</span></span><br><span class="line">28309 1.009647030   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#15] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146757822</span></span><br><span class="line">28312 1.009798430   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#16] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795021 TSecr=61820858 SLE=1144493978 SRE=1146945730</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/tshark-1.png"><br><img src="/img/tshark-2.png"></p>
<p>TCP has this inherent mechanism of recovery. In tcp stream eq 8 of your trace there was a condition of retransmission generated due to timing but not because of drops. Here is the snippet of your trace.</p>
<p>Step-1)Server send a packet to client(Let us call it packet-A){Packet.no-150}</p>
<p>Step-2)Client acknowledged the packet (Let us call it ack-A){Packet.no-192}</p>
<p>Step-3)Somehow packet-A was retransmitted by Server.The reason might be the delay in receiving ack-A from client and ack timer got out and retransmission timer got kicked in.(Dup of Packet-A){Packet.no-194}</p>
<p>Step-4)Client generated a duplicate ack for the retransmitted packet.(Dup of ack-A){Packet.no-195}</p>
<p><a target="_blank" rel="noopener" href="https://osqa-ask.wireshark.org/questions/21006/tcp-dup-acktcp-retransmission">https://osqa-ask.wireshark.org/questions/21006/tcp-dup-acktcp-retransmission</a></p>
<h3 id="tcpdump-802-3-header"><a href="#tcpdump-802-3-header" class="headerlink" title="tcpdump 802.3 header"></a><a target="_blank" rel="noopener" href="https://support.f5.com/csp/article/K2289">tcpdump 802.3 header</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">LACP is handled by the switch fabric, therefore packets must be captured directly on the physical interface, <span class="keyword">for</span> example, 1.1, as opposed to the VLAN or 0.0.</span><br><span class="line"></span><br><span class="line">To capture only LACP packets, use the following syntax:</span><br><span class="line"></span><br><span class="line">tcpdump -ni &lt;interface&gt; -e ether proto 0x8809</span><br><span class="line"></span><br><span class="line">Note: The -e switch prints the link-level header on each line.</span><br><span class="line"></span><br><span class="line">For example, to capture LACP packets on interface 1.1 of a Link Aggregation Group (LAG), <span class="built_in">type</span> the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">tcpdump -ni 1.1 -e ether proto 0x8809</span><br><span class="line"></span><br><span class="line">The output appears similar to the following example:</span><br><span class="line"></span><br><span class="line">15:21:03.445333 00:50:56:92:2a:82 &gt; 01:80:c2:00:00:02, ethertype 802.1Q (0x8100), length 128: vlan 0, p 0, ethertype Slow Protocols, LACPv1, length: 110</span><br><span class="line"></span><br><span class="line">Ethernet header (basically IEEE 802.3)</span><br><span class="line"></span><br><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                         Preamble (8)                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                      Preamble cont.                           |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination address (6)                    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|   Destination address cont.   |         Source address (6)    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Source address cont.                       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|            Type (2)           | Pri |C|     802.1q tag        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| <span class="keyword">if</span> <span class="built_in">type</span>!=0x8100, prev. 2 bytes are part of this field  (46 -  |</span><br><span class="line">| 1500 bytes of data) ...                                       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Frame Check Sequence, FCS (4)              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">Note: Although the previous diagram correctly shows both Preamble and Frame Check Sequence, tcpdump does not include these <span class="keyword">in</span> the totals <span class="keyword">for</span> header bytes (presumably because the data is fixed, so there is no reason to match against it.) As a result, <span class="keyword">if</span> you are basing ether expressions on this chart, you must subtract 12 (as <span class="keyword">if</span> the Preamble and FCS sections <span class="keyword">do</span> not exist.)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">To view the SYN packets and the SYN and ACK packets, you would create the following filter that accepts either value <span class="keyword">for</span> the flag byte:</span><br><span class="line">tcpdump -ni internal <span class="string">&#x27;tcp[13] == 18&#x27;</span> or <span class="string">&#x27;tcp[13] == 2&#x27;</span></span><br><span class="line"></span><br><span class="line">You can also create a filter that looks <span class="keyword">for</span> the <span class="built_in">set</span> SYN bit and ignores the rest of the flags <span class="keyword">in</span> the header. You must <span class="built_in">set</span> the filter to perform a logic AND (&amp;) to remove all but the value of the SYN bit and <span class="keyword">then</span> <span class="built_in">test</span> it.</span><br><span class="line"></span><br><span class="line">For example, <span class="keyword">if</span> the TCP flags are 00010010 and the mask <span class="keyword">for</span> Syn is 00000010(2 <span class="keyword">in</span> binary) <span class="keyword">then</span> 00010010 + 00000010 = 00000010. You can <span class="keyword">then</span> <span class="built_in">test</span> the resulting value against the SYN flag, by setting the filter as follows:</span><br><span class="line">tcpdump -ni internal <span class="string">&#x27;tcp[13] &amp; 2 == 2&#x27;</span></span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Ginger</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2017/01/08/tcp/">http://yoursite.com/2017/01/08/tcp/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/network/">network</a><a class="post-meta__tags" href="/tags/tcp/">tcp</a></div><div class="post_share"><div class="social-share" data-image="https://homerl.github.io/img/operting_system_a32c6f.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2017/03/09/kvm-command/"><img class="prev-cover" src="/img/photo_by_spacex.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">kvm_tips</div></div></a></div><div class="next-post pull-right"><a href="/2016/12/28/learn-zfs-internals-p1-p5/"><img class="next-cover" src="https://homerl.github.io/img/the_last_word_fs.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">A copy about ZFS Internals(p1-p5)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/07/22/network-benchmark-result/" title="Network bencharmk results"><img class="cover" src="/img/photo_by_spacex.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-22</div><div class="title">Network bencharmk results</div></div></a></div><div><a href="/2018/06/01/nic_ethernet_tuning/" title="ethernet nic tuning"><img class="cover" src="/img/photo_by_spacex.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-06-01</div><div class="title">ethernet nic tuning</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2020 By Ginger</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '0b9d5b98d0a972b33cf7',
      clientSecret: '769efc11b32f6c0d03bcbf3ee800dfc4e2690459',
      repo: 'homerl.github.io',
      owner: 'homerl',
      admin: ['homerl'],
      id: '25aaaee4716a38ccb06a5efe7943480e',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>