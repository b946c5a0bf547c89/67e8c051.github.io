<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>memory | 无常无相无功;不动不破不空</title><meta name="keywords" content="memory"><meta name="author" content="寸劲"><meta name="copyright" content="寸劲"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="x86_64 5-level page tableLinear-address Translation Using 5-level paging slabtop123456789101112131415161718192021222324252627282930#slab &gt; 100M object$ cat &#x2F;proc&#x2F;slabinfo |awk &amp;#x27;&amp;#123;if($3*$4&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="memory">
<meta property="og:url" content="http://yoursite.com/2018/07/02/mem/index.html">
<meta property="og:site_name" content="无常无相无功;不动不破不空">
<meta property="og:description" content="x86_64 5-level page tableLinear-address Translation Using 5-level paging slabtop123456789101112131415161718192021222324252627282930#slab &gt; 100M object$ cat &#x2F;proc&#x2F;slabinfo |awk &amp;#x27;&amp;#123;if($3*$4&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg">
<meta property="article:published_time" content="2018-07-02T02:49:30.000Z">
<meta property="article:modified_time" content="2022-03-28T19:09:41.000Z">
<meta property="article:author" content="寸劲">
<meta property="article:tag" content="memory">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg"><link rel="shortcut icon" href="/img/stout-shield.png"><link rel="canonical" href="http://yoursite.com/2018/07/02/mem/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-03-29 03:09:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="无常无相无功;不动不破不空" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/fighting-spiri-logot.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#x86-64-5-level-page-table"><span class="toc-number">1.</span> <span class="toc-text">x86_64 5-level page table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slabtop"><span class="toc-number">2.</span> <span class="toc-text">slabtop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-Memory-Leak-Detector"><span class="toc-number">3.</span> <span class="toc-text">Kernel Memory Leak Detector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zram"><span class="toc-number">4.</span> <span class="toc-text">zram</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#zram-info"><span class="toc-number">4.1.</span> <span class="toc-text">zram.info</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS-default-memory-setting-cause-issue"><span class="toc-number">5.</span> <span class="toc-text">CentOS default memory setting cause issue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Make-sure-the-ECC-work-in-Linux"><span class="toc-number">6.</span> <span class="toc-text">Make sure the ECC work in Linux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitor-ECC-error"><span class="toc-number">7.</span> <span class="toc-text">Monitor ECC error</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#From-OS"><span class="toc-number">7.1.</span> <span class="toc-text">From OS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#From-IPMI"><span class="toc-number">7.2.</span> <span class="toc-text">From IPMI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NIC-page-allocation-failure"><span class="toc-number">8.</span> <span class="toc-text">NIC page allocation failure</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dirty-page"><span class="toc-number">8.1.</span> <span class="toc-text">dirty page</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZRAM"><span class="toc-number">9.</span> <span class="toc-text">ZRAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Some-parameter-about-numa"><span class="toc-number">10.</span> <span class="toc-text">Some parameter about numa</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage"><span class="toc-number">11.</span> <span class="toc-text">Soft lockup detected on a large NUMA system under a heavy memory usage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Transparent-Huge-Page"><span class="toc-number">12.</span> <span class="toc-text">Transparent Huge Page</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Single-process-memory"><span class="toc-number">13.</span> <span class="toc-text">Single process memory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Slab"><span class="toc-number">13.1.</span> <span class="toc-text">Slab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Page-table"><span class="toc-number">13.2.</span> <span class="toc-text">Page table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Struct-page"><span class="toc-number">13.3.</span> <span class="toc-text">Struct page</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-hugetlbfs"><span class="toc-number">14.</span> <span class="toc-text">Use hugetlbfs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#set-hugepage"><span class="toc-number">14.1.</span> <span class="toc-text">set hugepage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memlock"><span class="toc-number">14.2.</span> <span class="toc-text">memlock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#free-hugepage"><span class="toc-number">14.3.</span> <span class="toc-text">free hugepage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#manage-tools"><span class="toc-number">14.4.</span> <span class="toc-text">manage tools</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reduce-OOM-kill-rate"><span class="toc-number">14.5.</span> <span class="toc-text">reduce OOM kill rate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get-pagesize"><span class="toc-number">14.6.</span> <span class="toc-text">get pagesize</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enable-huge-page-for-performance"><span class="toc-number">15.</span> <span class="toc-text">enable huge page for performance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slab-exhaust-all-memory-because-a-lot-of-scan"><span class="toc-number">16.</span> <span class="toc-text">slab exhaust all memory because a lot of scan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#memmap"><span class="toc-number">17.</span> <span class="toc-text">memmap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mapping-dev-pmemX-can-be-used-to-create-a-DAX-filesystem"><span class="toc-number">17.1.</span> <span class="toc-text">mapping &#x2F;dev&#x2F;pmemX can be used to create a DAX filesystem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Monitor-ecc-error"><span class="toc-number">17.2.</span> <span class="toc-text">Monitor ecc error</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Benchmark-by-perf"><span class="toc-number">18.</span> <span class="toc-text">Benchmark by perf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMD-roma-CPU-memroy"><span class="toc-number">19.</span> <span class="toc-text">AMD roma CPU memroy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#system-call"><span class="toc-number">20.</span> <span class="toc-text">system call</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#check-memroy-fragment"><span class="toc-number">21.</span> <span class="toc-text">check memroy fragment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proc-vmstat"><span class="toc-number">22.</span> <span class="toc-text">&#x2F;proc&#x2F;vmstat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trace-page-fault"><span class="toc-number">23.</span> <span class="toc-text">trace page fault</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#meminfo"><span class="toc-number">24.</span> <span class="toc-text">meminfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Out-of-memory"><span class="toc-number">25.</span> <span class="toc-text">Out of memory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#check-swap-usage"><span class="toc-number">25.1.</span> <span class="toc-text">check swap usage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#valgrind"><span class="toc-number">25.2.</span> <span class="toc-text">valgrind</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vmtouch"><span class="toc-number">25.3.</span> <span class="toc-text">vmtouch</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://homerl.github.io/img/operting_system_a32c6f.svg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">无常无相无功;不动不破不空</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">memory</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2018-07-02T02:49:30.000Z" title="Created 2018-07-02 10:49:30">2018-07-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-03-28T19:09:41.000Z" title="Updated 2022-03-29 03:09:41">2022-03-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/OS/">OS</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="x86-64-5-level-page-table"><a href="#x86-64-5-level-page-table" class="headerlink" title="x86_64 5-level page table"></a>x86_64 5-level page table</h3><p>Linear-address Translation Using 5-level paging</p>
<h3 id="slabtop"><a href="#slabtop" class="headerlink" title="slabtop"></a>slabtop</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#slab &gt; 100M object</span></span><br><span class="line">$ cat /<span class="keyword">proc</span>/slabinfo |awk &#x27;&#123;<span class="keyword">if</span>($<span class="number">3</span>*$<span class="number">4</span>/<span class="number">1024</span>/<span class="number">1024</span> &gt; <span class="number">100</span>)&#123;print $<span class="number">1</span>,$<span class="number">3</span>*$<span class="number">4</span>/<span class="number">1024</span>/<span class="number">1024</span>&#125; &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="number">2554</span> x slabs</span><br><span class="line"><span class="number">56</span> x obj in a slab    </span><br><span class="line">total <span class="number">8128</span> = <span class="number">254</span> x <span class="number">32</span>, obj sieze=<span class="number">1</span>K</span><br><span class="line"><span class="number">8128</span> x <span class="number">1</span>K = cache size = <span class="number">8128</span>K                          </span><br><span class="line">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME</span><br><span class="line"> <span class="number">8128</span>   <span class="number">7360</span>  <span class="number">90</span>%    <span class="number">1.00</span>K    <span class="number">254</span>	 <span class="number">32</span>	 <span class="number">8128</span>K kmalloc<span class="number">-1024</span></span><br><span class="line"></span><br><span class="line">To free pagecache:</span><br><span class="line">$ echo <span class="number">1</span> &gt; /<span class="keyword">proc</span>/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">To<span class="title"> free</span> dentries<span class="title"> and</span> inodes:</span><br><span class="line">$<span class="title"> echo</span> 2 &gt; /<span class="keyword">proc</span>/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">To<span class="title"> free</span> pagecache,<span class="title"> dentries</span> and<span class="title"> inodes:</span></span><br><span class="line"><span class="title">$</span> echo 3 &gt; /<span class="keyword">proc</span>/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">##<span class="title"> Got</span> the<span class="title"> free</span> pages<span class="title"> from</span> buddyinfo</span><br><span class="line">$<span class="title"> awk</span> &#x27;&#123;sum=<span class="number">0</span>;<span class="keyword">for</span>(i=<span class="number">5</span>;i&lt;=NF;i++) sum+=$i*(<span class="number">2</span>^(i<span class="number">-5</span>))&#125;;&#123;total+=sum*<span class="number">4096</span>/<span class="number">1024</span>/<span class="number">1024</span>&#125;;&#123;print $<span class="number">1</span> <span class="string">&quot; &quot;</span> $<span class="number">2</span> <span class="string">&quot; &quot;</span> $<span class="number">3</span> <span class="string">&quot; &quot;</span> $<span class="number">4</span> <span class="string">&quot;\t : &quot;</span> sum*<span class="number">4096</span>/<span class="number">1024</span>/<span class="number">1024</span> <span class="string">&quot;M&quot;</span>&#125; END &#123;print <span class="string">&quot;total\t\t\t : &quot;</span> total <span class="string">&quot;M&quot;</span>&#125;&#x27; /<span class="keyword">proc</span>/buddyinfo</span><br><span class="line"></span><br><span class="line">All<span class="title"> processes</span> mem= $(grep<span class="title"> Pss</span> /<span class="keyword">proc</span>/[1-9]*/smaps |<span class="title"> awk</span> &#x27;&#123;total+=$<span class="number">2</span>&#125;; END &#123;print total&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">RSS mem = awk &#x27;&#123;sum+=$<span class="number">2</span>&#125; END&#123;print sum*<span class="number">4</span><span class="string">&quot; KiB&quot;</span>&#125;&#x27; /<span class="keyword">proc</span>/[1-9]*/statm</span><br><span class="line">##<span class="title"> there</span> are<span class="title"> little</span> diff<span class="title"> result</span> with<span class="title"> python</span> version,<span class="title"> because</span> awk<span class="title"> and</span> python<span class="title"> is</span> not<span class="title"> the</span> same<span class="title"> application,</span> malloc<span class="title"> diff</span> mem</span><br><span class="line"></span><br><span class="line">slab<span class="title"> size</span> =<span class="title"> awk</span> &#x27;&#123;sum=sum+$<span class="number">3</span>*$<span class="number">4</span>;&#125;END&#123;print sum/<span class="number">1024</span><span class="string">&quot; KiB&quot;</span>&#125;&#x27; /<span class="keyword">proc</span>/slabinfo</span><br><span class="line"></span><br><span class="line">pagetable<span class="title"> size</span> =<span class="title"> awk</span> &#x27;$0~/PageTables/&#123;print $<span class="number">2</span><span class="string">&quot; KiB&quot;</span>&#125;&#x27; /<span class="keyword">proc</span>/meminfo</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://www.361way.com/whereis-the-memory/4036.html">多出的这部分内存是我们在计算rss内存时算重复了。因为rss内存包括我们使用的各种库和so等共享的模块。具体可以使用pmap指令查看详细的每个进程调用的lib库及已用内存值</a></p>
<p>show the info by smem</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ smem -u</span><br><span class="line">User     Count     Swap      USS      PSS      RSS</span><br><span class="line">chrony       1        0      584      621     1316</span><br><span class="line">rpc          1        0      604      633     1120</span><br><span class="line">...</span><br><span class="line">$ smem -m</span><br><span class="line">$ smem -w</span><br><span class="line">$ smem -t</span><br><span class="line">$ smem -c <span class="string">&quot;name user pss&quot;</span></span><br><span class="line">$ smem --bar <span class="variable">$pid</span> -c <span class="string">&quot;pss uss&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Kernel-Memory-Leak-Detector"><a href="#Kernel-Memory-Leak-Detector" class="headerlink" title="Kernel Memory Leak Detector"></a><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/dev-tools/kmemleak.html">Kernel Memory Leak Detector</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe kmemleak-test</span><br><span class="line">$ <span class="built_in">echo</span> scan &gt; /sys/kernel/debug/kmemleak</span><br><span class="line">$ cat /sys/kernel/debug/kmemleak</span><br><span class="line"></span><br><span class="line"><span class="comment">## centos not enabled by defualt</span></span><br><span class="line">$ grep CONFIG_DEBUG_KMEMLEAK /boot/config-4.18.0-305.el8.x86_64</span><br><span class="line">$ CONFIG_DEBUG_KMEMLEAK is not <span class="built_in">set</span></span><br></pre></td></tr></table></figure>

<h3 id="zram"><a href="#zram" class="headerlink" title="zram"></a><a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/zram.html">zram</a></h3><p>CentOS 7 only work for lzo and the performance was not good enough  </p>
<h4 id="zram-info"><a href="#zram-info" class="headerlink" title="zram.info"></a><a target="_blank" rel="noopener" href="https://gist.github.com/zouppen/6886178">zram.info</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> lz4 &gt; /sys/block/zram0/comp_algorithm</span><br><span class="line">-bash: <span class="built_in">echo</span>: write error: Invalid argument</span><br><span class="line">$ cat /sys/block/zram0/comp_algorithm</span><br><span class="line">[lzo]</span><br><span class="line"></span><br><span class="line">$ modprobe zram num_devices=2</span><br><span class="line">$ <span class="built_in">echo</span> 8589934592 &gt; /sys/block/zram0/disksize</span><br><span class="line">$ <span class="built_in">echo</span> 8589934592 &gt; /sys/block/zram1/disksize</span><br><span class="line">$ swapoff -a</span><br><span class="line">$ mkswap /dev/zram0</span><br><span class="line">$ mkswap /dev/zram1</span><br><span class="line">$ swapon /dev/zram0 /dev/zram1</span><br><span class="line"></span><br><span class="line">or </span><br><span class="line">$ modprobe zram num_devices=1</span><br><span class="line">$ <span class="built_in">echo</span> 68719476736 &gt; /sys/block/zram0/disksize</span><br><span class="line">$ mkfs.ext4 /dev/zram0</span><br><span class="line">$ tune2fs -m0 /dev/zram0</span><br><span class="line">tune2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Setting reserved blocks percentage to 0% (0 blocks)</span><br><span class="line"><span class="comment">## no compression function</span></span><br><span class="line">$ zpool create -o ashift=0 -o multihost=off -O compression=zstd -O primarycache=none -O secondarycache=none tank /dev/zram0</span><br><span class="line"></span><br><span class="line">$ sh zram.info</span><br><span class="line">Physical memory:     134,928,179,200 bytes</span><br><span class="line">Buffers and cache:       812,810,240 bytes /  0.6% of physical memory</span><br><span class="line">Unallocated:             825,503,744 bytes /  0.6% of physical memory</span><br><span class="line">Compressed:           19,495,145,472 bytes / 14.4% of physical memory</span><br><span class="line">Decompressed size:    33,168,183,296 bytes / 22.3% of decompressed memory</span><br><span class="line">Compression ratio: 1.701</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh -eu</span></span><br><span class="line"></span><br><span class="line">TOTAL_DATA=0</span><br><span class="line">TOTAL_COMP=0</span><br><span class="line">HAS_ZRAM=</span><br><span class="line"></span><br><span class="line"><span class="comment"># Iterate through swap devices searching for compressed ones</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> NAME _; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Filter zram swaps and let&#x27;s hope your ordinary swap doesn&#x27;t have</span></span><br><span class="line">    <span class="comment"># &quot;zram&quot; in its name :D</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$NAME</span> <span class="keyword">in</span></span><br><span class="line">	*zram*) ;;</span><br><span class="line">	*) <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    DIR=/sys`udevadm info --query=path --name=<span class="variable">$NAME</span>`</span><br><span class="line">    DATA=$(awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="variable">$DIR</span>/mm_stat)</span><br><span class="line">    COMP=$(awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> <span class="variable">$DIR</span>/mm_stat)</span><br><span class="line">    TOTAL_DATA=$((TOTAL_DATA + DATA))</span><br><span class="line">    TOTAL_COMP=$((TOTAL_COMP + COMP))</span><br><span class="line">    HAS_ZRAM=1</span><br><span class="line"><span class="keyword">done</span> &lt;/proc/swaps</span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract physical memory in kibibytes and scale back to bytes</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span> _ MEM_KIB _</span><br><span class="line">    <span class="built_in">read</span> _ FREE_KIB _</span><br><span class="line">    <span class="built_in">read</span> _ BUF_KIB _</span><br><span class="line">    <span class="built_in">read</span> _ CACHE_KIB _</span><br><span class="line">&#125; &lt;/proc/meminfo</span><br><span class="line"></span><br><span class="line">/usr/bin/<span class="built_in">printf</span> <span class="string">&quot;\</span></span><br><span class="line"><span class="string">Physical memory:   %&#x27;17d bytes</span></span><br><span class="line"><span class="string">Buffers and cache: %&#x27;17d bytes / %4.1f%% of physical memory</span></span><br><span class="line"><span class="string">Unallocated:       %&#x27;17d bytes / %4.1f%% of physical memory</span></span><br><span class="line"><span class="string">&quot;</span> `<span class="built_in">echo</span> <span class="string">&quot;scale=6; 1024*<span class="variable">$MEM_KIB</span>; 1024*(<span class="variable">$BUF_KIB</span>+<span class="variable">$CACHE_KIB</span>); 100*(<span class="variable">$BUF_KIB</span>+<span class="variable">$CACHE_KIB</span>)/<span class="variable">$MEM_KIB</span>; 1024*<span class="variable">$FREE_KIB</span>; 100*<span class="variable">$FREE_KIB</span>/<span class="variable">$MEM_KIB</span>&quot;</span>|bc`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$HAS_ZRAM</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/<span class="built_in">printf</span> <span class="string">&quot;\</span></span><br><span class="line"><span class="string">Compressed:        %&#x27;17d bytes / %4.1f%% of physical memory</span></span><br><span class="line"><span class="string">Decompressed size: %&#x27;17d bytes / %4.1f%% of decompressed memory</span></span><br><span class="line"><span class="string">Compression ratio: %.3f</span></span><br><span class="line"><span class="string">&quot;</span> `<span class="built_in">echo</span> <span class="string">&quot;scale=6; <span class="variable">$TOTAL_COMP</span>; 100*<span class="variable">$TOTAL_COMP</span>/<span class="variable">$MEM_KIB</span>/1024; <span class="variable">$TOTAL_DATA</span>; 100*<span class="variable">$TOTAL_DATA</span>/(1024*<span class="variable">$MEM_KIB</span>-<span class="variable">$TOTAL_COMP</span>+<span class="variable">$TOTAL_DATA</span>); <span class="variable">$TOTAL_DATA</span>/<span class="variable">$TOTAL_COMP</span>&quot;</span>|bc`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Compressed:                        0 bytes / zram not in use&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="CentOS-default-memory-setting-cause-issue"><a href="#CentOS-default-memory-setting-cause-issue" class="headerlink" title="CentOS default memory setting cause issue"></a>CentOS default memory setting cause issue</h3><p>####<a target="_blank" rel="noopener" href="http://lkml.iu.edu/hypermail/linux/kernel/1904.0/03600.html">nfs hang</a><br>Looks like the min_free_kbytes too low cause ther is no responding in linux kernel and Some reports not in the memory exhaust case.<br>after you setting the mini_free_kbytes, the issue has gone. it ‘s hard to get system log, when you run the dmesg command will hang too.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vm.min_free_kbytes=540672</span><br><span class="line">vm.swappiness=5</span><br><span class="line"></span><br><span class="line">min_free_kbytes:</span><br><span class="line">This is used to force the Linux VM to keep a minimum number of kilobytes free.  The VM uses this number to compute a watermark[WMARK_MIN] value <span class="keyword">for</span> each lowmem zone <span class="keyword">in</span> the system. Each lowmem zone gets a number of reserved free pages based proportionally on its size.</span><br><span class="line"></span><br><span class="line">Some minimal amount of memory is needed to satisfy PF_MEMALLOC allocations; <span class="keyword">if</span> you <span class="built_in">set</span> this to lower than 1024KB, your system will become subtly broken, and prone to deadlock under high loads.</span><br><span class="line">Setting this too high will OOM your machine instantly.</span><br></pre></td></tr></table></figure>
<p>(PFMEMALLOC)PF_MEMALLOC means don ‘t care the min watermark = ALLOC_NO_WATERMARK</p>
<h3 id="Make-sure-the-ECC-work-in-Linux"><a href="#Make-sure-the-ECC-work-in-Linux" class="headerlink" title="Make sure the ECC work in Linux"></a>Make sure the ECC work in Linux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmidecode -t memory  | grep -Ei <span class="string">&#x27;error correction type&#x27;</span></span><br><span class="line">	Error Correction Type: Single-bit ECC</span><br><span class="line">$ dmidecode -t memory  | grep -Ei <span class="string">&#x27;error correction type&#x27;</span></span><br><span class="line">	Error Correction Type: Multi-bit ECC</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="Monitor-ECC-error"><a href="#Monitor-ECC-error" class="headerlink" title="Monitor ECC error"></a>Monitor ECC error</h3><h4 id="From-OS"><a href="#From-OS" class="headerlink" title="From OS"></a>From OS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Intel x86 scalable</span></span><br><span class="line">skx_edac</span><br><span class="line"></span><br><span class="line"><span class="comment">#Intel x86 E3</span></span><br><span class="line">ie31200-edac</span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers are loaded. 1 MC detected:</span><br><span class="line">  mc0:IE31200</span><br><span class="line"></span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers loaded. No memory controllers found</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ edac-util -v</span><br><span class="line">mc0: 0 Uncorrected Errors with no DIMM info</span><br><span class="line">mc0: 0 Corrected Errors with no DIMM info</span><br><span class="line">mc0: csrow0: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow0: mc<span class="comment">#0csrow#0channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow0: mc<span class="comment">#0csrow#0channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow1: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow1: mc<span class="comment">#0csrow#1channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow1: mc<span class="comment">#0csrow#1channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow2: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow2: mc<span class="comment">#0csrow#2channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow2: mc<span class="comment">#0csrow#2channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow3: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow3: mc<span class="comment">#0csrow#3channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow3: mc<span class="comment">#0csrow#3channel#1: 0 Corrected Errors</span></span><br><span class="line">edac-util: No errors to report.</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 7.7 not support Xeon E2000, the kernel merge the patch at 2019-06, maybe wait CentOS 7.8</span></span><br><span class="line"><span class="comment">#Intel x86 E2000</span></span><br><span class="line">ie31200-edac</span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers loaded. No memory controllers found</span><br></pre></td></tr></table></figure>
<h4 id="From-IPMI"><a href="#From-IPMI" class="headerlink" title="From IPMI"></a>From IPMI</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool sel elist</span><br></pre></td></tr></table></figure>

<h3 id="NIC-page-allocation-failure"><a href="#NIC-page-allocation-failure" class="headerlink" title="NIC page allocation failure"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/641323">NIC page allocation failure</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">[Mon Jul  2 10:38:25 2018] swapper/16: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Mon Jul  2 10:38:25 2018] CPU: 16 PID: 0 Comm: swapper/16 Tainted: P           OE  ------------   3.10.0-693.5.2.el7_lustre.x86_64 <span class="comment">#1</span></span><br><span class="line">[Mon Jul  2 10:38:25 2018] Hardware name: Dell Inc. PowerEdge R730/072T6D, BIOS 2.4.3 01/17/2017</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  0000000000104020 7e870b98ec876be5 ffff88103e8039d8 ffffffff816a3e2d</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  ffff88103e803a68 ffffffff81188820 0000000000000246 ffff88103e803a28</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  fffffffffffffffc 0010402000000000 ffff88107ffdb018 7e870b98ec876be5</span><br><span class="line">[Mon Jul  2 10:38:25 2018] Call Trace:</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  &lt;IRQ&gt;  [&lt;ffffffff816a3e2d&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81188820&gt;] warn_alloc_failed+0x110/0x180</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8169fe2a&gt;] __alloc_pages_slowpath+0x6b6/0x724</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8118cdb5&gt;] __alloc_pages_nodemask+0x405/0x420</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffffc031abba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffffc031ba97&gt;] bnx2x_rx_int+0x227/0x17c0 [bnx2x]</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81573004&gt;] ? consume_skb+0x34/0x80</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81585dad&gt;] ? __dev_kfree_skb_any+0x3d/0x50</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffffc031eecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  &lt;EOI&gt;  [&lt;ffffffff816ab546&gt;] ? native_safe_halt+0x6/0x10</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816ab3de&gt;] default_idle+0x1e/0xc0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81035006&gt;] arch_cpu_idle+0x26/0x30</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line"></span><br><span class="line"><span class="comment"># in my case </span></span><br><span class="line">[Thu Jul 12 04:23:16 2018]  00000000ad5e4ed1</span><br><span class="line">[Thu Jul 12 04:23:16 2018] Call Trace:</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  ffff88103e643a20 ffffffff81188820</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;IRQ&gt;</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  00000000000000c3</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816a3e2d&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  0000000000000282</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81188820&gt;] warn_alloc_failed+0x110/0x180</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  fffffffffffffffc 0010402000000000</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  ffff8816385ea000 66b8573252d2c8c3</span><br><span class="line">[Thu Jul 12 04:23:16 2018] Call Trace:</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;IRQ&gt;  [&lt;ffffffff816a3e2d&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8169fe2a&gt;] __alloc_pages_slowpath+0x6b6/0x724</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81188820&gt;] warn_alloc_failed+0x110/0x180</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8169fe2a&gt;] __alloc_pages_slowpath+0x6b6/0x724</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118cdb5&gt;] __alloc_pages_nodemask+0x405/0x420</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] ? __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118cdb5&gt;] __alloc_pages_nodemask+0x405/0x420</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810d1c02&gt;] ? load_balance+0x192/0x9a0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810d1bd2&gt;] ? load_balance+0x162/0x9a0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81573004&gt;] ? consume_skb+0x34/0x80</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81585dad&gt;] ? __dev_kfree_skb_any+0x3d/0x50</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f95c2&gt;] ? bnx2x_free_tx_pkt+0x1f2/0x2d0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f0062&gt;] ? bnx2x_test_link+0x42/0x270 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] ? __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527d42&gt;] ? cpuidle_enter_state+0x52/0xc0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527e88&gt;] cpuidle_idle_call+0xd8/0x210</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81034fee&gt;] arch_cpu_idle+0xe/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810d1c02&gt;] ? load_balance+0x192/0x9a0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527d42&gt;] ? cpuidle_enter_state+0x52/0xc0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527e88&gt;] cpuidle_idle_call+0xd8/0x210</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;  [&lt;ffffffff81527d42&gt;] ? cpuidle_enter_state+0x52/0xc0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527e88&gt;] cpuidle_idle_call+0xd8/0x210</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81034fee&gt;] arch_cpu_idle+0xe/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81034fee&gt;] arch_cpu_idle+0xe/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;  [&lt;ffffffff811a3178&gt;] ? fragmentation_index+0x38/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811a877b&gt;] compaction_suitable+0x5b/0xb0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81199102&gt;] balance_pgdat+0x502/0x5e0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81199353&gt;] kswapd+0x173/0x440</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b1920&gt;] ? wake_up_atomic_t+0x30/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811991e0&gt;] ? balance_pgdat+0x5e0/0x5e0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b099f&gt;] kthread+0xcf/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b08d0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b4fd8&gt;] ret_from_fork+0x58/0x90</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b08d0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018] swapper/32: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Thu Jul 12 04:23:16 2018] CPU: 32 PID: 0 Comm: swapper/32 Tainted: P           OE  ------------   3.10.0-693.5.2.el7_lustre.x86_64 <span class="comment">#1</span></span><br><span class="line">[Thu Jul 12 04:23:16 2018] Hardware name: Dell Inc. PowerEdge R730/072T6D, BIOS 2.4.3 01/17/2017</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  0000000000104020 1fc54c56797ed550 ffff88103ea03990 ffffffff816a3e2d</span><br><span class="line">[Thu Jul 12 04:23:16 2018] swapper/12: page allocation failure: order:2, mode:0x104020</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can see a lot of processes could not allocation memory</span></span><br><span class="line">[Fri Aug 16 06:08:22 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] swapper/10: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/16: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/16: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/4: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/4: page allocation failure: order:2, mode:0x104020</span><br></pre></td></tr></table></figure>
<p>zone_reclaim_mode<br>sysctl -w vm.zone_reclaim_mode=1<br>This can be set to 1 to attempt reclamation of memory within a NUMA node before reclaiming from other NUMA nodes.<br>and it’s removed from the latest kernel, only exist in centos7   </p>
<p>Zone_reclaim_mode allows someone to set more or less aggressive approaches to reclaim memory when a zone runs out of memory. If it is set to zero then no zone reclaim occurs. Allocations will be satisfied from other zones / nodes in the system.<br>This is value ORed together of<br>1(1)= Zone reclaim on<br>2(10)= Zone reclaim writes dirty pages out<br>4(100)= Zone reclaim swaps pages<br>Only work for the three bit    </p>
<p><code>min_free_kbytes</code> (it ‘s worked, the page allocation failure was missing)<br>sysctl -w vm.min_free_kbytes = 540672<br>#Increase the virtual memory kernel tunable vm.min_free_kbytes, which instructs the virtual memory subsystem to try keep a certain amount of memory always free for allocation.<br>#And This parameter modified, the swap usage decrease right now</p>
<p>The network driver is receiving traffic from the network adapter into kernel memory, however when the driver tried to allocate memory, the allocation failed.</p>
<p>Kernel memory is required to be a contiguous block of a certain size. The kernel memory may be all consumed or fragmented, hence why a contiguous block could not be allocated.</p>
<p>Tuning of the system’s use of kernel memory is required to ensure the kernel can always service kernel memory allocations when running in interrupt context.</p>
<p>kswapd high cpu usage in some of not enough memory case<br>reslove the issue temporary</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sar -rB 2 <span class="comment"># check system vm status</span></span><br><span class="line"></span><br><span class="line">sar -r 2 </span><br><span class="line">               ------------------free --&gt; malloc --&gt; release or reclaim</span><br><span class="line">               |</span><br><span class="line">03:32:14 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">03:32:26 PM 122884328   8881472      6.74      1968     68528 118503440     88.53   5951984     60828         4</span><br><span class="line">03:33:22 PM  29706588 102059212     77.46      1968     75940 118507844     88.53  98904256     67008         0</span><br><span class="line">03:33:30 PM 128777516   2988284      2.27      1968     75940    282000      0.21     63112     66988         0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/compact_memory</span><br></pre></td></tr></table></figure>

<p>reduce memory compaction ratio<br>echo 1000 &gt;  /proc/sys/vm/extfrag_threshold # 0~1000 ,1000 means the minimum trigger memory compaction operation, it means kernel memory is required to be a contiguous block of a certain size. The kernel memory may be all consumed or fragmented, hence why a contiguous block could not be allocated.</p>
<p>Some times there are a lot of free memory in your system. But I ‘m not sure the sk_buffer to malloc memroy range from the linux kernel when the NIC driver tirgger the issue.</p>
<h4 id="dirty-page"><a href="#dirty-page" class="headerlink" title="dirty page"></a>dirty page</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sysctl -a | grep dirty</span><br><span class="line">vm.dirty_background_bytes = 0</span><br><span class="line">vm.dirty_background_ratio = 10</span><br><span class="line">vm.dirty_bytes = 0</span><br><span class="line">vm.dirty_expire_centisecs = 3000</span><br><span class="line">vm.dirty_ratio = 20</span><br><span class="line">vm.dirty_writeback_centisecs = 500</span><br></pre></td></tr></table></figure>


<h3 id="ZRAM"><a href="#ZRAM" class="headerlink" title="ZRAM"></a><a target="_blank" rel="noopener" href="http://liujunming.top/2016/07/04/Linux%E5%86%85%E6%A0%B8%E4%B8%ADzram%E6%A8%A1%E5%9D%97%E7%9A%84%E7%90%86%E8%A7%A3/">ZRAM</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">description <span class="string">&quot;Initializes zram swaping&quot;</span></span><br><span class="line">start on runlevel [2345]</span><br><span class="line">stop on runlevel [!2345]</span><br><span class="line">pre-start script</span><br><span class="line"><span class="comment"># load dependency modules</span></span><br><span class="line">modprobe zram num_devices=2</span><br><span class="line"><span class="comment"># initialize the devices</span></span><br><span class="line"><span class="built_in">echo</span> 1073741824 &gt; /sys/block/zram0/disksize</span><br><span class="line"><span class="built_in">echo</span> 1073741824 &gt; /sys/block/zram1/disksize</span><br><span class="line"><span class="comment"># Creating swap filesystems</span></span><br><span class="line">mkswap /dev/zram0</span><br><span class="line">mkswap /dev/zram1</span><br><span class="line"><span class="comment"># Switch the swaps on</span></span><br><span class="line">swapon -p 5 /dev/zram0</span><br><span class="line">swapon -p 5 /dev/zram1</span><br><span class="line">end script</span><br><span class="line">post-stop script</span><br><span class="line"><span class="comment"># Switching off swap</span></span><br><span class="line">swapoff /dev/zram0</span><br><span class="line">swapoff /dev/zram1</span><br><span class="line">rmmod zram</span><br><span class="line">end script</span><br><span class="line"></span><br><span class="line"><span class="comment">##test zram</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;  </span></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	//<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, sizeof(int));</span><br><span class="line">	int  *mem;</span><br><span class="line">	int i, size;</span><br><span class="line">	size = 0x70000000;</span><br><span class="line">	mem = (int*)malloc(size*sizeof(int));</span><br><span class="line">	<span class="keyword">for</span>(i = 0; i &lt; size; i++)</span><br><span class="line">		mem[i] = (i%1024);</span><br><span class="line">	getchar();</span><br><span class="line">	free(mem);</span><br><span class="line">	<span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Some-parameter-about-numa"><a href="#Some-parameter-about-numa" class="headerlink" title="Some parameter about numa"></a>Some parameter about numa</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">numactl --interleave=all <span class="comment">#Two/Four socket CPU will share all memory, but you can&#x27; t got the best performance except you need more memory</span></span><br><span class="line">vm.zone_reclaim_mode = 0  <span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> -15 &gt; /proc/&lt;pid&gt;/oom_adj <span class="comment">#reduce kill ratio	</span></span><br><span class="line">huge page will not be swaped</span><br></pre></td></tr></table></figure>

<h3 id="Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage"><a href="#Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage" class="headerlink" title="Soft lockup detected on a large NUMA system under a heavy memory usage"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/1560893">Soft lockup detected on a large NUMA system under a heavy memory usage</a></h3><p>Systems with numa factor lower than or equal to 30 may hang under the high load.<br>Soft lockup detected under a heavy memory pressure on a large NUMA system.</p>
<p>For RHEL 7, users must be aware of the following steps that can avoid the soft lockup from occurring. Disable Transparent Huge Page (THP) to avoid such busy memory-compaction, and add “numa_balancing=disable” to the kernel parameter followed by reboot, OR set /proc/sys/vm/zone_reclaim_mode to 1.<br>For RHEL 6,<br>disable Transparent Huge Page (THP) to avoid such busy memory-compaction OR set /proc/sys/vm/zone_reclaim_mode to 1.</p>
<p>The default value(zero) of /proc/sys/vm/zone_reclaim_mode results in the CPUs running on the memory exhausted nodes to skip over to the next node with available memory to attempt the memory allocation.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">kernel: BUG: soft lockup - CPU<span class="comment">#102 stuck for 22s! [forkoff:235364]</span></span><br><span class="line">kernel: Modules linked <span class="keyword">in</span>: fuse btrfs zlib_deflate raid6_pq xor msdos ext4</span><br><span class="line">mbcache jbd2 binfmt_misc xt_CHECKSUM iptable_mangle ipt_MASQUERADE</span><br><span class="line">nf_nat_masquerade_ipv4 iptable_nat nf_nat_ipv4 nf_nat nf_conntrack_ipv4</span><br><span class="line">nf_defrag_ipv4 xt_conntrack nf_conntrack ipt_REJECT iptable_filter ip_tables</span><br><span class="line">tun bridge stp llc dm_mirror dm_region_hash dm_log dm_mod iTCO_wdt</span><br><span class="line">iTCO_vendor_support vfat fat intel_powerclamp coretemp intel_rapl kvm_intel</span><br><span class="line">kvm crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel</span><br><span class="line">lrw gf128mul glue_helper ablk_helper cryptd pcspkr sb_edac edac_core lpc_ich</span><br><span class="line">i2c_i801 mfd_core shpchp ipmi_si ipmi_msghandler tpm_infineon nls_utf8 isofs</span><br><span class="line">loop uinput xfs libcrc32c sd_mod crc_t10dif crct10dif_common mgag200</span><br><span class="line">syscopyarea sysfillrect sysimgblt drm_kms_helper igb qla2xxx e1000e</span><br><span class="line">kernel: ttm dca ptp scsi_transport_fc drm i2c_algo_bit pps_core scsi_tgt</span><br><span class="line">megaraid_sas i2c_core</span><br><span class="line">kernel: CPU: 102 PID: 235364 Comm: forkoff Not tainted 3.10.0-229.el7.x86_64</span><br><span class="line"><span class="comment">#1                                                                                                                                                                                                                                                                             </span></span><br><span class="line">kernel:</span><br><span class="line">kernel: task: ffff911d25eea220 ti: ffff927835154000 task.ti: ffff927835154000</span><br><span class="line">kernel: RIP: 0010:[&lt;ffffffff811798ef&gt;]  [&lt;ffffffff811798ef&gt;]</span><br><span class="line">isolate_freepages_block+0xaf/0x380</span><br><span class="line">kernel: RSP: 0000:ffff927835157860  EFLAGS: 00000286</span><br><span class="line">kernel: RAX: 00000000ffffffff RBX: 00000014e4b60000 RCX: ffff927835157aa8</span><br><span class="line">kernel: RDX: 0000000053345c00 RSI: 0000000053345a00 RDI: ffff927835157a50</span><br><span class="line">kernel: RBP: ffff9278351578f8 R08: 0000000000000000 R09: ffff8e007ffda000</span><br><span class="line">kernel: R10: 00000014cd168000 R11: 0000000060080000 R12: 0000000000000301</span><br><span class="line">kernel: R13: ffff927835157850 R14: 0000000000000000 R15: 00007f4501f64000</span><br><span class="line">kernel: FS:  00007f4f4d540740(0000) GS:ffff90fa7f9a0000(0000)</span><br><span class="line">knlGS:0000000000000000</span><br><span class="line">kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">kernel: CR2: 00007f4690400000 CR3: 000009baa7060000 CR4: 00000000001407e0</span><br><span class="line">kernel: DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000</span><br><span class="line">kernel: DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400</span><br><span class="line">kernel: Stack:</span><br><span class="line">kernel: ffffea2a02311040 0000000060080000 0000000000000094 ffff927835157948</span><br><span class="line">kernel: 0000000053345a00 ffff927835157a50 000000004808ec38 00ff8e0000000000</span><br><span class="line">kernel: ffff927835157a90 ffff927835157aa8 ffff927835157a50 ffff8e007ffad000</span><br><span class="line">kernel: Call Trace:</span><br><span class="line">kernel: [&lt;ffffffff81179d8f&gt;] compaction_alloc+0x1cf/0x240</span><br><span class="line">kernel: [&lt;ffffffff811b15ce&gt;] migrate_pages+0xce/0x610</span><br><span class="line">kernel: [&lt;ffffffff81179bc0&gt;] ? isolate_freepages_block+0x380/0x380</span><br><span class="line">kernel: [&lt;ffffffff8117abb9&gt;] compact_zone+0x299/0x400</span><br><span class="line">kernel: [&lt;ffffffff8117adbc&gt;] compact_zone_order+0x9c/0xf0</span><br><span class="line">kernel: [&lt;ffffffff8117b171&gt;] try_to_compact_pages+0x121/0x1a0</span><br><span class="line">kernel: [&lt;ffffffff815ff336&gt;] __alloc_pages_direct_compact+0xac/0x196</span><br><span class="line">kernel: [&lt;ffffffff81160758&gt;] __alloc_pages_nodemask+0x788/0xb90</span><br><span class="line">kernel: [&lt;ffffffff810b11c0&gt;] ? task_numa_fault+0x8d0/0xbb0</span><br><span class="line">kernel: [&lt;ffffffff811a24aa&gt;] alloc_pages_vma+0x9a/0x140</span><br><span class="line">kernel: [&lt;ffffffff811b674b&gt;] do_huge_pmd_anonymous_page+0x10b/0x410</span><br><span class="line">kernel: [&lt;ffffffff81182334&gt;] handle_mm_fault+0x184/0xd60</span><br><span class="line">kernel: [&lt;ffffffff8160f1e6&gt;] __do_page_fault+0x156/0x520</span><br><span class="line">kernel: [&lt;ffffffff8118a945&gt;] ? change_protection+0x65/0xa0</span><br><span class="line">kernel: [&lt;ffffffff811a0dbb&gt;] ? change_prot_numa+0x1b/0x40</span><br><span class="line">kernel: [&lt;ffffffff810adb86&gt;] ? task_numa_work+0x266/0x300</span><br><span class="line">kernel: [&lt;ffffffff8160f5ca&gt;] do_page_fault+0x1a/0x70</span><br><span class="line">kernel: [&lt;ffffffff81013b0c&gt;] ? do_notify_resume+0x9c/0xb0</span><br><span class="line">kernel: [&lt;ffffffff8160b808&gt;] page_fault+0x28/0x30</span><br><span class="line">kernel: Code: 89 ee 48 89 4d b0 41 89 c5 eb 1d 90 49 83 c7 01 48 83 c3 40 4d</span><br><span class="line">39 <span class="built_in">fc</span> 0f 86 07 01 00 00 41 83 c5 01 4d 85 f6 4c 0f 44 f3 8b 43 18 &lt;83&gt; f8 80</span><br><span class="line">75 dc 48 8b 45 b8 0f b6 55 c0 48 8d 75 c8 4c 8b 45 b0</span><br></pre></td></tr></table></figure>

<h3 id="Transparent-Huge-Page"><a href="#Transparent-Huge-Page" class="headerlink" title="Transparent Huge Page"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/46111">Transparent Huge Page</a></h3><p>The transparent Huge Page implementation in the Linux kernel includes functionality that provides compaction. Compaction operations are system level processes that are resource intensive</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Enable or disable</span></span><br><span class="line">$ cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[always] madvise never</span><br><span class="line">$ cat /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line">[always] madvise never</span><br><span class="line"></span><br><span class="line">$ grep AnonHugePages /proc/meminfo</span><br><span class="line">AnonHugePages:  19523584 kB</span><br><span class="line"></span><br><span class="line">$ cat /proc/meminfo|grep Huge</span><br><span class="line">AnonHugePages:  1681086464 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line"></span><br><span class="line"><span class="comment">## means 1681086464/2048 = 820843x 2MB huge pages</span></span><br><span class="line"></span><br><span class="line">$ grep -Ei <span class="string">&#x27;trans|thp&#x27;</span> /proc/vmstat</span><br><span class="line">nr_anon_transparent_hugepages 9533</span><br><span class="line">thp_fault_alloc 24017</span><br><span class="line">thp_fault_fallback 16231</span><br><span class="line">thp_collapse_alloc 1687</span><br><span class="line">thp_collapse_alloc_failed 39449</span><br><span class="line">thp_split 2926</span><br><span class="line">thp_zero_page_alloc 1</span><br><span class="line">thp_zero_page_alloc_failed 0</span><br><span class="line"></span><br><span class="line"><span class="comment">### check the process</span></span><br><span class="line">$ grep -e AnonHugePages  /proc/*/smaps | awk -F <span class="string">&#x27;[/ ]+&#x27;</span> <span class="string">&#x27;$(NF-1)&gt;4 &#123;system(&quot;ps -fp  &quot;$3)&#125;&#x27;</span></span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">nobody    5023  5016  3 Jun07 ?        22:28:27 /sbin/lustre_exporter --collector.ost=disabled --collector.mdt=core</span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">polkitd    743     1  0 Jun07 ?        00:00:19 /usr/lib/polkit-1/polkitd --no-debug</span><br></pre></td></tr></table></figure>


<h3 id="Single-process-memory"><a href="#Single-process-memory" class="headerlink" title="Single process memory"></a>Single process memory</h3><pre><code>   /proc/[pid]/statm
          Provides information about memory usage, measured in pages.
          The columns are:

              size       (1) total program size
                         (same as VmSize in /proc/[pid]/status)
              resident   (2) resident set size
                         (same as VmRSS in /proc/[pid]/status)
              shared     (3) number of resident shared pages (i.e., backed by a file)
                         (same as RssFile+RssShmem in /proc/[pid]/status)
              text       (4) text (code)
              lib        (5) library (unused since Linux 2.6; always 0)
              data       (6) data + stack
              dt         (7) dirty pages (unused since Linux 2.6; always 0)</code></pre>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/3760/statm</span><br><span class="line">400865 96456 37653 27355 0 157019 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Second field means res (resident)<br>pmap $(pgrep bash)</p>
<p>There are some of share library in each resident</p>
<p>If you want get share library memory consumption.<br>/proc/[pid]/smaps (since Linux 2.6.14)<br>              This file shows memory consumption for each of the process’s<br>              mappings.  (The pmap(1) command displays similar information,<br>              in a form that may be easier for parsing.)</p>
<h4 id="Slab"><a href="#Slab" class="headerlink" title="Slab"></a>Slab</h4><p>In-kernel data structures cache.</p>
<p>Cache pool for often userd dupulication objects<br>you could found these objects from slabtop</p>
<p>Get all slabsize<br>awk ‘BEGIN{sum=0;}{sum=sum+$3*$4;}END{print sum/1024/1024}’ /proc/slabinfo MB</p>
<h4 id="Page-table"><a href="#Page-table" class="headerlink" title="Page table"></a>Page table</h4><p>awk ‘$0~/PageTables/ {print $2}’ /proc/meminfo KB</p>
<h4 id="Struct-page"><a href="#Struct-page" class="headerlink" title="Struct page"></a>Struct page</h4><p>page frame minimum unit. every page frame has a struct page to point<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34836806/how-to-get-physical-address-from-struct-page-in-linux-kernel">struct page could mapping page frame to physical address</a><br>all page frame in the LUR list.<br>There are 2.3%(96/4096) usage in linux 2.6.32</p>
<h3 id="Use-hugetlbfs"><a href="#Use-hugetlbfs" class="headerlink" title="Use hugetlbfs"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/tuning_and_optimizing_red_hat_enterprise_linux_for_oracle_9i_and_10g_databases/sect-oracle_9i_and_10g_tuning_guide-large_memory_optimization_big_pages_and_huge_pages-configuring_huge_pages_in_red_hat_enterprise_linux_4_or_5">Use hugetlbfs</a></h3><h4 id="set-hugepage"><a href="#set-hugepage" class="headerlink" title="set hugepage"></a><a target="_blank" rel="noopener" href="https://paolozaino.wordpress.com/2016/10/02/how-to-force-any-linux-application-to-use-hugepages-without-modifying-the-source-code/">set hugepage</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install libhugetlbfs-utils libhugetlbfs</span><br><span class="line"><span class="comment"># To set the 2MB pool minimum to 512 pages:</span></span><br><span class="line">$ hugeadm --pool-pages-min 2MB:512</span><br><span class="line">$ hugeadm --pool-pages-max 2MB:2048</span><br><span class="line">$ hugeadm --pool-list</span><br><span class="line"></span><br><span class="line">$ mkdir -p /mnt/hugetlbfs-64K</span><br><span class="line">$ mount -t hugetlbfs none -opagesize=64k /mnt/hugetlbfs-64K</span><br><span class="line">or </span><br><span class="line">$ mount -t hugetlbfs none /mnt/hugetlbfs -o uid=postfix -o gid=postfix</span><br><span class="line">$ hugeadm --set-recommended-shmmax</span><br><span class="line">$ hugeadm --explain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ LD_PRELOAD=libhugetlbfs.so HUGETLB_MORECORE=yes ./run_your_cmd</span><br><span class="line"><span class="comment">## looks like it &#x27;s ok</span></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">31723 root      20   0  642.7g  94996   1348 S  1734  0.0 101:41.53 ./ft.E.x</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ grep Hugepagesize /proc/meminfo</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">$ <span class="built_in">echo</span> 512 &gt; /proc/sys/vm/nr_hugepages</span><br><span class="line">This means <span class="keyword">if</span> a 1GB Huge Pages pool should be allocated, <span class="keyword">then</span> 512 Huge Pages need to be allocated</span><br><span class="line">it <span class="string">&#x27;s the static huge page</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 1000 &gt; /proc/sys/vm/hugetlb_shm_group</span></span><br><span class="line"><span class="string">##means only members of group testuser(1000) can allocate &quot;huge&quot; Shared memory segment</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o uid=1000,gid=1000,mode=775,size=10g none /data/hugeshm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#kernel parameter, 4x1G, 1024x2M</span></span><br><span class="line"><span class="string">default_hugepagesz=1G hugepagesz=1G hugepages=4 hugepagesz=2M hugepages=1024</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o pagesize=1G none /dev/hugepages1G</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o pagesize=2M none /dev/hugepages2M</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 4 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"><span class="string">echo 1024 &gt; /sys/devices/system/node/node3/hugepages/hugepages-2048kB/nr_hugepages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/proc/sys/vm/nr_overcommit_hugepages</span></span><br><span class="line"><span class="string">Defines the maximum number of additional huge pages that can be created and used by the system through overcommitting memory. Writing any non-zero value into this file indicates that the system obtains that number of huge pages from the kernel&#x27;</span>s normal page pool <span class="keyword">if</span> the persistent huge page pool is exhausted. As these surplus huge pages become unused, they are <span class="keyword">then</span> freed and returned to the kernel<span class="string">&#x27;s normal page pool.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h4 id="memlock"><a href="#memlock" class="headerlink" title="memlock"></a>memlock</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oracle           soft    memlock         1048576</span><br><span class="line">oracle           hard    memlock         1048576</span><br></pre></td></tr></table></figure>
<p>The memlock parameter specifies how much memory the oracle user can lock into its address space. Note that Huge Pages are locked in physical memory. The memlock setting is specified in KB and must match the memory size of the number of Huge Pages that Oracle should be able to allocate. So if the Oracle database should be able to use 512 Huge Pages, then memlock must be set to at least 512 * Hugepagesize, which on this system would be 1048576 KB (512<em>1024</em>2). If memlock is too small, then no single Huge Page will be allocated when the Oracle database starts</p>
<h4 id="free-hugepage"><a href="#free-hugepage" class="headerlink" title="free hugepage"></a>free hugepage</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/vm/nr_hugepages</span><br></pre></td></tr></table></figure>

<h4 id="manage-tools"><a href="#manage-tools" class="headerlink" title="manage tools"></a>manage tools</h4><p>hugeadm</p>
<h4 id="reduce-OOM-kill-rate"><a href="#reduce-OOM-kill-rate" class="headerlink" title="reduce OOM kill rate"></a>reduce OOM kill rate</h4><p>echo -15 &gt; /proc/${pid}/oom_adj</p>
<h4 id="get-pagesize"><a href="#get-pagesize" class="headerlink" title="get pagesize"></a>get pagesize</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getconf PAGESIZE</span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<h3 id="enable-huge-page-for-performance"><a href="#enable-huge-page-for-performance" class="headerlink" title="enable huge page for performance"></a>enable huge page for performance</h3><ul>
<li>Hugepages is a feature that allows the Linux kernel to utilize the multiple page size capabilities of<br>modern hardware architectures.<ul>
<li>A page is the basic unit of virtual memory, with the default page size being 4 KB in the x86 architecture.</li>
</ul>
</li>
<li>Leave sufficient memory for OS use<ul>
<li>no longer subject to normal memory allocations</li>
</ul>
</li>
<li>Huge Pages are ‘pinned’ to physical RAM and cannot be swapped/paged out.<ul>
<li>Preference is for 1G hugepages.</li>
<li>Each hugepage requires a TLB entry. Smaller hugepages =&gt; more TLBs and TLB lookups due to page faults =&gt; higher probability of packet drop blips</li>
</ul>
</li>
</ul>
<p>hugepagesz<br>[HW,IA-64,PPC,X86-64] The size of the HugeTLB pages.<br>On x86-64 and powerpc, this option can be specified multiple times interleaved with hugepages= to reserve huge pages of different sizes. Valid pages sizes on x86-64 are 2M (when the CPU supports “pse”) and 1G (when the CPU supports the “pdpe1gb” cpuinfo flag).</p>
<p>hugepages<br>[HW,X86-32,IA-64] HugeTLB pages to allocate at boot.</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hugepagesz</span>=1G <span class="attribute">hugepages</span>=224</span><br></pre></td></tr></table></figure>

<h3 id="slab-exhaust-all-memory-because-a-lot-of-scan"><a href="#slab-exhaust-all-memory-because-a-lot-of-scan" class="headerlink" title="slab exhaust all memory because a lot of scan"></a>slab exhaust all memory because a lot of scan</h3><p>top<br><img src="/img/top-mem1.png"></p>
<p>Why Slab=24021820 kB (24GB)</p>
<p>slabtop<br><img src="/img/slabtop1.png"> </p>
<p>meminfo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">MemTotal:       32832340 kB</span><br><span class="line">MemFree:          829744 kB</span><br><span class="line">Buffers:           85096 kB</span><br><span class="line">Cached:          1895216 kB</span><br><span class="line">SwapCached:       164592 kB</span><br><span class="line">Active:          4572372 kB</span><br><span class="line">Inactive:        2520612 kB</span><br><span class="line">Active(anon):    4131784 kB</span><br><span class="line">Inactive(anon):   983612 kB</span><br><span class="line">Active(file):     440588 kB</span><br><span class="line">Inactive(file):  1537000 kB</span><br><span class="line">Unevictable:       25864 kB</span><br><span class="line">Mlocked:            9512 kB</span><br><span class="line">SwapTotal:       8191996 kB</span><br><span class="line">SwapFree:        5818864 kB</span><br><span class="line">Dirty:               120 kB</span><br><span class="line">Writeback:             0 kB</span><br><span class="line">AnonPages:       4974644 kB</span><br><span class="line">Mapped:            12584 kB</span><br><span class="line">Shmem:                36 kB</span><br><span class="line">Slab:           24021820 kB</span><br><span class="line">SReclaimable:   11202668 kB</span><br><span class="line">SUnreclaim:     12819152 kB</span><br><span class="line">KernelStack:       10624 kB</span><br><span class="line">PageTables:        38088 kB</span><br><span class="line">NFS_Unstable:          0 kB</span><br><span class="line">Bounce:                0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line">CommitLimit:    24608164 kB</span><br><span class="line">Committed_AS:    7777952 kB</span><br><span class="line">VmallocTotal:   34359738367 kB</span><br><span class="line">VmallocUsed:      413916 kB</span><br><span class="line">VmallocChunk:   34359269244 kB</span><br><span class="line">HardwareCorrupted:     0 kB</span><br><span class="line">AnonHugePages:     30720 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">DirectMap4k:        4096 kB</span><br><span class="line">DirectMap2M:     1957888 k</span><br></pre></td></tr></table></figure>

<h3 id="memmap"><a href="#memmap" class="headerlink" title="memmap"></a><a target="_blank" rel="noopener" href="https://docs.pmem.io/getting-started-guide/creating-development-environments/linux-environments/linux-memmap">memmap</a></h3><p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt">https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">memmap=exactmap	[KNL,X86] Enable setting of an exact</span><br><span class="line">			E820 memory map, as specified by the user.</span><br><span class="line">			Such memmap=exactmap lines can be constructed based on</span><br><span class="line">			BIOS output or other requirements. See the memmap=nn@ss</span><br><span class="line">			option description.</span><br><span class="line"></span><br><span class="line">	memmap=nn[KMG]@ss[KMG]</span><br><span class="line">			[KNL] Force usage of a specific region of memory.</span><br><span class="line">			Region of memory to be used is from ss to ss+nn.</span><br><span class="line">			If @ss[KMG] is omitted, it is equivalent to mem=nn[KMG],</span><br><span class="line">			<span class="built_in">which</span> limits max address to nn[KMG].</span><br><span class="line">			Multiple different regions can be specified,</span><br><span class="line">			comma delimited.</span><br><span class="line">			Example:</span><br><span class="line">				memmap=100M@2G,100M<span class="comment">#3G,1G!1024G</span></span><br><span class="line"></span><br><span class="line">	memmap=nn[KMG]<span class="comment">#ss[KMG]</span></span><br><span class="line">			[KNL,ACPI] Mark specific memory as ACPI data.</span><br><span class="line">			Region of memory to be marked is from ss to ss+nn.</span><br><span class="line"></span><br><span class="line">	memmap=nn[KMG]<span class="variable">$ss</span>[KMG]</span><br><span class="line">			[KNL,ACPI] Mark specific memory as reserved.</span><br><span class="line">			Region of memory to be reserved is from ss to ss+nn.</span><br><span class="line">			Example: Exclude memory from 0x18690000-0x1869ffff</span><br><span class="line">			         memmap=64K<span class="variable">$0x18690000</span></span><br><span class="line">			         or</span><br><span class="line">			         memmap=0x10000<span class="variable">$0x18690000</span></span><br><span class="line">			Some bootloaders may need an escape character before <span class="string">&#x27;$&#x27;</span>,</span><br><span class="line">			like Grub2, otherwise <span class="string">&#x27;$&#x27;</span> and the following number</span><br><span class="line">			will be eaten.</span><br><span class="line"></span><br><span class="line">	memmap=nn[KMG]!ss[KMG]</span><br><span class="line">			[KNL,X86] Mark specific memory as protected.</span><br><span class="line">			Region of memory to be used, from ss to ss+nn.</span><br><span class="line">			The memory region may be marked as e820 <span class="built_in">type</span> 12 (0xc)</span><br><span class="line">			and is NVDIMM or ADR memory.</span><br></pre></td></tr></table></figure>

<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> dmesg | grep e820</span><br><span class="line"><span class="symbol">$</span> grubby --args=<span class="string">&quot;memmap=96G:32G&quot;</span> --update-kernel=<span class="keyword">ALL</span></span><br></pre></td></tr></table></figure>

<h4 id="mapping-dev-pmemX-can-be-used-to-create-a-DAX-filesystem"><a href="#mapping-dev-pmemX-can-be-used-to-create-a-DAX-filesystem" class="headerlink" title="mapping /dev/pmemX can be used to create a DAX filesystem"></a>mapping /dev/pmemX can be used to create a DAX filesystem</h4><ul>
<li>DAX bypass the pagecache<ul>
<li>DAX use NVRAM for pagecache</li>
<li>DAX can map pagecache NVRAM into user buffer</li>
</ul>
</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo parted <span class="regexp">/dev/</span>pmem0</span><br><span class="line">(parted) mkpart</span><br><span class="line">Partition type?  primary/extended? p</span><br><span class="line"><span class="keyword">File</span> system type?  [ext2]? ext4</span><br><span class="line">Start? <span class="number">2</span>MiB</span><br><span class="line">End? <span class="number">100</span>GiB</span><br><span class="line">(parted)</span><br><span class="line"></span><br><span class="line">(parted) mkpart</span><br><span class="line">Partition type?  primary/extended? p</span><br><span class="line"><span class="keyword">File</span> system type?  [ext2]? ext4</span><br><span class="line">Start? <span class="number">100</span>GiB</span><br><span class="line">End? <span class="number">200</span>GiB</span><br><span class="line"></span><br><span class="line">$  getconf PAGE_SIZE</span><br><span class="line"><span class="number">4096</span></span><br><span class="line"></span><br><span class="line">$ sudo mkfs.ext4 -b <span class="number">4096</span> -E stride=<span class="number">512</span> -F <span class="regexp">/dev/</span>pmem0</span><br><span class="line">$ sudo mkdir /pmem</span><br><span class="line">$ sudo mount -o dax <span class="regexp">/dev/</span>pmem0p1 /pmem</span><br><span class="line">$ sudo mount -v | <span class="keyword">grep</span> /pmem</span><br><span class="line">$ fallocate --length <span class="number">1</span>G <span class="regexp">/pmem/</span>data</span><br><span class="line">$ echo <span class="number">1</span> &gt; <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>fs_dax<span class="regexp">/dax_pmd_fault_done/</span>enable</span><br><span class="line">$ echo <span class="number">0</span> &gt; <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>fs_dax<span class="regexp">/dax_pmd_fault_done/</span>enable</span><br><span class="line"></span><br><span class="line"># Verify the namespace is in fsdax mode</span><br><span class="line">$ ndctl list -u</span><br><span class="line">$ cat <span class="regexp">/proc/i</span>omem</span><br></pre></td></tr></table></figure>


<h4 id="Monitor-ecc-error"><a href="#Monitor-ecc-error" class="headerlink" title="Monitor ecc error"></a>Monitor ecc error</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg -T |  grep -Ei <span class="string">&quot;Err.*bit ECC&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor multiple bit</span></span><br><span class="line">$ cat /sys/devices/system/edac/mc/mc*/[u,c]e_count | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> [[ ! <span class="variable">$line</span> -eq 0 ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;Got DRAM ecc error&quot;</span> &amp;&amp; <span class="built_in">exit</span> 2; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="Benchmark-by-perf"><a href="#Benchmark-by-perf" class="headerlink" title="Benchmark by perf"></a>Benchmark by perf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">......</span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          8.837 secs slowest (max) thread-runtime</span><br><span class="line">          8.000 secs fastest (min) thread-runtime</span><br><span class="line">          8.182 secs average thread-runtime</span><br><span class="line">          4.738 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.702 nsecs/byte/thread runtime</span><br><span class="line">          1.424 GB/sec/thread speed</span><br><span class="line">         14.239 GB/sec total speed</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          5.528 secs slowest (max) thread-runtime</span><br><span class="line">          5.000 secs fastest (min) thread-runtime</span><br><span class="line">          5.084 secs average thread-runtime</span><br><span class="line">          4.776 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.439 nsecs/byte/thread runtime</span><br><span class="line">          2.276 GB/sec/thread speed</span><br><span class="line">         22.764 GB/sec total speed</span><br></pre></td></tr></table></figure>

<h3 id="AMD-roma-CPU-memroy"><a href="#AMD-roma-CPU-memroy" class="headerlink" title="AMD roma CPU memroy"></a>AMD roma CPU memroy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">dmidecode</span> <span class="string">-t</span> <span class="string">memory</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-Ei</span> <span class="string">&#x27;1638|32&#x27;</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line">	<span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line">	<span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">5</span><span class="string">..8</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">echo</span> <span class="string">$i;</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">4</span><span class="string">,$i</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">         <span class="number">12.818</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line">         <span class="number">12.757</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line">         <span class="number">12.810</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line">         <span class="number">13.142</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">21</span><span class="string">..24</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">echo</span> <span class="string">$i;</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">20</span><span class="string">,$i</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line">         <span class="number">12.836</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">22</span></span><br><span class="line">         <span class="number">12.824</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">23</span></span><br><span class="line">         <span class="number">12.847</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">24</span></span><br><span class="line">         <span class="number">13.183</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">20</span><span class="string">,46</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span></span><br><span class="line">         <span class="number">13.125</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="string">$</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">20</span><span class="string">,47</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span></span><br><span class="line">         <span class="number">13.137</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br></pre></td></tr></table></figure>
<p>AMD roma looks like 4 cores share a mem channel, 2 threads x 15000MB = 30G , 12GB/s means in a mem channel, 13GB/s means pass two mem channel, just guess.</p>
<h3 id="system-call"><a href="#system-call" class="headerlink" title="system call"></a>system call</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/22370102/difference-between-kmalloc-and-kmem-cache-alloc">Kmalloc</a> - allocates contiguous region from the physical memory. But keep in mind, allocating and free’ing memory is a lot of work.</p>
</li>
<li><p>Kmem_cache_alloc - Here, your process keeps some copies of the some pre-defined size objects pre-allocated. Say you have struct that you know you will be requiring very frequently, so instead of allocating it from the main memory (kmalloc) when you need it, you already keep multiple copies of it allocated &amp; when you want it, it returns the address of the block already allocated (saves a lot of time). Similarly, when you free it, you don’t give it back, it actually isn’t free’d, it goes back to the allocated pool so that if some process again asks for it, you can return this address of the already allocated struct.</p>
</li>
<li><p>Reclaim ratios</p>
<ul>
<li>swappiness</li>
<li>min_free_kbytes</li>
<li>vfs_cache_pressure<br>Deps your cache hit ratio and automatic set the value<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vfs_cache_pressure</span><br><span class="line">------------------</span><br><span class="line">This percentage value controls the tendency of the kernel to reclaim the memory which is used <span class="keyword">for</span> caching of directory <span class="keyword">and</span> inode objects.</span><br><span class="line"></span><br><span class="line">At the <span class="keyword">default</span> value of vfs_cache_pressure=<span class="number">100</span> the kernel will attempt to reclaim dentries <span class="keyword">and</span> inodes at a <span class="string">&quot;fair&quot;</span> rate with respect to pagecache <span class="keyword">and</span> swapcache reclaim.  Decreasing vfs_cache_pressure causes the kernel to prefer to retain dentry <span class="keyword">and</span> inode caches. When vfs_cache_pressure=<span class="number">0</span>, the kernel will never reclaim dentries <span class="keyword">and</span> inodes due to memory pressure <span class="keyword">and</span> <span class="keyword">this</span> can easily lead to out-of-memory conditions. Increasing vfs_cache_pressure beyond <span class="number">100</span> causes the kernel to prefer to reclaim dentries <span class="keyword">and</span> inodes.</span><br><span class="line"></span><br><span class="line">Increasing vfs_cache_pressure significantly beyond <span class="number">100</span> may have negative performance impact. Reclaim code needs to take various locks to find freeable directory <span class="keyword">and</span> inode objects. With vfs_cache_pressure=<span class="number">1000</span>, it will look <span class="keyword">for</span> ten times more freeable objects than there are.</span><br><span class="line"></span><br><span class="line">sysctl -w vm.vfs_cache_pressure=<span class="number">200</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>writeback</p>
<ul>
<li>On very large memory systems, consider using more granularity by using<ul>
<li>/proc/sys/vm/dirty_background_ratio</li>
<li>/proc/sys/vm/dirty_ratio</li>
</ul>
</li>
<li>If there is a lot of pagecache pressure one would want to start background flushing sooner and delay the synchronous writes<ul>
<li>lower diretry_background_ratio</li>
<li>increase the dirty_ratio</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="check-memroy-fragment"><a href="#check-memroy-fragment" class="headerlink" title="check memroy fragment"></a>check memroy fragment</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/kernel/debug/extfrag/unusable_index</span><br><span class="line">Node 0, zone      DMA 0.000 0.000 0.000 0.000 0.000 0.008 0.016 0.032 0.032 0.097 0.226</span><br><span class="line">Node 0, zone    DMA32 0.000 0.000 0.039 0.236 0.328 0.353 0.365 0.376 0.390 0.406 0.414</span><br><span class="line">Node 0, zone   Normal 0.000 0.003 0.011 0.020 0.048 0.091 0.152 0.205 0.258 0.383 1.000</span><br><span class="line">Node 1, zone   Normal 0.000 0.001 0.007 0.008 0.044 0.115 0.180 0.240 0.383 0.544 0.611</span><br><span class="line">unusable index=(free pages−free blocks suitable)/free pages</span><br><span class="line">        /*</span><br><span class="line">         * Index should be a value between 0 and 1. Return a value to 3</span><br><span class="line">         * decimal places.</span><br><span class="line">         *</span><br><span class="line">         * 0 =&gt; no fragmentation</span><br><span class="line">         * 1 =&gt; high fragmentation</span><br><span class="line">         */</span><br><span class="line"></span><br><span class="line">$ numactl --hardware; cat /sys/kernel/debug/extfrag/extfrag_index /proc/pagetypeinfo /proc/buddyinfo</span><br><span class="line">        /*</span><br><span class="line">         * Index is between 0 and 1 so <span class="built_in">return</span> within 3 decimal places</span><br><span class="line">         *</span><br><span class="line">         * 0 =&gt; allocation would fail due to lack of memory</span><br><span class="line">         * 1 =&gt; allocation would fail due to fragmentation</span><br><span class="line">         */</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;free_blocks_suitable) //enough mem</span><br><span class="line">                <span class="built_in">return</span> -1000;</span><br><span class="line"></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class="line">node 0 size: 257436 MB</span><br><span class="line">node 0 free: 3644 MB</span><br><span class="line">node 1 cpus: 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95</span><br><span class="line">node 1 size: 258023 MB</span><br><span class="line">node 1 free: 428 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10</span><br><span class="line">Node 0, zone      DMA -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000</span><br><span class="line">Node 0, zone    DMA32 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 0.986 0.993</span><br><span class="line">Node 0, zone   Normal -1.000 -1.000 -1.000 -1.000 0.925 0.963 0.982 0.991 0.996 0.998 0.999</span><br><span class="line">Node 1, zone   Normal -1.000 -1.000 0.750 0.875 0.938 0.969 0.985 0.993 0.997 0.999 1.000</span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">Free pages count per migrate <span class="built_in">type</span> at order       0      1      2      3      4      5      6      7      8      9     10</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>    Unmovable      1      0      1      1      1      1      1      0      1      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>  Reclaimable      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Movable      0      0      0      0      0      0      0      0      0      1      3</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>    Unmovable    301   1638   1860      0   1252     75    303    228     15      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>  Reclaimable      0     24     13   1900   1473    399      2      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Movable   7829   8977   8590   6422   3501   1001     98      2      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>    Unmovable &gt;100000  64223   7587      3      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>  Reclaimable  45808  13050    380      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Movable  12480    373      4      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">Number of blocks <span class="built_in">type</span>     Unmovable  Reclaimable      Movable      Reserve          CMA      Isolate</span><br><span class="line">Node 0, zone      DMA            1            0            7            0            0            0</span><br><span class="line">Node 0, zone    DMA32          593          192          615            0            0            0</span><br><span class="line">Node 0, zone   Normal         9082          899       119555            0            0            0</span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">Free pages count per migrate <span class="built_in">type</span> at order       0      1      2      3      4      5      6      7      8      9     10</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>    Unmovable  83606     45      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>  Reclaimable    300      4      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>      Movable  24364     25      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">Number of blocks <span class="built_in">type</span>     Unmovable  Reclaimable      Movable      Reserve          CMA      Isolate</span><br><span class="line">Node 1, zone   Normal         5767          791       124514            0            0            0</span><br><span class="line">Node 0, zone      DMA      1      0      1      1      1      1      1      0      1      1      3</span><br><span class="line">Node 0, zone    DMA32   8130  10639  10463   8322   6226   1475    403    230     15      0      0</span><br><span class="line">Node 0, zone   Normal 397919  77646   7970      3      0      0      0      0      0      0      0</span><br><span class="line">Node 1, zone   Normal 108085     74      0      0      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">$ numactl --hardware; cat /sys/kernel/debug/extfrag/extfrag_index /proc/pagetypeinfo /proc/buddyinfo</span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class="line">node 0 size: 257436 MB</span><br><span class="line">node 0 free: 2616 MB</span><br><span class="line">node 1 cpus: 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95</span><br><span class="line">node 1 size: 258023 MB</span><br><span class="line">node 1 free: 3281 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10</span><br><span class="line">Node 0, zone      DMA -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000</span><br><span class="line">Node 0, zone    DMA32 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 0.984 0.992</span><br><span class="line">Node 0, zone   Normal -1.000 -1.000 -1.000 0.875 0.938 0.969 0.985 0.993 0.997 0.999 1.000</span><br><span class="line">Node 1, zone   Normal -1.000 -1.000 -1.000 -1.000 0.934 0.967 0.984 0.992 0.996 0.998 0.999</span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">Free pages count per migrate <span class="built_in">type</span> at order       0      1      2      3      4      5      6      7      8      9     10</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>    Unmovable      1      0      1      1      1      1      1      0      1      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>  Reclaimable      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Movable      0      0      0      0      0      0      0      0      0      1      3</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>    Unmovable    298   1896   1742     68   1354    775    336    229     15      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>  Reclaimable      0     24     13   1884   1473    399      2      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Movable   6649   7835   8050   6258   3592   1145    142      3      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>    Unmovable &gt;100000   1984      2      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>  Reclaimable   2385     24      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Movable  73017     93      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">Number of blocks <span class="built_in">type</span>     Unmovable  Reclaimable      Movable      Reserve          CMA      Isolate</span><br><span class="line">Node 0, zone      DMA            1            0            7            0            0            0</span><br><span class="line">Node 0, zone    DMA32          593          192          615            0            0            0</span><br><span class="line">Node 0, zone   Normal         9082          899       119555            0            0            0</span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">Free pages count per migrate <span class="built_in">type</span> at order       0      1      2      3      4      5      6      7      8      9     10</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>    Unmovable  92929    285     21      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>  Reclaimable   4389    152      6      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>      Movable &gt;100000  46439    105      1      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    1, zone   Normal, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">Number of blocks <span class="built_in">type</span>     Unmovable  Reclaimable      Movable      Reserve          CMA      Isolate</span><br><span class="line">Node 1, zone   Normal         5767          791       124514            0            0            0</span><br><span class="line">Node 0, zone      DMA      1      0      1      1      1      1      1      0      1      1      3</span><br><span class="line">Node 0, zone    DMA32   6947   9755   9806   8210   6419   2319    480    232     15      0      0</span><br><span class="line">Node 0, zone   Normal 296581   2189      2      0      0      0      0      0      0      0      0</span><br><span class="line">Node 1, zone   Normal 740918  46880    132      1      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line"><span class="comment">## In heavey loading, it &#x27;s too slow, go to memory compaction</span></span><br><span class="line">$ <span class="built_in">echo</span> &gt; /proc/sys/vm/compact_memory</span><br><span class="line"></span><br><span class="line"><span class="comment">## Got the free pages from buddyinfo</span></span><br><span class="line">awk <span class="string">&#x27;&#123;sum=0;for(i=5;i&lt;=NF;i++) sum+=$i*(2^(i-5))&#125;;&#123;total+=sum*4096/1024/1024&#125;;&#123;print $1 &quot; &quot; $2 &quot; &quot; $3 &quot; &quot; $4 &quot;\t : &quot; sum*4096/1024/1024 &quot;M&quot;&#125; END &#123;print &quot;total\t\t\t : &quot; total &quot;M&quot;&#125;&#x27;</span> /proc/buddyinfo </span><br></pre></td></tr></table></figure>

<p>memory compaction cause system responding slow, but it ‘s not trigger TcpExtPFMemallocDrop</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sar -r -B -S <span class="number">2</span></span><br><span class="line">Average:     pgpgin/s pgpgout/s   fault/s  majflt/s  pgfree/s pgscank/s pgscand/s pgsteal/s    %vmeff</span><br><span class="line">Average:         <span class="number">0.00</span>      <span class="number">8.92</span> <span class="number">3163363.44</span>      <span class="number">0.00</span> <span class="number">177917.30</span>      <span class="number">0.00</span>  <span class="number">39200.92</span>  <span class="number">39093.80</span>     <span class="number">99.73</span></span><br><span class="line"></span><br><span class="line">Average:    kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">Average:     <span class="number">17337774</span> <span class="number">510492746</span>     <span class="number">96.72</span>    <span class="number">140728</span> <span class="number">342605322</span> <span class="number">133693955</span>     <span class="number">24.93</span> <span class="number">266439056</span> <span class="number">230275118</span>    <span class="number">344656</span></span><br><span class="line"></span><br><span class="line">Average:    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad</span><br><span class="line">Average:      <span class="number">8075700</span>    <span class="number">312904</span>      <span class="number">3.73</span>      <span class="number">1948</span>      <span class="number">0.62</span></span><br><span class="line"></span><br><span class="line">cat /<span class="keyword">proc</span>/sys/vm/extfrag_threshold</span><br><span class="line">500</span><br><span class="line"></span><br><span class="line">This<span class="title"> parameter</span> affects<span class="title"> whether</span> the<span class="title"> kernel</span> will<span class="title"> compact</span> memory<span class="title"> or</span> direct<span class="title"> reclaim</span> to<span class="title"> satisfy</span> a<span class="title"> high-order</span> allocation. </span><br><span class="line">The<span class="title"> extfrag/extfrag_index</span> file<span class="title"> in</span> debugfs<span class="title"> shows</span> what<span class="title"> the</span> fragmentation<span class="title"> index</span> for<span class="title"> each</span> order<span class="title"> is</span> in<span class="title"> each</span> zone<span class="title"> in</span> the<span class="title"> system.</span> </span><br><span class="line">Values<span class="title"> tending</span> towards 0<span class="title"> imply</span> allocations<span class="title"> would</span> fail<span class="title"> due</span> to<span class="title"> lack</span> of<span class="title"> memory,</span> values<span class="title"> towards</span> 1000<span class="title"> imply</span> failures<span class="title"> are</span> due<span class="title"> to</span> fragmentation<span class="title"> and</span> -1<span class="title"> implies</span> that<span class="title"> the</span> allocation<span class="title"> will</span> succeed<span class="title"> as</span> long<span class="title"> as</span> watermarks<span class="title"> are</span> met.</span><br><span class="line"></span><br><span class="line">The<span class="title"> kernel</span> will<span class="title"> not</span> compact<span class="title"> memory</span> in<span class="title"> a</span> zone<span class="title"> if</span> the<span class="title"> fragmentation</span> index<span class="title"> is</span> &lt;=<span class="title"> extfrag_threshold.</span> The<span class="title"> default</span> value<span class="title"> is</span> 500</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">	 *<span class="title"> Index</span> is<span class="title"> between</span> 0<span class="title"> and</span> 1000</span><br><span class="line">	 *</span><br><span class="line">	 * 0 =&gt;<span class="title"> allocation</span> would<span class="title"> fail</span> due<span class="title"> to</span> lack<span class="title"> of</span> memory</span><br><span class="line">	 * 1000 =&gt;<span class="title"> allocation</span> would<span class="title"> fail</span> due<span class="title"> to</span> fragmentation</span><br><span class="line">	 */</span><br></pre></td></tr></table></figure>
<p>pgscank/s: Number of pages scanned by the kswapd daemon per second.<br>pgscand/s: Number of pages scanned directly per second.<br>%vmeff = pgsteal / pgscanin, In the kswapd scan pages(pagecache and swapcache), how many page banned and re-use the pages ratio<br>pgsteal/s: Number of pages the system has reclaimed from cache (pagecache and swapcache)  per  second  to  satisfy  its  memory demands.</p>
<p>Linux memory allocate base the buddy algorithm, When allocate a huge page and no free, trigger direct reclaim or memory compaction</p>
<p>如何限制系统减少出现memory compaction的概率.  查阅资料后, 发现Linux有一个参数是控制这个的: /proc/sys/vm/extfrag_threshold  这个参数是一个0 ~ 1000的整数. 如果出现内存不够用的情况, Linux会为当前系统的内存碎片情况打一个分, 如果超过了extfrag_threshold这个值, kswapd就会触发memory compaction .  所以, 这个值设置接近1000, 说明系统在内存碎片的处理倾向于把旧的页换出, 以符合申请的需要; 而设置接近0, 表示系统在内存碎片的处理倾向于做memory compaction.</p>
<p>echo 1 &gt; /proc/sys/vm/drop_caches<br>echo 1 &gt; /proc/sys/vm/compact_memory<br>这个实质就是减少memory compaction的内存总量</p>
<ol>
<li>Machine freshly booted and configured for hugepage usage with<br> a) hugeadm –create-global-mounts<br> b) hugeadm –pool-pages-max DEFAULT:8G<br> c) hugeadm –set-recommended-min_free_kbytes<br> d) hugeadm –set-recommended-shmmax<br><a target="_blank" rel="noopener" href="https://lwn.net/Articles/381677/">The min_free_kbytes here is important. Anti-fragmentation works best when pageblocks don’t mix. hugeadm knows how to calculate a value that will significantly reduce the worst of external-fragmentation-related events as reported by the mm_page_alloc_extfrag tracepoint.</a></li>
<li>In increments, attempt to allocate 5% of memory as hugepages.<pre><code>Measure how long it took, how successful it was, how many
direct reclaims took place and how how many compactions. Note
the compaction figures might not fully add up as compactions
can take place for orders other than the hugepage size</code></pre>
</li>
</ol>
<p>echo 1 &gt; /sys/kernel/debug/tracing/events/kmem/mm_page_alloc_extfrag/enable<br>cat /sys/kernel/debug/tracing/trace</p>
<pre><code>       &lt;...&gt;-48794 [003] d... 29700.500381: mm_page_alloc_extfrag: page=ffffe547d61d0000 pfn=22574080 alloc_order=9 fallback_order=10 pageblock_order=9 alloc_migratetype=2 fallback_migratetype=2 fragmenting=0 change_ownership=1
       &lt;...&gt;-48794 [003] d... 29701.045678: mm_page_alloc_extfrag: page=ffffe547d60e0000 pfn=22558720 alloc_order=9 fallback_order=10 pageblock_order=9 alloc_migratetype=2 fallback_migratetype=2 fragmenting=0 change_ownership=1</code></pre>
<p>Each zone has the watermark, cat /proc/zoneinfo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> |</span><br><span class="line"> |                availlable memory back to high watermark level, swapd goes sleep</span><br><span class="line"> |                                   |    .</span><br><span class="line"> |      kswapd work up               |   .</span><br><span class="line"> |    .     |      direct reclam     | ..</span><br><span class="line">f|     .    |            |           v. </span><br><span class="line">r|------.----------------------------.----------- high watermark</span><br><span class="line">e|       .  |            |          .</span><br><span class="line">e|        . |            |         .</span><br><span class="line"> |         .V            |        .</span><br><span class="line">p|----------.--------------------.--------------- low watermark</span><br><span class="line">a|            ......     |    ..</span><br><span class="line">g|                ^ ..   |  ..</span><br><span class="line">e|                |   .. v..</span><br><span class="line">s|-----------------------.----------------------- min watermark</span><br><span class="line"> |                |</span><br><span class="line"> |                |</span><br><span class="line"> ------------------------------------------------</span><br><span class="line">                 |</span><br><span class="line">           kswapd running still rate of allocation is high</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>GFP_ATOMIC  (__GFP_HIGH|__GFP_ATIOMIC|__GFP_KSWAPD_RECLAIM eg:alloc_skb) could malloc some memory under the lower watermark<br>if under lower watermark, you could see the PF_MEMALLOC, in our case ,it ‘s the PF_MEMALLOC failed (out of memory)<br>but it could failed too, because some memory will to scan and reclaim   </p>
<p><a target="_blank" rel="noopener" href="https://github.com/haiwei-li/study/blob/3f40f1406620fb0bb7300a1d3ff7320b180875bc/Linux/Memory/zone%20%E6%B0%B4%E4%BD%8D/zone%20watermask.md">reference</a><br>一种是默认的操作，此时分配器将同步等待内存回收完成，再进行内存分配，也就是direct reclaim<br>还有一种特殊情况，如果内存分配的请求是带了 PF_MEMALLOC 标志位的，并且现在空余内存的大小可以满足本次内存分配的需求，那么也将是先分配，再回收。<br>使用PF_MEMALLOC(“PF”表示per-process flag)相当于是忽略了watermark，因此它对应的内存分配的标志是ALLOC_NO_WATERMARK。能够获取”min”值以下的内存，也意味着该process有动用几乎所有内存的权利，因此它也对应GFP的标志__GFP_MEMALLOC。     </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_MEMALLOC)</span><br><span class="line">	<span class="keyword">return</span> ALLOC_NO_WATERMARKS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)</span><br><span class="line">        set_page_pfmemalloc(page);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以在内存严重短缺的时候，不等待回收而强行分配内存呢？其中的一个人物就是kswapd啦，因为kswapd本身就是负责回收内存的，它只需要占用一小部分内存支撑其正常运行(就像启动资金一样)，就可以去回收更多的内存(赚更多的钱回来)。<br>虽然kswapd是在”low”到”min”的这段区间被唤醒加入调度队列的，但当它真正执行的时候，空余内存的值可能已经掉到”min”以下了。可见，”min”值存在的一个意义是保证像kswapd这样的特殊任务能够在需要的时候立刻获得所需内存。   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#linux-3.10.0-1127.el7/mm/page_alloc.c</span></span><br><span class="line">int __meminit init_per_zone_wmark_min(void)</span><br><span class="line">&#123;</span><br><span class="line">        unsigned long lowmem_kbytes;</span><br><span class="line">        int new_min_free_kbytes;</span><br><span class="line"></span><br><span class="line">        lowmem_kbytes = nr_free_buffer_pages() * (PAGE_SIZE &gt;&gt; 10);</span><br><span class="line">        new_min_free_kbytes = int_sqrt(lowmem_kbytes * 16);  &lt;------------------min_free_kbytes</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (new_min_free_kbytes &gt; user_min_free_kbytes) &#123;</span><br><span class="line">                min_free_kbytes = new_min_free_kbytes;</span><br><span class="line">                <span class="keyword">if</span> (min_free_kbytes &lt; 128)</span><br><span class="line">                        min_free_kbytes = 128;</span><br><span class="line">                <span class="keyword">if</span> (min_free_kbytes &gt; 65536)</span><br><span class="line">                        min_free_kbytes = 65536;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pr_warn(<span class="string">&quot;min_free_kbytes is not updated to %d because user defined value %d is preferred\n&quot;</span>,</span><br><span class="line">                                new_min_free_kbytes, user_min_free_kbytes);</span><br><span class="line">        &#125;</span><br><span class="line">        setup_per_zone_wmarks();</span><br><span class="line">        refresh_zone_stat_thresholds();</span><br><span class="line">        setup_per_zone_lowmem_reserve();</span><br><span class="line">        setup_per_zone_inactive_ratio();</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static void __setup_per_zone_wmarks(void)</span><br><span class="line">&#123;</span><br><span class="line">        unsigned long pages_min = min_free_kbytes &gt;&gt; (PAGE_SHIFT - 10);</span><br><span class="line">        unsigned long lowmem_pages = 0;</span><br><span class="line">        struct zone *zone;</span><br><span class="line">        unsigned long flags;</span><br><span class="line"></span><br><span class="line">        /* Calculate total number of !ZONE_HIGHMEM pages */ &lt;--------------------------------------</span><br><span class="line">        for_each_zone(zone) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!is_highmem(zone))</span><br><span class="line">                        lowmem_pages += zone-&gt;managed_pages;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for_each_zone(zone) &#123;</span><br><span class="line">                u64 tmp;</span><br><span class="line"></span><br><span class="line">可以看出这里每一个 zone 的 wmark_min 的根据自己的内存大小比例分配对应百分比的 min_free_kbytes. 也就是所有 zone 的 wmark_min 加起来就是这个 min_free_kbytes</span><br><span class="line">wmark_low = 5/4 * wmark_min</span><br><span class="line">wmark_high = 3/2 * wmark_min</span><br><span class="line">每一个zone 还有一个reserve page, 用来限制在 high level zone 满足不了请求的情况下, low level zone 自己需要保留的page数.具体的初始化在</span><br><span class="line">setup_per_zone_lowmem_reserve()</span><br><span class="line">那么这里来理解一下设置这些wmark_min, wmark_low, wmark_high 的目的了.</span><br><span class="line"></span><br><span class="line">这里min_free_kbytes 主要是kernel 为了留给__GFP_ATOMIC 类型的内存申请操作, 因为在操作系统里面有一些内存申请操作是不允许切换的,也就是不能在这个时候把当前这个 cpu 交给别的进程, 比如handling an interrupt or executing code inside an critical region. 那么这时候肯定也是希望kernel 内存申请操作应该是非阻塞的. 因此希望系统至少能够留下 min_free_kbytes 的空间用户__GFP_ATOMIC 类型的内存申请操作.</span><br><span class="line"></span><br><span class="line">wmark_min 是说当前的这个空闲的 page frame 已经极地了, 当有内存申请操作的时候, 如果是非内核的内存申请操作, 那么就返回失败, 如果申请操作来自kernel, 比如调用的是 __alloc_pages_high_priority() 的时候, 就可以返回内存</span><br><span class="line">wmark_low 是用来唤醒 kswap 进程, 当我们某一个__alloc_pages 的时候发现 free page fram 小于 wmark_low 的时候, 就会唤醒这个kswapd 进程, 进行 page reclaim</span><br><span class="line">wmark_high 是当 kswapd 这个进程进行 page reclaim 了以后, 什么时候停止的标志, 只有当 page frame 大于这个 pagh_high 的时候, kswapd 进程才会停止, 继续sleep </span><br><span class="line">所以其实wmark_min, wmark_low, wmark_high 都是为了kernel 能够允许atomic 类型的申请操作成功服务的</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">https://github.com/baotiao/baotiao.github.com/blob/6448a8ba675cbb6ea9ec002c4d8792a2b50226d5/_posts/2016-06-02-page-reclaim.md</span><br></pre></td></tr></table></figure>

<p>The “burst allocation” cause the high latency direct reclaim, for prevent this situation ….. </p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">------------------------------------------------------------------</span></span><br><span class="line">    &lt;<span class="comment">---allocate | reclaim---&gt;                               used    RAM</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">------------------------watermark_scale_factor increase min to high</span></span><br><span class="line">        |                   |</span><br><span class="line">        |<span class="comment">-------------------|---extra_free_kbytes increase this area from min to low</span></span><br><span class="line">        |        |          |</span><br><span class="line">  wmark <span class="built_in">min</span>  wmark low    wmark high</span><br><span class="line"><span class="comment">--------|--------|----------|-------------------------------------</span></span><br><span class="line">        <span class="comment">--delta--</span></span><br><span class="line">    &lt;<span class="comment">---allocate | reclaim---&gt;                               used    RAM</span></span><br><span class="line"><span class="comment">----|-------------------|-----------------------------------------</span></span><br><span class="line">    <span class="comment">-----alloc size------</span></span><br><span class="line"></span><br><span class="line">Lower <span class="keyword">the</span> wmark low will wake up <span class="keyword">the</span> kswapd...</span><br><span class="line">In <span class="keyword">the</span> android <span class="built_in">add</span> <span class="keyword">the</span> extra_free_kbytes <span class="keyword">for</span> increase <span class="keyword">the</span> memory size <span class="built_in">from</span> wmark <span class="built_in">min</span> <span class="built_in">to</span> <span class="keyword">the</span> wmark low</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/93841288">about avaiable memory</a><br>si_mem_available   </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">             |---unreclaimble</span><br><span class="line">page cache &lt;-----reclaimble --------------|</span><br><span class="line">                 SReclaimable  -------------&gt; available</span><br><span class="line">             |---free   ------------------|</span><br><span class="line">free pages &lt;-----zone watermark (low? <span class="keyword">or</span> high)</span><br><span class="line">             |---lowmem reserve (min)</span><br><span class="line"></span><br><span class="line">avaiable = free pages - all zone lowmem reserve - high watermark +<span class="built_in"> page </span>cache + could be reclaim <span class="keyword">from</span> slab</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## too high lru_lock--- &gt; lru cache once write a lot of pages to inactive list</span></span><br><span class="line">2 x list in linux <span class="comment">----&gt; active FIFO list (PG_active=1 in the flag, PG_referenced means used it recently ?)</span></span><br><span class="line">                   |<span class="comment">--&gt; inactive FIFO list (PG_active=0)</span></span><br><span class="line"></span><br><span class="line">对于anonymous pages，总是需要先写入swap area才能回收。而对于page <span class="keyword">cache</span>，有一些可以直接discard（比如elf的<span class="built_in">text</span>段对应的页面，<span class="keyword">data</span>段对应的页面中clean的部分），有一些dirty的页面需要先write back同步到磁盘。</span><br><span class="line">由于有flusher <span class="keyword">thread</span>定期的write back，回收时还是dirty的page <span class="keyword">cache</span>页面不会太多。而且，page <span class="keyword">cache</span>中的页面有对应的文件和在文件中的位置信息，需要换入恢复的时候也更加容易。</span><br><span class="line">因此，内核通常更倾向于换出page <span class="keyword">cache</span>中的页面，只有当内存压力变得相对严重时，才会选择回收 anonymous pages。用户可以根据具体应用场景的需要，通过<span class="string">&quot;/proc/sys/vm/swappiness&quot;</span>调节内存回收时anonymous pages和page <span class="keyword">cache</span>的比重。</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/93228929">meminfo</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|------------------------buff/cache-----------------------------|             ---&gt; some of swapcached</span><br><span class="line">           |---buffers---|------------cached(mapped)------------|             |</span><br><span class="line">|---slab---|---Active(file)+Inactive(file)---|---shmem shared---|---anonpages---|</span><br><span class="line">                                             |---active(anon)+Inactive(anon)----|</span><br><span class="line"></span><br><span class="line">$ dmesg  | grep Memory</span><br><span class="line">                                                                            <span class="built_in">read</span>,write      <span class="built_in">readonly</span>              not init</span><br><span class="line">[    0.059168] Memory: 7776940K/8200176K available (14345K kernel code, 3481K rwdata, 10348K rodata, 2688K init, 5976K bss, 422976K reserved, 0K cma-reserved)</span><br><span class="line">[    0.112476] x86/mm: Memory block size: 128MB</span><br><span class="line"></span><br><span class="line">- KernelStack</span><br><span class="line">  - grep -i stack /proc/meminfo</span><br><span class="line">- kernel heap   </span><br><span class="line">  - kmalloc() samll block by slab allocator</span><br><span class="line">  - alloc_page or __get_free_page or kmalloc big part or vmalloc</span><br><span class="line">    - /proc/vmallocinfo</span><br><span class="line">- Page tables</span><br><span class="line">  - All: grep pagetables /proc/meminfo -i</span><br><span class="line">  - single process: grep -E <span class="string">&#x27;VmPTE|VmPMD&#x27;</span> /proc/[PID]/status</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="http://linux.laoqinren.net/kernel/vm-sysctl-min_free_kbytes/">lower watermark is min_free_kbytes 125%, hiher watermark is min_free_kbytes 150%</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Initialise min_free_kbytes.</span><br><span class="line"> *</span><br><span class="line"> * For small machines we want it small (128k min).  For large machines</span><br><span class="line"> * we want it large (64MB max).  But it is not linear, because network</span><br><span class="line"> * bandwidth does not increase linearly with machine size.  We use</span><br><span class="line"> *</span><br><span class="line"> *      min_free_kbytes = 4 * sqrt(lowmem_kbytes), <span class="keyword">for</span> better accuracy:</span><br><span class="line"> *      min_free_kbytes = sqrt(lowmem_kbytes * 16)</span><br><span class="line"> *</span><br><span class="line"> * <span class="built_in">which</span> yields</span><br><span class="line"> *</span><br><span class="line"> * 16MB:        512k</span><br><span class="line"> * 32MB:        724k</span><br><span class="line"> * 64MB:        1024k</span><br><span class="line"> * 128MB:       1448k</span><br><span class="line"> * 256MB:       2048k</span><br><span class="line"> * 512MB:       2896k</span><br><span class="line"> * 1024MB:      4096k</span><br><span class="line"> * 2048MB:      5792k</span><br><span class="line"> * 4096MB:      8192k</span><br><span class="line"> * 8192MB:      11584k</span><br><span class="line"> * 16384MB:     16384k</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">watermark[high] - watermark[low] </span><br><span class="line">		= watermark[min] * 3 / 2 - watermark[min] * 5 / 4 </span><br><span class="line">		= watermark[min] * 1 / 4 </span><br><span class="line">		= per_zone_min_free_pages * 1/4</span><br><span class="line"></span><br><span class="line">$ systctl -w vm.min_free_kbytes=70336</span><br><span class="line">$ grep -A 3 -B 1 <span class="string">&quot;  pages free&quot;</span> /proc/zoneinfo</span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">  pages free     3969</span><br><span class="line">        min      2</span><br><span class="line">        low      2</span><br><span class="line">        high     3</span><br><span class="line">--</span><br><span class="line">Node 0, zone    DMA32</span><br><span class="line">  pages free     451904</span><br><span class="line">        min      241</span><br><span class="line">        low      301 (125%)</span><br><span class="line">        high     361 (150%)</span><br><span class="line">--</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">  pages free     15162636</span><br><span class="line">        min      8533 </span><br><span class="line">        low      10666 (125%)</span><br><span class="line">        high     12799 (150%)</span><br><span class="line">--</span><br><span class="line">Node 1, zone   Normal</span><br><span class="line">  pages free     15810809</span><br><span class="line">        min      8806</span><br><span class="line">        low      11007</span><br><span class="line">        high     13209</span><br><span class="line">$ sysctl -w vm.min_free_kbytes=570336</span><br><span class="line">vm.min_free_kbytes = 570336</span><br><span class="line"></span><br><span class="line">$ grep -A 3 -B 1 <span class="string">&quot;  pages free&quot;</span> /proc/zoneinfo</span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">  pages free     3969</span><br><span class="line">        min      17</span><br><span class="line">        low      21</span><br><span class="line">        high     25</span><br><span class="line">--</span><br><span class="line">Node 0, zone    DMA32</span><br><span class="line">  pages free     451904</span><br><span class="line">        min      1957</span><br><span class="line">        low      2446</span><br><span class="line">        high     2935</span><br><span class="line">--</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">  pages free     15162723</span><br><span class="line">        min      69196</span><br><span class="line">        low      86495</span><br><span class="line">        high     103794</span><br><span class="line">--</span><br><span class="line">Node 1, zone   Normal</span><br><span class="line">  pages free     15810673</span><br><span class="line">        min      71413</span><br><span class="line">        low      89266</span><br><span class="line">        high     107119</span><br><span class="line">$ grep -A 3 -B 1 <span class="string">&quot;  pages free&quot;</span> /proc/zoneinfo  | awk <span class="string">&#x27;$0~/min/&#123;sum+=$NF&#125; END&#123;print sum*4+4&#125;&#x27;</span></span><br><span class="line">570336</span><br><span class="line"></span><br><span class="line"><span class="comment"># you could see the same ratio from min to low</span></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/mm/vmscan.c</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The background pageout daemon, started as a kernel thread</span></span><br><span class="line"><span class="comment"> * from the init process.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This basically trickles out pages so that we have _some_</span></span><br><span class="line"><span class="comment"> * free memory available even if there is no other activity</span></span><br><span class="line"><span class="comment"> * that frees anything up. This is needed for things like routing</span></span><br><span class="line"><span class="comment"> * etc, where we otherwise might have all activity going on in</span></span><br><span class="line"><span class="comment"> * asynchronous contexts that cannot page things out.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If there are applications that are active memory-allocators</span></span><br><span class="line"><span class="comment"> * (most normal use), this basically shouldn&#x27;t matter.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kswapd</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> order, new_order;</span><br><span class="line">        <span class="keyword">unsigned</span> balanced_order;</span><br><span class="line">        <span class="keyword">int</span> classzone_idx, new_classzone_idx;</span><br><span class="line">        <span class="keyword">int</span> balanced_classzone_idx;</span><br><span class="line">        <span class="keyword">pg_data_t</span> *pgdat = (<span class="keyword">pg_data_t</span>*)p;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span> = <span class="title">current</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">reclaim_state</span> <span class="title">reclaim_state</span> = &#123;</span></span><br><span class="line">                .reclaimed_slab = <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cpumask</span> *<span class="title">cpumask</span> = <span class="title">cpumask_of_node</span>(<span class="title">pgdat</span>-&gt;<span class="title">node_id</span>);</span></span><br><span class="line"></span><br><span class="line">        lockdep_set_current_reclaim_state(GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cpumask_empty(cpumask))</span><br><span class="line">                set_cpus_allowed_ptr(tsk, cpumask);</span><br><span class="line">        current-&gt;reclaim_state = &amp;reclaim_state;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Tell the memory management that we&#x27;re a &quot;memory allocator&quot;,</span></span><br><span class="line"><span class="comment">         * and that if we need more memory we should get access to it</span></span><br><span class="line"><span class="comment">         * regardless (see &quot;__alloc_pages()&quot;). &quot;kswapd&quot; should</span></span><br><span class="line"><span class="comment">         * never get caught in the normal page freeing logic.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * (Kswapd normally doesn&#x27;t need memory anyway, but sometimes</span></span><br><span class="line"><span class="comment">         * you need a small amount of memory in order to be able to</span></span><br><span class="line"><span class="comment">         * page out something else, and this flag essentially protects</span></span><br><span class="line"><span class="comment">         * us from recursively trying to free more memory as we&#x27;re</span></span><br><span class="line"><span class="comment">         * trying to free the first piece of memory in the first place).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tsk-&gt;flags |= PF_MEMALLOC | PF_SWAPWRITE | PF_KSWAPD;</span><br><span class="line">        set_freezable();</span><br></pre></td></tr></table></figure>
<ul>
<li>vm.min_free_kbytes: kernel reserve for emergency</li>
<li>vm.extra_free_kbytes: reserve for application emergency<ul>
<li>not in centos 7 and ubuntu 20.04</li>
<li>work in centos 6<br>free mem &lt; vm.min_free_kbytes + vm.extra_free_kbytes —&gt; kswapd scan and reclaim pages until high in /proc/zoneinfo</li>
</ul>
</li>
</ul>
<h3 id="proc-vmstat"><a href="#proc-vmstat" class="headerlink" title="/proc/vmstat"></a>/proc/vmstat</h3><ul>
<li>pgscan_kswapd reclaim<ul>
<li>pgscan_kswapd<ul>
<li>kswapd background scan page numbers</li>
</ul>
</li>
<li>pgsteal_kswapd<ul>
<li>kswapd background reclaim page numbers</li>
</ul>
</li>
<li>pgscan_direct<ul>
<li>Number of pages scanned by the kswapd daemon per second</li>
</ul>
</li>
<li>pgsteal_direct<ul>
<li>Number of pages scanned directly per second</li>
</ul>
</li>
</ul>
</li>
<li>fragmentation<ul>
<li>compact_stall</li>
<li>compact_fail</li>
<li>compact_success</li>
</ul>
</li>
<li>nr_dirty</li>
<li>drop_cache<ul>
<li>drop_pagecache<ul>
<li>drop page cache number</li>
</ul>
</li>
<li>drop_slab<ul>
<li>drop slab number</li>
</ul>
</li>
<li>pginodesteal<ul>
<li>direct reclaim inode page cache number</li>
</ul>
</li>
<li>kswapd_inodesteal<ul>
<li>kswapd background reclaim page cache number</li>
</ul>
</li>
</ul>
</li>
<li>IO<ul>
<li>pgpgin</li>
<li>pgpgout</li>
</ul>
</li>
<li>SWAP IO<ul>
<li>pswpin</li>
<li>pswpout</li>
</ul>
</li>
<li>workingset<ul>
<li>workingset_refault<ul>
<li>release pages read from disk to memory</li>
</ul>
</li>
<li>workingset_restore<ul>
<li>How many pages avoid to reclaimed, before release the page re-use<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Ei &#x27;drop|inodesteal|nr_dirty_&#x27; /<span class="keyword">proc</span>/vmstat</span><br><span class="line">nr_dirty_threshold 48600882</span><br><span class="line">nr_dirty_background_threshold 24300441</span><br><span class="line">pginodesteal 255519573</span><br><span class="line">kswapd_inodesteal 902259110</span><br><span class="line">drop_pagecache 32</span><br><span class="line">drop_slab 48</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://plantegg.github.io/2020/11/15/Linux%E5%86%85%E5%AD%98--%E7%A2%8E%E7%89%87/">In this page, the openssl speed slow when malloc the big page, you could compare with diff servers</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./openssl speed -seconds 300 -bytes 32768 aes-256-ige</span><br><span class="line">Doing aes-256 ige <span class="keyword">for</span> 300s on 32768 size blocks:</span><br></pre></td></tr></table></figure>

<h3 id="trace-page-fault"><a href="#trace-page-fault" class="headerlink" title="trace page fault"></a><a target="_blank" rel="noopener" href="http://www.brendangregg.com/FlameGraphs/memoryflamegraphs.html">trace page fault</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ perf record -e page-fault -a -g -- sleep 30</span><br><span class="line">$ perf script &gt; out.stacks</span><br><span class="line">$ ./stackcollapse-perf.pl &lt; out.stacks | ./flamegraph.pl --color=mem \</span><br><span class="line">    --title=<span class="string">&quot;Page Fault Flame Graph&quot;</span> --countname=<span class="string">&quot;pages&quot;</span> &gt; out.svg</span><br><span class="line"></span><br><span class="line">$ /usr/share/bcc/tools/stackcount <span class="string">&#x27;t:exceptions:page_fault_*&#x27;</span> &gt; out.stacks</span><br><span class="line">$ ./stackcollapse.pl &lt; out.stacks | ./flamegraph.pl --color=mem \</span><br><span class="line">    --title=<span class="string">&quot;Page Fault Flame Graph&quot;</span> --countname=<span class="string">&quot;pages&quot;</span> &gt; out.svg</span><br></pre></td></tr></table></figure>

<h3 id="meminfo"><a href="#meminfo" class="headerlink" title="meminfo"></a>meminfo</h3><ul>
<li>cache:           file cache page + shm page</li>
<li>rss:             anonymous page + swap cache page</li>
<li>(in)active_anon: anonymous page + swap cache page + shm page</li>
<li>(in)active_file: file cache page</li>
<li>rss + cache = (in)active_anon + (in)active_file</li>
</ul>
<p>The memory does not automatically count by alloc_pages assigned, unless alloc_pages kernel module or driver calls the initiative to statistics, otherwise we can only see free memory is reduced, but the /proc/meminfo was not clear where their specific use went. For example, there is a FAQ on the VMware guest, is the opportunity to take up guest VMWare ESX host memory via Balloon driver (vmware_balloon module) on the guest, and sometimes take up too much will cause no guest memory is available, then the guest to check the /proc/meminfo MemFree see only rarely, but can not see the whereabouts of memory, reason is Balloon driver by alloc_pages allocate memory, leaving no statistical value in /proc/meminfo in, it is difficult to track.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/openzfs/zfs/issues/7734">same with zfs on linux</a></p>
<p><a target="_blank" rel="noopener" href="http://linuxperf.com/?p=142">kernel</a><br>   reserved (dmesg -T | grep reserved)<br>   slab<br>     SReclaimable<br>     SUnreclaim<br>   VmallocUsed (grep vmalloc /proc/vmallocinfo)  kernel/module.c<br>      awk ‘$0~/vmalloc/{total+=$2}; END {print total}’ /proc/vmallocinfo<br>      kernel modules (lsmod size field)<br>        seq_printf(m, “%s %u”,mod-&gt;name, mod-&gt;init_size + mod-&gt;core_size)<br>   HardwareCorrupted (mm/memory-failure.c: memory_failure())<br>   PageTables<br>      not contains Page Frame, it ‘s the base unit by physical memory<br>   KernelStack (2048k)<br>   Bounce( bounce buffering in the old device)<br>   Hugepages( diff with Transparent HugePage)</p>
<pre><code> HugePages_Total = vm.nr_hugepages
   $ echo 128 &gt; /proc/sys/vm/nr_hugepages
   $ cat /proc/meminfo
   HugePages_Total: 128
   HugePages_Free: 128
   Hugepagesize: 2048 kB
   hugetlbfs mmap() or read(), not support write()
   not count by PSS and RSS, not in RU Active/Inactive, not in cache/buffer
   VmFlags: xxx ht(hugepages) in smaps
   THP will count by PSS and RSS
   AnonHugePages count in AnonPages and in PSS/RSS
   $ cat /sys/devices/node/*/hugepages/*/nrhugepages
   Used via hugetlbfs</code></pre>
<p>   LUR (Struct of Page Frame Reclaiming)<br>     LRU_INACTIVE_ANON &lt;–&gt; Inactive(anon)<br>     LRU_ACTIVE_ANON &lt;–&gt; Active(anon)<br>     LRU_INACTIVE_FILE &lt;–&gt; Inactive(file)<br>     LRU_ACTIVE_FILE &lt;–&gt; Active(file)<br>     LRU_UNEVICTABLE &lt;–&gt; Unevictable<br>     Cached+AnonPages<br>       User process<br>         /proc/<pid>/smaps<br>       Page cache<br>   Shmem (page cache or Mapped(attach shmem))<br>     Inactive(anon) or Active(anon), in anon list but not count by AnonPages()<br>     share mem<br>     tmpfs<br>     devtmpfs<br>     used size, allocate not means used<br>   AnonPages<br>     User pages: 1. Anonpages; 2. file-backed page<br>     Anonymous Pages release when the user process exit<br>     page cache(Cached) is the file-backed page, not Anonymous pages<br>     anonymous pages<br>     AnonPages not in share memory, it’s the Cached<br>     mmap private anonymous pages is AnonPages(Anonymous Pages),mmap shared anonymous pages is Cached(file-backed pages),shared anonymous mmap is tmpfs<br>     the Transparent HugePages (THP) AnonHugePages (fs/proc/meminfo.c meminfo_proc_show)<br>       Transparent HugePages<br>         echo never &gt; /sys/kernel/mm/transparent_hugepages=never<br>         echo always &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled<br>   Cached<br>     Mapped<br>       User file-backed pages<br>       Share lib file/mmap file/executable file<br>       All process PSS == Mapped + AnonPages<br>     Unmapped (Cached - Mapped)<br>       The process exit and the file-backed pages will not be reclaimed<br>     tmpfs<br>       POSIX/SysV shared memory<br>       shared anonymous mmap<br>         not swap-out<br>   SwapCached ( fs/proc/meminfo.c, meminfo_proc_show, total_swapcache_pages )<br>     AnonPages( make sure the mapping when swap-out;mm/vmscan.c: shrink_page_list() )<br>     Shmem<br>     the pages swap-out -&gt; swap-in, the swapcache will not be reclaimed right now, it ‘s the cache too<br>   Mlocked<br>     From Active/Inactive LRU list move to the Unevictable LRU list<br>     It could not page-out and swap-out<br>     location: Contain in the LRU Unevictable，AnonPages，Shmem，Mapped<br>   Buffer (the block dev cache page, filemap.c: do_generic_file_read &gt; add_to_page_cache_lru)<br>     read/write/metadata cache, the diff with cache, it ‘s not linux file cache, just block dev<br>     location: LRU list/Active(file)/Inactive(file)<br>   DirectMap (4K,2M,1G..)<br>     TLB(Translation Lookaside Buffer) efficiency<br>   Dirty pages<br>     dirty pages = Dirty + NFS_Unstable + Writeback<br>   The kernel used<br>     Active(file) + Inactive(file) + Shmem + mlock_file】== Cached + Buffers<br>     Slab+ VmallocUsed + PageTables + KernelStack + HardwareCorrupted + Bounce + X(black hole, alloc_pages/__get_free_page not count in meminfo)<br>   The user used<br>     (Active + Inactive + Unevictable) + (HugePages_Total * Hugepagesize)<br>     if swapcache=0 (Cached + AnonPages + Buffers) + (HugePages_Total * Hugepagesize)<br>     All processes = $(grep Pss /proc/[1-9]*/smaps | awk ‘{total+=$2}; END {print total}’)<br>     All processes + (Cached - mapped) + Buffers + (HugePages_Total * Hugepagesize)<br>   The collectl info<br>     dd wirte file: collectl Inact(file)<br>     user process: collectl Anon(contains AnonH)</p>
<h3 id="Out-of-memory"><a href="#Out-of-memory" class="headerlink" title="Out of memory"></a>Out of memory</h3><p>Here is the user process cause OOM</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[Mon Apr 19 13:38:55 2021] Node 0 DMA free:14400kB min:28kB low:32kB high:40kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:15984kB managed:15900kB mlocked:0kB dirty:0kB writeback:0kB mapped:0kB shmem:0kB slab_reclaimable:0kB slab_unreclaimable:0kB kernel_stack:0kB pagetables:0kB unstable:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:0 all_unreclaimable? yes</span><br><span class="line">[Mon Apr 19 13:38:55 2021] lowmem_reserve[]: 0 1408 22531 22531</span><br><span class="line"><span class="comment">## lowmem_reserve[2](22531*4kB) + low_watermark(low: 32kB) &gt; free pages(14400kB) - malloc N x pages (no enough malloc 1 page, because 22531*4kB &gt; free pages 14400kB)</span></span><br><span class="line"><span class="comment">## failed to get memory from DMA</span></span><br><span class="line"></span><br><span class="line">[Mon Apr 19 13:38:55 2021] Node 0 DMA32 free:87208kB min:2716kB low:3392kB high:4072kB active_anon:94576kB inactive_anon:94732kB active_file:328kB inactive_file:2784kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:1675200kB managed:1442720kB mlocked:0kB dirty:0kB writeback:0kB mapped:120kB shmem:4kB slab_reclaimable:114200kB slab_unreclaimable:32456kB kernel_stack:992kB pagetables:4212kB unstable:0kB bounce:0kB free_pcp:124kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:5910 all_unreclaimable? yes</span><br><span class="line">[Mon Apr 19 13:38:55 2021] lowmem_reserve[]: 0 0 21122 21122</span><br><span class="line"><span class="comment">## lowmem_reserve[2](21122*4kB) + low_watermark(low: 3392kB) &gt; free pages(87208kB) - malloc N x pages (no enough malloc 1 page, because 87208-21122*4-3392=-672)</span></span><br><span class="line"></span><br><span class="line">For a memory request to be granted/allocated the following check must pass:</span><br><span class="line">low watermark + lowmem_reserve[2] &lt; free pages - n pages</span><br><span class="line">low watermark - is the low watermark value <span class="keyword">in</span> the zone;</span><br><span class="line">lowmem_reserve - is a buffer watermark value to protect lower zones;</span><br><span class="line">n pages - is the number of pages requested, <span class="keyword">in</span> this <span class="keyword">case</span>, it is 1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Mon Apr 19 13:38:55 2021] Node 0 Normal free:42948kB min:40752kB low:50940kB high:61128kB active_anon:14171856kB inactive_anon:1287928kB active_file:7440kB inactive_file:34588kB unevictable:0kB isolated(anon):1536kB isolated(file):256kB present:22020096kB managed:21629868kB mlocked:0kB dirty:12kB writeback:372kB mapped:3156kB shmem:1064kB slab_reclaimable:254928kB slab_unreclaimable:224444kB kernel_stack:7488kB pagetables:53080kB unstable:0kB bounce:0kB free_pcp:1804kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:84491 all_unreclaimable? yes</span><br><span class="line">[Mon Apr 19 13:38:55 2021] lowmem_reserve[]: 0 0 0 0</span><br><span class="line">free &lt; low, skip ?</span><br><span class="line"></span><br><span class="line">[Mon Apr 19 13:38:55 2021] Node 1 Normal free:48548kB min:46608kB low:58260kB high:69912kB active_anon:22031860kB inactive_anon:1573648kB active_file:5164kB inactive_file:31048kB unevictable:0kB isolated(anon):1664kB isolated(file):512kB present:25165824kB managed:24739068kB mlocked:0kB dirty:32kB writeback:196kB mapped:2188kB shmem:972kB slab_reclaimable:285956kB slab_unreclaimable:250044kB kernel_stack:8992kB pagetables:80520kB unstable:0kB bounce:0kB free_pcp:1248kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:100515 all_unreclaimable? yes</span><br><span class="line">[Mon Apr 19 13:38:55 2021] lowmem_reserve[]: 0 0 0 0</span><br><span class="line">free &lt; low, skip ?</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">[Mon Apr 19 13:38:55 2021] Free swap  = 0kB</span><br><span class="line">[Mon Apr 19 13:38:55 2021] Total swap = 16383996kB</span><br><span class="line">[Mon Apr 19 13:38:55 2021] 12219276 pages RAM</span><br><span class="line">[Mon Apr 19 13:38:55 2021] 0 pages HighMem/MovableOnly</span><br><span class="line">[Mon Apr 19 13:38:55 2021] 262387 pages reserved</span><br></pre></td></tr></table></figure>
<h4 id="check-swap-usage"><a href="#check-swap-usage" class="headerlink" title="check swap usage"></a>check swap usage</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Get current swap usage for all running processes</span></span><br><span class="line"><span class="comment"># Erik Ljungstrom 27/05/2011</span></span><br><span class="line"><span class="comment"># Modified by Mikko Rantalainen 2012-08-09</span></span><br><span class="line"><span class="comment"># Pipe the output to &quot;sort -nk3&quot; to get sorted output</span></span><br><span class="line"><span class="comment"># Modified by Marc Methot 2014-09-18</span></span><br><span class="line"><span class="comment"># removed the need for sudo</span></span><br><span class="line"></span><br><span class="line">SUM=0</span><br><span class="line">OVERALL=0</span><br><span class="line"><span class="keyword">for</span> DIR <span class="keyword">in</span> `find /proc/ -maxdepth 1 -<span class="built_in">type</span> d -regex <span class="string">&quot;^/proc/[0-9]+&quot;</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    PID=`<span class="built_in">echo</span> <span class="variable">$DIR</span> | cut -d / -f 3`</span><br><span class="line">    PROGNAME=`ps -p <span class="variable">$PID</span> -o comm --no-headers`</span><br><span class="line">    <span class="keyword">for</span> SWAP <span class="keyword">in</span> `grep VmSwap <span class="variable">$DIR</span>/status 2&gt;/dev/null | awk <span class="string">&#x27;&#123; print $2 &#125;&#x27;</span>`</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">let</span> SUM=<span class="variable">$SUM</span>+<span class="variable">$SWAP</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">if</span> (( <span class="variable">$SUM</span> &gt; 0 )); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;PID=<span class="variable">$PID</span> swapped <span class="variable">$SUM</span> KB (<span class="variable">$PROGNAME</span>)&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">let</span> OVERALL=<span class="variable">$OVERALL</span>+<span class="variable">$SUM</span></span><br><span class="line">    SUM=0</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Overall swap used: <span class="variable">$OVERALL</span> KB&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="valgrind"><a href="#valgrind" class="headerlink" title="valgrind"></a>valgrind</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind <span class="attribute">--tool</span>=memcheck <span class="attribute">--leak-check</span>=<span class="literal">yes</span> <span class="attribute">--show-reachable</span>=<span class="literal">yes</span> <span class="attribute">--num-callers</span>=20 <span class="attribute">--track-fds</span>=<span class="literal">yes</span> ./lustre_exporter</span><br></pre></td></tr></table></figure>

<h4 id="vmtouch"><a href="#vmtouch" class="headerlink" title="vmtouch"></a>vmtouch</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ vmtouch  ixgbe-5.12.5.tar.gz</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 0&#x2F;127  0&#x2F;508K  0%</span><br><span class="line">         Elapsed: 4.1e-05 seconds</span><br><span class="line">$ cat ixgbe-5.12.5.tar.gz &gt; &#x2F;dev&#x2F;null</span><br><span class="line">$ vmtouch  ixgbe-5.12.5.tar.gz</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 127&#x2F;127  508K&#x2F;508K  100%</span><br><span class="line">         Elapsed: 5.2e-05 seconds</span><br><span class="line"></span><br><span class="line">$ dd if&#x3D;ixgbe-5.12.5.tar.gz of&#x3D;&#x2F;dev&#x2F;null bs&#x3D;1M iflag&#x3D;nocache</span><br><span class="line">0+1 records in</span><br><span class="line">0+1 records out</span><br><span class="line">518142 bytes (518 kB, 506 KiB) copied, 0.000246479 s, 2.1 GB&#x2F;s</span><br><span class="line"></span><br><span class="line">$ vmtouch  ixgbe-5.12.5.tar.gz</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 0&#x2F;127  0&#x2F;508K  0%</span><br><span class="line">         Elapsed: 4.1e-05 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">寸劲</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/07/02/mem/">http://yoursite.com/2018/07/02/mem/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/memory/">memory</a></div><div class="post_share"><div class="social-share" data-image="https://homerl.github.io/img/operting_system_a32c6f.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2018/07/08/scsi_dev/"><img class="prev-cover" src="https://homerl.github.io/img/hard-disk_223cf.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">scsi device maintain</div></div></a></div><div class="next-post pull-right"><a href="/2018/06/01/ethernet_nic_tuning/"><img class="next-cover" src="https://homerl.github.io/img/32_connection_nodes_communication_network_seo_social_community_relation-512.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Ethernet nic tuning</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2018/08/06/numa/" title="numa"><img class="cover" src="https://homerl.github.io/img/operting_system_a32c6f.svg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-08-06</div><div class="title">numa</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2022 By 寸劲</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '0b9d5b98d0a972b33cf7',
      clientSecret: '769efc11b32f6c0d03bcbf3ee800dfc4e2690459',
      repo: 'homerl.github.io',
      owner: 'homerl',
      admin: ['homerl'],
      id: 'bf66e170ded620c91eb0086029154e63',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>