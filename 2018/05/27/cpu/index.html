<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>cpu | 无常无相无功;不动不破不空</title><meta name="keywords" content="cpu"><meta name="author" content="Homer"><meta name="copyright" content="Homer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="kernel boot12345678cpuidle.off&#x3D;1	[CPU_IDLE]		disable the cpuidle sub-systemcpuidle.governor&#x3D;		[CPU_IDLE] Name of the cpuidle governor to use.cpufreq.off&#x3D;1	[CPU_FREQ]		disable the cpufreq sub-systemcpu">
<meta property="og:type" content="article">
<meta property="og:title" content="cpu">
<meta property="og:url" content="http://yoursite.com/2018/05/27/cpu/index.html">
<meta property="og:site_name" content="无常无相无功;不动不破不空">
<meta property="og:description" content="kernel boot12345678cpuidle.off&#x3D;1	[CPU_IDLE]		disable the cpuidle sub-systemcpuidle.governor&#x3D;		[CPU_IDLE] Name of the cpuidle governor to use.cpufreq.off&#x3D;1	[CPU_FREQ]		disable the cpufreq sub-systemcpu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg">
<meta property="article:published_time" content="2018-05-27T07:35:59.000Z">
<meta property="article:modified_time" content="2022-07-22T15:08:10.072Z">
<meta property="article:author" content="Homer">
<meta property="article:tag" content="cpu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://homerl.github.io/img/operting_system_a32c6f.svg"><link rel="shortcut icon" href="/img/stout-shield.png"><link rel="canonical" href="http://yoursite.com/2018/05/27/cpu/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-07-22 23:08:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="无常无相无功;不动不破不空" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/fighting-spiri-logot.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-boot"><span class="toc-number">1.</span> <span class="toc-text">kernel boot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline-Width"><span class="toc-number">2.</span> <span class="toc-text">Pipeline Width</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cache-consistenta"><span class="toc-number">3.</span> <span class="toc-text">Cache consistenta</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMD-SMT-255-cores"><span class="toc-number">4.</span> <span class="toc-text">AMD SMT, 255 cores</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BIOS"><span class="toc-number">5.</span> <span class="toc-text">BIOS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><span class="toc-number">6.</span> <span class="toc-text">Application multiple threads get down to single core cause performance issue in intel skylake platform</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#E3-v6-Turbo-not-work-in-CentOS6"><span class="toc-number">7.</span> <span class="toc-text">E3 v6 Turbo not work in CentOS6</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Check-cpu-freq-instead-of-cat-proc-cpuinfo-grep-MHz"><span class="toc-number">7.0.1.</span> <span class="toc-text">Check cpu freq, instead of cat &#x2F;proc&#x2F;cpuinfo | grep MHz</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#check-driver"><span class="toc-number">7.1.</span> <span class="toc-text">check driver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#When-I-run-pigz-to-benchmark"><span class="toc-number">7.2.</span> <span class="toc-text">When I run pigz to benchmark</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Isolated-CPUs-example"><span class="toc-number">8.</span> <span class="toc-text">Isolated CPUs example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-state"><span class="toc-number">9.</span> <span class="toc-text">CPU state</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-parameter"><span class="toc-number">10.</span> <span class="toc-text">kernel parameter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#isolcpus"><span class="toc-number">10.1.</span> <span class="toc-text">isolcpus</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tuna"><span class="toc-number">10.2.</span> <span class="toc-text">tuna</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cpu-IPC-Instruction-Per-Clock-cycle"><span class="toc-number">11.</span> <span class="toc-text">cpu IPC (Instruction Per Clock cycle)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Benchmark-CPU"><span class="toc-number">12.</span> <span class="toc-text">Benchmark CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc-x86-options"><span class="toc-number">12.1.</span> <span class="toc-text">gcc_x86_options</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Disable-CPU-features"><span class="toc-number">13.</span> <span class="toc-text">Disable CPU features</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Disable-AVX"><span class="toc-number">14.</span> <span class="toc-text">Disable AVX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Found-the-half-cores"><span class="toc-number">15.</span> <span class="toc-text">Found the half cores</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Turn-off-the-cpu-cores"><span class="toc-number">16.</span> <span class="toc-text">Turn off the cpu cores</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-parameter-for-storage-system"><span class="toc-number">17.</span> <span class="toc-text">set parameter for storage system</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP-performance-in-AMD-roma-2x-7552"><span class="toc-number">18.</span> <span class="toc-text">UDP performance in AMD roma (2x 7552)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#intel-cmt-cat"><span class="toc-number">19.</span> <span class="toc-text">intel-cmt-cat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proc-stat"><span class="toc-number">20.</span> <span class="toc-text">&#x2F;proc&#x2F;stat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#numa"><span class="toc-number">21.</span> <span class="toc-text">numa</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#numastat"><span class="toc-number">21.1.</span> <span class="toc-text">numastat</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-many-temperature-is-high-for-intel-CPU"><span class="toc-number">22.</span> <span class="toc-text">How many temperature is high for intel CPU ?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#install-uarch-bench-on-centos-7"><span class="toc-number">23.</span> <span class="toc-text">install uarch-bench on centos 7</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#irqbalance"><span class="toc-number">24.</span> <span class="toc-text">irqbalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-Performance-overrides"><span class="toc-number">25.</span> <span class="toc-text">CVE Performance overrides</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cases"><span class="toc-number">26.</span> <span class="toc-text">Cases</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AMD-PCIE-4-issues"><span class="toc-number">26.1.</span> <span class="toc-text">AMD PCIE 4 issues</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-env-parameters"><span class="toc-number">26.2.</span> <span class="toc-text">test env parameters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Too-many-futex-overhead"><span class="toc-number">26.3.</span> <span class="toc-text">Too many futex overhead</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BIOS-1"><span class="toc-number">27.</span> <span class="toc-text">BIOS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DCU-Data-Prefetcher"><span class="toc-number">27.1.</span> <span class="toc-text">DCU Data Prefetcher</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AVX-Tflops"><span class="toc-number">28.</span> <span class="toc-text">AVX Tflops</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#power-setting-in-supermicro"><span class="toc-number">29.</span> <span class="toc-text">power setting in supermicro</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#turbostat"><span class="toc-number">29.1.</span> <span class="toc-text">turbostat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powertop"><span class="toc-number">29.2.</span> <span class="toc-text">powertop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powercap"><span class="toc-number">29.3.</span> <span class="toc-text">powercap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#process-counter-monitor-PCM"><span class="toc-number">29.4.</span> <span class="toc-text">process counter monitor (PCM)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numatop"><span class="toc-number">29.5.</span> <span class="toc-text">numatop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cache-monitor-technology"><span class="toc-number">29.6.</span> <span class="toc-text">cache monitor technology</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-some-of-EPYC2-limit-the-memory-bandwith"><span class="toc-number">30.</span> <span class="toc-text">Why some of EPYC2 limit the memory bandwith</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-cluster-mode"><span class="toc-number">31.</span> <span class="toc-text">CPU cluster mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-linux-kernel-parameters"><span class="toc-number">32.</span> <span class="toc-text">CPU linux kernel parameters</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://homerl.github.io/img/operting_system_a32c6f.svg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">无常无相无功;不动不破不空</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">cpu</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2018-05-27T07:35:59.000Z" title="Created 2018-05-27 15:35:59">2018-05-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-07-22T15:08:10.072Z" title="Updated 2022-07-22 23:08:10">2022-07-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/OS/">OS</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="kernel-boot"><a href="#kernel-boot" class="headerlink" title="kernel boot"></a>kernel boot</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cpuidle.off=1	[CPU_IDLE]</span><br><span class="line">		<span class="built_in">disable</span> the cpuidle sub-system</span><br><span class="line">cpuidle.governor=</span><br><span class="line">		[CPU_IDLE] Name of the cpuidle governor to use.</span><br><span class="line">cpufreq.off=1	[CPU_FREQ]</span><br><span class="line">		<span class="built_in">disable</span> the cpufreq sub-system</span><br><span class="line">cpufreq.default_governor=</span><br><span class="line">		[CPU_FREQ] Name of the default cpufreq governor or policy to use. This governor must be registered <span class="keyword">in</span> the kernel before the cpufreq driver probes.</span><br></pre></td></tr></table></figure>

<h3 id="Pipeline-Width"><a href="#Pipeline-Width" class="headerlink" title="Pipeline Width"></a><a target="_blank" rel="noopener" href="https://travisdowns.github.io/blog/2019/06/11/speed-limits.html">Pipeline Width</a></h3><ul>
<li><p>Intel Skylake: Maximum 4 fused uops per cycle</p>
</li>
<li><p>Intel Ice Lake: Maximum 5 fused uops per cycle</p>
</li>
<li><p>AMD Zen, Zen 2: Maximum 6 MOPs from up to 5 instructions per cycle</p>
</li>
<li><p>AMD Zen 3: Maximum 6 MOPs from up to 6 instructions per cycle</p>
</li>
<li><p>Apple M1: Maximum 8 ops per cycle<br><a target="_blank" rel="noopener" href="https://github.com/travisdowns/uarch-bench">how to test it</a></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#./uarch-bench<span class="selector-class">.sh</span> --timer=perf --test-name=cpp/sum-halves --extra-events=uops_issued.any</span><br><span class="line">./uarch-bench<span class="selector-class">.sh</span> --test-name=cpp/sum-halves --extra-events=uops_issued.any</span><br><span class="line">#./uarch-bench<span class="selector-class">.sh</span> --timer=perf --test-name=cpp/mul-<span class="number">4</span> --extra-events=uops_issued<span class="selector-class">.any</span>,uops_retired.retire_slots</span><br><span class="line">./uarch-bench<span class="selector-class">.sh</span> --test-name=cpp/mul-<span class="number">4</span> --extra-events=uops_issued<span class="selector-class">.any</span>,uops_retired.retire_slots</span><br><span class="line">#./uarch-bench<span class="selector-class">.sh</span> --timer=perf --test-name=cpp/mul-<span class="number">4</span> --extra-events=uops_dispatched_port.port_0<span class="selector-id">#p0</span>,uops_dispatched_port.port_1<span class="selector-id">#p1</span>,uops_dispatched_port.port_2<span class="selector-id">#p2</span>,uops_dispatched_port.port_3<span class="selector-id">#p3</span>,uops_dispatched_port.port_4<span class="selector-id">#p4</span>,uops_dispatched_port.port_5<span class="selector-id">#p5</span>,uops_dispatched_port.port_6<span class="selector-id">#p6</span>,uops_dispatched_port.port_7#p7</span><br><span class="line">./uarch-bench<span class="selector-class">.sh</span> --test-name=cpp/mul-<span class="number">4</span> --extra-events=uops_dispatched_port.port_0<span class="selector-id">#p0</span>,uops_dispatched_port.port_1<span class="selector-id">#p1</span>,uops_dispatched_port.port_2<span class="selector-id">#p2</span>,uops_dispatched_port.port_3<span class="selector-id">#p3</span>,uops_dispatched_port.port_4<span class="selector-id">#p4</span>,uops_dispatched_port.port_5<span class="selector-id">#p5</span>,uops_dispatched_port.port_6<span class="selector-id">#p6</span>,uops_dispatched_port.port_7#p7</span><br><span class="line">./uarch-bench<span class="selector-class">.sh</span> --test-name=cpp/mul-chain --extra-events=uops_dispatched_port.port_0<span class="selector-id">#p0</span>,uops_dispatched_port.port_1<span class="selector-id">#p1</span>,uops_dispatched_port.port_2<span class="selector-id">#p2</span>,uops_dispatched_port.port_3<span class="selector-id">#p3</span>,uops_dispatched_port.port_4<span class="selector-id">#p4</span>,uops_dispatched_port.port_5<span class="selector-id">#p5</span>,uops_dispatched_port.port_6#p6</span><br></pre></td></tr></table></figure>
</li>
<li><p>eIPC: effective instuction per cycle</p>
</li>
<li><p>IPC: insns per cycle insn/cycles</p>
</li>
<li><p>Application CPU time = instruction nums/(frequency x IPC)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://plantegg.github.io/2021/06/18/%E5%87%A0%E6%AC%BECPU%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94">The simple cpu maximum performance evaluate = frequency x Core nums x Maximum N(4/5/6/8 or more) fused uops per cycle x 1.3(smt2, 2 HT x86) or 1.5(smt4, 4 HT power)</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perf <span class="built_in">stat</span> -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,iTLB-load-misses  -a -p <span class="variable">$test_app_pid</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/cpu-cache-memory.png"></p>
</li>
</ul>
<h3 id="Cache-consistenta"><a href="#Cache-consistenta" class="headerlink" title="Cache consistenta"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/94811032">Cache consistent</a>a</h3><ul>
<li>write back<ul>
<li>only cache and then write to memory</li>
</ul>
</li>
<li>write through<ul>
<li>write cache and memory at the same time</li>
</ul>
</li>
<li>Snooping<ul>
<li>boardcast</li>
</ul>
</li>
<li>Directory-based<ul>
<li>index directory for some cores</li>
<li>The worst case: N x Cores, each core will communicates with the others(N-1)</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/20793.html">reference1</a><br><a target="_blank" rel="noopener" href="https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm">reference2</a></p>
<h3 id="AMD-SMT-255-cores"><a href="#AMD-SMT-255-cores" class="headerlink" title="AMD SMT, 255 cores"></a><a target="_blank" rel="noopener" href="https://developer.amd.com/wp-content/resources/56745_0.80.pdf">AMD SMT, 255 cores</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Some workloads, including many HPC ones, observe a performance neutral or even performance negative result when SMT is enabled. Some applications license by the hardware thread enabled, not just physical core. For those reasons, disabling SMT on your EPYC 7002 Series processor may be desirable. There are also some operating systems that have not enabled support <span class="keyword">for</span> the x2APIC within the EPYC 7002 Series Processor, <span class="built_in">which</span> is required to support beyond 255 threads. If you are running an operating system that does not support AMD’s x2APIC implementation, and have two 64-core processors installed, you will need to <span class="built_in">disable</span> SMT.</span><br></pre></td></tr></table></figure>


<h3 id="BIOS"><a href="#BIOS" class="headerlink" title="BIOS"></a>BIOS</h3><ul>
<li>Performance Per Watt (DAPC)<ul>
<li>Dell Active Power Control</li>
</ul>
</li>
<li>Performance Per Watt (OS)<ul>
<li>OS DBPM<ul>
<li>Demand Based Power Management (MBPM)</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://community.intel.com/t5/Software-Tuning-Performance/Monitoring-C1-and-C1E-core-c-state/m-p/1067363/highlight/true#M5233">intel cpu state</a><ul>
<li>state0 “POLL” (cpu spin-waits because it is expected to get more work very soon – &lt; 10 microseconds)  </li>
<li>state1 “C1-SKX” – default behavior of MWAIT with argument EAX=0x00 – has 2 microsecond wakeup latency  </li>
<li>state2 “C1E-SKX” – MWAIT with argument EAX=0x01 – has 10 microsecond wakeup latency and drops core to maximum efficiency frequency  </li>
<li>state3 “C6-SKX” – MWAIT with argument EAX=0x20 – has 133 microsecond wakeup latency and turns off core (allowing more power to other cores)</li>
</ul>
</li>
</ul>
<p>By booting with the kernel command line argument processor.max_cstate=1 and idle=poll the system will never enter a C-state other than zero and will not even use the MWAIT mechanism to temporarily halt in the idle routine. While this will provide the fastest scheduler response time, it is very wasteful of power and will generate heat that requires the air conditioning system to run (and waste more power).  This method is not recommended for general use, but can be quite handy for testing whether your application is being affected by cstates and idle transition latency. Booting your kernel and adding the commandline options: processor.max_cstate=1 idle=poll</p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/articles/65410">The second method, which has a bit more fine-grained control of the power management features, is to use the Power Management Quality of Service interface (PM QOS). The file /dev/cpu_dma_latency is the interface which when opened registers a quality-of-service request for latency with the operating system. A program should open /dev/cpu_dma_latency, write a 32-bit number to it representing a maximum response time in microseconds and then keep the file descriptor open while low-latency operation is desired.  Writing a zero means that you want the fastest response time</a><br><a target="_blank" rel="noopener" href="https://gist.github.com/SaveTheRbtz/f5e8d1ca7b55b6a7897b">Set the cpu_dma_latency</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2009 Johannes Berg &lt;johannes@sipsolutions.net&gt;</span></span><br><span class="line"><span class="comment"> * Copyright 2010 Luis R. Rodriguez &lt;lrodriguez@atheros.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Permission to use, copy, modify, and/or distribute this software for any</span></span><br><span class="line"><span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span></span><br><span class="line"><span class="comment"> * copyright notice and this permission notice appear in all copies.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span></span><br><span class="line"><span class="comment"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span></span><br><span class="line"><span class="comment"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span></span><br><span class="line"><span class="comment"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span></span><br><span class="line"><span class="comment"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span></span><br><span class="line"><span class="comment"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span></span><br><span class="line"><span class="comment"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Compile simply with:</span></span><br><span class="line"><span class="comment"> *	cc -o cpudmalatency cpudmalatency.c	</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Some unpatched buggy BIOSes create excessive C-state transition latencies</span></span><br><span class="line"><span class="comment"> * which can affect DMA on some devices. Instead of patching each and every</span></span><br><span class="line"><span class="comment"> * Linux kernel driver to account for these inefficiencies - lets punt these</span></span><br><span class="line"><span class="comment"> * work arounds to userspace. Linux distributions will hopefully have a way</span></span><br><span class="line"><span class="comment"> * to automatically detect these buggy platforms and call this. Note that</span></span><br><span class="line"><span class="comment"> * this app will hold the file open.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int32_t</span> v;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;latency [us]&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;	latency: the maximum tolerable CPU DMA you\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;	         are willing to put up with [in microseconds]\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This program will block until you hit Ctrl-C, at which point\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;the file descriptor is closed and the latency requirement is\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;unregistered again.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Hint: if you have an platform with a buggy BIOS that has\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;issues with excessive C-state transition latencies try value 55\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;setting latency to %d.%.6d seconds\n&quot;</span>, v/<span class="number">1000000</span>, v % <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">	fd = open(<span class="string">&quot;/dev/cpu_dma_latency&quot;</span>, O_WRONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;open /dev/cpu_dma_latency&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (write(fd, &amp;v, <span class="keyword">sizeof</span>(v)) != <span class="keyword">sizeof</span>(v)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;write to /dev/cpu_dma_latency&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://huataihuang.gitbooks.io/cloud-atlas/content/os/linux/kernel/cpu/intel_pstate.html">intel_pstate for more info</a><br><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cpuidle/sysfs.txt">cpuidle</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disable turbo in intel_pstate</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/devices/system/cpu/intel_pstate/no_turbo</span><br><span class="line"><span class="comment"># acpi-cpufreq disable</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpufreq/boost</span><br><span class="line"></span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">performance</span><br><span class="line"></span><br><span class="line">$ ./cpudmalatency 20</span><br><span class="line">setting latency to 0.000020 seconds</span><br><span class="line"></span><br><span class="line">$ ls /sys/devices/system/cpu/cpu0/cpuidle/</span><br><span class="line">state0  state1  state2  state3  state4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## Option to disable this idle state (bool, 1 disable idle, 0 enable)</span></span><br><span class="line"><span class="built_in">echo</span> 1 | tee -a /sys/devices/system/cpu/cpu*/cpuidle/state*/<span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## mode</span></span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpuidle/state*/name</span><br><span class="line">POLL</span><br><span class="line">C1-HSW</span><br><span class="line">C1E-HSW</span><br><span class="line">C3-HSW</span><br><span class="line">C6-HSW <span class="comment">### C6 	Deep Power Down 	Reduces the CPU internal voltage to any value, including 0 V</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Latency to exit out of this idle state (in microseconds)</span></span><br><span class="line">$ cat /sys/devices/system/cpu/cpu0/cpuidle/state*/latency</span><br><span class="line">0</span><br><span class="line">2</span><br><span class="line">10</span><br><span class="line">33</span><br><span class="line">133</span><br><span class="line"></span><br><span class="line"><span class="comment">## direct set the latency</span></span><br><span class="line">$ cpupower idle-set -D 133 <span class="comment">##enable 0,1,2,3 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 33  <span class="comment">##enable 0,1,2 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 10  <span class="comment">##enable 0,1 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 2   <span class="comment">##enable 0 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 0   <span class="comment">##disable 0,1,2,3,4</span></span><br><span class="line"><span class="comment">##https://www.intel.com/content/www/us/en/support/articles/000006619/processors/intel-core-processors.html</span></span><br><span class="line">CPU/Package sleep states</span><br><span class="line">    C0 - Active: CPU is on and operating.</span><br><span class="line">    C1 - Auto Halt: Core clock is off. The processor is not executing instructions, but can <span class="built_in">return</span> to an executing state almost instantaneously. Some processors also support an enhanced C1 state (C1E) <span class="keyword">for</span> lower power consumption.</span><br><span class="line">    C2 - Stop Clock: Core and bus clocks are off. The processor maintains all software-visible state, but can take longer to wake up.</span><br><span class="line">    C3 - Deep Sleep: Clock generator is off. The processor does not need to keep its cache coherent, but maintains other states. Some processors have variations of the C3 state (Deep Sleep, Deeper Sleep) that differ by how long it takes to wake the processor.</span><br><span class="line">    C4 - Deeper Sleep: Reduced VCC</span><br><span class="line">    DC4 - Deeper C4 Sleep: Further reduced VCC</span><br><span class="line"></span><br><span class="line">ACPI (Advanced Configuration and Power Interface)*</span><br><span class="line">The ACPI on the System Manageability Bus enables low-power sleep mode and conserves energy when a system is idle.</span><br><span class="line">Power management</span><br><span class="line">How power is efficiently directed to different components of a system. Power management is especially important <span class="keyword">for</span> portable devices that rely on battery power. By reducing power to components that are not being used, a good power management system can double or triple the lifetime of a battery.</span><br><span class="line"></span><br><span class="line">Deeper Sleep</span><br><span class="line">Works along with Intel® QuickStart technology on Intel® Mobile Processors. Deeper Sleep is a dynamic power management mode that delivers longer battery life. Deeper Sleep minimizes the power consumption of the CPU when it senses an extended period of inactivity by the user. It reduces power when idle and quickly restores the CPU to an active state as soon as the user resumes use of the system. It reduces processor voltage below the minimum operating voltage <span class="keyword">while</span> preserving the processor state. Deeper Sleep is functionally identical to the Deep Sleep State but at a 66 percent lower voltage.</span><br><span class="line"></span><br><span class="line">QuickStart technology</span><br><span class="line">Extends battery life by entering a low-power state during the briefest pauses <span class="keyword">in</span> user activity, such as between key strokes. Instantly returns to full-power state when prompted.</span><br><span class="line"></span><br><span class="line">Intel® Enhanced Deeper Sleep with Dynamic Cache Sizing</span><br><span class="line">This new power savings mechanism flushes system memory dynamically, based on demand or during periods of inactivity. Power savings occur as the cache ways are turned off once the data has been saved <span class="keyword">in</span> memory. L2 cache data integrity determines Deeper Sleep minimum voltage limits <span class="keyword">for</span> the Intel® Core™ Duo processor. Once the Dynamic Cache Sizing feature flushes the entire L2 cache to memory, the processor transitions to Intel® Enhanced Deeper Sleep. This allows the processor to lower voltage below the Deeper Sleep minimum voltage <span class="keyword">for</span> enhanced power savings and/or efficiencies.</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the maximum frequency</span></span><br><span class="line">$ cpupower frequency-set -u 2.8G</span><br><span class="line">$ cpupower frequency-set -d 2.0G</span><br><span class="line"></span><br><span class="line">$ cat /sys/devices/system/cpu/cpuidle/current_driver</span><br><span class="line">intel_idle</span><br><span class="line"></span><br><span class="line">$ ls /usr/lib/modules/$(uname -r)/kernel/drivers/cpufreq/</span><br><span class="line">acpi-cpufreq.ko.xz          cpufreq_stats.ko.xz  pcc-cpufreq.ko.xz  speedstep-lib.ko.xz</span><br><span class="line">amd_freq_sensitivity.ko.xz  p4-clockmod.ko.xz    powernow-k8.ko.xz</span><br><span class="line"></span><br><span class="line">$ cpupower frequency-info --driver</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line"></span><br><span class="line">$ cpupower frequency-info --governors</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line"></span><br><span class="line">$ cat /sys/devices/system/cpu/intel_pstate/status</span><br><span class="line">active</span><br><span class="line">$ <span class="built_in">echo</span> off | sudo tee /sys/devices/system/cpu/intel_pstate/status</span><br><span class="line">off</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> acpi-cpufreq &gt; /sys/devices/system/cpu/cpu2/cpufreq/scaling_driver</span><br><span class="line">-bash: /sys/devices/system/cpu/cpu2/cpufreq/scaling_driver: Permission denied</span><br><span class="line"><span class="comment"># can&#x27;t reload the driver</span></span><br><span class="line"></span><br><span class="line">$ cpuid -1 -l5</span><br><span class="line">Disclaimer: cpuid may not support decoding of all cpuid registers.</span><br><span class="line">CPU:</span><br><span class="line">   MONITOR/MWAIT (5):</span><br><span class="line">      smallest monitor-line size (bytes)       = 0x40 (64)</span><br><span class="line">      largest monitor-line size (bytes)        = 0x40 (64)</span><br><span class="line">      enum of Monitor-MWAIT exts supported     = <span class="literal">true</span></span><br><span class="line">      supports intrs as break-event <span class="keyword">for</span> MWAIT  = <span class="literal">true</span></span><br><span class="line">      number of C0 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C1 sub C-states using MWAIT    = 0x2 (2)</span><br><span class="line">      number of C2 sub C-states using MWAIT    = 0x1 (1)</span><br><span class="line">      number of C3 sub C-states using MWAIT    = 0x2 (2)</span><br><span class="line">      number of C4 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C5 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C6 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C7 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line"></span><br><span class="line">$ cpuid -1 -l6</span><br><span class="line">Disclaimer: cpuid may not support decoding of all cpuid registers.</span><br><span class="line">CPU:</span><br><span class="line">   Thermal and Power Management Features (6):</span><br><span class="line">      digital thermometer                     = <span class="literal">true</span></span><br><span class="line">      Intel Turbo Boost Technology            = <span class="literal">true</span></span><br><span class="line">      ARAT always running APIC timer          = <span class="literal">true</span></span><br><span class="line">      PLN power <span class="built_in">limit</span> notification            = <span class="literal">true</span></span><br><span class="line">      ECMD extended clock modulation duty     = <span class="literal">true</span></span><br><span class="line">      PTM package thermal management          = <span class="literal">true</span></span><br><span class="line">      HWP base registers                      = <span class="literal">false</span></span><br><span class="line">      HWP notification                        = <span class="literal">false</span></span><br><span class="line">      HWP activity window                     = <span class="literal">false</span></span><br><span class="line">      HWP energy performance preference       = <span class="literal">false</span></span><br><span class="line">      HWP package level request               = <span class="literal">false</span></span><br><span class="line">      HDC base registers                      = <span class="literal">false</span></span><br><span class="line">      digital thermometer thresholds          = 0x2 (2)</span><br><span class="line">      ACNT/MCNT supported performance measure = <span class="literal">true</span></span><br><span class="line">      ACNT2 available                         = <span class="literal">false</span></span><br><span class="line">      performance-energy bias capability      = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>Mwait is a special instruction in CPUs which essentially instructs the CPU to enter power saving mode. Mwait can be called in a variety of ways. Mwait can be called with a time hint, to tell the CPU for how long it should be idle. Mwait can also be called with a hint for C-state. Intel_idle passes the information from idle governor to the hardware by call-ing mwait with hints to desired C-state</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">call_cpuidle() &#123;</span><br><span class="line">  cpuidle_enter() &#123;</span><br><span class="line">    cpuidle_enter_state() &#123; </span><br><span class="line">      sched_idle_set_state();</span><br><span class="line">      intel_idle() &#123;</span><br><span class="line">        leave_mm(); </span><br><span class="line">        mwait_idle_with_hints.constprop<span class="number">.2</span>();</span><br><span class="line">      &#125; </span><br><span class="line">     sched_idle_set_state(); </span><br><span class="line">     arch_local_irq_enable() &#123;</span><br><span class="line">       do_IRQ() &#123;               </span><br><span class="line">         irq_enter() &#123;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.163/source/drivers/idle/intel_idle.c#L1115">source code</a></p>
<h3 id="Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><a href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform" class="headerlink" title="Application multiple threads get down to single core cause performance issue in intel skylake platform"></a>Application multiple threads get down to single core cause performance issue in intel skylake platform</h3><ul>
<li>The test CPU was Intel 2x Silver 4116</li>
<li>Default OS version was 3.10.0-862.el7.x86_64<ul>
<li>Pstate enabled in BIOS, I don’t know why it ‘s not work<ul>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/7.7_release_notes/index#enhancement_kernel">RHEL 7.7 release note BZ#1698453</a> The intel_pstate driver loads on the Intel Skylake-X systems with HWP disabled</li>
</ul>
</li>
<li>How to avoid this get down to single core<ul>
<li>Upgrade kernel to RHEL 7.7+</li>
<li>Disable Hyper threading</li>
</ul>
</li>
</ul>
</li>
<li>if you set BIOS to performance mode, HWP(Hardware-Controlled Performance States) will be disabled cause not loading intel_pstate<ul>
<li><a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-pm/patch/20180110193852.63667-2-srinivas.pandruvada@linux.intel.com/">cpufreq: intel_pstate: Add Skylake servers support</a></li>
</ul>
</li>
</ul>
<p>Looks like acpi-cpu-freq not support Turbo mode for each cores</p>
<p>Before upgrade</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### intel pstat 3.6GHz</span></span><br><span class="line"> cpupower  frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 1.20 GHz - 3.70 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 1.20 GHz and 3.70 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 3.60 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br><span class="line"></span><br><span class="line"><span class="comment">### ACPI-cpufreq only 3.4GHz, not 3.6GHz</span></span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: acpi-cpufreq</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency: 10.0 us</span><br><span class="line">  hardware limits: 1.20 GHz - 3.40 GHz</span><br><span class="line">  available frequency steps:  3.40 GHz, 3.40 GHz, 3.30 GHz, 3.10 GHz, 3.00 GHz, 2.80 GHz, 2.70 GHz, 2.50 GHz, 2.30 GHz, 2.20 GHz, 2.00 GHz, 1.90 GHz, 1.70 GHz, 1.60 GHz, 1.40 GHz, 1.20 GHz</span><br><span class="line">  available cpufreq governors: conservative userspace powersave ondemand performance</span><br><span class="line">  current policy: frequency should be within 1.20 GHz and 3.40 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 3.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br></pre></td></tr></table></figure>

<p>After upgarde</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 800 MHz - 3.00 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 800 MHz and 3.00 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 2.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br></pre></td></tr></table></figure>

<p>Single core</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">11671 root      20   0   66.6g  64.1g   2176 S  14.3 40.9   5741:29 xxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<p>Multiple cores</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">19663 root      20   0   41.5g  40.6g   3680 S  2235 25.9 830:58.64 xxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<h3 id="E3-v6-Turbo-not-work-in-CentOS6"><a href="#E3-v6-Turbo-not-work-in-CentOS6" class="headerlink" title="E3 v6 Turbo not work in CentOS6"></a>E3 v6 Turbo not work in CentOS6</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ cpupower frequency-set --governor ondemand/powersave/performance</span><br><span class="line"></span><br><span class="line">CentOS 6</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line"></span><br><span class="line">CentOS 7</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<h5 id="Check-cpu-freq-instead-of-cat-proc-cpuinfo-grep-MHz"><a href="#Check-cpu-freq-instead-of-cat-proc-cpuinfo-grep-MHz" class="headerlink" title="Check cpu freq, instead of cat /proc/cpuinfo | grep MHz"></a>Check cpu freq, instead of cat /proc/cpuinfo | grep MHz</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if you could not get the cpu freq from &quot;cpupower frequency-info&quot;</span></span><br><span class="line"><span class="comment"># use the command </span></span><br><span class="line">cpupower monitor -m Mperf</span><br><span class="line"></span><br><span class="line">cpupower frequency-<span class="builtin-name">set</span> -g performance</span><br><span class="line">cpupower idle-<span class="builtin-name">set</span> -d 0</span><br><span class="line">cpupower idle-<span class="builtin-name">set</span> -d 1</span><br><span class="line">cpupower idle-<span class="builtin-name">set</span> -d 2</span><br><span class="line">tuned-adm<span class="built_in"> profile </span>throughput-performance</span><br><span class="line">tuned-adm active</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.redhat.com/cms/managed-files/Handout%20Performance%20Analysis%20and%20Tuning%20Red%20Hat%20Enterprise%20Linux%202019.pdf">RHEL tuning</a></p>
<ul>
<li>Throughput<ul>
<li>Scheduler quantum (default 4/10 ms,-&gt; 10/15 ms)<ul>
<li>kernel.sched_min_granularity_ns=10000000</li>
<li>kernel_sched_wakeup _granularity_ns = 15000000</li>
</ul>
</li>
<li>Weight function on how often to migrate - 5ms -&gt; 50ms<ul>
<li>kernel.sched_migration_cost_ns=50000000</li>
</ul>
</li>
</ul>
</li>
<li>Latency<ul>
<li>Decrease quantum above to 4 /10 ms<ul>
<li>Adjust power management - BIOS OS controlled</li>
<li>pstates - governor=performance</li>
<li>energy_perf_bias=performance</li>
<li>cstate - force_latency=1</li>
</ul>
</li>
<li>Disable scaning tools for better determinism<ul>
<li>Disable numa balance</li>
<li>kernel.numa_balancing = 0</li>
<li>Disable Transparent HugePages</li>
<li>mm.redhat_transparent_hugepage never</li>
</ul>
</li>
</ul>
</li>
<li>VM Tunables<ul>
<li>Reclaim Ratios</li>
<li>vm.swappiness</li>
<li>vm.vfs_cache_pressure</li>
<li>vm.min_free_kbytes<ul>
<li>Writeback Parameters 30/10 -&gt; 10/3</li>
</ul>
</li>
<li>vm.dirty_background_ratio</li>
<li>vm.dirty_ratio<ul>
<li>Readahead parameters per device 512-&gt; 4k</li>
</ul>
</li>
<li>/sys/block/<bdev>/queue/read_ahead_kb</li>
</ul>
</li>
<li>NUMA hugepage<ul>
<li>Auto numa balancing at scheduling time<ul>
<li>kernel.numa_balancing = 1</li>
<li>Adjust numa scan interval 1000 ms -&gt; 100 ms</li>
<li>vm.zone_reclaim_mode = 1 (reclaim local node vs spill)</li>
</ul>
</li>
<li>Transparent HugePages <ul>
<li>mm.redhat_transparent_hugepage enabled</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>latency-performance  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">force_latency=1</span><br><span class="line">governor=performance</span><br><span class="line">energy_perf_bias=performance</span><br><span class="line">min_perf_pct=100</span><br><span class="line">vm.dirty_ratio=10</span><br><span class="line">vm.dirty_background_ratio=3</span><br><span class="line">vm.swappiness=10</span><br><span class="line">kernel.sched_min_granularity_ns=10000000</span><br><span class="line">kernel.sched_migration_cost_ns=5000000</span><br></pre></td></tr></table></figure>

<p>network-latency</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">include=latency-performance</span><br><span class="line">transparent_hugepages=never</span><br><span class="line">net.core.busy_read=50</span><br><span class="line">net.core.busy_poll=50</span><br><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line">kernel.numa_balancing=0</span><br></pre></td></tr></table></figure>

<p>page fault</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">RHEL</span> <span class="number">7</span>.<span class="number">6</span>, page fault stack not present.</span><br><span class="line"> <span class="attribute">raw_spin_unlock_irqrestore</span></span><br><span class="line"> <span class="attribute">_raw_spin_unlock_irqrestore</span></span><br><span class="line"> <span class="attribute">__wake_up</span></span><br><span class="line"> <span class="attribute">xlog_state_do_callback</span></span><br><span class="line"> <span class="attribute">xlog_state_done_syncing</span></span><br><span class="line"> <span class="attribute">xlog_iodone</span></span><br><span class="line"> <span class="attribute">xfs_buf_ioend</span></span><br><span class="line"> <span class="attribute">Xfs_buf_ioend_work</span></span><br><span class="line"><span class="attribute">RHEL</span> <span class="number">8</span></span><br><span class="line"><span class="attribute">filemap_map_pages</span>+<span class="number">187</span></span><br><span class="line"><span class="attribute">handle_pte_fault</span>+<span class="number">2406</span></span><br><span class="line"><span class="attribute">__handle_mm_fault</span>+<span class="number">1066</span></span><br><span class="line"><span class="attribute">handle_mm_fault</span>+<span class="number">218</span></span><br><span class="line"><span class="attribute">__do_page_fault</span>+<span class="number">586</span></span><br><span class="line"><span class="attribute">do_page_fault</span>+<span class="number">50</span></span><br><span class="line"><span class="attribute">page_fault</span>+<span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>RHEL 8 - Database tuning tips Oracle 12c   </p>
<ul>
<li>Implement huge pages<ul>
<li>Reduce TLB misses</li>
<li>For wiring down database pages</li>
<li>Prevent swapping</li>
</ul>
</li>
<li>Turn off Auto numa<ul>
<li>To prevent conflict with Oracle NUMA optimization</li>
</ul>
</li>
<li>Turn of transparent huge pages<ul>
<li>To reduce CPU overhead of THP scan</li>
</ul>
</li>
<li>Lower dirty background ratio<ul>
<li>Start flushing dirty blocks and reclaim</li>
</ul>
</li>
<li>Increase dirty ratio<ul>
<li>Delay the process of hitting dirty blocks threshold</li>
</ul>
</li>
<li>Use numa pinning in multiple instance environments (including listener process)<ul>
<li>To take advantage of NUMA localization</li>
</ul>
</li>
<li>Size SGA based on user connections (or use connection pooling)<ul>
<li>To prevent memory pressure</li>
</ul>
</li>
</ul>
<h4 id="check-driver"><a href="#check-driver" class="headerlink" title="check driver"></a>check driver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cpupower frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: acpi-cpufreq</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0 1 2 3 4 5 6 7</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency: 10.0 us</span><br><span class="line">  hardware limits: 800 MHz - 3.70 GHz</span><br><span class="line">  available frequency steps:  3.70 GHz, 3.70 GHz, 3.50 GHz, 3.30 GHz, 3.10 GHz, 2.90 GHz, 2.70 GHz, 2.50 GHz, 2.20 GHz, 2.00 GHz, 1.80 GHz, 1.60 GHz, 1.40 GHz, 1.20 GHz, 1000 MHz, 800 MHz</span><br><span class="line">  available cpufreq governors: ondemand userspace performance</span><br><span class="line">  current policy: frequency should be within 800 MHz and 3.70 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;ondemand&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 800 MHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>It ‘s looks like it cound not work in 3.9GHz or 4.1GHz<br>Replace driver to intel_pstate</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">modprobe -r acpi_cpufreq</span><br><span class="line">modprobe intel_pstate</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;install acpi_cpufreq /sbin/modprobe intel_pstate&#x27;</span> &gt;/etc/modprobe.d/cpu.conf</span><br><span class="line">dracut -f --add-drivers intel_pstate</span><br><span class="line"></span><br><span class="line">cpupower frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 800 MHz - 4.10 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 800 MHz and 4.10 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;powersave&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 4.00 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br><span class="line"></span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line"></span><br><span class="line"><span class="comment">#The intel_pstate driver was added later during RHEL6 life cycle and is available in our kernel since RHEL6.5, but Red Hat decided to keep acpi_cpufreq as default to prevent any potential compatibility issues.</span></span><br></pre></td></tr></table></figure>

<h4 id="When-I-run-pigz-to-benchmark"><a href="#When-I-run-pigz-to-benchmark" class="headerlink" title="When I run pigz to benchmark"></a>When I run pigz to benchmark</h4><p>Enable Turbo, acpi-cpufreq(show 3.7GHz) and intel_pstate(3.89GHz) has the same performance (608s finish the benchmark), I can ‘t believe. I test opnessl, Intel® Math Kernel Library , all test result is same. that means in CentOS 6.9 with acpi-cpufreq, just show 3.7GHz, the cpu work in 3.9GHz<br>Disable Turbo in BIOS, acpi-cpufreq(show 3.7GHz) and intel_pstate(3.7GHz) has the same performance too (640s finish the benchmark)<br>About 5% raise, same with cpu frequency distance</p>
<h3 id="Isolated-CPUs-example"><a href="#Isolated-CPUs-example" class="headerlink" title="Isolated CPUs example"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/isolating_cpus_using_tuned-profiles-realtime">Isolated CPUs example</a></h3><p>Isolating CPUs generally involves:<br>removing all user-space threads;<br>removing any unbound kernel threads (bound kernel threads are tied to a specific CPU and may not be moved);<br>removing interrupts by modifying the /proc/irq/N/smp_affinity property of each Interrupt Request (IRQ) number N in the system.</p>
<p>Plan out CPU allocation, e.g.<br>    * CPUs should NOT be used for more than one task.<br>    * CPUs for host OS<br>    * CPUs for XVIO<br>    * CPUs for VMs<br>        * CPUs for guest OS<br>        * CPUs for VNF or application</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ yum install tuned tuned-profiles-realtime</span><br><span class="line">$ cat /etc/tuned/realtime-variables.conf</span><br><span class="line">isolated_cores=0-3,5,7</span><br><span class="line">$ tuned-adm profile realtime</span><br><span class="line">$ grep isolcpus /proc/cmdline</span><br><span class="line">$ </span><br></pre></td></tr></table></figure>
<p><img src="/img/cpu-Isolated-334379.png"></p>
<h3 id="CPU-state"><a href="#CPU-state" class="headerlink" title="CPU state"></a>CPU state</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">P-states – changing frequency <span class="keyword">and</span> voltage of cores, to reduce power dissipation <span class="keyword">or</span> increase performance</span><br><span class="line">C-state – voltage <span class="keyword">and</span> frequency gating <span class="keyword">for</span> CPU cores</span><br><span class="line">PC-state – voltage gating components of the CPU</span><br><span class="line">S-state – sleep state, equivalent to halt</span><br><span class="line">D-state – device power management </span><br><span class="line"></span><br><span class="line">CC0 Normal operating state of the CPU where code is being executed </span><br><span class="line">CC1 All threads on that core execute HLT or MWAIT (C1/C1E) instruction. The core is in low power mode with low voltage and frequency. When returning to CC0, frequency and voltage are restored to the state before idle state. </span><br><span class="line">C1E Same as CC1, but when exiting <span class="keyword">this</span> state, the CPU start operating in LFM CC3 The contents of L1, L2 caches are flushed to LLC, <span class="keyword">and</span> the core’s volt-age is lowered, <span class="keyword">and</span> clock is stopped.  </span><br><span class="line">CC6 The core saves its architectural state to SRAM, <span class="keyword">and</span> the core is com-pletely powered down. </span><br><span class="line">CC7 – CC10 These states are rarely used in Xeon CPUs, but <span class="keyword">if</span> these states are im-plemented, they exhibit the same behaviour as CC6</span><br></pre></td></tr></table></figure>
<p>It is important to note that a CPU has a special register call Time Stamp Counter (TSC). In Intel Xeon CPU, starting from Nehalem generation of CPUs, two generations prior to Ivy Bridge, TSC became C-state invariant, meaning that it never stops counting, and it also counts at a constant frequency.</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PC0 This is the normal operating <span class="keyword">state</span> <span class="keyword">for</span> the processor. The processor remains <span class="keyword">in</span> the normal <span class="keyword">state</span> when at least one of its processor IA cores is <span class="keyword">in</span> the C0 or C1. Individual processor IA cores may be <span class="keyword">in</span> deeper power idle states while the package is <span class="keyword">in</span> C0 <span class="keyword">state</span>. </span><br><span class="line">PC2 Special package C-state not explicitly available <span class="keyword">to</span> SW. There are two scenar-ios when this <span class="keyword">state</span> is used:</span><br><span class="line">    When deeper PC-states are off limits, and PC2 is the deepest PC-state </span><br><span class="line">    When the CPU is <span class="keyword">in</span> PC3 <span class="keyword">state</span> and a memory access request is re-ceived. In this case the CPU transitions <span class="keyword">to</span> PC2, and completes <span class="literal">all</span> out-standing memory access requests, and then transitions back <span class="keyword">to</span> PC3, or PC0 if there is a cause <span class="keyword">to</span> wake <span class="keyword">from</span> idle <span class="keyword">state</span>. </span><br><span class="line">PC3 Package low power <span class="keyword">state</span> </span><br><span class="line">PC6 LLC Cache is flushed, and turned off </span><br><span class="line">PC7 – PC10 Typically present only <span class="keyword">on</span> Desktop CPUs, not <span class="keyword">on</span> CPU meant <span class="keyword">for</span> servers</span><br></pre></td></tr></table></figure>

<p>linux-3.10.0-1127.el7/drivers/idle/intel_idle.c</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">static struct cpuidle_state skx_cstates[] = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">.name</span> = <span class="string">&quot;C1-SKX&quot;</span>,</span><br><span class="line">                <span class="string">.desc</span> = <span class="string">&quot;MWAIT 0x00&quot;</span>,</span><br><span class="line">                <span class="string">.flags</span> = MWAIT2flg<span class="params">(0x00)</span>,</span><br><span class="line">                <span class="string">.exit_latency</span> = 2,</span><br><span class="line">                <span class="string">.target_residency</span> = 2,</span><br><span class="line">                <span class="string">.enter</span> = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">.name</span> = <span class="string">&quot;C1E-SKX&quot;</span>,</span><br><span class="line">                <span class="string">.desc</span> = <span class="string">&quot;MWAIT 0x01&quot;</span>,</span><br><span class="line">                <span class="string">.flags</span> = MWAIT2flg<span class="params">(0x01)</span>,</span><br><span class="line">                <span class="string">.exit_latency</span> = 10,</span><br><span class="line">                <span class="string">.target_residency</span> = 20,</span><br><span class="line">                <span class="string">.enter</span> = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">.name</span> = <span class="string">&quot;C6-SKX&quot;</span>,</span><br><span class="line">                <span class="string">.desc</span> = <span class="string">&quot;MWAIT 0x20&quot;</span>,</span><br><span class="line">                <span class="string">.flags</span> = MWAIT2flg<span class="params">(0x20)</span> | CPUIDLE_FLAG_TLB_FLUSHED,</span><br><span class="line">                <span class="string">.exit_latency</span> = 133,</span><br><span class="line">                <span class="string">.target_residency</span> = 600,</span><br><span class="line">                <span class="string">.enter</span> = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">.enter</span> = NULL &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="kernel-parameter"><a href="#kernel-parameter" class="headerlink" title="kernel parameter"></a>kernel parameter</h3><ul>
<li>intel_idle.max_cstate=0 processor.max_cstate=0 idle=mwait<ul>
<li>idle=mwait C1 will be entered whenever the core is idle irrespective of other settings</li>
<li>idle=poll keeps the processing cores in C0 state when used in conjunction with intel_idle.max_cstate=0</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=32-47,48-63 default_hugepagesz=1GB hugepagesz=1G hugepages=12 intel_idle.max_cstate=0 processor.max_cstate=0 idle=nomwait&quot;</span></span><br><span class="line"></span><br><span class="line">CPU idle time management: idle=poll, idle=halt, and idle=nomwait</span><br><span class="line">The first two of them <span class="built_in">disable</span> the acpi_idle and intel_idle drivers altogether, <span class="built_in">which</span> effectively causes the entire CPUIdle subsystem to be disabled and makes the idle loop invoke the architecture support code to deal with idle CPUs</span><br><span class="line">In the idle=halt <span class="keyword">case</span>, the architecture support code will use the HLT instruction of the CPUs (<span class="built_in">which</span>, as a rule, suspends the execution of the program and causes the hardware to attempt to enter the shallowest available idle state) <span class="keyword">for</span> this purpose, and <span class="keyword">if</span> idle=poll is used, idle CPUs will execute a more or lessa lightweight<span class="string">&#x27;&#x27;</span> sequence of instructions <span class="keyword">in</span> a tight loop.</span><br><span class="line"></span><br><span class="line">idle=poll is somewhat drastic <span class="keyword">in</span> many cases, as preventing idle CPUs from saving almost any energy at all may not be the only effect of it.</span><br><span class="line"></span><br><span class="line">For example, on Intel hardware it effectively prevents CPUs from using P-states (see CPU Performance Scaling) that require any number of CPUs <span class="keyword">in</span> a package to be idle, so it very well may hurt single-thread computations performance as well as energy-efficiency. Thus using it <span class="keyword">for</span> performance reasons may not be a good idea at all</span><br><span class="line"></span><br><span class="line">The idle=nomwait option disables the intel_idle driver and causes acpi_idle to be used (as long as all of the information needed by it is there <span class="keyword">in</span> the system’s ACPI tables), but it is not allowed to use the MWAIT instruction of the CPUs to ask the hardware to enter idle states.</span><br><span class="line"></span><br><span class="line">In addition to the architecture-level kernel <span class="built_in">command</span> line options affecting CPU idle time management, there are parameters affecting individual CPUIdle drivers that can be passed to them via the kernel <span class="built_in">command</span> line. Specifically, the intel_idle.max_cstate=&lt;n&gt; and processor.max_cstate=&lt;n&gt; parameters, <span class="built_in">where</span> &lt;n&gt; is an idle state index also used <span class="keyword">in</span> the name of the given state’s directory <span class="keyword">in</span> sysfs (see Representation of Idle States), causes the intel_idle and acpi_idle drivers, respectively, to discard all of the idle states deeper than idle state &lt;n&gt;</span><br><span class="line"></span><br><span class="line">https://www.kernel.org/doc/html/v5.0/admin-guide/pm/cpuidle.html</span><br></pre></td></tr></table></figure>

<h4 id="isolcpus"><a href="#isolcpus" class="headerlink" title="isolcpus"></a><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1792712">isolcpus</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## run the benchmark for all cores, you could see the core 2 not worked</span></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;  </span><br><span class="line">   fork();</span><br><span class="line">   fork();</span><br><span class="line">   fork();</span><br><span class="line">   <span class="keyword">while</span>(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## you could taskset to core 2</span></span><br><span class="line">$ taskset -c 2 ./your_app</span><br><span class="line"></span><br><span class="line"><span class="comment">## isolate the kernel thread and interrupt</span></span><br><span class="line">$ cat /sys/..../smp_affinity</span><br><span class="line">fb</span><br><span class="line">fb = 11111011</span><br><span class="line">          |</span><br><span class="line">	  -----avoid the core 2</span><br></pre></td></tr></table></figure>

<p>the author show the timer tick in the core 2 too<br>The kernel docs <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/timers/no_hz.html">NO_HZ</a></p>
<ul>
<li><p>ever omit scheduling-clock ticks (CONFIG_HZ_PERIODIC=y or CONFIG_NO_HZ=n for older kernels). You normally will -not- want to choose this option.</p>
</li>
<li><p>Omit scheduling-clock ticks on idle CPUs (CONFIG_NO_HZ_IDLE=y or CONFIG_NO_HZ=y for older kernels). This is the most common approach, and should be the default.</p>
</li>
<li><p>Omit scheduling-clock ticks on CPUs that are either idle or that have only one runnable task (CONFIG_NO_HZ_FULL=y). Unless you are running realtime applications or certain types of HPC workloads, you will normally -not- want this option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /boot/config-5.11.0-25-generic | grep NO_HZ_FULL</span><br><span class="line"><span class="comment"># CONFIG_NO_HZ_FULL is not set</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## recomplie the kernel</span></span><br><span class="line">CONFIG_NO_HZ_FULL=y</span><br><span class="line">(x) Full dynticks system(tickless)</span><br></pre></td></tr></table></figure>
<p>Only one job in core 2, the timer interrupt will not increase…. not test, just record<br>and he use dma-map-benchmark to run DMA map and unmap, the core 2 not work too  </p>
</li>
<li><p>In the HPC env</p>
<ul>
<li>isolcpus these cores<ul>
<li>pin the HPC job to these cores(part 1)</li>
<li>pin the interrupt and kernel threads to another cores(part 2)</li>
<li>CONFIG_NO_HZ_FULL=y and running single job to each core</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="tuna"><a href="#tuna" class="headerlink" title="tuna"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-CPU-Configuration_suggestions#sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-Configuration_suggestions-Configuring_CPU_thread_and_interrupt_affinity_with_Tuna">tuna</a></h4><p>pin cpu   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl stop irqbalance.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#Move an irq to cpu 5</span></span><br><span class="line">$ tuna -c5 -q eth4-rx-4 -move</span><br><span class="line"></span><br><span class="line"><span class="comment">#Move all irqs named &quot;eth4*&quot; away from numa node 1</span></span><br><span class="line">$ tuna -S 1 -i -q <span class="string">&#x27;eth4*&#x27;</span>  </span><br><span class="line">                    |</span><br><span class="line">                    ---name from /proc/interrupts</span><br><span class="line"></span><br><span class="line">$ systemctl stop irqbalance.service</span><br><span class="line">$ tuna -c 8-15 -t <span class="string">&#x27;*rcu*&#x27;</span> --move</span><br><span class="line">or</span><br><span class="line">$ tuna -C 8-15 -i -q <span class="string">&#x27;mlx5_comp*@pci:0000:c1:00.0&#x27;</span></span><br><span class="line">$ tuna -C 8-15 -i -q <span class="string">&#x27;mlx5_comp*@pci:0000:c1:00.1&#x27;</span></span><br><span class="line">$ tuna -C 8-15 -i -q <span class="string">&#x27;mpt3sas*-msix*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Move lustre and zfs process</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/module/spl/parameters/spl_taskq_thread_dynamic</span><br><span class="line">$ tuna --cpus=8-15 --threads z_wr_iss* --move</span><br><span class="line">$ tuna --cpus=8-15 --threads z_wr_int* --move</span><br><span class="line">$ tuna --cpus=0-7 --threads socknal* --move</span><br><span class="line">$ tuna --cpus=0-7 --threads ll_ost_io* --move</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ tuna --cpus CPUs --isolate</span><br><span class="line">$ tuna --cpus CPUs --include</span><br><span class="line">$ tuna --irqs IRQs --cpus CPU --move</span><br><span class="line">$ tuna --irqs sfc1* -c7 -m -x</span><br><span class="line">$ tuna --irqs <span class="string">&#x27;enp1s0f*&#x27;</span> --socket 0 --spread --show_irqs</span><br><span class="line">$ tuna --threads thread --priority policy:level  <span class="comment">#level:0-99</span></span><br><span class="line">$ tuna --cpus=0,1 --threads=ssh* --move --cpus=2,3 --threads=http* --move</span><br><span class="line">$ tuna --threads 7861 --show_threads</span><br><span class="line">$ tuna --threads 7861 --priority=RR:40</span><br><span class="line">$ tuna -t qemu* -P -c0 -mP -c1 -mP -c+0 -mP</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0 0xff,0xffffffff    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0 0xff,0xffffffff   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0 0xff,0xffffffff   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0 0xff,0xffffffff  54315196        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0 0xff,0xffffffff  42864592         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        0    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        0   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        0   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        0  54315198        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        0  42864593         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        1  54315200        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        1  42864595         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0      0,1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0      0,1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0      0,1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0      0,1  54315202        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0      0,1  42864597         6630        qemu-kvm</span><br></pre></td></tr></table></figure>

<h3 id="cpu-IPC-Instruction-Per-Clock-cycle"><a href="#cpu-IPC-Instruction-Per-Clock-cycle" class="headerlink" title="cpu IPC (Instruction Per Clock cycle)"></a>cpu IPC (Instruction Per Clock cycle)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cpu FSB x multiplier = frequency</span><br><span class="line">cpu frequency x IPC</span><br></pre></td></tr></table></figure>

<h3 id="Benchmark-CPU"><a href="#Benchmark-CPU" class="headerlink" title="Benchmark CPU"></a>Benchmark CPU</h3><h4 id="gcc-x86-options"><a href="#gcc-x86-options" class="headerlink" title="gcc_x86_options"></a><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/x86-Options.html">gcc_x86_options</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">-march=cpu-type</span><br><span class="line">Generate instructions <span class="keyword">for</span> the machine <span class="built_in">type</span> cpu-type. </span><br><span class="line"></span><br><span class="line">-mtune=cpu-type ; only generic and intel</span><br><span class="line">Tune to cpu-type everything applicable about the generated code, except <span class="keyword">for</span> the ABI and the <span class="built_in">set</span> of available instructions. </span><br><span class="line"></span><br><span class="line">-mincoming-stack-boundary=num</span><br><span class="line">Assume the incoming stack is aligned to a 2 raised to num byte boundary. If -mincoming-stack-boundary is not specified, the one specified by -mpreferred-stack-boundary is used.</span><br><span class="line">-mmmx</span><br><span class="line">-msse</span><br><span class="line">-msse2</span><br><span class="line">-msse3</span><br><span class="line">-mssse3</span><br><span class="line">-msse4</span><br><span class="line">-msse4a</span><br><span class="line">-msse4.1</span><br><span class="line">-msse4.2</span><br><span class="line">-mavx</span><br><span class="line">-mavx2</span><br><span class="line">-mavx512f</span><br><span class="line">-mavx512pf</span><br><span class="line">-mavx512er</span><br><span class="line">-mavx512cd</span><br><span class="line">-mavx512vl</span><br><span class="line">-mavx512bw</span><br><span class="line">-mavx512dq</span><br><span class="line">-mavx512ifma</span><br><span class="line">-mavx512vbmi</span><br><span class="line">-mavx512vbmi2</span><br><span class="line">-mavx512bf16</span><br><span class="line">-mavx512vpopcntdq</span><br><span class="line">-mavx512vp2intersect</span><br><span class="line">-mavx5124fmaps</span><br><span class="line">-mavx512vnni</span><br><span class="line">-mavx5124vnniw</span><br><span class="line">-mcldemote</span><br><span class="line">.... <span class="comment">## too many</span></span><br><span class="line"></span><br><span class="line">-mprefer-vector-width=opt</span><br><span class="line">This option instructs GCC to use opt-bit vector width <span class="keyword">in</span> instructions instead of default on the selected platform.</span><br><span class="line">none/128/256/512</span><br><span class="line"></span><br><span class="line"><span class="comment">### test Makefile</span></span><br><span class="line">CFLAGS = -m64 -Wall -O3 -fopenmp</span><br><span class="line">CFLAGS = -m64 -g -Wall -fopenmp -lpthread -march=broadwell -mavx2 -mprefer-vector-width=256</span><br><span class="line">CFLAGS = -m64 -g -Wall -fopenmp -lpthread -march=skylake-avx512 -mprefer-vector-width=512 -mavx512pf</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Check gcc parameters</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc <span class="attribute">-march</span>=native -Q <span class="attribute">--help</span>=target</span><br><span class="line"></span><br><span class="line">$ gcc <span class="attribute">-march</span>=native -Q <span class="attribute">--help</span>=target|grep march</span><br><span class="line">-march=                               broadwell</span><br></pre></td></tr></table></figure>

<h3 id="Disable-CPU-features"><a href="#Disable-CPU-features" class="headerlink" title="Disable CPU features"></a><a target="_blank" rel="noopener" href="https://www.ibm.com/support/pages/how-disable-cpu-feature-flag-hle-hardware-lock-elision-rhel-x86-intel">Disable CPU features</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">CentOS 8.5 </span><br><span class="line"></span><br><span class="line">linux-4.18.0-305.el8/arch/x86/include/asm/cpufeatures.h</span><br><span class="line"></span><br><span class="line"><span class="comment">#define X86_FEATURE_HLE                 ( 9*32+ 4) /* Hardware Lock Elision */ 292</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX                 ( 4*32+28) /* Advanced Vector Extensions */ 156</span></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX2                ( 9*32+ 5) /* AVX2 instructions */   293</span></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX512F		( 9*32+16) /* AVX-512 Foundation */  304</span></span><br><span class="line"></span><br><span class="line">$ grep -io avx2 /proc/cpuinfo </span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;clearcpuid=293&#x27;</span></span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$ grep -io avx2 /proc/cpuinfo </span><br><span class="line"><span class="comment"># no output, grep failed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add another flag</span></span><br><span class="line">$ grep -io hle /proc/cpuinfo</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line"></span><br><span class="line"><span class="comment">## support from linux 5.10</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;clearcpuid=292,293,304&#x27;</span> </span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">## https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0a4bb5e5507a585532cc413125b921c8546fc39f</span></span><br><span class="line">x86/fpu: Allow multiple bits <span class="keyword">in</span> clearcpuid= parameter</span><br><span class="line">The Linux 5.10 support multile bits</span><br><span class="line">compare with the centos 8.5 <span class="built_in">source</span> code, it <span class="string">&#x27;s not support multiple bits</span></span><br></pre></td></tr></table></figure>

<h3 id="Disable-AVX"><a href="#Disable-AVX" class="headerlink" title="Disable AVX"></a><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/articles/introduction-to-intel-advanced-vector-extensions">Disable AVX</a></h3><p>To use the Intel AVX extensions reliably in most settings, the operating system must support saving and loading the new registers (with XSAVE/XRSTOR) on thread context switches to prevent data corruption. To help avoid such errors, operating systems supporting Intel AVX-aware context switches explicitly set a CPU bit enabling the new instructions; otherwise, an undefined opcode (#UD) exception is generated when Intel AVX instructions are used.</p>
<p>Add kernel parameter to disable AVX </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">        noxsave         [BUGS=X86] Disables x86 extended register state save</span><br><span class="line">                        and restore using xsave. The kernel will fallback to</span><br><span class="line">                        enabling legacy floating-point and sse state.</span><br><span class="line"></span><br><span class="line">        noxsaveopt      [X86] Disables xsaveopt used <span class="keyword">in</span> saving x86 extended</span><br><span class="line">                        register states. The kernel will fall back to use</span><br><span class="line">                        xsave to save the states. By using this parameter,</span><br><span class="line">                        performance of saving the states is degraded because</span><br><span class="line">                        xsave doesn<span class="string">&#x27;t support modified optimization while</span></span><br><span class="line"><span class="string">                        xsaveopt supports it on xsaveopt enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        noxsaves        [X86] Disables xsaves and xrstors used in saving and</span></span><br><span class="line"><span class="string">                        restoring x86 extended register state in compacted</span></span><br><span class="line"><span class="string">                        form of xsave area. The kernel will fall back to use</span></span><br><span class="line"><span class="string">                        xsaveopt and xrstor to save and restore the states</span></span><br><span class="line"><span class="string">                        in standard form of xsave area. By using this</span></span><br><span class="line"><span class="string">                        parameter, xsave area per process might occupy more</span></span><br><span class="line"><span class="string">                        memory on xsaves enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cpuid | grep XSAVE -i | head</span></span><br><span class="line"><span class="string">Disclaimer: cpuid may not support decoding of all cpuid registers.</span></span><br><span class="line"><span class="string">      FXSAVE/FXRSTOR                         = true</span></span><br><span class="line"><span class="string">      XSAVE/XSTOR states                      = true</span></span><br><span class="line"><span class="string">      OS-enabled XSAVE/XSTOR                  = true</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/0):</span></span><br><span class="line"><span class="string">      bytes required by XSAVE/XRSTOR area     = 0x00000340 (832)</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/1):</span></span><br><span class="line"><span class="string">      XSAVEOPT instruction                        = true</span></span><br><span class="line"><span class="string">      XSAVEC instruction                          = false</span></span><br><span class="line"><span class="string">      XSAVES/XRSTORS instructions                 = false</span></span><br><span class="line"><span class="string">      64-byte alignment in compacted XSAVE     = false</span></span><br></pre></td></tr></table></figure>

<h3 id="Found-the-half-cores"><a href="#Found-the-half-cores" class="headerlink" title="Found the half cores"></a>Found the half cores</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ((i=0;i&lt;$(grep -c processor /proc/cpuinfo);i++)); </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  cat /sys/devices/system/cpu/cpu<span class="variable">$i</span>/cache/index2/shared_cpu_list; </span><br><span class="line"><span class="keyword">done</span> | awk -F, <span class="string">&#x27;&#123;a[$1]=$0&#125; END&#123;</span></span><br><span class="line"><span class="string">  count=0;</span></span><br><span class="line"><span class="string">  for (i in a) &#123;</span></span><br><span class="line"><span class="string">     if(count==0) &#123;</span></span><br><span class="line"><span class="string">       printf i</span></span><br><span class="line"><span class="string">     &#125; else &#123;</span></span><br><span class="line"><span class="string">       printf &quot;,&quot;i</span></span><br><span class="line"><span class="string">     &#125;;</span></span><br><span class="line"><span class="string">       count++ </span></span><br><span class="line"><span class="string">  &#125; </span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">17,4,18,5,19,6,7,8,9,10,11,12,13,0,14,1,15,2,16,3</span><br></pre></td></tr></table></figure>

<h3 id="Turn-off-the-cpu-cores"><a href="#Turn-off-the-cpu-cores" class="headerlink" title="Turn off the cpu cores"></a>Turn off the cpu cores</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpu17/online</span><br></pre></td></tr></table></figure>

<h3 id="set-parameter-for-storage-system"><a href="#set-parameter-for-storage-system" class="headerlink" title="set parameter for storage system"></a>set parameter for storage system</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ find /sys -iname  rq_affinity ! -name <span class="string">&#x27;*irq*&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> <span class="built_in">echo</span> 2 &gt; <span class="variable">$line</span> ; <span class="keyword">done</span></span><br><span class="line">If this option is <span class="string">&#x27;1&#x27;</span>, the block layer will migrate request completions to the cpu <span class="string">&quot;group&quot;</span> that originally submitted the request. For some workloads this provides a significant reduction <span class="keyword">in</span> CPU cycles due to caching effects.</span><br><span class="line"></span><br><span class="line">For storage configurations that need to maximize distribution of completion processing setting this option to <span class="string">&#x27;2&#x27;</span> forces the completion to run on the requesting cpu (bypassing the <span class="string">&quot;group&quot;</span> aggregation logic).</span><br></pre></td></tr></table></figure>

<h3 id="UDP-performance-in-AMD-roma-2x-7552"><a href="#UDP-performance-in-AMD-roma-2x-7552" class="headerlink" title="UDP performance in AMD roma (2x 7552)"></a>UDP performance in AMD roma (2x 7552)</h3><p>You could see top performance in CPU core 74, pps reach to 0.936M pps</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                96</span><br><span class="line">On-line CPU(s) list:   0-95</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    48</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Vendor ID:             AuthenticAMD</span><br><span class="line">CPU family:            23</span><br><span class="line">Model:                 49</span><br><span class="line">Model name:            AMD EPYC 7552 48-Core Processor</span><br><span class="line">Stepping:              0</span><br><span class="line">CPU MHz:               2200.000</span><br><span class="line">CPU max MHz:           2200.0000</span><br><span class="line">CPU min MHz:           1500.0000</span><br><span class="line">BogoMIPS:              4400.06</span><br><span class="line">Virtualization:        AMD-V</span><br><span class="line">L1d cache:             32K</span><br><span class="line">L1i cache:             32K</span><br><span class="line">L2 cache:              512K</span><br><span class="line">L3 cache:              16384K</span><br><span class="line">NUMA node0 CPU(s):     0-47</span><br><span class="line">NUMA node1 CPU(s):     48-95</span><br><span class="line">Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc art rep_good nopl xtopology nonstop_tsc extd_apicid aperfmperf eagerfpu pni pclmulqdq monitor ssse3 fma cx16 sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand lahf_lm cmp_legacy svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw ibs skinit wdt tce topoext perfctr_core perfctr_nb bpext perfctr_l2 cpb cat_l3 cdp_l3 hw_pstate sme retpoline_amd ssbd ibrs ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 cqm rdt_a rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local clzero irperf xsaveerptr arat npt lbrv svm_lock nrip_save tsc_scale vmcb_clean flushbyasid decodeassists pausefilter pfthreshold avic v_vmsave_vmload vgif umip overflow_recov succor smca</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> ((i=4;i&lt;=96;i=i+10)); <span class="keyword">do</span> <span class="built_in">echo</span> CPU core:<span class="variable">$i</span>; timeout 5 taskset -c <span class="variable">$i</span> ./receiver 0.0.0.0:4321; <span class="keyword">done</span></span><br><span class="line">CPU core:4</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">CPU core:14</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.411M pps  12.538MiB / 105.177Mb</span><br><span class="line">  0.455M pps  13.891MiB / 116.523Mb</span><br><span class="line">  0.452M pps  13.797MiB / 115.737Mb</span><br><span class="line">  0.430M pps  13.109MiB / 109.969Mb</span><br><span class="line">CPU core:24</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.455M pps  13.875MiB / 116.392Mb</span><br><span class="line">  0.411M pps  12.532MiB / 105.124Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">CPU core:34</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.442M pps  13.500MiB / 113.246Mb</span><br><span class="line">  0.425M pps  12.969MiB / 108.790Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">CPU core:44</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.454M pps  13.859MiB / 116.261Mb</span><br><span class="line">  0.455M pps  13.875MiB / 116.392Mb</span><br><span class="line">  0.454M pps  13.844MiB / 116.130Mb</span><br><span class="line">  0.440M pps  13.422MiB / 112.591Mb</span><br><span class="line">CPU core:54</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.719M pps  21.929MiB / 183.950Mb</span><br><span class="line">  0.685M pps  20.907MiB / 175.383Mb</span><br><span class="line">  0.680M pps  20.766MiB / 174.199Mb</span><br><span class="line">  0.544M pps  16.611MiB / 139.345Mb</span><br><span class="line">CPU core:64</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.586M pps  17.888MiB / 150.057Mb</span><br><span class="line">  0.626M pps  19.093MiB / 160.164Mb</span><br><span class="line">  0.629M pps  19.200MiB / 161.061Mb</span><br><span class="line">  0.630M pps  19.232MiB / 161.329Mb</span><br><span class="line">CPU core:74</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.936M pps  28.571MiB / 239.668Mb</span><br><span class="line">  0.935M pps  28.540MiB / 239.410Mb</span><br><span class="line">  0.936M pps  28.563MiB / 239.602Mb</span><br><span class="line">  0.948M pps  28.928MiB / 242.669Mb</span><br><span class="line">CPU core:84</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.616M pps  18.786MiB / 157.585Mb</span><br><span class="line">  0.622M pps  18.976MiB / 159.180Mb</span><br><span class="line">  0.618M pps  18.847MiB / 158.102Mb</span><br><span class="line">  0.615M pps  18.780MiB / 157.541Mb</span><br><span class="line">CPU core:94</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.576M pps  17.589MiB / 147.543Mb</span><br><span class="line">  0.674M pps  20.583MiB / 172.664Mb</span><br><span class="line">  0.672M pps  20.499MiB / 171.958Mb</span><br><span class="line">  0.678M pps  20.684MiB / 173.507Mb</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> ((i=1;i&lt;=96;i=i+10)); <span class="keyword">do</span> <span class="built_in">echo</span> CPU core:<span class="variable">$i</span>; timeout 5 taskset -c <span class="variable">$i</span> ./receiver 0.0.0.0:4321; <span class="keyword">done</span></span><br><span class="line">CPU core:1</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.440M pps  13.422MiB / 112.591Mb</span><br><span class="line">  0.452M pps  13.797MiB / 115.737Mb</span><br><span class="line">  0.442M pps  13.484MiB / 113.115Mb</span><br><span class="line">  0.441M pps  13.453MiB / 112.853Mb</span><br><span class="line">CPU core:11</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.433M pps  13.203MiB / 110.756Mb</span><br><span class="line">  0.433M pps  13.221MiB / 110.907Mb</span><br><span class="line">  0.434M pps  13.234MiB / 111.018Mb</span><br><span class="line">  0.433M pps  13.219MiB / 110.887Mb</span><br><span class="line">CPU core:21</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.439M pps  13.406MiB / 112.460Mb</span><br><span class="line">  0.438M pps  13.375MiB / 112.198Mb</span><br><span class="line">  0.438M pps  13.375MiB / 112.198Mb</span><br><span class="line">  0.438M pps  13.375MiB / 112.198Mb</span><br><span class="line">CPU core:31</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.428M pps  13.047MiB / 109.445Mb</span><br><span class="line">  0.428M pps  13.062MiB / 109.576Mb</span><br><span class="line">  0.428M pps  13.062MiB / 109.576Mb</span><br><span class="line">  0.428M pps  13.047MiB / 109.445Mb</span><br><span class="line">CPU core:41</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.425M pps  12.969MiB / 108.790Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">CPU core:51</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.617M pps  18.828MiB / 157.938Mb</span><br><span class="line">  0.651M pps  19.881MiB / 166.777Mb</span><br><span class="line">  0.638M pps  19.465MiB / 163.284Mb</span><br><span class="line">  0.645M pps  19.670MiB / 165.000Mb</span><br><span class="line">CPU core:61</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.595M pps  18.156MiB / 152.307Mb</span><br><span class="line">  0.631M pps  19.271MiB / 161.654Mb</span><br><span class="line">  0.654M pps  19.973MiB / 167.548Mb</span><br><span class="line">  0.654M pps  19.956MiB / 167.400Mb</span><br><span class="line">CPU core:71</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.517M pps  15.792MiB / 132.474Mb</span><br><span class="line">  0.611M pps  18.643MiB / 156.390Mb</span><br><span class="line">  0.611M pps  18.642MiB / 156.381Mb</span><br><span class="line">  0.558M pps  17.035MiB / 142.898Mb</span><br><span class="line">CPU core:81</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.614M pps  18.743MiB / 157.231Mb</span><br><span class="line">  0.616M pps  18.802MiB / 157.720Mb</span><br><span class="line">  0.627M pps  19.136MiB / 160.525Mb</span><br><span class="line">  0.626M pps  19.117MiB / 160.361Mb</span><br><span class="line">CPU core:91</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.613M pps  18.692MiB / 156.800Mb</span><br><span class="line">  0.624M pps  19.055MiB / 159.843Mb</span><br><span class="line">  0.632M pps  19.280MiB / 161.730Mb</span><br><span class="line">  0.633M pps  19.316MiB / 162.035Mb</span><br></pre></td></tr></table></figure>

<h3 id="intel-cmt-cat"><a href="#intel-cmt-cat" class="headerlink" title="intel-cmt-cat"></a>intel-cmt-cat</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ yum install <span class="built_in">int</span>el-cmt-cat.x86_64</span><br><span class="line"></span><br><span class="line">TIME <span class="number">2020</span><span class="number">-01</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">05</span></span><br><span class="line">           LLC(Last Level Cache): CMT(Cache Monitoring Technology) Cache Occupancy</span><br><span class="line">           MBL:MBM local bandwidth</span><br><span class="line">           MBR:MBM Remote bandwidth</span><br><span class="line">$ pqos</span><br><span class="line">    CORE   IPC   MISSES     LLC[KB]   MBL[MB/s]   MBR[MB/s]</span><br><span class="line"></span><br><span class="line">       <span class="number">0</span>  <span class="number">0.26</span>       <span class="number">6</span>k      <span class="number">1080.0</span>         <span class="number">0.2</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">1</span>  <span class="number">0.26</span>       <span class="number">0</span>k         <span class="number">0.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">2</span>  <span class="number">0.27</span>       <span class="number">4</span>k      <span class="number">4600.0</span>         <span class="number">0.5</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">3</span>  <span class="number">0.26</span>       <span class="number">5</span>k       <span class="number">520.0</span>         <span class="number">0.0</span>         <span class="number">0.2</span></span><br><span class="line">       <span class="number">4</span>  <span class="number">0.27</span>       <span class="number">8</span>k      <span class="number">1120.0</span>         <span class="number">0.7</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">5</span>  <span class="number">0.25</span>      <span class="number">12</span>k      <span class="number">1080.0</span>         <span class="number">0.7</span>         <span class="number">0.2</span></span><br><span class="line">       <span class="number">6</span>  <span class="number">0.28</span>      <span class="number">18</span>k      <span class="number">1040.0</span>         <span class="number">0.9</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">7</span>  <span class="number">0.25</span>       <span class="number">0</span>k         <span class="number">0.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">8</span>  <span class="number">0.27</span>       <span class="number">4</span>k      <span class="number">3400.0</span>         <span class="number">0.2</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">9</span>  <span class="number">0.25</span>       <span class="number">0</span>k      <span class="number">1360.0</span>         <span class="number">0.1</span>         <span class="number">0.1</span></span><br><span class="line">      <span class="number">10</span>  <span class="number">0.26</span>      <span class="number">14</span>k      <span class="number">7000.0</span>         <span class="number">1.3</span>         <span class="number">0.0</span></span><br><span class="line">      <span class="number">11</span>  <span class="number">0.39</span>       <span class="number">1</span>k       <span class="number">120.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>L3 misses/s (LUR, more L3 and lower misses in some case)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/intel/intel-cmt-cat/wiki/Usage-Examples">Usage-example</a></p>
<p>Cache Monitoring Technology (CMT)<br>Cache Allocation Technology (CAT)<br>Memory Bandwidth Monitoring (MBM)<br>Memory Bandwidth Allocation (MBA)<br>Code and Data Prioritization (CDP)</p>
<h3 id="proc-stat"><a href="#proc-stat" class="headerlink" title="/proc/stat"></a>/proc/stat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/<span class="built_in">stat</span></span><br><span class="line">    user nice system idle  iowait irq softirq steal guest  guest_nice</span><br><span class="line">cpu  602  8    786  680812 901    0   13      29    0      0</span><br><span class="line"></span><br><span class="line"><span class="comment"># steal</span></span><br><span class="line">Stolen time, <span class="built_in">which</span> is the time spent <span class="keyword">in</span> other operating systems when running <span class="keyword">in</span> a virtualized environment</span><br><span class="line"></span><br><span class="line">$ getconf CLK_TCK</span><br><span class="line">100</span><br><span class="line"></span><br><span class="line">cpuTime = 1000ull * 1000ull * 1000ull * (usertime + systime) / (unsigned long long)sysconf(_SC_CLK_TCK);</span><br></pre></td></tr></table></figure>

<h3 id="numa"><a href="#numa" class="headerlink" title="numa"></a>numa</h3><h4 id="numastat"><a href="#numastat" class="headerlink" title="numastat"></a>numastat</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">numastat -nc</span><br><span class="line"></span><br><span class="line">Per-node numastat info (<span class="keyword">in</span> MBs):</span><br><span class="line">                 Node 0  Node 1    Total</span><br><span class="line">                ------- ------- --------</span><br><span class="line">Numa_Hit        6966101 4861306 11827407</span><br><span class="line">Numa_Miss         47509    2039    49548</span><br><span class="line">Numa_Foreign       2039   47509    49548</span><br><span class="line">Interleave_Hit      142     142      284</span><br><span class="line">Local_Node      6966031 4861115 11827145</span><br><span class="line">Other_Node        47579    2231    49810</span><br><span class="line"></span><br><span class="line">numastat -mc</span><br><span class="line"></span><br><span class="line">Per-node system memory usage (<span class="keyword">in</span> MBs):</span><br><span class="line">                 Node 0 Node 1  Total</span><br><span class="line">                 ------ ------ ------</span><br><span class="line">MemTotal          64214  64464 128678</span><br><span class="line">MemFree            3895  25196  29091</span><br><span class="line">MemUsed           60319  39267  99586</span><br><span class="line">Active            37061  36103  73163</span><br><span class="line">Inactive          20956    779  21735</span><br><span class="line">Active(anon)         23     24     47</span><br><span class="line">Inactive(anon)       26     25     51</span><br><span class="line">Active(file)      37038  36079  73117</span><br><span class="line">Inactive(file)    20931    754  21685</span><br><span class="line">Unevictable           0      0      0</span><br><span class="line">Mlocked               0      0      0</span><br><span class="line">Dirty                 0      0      0</span><br><span class="line">Writeback             0      0      0</span><br><span class="line">FilePages         57994  36858  94852</span><br><span class="line">Mapped               23      6     29</span><br><span class="line">AnonPages            23     24     47</span><br><span class="line">Shmem                25     25     50</span><br><span class="line">KernelStack           5      4      9</span><br><span class="line">PageTables            1      2      4</span><br><span class="line">NFS_Unstable          0      0      0</span><br><span class="line">Bounce                0      0      0</span><br><span class="line">WritebackTmp          0      0      0</span><br><span class="line">Slab               1073   1122   2195</span><br><span class="line">SReclaimable        895   1003   1898</span><br><span class="line">SUnreclaim          178    119    297</span><br><span class="line">AnonHugePages         2      6      8</span><br><span class="line">HugePages_Total       0      0      0</span><br><span class="line">HugePages_Free        0      0      0</span><br><span class="line">HugePages_Surp        0      0      0</span><br><span class="line"></span><br><span class="line"><span class="comment">## memory status</span></span><br><span class="line">$ perf <span class="built_in">stat</span> -e <span class="built_in">sched</span>:sched_stick_numa,<span class="built_in">sched</span>:sched_move_numa,<span class="built_in">sched</span>:sched_swap_numa,migrate:mm_migrate_pages,minor-faults -p PID</span><br></pre></td></tr></table></figure>

<h3 id="How-many-temperature-is-high-for-intel-CPU"><a href="#How-many-temperature-is-high-for-intel-CPU" class="headerlink" title="How many temperature is high for intel CPU ?"></a>How many temperature is high for intel CPU ?</h3><p>In intel 2nd Gen Scalable Xeon refresh version just 14nm+++, so it cause high temperature, eg: 6248R</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">     air---------------------------T(ambient) ----</span><br><span class="line">                                                 |</span><br><span class="line">| | | | | | | | |                               sa------</span><br><span class="line">| |cooling fin| |                                |     |</span><br><span class="line">| | | | |-------------------------T(sink)--------      |</span><br><span class="line">| | | | | | | | |                               cs     ca</span><br><span class="line">^^^^^^^^^-------------------------T(<span class="keyword">case</span>)--------      |</span><br><span class="line">|    =======    |                               jc-----</span><br><span class="line">|   |||CPU------------------------T(junction)----</span><br><span class="line">==================</span><br><span class="line">|===baseboard===|</span><br><span class="line">=================</span><br></pre></td></tr></table></figure>

<p>In some vendor mark the max DST temperature in the SPEC.<br>The BMC has no DST temperature sensor output. the CPU1 DTS is unspec. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool sdr <span class="built_in">type</span> Temperature</span><br><span class="line">CPU1 OverTemp    | 85h | ok  |  3.1 | Transition to OK</span><br><span class="line">CPU1 Temp        | 84h | ok  |  3.1 | 72 degrees C</span><br><span class="line">CPU1 DTS         | 50h | ok  |  3.1 | -22.80 unspecif</span><br><span class="line">CPU2 OverTemp    | 87h | ok  |  3.2 | Transition to OK</span><br><span class="line">CPU2 Temp        | 86h | ok  |  3.2 | 72 degrees C</span><br><span class="line">CPU2 DTS         | 51h | ok  |  3.2 | -22.80 unspecif</span><br><span class="line">DIMM 1 Temp      | 30h | ok  | 32.1 | 29 degrees C</span><br><span class="line">DIMM 2 Temp      | 31h | ns  | 32.2 | No Reading</span><br><span class="line">PCH OverTemp     | 8Bh | ok  | 45.1 | Transition to OK</span><br><span class="line">PCH Temp         | 2Fh | ok  | 45.1 | 43 degrees C</span><br><span class="line">Ambient Temp     | 80h | ok  | 39.1 | 22 degrees C</span><br><span class="line">PCI 1 OverTemp   | 48h | ok  | 11.1 | Transition to OK</span><br><span class="line">PCI 2 OverTemp   | 49h | ok  | 11.2 | Transition to OK</span><br><span class="line">Exhaust Temp     | 83h | ok  | 30.2 | 38 degrees C</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>In my benchmark, I got the result, I can ‘t got DTS temperature from BMC sensor, but I could use the DTS value to measure.<br>The 6248R(the hottest room) and 6248(hot room),6240R(cool room) in the different server room</p>
<p>And in many manufacturer BMC manager (IDRAC/TSM), In the BMC interface show the CPU maximum temperature is same with the DST max temperature.  </p>
<p><a target="_blank" rel="noopener" href="https://cdrdv2.intel.com/v1/dl/getContent/616776">Got the DST max</a><br>|CPU(all °C) |Tcase| DST max| throttling temp dmesg | performance idle | powersave idle| Full loading        |  rack and fan<br>|————|—–|——–|———————–|——————|—————|———————|—————<br>|Xeon 64248R |  75 |  95    | 96                    |  73              | 55            | 84(after silicone)  |  20k rpm,SR630<br>|Xeon 64248  |  86 |  100   | 100                   |  60              | 49            | 87                  |  unknow,SR630<br>|Xeon 6240R  |  90 |  104   | 104                   |  35              | 41            | 82                  |  16k,PowerEdge C6420</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPU1 Temp        | 84h | ok  |  3.1 | 72 degrees C</span><br></pre></td></tr></table></figure>
<p>if the DST max temperature &gt; 84h CPU1 Temp(72 degress C) that means the temperature little high for 2nd gen scalable CPU, but the CPU could work well except the Fan or some circuit not suitable for high temperature env<br>if the Tcase temperature &gt; 84h CPU1 Temp(72 degress C) that means it ‘s the cool air temperature for this CPU   </p>
<p>The Fan location<br>In this example, C6h is the sensor code. c6h is XCC sensor number for “Fan 7A Tach”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CPU 1 Overtemp   | C4h | ok  |  3.1 | Transition to OK</span><br><span class="line">CPU 1 Temp       | C6h | ok  |  3.1 | 43 degrees C</span><br><span class="line">CPU 1 DTS        | CAh | ok  |  3.1 | -51 unspecified</span><br><span class="line">CPU 2 Overtemp   | C5h | ok  |  3.2 | Transition to OK</span><br><span class="line">CPU 2 Temp       | C7h | ok  |  3.2 | 40 degrees C</span><br><span class="line">CPU 2 DTS        | CBh | ok  |  3.2 | -51 unspecified</span><br><span class="line">PCIe 1 Temp      | 41h | ok  | 11.1 | Transition to OK</span><br><span class="line">PCIe 3 Temp      | 43h | ok  | 11.3 | Transition to OK</span><br><span class="line">PCIe 5 Temp      | 45h | ok  | 11.5 | Transition to OK</span><br><span class="line">PCIe 6 Temp      | 46h | ok  | 11.6 | Transition to OK</span><br><span class="line">Drive Overtemp   | BFh | ok  | 37.4 |</span><br><span class="line">M2 Temp          | BEh | ns  | 11.7 | No Reading</span><br><span class="line">PCH Overtemp     | BDh | ok  | 45.1 | Transition to OK</span><br><span class="line">Ambient Temp     | B0h | ok  | 39.1 | 22 degrees C</span><br><span class="line">Exhaust Temp     | E3h | ok  | 13.1 | 38 degrees C</span><br></pre></td></tr></table></figure>
<p><a href="/img/server_c6h_location.png"></a>   </p>
<h3 id="install-uarch-bench-on-centos-7"><a href="#install-uarch-bench-on-centos-7" class="headerlink" title="install uarch-bench on centos 7"></a>install uarch-bench on centos 7</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">$ yum install devtoolset-9-toolchain</span><br><span class="line">$ scl <span class="built_in">enable</span> devtoolset-9 bash</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/obilaniu/libpfc</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/nemequ/portable-snippets</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/andikleen/pmu-tools</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/bombela/backward-cpp/</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/travisdowns/nasm-utils</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/wcohen/libpfm4</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/travisdowns/avx-turbo</span><br><span class="line">$ cp -a ../libpfc ./</span><br><span class="line">$ cp -a nasm-utils uarch-benchs</span><br><span class="line">$ cp -a ../pmu-tools ./</span><br><span class="line">$ cp -a ../libpfm4 ./</span><br><span class="line">$ cp ../avx-turbo/cpu.o ./</span><br><span class="line">$ vi isa-support.cpp</span><br><span class="line">$ vi perf-timer.cpp</span><br><span class="line">$ vi main.cpp</span><br><span class="line">$ vi libpfm4-support.cpp</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">avx-turbo  backward-cpp  libpfc  libpfm4  nasm-utils  pmu-tools  portable-snippets  uarch-bench</span><br><span class="line">$ <span class="built_in">cd</span> avx-turbo</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../libpfc</span><br><span class="line">$ make</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=<span class="variable">$C_INCLUDE_PATH</span>:/opt/lib/el7/mpich-3.2.1/include/:/opt/lib/el7/libtool-2.4.6/include:~/uarch/libpfc/include:~/uarch/avx-turbo:~/uarch/libpfc/include</span><br><span class="line">$ <span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:/<span class="built_in">local</span>/nvme/uarch/libpfc</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../uarch-bench</span><br><span class="line">$ rmdir libpfc</span><br><span class="line">$ cp -a ../libpfc ./</span><br><span class="line">$ mkdir cpu</span><br><span class="line">$ cp ../avx-turbo/cpu.c cpu</span><br><span class="line">$ cp ../avx-turbo/cpu.h cpu</span><br><span class="line">$ rmdir pmu-tools</span><br><span class="line">$ cp -a ../pmu-tools ./</span><br><span class="line">$ rmdir backward-cpp</span><br><span class="line">$ cp -a ../backward-cpp ./</span><br><span class="line">$ rmdir nasm-utils/</span><br><span class="line">$ cp -a ../nasm-utils ./</span><br><span class="line">$ rmdir libpfm4</span><br><span class="line">$ cp -a ../libpfm4 ./</span><br><span class="line">$ rmdir pmu-tools</span><br><span class="line">$ cp -a ../pmu-tools ./</span><br><span class="line">$ cp ../avx-turbo/cpu.o ./</span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ ./uarch-bench</span><br><span class="line">Welcome to uarch-bench (f88a3a8-dirty)</span><br><span class="line">Supported CPU features: SSE3 PCLMULQDQ VMX SMX EST TM2 SSSE3 FMA CX16 SSE4_1 SSE4_2 MOVBE POPCNT AES AVX RDRND TSC_ADJ SGX BMI1 HLE AVX2 BMI2 ERMS RTM MPX RDSEED ADX CLFLUSHOPT INTEL_PT</span><br><span class="line">Pinned to CPU 0</span><br><span class="line">Median CPU speed: 3.987 GHz</span><br><span class="line">Running benchmarks groups using timer clock</span><br><span class="line"></span><br><span class="line">** Running group basic : Basic Benchmarks **</span><br><span class="line">                               Benchmark    Cycles     Nanos</span><br><span class="line">                     Dependent add chain      1.00      0.25</span><br><span class="line">                   Independent add chain      0.25      0.06</span><br><span class="line">                  Dependent imul 64-&gt;128      3.00      0.75</span><br><span class="line">                   Dependent imul 64-&gt;64      3.00      0.75</span><br><span class="line">                Independent imul 64-&gt;128      1.01      0.25</span><br><span class="line">                 Independent imul 64-&gt;64      1.00      0.25</span><br><span class="line">                    Same location stores      1.00      0.25</span><br><span class="line">                Disjoint location stores      1.00      0.25</span><br><span class="line">                Dependent push/pop chain      4.42      1.11</span><br><span class="line">              Independent push/pop chain      1.04      0.26</span><br><span class="line">     Back-to-back call of empty <span class="keyword">function</span>      4.37      1.10</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">$ ./uarch-bench.sh --test-name=memory/load-parallel/parallel-load-128</span><br><span class="line">Driver: intel_pstate, governor: performance</span><br><span class="line">Vendor ID: GenuineIntel</span><br><span class="line">Model name: Intel(R) Xeon(R) CPU E5-2643 v3 @ 3.40GHz</span><br><span class="line">intel_pstate/no_turbo reports that turbo is already disabled</span><br><span class="line">Using timer: clock</span><br><span class="line">Welcome to uarch-bench (f88a3a8-dirty)</span><br><span class="line">Supported CPU features: SSE3 PCLMULQDQ VMX SMX EST TM2 SSSE3 FMA CX16 SSE4_1 SSE4_2 MOVBE POPCNT AES AVX RDRND TSC_ADJ BMI1 AVX2 BMI2 ERMS</span><br><span class="line">Pinned to CPU 0</span><br><span class="line">Median CPU speed: 3.399 GHz</span><br><span class="line">Running benchmarks groups using timer clock</span><br><span class="line"></span><br><span class="line">** Running group memory/load-parallel : Random(ish) parallel loads from fixed-size regions **</span><br><span class="line">                               Benchmark    Cycles     Nanos</span><br><span class="line">                   128-KiB parallel load      2.27      0.67</span><br><span class="line">Finished <span class="keyword">in</span> 315 ms (memory/load-parallel)</span><br></pre></td></tr></table></figure>

<ul>
<li>wrmsr - tool for writing CPU machine specific registers (MSR)</li>
<li>rdmsr - tool for reading CPU machine specific registers (MSR)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># only turning of that one</span></span><br><span class="line">$ rdmsr -a 0x1a4</span><br><span class="line">0</span><br><span class="line">...</span><br><span class="line"><span class="comment">## the line number = CPU thread numbers</span></span><br><span class="line"></span><br><span class="line">$ wrmsr -a 0x1a4 <span class="string">&quot;<span class="subst">$((2#1111)</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  only turning of that one</span></span><br><span class="line">$ wrmsr -a 0x1a4 <span class="string">&quot;<span class="subst">$((2#0001)</span>)&quot;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="irqbalance"><a href="#irqbalance" class="headerlink" title="irqbalance"></a>irqbalance</h3><p>/etc/sysconfig/irqbalance  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exclude CPUs 8 to 15 by uncommenting the variable IRQBALANCE_BANNED_CPUS and setting its value this wayj</span></span><br><span class="line">IRQBALANCE_BANNED_CPUS=0000ff00</span><br></pre></td></tr></table></figure>

<h3 id="CVE-Performance-overrides"><a href="#CVE-Performance-overrides" class="headerlink" title="CVE Performance overrides"></a>CVE Performance overrides</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## disable CVE patch for performance</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;spectre_v2=off spec_store_bypass_disable=off nopti l1tf=off&#x27;</span></span><br><span class="line"></span><br><span class="line">$ grep . <span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/</span>*</span><br><span class="line"></span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/i</span>tlb_multihit:KVM: Mitigation: Split huge pages</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/</span>l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/m</span>ds:Mitigation: Clear CPU buffers; SMT vulnerable</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/m</span>eltdown:Mitigation: PTI</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/</span>spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/</span>spectre_v1:Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/</span>spectre_v2:Mitigation: Full generic retpoline, IBPB: conditional, IBRS_FW, STIBP: conditional, RSB filling</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/</span>srbds:Mitigation: Microcode</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/vulnerabilities/</span>tsx_async_abort:Mitigation: Clear CPU buffers; SMT vulnerable</span><br></pre></td></tr></table></figure>

<h3 id="Cases"><a href="#Cases" class="headerlink" title="Cases"></a>Cases</h3><h4 id="AMD-PCIE-4-issues"><a href="#AMD-PCIE-4-issues" class="headerlink" title="AMD PCIE 4 issues"></a>AMD PCIE 4 issues</h4><p><a target="_blank" rel="noopener" href="https://www.dell.com/support/manuals/en-us/red-hat-entps-lx-v7.0/rhel_7_rn_pub/iopagefault-messages-are-displayed-in-dmesg-for-pcie-generation-4-devices?guid=guid-fc7e36fc-34c9-4a82-82c8-a0ad098430a7">IO_PAGE_FAULT messages are displayed in dmesg for PCIe Generation 4 devices</a><br><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/5320571">System logs IO_PAGE_FAULT errors for AMD-Vi</a></p>
<p>Red Hat Enterprise Linux 7.8 and later, centos 8 default parameter: iommu=pt (pass-through)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;iommu=pt&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="test-env-parameters"><a href="#test-env-parameters" class="headerlink" title="test env parameters"></a>test env parameters</h4><p>The OMP_NUM_THREADS environment variable specifies the number of threads to use for parallel region<br>OMP_NUM_THREADS   </p>
<h4 id="Too-many-futex-overhead"><a href="#Too-many-futex-overhead" class="headerlink" title="Too many futex overhead"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/534663">Too many futex overhead</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ strace -c -f -p <span class="variable">$pid</span></span><br><span class="line">strace: Process 167963 attached with 6 threads</span><br><span class="line">strace: Process 167963 detached</span><br><span class="line">strace: Process 167965 detached</span><br><span class="line">strace: Process 167966 detached</span><br><span class="line">strace: Process 167967 detached</span><br><span class="line">strace: Process 167968 detached</span><br><span class="line">strace: Process 167969 detached</span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"> 85.85  231.536205          63   3626015    235152 futex</span><br><span class="line">  9.66   26.050936          16   1606480           <span class="built_in">read</span></span><br><span class="line">  4.49   12.108573           7   1606480           lseek</span><br><span class="line">  0.00    0.003128           7       398           brk</span><br><span class="line">  0.00    0.000250          17        14           mmap</span><br><span class="line">  0.00    0.000075          37         2           mremap</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00  269.699167               6839389    235152 total</span><br><span class="line"></span><br><span class="line">Futex calls are used to arbitrate userspace lock contention <span class="keyword">in</span> applications. If applications are spending a lot of time <span class="keyword">in</span> futex() system calls <span class="keyword">then</span> that means there is contention on userspace locks <span class="keyword">in</span> the application. Is it some massively multi-threaded application? </span><br><span class="line">Try reducing the thread count. </span><br><span class="line">I think the strace data is sufficient to suggest there is contention <span class="keyword">in</span> the application and the next step would be to profile the application and how often it acquires whatever synchronisation mechanisms it is using.</span><br><span class="line"></span><br><span class="line">as a workaround turning off ticket spinlocks may <span class="built_in">help</span> with performance little bit. this can be <span class="keyword">done</span> by setting <span class="string">&#x27;spinlock-type=unfair&#x27;</span> on grub<span class="string">&#x27;s kernel command line</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The futex code uses spinlocks to protect hash bucket queues and spinlocks on RHEL6 are ticketed (ie fair) and performance can really drop off if there is contention from a workload running across numa nodes. The result would be CPUs spending a lot more time busy waiting. We&#x27;</span>ll need to know how much of the time spent <span class="keyword">in</span> futex() is spent sleeping and how much time is spent busy waiting.</span><br></pre></td></tr></table></figure>
<p>I ‘m <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html?highlight=kernel%20parameters">not found</a> the parameter “spinlock-type=unfair”     </p>
<h3 id="BIOS-1"><a href="#BIOS-1" class="headerlink" title="BIOS"></a>BIOS</h3><h4 id="DCU-Data-Prefetcher"><a href="#DCU-Data-Prefetcher" class="headerlink" title="DCU Data Prefetcher"></a><a target="_blank" rel="noopener" href="https://www.intel.com/content/dam/support/us/en/documents/motherboards/server/sb/intelserversystembiossetuputilityguide10_final.pdf">DCU Data Prefetcher</a></h4><ul>
<li>[Enabled] The next cache line will be prefetched into L1 data cache from L2 or system memory during unused cycles if it sees that the processor core has accessed several bytes sequentially in a cache line as data.</li>
<li>[Disabled] Only fetches cache line with data required by the processor (64 bytes)</li>
<li>DCU Mode<ul>
<li>32KB 8Way Without ECC</li>
<li>16KB 4Way With ECC</li>
</ul>
</li>
</ul>
<h3 id="AVX-Tflops"><a href="#AVX-Tflops" class="headerlink" title="AVX Tflops"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Matrix_Yao/p/9550967.html">AVX Tflops</a></h3><ul>
<li><a target="_blank" rel="noopener" href="https://colfaxresearch.com/skl-avx512/">SKL</a><ul>
<li>AVX-512F<ul>
<li>The fundamental instruction set, it expands most of AVX functions to support 512-bit registers and adds masking, embedded broadcasting, embedded rounding and exception control.</li>
</ul>
</li>
<li>AVX-512CD     <ul>
<li>Conflict Detection instruction set allows vectorization of loops with vector dependency due to writing conflicts</li>
</ul>
</li>
<li>AVX-512BW <ul>
<li>Byte and Word support instruction set: 8-bit and 16-bit integer operations, processing up to 64 8-bit elements or 32 16-bit integer elements per vector</li>
</ul>
</li>
<li>AVX-512DQ     <ul>
<li>Double and Quad word instruction set, supports new instructions for double-word (32-bit) and quadword (64-bit) integer and floating-point elements</li>
</ul>
</li>
<li>AVX-512VL <ul>
<li>Vector Length extensions: support for vector lengths smaller than 512 bits</li>
</ul>
</li>
</ul>
</li>
<li>KNL<ul>
<li>AVX-512F     <ul>
<li>Conflict Detection instruction set allows vectorization of loops with vector dependency due to writing conflicts</li>
</ul>
</li>
<li>AVX-512CD<ul>
<li>Byte and Word support instruction set: 8-bit and 16-bit integer operations, processing up to 64 8-bit elements or 32 16-bit integer elements per vector</li>
</ul>
</li>
<li>AVX-512PF<ul>
<li>Data prefetching for gather and scatter instructions</li>
</ul>
</li>
<li>AVX-512ER<ul>
<li>Exponential and Reciprocal instruction set for high-accuracy base-2 exponential functions, reciprocals, and reciprocal square root</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Compiler 	Intel compilers 17.x 	Intel compilers 18.x 	                  GNU and LLVM</span><br><span class="line">Cross-platform 	-xCommon-AVX512 	-xCommon-AVX512 	                -mfma -mavx512f -mavx512cd</span><br><span class="line">SKL processors 	-xCore-AVX512 	        -xCore-AVX512 -qopt-zmm-usage=high 	-march=skylake-avx512</span><br><span class="line">KNL processors 	-xMIC-AVX512 	        -xMIC-AVX512 	-march=knl</span><br><span class="line"></span><br><span class="line">$ icc -xCORE-AVX512 -c auto_vec.c</span><br><span class="line">$ icc -xCORE-AVX512 -S auto_vec.c</span><br><span class="line">$ icc -xCORE-AVX512 -c auto_vec.c -qopt-report=5 </span><br><span class="line"></span><br><span class="line">$ icc  -xCORE-AVX512 -S auto_vec.c -qopt-report-embed</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -c auto_vec.c</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -S auto_vec.c</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -c auto_vec.c -fopt-info-vec</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -S auto_vec.c -fopt-info-vec</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//The example in the listing below shows a benchmark of the fused multiply-add (FMA) operation.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n_trials = <span class="number">1000000000</span>; <span class="comment">// Enough to keep cores busy for a while and observe a steady state</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> flops_per_calc = <span class="number">2</span>; <span class="comment">// Multiply + add = 2 instructions</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> n_chained_fmas = <span class="number">10</span>; <span class="comment">// Must be tuned for architectures here and in blocks (R) and in (E)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">  &#123; &#125; <span class="comment">// Warm up the threads</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">double</span> t0 = omp_get_wtime(); <span class="comment">// start timer</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">  &#123; <span class="comment">// Benchmark in all threads</span></span><br><span class="line">    <span class="keyword">double</span> fa[VECTOR_WIDTH*n_chained_fmas], fb[VECTOR_WIDTH], fc[VECTOR_WIDTH];</span><br><span class="line"></span><br><span class="line">    fa[<span class="number">0</span>:VECTOR_WIDTH*n_chained_fmas] = <span class="number">0.0</span>; <span class="comment">// prototype of a memory-based array</span></span><br><span class="line">    fb[<span class="number">0</span>:VECTOR_WIDTH] = <span class="number">0.5</span>; <span class="comment">// fixed</span></span><br><span class="line">    fc[<span class="number">0</span>:VECTOR_WIDTH] = <span class="number">1.0</span>; <span class="comment">// fixed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa01 = fa +  <span class="number">0</span>*VECTOR_WIDTH; <span class="comment">// This is block (R)</span></span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa02 = fa +  <span class="number">1</span>*VECTOR_WIDTH; <span class="comment">// To tune for a specific architecture,</span></span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa03 = fa +  <span class="number">2</span>*VECTOR_WIDTH; <span class="comment">// more or fewer fa* variables</span></span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa04 = fa +  <span class="number">3</span>*VECTOR_WIDTH; <span class="comment">// must be used</span></span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa05 = fa +  <span class="number">4</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa06 = fa +  <span class="number">5</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa07 = fa +  <span class="number">6</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa08 = fa +  <span class="number">7</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa09 = fa +  <span class="number">8</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">double</span> *fa10 = fa +  <span class="number">9</span>*VECTOR_WIDTH;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> nounroll <span class="comment">// Prevents automatic unrolling by compiler to avoid skewed benchmarks</span></span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n_trials; i++)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp simd <span class="comment">// Ensures that vectorization does occur</span></span></span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; VECTOR_WIDTH; j++) &#123; <span class="comment">// VECTOR_WIDTH=4 for AVX2, =8 for AVX-512</span></span><br><span class="line">        fa01[j] = fa01[j]*fb[j] + fc[j]; <span class="comment">// This is block (E)</span></span><br><span class="line">        fa02[j] = fa02[j]*fb[j] + fc[j]; <span class="comment">// To tune for a specific architecture,</span></span><br><span class="line">        fa03[j] = fa03[j]*fb[j] + fc[j]; <span class="comment">// more or fewer such FMA constructs</span></span><br><span class="line">        fa04[j] = fa04[j]*fb[j] + fc[j]; <span class="comment">// must be used</span></span><br><span class="line">        fa05[j] = fa05[j]*fb[j] + fc[j];</span><br><span class="line">        fa06[j] = fa06[j]*fb[j] + fc[j];</span><br><span class="line">        fa07[j] = fa07[j]*fb[j] + fc[j];</span><br><span class="line">        fa08[j] = fa08[j]*fb[j] + fc[j];</span><br><span class="line">        fa09[j] = fa09[j]*fb[j] + fc[j];</span><br><span class="line">        fa10[j] = fa10[j]*fb[j] + fc[j];</span><br><span class="line">      &#125;</span><br><span class="line">    fa[<span class="number">0</span>:VECTOR_WIDTH*n_chained_fmas] *= <span class="number">2.0</span>; <span class="comment">// Prevent dead code elimination</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">double</span> t1 = omp_get_wtime();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">double</span> gflops = <span class="number">1.0e-9</span>*(<span class="keyword">double</span>)VECTOR_WIDTH*(<span class="keyword">double</span>)n_trials*(<span class="keyword">double</span>)flops_per_calc*</span><br><span class="line">                        (<span class="keyword">double</span>)omp_get_max_threads()*(<span class="keyword">double</span>)n_chained_fmas;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Chained FMAs=%d, vector width=%d, GFLOPs=%.1f, time=%.6f s, performance=%.1f GFLOP/s\n&quot;</span>, </span><br><span class="line">                        n_chained_fmas, VECTOR_WIDTH, gflops, t1 - t0, gflops/(t1 - t0));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ icpc -qopenmp -DVECTOR_WIDTH=<span class="number">4</span> -xCORE-AVX2 -S -o fma_avx2_10.s fma_10.c</span><br><span class="line">$ icpc -qopenmp -DVECTOR_WIDTH=<span class="number">8</span> -xCORE-AVX512 -S -o fma_avx512_08.s fma_08.c</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> ARR_SIZE=<span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">float</span> A[ARR_SIZE],C[ARR_SIZE]; </span><br><span class="line">  <span class="keyword">int</span> B[ARR_SIZE];</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; ARR_SIZE; i++)</span><br><span class="line">    A[B[i]] += <span class="number">1.0f</span>/C[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Broadwell</span><br><span class="line">$ icc CD.c -xCORE-AVX2 -O3 -qopt-report=<span class="number">5</span> -fp-model fast=<span class="number">2</span> -S</span><br><span class="line"></span><br><span class="line"># skylake</span><br><span class="line">$ icc CD.c -xCORE-AVX512 -O3 -qopt-report=<span class="number">5</span> -fp-model fast=<span class="number">2</span> -S</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">FP64  </span><br><span class="line">     2xsocket</span><br><span class="line">       |24 cores</span><br><span class="line">       |  | operations_per_cycle = 2 x FMA AVX512 , (fma_num)2 x (512/FP64) x 2(乘法和加法各算一个操作，所以8可以乘2) =2 x 8 x 2 =32</span><br><span class="line">       |  |  | 2.6GHz</span><br><span class="line">       |  |  |  |</span><br><span class="line">TFLOPS=2*24*32*2.6*10^9*10^-12=3.9936 Tflops</span><br><span class="line"></span><br><span class="line">FP32=FP64 x 2</span><br><span class="line">FP16=Xeon CPU在SapphirRapids(SPR)之前不支持FP16的原生FMA运算，需要先通过vcvtph2ps指令将FP16转换成FP32，再通过FP32的FMA运算来完成。此时，FP16的峰值TFLOPS与FP32的峰值TFLOPS是相等的</span><br><span class="line"></span><br><span class="line">BF16=Xeon CPU从CooperLake(CPX)开始支持BF16的乘加运算，凡是CPU Flag中有AVX512_BF16的CPU均支持原生BF16乘加。但因为其复用了FP32的FMA，所以暴露出来的BF16指令并不是标准的FMA，而是DP(Dot Product)</span><br><span class="line"></span><br><span class="line">一个AVX-512寄存器可以存放32个BF16。因此，一个AVX-512 BF16 DP每个clock cycle可以做32个乘加操作。</span><br><span class="line"></span><br><span class="line">AVX INT32 MA</span><br><span class="line">CPU通过两条指令vpmuldq + vpaddq完成INT32的乘加操作</span><br><span class="line">一个AVX-512寄存器可以存放16个INT32, 一个AVX-512 FMA每2个clock cycle可以做16个INT32乘加操作，即平均每个clock cycle可以做8个INT32乘加操作。</span><br><span class="line"></span><br><span class="line">pre-VNNI MA</span><br><span class="line">在支持VNNI(Vector Neural Network Instructions)指令前，CPU通过两条指令vpmaddwd + vpaddd完成INT16的DP操作(原因也是为了复用INT32的FMA，所以选择不支持INT16的FMA，而只支持Multiply Add)</span><br><span class="line">一个AVX-512寄存器可以存放32个INT16。因此，每2个clock cycle可以做32个INT16乘加操作，即平均每个clock cycle做16个INT16乘加操作</span><br><span class="line"></span><br><span class="line">post-VNNI DP</span><br><span class="line">在支持VNNI指令后，CPU通过一条指令vpdpwssd完成INT16的乘加操作</span><br><span class="line">一个AVX-512 FMA每个clock cycle可以做32个INT16乘加操作</span><br><span class="line"></span><br><span class="line">INT8 TOPS计算</span><br><span class="line">在支持VNNI指令前，CPU通过三条指令vpmaddubsw + vpmaddwd + vpaddd完成INT8的DP操作</span><br><span class="line">一个AVX-512寄存器可以存放64个INT8 。因此，一个AVX-512 FMA每3个clock可以做64个INT8乘加操作，即平均每个clock做64/3￼个INT8乘加操作</span><br><span class="line"></span><br><span class="line">在支持VNNI指令后，CPU通过一条指令vpdpbusd完成INT8的DP操作,</span><br><span class="line">一个AVX-512寄存器可以存放64个INT8。因此，一个AVX-512 FMA每个clock cycle可以做64个INT8乘加操作</span><br></pre></td></tr></table></figure>


<h3 id="power-setting-in-supermicro"><a href="#power-setting-in-supermicro" class="headerlink" title="power setting in supermicro"></a>power setting in supermicro</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CPU configuration</span><br><span class="line">  Advance power management configuration</span><br><span class="line">    Power technology --&gt; custom</span><br><span class="line">    Energy performance BIAS setting --&gt; performance</span><br><span class="line">      CPU P State control</span><br><span class="line">        EIST (P-state) --&gt; <span class="built_in">disable</span></span><br><span class="line">      CPU C State control</span><br><span class="line">        Package C State Limit --&gt; C0/C1 state</span><br><span class="line">      CPU T State control</span><br><span class="line">        ACPI T-state --&gt; <span class="built_in">disable</span>  </span><br></pre></td></tr></table></figure>
<h4 id="turbostat"><a href="#turbostat" class="headerlink" title="turbostat"></a>turbostat</h4><ul>
<li>Avg_MHz</li>
<li>Bzy_MHz<ul>
<li>idle CPU frequency</li>
</ul>
</li>
<li>PkgWatt<ul>
<li>The whole CPU power </li>
</ul>
</li>
<li>RAMwatt<ul>
<li>All mem power</li>
</ul>
</li>
<li>CoreTmp</li>
<li>PkgTtmp<ul>
<li>The vluae of the whole CPU package thermal monitor </li>
</ul>
</li>
</ul>
<h4 id="powertop"><a href="#powertop" class="headerlink" title="powertop"></a>powertop</h4><h4 id="powercap"><a href="#powercap" class="headerlink" title="powercap"></a>powercap</h4><h4 id="process-counter-monitor-PCM"><a href="#process-counter-monitor-PCM" class="headerlink" title="process counter monitor (PCM)"></a>process counter monitor (PCM)</h4><h4 id="numatop"><a href="#numatop" class="headerlink" title="numatop"></a>numatop</h4><ul>
<li><p>RMA(K): number of Remote Memory Accesses (unit is 1000).</p>
<ul>
<li>RMA(K) = RMA / 1000;</li>
</ul>
</li>
<li><p>LMA(K): number of Local Memory Accesses (unit is 1000).</p>
<ul>
<li>LMA(K) = LMA / 1000;</li>
</ul>
</li>
<li><p>IR: Instruction Retired.</p>
</li>
<li><p>CYCLE: CPU cycles.</p>
</li>
<li><p>RMA/LMA: ratio of RMA/LMA.</p>
</li>
<li><p>CPI: CPU cycle per instruction.</p>
</li>
<li><p>CPU%: CPU utilization.</p>
</li>
<li><p>RPI(K): RMA normalized by 1000 instructions.</p>
<ul>
<li>RPI(K) = RMA / (IR / 1000);</li>
</ul>
</li>
<li><p>LPI(K): LMA normalized by 1000 instructions.</p>
<ul>
<li>LPI(K) = LMA / (IR / 1000);</li>
</ul>
</li>
<li><p>ACCESS%: percentage of memory accesses are to this node.</p>
</li>
<li><p>LAT(ns): the average latency (nanoseconds) of memory accesses to this node.</p>
</li>
<li><p>CPU: array of logical CPUs which belong to this node</p>
</li>
<li><p>CPU%: per-node CPU utilization</p>
</li>
<li><p>MEM active: the amount of memory that has been used more recently and<br>is not usually reclaimed unless absolute necessary</p>
</li>
<li><p>MEM inactive: the amount of memory that has not been used for a while<br>and is eligible to be swapped to disk</p>
</li>
<li><p>Dirty: the amount of memory waiting to be written back to the disk</p>
</li>
<li><p>Writeback: the amount of memory actively being written back to the disk</p>
</li>
<li><p>Mapped: all pages mapped into a process</p>
</li>
</ul>
<h4 id="cache-monitor-technology"><a href="#cache-monitor-technology" class="headerlink" title="cache monitor technology"></a>cache monitor technology</h4><h3 id="Why-some-of-EPYC2-limit-the-memory-bandwith"><a href="#Why-some-of-EPYC2-limit-the-memory-bandwith" class="headerlink" title="Why some of EPYC2 limit the memory bandwith"></a>Why some of EPYC2 limit the memory bandwith</h3><p><a target="_blank" rel="noopener" href="https://en.wikichip.org/wiki/amd/epyc/7252">This model supports up to 8 channels of up to DDR4-3200 memory with a theoretical maximum bandwidth of 25.6 GB/s (≈ 23.84 GiB/s) per channel, but is apparently bandwidth limited by the IFOP links between the I/O die and its only two compute dies (effective bandwidth ≈ 55 GB/s per CCD at 1.46 GHz FCLK). According to AMD this processor is “optimized for 4 channels with DDR4-2667 DIMMs” (≈ 21.3 GB/s per channel) and therefore has a “per-socket theoretical memory bandwidth 85.3 GB/s” (≈ 79.47 Ga)</a></p>
<h3 id="CPU-cluster-mode"><a href="#CPU-cluster-mode" class="headerlink" title="CPU cluster mode"></a>CPU cluster mode</h3><p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/articles/technical/xeon-processor-scalable-family-technical-overview.html">CHA is responsible for tracking of requests from the core and responding to snoops from local and remote agents as well as resolution of coherency across multiple processors</a></p>
<ul>
<li>All2All<ul>
<li>No policy, free, maybe the request pass the longest path</li>
</ul>
</li>
<li>SNC-2/SNC-4 (sub-NUMA)<ul>
<li>Don ‘t keep cache consistency with remote numa node, divide by numa and cluster range</li>
</ul>
</li>
<li>Hemishphere<ul>
<li>Memory channel(worked) with symmetric assembly in the 2 x Memory controller</li>
</ul>
</li>
<li>Quadrant<ul>
<li>Same with hemishphere in the 4 x Memory controller</li>
</ul>
</li>
<li>Auto</li>
</ul>
<h3 id="CPU-linux-kernel-parameters"><a href="#CPU-linux-kernel-parameters" class="headerlink" title="CPU linux kernel parameters"></a>CPU linux kernel parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####CPU parameters</span></span><br><span class="line">$ vfio-pci.ids=[...] amd_iommu=on iommu=pt iommu=1 acpi_enforce_resources=lax isolcpus=7-15 rcu_nocbs=7-15 nohz_full=7-15 rcu_nocb_poll irqaffinity=0,1,2,3,4,5,6 spl_taskq_thread_bind=1 nohibernate zfs_force=1 systemd.unified_cgroup_hierarchy=0 loglevel=4</span><br></pre></td></tr></table></figure>
<p>$ grubby –update-kernel=ALL –args=’iommu=pt’</p>
<pre><code>- rcu_nocbs=      [KNL]
  - RCU is a synchronization mechanism that was added to the Linux kernel during the 2.5 development effort that is optimized for read-mostly situations.
  - The argument is a cpu list, as described above.
  - In kernels built with CONFIG_RCU_NOCB_CPU=y, set the specified list of CPUs to be no-callback CPUs.
  - Invocation of these CPUs&#39; RCU callbacks will be offloaded to &quot;rcuox/N&quot; kthreads created for that purpose, where &quot;x&quot; is &quot;b&quot; for RCU-bh, &quot;p&quot; for RCU-preempt, and &quot;s&quot; for RCU-sched, and &quot;N&quot; is the CPU number.  This reduces OS jitter on the offloaded CPUs, which can be useful for HPC and real-time workloads.  It can also improve energy efficiency for asymmetric multiprocessors.
- nohz_full=      [KNL,BOOT]
  - The argument is a cpu list, as described above. In kernels built with CONFIG_NO_HZ_FULL=y, set the specified list of CPUs whose tick will be stopped whenever possible. 
  - The boot CPU will be forced outside the range to maintain the timekeeping.  Any CPUs in this list will have their RCU callbacks offloaded, just as if they had also been called out in thercu_nocbs= boot parameter.

- rcu_nocb_poll   [KNL]
  - Rather than requiring that offloaded CPUs (specified by rcu_nocbs= above) explicitly awaken the corresponding &quot;rcuoN&quot; kthreads, make these kthreads poll for callbacks.
  - This improves the real-time response for the offloaded CPUs by relieving them of the need to wake up the corresponding kthread, but degrades energy efficiency by requiring that the kthreads periodically wake up to do the polling.

- irqaffinity [SMP] 
  - Set the default irq affinity mask The argument is a cpu list, as described above.
- nohibernate     
  - [HIBERNATION] Disable hibernation and resume.

- loglevel
  - All Kernel Messages with a loglevel smaller than the console loglevel will be printed to the console. It can also be changed with klogd or other programs. The loglevels are defined as follows:
  - 0 (KERN_EMERG)          system is unusable
  - 1 (KERN_ALERT)          action must be taken immediately
  - 2 (KERN_CRIT)           critical conditions
  - 3 (KERN_ERR)            error conditions
  - 4 (KERN_WARNING)        warning conditions
  - 5 (KERN_NOTICE)         normal but significant condition
  - 6 (KERN_INFO)           informational
  - 7 (KERN_DEBUG)          debug-level messages

- Enable cgroup v1
  - Cgroup v2 is now enabled by default. If you want to switch to cgroup v1 instead, you need to set the following
    - systemd.unified_cgroup_hierarchy=0

- amd_iommu
  - Pass parameters to the AMD IOMMU driver in the system. Possible values are:
    -fullflush - Deprecated, equivalent to iommu.strict=1
    -off      - do not initialize any AMD IOMMU found in the system
force_isolation - Force device isolation for all devices. The IOMMU driver is not allowed anymore to lift isolation requirements as needed. This option does not override iommu=pt
force_enable - Force enable the IOMMU on platforms known to be buggy with IOMMU enabled. Use this option with care.

- iommu
  - off
  - force
  - noforce
  - biomerge
  - panic
  - nopanic
  - merge
  - nomerge
  - forcesac
  - soft
  - pt              [x86, IA-64]
  - nobypass        [PPC/POWERNV]
     - Disable IOMMU bypass, using IOMMU for PCI devices.
- acpi_enforce_resources= [ACPI]
  - &#123; strict | lax | no &#125;
  - Check for resource conflicts between native drivers and ACPI OperationRegions (SystemIO and SystemMemory only). IO ports and memory declared in ACPI might be used by the ACPI subsystem in arbitrary AML code and can interfere with legacy drivers.
    - strict (default): access to resources claimed by ACPI is denied; legacy drivers trying to access reserved resources will fail to bind to device using them.
    - lax: access to resources claimed by ACPI is allowed; legacy drivers trying to access reserved resources will bind successfully but a warning message is logged.
    - no: ACPI OperationRegions are not marked as reserved, no further checks are performed.
- isolcpus=[KNL,SMP] 
  - Isolate CPUs from the general process scheduler. The argument is a cpu list, as described above.
    - This option can be used to specify one or more CPUs to isolate from the general SMP balancing and scheduling algorithms. You can move a process onto or off an &quot;isolated&quot; CPU via the CPU affinity syscalls or cpuset. &lt;cpu number&gt; begins at 0 and the maximum value is &quot;number of CPUs in system - 1&quot;.
    - This option is the preferred way to isolate CPUs. The alternative -- manually setting the CPU mask of all tasks in the system -- can cause problems and suboptimal load balancer performance.
    - NOTE: kernel threads are not able to be disabled and will always be visible on all cores. In ps -eLf output, these show up in brackets, like [ksoftirqd/0]

</code></pre>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Homer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/05/27/cpu/">http://yoursite.com/2018/05/27/cpu/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cpu/">cpu</a></div><div class="post_share"><div class="social-share" data-image="https://homerl.github.io/img/operting_system_a32c6f.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2018/06/01/ethernet_nic_tuning/"><img class="prev-cover" src="https://homerl.github.io/img/32_connection_nodes_communication_network_seo_social_community_relation-512.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Ethernet nic tuning</div></div></a></div><div class="next-post pull-right"><a href="/2018/05/27/ipmi/"><img class="next-cover" src="https://homerl.github.io/img/network-interface-card-2081371-1751392.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">ipmitool</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2018/08/06/numa/" title="numa"><img class="cover" src="https://homerl.github.io/img/operting_system_a32c6f.svg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-08-06</div><div class="title">numa</div></div></a></div><div><a href="/2016/06/16/spec/" title="spec"><img class="cover" src="https://homerl.github.io/img/network-interface-card-2081371-1751392.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-06-16</div><div class="title">spec</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2022 By Homer</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '0b9d5b98d0a972b33cf7',
      clientSecret: '769efc11b32f6c0d03bcbf3ee800dfc4e2690459',
      repo: 'homerl.github.io',
      owner: 'homerl',
      admin: ['homerl'],
      id: '979e3cf40c4642470b825572b868c91e',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>