<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>无常无形无功;不动不破不空</title>
  
  <subtitle>My Silent Hill</subtitle>
  <link href="http://yoursite.com/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-09-17T01:22:27.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>寸劲</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Linux debug</title>
    <link href="http://yoursite.com/2020/12/08/debug/"/>
    <id>http://yoursite.com/2020/12/08/debug/</id>
    <published>2020-12-08T14:35:34.000Z</published>
    <updated>2021-09-17T01:22:27.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Mem-mapping-in-Linux"><a href="#Mem-mapping-in-Linux" class="headerlink" title="Mem mapping in Linux"></a>Mem mapping in Linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -p <span class="variable">$pid</span></span><br><span class="line">or</span><br><span class="line">$ pmap -x <span class="variable">$pid</span></span><br><span class="line">$ pmap -XX <span class="variable">$pid</span></span><br></pre></td></tr></table></figure><h4 id="CentOS-debuginfo"><a href="#CentOS-debuginfo" class="headerlink" title="CentOS debuginfo"></a>CentOS debuginfo</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#bpftrace </span></span><br><span class="line"><span class="attribute">https</span>://repos.baslab.org/bpftools/x<span class="number">86</span>_<span class="number">64</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#souce</span></span><br><span class="line"><span class="attribute">https</span>://vault.centos.org/<span class="number">7</span>.<span class="number">9</span>.<span class="number">2009</span>/updates/Source/SPackages/</span><br><span class="line"></span><br><span class="line"><span class="comment">#debuginfo</span></span><br><span class="line"><span class="attribute">http</span>://debuginfo.centos.org/<span class="number">7</span>/x<span class="number">86</span>_<span class="number">64</span>/kernel-debuginfo-<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">1160</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>.rpm</span><br><span class="line"><span class="attribute">http</span>://debuginfo.centos.org/<span class="number">7</span>/x<span class="number">86</span>_<span class="number">64</span>/kernel-debuginfo-<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">1160</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>.rpm</span><br></pre></td></tr></table></figure><h4 id="Linux-kernel-tracepoints"><a href="#Linux-kernel-tracepoints" class="headerlink" title="Linux kernel tracepoints"></a>Linux kernel tracepoints</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ ls /sys/kernel/debug/tracing/events</span><br><span class="line">block             <span class="built_in">enable</span>      gpio          iommu        libata   mpx   pagemap  ras           scsi      task      workqueue</span><br><span class="line">bridge            exceptions  header_event  irq          mce      napi  percpu   raw_syscalls  signal    timer     writeback</span><br><span class="line">compaction        filelock    header_page   irq_vectors  mdio     net   power    rcu           skb       ucsi      xen</span><br><span class="line">context_tracking  filemap     hyperv        kmem         mei      nfs   printk   regmap        sock      udp       xfs</span><br><span class="line">dma_fence         fs_dax      i2c           kvm          migrate  nfs4  qdisc    rpm           sunrpc    vmscan    xhci-hcd</span><br><span class="line">drm               ftrace      intel_ish     kvmmmu       module   oom   random   <span class="built_in">sched</span>         syscalls  vsyscall</span><br><span class="line"></span><br><span class="line">$ ls /sys/kernel/debug/tracing/events/syscalls</span><br><span class="line"><span class="built_in">enable</span>                       sys_enter_name_to_handle_at       sys_exit_accept             sys_exit_newfstat</span><br><span class="line">filter                       sys_enter_nanosleep               sys_exit_accept4            sys_exit_newfstatat</span><br><span class="line">sys_enter_accept             sys_enter_newfstat                sys_exit_access             sys_exit_newlstat</span><br><span class="line">sys_enter_accept4            sys_enter_newfstatat              sys_exit_acct               sys_exit_newstat</span><br><span class="line">sys_enter_access             sys_enter_newlstat                sys_exit_add_key            sys_exit_newuname</span><br><span class="line">sys_enter_acct               sys_enter_newstat                 sys_exit_adjtimex           sys_exit_open</span><br><span class="line">sys_enter_add_key            sys_enter_newuname                sys_exit_alarm              sys_exit_openat</span><br><span class="line">sys_enter_adjtimex           sys_enter_open                    sys_exit_bind               sys_exit_open_by_handle_at</span><br><span class="line">...</span><br><span class="line"><span class="comment"># all /proc/kallsyms symbol could add in kprobe</span></span><br><span class="line">$ cat /proc/kallsyms</span><br><span class="line"></span><br><span class="line">system.map = $(nm vmlinux)</span><br><span class="line">/proc/kallsysms = system.map + loaded modules<span class="string">&#x27;s kallsyms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -l | grep sys_enter_nanosleep</span></span><br><span class="line"><span class="string">tracepoint:syscalls:sys_enter_nanosleep</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -lv &#x27;</span>t:syscalls:sys_enter_openat<span class="string">&#x27;</span></span><br><span class="line"><span class="string">tracepoint:syscalls:sys_enter_openat</span></span><br><span class="line"><span class="string">    int nr;</span></span><br><span class="line"><span class="string">    int dfd;</span></span><br><span class="line"><span class="string">    const char * filename;</span></span><br><span class="line"><span class="string">    int flags;</span></span><br><span class="line"><span class="string">    umode_t mode;</span></span><br><span class="line"><span class="string">asmlinkage long sys_openat(int dfd, const char __user *filename, int flags,</span></span><br><span class="line"><span class="string">   umode_t mode);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -lv &#x27;</span>t:k:tcp_sendmsg<span class="string">&#x27;</span></span><br><span class="line"><span class="string"># not output</span></span><br><span class="line"><span class="string">int tcp_sendmsg(struct sock *sk, struct msghdr *msg, size_t size);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## work in ubuntu 20.04</span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/kprobe_events</span></span><br><span class="line"><span class="string">p:kprobes/tcp_sendmsg tcp_sendmsg dst=+0(%di):x32 dport=+12(%di):x16 src=+4(%di):x32 sport=+14(%di):x16 size=%dx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/events/kprobes/tcp_sendmsg/format</span></span><br><span class="line"><span class="string">name: tcp_sendmsg</span></span><br><span class="line"><span class="string">ID: 1734</span></span><br><span class="line"><span class="string">format:</span></span><br><span class="line"><span class="string">field:unsigned short common_type;offset:0;size:2;signed:0;</span></span><br><span class="line"><span class="string">field:unsigned char common_flags;offset:2;size:1;signed:0;</span></span><br><span class="line"><span class="string">field:unsigned char common_preempt_count;offset:3;size:1;signed:0;</span></span><br><span class="line"><span class="string">field:int common_pid;offset:4;size:4;signed:1;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">field:unsigned long __probe_ip;offset:8;size:8;signed:0;</span></span><br><span class="line"><span class="string">field:u32 dst;offset:16;size:4;signed:0;</span></span><br><span class="line"><span class="string">field:u16 dport;offset:20;size:2;signed:0;</span></span><br><span class="line"><span class="string">field:u32 src;offset:22;size:4;signed:0;</span></span><br><span class="line"><span class="string">field:u16 sport;offset:26;size:2;signed:0;</span></span><br><span class="line"><span class="string">field:u64 size;offset:28;size:8;signed:0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print fmt: &quot;(%lx) dst=0x%x dport=0x%x src=0x%x sport=0x%x size=0x%Lx&quot;, REC-&gt;__probe_ip, REC-&gt;dst, REC-&gt;dport, REC-&gt;src, REC-&gt;sport, REC-&gt;size</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## tracepoint specific</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">asmlinkage long sys_openat(int dfd, const char __user *filename, int flags,</span></span><br><span class="line"><span class="string">   umode_t mode);</span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_openat/format</span></span><br><span class="line"><span class="string">name: sys_enter_openat</span></span><br><span class="line"><span class="string">ID: 495</span></span><br><span class="line"><span class="string">format:</span></span><br><span class="line"><span class="string">field:unsigned short common_type;offset:0;size:2;signed:0;</span></span><br><span class="line"><span class="string">field:unsigned char common_flags;offset:2;size:1;signed:0;</span></span><br><span class="line"><span class="string">field:unsigned char common_preempt_count;offset:3;size:1;signed:0;</span></span><br><span class="line"><span class="string">field:int common_pid;offset:4;size:4;signed:1;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">field:int nr;offset:8;size:4;signed:1;</span></span><br><span class="line"><span class="string">field:int dfd;offset:16;size:8;signed:0;</span></span><br><span class="line"><span class="string">field:const char * filename;offset:24;size:8;signed:0;</span></span><br><span class="line"><span class="string">field:int flags;offset:32;size:8;signed:0;</span></span><br><span class="line"><span class="string">field:umode_t mode;offset:40;size:8;signed:0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print fmt: &quot;dfd: 0x%08lx, filename: 0x%08lx, flags: 0x%08lx, mode: 0x%08lx&quot;, ((unsigned long)(REC-&gt;dfd)), ((unsigned long)(REC-&gt;filename)), ((unsigned long)(REC-&gt;flags)), ((unsigned long)(REC-&gt;mode))</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h4 id="Linux-kprobe"><a href="#Linux-kprobe" class="headerlink" title="Linux kprobe"></a>Linux kprobe</h4><p>And you could get the kprobe demo source code from linux kernel source</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/kernel/debug/kprobes/enabled</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment"># The same results</span></span><br><span class="line">$ cat /sys/kernel/debug/tracing/available_filter_functions</span><br><span class="line">$ bpftrace -l kprobe:*</span><br><span class="line"></span><br><span class="line">$ bpftrace -l kprobe:*nfs42*</span><br><span class="line">kprobe:nfs42_clone_file_range</span><br><span class="line">kprobe:nfs42_fallocate</span><br><span class="line">kprobe:_nfs42_proc_fallocate</span><br><span class="line">kprobe:nfs42_proc_fallocate</span><br><span class="line">kprobe:_nfs42_proc_clone</span><br><span class="line">kprobe:_nfs42_proc_llseek</span><br><span class="line">kprobe:nfs42_layoutstat_prepare</span><br><span class="line">kprobe:nfs42_layoutstat_release</span><br><span class="line">kprobe:nfs42_layoutstat_done</span><br><span class="line">kprobe:nfs42_proc_allocate</span><br><span class="line">kprobe:nfs42_proc_deallocate</span><br><span class="line">kprobe:nfs42_proc_copy</span><br><span class="line">kprobe:nfs42_proc_llseek</span><br><span class="line">kprobe:nfs42_proc_layoutstats_generic</span><br><span class="line">probe:nfs42_proc_clone</span><br><span class="line"></span><br><span class="line">$ bpftrace -l kprobe:sys_unlinkat</span><br><span class="line">kprobe:SyS_unlinkat</span><br><span class="line"></span><br><span class="line">$ cat /proc/kallsyms</span><br><span class="line"><span class="comment"># add kprobe for all symbols from /proc/kallsyms</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/kallsyms | grep do_sys_open</span><br><span class="line">ffffffff8b44bec0 T do_sys_open</span><br><span class="line"></span><br><span class="line">$ nm /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux |grep do_fork</span><br><span class="line">ffffffff8109acc0 T do_fork</span><br><span class="line">ffffffff81cf62e0 d do_fork_test</span><br><span class="line">$ cat /proc/kallsyms |grep do_fork</span><br><span class="line">ffffffff8d69acc0 T do_fork</span><br><span class="line">ffffffff8e2f62e0 d do_fork_test</span><br><span class="line"></span><br><span class="line"><span class="comment">## it could assigning the register data</span></span><br><span class="line">$ cat /sys/kernel/debug/kprobes/enabled</span><br><span class="line">1</span><br><span class="line">$ cat /proc/sys/debug/kprobes-optimization</span><br><span class="line">1</span><br><span class="line">/sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events <span class="comment">#the return value is number</span></span><br><span class="line"></span><br><span class="line">$ cat /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line"></span><br><span class="line">name: myprobe</span><br><span class="line">ID: 1662</span><br><span class="line">format:</span><br><span class="line">field:unsigned short common_type;offset:0;size:2;signed:0;</span><br><span class="line">field:unsigned char common_flags;offset:2;size:1;signed:0;</span><br><span class="line">field:unsigned char common_preempt_count;offset:3;size:1;signed:0;</span><br><span class="line">field:int common_pid;offset:4;size:4;signed:1;</span><br><span class="line"></span><br><span class="line">field:unsigned long __probe_ip;offset:8;size:8;signed:0;</span><br><span class="line">field:u64 dfd;offset:16;size:8;signed:0;</span><br><span class="line">field:u64 filename;offset:24;size:8;signed:0;</span><br><span class="line">field:u64 flags;offset:32;size:8;signed:0;</span><br><span class="line">field:u64 mode;offset:40;size:8;signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> fmt: <span class="string">&quot;(%lx) dfd=0x%Lx filename=0x%Lx flags=0x%Lx mode=0x%Lx&quot;</span>, REC-&gt;__probe_ip, REC-&gt;dfd, REC-&gt;filename, REC-&gt;flags, REC-&gt;mode</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myprobe getname +0($retval):string&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events <span class="comment">#the return value is string</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line">$ cat /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 61/61   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">             cat-13819 [015] d... 280432.427059: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x88000 flags=0x4150 mode=0xffffffff</span><br><span class="line">             cat-13819 [015] d... 280432.427069: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x88000 flags=0x4150 mode=0xffffffff</span><br><span class="line">             irqbalance-2106  [019] d... 280436.335586: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x8000 flags=0x1b6 mode=0xffffffff</span><br><span class="line">             irqbalance-2106  [019] d... 280436.337937: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x8000 flags=0x1b6 mode=0xffffffff</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line">$ <span class="built_in">echo</span> -:myprobe &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="comment"># clear all</span></span><br><span class="line">$ <span class="built_in">echo</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/local/sbin/ply</span></span><br><span class="line">kprobe:sys_unlinkat / !strcmp(execname, <span class="string">&quot;rm&quot;</span>) /</span><br><span class="line">&#123;</span><br><span class="line">   t[pid] =  walltime;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;pid: %d %s\n&quot;</span>, pid, str(arg1) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:sys_unlinkat / !strcmp(execname, <span class="string">&quot;rm&quot;</span>) /</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sys_unlinkat take time: %lld ns\n&quot;</span>, walltime - t[pid] );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="compile-the-kprobe-sample-codes-in-centos-7"><a href="#compile-the-kprobe-sample-codes-in-centos-7" class="headerlink" title="compile the kprobe sample codes in centos 7"></a>compile the kprobe sample codes in centos 7</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> linux-3.10.0-1127.el7/samples/kprobes</span><br><span class="line">$ ls</span><br><span class="line">jprobe_example.c  kprobe_example.c  kretprobe_example.c</span><br><span class="line"></span><br><span class="line"><span class="comment">## work with kretprobe_example.c</span></span><br><span class="line">$ cat Makefile</span><br><span class="line">obj-m := kretprobe_example.o</span><br><span class="line">KERNEL := /lib/modules/`uname -r`/build</span><br><span class="line">all:</span><br><span class="line">make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` modules</span><br><span class="line">install:</span><br><span class="line">make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` modules_install</span><br><span class="line">depmod -A</span><br><span class="line">clean:</span><br><span class="line">make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` clean</span><br><span class="line"></span><br><span class="line">$ make </span><br><span class="line">$ ls</span><br><span class="line">jprobe_example.c  kretprobe_example.c   kretprobe_example.mod.c  kretprobe_example.o  modules.order</span><br><span class="line">kprobe_example.c  kretprobe_example.ko  kretprobe_example.mod.o  Makefile             Module.symvers</span><br><span class="line"></span><br><span class="line">$ insmod ./kretprobe_example.ko</span><br><span class="line"></span><br><span class="line">$ dmesg -T</span><br><span class="line">[Tue Dec 15 02:27:50 2020] do_fork returned 5570 and took 30141 ns to execute</span><br><span class="line">[Tue Dec 15 02:27:51 2020] do_fork returned 5571 and took 131646 ns to execute</span><br><span class="line"></span><br><span class="line">$ lsmod | grep kret</span><br><span class="line">kretprobe_example      12696  0</span><br><span class="line">$ rmmod kretprobe_example</span><br><span class="line">$ lsmod | grep kret</span><br><span class="line">$ dmesg -T</span><br><span class="line">[Tue Dec 15 02:30:23 2020] kretprobe at ffffffff8d69acc0 unregistered</span><br><span class="line">[Tue Dec 15 02:30:23 2020] Missed probing 0 instances of do_fork</span><br></pre></td></tr></table></figure><ul><li>linux-3.10.0-1127.el7/include/linux/sysctl.h<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">struct ctl_table</span><br><span class="line">&#123;</span><br><span class="line">        const char *procname;           /* Text ID <span class="keyword">for</span> /proc/sys, or zero */</span><br><span class="line">        void *data;                     </span><br><span class="line">        int maxlen;</span><br><span class="line">        umode_t mode;                   </span><br><span class="line">        struct ctl_table *child;        /* Deprecated */</span><br><span class="line">        proc_handler *proc_handler;     /* Callback <span class="keyword">for</span> text formatting */</span><br><span class="line">        struct ctl_table_poll *poll;</span><br><span class="line">        void *extra1;</span><br><span class="line">        void *extra2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//mode,access permission</span><br><span class="line">//porc_dointvec, one or more int array[]</span><br><span class="line">//proc_dostring, <span class="built_in">read</span> and write stirng</span><br><span class="line">//proc_dointvec_minmax, the int value range from min to max</span><br></pre></td></tr></table></figure></li></ul><h3 id="Inject-function-example"><a href="#Inject-function-example" class="headerlink" title="Inject function example"></a>Inject function example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">$ uname -r</span><br><span class="line">3.10.0-1127.el7.x86_64</span><br><span class="line">$ bpftrace -V</span><br><span class="line">bpftrace v0.11.0-118-gf543-dirty</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;k:xs_tcp_send_request &#123;printf(&quot;override PID %d\n&quot;, pid);override(-5); &#125;&#x27;</span> --unsafe</span><br><span class="line">$ vi linux-3.10.0-1127.el7/net/sunrpc/xprtsock.c</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * xs_tcp_send_request - write an RPC request to a TCP socket</span><br><span class="line"> * @task: address of RPC task that manages the state of an RPC request</span><br><span class="line"> *</span><br><span class="line"> * Return values:</span><br><span class="line"> *        0:    The request has been sent</span><br><span class="line"> *   EAGAIN:    The socket was blocked, please call again later to</span><br><span class="line"> *              complete the request</span><br><span class="line"> * ENOTCONN:    Caller needs to invoke connect logic <span class="keyword">then</span> call again</span><br><span class="line"> *    other:    Some other error occurred, the request was not sent</span><br><span class="line"> *</span><br><span class="line"> * XXX: In the <span class="keyword">case</span> of soft timeouts, should we eventually give up</span><br><span class="line"> *      <span class="keyword">if</span> sendmsg is not able to make progress?</span><br><span class="line"> */</span><br><span class="line">static int xs_tcp_send_request(struct rpc_task *task)</span><br><span class="line">....</span><br><span class="line">        <span class="built_in">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe xs_tcp_send_request $retval&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/kprobes/myretprobe/format</span><br><span class="line">name: myretprobe</span><br><span class="line">ID: 1660</span><br><span class="line">format:</span><br><span class="line">field:unsigned short common_type;offset:0;size:2;signed:0;</span><br><span class="line">field:unsigned char common_flags;offset:2;size:1;signed:0;</span><br><span class="line">field:unsigned char common_preempt_count;offset:3;size:1;signed:0;</span><br><span class="line">field:int common_pid;offset:4;size:4;signed:1;</span><br><span class="line"></span><br><span class="line">field:unsigned long __probe_func;offset:8;size:8;signed:0;</span><br><span class="line">field:unsigned long __probe_ret_ip;offset:16;size:8;signed:0;</span><br><span class="line">field:u64 arg1;offset:24;size:8;signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> fmt: <span class="string">&quot;(%lx &lt;- %lx) arg1=0x%Lx&quot;</span>, REC-&gt;__probe_func, REC-&gt;__probe_ret_ip, REC-&gt;arg1</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/<span class="built_in">enable</span></span><br><span class="line">$ cat /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 24/24   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">  kworker/u433:0-18077 [017] d... 281350.965310: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">           &lt;...&gt;-170470 [008] d... 281350.968731: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">  kworker/u433:0-18077 [021] d... 281356.021502: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">           &lt;...&gt;-170470 [008] d... 281356.024915: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decimal from signed 2&#x27;s complement: 0xfffffffffffffffb = -5</span></span><br><span class="line"><span class="comment"># How to calculate ?</span></span><br><span class="line"><span class="comment"># 5 = 0000,0101</span></span><br><span class="line"><span class="comment"># Get complement: 1111,1010</span></span><br><span class="line"><span class="comment"># Add 1: 1111,1011</span></span><br><span class="line"><span class="comment">#         f , b</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/<span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">$ grep <span class="string">&quot;struct rpc_task &#123;&quot;</span> linux-3.10.0-1127.el7/include/linux/sunrpc/sched.h -A 50</span><br><span class="line">struct rpc_task &#123;</span><br><span class="line">atomic_ttk_count;/* Reference count */</span><br><span class="line">inttk_status;/* result of last operation */</span><br><span class="line">struct list_headtk_task;/* global list of tasks */</span><br></pre></td></tr></table></figure><p>Because it ‘s the kernel module from sunrpc.ko, not in vmlinux, try to loading the kernel module</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc</span><br><span class="line">$ cp sunrpc.ko.xz sunrpc-1.ko.xz</span><br><span class="line">$ xd -d sunrpc-1.ko.xz</span><br><span class="line">$ mv sunrpc-1.ko sunrpc.ko</span><br><span class="line"></span><br><span class="line">$ cat /sys/module/sunrpc/sections/.text</span><br><span class="line">0xffffffffc0bf9000</span><br><span class="line"></span><br><span class="line">$ add-symbol-file /lib/modules/3.10.0-1127.el7.x86_64/extra/qlgc-fastlinq/qede.ko 0xffffffffc022b000</span><br><span class="line"></span><br><span class="line">$ gdb /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line">$ add-symbol-file /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0bf9000</span><br><span class="line">$ add-symbol-file /usr/lib/modules/3.10.0-957.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0396000</span><br><span class="line">(gdb) list xs_tcp_send_request</span><br><span class="line">655 *</span><br><span class="line">656 * XXX: In the <span class="keyword">case</span> of soft timeouts, should we eventually give up</span><br><span class="line">657 *<span class="keyword">if</span> sendmsg is not able to make progress?</span><br><span class="line">658 */</span><br><span class="line">659static int xs_tcp_send_request(struct rpc_task *task)</span><br><span class="line">660&#123;</span><br><span class="line">661struct rpc_rqst *req = task-&gt;tk_rqstp;</span><br><span class="line">662struct rpc_xprt *xprt = req-&gt;rq_xprt;</span><br><span class="line">663struct sock_xprt *transport = container_of(xprt, struct sock_xprt, xprt);</span><br><span class="line">664struct xdr_buf *xdr = &amp;req-&gt;rq_snd_buf;</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_count</span><br><span class="line"><span class="variable">$1</span> = 0</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_timeout</span><br><span class="line"><span class="variable">$3</span> = 40</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_runstate</span><br><span class="line"><span class="variable">$4</span> = 48</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_msg</span><br><span class="line"><span class="variable">$6</span> = 120</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_start</span><br><span class="line"><span class="variable">$5</span> = 200</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe xs_tcp_send_request count=+0(%di):u32 run_sta=+48(%di):u32 tk_msg=+120(%di):x64&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/<span class="built_in">enable</span></span><br><span class="line">$ cat trace</span><br><span class="line">           &lt;...&gt;-81155 [020] d... 95057.395523: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bbb</span><br><span class="line">           &lt;...&gt;-81155 [010] d... 95057.395638: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bbb</span><br><span class="line">.....</span><br><span class="line">           &lt;...&gt;-81165 [008] d... 95063.283924: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bab</span><br><span class="line">           &lt;...&gt;-81165 [008] d... 95063.283973: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bab</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_client</span><br><span class="line"><span class="variable">$17</span> = 168</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_client-&gt;cl_metrics-&gt;om_ops</span><br><span class="line"><span class="variable">$18</span> = 8</span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_client-&gt;cl_metrics-&gt;om_ntrans</span><br><span class="line"><span class="variable">$19</span> = 16</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe xs_tcp_send_request count=+0(%di):u32 run_sta=+48(%di):u32 pid=+208(%di):u32&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">$ cat trace </span><br><span class="line">           &lt;...&gt;-88620 [001] d... 103530.318261: myprobe: (xs_tcp_send_request+0x0/0x230 [sunrpc]) count=0x2 run_sta=0x5 pid=0x15a2c</span><br><span class="line">           &lt;...&gt;-88620 [001] d... 103530.354814: myprobe: (xs_tcp_send_request+0x0/0x230 [sunrpc]) count=0x2 run_sta=0x5 pid=0x15a2c</span><br><span class="line">           &lt;...&gt;-88469 [004] d... 103587.916562: myprobe: (xs_tcp_send_request+0x0/0x230 [sunrpc]) count=0x1 run_sta=0x5 pid=0xe5</span><br><span class="line"></span><br><span class="line">0xe5=229</span><br><span class="line">root        229  0.0  0.0      0     0 ?        S    Dec19   0:00 [kworker/2:1]</span><br></pre></td></tr></table></figure><h4 id="linux-3-10-0-1127-el7-arch-x86-include-asm-calling-h"><a href="#linux-3-10-0-1127-el7-arch-x86-include-asm-calling-h" class="headerlink" title="linux-3.10.0-1127.el7/arch/x86/include/asm/calling.h"></a>linux-3.10.0-1127.el7/arch/x86/include/asm/calling.h</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">x86 function call convention, <span class="number">64</span>-bit:</span><br><span class="line">-------------------------------------</span><br><span class="line"> arguments           |  callee-saved      | extra caller-saved | <span class="keyword">return</span></span><br><span class="line">[callee-clobbered]   |                    | [callee-clobbered] |</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">rdi rsi rdx rcx r8<span class="number">-9</span> | rbx rbp [*] r12<span class="number">-15</span> | r10<span class="number">-11</span>             | rax, rdx [**]</span><br><span class="line"></span><br><span class="line">( rsp is obviously invariant across normal function calls. (gcc can &#x27;merge&#x27;</span><br><span class="line">  functions when it sees tail-call optimization possibilities) rflags is</span><br><span class="line">  clobbered. Leftover arguments are passed over the <span class="built_in">stack</span> frame.)</span><br><span class="line"></span><br><span class="line">[*]  In the frame-pointers <span class="keyword">case</span> rbp is fixed to the <span class="built_in">stack</span> frame.</span><br><span class="line"></span><br><span class="line">[**] <span class="keyword">for</span> <span class="class"><span class="keyword">struct</span> <span class="title">return</span> <span class="title">values</span> <span class="title">wider</span> <span class="title">than</span> 64 <span class="title">bits</span> <span class="title">the</span> <span class="title">return</span> <span class="title">convention</span> <span class="title">is</span> <span class="title">a</span></span></span><br><span class="line"><span class="class">     <span class="title">bit</span> <span class="title">more</span> <span class="title">complex</span>:</span> up to <span class="number">128</span> bits width we <span class="keyword">return</span> small structures</span><br><span class="line">     straight in rax, rdx. For structures larger than that (<span class="number">3</span> words <span class="keyword">or</span></span><br><span class="line">     larger) the caller <span class="built_in">puts</span> a pointer to an on-<span class="built_in">stack</span> <span class="keyword">return</span> struct</span><br><span class="line">     [allocated in the caller<span class="number">&#x27;</span>s <span class="built_in">stack</span> frame] into the first argument - i.e.</span><br><span class="line">     into rdi. All other arguments shift up by one in <span class="keyword">this</span> <span class="keyword">case</span>.</span><br><span class="line">     Fortunately <span class="keyword">this</span> <span class="keyword">case</span> is rare in the kernel.</span><br></pre></td></tr></table></figure><h4 id="user-and-kernel-space-parameters-in-regs"><a href="#user-and-kernel-space-parameters-in-regs" class="headerlink" title="user and kernel space parameters in regs"></a>user and kernel space parameters in regs</h4><p>linux-3.10.0-1127.el7/arch/x86/include/asm/ptrace.h<br><a href="https://uclibc.org/docs/psABI-x86_64.pdf">psABI-x86_64.pdf</a><br>page 125   </p><ul><li>User-level applications use as integer registers for passing the sequence %rdi, %rsi, %rdx, %rcx, %r8 and %r9</li><li>The kernel interface uses %rdi, %rsi, %rdx, %r10, %r8 and %r9</li><li>A system-call is done via the syscall instruction. The kernel destroys registers %rcx and %r11</li><li>The number of the syscall has to be passed in register %rax</li><li>System-calls are limited to six arguments, no argument is passed directly on the stack</li><li>Returning from the syscall, register %rax contains the result of the system-call. A value in the range between -4095 and -1 indicates an error, it is -errno</li><li>Only values of class INTEGER or class MEMORY are passed to the kernel</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// x86_64</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> bp;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> bx;</span><br><span class="line"><span class="comment">/* arguments: non interrupts/non tracing syscalls only save up to here*/</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r10; </span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r9; <span class="comment">// mapped to arg[5], if arg[5] is the float number, the r9 will not save it</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r8; <span class="comment">// mapped to arg[4]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ax;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> cx; <span class="comment">// mapped to arg[3]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> dx; <span class="comment">// mapped to arg[2]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> si; <span class="comment">// mapped to arg[1]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> di; <span class="comment">// mapped to arg[0] first parameters</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_ax;</span><br><span class="line"><span class="comment">/* end of arguments */</span></span><br><span class="line"><span class="comment">/* cpu exception frame or undefined */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ip;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> sp;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">##<span class="meta"># linux/arch/x86/entry/common.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line"><span class="keyword">if</span> (arch == AUDIT_ARCH_X86_64) &#123;</span><br><span class="line">sd.args[<span class="number">0</span>] = regs-&gt;di;</span><br><span class="line">sd.args[<span class="number">1</span>] = regs-&gt;si;</span><br><span class="line">sd.args[<span class="number">2</span>] = regs-&gt;dx;</span><br><span class="line">sd.args[<span class="number">3</span>] = regs-&gt;r10;</span><br><span class="line">sd.args[<span class="number">4</span>] = regs-&gt;r8;</span><br><span class="line">sd.args[<span class="number">5</span>] = regs-&gt;r9;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">&#123;</span><br><span class="line">sd.args[<span class="number">0</span>] = regs-&gt;bx;</span><br><span class="line">sd.args[<span class="number">1</span>] = regs-&gt;cx;</span><br><span class="line">sd.args[<span class="number">2</span>] = regs-&gt;dx;</span><br><span class="line">sd.args[<span class="number">3</span>] = regs-&gt;si;</span><br><span class="line">sd.args[<span class="number">4</span>] = regs-&gt;di;</span><br><span class="line">sd.args[<span class="number">5</span>] = regs-&gt;bp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/smith9527/p/11437647.html">reference</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Rin netif_receive_skb_core linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7</span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/net/core/dev.c:<span class="number">4237</span>:<span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb_core(struct sk_buff *skb, <span class="keyword">bool</span> pfmemalloc)</span><br><span class="line"></span><br><span class="line">$ crash /usr/lib/debug/usr/lib/modules/<span class="number">3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/vmlinux</span><br><span class="line">crash&gt; dis -l __netif_receive_skb_core</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4238</span></span><br><span class="line"><span class="number">0xffffffff9d0534f0</span> &lt;__netif_receive_skb_core&gt;:  nopl   <span class="number">0x0</span>(%rax,%rax,<span class="number">1</span>) [FTRACE NOP]</span><br><span class="line"><span class="number">0xffffffff9d0534f5</span> &lt;__netif_receive_skb_core+<span class="number">5</span>&gt;:        push   %rbp</span><br><span class="line"><span class="number">0xffffffff9d0534f6</span> &lt;__netif_receive_skb_core+<span class="number">6</span>&gt;:        mov    %rsp,%rbp</span><br><span class="line"><span class="number">0xffffffff9d0534f9</span> &lt;__netif_receive_skb_core+<span class="number">9</span>&gt;:        push   %r15</span><br><span class="line"><span class="number">0xffffffff9d0534fb</span> &lt;__netif_receive_skb_core+<span class="number">11</span>&gt;:       push   %r14</span><br><span class="line"><span class="number">0xffffffff9d0534fd</span> &lt;__netif_receive_skb_core+<span class="number">13</span>&gt;:       push   %r13</span><br><span class="line"><span class="number">0xffffffff9d0534ff</span> &lt;__netif_receive_skb_core+<span class="number">15</span>&gt;:       push   %r12</span><br><span class="line"><span class="number">0xffffffff9d053501</span> &lt;__netif_receive_skb_core+<span class="number">17</span>&gt;:       mov    %rdi,%r12  &lt;-------------- first parameter, arg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xffffffff9d053504</span> &lt;__netif_receive_skb_core+<span class="number">20</span>&gt;:       push   %rbx</span><br><span class="line"><span class="number">0xffffffff9d053505</span> &lt;__netif_receive_skb_core+<span class="number">21</span>&gt;:       <span class="keyword">and</span>    $<span class="number">0xfffffffffffffff0</span>,%rsp</span><br><span class="line"><span class="number">0xffffffff9d053509</span> &lt;__netif_receive_skb_core+<span class="number">25</span>&gt;:       sub    $<span class="number">0x38</span>,%rsp</span><br><span class="line"><span class="number">0xffffffff9d05350d</span> &lt;__netif_receive_skb_core+<span class="number">29</span>&gt;:       mov    %rdi,<span class="number">0x10</span>(%rsp)</span><br><span class="line"><span class="number">0xffffffff9d053512</span> &lt;__netif_receive_skb_core+<span class="number">34</span>&gt;:       mov    %sil,<span class="number">0x8</span>(%rsp)</span><br><span class="line"><span class="number">0xffffffff9d053517</span> &lt;__netif_receive_skb_core+<span class="number">39</span>&gt;:       mov    %gs:<span class="number">0x28</span>,%rax</span><br><span class="line"><span class="number">0xffffffff9d053520</span> &lt;__netif_receive_skb_core+<span class="number">48</span>&gt;:       mov    %rax,<span class="number">0x30</span>(%rsp)</span><br><span class="line"><span class="number">0xffffffff9d053525</span> &lt;__netif_receive_skb_core+<span class="number">53</span>&gt;:       <span class="keyword">xor</span>    %eax,%eax</span><br><span class="line"><span class="number">0xffffffff9d053527</span> &lt;__netif_receive_skb_core+<span class="number">55</span>&gt;:       jmpq   <span class="number">0xffffffff9d0539d8</span> &lt;__netif_receive_skb_core+<span class="number">1256</span>&gt;</span><br><span class="line"><span class="number">0xffffffff9d05352c</span> &lt;__netif_receive_skb_core+<span class="number">60</span>&gt;:       nopl   <span class="number">0x0</span>(%rax,%rax,<span class="number">1</span>)</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2262</span></span><br><span class="line"><span class="number">0xffffffff9d053531</span> &lt;__netif_receive_skb_core+<span class="number">65</span>&gt;:       mov    <span class="number">0xe8</span>(%r12),%rax</span><br><span class="line"><span class="number">0xffffffff9d053539</span> &lt;__netif_receive_skb_core+<span class="number">73</span>&gt;:       sub    <span class="number">0xe0</span>(%r12),%rax</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4253</span></span><br><span class="line"><span class="number">0xffffffff9d053541</span> &lt;__netif_receive_skb_core+<span class="number">81</span>&gt;:       cmpw   $<span class="number">0xffff</span>,<span class="number">0xc0</span>(%r12)</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4250</span></span><br><span class="line"><span class="number">0xffffffff9d05354b</span> &lt;__netif_receive_skb_core+<span class="number">91</span>&gt;:       mov    <span class="number">0x20</span>(%r12),%r14</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2262</span></span><br><span class="line"><span class="number">0xffffffff9d053550</span> &lt;__netif_receive_skb_core+<span class="number">96</span>&gt;:       mov    %ax,<span class="number">0xc2</span>(%r12)</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4253</span></span><br><span class="line"><span class="number">0xffffffff9d053559</span> &lt;__netif_receive_skb_core+<span class="number">105</span>&gt;:      je     <span class="number">0xffffffff9d053cd0</span> &lt;__netif_receive_skb_core+<span class="number">2016</span>&gt;</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2174</span></span><br><span class="line"><span class="number">0xffffffff9d05355f</span> &lt;__netif_receive_skb_core+<span class="number">111</span>&gt;:      sub    <span class="number">0xc4</span>(%r12),%ax</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4243</span></span><br><span class="line"><span class="number">0xffffffff9d053568</span> &lt;__netif_receive_skb_core+<span class="number">120</span>&gt;:      mov    $<span class="number">0x1</span>,%r15d</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2174</span></span><br></pre></td></tr></table></figure><h4 id="linux-3-10-0-1127-el7-include-linux-fs-h"><a href="#linux-3-10-0-1127-el7-include-linux-fs-h" class="headerlink" title="linux-3.10.0-1127.el7/include/linux/fs.h"></a>linux-3.10.0-1127.el7/include/linux/fs.h</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="keyword">long</span> do_sys_open(<span class="keyword">int</span> dfd, <span class="keyword">const</span> <span class="keyword">char</span> __user *filename, <span class="keyword">int</span> flags,</span><br><span class="line">                        umode_t mode);</span><br><span class="line">$ cd /sys/kernel/debug/tracing</span><br><span class="line">$ echo <span class="string">&#x27;p:open do_sys_open file=%si&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; events/kprobes/open/enable</span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># _-----=&gt; irqs-off</span></span><br><span class="line"><span class="meta"># / _----=&gt; need-resched</span></span><br><span class="line"><span class="meta"># | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="meta"># || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="meta"># ||| / delay</span></span><br><span class="line"><span class="meta"># TASK-PID CPU# |||| TIMESTAMP FUNCTION</span></span><br><span class="line"><span class="meta"># | | | |||| | |</span></span><br><span class="line"> ls<span class="number">-13261</span> [<span class="number">005</span>] ..<span class="number">.1</span> <span class="number">104673.170507</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x250</span>) file=<span class="number">0x562bbf8fe790</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># +0(%reg):string - Makes %reg into an address that string can use</span></span><br><span class="line">$ echo <span class="string">&#x27;p:open do_sys_open file=+0(%si):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ echo <span class="string">&#x27;p:kprobes/open do_sys_open file=+0($arg2):string&#x27;</span> &gt; kprobe_events # has the same results </span><br><span class="line">$ echo <span class="number">1</span> &gt; /sys/kernel/debug/tracing/events/kprobes/open/enable</span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># entries-in-buffer/entries-written: 447/447   #P:24</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="meta">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="meta">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="meta">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="meta">#                            ||| /     delay</span></span><br><span class="line"><span class="meta">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="meta">#              | |       |   ||||       |         |</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.631212</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/interrupts&quot;</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.632541</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/stat&quot;</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.632692</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/irq/25/smp_affinity&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">### function events not work in centos 7.8 and ubuntu 20.04</span></span><br><span class="line">$ cd /sys/kernel/tracing/events</span><br><span class="line">$ echo <span class="string">&#x27;do_sys_open(NULL, string file)&#x27;</span> &gt; function_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; events/functions/do_sys_open/enable</span><br><span class="line">$ ls &gt; /dev/<span class="literal">null</span></span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># _-----=&gt; irqs-off</span></span><br><span class="line"><span class="meta"># / _----=&gt; need-resched</span></span><br><span class="line"><span class="meta"># | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="meta"># || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="meta"># ||| / delay</span></span><br><span class="line"><span class="meta"># TASK-PID CPU# |||| TIMESTAMP FUNCTION</span></span><br><span class="line"><span class="meta"># | | | |||| | |</span></span><br><span class="line"> ls<span class="number">-822</span> [<span class="number">002</span>] ..<span class="number">.2</span> <span class="number">534.996438</span>: do_syscall_64-&gt;do_sys_open(file=/dev/<span class="literal">null</span>)</span><br><span class="line"> ls<span class="number">-822</span> [<span class="number">002</span>] ..<span class="number">.2</span> <span class="number">535.002703</span>: do_syscall_64-&gt;do_sys_open(file=/etc/ld.so.cache)</span><br></pre></td></tr></table></figure><h4 id="example2"><a href="#example2" class="headerlink" title="example2"></a><a href="https://events19.linuxfoundation.org/wp-content/uploads/2017/12/oss-eu-2018-fun-with-dynamic-trace-events_steven-rostedt.pdf">example2</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">(gdb) li ip_rcv</span><br><span class="line">378</span><br><span class="line">379/*</span><br><span class="line">380 * Main IP Receive routine.</span><br><span class="line">381 */</span><br><span class="line">382int ip_rcv(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *orig_dev)</span><br><span class="line">383&#123;</span><br><span class="line">384const struct iphdr *iph;</span><br><span class="line">385u32 len;</span><br><span class="line">386</span><br><span class="line">387/* When the interface is <span class="keyword">in</span> promisc. mode, drop all the crap</span><br><span class="line">(gdb) ptype struct net_device</span><br><span class="line"><span class="built_in">type</span> = struct net_device &#123;</span><br><span class="line">    char name[16];</span><br><span class="line">    struct hlist_node name_hlist;</span><br><span class="line">    char *ifalias;</span><br><span class="line">...</span><br><span class="line">    unsigned char perm_addr[32];</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">### not work in centos 7.8, ubuntu is ok</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:net ip_rcv dev=$arg2 name=+0($arg2):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ cat kprobe_events</span><br><span class="line">p:kprobes/net ip_rcv dev=<span class="variable">$arg2</span> name=+0(<span class="variable">$arg2</span>):string</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; events/kprobes/<span class="built_in">enable</span></span><br><span class="line">$ cat trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 460/460   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">          &lt;idle&gt;-0       [002] ..s. 201549.228307: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579520: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579534: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579542: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct net_device *)0)-&gt;perm_addr</span><br><span class="line"><span class="variable">$1</span> = 598</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:net ip_rcv name=+0($arg2):string a1=+598($arg2):x8 a2=+599($arg2):x8 a3=+600($arg2):x8 a4=+601($arg2):x8 a5=+602($arg2):x8 a6=+603($arg2):x8&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ head -n 15 trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 84/84   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">          &lt;idle&gt;-0       [021] ..s. 202995.512725: net: (ip_rcv+0x0/0xd0) name=<span class="string">&quot;br0&quot;</span> a1=0x0 a2=0x0 a3=0x0 a4=0x0 a5=0x0 a6=0x0</span><br><span class="line">           &lt;...&gt;-207344  [003] ..s. 202995.750896: net: (ip_rcv+0x0/0xd0) name=<span class="string">&quot;eno3&quot;</span> a1=0x18 a2=0x66 a3=0xda a4=0x91 a5=0x97 a6=0x9</span><br><span class="line"><span class="comment">#eno3 ether 18:66:da:91:97:09, looks like br0 no mac addr</span></span><br><span class="line"></span><br><span class="line">(gdb) li vfs_read</span><br><span class="line">446&#125;</span><br><span class="line">447</span><br><span class="line">448EXPORT_SYMBOL(do_sync_read);</span><br><span class="line">449</span><br><span class="line">450ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">451&#123;</span><br><span class="line">452ssize_t ret;</span><br><span class="line">453</span><br><span class="line">454<span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">455<span class="built_in">return</span> -EBADF;</span><br><span class="line">(gdb)  ptype struct file</span><br><span class="line"><span class="built_in">type</span> = struct file &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct list_head fu_list;</span><br><span class="line">        struct callback_head fu_rcuhead;</span><br><span class="line">    &#125; f_u;</span><br><span class="line">    struct path f_path;</span><br><span class="line">    struct inode *f_inode;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct inode</span><br><span class="line"><span class="built_in">type</span> = struct inode &#123;</span><br><span class="line">    umode_t i_mode;</span><br><span class="line">    unsigned short i_opflags;</span><br><span class="line">    kuid_t i_uid;</span><br><span class="line">    kgid_t i_gid;</span><br><span class="line">    unsigned int i_flags;</span><br><span class="line">    struct posix_acl *i_acl;</span><br><span class="line">    struct posix_acl *i_default_acl;</span><br><span class="line">    const struct inode_operations *i_op;</span><br><span class="line">    struct super_block *i_sb;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct super_block</span><br><span class="line"><span class="built_in">type</span> = struct super_block &#123;</span><br><span class="line">    struct list_head s_list;</span><br><span class="line">    dev_t s_dev;</span><br><span class="line">    unsigned char s_blocksize_bits;</span><br><span class="line">    unsigned long s_blocksize;</span><br><span class="line">    loff_t s_maxbytes;</span><br><span class="line">    struct file_system_type *s_type;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct file_system_type</span><br><span class="line"><span class="built_in">type</span> = struct file_system_type &#123;</span><br><span class="line">    const char *name;</span><br><span class="line"></span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct file *)0)-&gt;f_inode</span><br><span class="line"><span class="variable">$1</span> = 32</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct inode *)0)-&gt;i_sb</span><br><span class="line"><span class="variable">$2</span> = 40</span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct super_block *)0)-&gt;s_type</span><br><span class="line"><span class="variable">$3</span> = 40</span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct file_system_type *)0)-&gt;name</span><br><span class="line"><span class="variable">$4</span> = 0</span><br><span class="line"></span><br><span class="line"><span class="comment">### not support centos 7.8</span></span><br><span class="line">$ <span class="built_in">cd</span> /sys/kernel/debug/tracing</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; events/kprobes/<span class="built_in">enable</span></span><br><span class="line">$ cat trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 37/37   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">           &lt;...&gt;-520179  [018] .... 206923.224377: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devtmpfs&quot;</span></span><br><span class="line">           &lt;...&gt;-520179  [018] .... 206924.886880: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;sockfs&quot;</span></span><br><span class="line">           &lt;...&gt;-520240  [001] .... 206924.887006: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devpts&quot;</span></span><br><span class="line">           &lt;...&gt;-520240  [001] .... 206924.887022: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devpts&quot;</span></span><br><span class="line">           &lt;...&gt;-520240  [001] .... 206924.887029: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devpts&quot;</span></span><br><span class="line">           &lt;...&gt;-520179  [018] .... 206924.887110: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devtmpfs&quot;</span></span><br></pre></td></tr></table></figure><h3 id="The-same-result-use-perf"><a href="#The-same-result-use-perf" class="headerlink" title="The same result use perf"></a>The same result use perf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## The server installed debug-info</span></span><br><span class="line">$ perf probe -L vfs_read:0+10</span><br><span class="line">&lt;vfs_read@/usr/src/debug/kernel-3.10.0-1127.el7/linux-3.10.0-1127.el7.x86_64/fs/read_write.c:0&gt;</span><br><span class="line">      0  ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">      1  &#123;</span><br><span class="line">                ssize_t ret;</span><br><span class="line"></span><br><span class="line">      4         <span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">      5                 <span class="built_in">return</span> -EBADF;</span><br><span class="line">      6         <span class="keyword">if</span> (!file-&gt;f_op || (!file-&gt;f_op-&gt;<span class="built_in">read</span> &amp;&amp; !file-&gt;f_op-&gt;aio_read))</span><br><span class="line">      7                 <span class="built_in">return</span> -EINVAL;</span><br><span class="line">      8         <span class="keyword">if</span> (unlikely(!access_ok(VERIFY_WRITE, buf, count)))</span><br><span class="line">      9                 <span class="built_in">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">$ perf probe <span class="string">&#x27;vfs_read file-&gt;f_inode file-&gt;f_inode-&gt;i_sb file-&gt;f_inode-&gt;i_sb-&gt;s_type file-&gt;f_inode-&gt;i_sb-&gt;s_type-&gt;name:string&#x27;</span></span><br><span class="line"><span class="comment">### echo &#x27;p:myprobe vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27; &gt; kprobe_events</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR sleep 1</span><br><span class="line">$ perf report </span><br><span class="line">  33.33%  (ffffffff87a4cf20) f_inode=0xffff8e7e363aaa80 i_sb=0xffff8e8037bda800 s_type=0xffffffffc0430500 name=<span class="string">&quot;xfs&quot;</span></span><br><span class="line">  22.22%  (ffffffff87a4cf20) f_inode=0xffff8e803b86a060 i_sb=0xffff8e7f7c923000 s_type=0xffffffff884b1be0 name=<span class="string">&quot;anon_inodefs&quot;</span></span><br><span class="line">  22.22%  (ffffffff87a4cf20) f_inode=0xffff8e803bbec8c0 i_sb=0xffff8e8037bda800 s_type=0xffffffffc0430500 name=<span class="string">&quot;xfs&quot;</span></span><br><span class="line">....</span><br><span class="line">$ perf probe -d vfs_read</span><br><span class="line">Removed event: probe:vfs_read</span><br><span class="line"></span><br><span class="line"><span class="comment">#### not support centos 7.8, work on ubuntu 20.04</span></span><br><span class="line">$ perf probe <span class="string">&#x27;vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27;</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR sleep 1</span><br><span class="line">$ perf report</span><br><span class="line">  85.71%  (ffffffff8badefd0) name=<span class="string">&quot;ext4&quot;</span></span><br><span class="line">   7.14%  (ffffffff8badefd0) name=<span class="string">&quot;proc&quot;</span></span><br><span class="line">   7.14%  (ffffffff8badefd0) name=<span class="string">&quot;tmpfs&quot;</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR sleep 1</span><br><span class="line">$ perf probe -d vfs_read</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### another example  https://docs.windriver.com/bundle/Wind_River_Linux_Tutorial_Kernel_Debugging_with_ftrace_and_kprobes_LTS_19/page/mmo1403548860893.html</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:doforkprobe _do_fork clone_flags=%ax stack_start=%dx regs=%cx parent_tidptr=+4($stack) child_tidptr=+8($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:fork_retprobe _do_fork $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:dentry_openprobe dentry_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br></pre></td></tr></table></figure><h3 id="Crash"><a href="#Crash" class="headerlink" title="Crash"></a>Crash</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">crash /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line"></span><br><span class="line">crash 7.2.3-10.el7</span><br><span class="line">Copyright (C) 2002-2017  Red Hat, Inc.</span><br><span class="line">Copyright (C) 2004, 2005, 2006, 2010  IBM Corporation</span><br><span class="line">Copyright (C) 1999-2006  Hewlett-Packard Co</span><br><span class="line">Copyright (C) 2005, 2006, 2011, 2012  Fujitsu Limited</span><br><span class="line">Copyright (C) 2006, 2007  VA Linux Systems Japan K.K.</span><br><span class="line">Copyright (C) 2005, 2011  NEC Corporation</span><br><span class="line">Copyright (C) 1999, 2002, 2007  Silicon Graphics, Inc.</span><br><span class="line">Copyright (C) 1999, 2000, 2001, 2002  Mission Critical Linux, Inc.</span><br><span class="line">This program is free software, covered by the GNU General Public License,</span><br><span class="line">and you are welcome to change it and/or distribute copies of it under</span><br><span class="line">certain conditions.  Enter <span class="string">&quot;help copying&quot;</span> to see the conditions.</span><br><span class="line">This program has absolutely no warranty.  Enter <span class="string">&quot;help warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">GNU gdb (GDB) 7.6</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-unknown-linux-gnu&quot;</span>...</span><br><span class="line"></span><br><span class="line">WARNING: kernel relocated [104MB]: patching 87167 gdb minimal_symbol values</span><br><span class="line"></span><br><span class="line">please <span class="built_in">wait</span>... (patching 87167 gdb minimal_symbol values)</span><br><span class="line">      KERNEL: /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line">    DUMPFILE: /dev/crash</span><br><span class="line">        CPUS: 4</span><br><span class="line">        DATE: Sun Dec 20 10:11:56 2020</span><br><span class="line">      UPTIME: 3 days, 07:23:40</span><br><span class="line">LOAD AVERAGE: 0.22, 0.07, 0.06</span><br><span class="line">       TASKS: 156</span><br><span class="line">    NODENAME: centos7-test</span><br><span class="line">     RELEASE: 3.10.0-1127.el7.x86_64</span><br><span class="line">     VERSION: <span class="comment">#1 SMP Tue Mar 31 23:36:51 UTC 2020</span></span><br><span class="line">     MACHINE: x86_64  (2394 Mhz)</span><br><span class="line">      MEMORY: 8.1 GB</span><br><span class="line">         PID: 10155</span><br><span class="line">     COMMAND: <span class="string">&quot;crash&quot;</span></span><br><span class="line">        TASK: ffff8e8038748000  [THREAD_INFO: ffff8e7eb7154000]</span><br><span class="line">         CPU: 1</span><br><span class="line">       STATE: TASK_RUNNING (ACTIVE)</span><br><span class="line"></span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; *buffer_head</span><br><span class="line">struct buffer_head &#123;</span><br><span class="line">    unsigned long b_state;</span><br><span class="line">    struct buffer_head *b_this_page;</span><br><span class="line">    struct page *b_page;</span><br><span class="line">    sector_t b_blocknr;</span><br><span class="line">    size_t b_size;</span><br><span class="line">    char *b_data;</span><br><span class="line">    struct block_device *b_bdev;</span><br><span class="line">    bh_end_io_t *b_end_io;</span><br><span class="line">    void *b_private;</span><br><span class="line">    struct list_head b_assoc_buffers;</span><br><span class="line">    struct address_space *b_assoc_map;</span><br><span class="line">    atomic_t b_count;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 104</span><br><span class="line">crash&gt; struct cpu</span><br><span class="line">struct cpu &#123;</span><br><span class="line">    int node_id;</span><br><span class="line">    int hotpluggable;</span><br><span class="line">    struct device dev;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 680</span><br><span class="line">crash&gt; struct sym jiffies</span><br><span class="line">struct: invalid data structure reference: sym</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; sym jiffies</span><br><span class="line">ffffffff8856c000 (D) jiffies</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; files</span><br><span class="line">PID: 10155  TASK: ffff8e8038748000  CPU: 3   COMMAND: <span class="string">&quot;crash&quot;</span></span><br><span class="line">ROOT: /    CWD: /root</span><br><span class="line"> FD       FILE            DENTRY           INODE       TYPE PATH</span><br><span class="line">  0 ffff8e803b102b00 ffff8e7ea61bb480 ffff8e7ea61b5bc0 CHR  /dev/pts/0</span><br><span class="line">  1 ffff8e803b102b00 ffff8e7ea61bb480 ffff8e7ea61b5bc0 CHR  /dev/pts/0</span><br><span class="line">  2 ffff8e803b102b00 ffff8e7ea61bb480 ffff8e7ea61b5bc0 CHR  /dev/pts/0</span><br><span class="line">  3 ffff8e7e364f2f00 ffff8e7f7f827240 ffff8e8044570850 CHR  /dev/null</span><br><span class="line">  4 ffff8e803684e100 ffff8e7f7f834180 ffff8e8038ab9ae8 CHR  /dev/crash</span><br><span class="line">  5 ffff8e803684ec00 ffff8e800c25d180 ffff8e800c2d9400 REG  /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line">  6 ffff8e803aa2ac00 ffff8e800c3e6480 ffff8e800c37a9a0 FIFO</span><br><span class="line">  7 ffff8e803aa2a800 ffff8e800c3e6480 ffff8e800c37a9a0 FIFO</span><br><span class="line">  8 ffff8e803b102500 ffff8e800ead1300 ffff8e80029917c0 REG  /tmp/tmpfpagMdU</span><br><span class="line"> 10 ffff8e80445c4000 ffff8e7ea6199180 ffff8e800c37b090 FIFO</span><br><span class="line">crash&gt; struct dentry.d_inode,d_name ffff8e800ead1300</span><br><span class="line">  d_inode = 0xffff8e80029917c0</span><br><span class="line">  d_name = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">hash</span> = 1385601899,</span><br><span class="line">        len = 10</span><br><span class="line">      &#125;,</span><br><span class="line">      hash_len = 44335274859</span><br><span class="line">    &#125;,</span><br><span class="line">    name = 0xffff8e800ead1338 <span class="string">&quot;tmpfpagMdU&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">crash&gt;  rd -8 0xffff8e800ead1338 20</span><br><span class="line">ffff8e800ead1338:  74 6d 70 66 70 61 67 4d 64 55 00 63 74 00 0a 0a   tmpfpagMdU.ct...</span><br><span class="line">ffff8e800ead1348:  0a 0a 0a 0a</span><br><span class="line"></span><br><span class="line">crash&gt; mod -s sunrpc /lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line">     MODULE       NAME                            SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0b51300  sunrpc                        358543  /lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line"></span><br><span class="line">crash&gt; dmesg</span><br><span class="line">...</span><br><span class="line">[&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">crash&gt; add-symbol-file/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0bf9000</span><br><span class="line">add symbol table from file <span class="string">&quot;/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko&quot;</span> at</span><br><span class="line">        .text_addr = 0xffffffffc0bf9000</span><br><span class="line">Reading symbols from /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko...Reading symbols from /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko.debug...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">crash&gt; gdb list *xprt_transmit+0x6c</span><br><span class="line">0xffffffffc0bff38c is <span class="keyword">in</span> xprt_transmit (net/sunrpc/xprt.c:1024).</span><br><span class="line">1019                    &#125;</span><br><span class="line">1020            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!req-&gt;rq_bytes_sent)</span><br><span class="line">1021                    <span class="built_in">return</span>;</span><br><span class="line">1022</span><br><span class="line">1023            connect_cookie = xprt-&gt;connect_cookie;</span><br><span class="line">1024            status = xprt-&gt;ops-&gt;send_request(task);</span><br><span class="line">1025            trace_xprt_transmit(xprt, req-&gt;rq_xid, status);</span><br><span class="line">1026            <span class="keyword">if</span> (status != 0) &#123;</span><br><span class="line">1027                    task-&gt;tk_status = status;</span><br><span class="line">1028                    <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">crash&gt; dis -r xprt_transmit+0x6c</span><br><span class="line">0xffffffffc0b9c320 &lt;xprt_transmit&gt;:     nopl   0x0(%rax,%rax,1) [FTRACE NOP]</span><br><span class="line">0xffffffffc0b9c325 &lt;xprt_transmit+5&gt;:   push   %rbp</span><br><span class="line">0xffffffffc0b9c326 &lt;xprt_transmit+6&gt;:   mov    %rsp,%rbp</span><br><span class="line">0xffffffffc0b9c329 &lt;xprt_transmit+9&gt;:   push   %r15</span><br><span class="line">0xffffffffc0b9c32b &lt;xprt_transmit+11&gt;:  push   %r14</span><br><span class="line">0xffffffffc0b9c32d &lt;xprt_transmit+13&gt;:  mov    %rdi,%r14</span><br><span class="line">0xffffffffc0b9c330 &lt;xprt_transmit+16&gt;:  push   %r13</span><br><span class="line">0xffffffffc0b9c332 &lt;xprt_transmit+18&gt;:  push   %r12</span><br><span class="line">0xffffffffc0b9c334 &lt;xprt_transmit+20&gt;:  push   %rbx</span><br><span class="line">0xffffffffc0b9c335 &lt;xprt_transmit+21&gt;:  sub    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">0xffffffffc0b9c339 &lt;xprt_transmit+25&gt;:  testb  <span class="variable">$0x1</span>,0x38f0c(%rip)        <span class="comment"># 0xffffffffc0bd524c</span></span><br><span class="line">0xffffffffc0b9c340 &lt;xprt_transmit+32&gt;:  mov    0xb8(%rdi),%r12</span><br><span class="line">0xffffffffc0b9c347 &lt;xprt_transmit+39&gt;:  mov    (%r12),%r15</span><br><span class="line">0xffffffffc0b9c34b &lt;xprt_transmit+43&gt;:  jne    0xffffffffc0b9c63a &lt;xprt_transmit+794&gt;</span><br><span class="line">0xffffffffc0b9c351 &lt;xprt_transmit+49&gt;:  cmpq   <span class="variable">$0x0</span>,0xf0(%r12)</span><br><span class="line">0xffffffffc0b9c35a &lt;xprt_transmit+58&gt;:  jne    0xffffffffc0b9c3b8 &lt;xprt_transmit+152&gt;</span><br><span class="line">0xffffffffc0b9c35c &lt;xprt_transmit+60&gt;:  lea    0xb8(%r12),%rbx</span><br><span class="line">0xffffffffc0b9c364 &lt;xprt_transmit+68&gt;:  cmp    0xb8(%r12),%rbx</span><br><span class="line">0xffffffffc0b9c36c &lt;xprt_transmit+76&gt;:  je     0xffffffffc0b9c510 &lt;xprt_transmit+496&gt;</span><br><span class="line">0xffffffffc0b9c372 &lt;xprt_transmit+82&gt;:  mov    0x440(%r15),%eax</span><br><span class="line">0xffffffffc0b9c379 &lt;xprt_transmit+89&gt;:  mov    %r14,%rdi</span><br><span class="line">0xffffffffc0b9c37c &lt;xprt_transmit+92&gt;:  mov    %eax,-0x30(%rbp)</span><br><span class="line">0xffffffffc0b9c37f &lt;xprt_transmit+95&gt;:  mov    0x8(%r15),%rax</span><br><span class="line">0xffffffffc0b9c383 &lt;xprt_transmit+99&gt;:  mov    0x50(%rax),%rax</span><br><span class="line">0xffffffffc0b9c387 &lt;xprt_transmit+103&gt;: callq  0xffffffffa5f96410 &lt;__x86_indirect_thunk_rax&gt;</span><br><span class="line">0xffffffffc0b9c38c &lt;xprt_transmit+108&gt;: mov    %eax,%ebx</span><br><span class="line"></span><br><span class="line">crash&gt; sym 0xffffffffc0b9c510</span><br><span class="line">ffffffffc0b9c510 (t) xprt_transmit+496 [sunrpc]</span><br><span class="line"></span><br><span class="line">crash&gt; whatis xprt_transmit</span><br><span class="line">void xprt_transmit(struct rpc_task *);</span><br><span class="line"></span><br><span class="line">crash&gt; whatis __x86_indirect_thunk_rax</span><br><span class="line">&lt;text variable, no debug info&gt; __x86_indirect_thunk_rax;</span><br></pre></td></tr></table></figure><p>——— re-run</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line">[Wed Dec 23 22:03:22 2020] Modules linked <span class="keyword">in</span>: rpcsec_gss_krb5 auth_rpcgss nfsv4 dns_resolver nfs lockd grace fscache dell_rbu bonding sunrpc iTCO_wdt iTCO_vendor_support mxm_wmi dcdbas vfat fat sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr joydev lpc_ich sg mei_me mei ipmi_si ipmi_devintf ipmi_msghandler wmi acpi_power_meter binfmt_misc ip_tables xfs sr_mod cdrom sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm bnx2x ahci drm mpt3sas crct10dif_pclmul crct10dif_common crc32c_intel libahci megaraid_sas mdio libata raid_class ptp drm_panel_orientation_quirks scsi_transport_sas pps_core libcrc32c</span><br><span class="line">[Wed Dec 23 22:03:22 2020] CPU: 6 PID: 70273 Comm: kworker/u434:1 Kdump: loaded Tainted: G             L ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Wed Dec 23 22:03:22 2020] Hardware name: Dell Inc. PowerEdge R630/0CNCJW, BIOS 2.11.0 11/02/2019</span><br><span class="line">[Wed Dec 23 22:03:22 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RIP: 0010:[&lt;ffffffffc0b97de0&gt;]  [&lt;ffffffffc0b97de0&gt;] call_transmit+0x0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RSP: 0018:ffff8ebe1e183da8  EFLAGS: 00000282</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RAX: 0000000000000005 RBX: ffff8ebe1e183d38 RCX: 00000000ffffffe0</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RDX: ffff8ebe3155b05c RSI: ffff8ebe1e183cb0 RDI: ffff8ece3a176100</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RBP: ffff8ebe1e183e08 R08: ffff8ebe3af63b08 R09: 0000000000000001</span><br><span class="line">[Wed Dec 23 22:03:22 2020] R10: ffff8ebe1e183d00 R11: ffff8ebe1e183c88 R12: 0000000000000010</span><br><span class="line">[Wed Dec 23 22:03:22 2020] R13: ffffffffa5c6911b R14: ffff8ebe3155b084 R15: ffff8ece3a176100</span><br><span class="line">[Wed Dec 23 22:03:22 2020] FS:  0000000000000000(0000) GS:ffff8ebe3e2c0000(0000) knlGS:0000000000000000</span><br><span class="line">[Wed Dec 23 22:03:22 2020] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[Wed Dec 23 22:03:22 2020] CR2: 00007f9186d4dc70 CR3: 000000028aa10000 CR4: 00000000001607e0</span><br><span class="line">[Wed Dec 23 22:03:22 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffc0ba51c9&gt;] ? __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:22 2020] Code: 00 48 c7 c7 60 57 bc c0 48 8b b0 90 05 00 00 31 c0 e8 8d 18 7e e5 41 b8 f3 ff ff ff e9 ee fa ff ff 66 2e 0f 1f 84 00 00 00 00 00 &lt;0f&gt; 1f 44 00 00 55 f6 05 5f d4 03 00 02 48 89 e5 41 56 41 55 41</span><br><span class="line">[Wed Dec 23 22:03:50 2020] NMI watchdog: BUG: soft lockup - CPU<span class="comment">#6 stuck for 22s! [kworker/u434:1:70273]</span></span><br><span class="line">[Wed Dec 23 22:03:50 2020] Modules linked <span class="keyword">in</span>: rpcsec_gss_krb5 auth_rpcgss nfsv4 dns_resolver nfs lockd grace fscache dell_rbu bonding sunrpc iTCO_wdt iTCO_vendor_support mxm_wmi dcdbas vfat fat sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr joydev lpc_ich sg mei_me mei ipmi_si ipmi_devintf ipmi_msghandler wmi acpi_power_meter binfmt_misc ip_tables xfs sr_mod cdrom sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm bnx2x ahci drm mpt3sas crct10dif_pclmul crct10dif_common crc32c_intel libahci megaraid_sas mdio libata raid_class ptp drm_panel_orientation_quirks scsi_transport_sas pps_core libcrc32c</span><br><span class="line">[Wed Dec 23 22:03:50 2020] CPU: 6 PID: 70273 Comm: kworker/u434:1 Kdump: loaded Tainted: G             L ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Wed Dec 23 22:03:50 2020] Hardware name: Dell Inc. PowerEdge R630/0CNCJW, BIOS 2.11.0 11/02/2019</span><br><span class="line">[Wed Dec 23 22:03:50 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RIP: 0010:[&lt;ffffffffa638ce89&gt;]  [&lt;ffffffffa638ce89&gt;] kprobe_ftrace_handler+0x69/0x120</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RSP: 0018:ffff8ebe1e183c10  EFLAGS: 00000282</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RAX: 0000000000000001 RBX: 0000000000000004 RCX: ffffffffc0b9fc55</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RDX: 0000000000000001 RSI: ffffffffffffffe0 RDI: 0000000000000282</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RBP: ffff8ebe1e183c40 R08: 00000000359c2550 R09: 000000000000001f</span><br><span class="line">[Wed Dec 23 22:03:50 2020] R10: 00000000359c2550 R11: ffff8ebe1e183c88 R12: ffff8ebe3155b05c</span><br><span class="line">[Wed Dec 23 22:03:50 2020] R13: ffff8ebe3155b058 R14: ffff8ebe3af63b08 R15: 0000000000000001</span><br><span class="line">[Wed Dec 23 22:03:50 2020] FS:  0000000000000000(0000) GS:ffff8ebe3e2c0000(0000) knlGS:0000000000000000</span><br><span class="line">[Wed Dec 23 22:03:50 2020] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[Wed Dec 23 22:03:50 2020] CR2: 00007f9186d4dc70 CR3: 000000028aa10000 CR4: 00000000001607e0</span><br><span class="line">[Wed Dec 23 22:03:50 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5d62634&gt;] ftrace_ops_list_func+0xf4/0x120</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa6396b14&gt;] ftrace_regs_call+0x5/0x81</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5c6911b&gt;] ? arch_unoptimize_kprobes+0xdb/0xdb</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b97fb0&gt;] call_transmit+0x1d0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0ba51c9&gt;] __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:50 2020] Code: 75 24 49 c7 c6 a0 33 01 00 65 4c 03 35 71 43 c8 59 65 48 8b 05 51 66 c8 59 48 85 c0 74 24 4c 89 e7 e8 5c 37 00 00 48 89 df 57 9d &lt;0f&gt; 1f 44 00 00 48 83 c4 08 5b 41 5c 41 5d 41 5e 41 5f 5d c3 0f</span><br><span class="line">[Wed Dec 23 22:04:02 2020] INFO: rcu_sched self-detected stall on CPU &#123; 6&#125;  (t=600013 jiffies g=238339 c=238338 q=49819)</span><br><span class="line">[Wed Dec 23 22:04:02 2020] Task dump <span class="keyword">for</span> CPU 6:</span><br><span class="line">[Wed Dec 23 22:04:02 2020] kworker/u434:1  R  running task        0 70273      2 0x00000088</span><br><span class="line">[Wed Dec 23 22:04:02 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  &lt;IRQ&gt;  [&lt;ffffffffa5cdab18&gt;] sched_show_task+0xa8/0x110</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cde919&gt;] dump_cpu_task+0x39/0x70</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d58b90&gt;] rcu_dump_cpu_stacks+0x90/0xd0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d5c252&gt;] rcu_check_callbacks+0x442/0x730</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d10ae0&gt;] ? tick_sched_do_timer+0x50/0x50</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5caf9d6&gt;] update_process_times+0x46/0x80</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d10850&gt;] tick_sched_handle+0x30/0x70</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d10b19&gt;] tick_sched_timer+0x39/0x80</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5ccaa8e&gt;] __hrtimer_run_queues+0x10e/0x270</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5ccafef&gt;] hrtimer_interrupt+0xaf/0x1d0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc51&gt;] ? xs_tcp_send_request+0x1/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5c5caeb&gt;] local_apic_timer_interrupt+0x3b/0x60</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa63979c3&gt;] smp_apic_timer_interrupt+0x43/0x60</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6393efa&gt;] apic_timer_interrupt+0x16a/0x170</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  &lt;EOI&gt;  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa638ce89&gt;] ? kprobe_ftrace_handler+0x69/0x120</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d62634&gt;] ftrace_ops_list_func+0xf4/0x120</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6396b14&gt;] ftrace_regs_call+0x5/0x81</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5c6911b&gt;] ? arch_unoptimize_kprobes+0xdb/0xdb</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b97fb0&gt;] call_transmit+0x1d0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0ba51c9&gt;] __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:30 2020] NMI watchdog: BUG: soft lockup - CPU<span class="comment">#6 stuck for 23s! [kworker/u434:1:70273]</span></span><br><span class="line">[Wed Dec 23 22:04:30 2020] Modules linked <span class="keyword">in</span>: rpcsec_gss_krb5 auth_rpcgss nfsv4 dns_resolver nfs lockd grace fscache dell_rbu bonding sunrpc iTCO_wdt iTCO_vendor_support mxm_wmi dcdbas vfat fat sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr joydev lpc_ich sg mei_me mei ipmi_si ipmi_devintf ipmi_msghandler wmi acpi_power_meter binfmt_misc ip_tables xfs sr_mod cdrom sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm bnx2x ahci drm mpt3sas crct10dif_pclmul crct10dif_common crc32c_intel libahci megaraid_sas mdio libata raid_class ptp drm_panel_orientation_quirks scsi_transport_sas pps_core libcrc32c</span><br><span class="line">[Wed Dec 23 22:04:30 2020] CPU: 6 PID: 70273 Comm: kworker/u434:1 Kdump: loaded Tainted: G             L ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Wed Dec 23 22:04:30 2020] Hardware name: Dell Inc. PowerEdge R630/0CNCJW, BIOS 2.11.0 11/02/2019</span><br><span class="line">[Wed Dec 23 22:04:30 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RIP: 0010:[&lt;ffffffffa638ce92&gt;]  [&lt;ffffffffa638ce92&gt;] kprobe_ftrace_handler+0x72/0x120</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RSP: 0018:ffff8ebe1e183c18  EFLAGS: 00000286</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RAX: 0000000000000001 RBX: ffff8ebe3af63b08 RCX: ffffffffc0b9fc55</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RDX: 0000000000000001 RSI: ffffffffffffffe0 RDI: 0000000000000282</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RBP: ffff8ebe1e183c40 R08: 000000003968f6f0 R09: 000000000000001f</span><br><span class="line">[Wed Dec 23 22:04:30 2020] R10: 000000003968f6f0 R11: ffff8ebe1e183c88 R12: ffff8ebe1e183d00</span><br><span class="line">[Wed Dec 23 22:04:30 2020] R13: ffff8ebe1e183c88 R14: ffff8ebe3af63b08 R15: ffff8ebe1e183c00</span><br><span class="line">[Wed Dec 23 22:04:30 2020] FS:  0000000000000000(0000) GS:ffff8ebe3e2c0000(0000) knlGS:0000000000000000</span><br><span class="line">[Wed Dec 23 22:04:30 2020] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[Wed Dec 23 22:04:30 2020] CR2: 00007f9186d4dc70 CR3: 000000028aa10000 CR4: 00000000001607e0</span><br><span class="line">[Wed Dec 23 22:04:30 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5d62634&gt;] ftrace_ops_list_func+0xf4/0x120</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa6396b14&gt;] ftrace_regs_call+0x5/0x81</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5c6911b&gt;] ? arch_unoptimize_kprobes+0xdb/0xdb</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b97fb0&gt;] call_transmit+0x1d0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0ba51c9&gt;] __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:30 2020] Code: 65 4c 03 35 71 43 c8 59 65 48 8b 05 51 66 c8 59 48 85 c0 74 24 4c 89 e7 e8 5c 37 00 00 48 89 df 57 9d 0f 1f 44 00 00 48 83 c4 08 &lt;5b&gt; 41 5c 41 5d 41 5e 41 5f 5d c3 0f 1f 00 49 83 c5 01 49 8b 8f</span><br><span class="line"></span><br><span class="line"><span class="comment">## loading external kernel module</span></span><br><span class="line">crash&gt; add-symbol-file /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0bf9000</span><br><span class="line">add symbol table from file <span class="string">&quot;/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko&quot;</span> at</span><br><span class="line">        .text_addr = 0xffffffffc0bf9000</span><br><span class="line">Reading symbols from /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko...Reading symbols from /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko.debug...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">or you could</span><br><span class="line"></span><br><span class="line">crash&gt; mod -s sunrpc /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line">     MODULE       NAME                            SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0bd2300  sunrpc                        358543  /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line"></span><br><span class="line"><span class="comment">### crash run script</span></span><br><span class="line">crash&gt; &lt; /tmp/test.sh</span><br><span class="line"></span><br><span class="line">crash&gt; struct -o rpc_task</span><br><span class="line">struct rpc_task &#123;</span><br><span class="line">    [0] atomic_t tk_count;</span><br><span class="line">    [4] int tk_status;</span><br><span class="line">    [8] struct list_head tk_task;</span><br><span class="line">   [24] void (*tk_callback)(struct rpc_task *);</span><br><span class="line">   [32] void (*tk_action)(struct rpc_task *);</span><br><span class="line">   [40] unsigned long tk_timeout;</span><br><span class="line">   [48] unsigned long tk_runstate;</span><br><span class="line">   [56] struct rpc_wait_queue *tk_waitqueue;</span><br><span class="line">        union &#123;</span><br><span class="line">            struct work_struct tk_work;</span><br><span class="line">            struct rpc_wait tk_wait;</span><br><span class="line">   [64] &#125; u;</span><br><span class="line">  [120] struct rpc_message tk_msg;</span><br><span class="line">  [152] void *tk_calldata;</span><br><span class="line">  [160] const struct rpc_call_ops *tk_ops;</span><br><span class="line">  [168] struct rpc_clnt *tk_client;</span><br><span class="line">  [176] struct rpc_xprt *tk_xprt;</span><br><span class="line">  [184] struct rpc_rqst *tk_rqstp;</span><br><span class="line">  [192] struct workqueue_struct *tk_workqueue;</span><br><span class="line">  [200] ktime_t tk_start;</span><br><span class="line">  [208] pid_t tk_owner;</span><br><span class="line">  [212] unsigned short tk_flags;</span><br><span class="line">  [214] unsigned short tk_timeouts;</span><br><span class="line">  [216] unsigned short tk_pid;</span><br><span class="line">  [218] unsigned char tk_priority : 2;</span><br><span class="line">  [218] unsigned char tk_garb_retry : 2;</span><br><span class="line">  [218] unsigned char tk_cred_retry : 2;</span><br><span class="line">  [218] unsigned char tk_rebind_retry : 2;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 224</span><br><span class="line"></span><br><span class="line">crash&gt; kmem -s</span><br><span class="line">CACHE            NAME                 OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE</span><br><span class="line">ffff8ece2ef38300 nfs_direct_cache         352          0         0      0    16k</span><br><span class="line">ffff8ece2ef38200 nfs_commit_data          696          4        46      1    32k</span><br><span class="line">ffff8ece2ef38100 nfs_read_data            888         32       216      6    32k</span><br><span class="line">ffff8ece2ef38000 nfs_inode_cache         1040        180       279      9    32k</span><br><span class="line"></span><br><span class="line">crash&gt; kmem -S nfs_inode_cache</span><br><span class="line"></span><br><span class="line">[Wed Dec 23 22:03:50 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RIP: 0010:[&lt;ffffffffa638ce89&gt;]  [&lt;ffffffffa638ce89&gt;] kprobe_ftrace_handler+0x69/0x120</span><br><span class="line"></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6393efa&gt;] apic_timer_interrupt+0x16a/0x170</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  &lt;EOI&gt;  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc] <span class="comment">## got bad value</span></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa638ce89&gt;] ? kprobe_ftrace_handler+0x69/0x120 <span class="comment">## insert the error</span></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]  <span class="comment">## the normal return</span></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line"></span><br><span class="line"><span class="comment">##linux-3.10.0-1127.el7/tools/include/uapi/asm-generic/errno-base.h</span></span><br><span class="line">/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span><br><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#defineEPERM 1/* Operation not permitted */</span></span><br><span class="line"><span class="comment">#defineENOENT 2/* No such file or directory */</span></span><br><span class="line"><span class="comment">#defineESRCH 3/* No such process */</span></span><br><span class="line"><span class="comment">#defineEINTR 4/* Interrupted system call */</span></span><br><span class="line"><span class="comment">#defineEIO 5/* I/O error */</span></span><br><span class="line"><span class="comment">#defineENXIO 6/* No such device or address */</span></span><br><span class="line"><span class="comment">#defineE2BIG 7/* Argument list too long */</span></span><br><span class="line"><span class="comment">#defineENOEXEC 8/* Exec format error */</span></span><br><span class="line"><span class="comment">#defineEBADF 9/* Bad file number */</span></span><br><span class="line"><span class="comment">#defineECHILD10/* No child processes */</span></span><br><span class="line"><span class="comment">#defineEAGAIN11/* Try again */</span></span><br><span class="line"><span class="comment">#defineENOMEM12/* Out of memory */</span></span><br><span class="line"><span class="comment">#defineEACCES13/* Permission denied */</span></span><br><span class="line"><span class="comment">#defineEFAULT14/* Bad address */</span></span><br><span class="line"><span class="comment">#defineENOTBLK15/* Block device required */</span></span><br><span class="line"><span class="comment">#defineEBUSY16/* Device or resource busy */</span></span><br><span class="line"><span class="comment">#defineEEXIST17/* File exists */</span></span><br><span class="line"><span class="comment">#defineEXDEV18/* Cross-device link */</span></span><br><span class="line"><span class="comment">#defineENODEV19/* No such device */</span></span><br><span class="line"><span class="comment">#defineENOTDIR20/* Not a directory */</span></span><br><span class="line"><span class="comment">#defineEISDIR21/* Is a directory */</span></span><br><span class="line"><span class="comment">#defineEINVAL22/* Invalid argument */</span></span><br><span class="line"><span class="comment">#defineENFILE23/* File table overflow */</span></span><br><span class="line"><span class="comment">#defineEMFILE24/* Too many open files */</span></span><br><span class="line"><span class="comment">#defineENOTTY25/* Not a typewriter */</span></span><br><span class="line"><span class="comment">#defineETXTBSY26/* Text file busy */</span></span><br><span class="line"><span class="comment">#defineEFBIG27/* File too large */</span></span><br><span class="line"><span class="comment">#defineENOSPC28/* No space left on device */</span></span><br><span class="line"><span class="comment">#defineESPIPE29/* Illegal seek */</span></span><br><span class="line"><span class="comment">#defineEROFS30/* Read-only file system */</span></span><br><span class="line"><span class="comment">#defineEMLINK31/* Too many links */</span></span><br><span class="line"><span class="comment">#defineEPIPE32/* Broken pipe */</span></span><br><span class="line"><span class="comment">#defineEDOM33/* Math argument out of domain of func */</span></span><br><span class="line"><span class="comment">#defineERANGE34/* Math result not representable */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat linux-3.10.0-1127.el7/tools/include/uapi/asm-generic/errno.h</span></span><br><span class="line"></span><br><span class="line">/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span><br><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;asm-generic/errno-base.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#defineEDEADLK35/* Resource deadlock would occur */</span></span><br><span class="line"><span class="comment">#defineENAMETOOLONG36/* File name too long */</span></span><br><span class="line"><span class="comment">#defineENOLCK37/* No record locks available */</span></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * This error code is special: arch syscall entry code will <span class="built_in">return</span></span><br><span class="line"> * -ENOSYS <span class="keyword">if</span> users try to call a syscall that doesn<span class="string">&#x27;t exist.  To keep</span></span><br><span class="line"><span class="string"> * failures of syscalls that really do exist distinguishable from</span></span><br><span class="line"><span class="string"> * failures due to attempts to use a nonexistent syscall, syscall</span></span><br><span class="line"><span class="string"> * implementations should refrain from returning -ENOSYS.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">#defineENOSYS38/* Invalid system call number */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#defineENOTEMPTY39/* Directory not empty */</span></span><br><span class="line"><span class="string">#defineELOOP40/* Too many symbolic links encountered */</span></span><br><span class="line"><span class="string">#defineEWOULDBLOCKEAGAIN/* Operation would block */</span></span><br><span class="line"><span class="string">#defineENOMSG42/* No message of desired type */</span></span><br><span class="line"><span class="string">#defineEIDRM43/* Identifier removed */</span></span><br><span class="line"><span class="string">#defineECHRNG44/* Channel number out of range */</span></span><br><span class="line"><span class="string">#defineEL2NSYNC45/* Level 2 not synchronized */</span></span><br><span class="line"><span class="string">#defineEL3HLT46/* Level 3 halted */</span></span><br><span class="line"><span class="string">#defineEL3RST47/* Level 3 reset */</span></span><br><span class="line"><span class="string">#defineELNRNG48/* Link number out of range */</span></span><br><span class="line"><span class="string">#defineEUNATCH49/* Protocol driver not attached */</span></span><br><span class="line"><span class="string">#defineENOCSI50/* No CSI structure available */</span></span><br><span class="line"><span class="string">#defineEL2HLT51/* Level 2 halted */</span></span><br><span class="line"><span class="string">#defineEBADE52/* Invalid exchange */</span></span><br><span class="line"><span class="string">#defineEBADR53/* Invalid request descriptor */</span></span><br><span class="line"><span class="string">#defineEXFULL54/* Exchange full */</span></span><br><span class="line"><span class="string">#defineENOANO55/* No anode */</span></span><br><span class="line"><span class="string">#defineEBADRQC56/* Invalid request code */</span></span><br><span class="line"><span class="string">#defineEBADSLT57/* Invalid slot */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#defineEDEADLOCKEDEADLK</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#defineEBFONT59/* Bad font file format */</span></span><br><span class="line"><span class="string">#defineENOSTR60/* Device not a stream */</span></span><br><span class="line"><span class="string">#defineENODATA61/* No data available */</span></span><br><span class="line"><span class="string">#defineETIME62/* Timer expired */</span></span><br><span class="line"><span class="string">#defineENOSR63/* Out of streams resources */</span></span><br><span class="line"><span class="string">#defineENONET64/* Machine is not on the network */</span></span><br><span class="line"><span class="string">#defineENOPKG65/* Package not installed */</span></span><br><span class="line"><span class="string">#defineEREMOTE66/* Object is remote */</span></span><br><span class="line"><span class="string">#defineENOLINK67/* Link has been severed */</span></span><br><span class="line"><span class="string">#defineEADV68/* Advertise error */</span></span><br><span class="line"><span class="string">#defineESRMNT69/* Srmount error */</span></span><br><span class="line"><span class="string">#defineECOMM70/* Communication error on send */</span></span><br><span class="line"><span class="string">#defineEPROTO71/* Protocol error */</span></span><br><span class="line"><span class="string">#defineEMULTIHOP72/* Multihop attempted */</span></span><br><span class="line"><span class="string">#defineEDOTDOT73/* RFS specific error */</span></span><br><span class="line"><span class="string">#defineEBADMSG74/* Not a data message */</span></span><br><span class="line"><span class="string">#defineEOVERFLOW75/* Value too large for defined data type */</span></span><br><span class="line"><span class="string">#defineENOTUNIQ76/* Name not unique on network */</span></span><br><span class="line"><span class="string">#defineEBADFD77/* File descriptor in bad state */</span></span><br><span class="line"><span class="string">#defineEREMCHG78/* Remote address changed */</span></span><br><span class="line"><span class="string">#defineELIBACC79/* Can not access a needed shared library */</span></span><br><span class="line"><span class="string">#defineELIBBAD80/* Accessing a corrupted shared library */</span></span><br><span class="line"><span class="string">#defineELIBSCN81/* .lib section in a.out corrupted */</span></span><br><span class="line"><span class="string">#defineELIBMAX82/* Attempting to link in too many shared libraries */</span></span><br><span class="line"><span class="string">#defineELIBEXEC83/* Cannot exec a shared library directly */</span></span><br><span class="line"><span class="string">#defineEILSEQ84/* Illegal byte sequence */</span></span><br><span class="line"><span class="string">#defineERESTART85/* Interrupted system call should be restarted */</span></span><br><span class="line"><span class="string">#defineESTRPIPE86/* Streams pipe error */</span></span><br><span class="line"><span class="string">#defineEUSERS87/* Too many users */</span></span><br><span class="line"><span class="string">#defineENOTSOCK88/* Socket operation on non-socket */</span></span><br><span class="line"><span class="string">#defineEDESTADDRREQ89/* Destination address required */</span></span><br><span class="line"><span class="string">#defineEMSGSIZE90/* Message too long */</span></span><br><span class="line"><span class="string">#defineEPROTOTYPE91/* Protocol wrong type for socket */</span></span><br><span class="line"><span class="string">#defineENOPROTOOPT92/* Protocol not available */</span></span><br><span class="line"><span class="string">#defineEPROTONOSUPPORT93/* Protocol not supported */</span></span><br><span class="line"><span class="string">#defineESOCKTNOSUPPORT94/* Socket type not supported */</span></span><br><span class="line"><span class="string">#defineEOPNOTSUPP95/* Operation not supported on transport endpoint */</span></span><br><span class="line"><span class="string">#defineEPFNOSUPPORT96/* Protocol family not supported */</span></span><br><span class="line"><span class="string">#defineEAFNOSUPPORT97/* Address family not supported by protocol */</span></span><br><span class="line"><span class="string">#defineEADDRINUSE98/* Address already in use */</span></span><br><span class="line"><span class="string">#defineEADDRNOTAVAIL99/* Cannot assign requested address */</span></span><br><span class="line"><span class="string">#defineENETDOWN100/* Network is down */</span></span><br><span class="line"><span class="string">#defineENETUNREACH101/* Network is unreachable */</span></span><br><span class="line"><span class="string">#defineENETRESET102/* Network dropped connection because of reset */</span></span><br><span class="line"><span class="string">#defineECONNABORTED103/* Software caused connection abort */</span></span><br><span class="line"><span class="string">#defineECONNRESET104/* Connection reset by peer */</span></span><br><span class="line"><span class="string">#defineENOBUFS105/* No buffer space available */</span></span><br><span class="line"><span class="string">#defineEISCONN106/* Transport endpoint is already connected */</span></span><br><span class="line"><span class="string">#defineENOTCONN107/* Transport endpoint is not connected */</span></span><br><span class="line"><span class="string">#defineESHUTDOWN108/* Cannot send after transport endpoint shutdown */</span></span><br><span class="line"><span class="string">#defineETOOMANYREFS109/* Too many references: cannot splice */</span></span><br><span class="line"><span class="string">#defineETIMEDOUT110/* Connection timed out */</span></span><br><span class="line"><span class="string">#defineECONNREFUSED111/* Connection refused */</span></span><br><span class="line"><span class="string">#defineEHOSTDOWN112/* Host is down */</span></span><br><span class="line"><span class="string">#defineEHOSTUNREACH113/* No route to host */</span></span><br><span class="line"><span class="string">#defineEALREADY114/* Operation already in progress */</span></span><br><span class="line"><span class="string">#defineEINPROGRESS115/* Operation now in progress */</span></span><br><span class="line"><span class="string">#defineESTALE116/* Stale file handle */</span></span><br><span class="line"><span class="string">#defineEUCLEAN117/* Structure needs cleaning */</span></span><br><span class="line"><span class="string">#defineENOTNAM118/* Not a XENIX named type file */</span></span><br><span class="line"><span class="string">#defineENAVAIL119/* No XENIX semaphores available */</span></span><br><span class="line"><span class="string">#defineEISNAM120/* Is a named type file */</span></span><br><span class="line"><span class="string">#defineEREMOTEIO121/* Remote I/O error */</span></span><br><span class="line"><span class="string">#defineEDQUOT122/* Quota exceeded */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#defineENOMEDIUM123/* No medium found */</span></span><br><span class="line"><span class="string">#defineEMEDIUMTYPE124/* Wrong medium type */</span></span><br><span class="line"><span class="string">#defineECANCELED125/* Operation Canceled */</span></span><br><span class="line"><span class="string">#defineENOKEY126/* Required key not available */</span></span><br><span class="line"><span class="string">#defineEKEYEXPIRED127/* Key has expired */</span></span><br><span class="line"><span class="string">#defineEKEYREVOKED128/* Key has been revoked */</span></span><br><span class="line"><span class="string">#defineEKEYREJECTED129/* Key was rejected by service */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* for robust mutexes */</span></span><br><span class="line"><span class="string">#defineEOWNERDEAD130/* Owner died */</span></span><br><span class="line"><span class="string">#defineENOTRECOVERABLE131/* State not recoverable */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define ERFKILL132/* Operation not possible due to RF-kill */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define EHWPOISON133/* Memory page has hardware error */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1.   Reserve an RPC call slot</span></span><br><span class="line"><span class="string">static void call_reserve(struct rpc_task *task)</span></span><br><span class="line"><span class="string">1b.  Grok the result of xprt_reserve() ,what is xprt_reserve() ? net/sunrpc/xprt.c: * xprt_reserve - allocate an RPC request slot</span></span><br><span class="line"><span class="string">     void xprt_reserve(struct rpc_task *task)</span></span><br><span class="line"><span class="string">static void call_reserveresult(struct rpc_task *task)</span></span><br><span class="line"><span class="string">1c.  Retry reserving an RPC call slot</span></span><br><span class="line"><span class="string">static void call_retry_reserve(struct rpc_task *task)</span></span><br><span class="line"><span class="string">2.   Bind and/or refresh the credentials</span></span><br><span class="line"><span class="string">   static void call_refresh(struct rpc_task *task)</span></span><br><span class="line"><span class="string">2a.  Process the results of a credential refresh</span></span><br><span class="line"><span class="string">   static void call_refreshresult(struct rpc_task *task)</span></span><br><span class="line"><span class="string">2b.  Allocate the buffer. For details, see sched.c:rpc_malloc. (Note: buffer memory is freed in xprt_release).</span></span><br><span class="line"><span class="string">   static void call_allocate(struct rpc_task *task)</span></span><br><span class="line"><span class="string">3.   Encode arguments of an RPC call</span></span><br><span class="line"><span class="string">        static void rpc_xdr_encode(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4.   Get the server port number if not yet set</span></span><br><span class="line"><span class="string">            static void call_bind(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4a.  Sort out bind result</span></span><br><span class="line"><span class="string">            static void call_bind_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4b.  Connect to the RPC server</span></span><br><span class="line"><span class="string">            static void call_connect(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4c.  Sort out connect result</span></span><br><span class="line"><span class="string">            static void call_connect_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">5.   Transmit the RPC request, and wait for reply</span></span><br><span class="line"><span class="string">                static void call_transmit(struct rpc_task *task)</span></span><br><span class="line"><span class="string">5a.  Handle cleanup after a transmission</span></span><br><span class="line"><span class="string">                static void call_transmit_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">5b.  Send the backchannel RPC reply.  On error, drop the reply.  In addition, disconnect on connectivity errors.</span></span><br><span class="line"><span class="string">                static void call_bc_transmit(struct rpc_task *task)</span></span><br><span class="line"><span class="string">6.   Sort out the RPC call status</span></span><br><span class="line"><span class="string">                    static void call_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">6a.  Handle RPC timeout, We do not release the request slot, so we keep using the</span></span><br><span class="line"><span class="string">     same XID for all retransmits.</span></span><br><span class="line"><span class="string">                    static void call_timeout(struct rpc_task *task)</span></span><br><span class="line"><span class="string">7.   Decode the RPC reply</span></span><br><span class="line"><span class="string">                        static void call_decode(struct rpc_task *task)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   - rpc_async_schedule                                                                                                                       ▒</span></span><br><span class="line"><span class="string">      - 91.95% __rpc_execute                                                                                                                  ▒</span></span><br><span class="line"><span class="string">         - 83.19% call_transmit                                                                                                               ◆</span></span><br><span class="line"><span class="string">            - 41.82% xprt_transmit                                                                                                            ▒</span></span><br><span class="line"><span class="string">               - 35.74% xs_tcp_send_request                                                                                                   ▒</span></span><br><span class="line"><span class="string">                  - 32.08% xs_sendpages                                                                                                       ▒</span></span><br><span class="line"><span class="string">                     - 29.48% xs_send_kvec                                                                                                    ▒</span></span><br><span class="line"><span class="string">                        - 26.45% kernel_sendmsg                                                                                               ▒</span></span><br><span class="line"><span class="string">                           - 24.08% sock_sendmsg                                                                                              ▒</span></span><br><span class="line"><span class="string">                              - 16.47% inet_sendmsg                                                                                           ▒</span></span><br><span class="line"><span class="string">                                 - 14.92% tcp_sendmsg                                                                                         ▒</span></span><br><span class="line"><span class="string">                                      4.27% _raw_spin_lock_bh                                                                                 ▒</span></span><br><span class="line"><span class="string">                                    - 3.51% release_sock                                                                                      ▒</span></span><br><span class="line"><span class="string">                                       - 1.64% _raw_spin_unlock_bh                                                                            ▒</span></span><br><span class="line"><span class="string">                                            __local_bh_enable_ip                                                                              ▒</span></span><br><span class="line"><span class="string">                                    - 2.14% lock_sock_nested                                                                                  ▒</span></span><br><span class="line"><span class="string">                                       - 1.71% local_bh_enable                                                                                ▒</span></span><br><span class="line"><span class="string">                                            1.60% __local_bh_enable_ip</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h4 id="cp-stack-interrupt-by-nfs"><a href="#cp-stack-interrupt-by-nfs" class="headerlink" title="cp stack interrupt by nfs"></a>cp stack interrupt by nfs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[&lt;ffffffff8adbd691&gt;] wait_on_page_bit+0x81/0xa0</span><br><span class="line">[&lt;ffffffff8adbd7c1&gt;] __filemap_fdatawait_range+0x111/0x190</span><br><span class="line">[&lt;ffffffff8adbd854&gt;] filemap_fdatawait_range+0x14/0x30</span><br><span class="line">[&lt;ffffffff8adbfd36&gt;] filemap_write_and_wait_range+0x56/0x90</span><br><span class="line">[&lt;ffffffffc0717756&gt;] nfs_file_fsync+0x86/0x110 [nfs]</span><br><span class="line">[&lt;ffffffff8ae82cfe&gt;] vfs_fsync+0x2e/0x40</span><br><span class="line">[&lt;ffffffffc0717b96&gt;] nfs_file_flush+0x46/0x60 [nfs]</span><br><span class="line">[&lt;ffffffff8ae4a637&gt;] filp_close+0x37/0x90</span><br><span class="line">[&lt;ffffffff8ae6e2e8&gt;] put_files_struct+0x88/0xe0</span><br><span class="line">[&lt;ffffffff8ae6e3e9&gt;] exit_files+0x49/0x50</span><br><span class="line">[&lt;ffffffff8aca23e2&gt;] do_exit+0x2b2/0xa20</span><br><span class="line">[&lt;ffffffff8aca2bcf&gt;] do_group_exit+0x3f/0xa0</span><br><span class="line">[&lt;ffffffff8acb3aee&gt;] get_signal_to_deliver+0x1ce/0x5e0</span><br><span class="line">[&lt;ffffffff8ac2c527&gt;] do_signal+0x57/0x6f0</span><br><span class="line">[&lt;ffffffff8ac2cc32&gt;] do_notify_resume+0x72/0xc0</span><br><span class="line">[&lt;ffffffff8b39322f&gt;] int_signal+0x12/0x17</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</span><br></pre></td></tr></table></figure><h3 id="Fault-injection"><a href="#Fault-injection" class="headerlink" title="Fault-injection"></a>Fault-injection</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./failcmd.sh --<span class="built_in">times</span>=-1 --interval=1 --verbose=2</span><br><span class="line">failslab is not available</span><br></pre></td></tr></table></figure><h4 id="debug-example1"><a href="#debug-example1" class="headerlink" title="debug example1"></a>debug example1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">[Fri Jan 15 20:25:37 2021] ------------[ cut here ]------------</span><br><span class="line">[Fri Jan 15 20:25:37 2021] WARNING: CPU: 68 PID: 111577 at kernel/irq/manage.c:1452 free_irq+0x6a/0x90</span><br><span class="line">[Fri Jan 15 20:25:37 2021] Modules linked <span class="keyword">in</span>: netlink_diag mgc(OE) lustre(OE) lmv(OE) mdc(OE) fid(OE) osc(OE) lov(OE) fld(OE) ksocklnd(OE) ptlrpc(OE) obdclass(OE) lnet(OE) libcfs(OE) nfsv3 nfs_acl nfs lockd grace fscache pktgen ib_isert iscsi_target_mod ib_srpt bonding target_core_mod ib_srp scsi_transport_srp scsi_tgt ib_ipoib ib_umad mpt2sas raid_class mptctl mptbase rpcrdma rdma_ucm ib_uverbs ib_iser rdma_cm iw_cm ib_cm libiscsi scsi_transport_iscsi dell_rbu ses enclosure scsi_transport_sas amd64_edac_mod edac_mce_amd kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr dcdbas vfat fat joydev cdc_ether usbnet mii sg qedr ib_core megaraid_sas i2c_piix4 k10temp ipmi_si ipmi_devintf ipmi_msghandler pinctrl_amd i2c_designware_platform i2c_designware_core acpi_cpufreq</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  binfmt_misc auth_rpcgss sunrpc ip_tables ext4 mbcache jbd2 sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea crct10dif_pclmul crct10dif_common sysfillrect crc32c_intel qede ptp sysimgblt fb_sys_fops ttm pps_core ahci drm libahci qed libata drm_panel_orientation_quirks crc8 nfit libnvdimm [last unloaded: libcfs]</span><br><span class="line">[Fri Jan 15 20:25:37 2021] CPU: 68 PID: 111577 Comm: ifconfig Kdump: loaded Tainted: G        W  OE  ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Fri Jan 15 20:25:37 2021] Hardware name: Lenovo ThinkSystem SR665/7D2VCTO1WW, BIOS D8E110J-1.20 11/09/2020</span><br><span class="line">[Fri Jan 15 20:25:37 2021] Call Trace:</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b7ff85&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9149bd18&gt;] __warn+0xd8/0x100</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9149be5d&gt;] warn_slowpath_null+0x1d/0x20</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9155109a&gt;] free_irq+0x6a/0x90</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022b706&gt;] qede_sync_free_irqs+0x66/0xc0 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022eb06&gt;] qede_load+0x8a6/0x1150 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b8db6f&gt;] ? notifier_call_chain+0x4f/0x70</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022f6fe&gt;] qede_open+0x3e/0xb0 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a581b2&gt;] __dev_open+0xd2/0x150</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a584e3&gt;] __dev_change_flags+0xa3/0x180</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a585e9&gt;] dev_change_flags+0x29/0x60</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91ada523&gt;] devinet_ioctl+0x6e3/0x7e0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91adb645&gt;] inet_ioctl+0x75/0xa0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a3149b&gt;] sock_do_ioctl+0x2b/0x60</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a316bb&gt;] sock_ioctl+0x1eb/0x2d0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91662810&gt;] do_vfs_ioctl+0x3a0/0x5b0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b8d678&gt;] ? __do_page_fault+0x238/0x500</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91662ac1&gt;] SyS_ioctl+0xa1/0xc0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b92ed2&gt;] system_call_fastpath+0x25/0x2a</span><br><span class="line">[Fri Jan 15 20:25:37 2021] ---[ end trace 6abd3d242706b4fe ]---</span><br><span class="line"></span><br><span class="line">(gdb) list *free_irq+0x6a/0x90</span><br><span class="line">0xffffffff81151030 is <span class="keyword">in</span> free_irq (kernel/irq/manage.c:1443).</span><br><span class="line">1438 *This <span class="keyword">function</span> must not be called from interrupt context.</span><br><span class="line">1439 *</span><br><span class="line">1440 *Returns the devname argument passed to request_irq.</span><br><span class="line">1441 */</span><br><span class="line">1442const void *free_irq(unsigned int irq, void *dev_id)</span><br><span class="line">1443&#123;</span><br><span class="line">1444struct irq_desc *desc = irq_to_desc(irq);</span><br><span class="line">1445struct irqaction *action;</span><br><span class="line">1446const char *devname;</span><br><span class="line">1447</span><br><span class="line">1448<span class="keyword">if</span> (!desc || WARN_ON(irq_settings_is_per_cpu_devid(desc)))</span><br><span class="line">1449<span class="built_in">return</span> NULL;</span><br><span class="line">1450</span><br><span class="line">1451<span class="comment">#ifdef CONFIG_SMP</span></span><br><span class="line">1452<span class="keyword">if</span> (WARN_ON(desc-&gt;affinity_notify))</span><br><span class="line">1453desc-&gt;affinity_notify = NULL;</span><br><span class="line">1454<span class="comment">#endif</span></span><br><span class="line">1455</span><br><span class="line">1456action = __free_irq(irq, dev_id);</span><br><span class="line">1457devname = action-&gt;name;</span><br><span class="line"></span><br><span class="line">crash&gt; struct irqaction</span><br><span class="line">struct irqaction &#123;</span><br><span class="line">    irq_handler_t handler;</span><br><span class="line">    void *dev_id;</span><br><span class="line">    void *percpu_dev_id;</span><br><span class="line">    struct irqaction *next;</span><br><span class="line">    irq_handler_t thread_fn;</span><br><span class="line">    struct task_struct *thread;</span><br><span class="line">    unsigned int irq;</span><br><span class="line">    unsigned int flags;</span><br><span class="line">    unsigned long thread_flags;</span><br><span class="line">    unsigned long thread_mask;</span><br><span class="line">    const char *name;</span><br><span class="line">    struct proc_dir_entry *dir;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 128</span><br><span class="line"></span><br><span class="line">$ cat test.bt</span><br><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;linux/interrupt.h&gt;</span></span><br><span class="line">kretprobe:free_irq &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pid: %d , cmd: %s, returned: %d\n&quot;</span>,pid, comm, retval);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:__free_irq &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pid: %d , cmd: %s, returned: %s\n&quot;</span>,pid, comm, str(((struct irqaction *)retval)-&gt;name) );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## show the device name</span></span><br><span class="line"></span><br><span class="line">$ ./test.bt</span><br><span class="line">Attaching 2 probes...</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-0</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511010040</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-1</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511009752</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-2</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511009464</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-3</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511009176</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-4</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008888</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-5</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008600</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-6</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008312</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-7</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008024</span><br><span class="line"><span class="comment">## show the info when I restart network ,Got it</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## up failed</span></span><br><span class="line">$ systemctl restart network</span><br><span class="line">Job <span class="keyword">for</span> network.service failed because the control process exited with error code. See <span class="string">&quot;systemctl status network.service&quot;</span> and <span class="string">&quot;journalctl -xe&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line"><span class="comment">## try to up the device</span></span><br><span class="line">$ ifconfig enp129s0f1 up</span><br><span class="line">SIOCSIFFLAGS: Device or resource busy</span><br><span class="line"></span><br><span class="line">$ ls -1  /sys/class/net/</span><br><span class="line">bond0</span><br><span class="line">bonding_masters</span><br><span class="line">enp129s0f0</span><br><span class="line">enp129s0f1</span><br><span class="line">enp35s0f3u1u6</span><br><span class="line">ens9f0</span><br><span class="line">ens9f1</span><br><span class="line">lo</span><br></pre></td></tr></table></figure><h5 id="debug-example1-1"><a href="#debug-example1-1" class="headerlink" title="debug example1-1"></a>debug example1-1</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">struct tcp_info &#123;</span><br><span class="line">    __u8 tcpi_state;</span><br><span class="line">    __u8 tcpi_ca_state;</span><br><span class="line">    __u8 tcpi_retransmits;</span><br><span class="line">    __u8 tcpi_probes;</span><br><span class="line">    __u8 tcpi_backoff;</span><br><span class="line">    __u8 tcpi_options;</span><br><span class="line">    __u8 tcpi_snd_wscale : 4;</span><br><span class="line">    __u8 tcpi_rcv_wscale : 4;</span><br><span class="line">    __u32 tcpi_rto;</span><br><span class="line">    __u32 tcpi_ato;</span><br><span class="line">    __u32 tcpi_snd_mss;</span><br><span class="line">    __u32 tcpi_rcv_mss;</span><br><span class="line">    __u32 tcpi_unacked;</span><br><span class="line">    __u32 tcpi_sacked;</span><br><span class="line">    __u32 tcpi_lost;</span><br><span class="line">    __u32 tcpi_retrans;</span><br><span class="line">    __u32 tcpi_fackets;</span><br><span class="line">    __u32 tcpi_last_data_sent;</span><br><span class="line">    __u32 tcpi_last_ack_sent;</span><br><span class="line">    __u32 tcpi_last_data_recv;</span><br><span class="line">    __u32 tcpi_last_ack_recv;</span><br><span class="line">    __u32 tcpi_pmtu;</span><br><span class="line">    __u32 tcpi_rcv_ssthresh;</span><br><span class="line">    __u32 tcpi_rtt;</span><br><span class="line">    __u32 tcpi_rttvar;</span><br><span class="line">    __u32 tcpi_snd_ssthresh;</span><br><span class="line">    __u32 tcpi_snd_cwnd;</span><br><span class="line">    __u32 tcpi_advmss;</span><br><span class="line">    __u32 tcpi_reordering;</span><br><span class="line">    __u32 tcpi_rcv_rtt;</span><br><span class="line">    __u32 tcpi_rcv_space;</span><br><span class="line">    __u32 tcpi_total_retrans;</span><br><span class="line">    __u64 tcpi_pacing_rate;</span><br><span class="line">    __u64 tcpi_max_pacing_rate;</span><br><span class="line">    __u64 tcpi_bytes_acked;</span><br><span class="line">    __u64 tcpi_bytes_received;</span><br><span class="line">    __u32 tcpi_segs_out;</span><br><span class="line">    __u32 tcpi_segs_in;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crash&gt; struct irqaction</span><br><span class="line">struct irqaction &#123;</span><br><span class="line">    irq_handler_t handler;</span><br><span class="line">    void *dev_id;</span><br><span class="line">    void *percpu_dev_id;</span><br><span class="line">    struct irqaction *next;</span><br><span class="line">    irq_handler_t thread_fn;</span><br><span class="line">    struct task_struct *thread;</span><br><span class="line">    unsigned int irq;</span><br><span class="line">    unsigned int flags;</span><br><span class="line">    unsigned long thread_flags;</span><br><span class="line">    unsigned long thread_mask;</span><br><span class="line">    const char *name;</span><br><span class="line">    struct proc_dir_entry *dir;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 128</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct irqaction *)0)-&gt;name</span><br><span class="line"><span class="variable">$1</span> = 72</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span>  &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myprobe __free_irq +72($retval):string&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ cat /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">r:kprobes/myprobe __free_irq arg1=+72(<span class="variable">$retval</span>):string</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line">$ <span class="built_in">echo</span> &gt; /sys/kernel/debug/tracing/trace</span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line">name: myprobe</span><br><span class="line">ID: 1685</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:unsigned long __probe_func;       offset:8;       size:8; signed:0;</span><br><span class="line">        field:unsigned long __probe_ret_ip;     offset:16;      size:8; signed:0;</span><br><span class="line">        field:u64 arg1; offset:24;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> fmt: <span class="string">&quot;(%lx &lt;- %lx) arg1=0x%Lx&quot;</span>, REC-&gt;__probe_func, REC-&gt;__probe_ret_ip, REC-&gt;arg1</span><br><span class="line"></span><br><span class="line">$ ifconfig em3 down ; ifconfig em3 up</span><br><span class="line">$ cat /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 9/9   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">        ifconfig-25429 [009] d... 539865.798024: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;&quot;</span></span><br><span class="line">        ifconfig-25429 [009] d... 539865.798027: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;/4���&quot;</span></span><br><span class="line">        ifconfig-25429 [009] d... 539865.798030: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;X/4����b&quot;</span><span class="string">&#x27;���&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798032: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;�/4����b&quot;&#x27;</span>���<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798034: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span>/4���<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798036: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span></span><br><span class="line">                                                                                                   /4�����W/���<span class="string">&quot;</span></span><br><span class="line"><span class="string">/4�����W/���&quot;</span>fig-25429 [009] d... 539865.798039: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;X</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798041: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span>�/4���@�W/���<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798043: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span>�/4���<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># return free_irq(const char *devname; return devname;) better than __free_irq</span></span><br><span class="line"><span class="string">$ echo &#x27;r:myprobe free_irq +0(<span class="variable">$retval</span>):string&#x27; &gt; /sys/kernel/debug/tracing/kprobe_events</span></span><br><span class="line"><span class="string">$ echo 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span></span><br><span class="line"><span class="string">$ echo &gt; /sys/kernel/debug/tracing/trace</span></span><br><span class="line"><span class="string">$ ifconfig em3 down; ifconfig em3 up</span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/trace</span></span><br><span class="line"><span class="string"># tracer: nop</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># entries-in-buffer/entries-written: 9/9   #P:24</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="string">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="string">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="string">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="string">#                            ||| /     delay</span></span><br><span class="line"><span class="string">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="string">#              | |       |   ||||       |         |</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481195: myprobe: (bnx2x_free_msix_irqs.part.68+0xdd/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481197: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-0<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481199: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-1<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481202: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-2<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481204: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-3<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481206: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-4<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481208: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-5<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481210: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-6<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481212: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-7<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### if I don &#x27;t convert to string</span></span><br><span class="line"><span class="string"># tracer: nop</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># entries-in-buffer/entries-written: 9/9   #P:24</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="string">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="string">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="string">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="string">#                            ||| /     delay</span></span><br><span class="line"><span class="string">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="string">#              | |       |   ||||       |         |</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630316: myprobe: (bnx2x_free_msix_irqs.part.68+0xdd/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342d4000</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630321: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0218</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630324: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0458</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630327: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0698</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630330: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f08d8</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630333: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0b18</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630335: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0d58</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630338: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0f98</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630341: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f11d8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### ??? the question, How could I print the name from the hex addr ?</span></span><br><span class="line"><span class="string">crash&gt; kmem 0xffff9717342d4000</span></span><br><span class="line"><span class="string">      PAGE         PHYSICAL      MAPPING       INDEX CNT FLAGS</span></span><br><span class="line"><span class="string">ffffd92440d0b500 10342d4000                0        0  1 2fffff00004000 head</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">crash&gt; struct irqaction 0xffff9717342d4000</span></span><br><span class="line"><span class="string">struct irqaction &#123;</span></span><br><span class="line"><span class="string">  handler = 0x336d65,</span></span><br><span class="line"><span class="string">  dev_id = 0x0,</span></span><br><span class="line"><span class="string">  percpu_dev_id = 0x0,</span></span><br><span class="line"><span class="string">  next = 0xffff9717389a8010,</span></span><br><span class="line"><span class="string">  thread_fn = 0x0,</span></span><br><span class="line"><span class="string">  thread = 0x937fffff,</span></span><br><span class="line"><span class="string">  irq = 2466250752,</span></span><br><span class="line"><span class="string">  flags = 0,</span></span><br><span class="line"><span class="string">  thread_flags = 2466250752,</span></span><br><span class="line"><span class="string">  thread_mask = 100,</span></span><br><span class="line"><span class="string">  name = 0x3 &lt;Address 0x3 out of bounds&gt;,</span></span><br><span class="line"><span class="string">  dir = 0xffff971734360050</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="The-stack-work-flow"><a href="#The-stack-work-flow" class="headerlink" title="The stack work flow"></a>The stack work flow</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#6 [ffff885e484afcf0] vfs_open at ffffffff811dc250</span></span><br><span class="line"> <span class="comment">#7 [ffff885e484afd00] do_last at ffffffff811eb81d</span></span><br><span class="line"> <span class="comment">#8 [ffff885e484afdb0] path_openat at ffffffff811ee582</span></span><br><span class="line"> <span class="comment">#9 [ffff885e484afe48] do_filp_open at ffffffff811efd4b</span></span><br><span class="line"><span class="comment">#10 [ffff885e484aff18] do_sys_open at ffffffff811dd6f3</span></span><br><span class="line"><span class="comment">#11 [ffff885e484aff70] sys_open at ffffffff811dd80e  </span></span><br><span class="line"></span><br><span class="line">means</span><br><span class="line"></span><br><span class="line">sys_open</span><br><span class="line">  do_sys_open</span><br><span class="line">    do_filp_open</span><br><span class="line">      path_openat</span><br><span class="line">        do_last</span><br><span class="line">          vfs_open</span><br></pre></td></tr></table></figure><h3 id="show-pr-debug-the-small-write-amplification-with-linux-soft-raid5"><a href="#show-pr-debug-the-small-write-amplification-with-linux-soft-raid5" class="headerlink" title="show pr_debug, the small write amplification with linux soft raid5"></a>show pr_debug, the small write amplification with linux soft raid5</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Ei &#x27;CONFIG_DEBUG_FS|CONFIG_DYNAMIC_DEBUG&#x27; /boot/config-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DYNAMIC_DEBUG=y</span><br><span class="line"></span><br><span class="line">$ cat /proc/mdstat</span><br><span class="line">Personalities : [raid6] [raid5] [raid4]</span><br><span class="line">md127 : active raid5 nvme0n1p3[<span class="number">3</span>] nvme0n1p1[<span class="number">0</span>] nvme0n1p2[<span class="number">1</span>]</span><br><span class="line">      <span class="number">390344704</span> blocks super <span class="number">1.2</span> level <span class="number">5</span>, <span class="number">32</span>k chunk, algorithm <span class="number">2</span> [<span class="number">3</span>/<span class="number">3</span>] [UUU]</span><br><span class="line"></span><br><span class="line">unused devices: &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ cat fio.cfg</span><br><span class="line">[global]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=sync</span><br><span class="line">size=<span class="number">8</span>G</span><br><span class="line">numjobs=<span class="number">32</span></span><br><span class="line">group_reporting</span><br><span class="line">exitall</span><br><span class="line">time_based</span><br><span class="line">runtime=<span class="number">3600</span></span><br><span class="line">direct=<span class="number">1</span></span><br><span class="line">bssplit=<span class="number">8</span>K/<span class="number">100</span></span><br><span class="line">[rw]</span><br><span class="line">directory=/mnt</span><br><span class="line"></span><br><span class="line">                                                       ------------why read ?</span><br><span class="line">                                                       |</span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle|</span><br><span class="line">           <span class="number">0.36</span>    <span class="number">0.00</span>    <span class="number">4.42</span>   <span class="number">73.21</span>    <span class="number">0.00</span>   <span class="number">22.02</span>|</span><br><span class="line">                                                       |</span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">nvme0n1       <span class="number">47036.00</span>     <span class="number">0.00</span> <span class="number">47051.00</span> <span class="number">188169.00</span>   <span class="number">367.54</span>   <span class="number">735.04</span>     <span class="number">9.60</span>    <span class="number">39.26</span>    <span class="number">0.17</span>    <span class="number">0.55</span>    <span class="number">0.07</span>   <span class="number">0.00</span>  <span class="number">99.95</span></span><br><span class="line">nvme0n1p1     <span class="number">15598.00</span>     <span class="number">0.00</span> <span class="number">15602.50</span> <span class="number">62886.50</span>   <span class="number">121.88</span>   <span class="number">245.65</span>     <span class="number">9.59</span>    <span class="number">13.31</span>    <span class="number">0.17</span>    <span class="number">0.55</span>    <span class="number">0.08</span>   <span class="number">0.01</span> <span class="number">100.00</span></span><br><span class="line">nvme0n1p2     <span class="number">15752.50</span>     <span class="number">0.00</span> <span class="number">15755.00</span> <span class="number">62576.00</span>   <span class="number">123.08</span>   <span class="number">244.44</span>     <span class="number">9.61</span>    <span class="number">13.19</span>    <span class="number">0.17</span>    <span class="number">0.54</span>    <span class="number">0.08</span>   <span class="number">0.01</span> <span class="number">100.00</span></span><br><span class="line">nvme0n1p3     <span class="number">15685.50</span>     <span class="number">0.00</span> <span class="number">15691.50</span> <span class="number">62705.50</span>   <span class="number">122.57</span>   <span class="number">244.94</span>     <span class="number">9.60</span>    <span class="number">12.95</span>    <span class="number">0.17</span>    <span class="number">0.55</span>    <span class="number">0.07</span>   <span class="number">0.01</span> <span class="number">100.00</span></span><br><span class="line"></span><br><span class="line">$ bpftrace -e &#x27;kprobe:md* &#123;&#123;@[probe] = count()&#125; &#125;&#x27;</span><br><span class="line">@[kprobe:md_write_start]: <span class="number">425895</span></span><br><span class="line">@[kprobe:md_make_request]: <span class="number">430225</span></span><br><span class="line">@[kprobe:md_handle_request]: <span class="number">430950</span></span><br><span class="line">@[kprobe:md_write_inc]: <span class="number">851009</span></span><br><span class="line">@[kprobe:md_mergeable_bvec]: <span class="number">859830</span></span><br><span class="line">@[kprobe:md_write_end]: <span class="number">1278241</span></span><br><span class="line">@[kprobe:md_check_recovery]: <span class="number">1758916</span></span><br><span class="line">@[kprobe:md_wakeup_thread]: <span class="number">4295662</span></span><br><span class="line"></span><br><span class="line">Got the high latency by ftrace</span><br><span class="line">  <span class="number">12</span>)               |      handle_stripe [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |        analyse_stripe [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.022</span> us    |          r5l_log_disk_error [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.390</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |        r5c_finish_stripe_write_out [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.020</span> us    |        r5c_is_writeback [raid456]();</span><br><span class="line">  <span class="number">12</span>)               |        handle_stripe_dirtying [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |          schedule_reconstruction [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.147</span> us    |            r5c_release_extra_page [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.437</span> us    |          &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.739</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>)               |        raid_run_ops [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.022</span> us    |          _raw_spin_lock_irq();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.020</span> us    |          r5c_is_writeback [raid456]();</span><br><span class="line">  <span class="number">12</span>)               |          async_copy_data.isra<span class="number">.47</span> [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |            async_memcpy [async_memcpy]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |              __async_tx_find_channel [async_tx]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.022</span> us    |                dma_find_channel();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.260</span> us    |              &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |              async_tx_quiesce [async_tx]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |              dmaengine_unmap_put();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">1.790</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">2.071</span> us    |          &#125;</span><br><span class="line">  <span class="number">12</span>)               |          async_xor [async_xor]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |            __async_tx_find_channel [async_tx]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.023</span> us    |              dma_find_channel();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.262</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |            async_tx_quiesce [async_tx]();</span><br><span class="line">  <span class="number">12</span>)               |            xor_blocks [<span class="keyword">xor</span>]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |              xor_avx_3 [<span class="keyword">xor</span>]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |                irq_fpu_usable();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.039</span> us    |                __kernel_fpu_begin();</span><br><span class="line">  <span class="number">12</span>)               |                __kernel_fpu_end() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.057</span> us    |                  math_state_restore();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.291</span> us    |                &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">1.882</span> us    |              &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">2.137</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)               |            ops_complete_reconstruct [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.031</span> us    |              raid5_release_stripe [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.323</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">4.343</span> us    |          &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">7.464</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>)               |        ops_run_io [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.023</span> us    |          _cond_resched();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.329</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.398</span> us   |      &#125;</span><br><span class="line"></span><br><span class="line">## it &#x27;s nvme dev, handle_stripe has the highest latency except some system default calls</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.330</span> us   |      &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.340</span> us   |      &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">9.921</span> us    |      &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.057</span> us   |      &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.239</span> us   |      &#125;</span><br><span class="line"></span><br><span class="line">$ echo <span class="number">8</span> <span class="number">4</span> <span class="number">1</span> <span class="number">7</span> &gt; /proc/sys/kernel/printk</span><br><span class="line">$ echo -n <span class="string">&quot;file raid5.c +p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">$ echo -n <span class="string">&quot;file raid5.c +pmflt&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">$ dmesg | grep <span class="string">&quot;Read_old block&quot;</span> -B <span class="number">4</span> -A <span class="number">4</span> </span><br><span class="line"></span><br><span class="line">##<span class="meta"># disable</span></span><br><span class="line">$ echo -n &#x27;file raid5.c -p&#x27; &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">$ echo -n <span class="string">&quot;file raid5.c -pmflt&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line"></span><br><span class="line">##<span class="meta"># single func</span></span><br><span class="line">$ echo <span class="string">&quot;func handle_stripe_dirtying +p&quot;</span> &gt;&gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">$ echo <span class="string">&quot;func handle_stripe_dirtying -p&quot;</span> &gt;&gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">[ <span class="number">6491.600465</span>] <span class="keyword">for</span> sector <span class="number">224878608</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6491.600939</span>] <span class="keyword">for</span> sector <span class="number">224878616</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6491.601260</span>] <span class="keyword">for</span> sector <span class="number">149425888</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6491.601584</span>] <span class="keyword">for</span> sector <span class="number">149425896</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6496.311915</span>] <span class="keyword">for</span> sector <span class="number">195169064</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.312323</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">6496.312671</span>] <span class="keyword">for</span> sector <span class="number">195169072</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.313044</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">6496.313381</span>] <span class="keyword">for</span> sector <span class="number">195169080</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.313719</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">6496.314060</span>] <span class="keyword">for</span> sector <span class="number">195169088</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.314416</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">[ <span class="number">1795.266077</span>] &lt;intr&gt; raid456:raid5_end_write_request:<span class="number">2636</span>: end_write_request <span class="number">123139960</span>/<span class="number">0</span>, count <span class="number">2</span>, uptodate: <span class="number">1.</span></span><br><span class="line">[ <span class="number">1795.266080</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">0</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">[ <span class="number">1795.266082</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4749</span>: locked=<span class="number">0</span> uptodate=<span class="number">0</span> to_read=<span class="number">0</span> to_write=<span class="number">1</span> failed=<span class="number">0</span> failed_num=<span class="number">-1</span>,<span class="number">-1</span></span><br><span class="line">[ <span class="number">1795.266084</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3919</span>: <span class="keyword">for</span> sector <span class="number">275011528</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">1795.266086</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3996</span>: Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">1795.266088</span>] [<span class="number">4448</span>] raid456:ops_run_io:<span class="number">1111</span>: ops_run_io: <span class="keyword">for</span> <span class="number">275011528</span> schedule op <span class="number">0</span> on disc <span class="number">2</span></span><br><span class="line">[ <span class="number">1795.266091</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4717</span>: handling stripe <span class="number">214788240</span>, state=<span class="number">0x2041</span> cnt=<span class="number">1</span>, pd_idx=<span class="number">0</span>, qd_idx=<span class="number">-1</span></span><br><span class="line">               , check:<span class="number">0</span>, reconstruct:<span class="number">5</span></span><br><span class="line">[ <span class="number">1795.266093</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">2</span>: state <span class="number">0x11</span> read           (null) write           (null) written           (null)</span><br><span class="line">--</span><br><span class="line">[ <span class="number">1795.266269</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">1</span>: state <span class="number">0x8</span> read           (null) write ffff928df71d5900 written           (null)</span><br><span class="line">[ <span class="number">1795.266271</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">0</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">[ <span class="number">1795.266273</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4749</span>: locked=<span class="number">0</span> uptodate=<span class="number">0</span> to_read=<span class="number">0</span> to_write=<span class="number">1</span> failed=<span class="number">0</span> failed_num=<span class="number">-1</span>,<span class="number">-1</span></span><br><span class="line">[ <span class="number">1795.266275</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3919</span>: <span class="keyword">for</span> sector <span class="number">72429152</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">1795.266277</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3996</span>: Read_old block <span class="number">0</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">1795.266279</span>] [<span class="number">4448</span>] raid456:ops_run_io:<span class="number">1111</span>: ops_run_io: <span class="keyword">for</span> <span class="number">72429152</span> schedule op <span class="number">0</span> on disc <span class="number">0</span></span><br><span class="line">[ <span class="number">1795.266283</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4717</span>: handling stripe <span class="number">72429160</span>, state=<span class="number">0x41</span> cnt=<span class="number">1</span>, pd_idx=<span class="number">2</span>, qd_idx=<span class="number">-1</span></span><br><span class="line">               , check:<span class="number">0</span>, reconstruct:<span class="number">0</span></span><br><span class="line">[ <span class="number">1795.266285</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">2</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">--</span><br><span class="line">[ <span class="number">1795.266291</span>] &lt;intr&gt; raid456:raid5_end_write_request:<span class="number">2636</span>: end_write_request <span class="number">224927640</span>/<span class="number">0</span>, count <span class="number">1</span>, uptodate: <span class="number">1.</span></span><br><span class="line">[ <span class="number">1795.266293</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">0</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">[ <span class="number">1795.266296</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4749</span>: locked=<span class="number">0</span> uptodate=<span class="number">0</span> to_read=<span class="number">0</span> to_write=<span class="number">1</span> failed=<span class="number">0</span> failed_num=<span class="number">-1</span>,<span class="number">-1</span></span><br><span class="line">[ <span class="number">1795.266298</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3919</span>: <span class="keyword">for</span> sector <span class="number">72429160</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">1795.266300</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3996</span>: Read_old block <span class="number">0</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">1795.266302</span>] [<span class="number">4448</span>] raid456:ops_run_io:<span class="number">1111</span>: ops_run_io: <span class="keyword">for</span> <span class="number">72429160</span> schedule op <span class="number">0</span> on disc <span class="number">0</span></span><br><span class="line">[ <span class="number">1795.266305</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4717</span>: handling stripe <span class="number">104667968</span>, state=<span class="number">0x2041</span> cnt=<span class="number">1</span>, pd_idx=<span class="number">0</span>, qd_idx=<span class="number">-1</span></span><br><span class="line">               , check:<span class="number">0</span>, reconstruct:<span class="number">5</span></span><br><span class="line">[ <span class="number">1795.266307</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">2</span>: state <span class="number">0x11</span> read           (null) write           (null) written           (null)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/drivers/md/raid5.c</span><br><span class="line">        <span class="comment">//raid456:handle_stripe_dirtying:3919: for sector 72429160 state 0x41, rmw=2 rcw=1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((rcw &lt; rmw || (rcw == rmw &amp;&amp; conf-&gt;rmw_level != PARITY_PREFER_RMW)) &amp;&amp; rcw &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* want reconstruct write, but need to get some data */</span></span><br><span class="line">                <span class="keyword">int</span> qread =<span class="number">0</span>;</span><br><span class="line">                rcw = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (i = disks; i--; ) &#123;</span><br><span class="line">                        <span class="class"><span class="keyword">struct</span> <span class="title">r5dev</span> *<span class="title">dev</span> = &amp;<span class="title">sh</span>-&gt;<span class="title">dev</span>[<span class="title">i</span>];</span></span><br><span class="line">                        <span class="keyword">if</span> (!test_bit(R5_OVERWRITE, &amp;dev-&gt;flags) &amp;&amp;</span><br><span class="line">                            i != sh-&gt;pd_idx &amp;&amp; i != sh-&gt;qd_idx &amp;&amp;</span><br><span class="line">                            !test_bit(R5_LOCKED, &amp;dev-&gt;flags) &amp;&amp;</span><br><span class="line">                            !(test_bit(R5_UPTODATE, &amp;dev-&gt;flags) ||</span><br><span class="line">                              test_bit(R5_Wantcompute, &amp;dev-&gt;flags))) &#123;</span><br><span class="line">                                rcw++;</span><br><span class="line">                                <span class="keyword">if</span> (test_bit(R5_Insync, &amp;dev-&gt;flags) &amp;&amp;</span><br><span class="line">                                    test_bit(STRIPE_PREREAD_ACTIVE,</span><br><span class="line">                                             &amp;sh-&gt;state)) &#123;</span><br><span class="line">                                        pr_debug(<span class="string">&quot;Read_old block &quot;</span></span><br><span class="line">                                                <span class="string">&quot;%d for Reconstruct\n&quot;</span>, i);</span><br><span class="line">                                        set_bit(R5_LOCKED, &amp;dev-&gt;flags);</span><br><span class="line">                                        set_bit(R5_Wantread, &amp;dev-&gt;flags);</span><br><span class="line">                                        s-&gt;locked++;</span><br><span class="line">                                        qread++;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        set_bit(STRIPE_DELAYED, &amp;sh-&gt;state);</span><br><span class="line">                                        set_bit(STRIPE_HANDLE, &amp;sh-&gt;state);</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (rcw &amp;&amp; conf-&gt;mddev-&gt;<span class="built_in">queue</span>)</span><br><span class="line">                        blk_add_trace_msg(conf-&gt;mddev-&gt;<span class="built_in">queue</span>, <span class="string">&quot;raid5 rcw %llu %d %d %d&quot;</span>,</span><br><span class="line">                                          (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)sh-&gt;sector,</span><br><span class="line">                                          rcw, qread, test_bit(STRIPE_DELAYED, &amp;sh-&gt;state));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="kprobe-example"><a href="#kprobe-example" class="headerlink" title="kprobe example"></a><a href="https://www.linuxjournal.com/content/oops-debugging-kernel-panics-0">kprobe example</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_module_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> *p = <span class="number">1</span>;</span><br><span class="line">printk(<span class="string">&quot;%d\n&quot;</span>, *p);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_module_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(test_module_init);</span><br><span class="line">module_exit(test_module_exit);</span><br><span class="line"></span><br><span class="line">## Makefile</span><br><span class="line">obj-m += test-<span class="keyword">module</span>.o</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">    $(MAKE) -C/lib/modules/$(shell uname -r)/build M=$(PWD)</span><br><span class="line"></span><br><span class="line">$ sync &amp;&amp; sudo insmod test-<span class="keyword">module</span>.ko</span><br><span class="line">crash&gt; mod -s test ./test.o</span><br><span class="line">$ kmem -i</span><br></pre></td></tr></table></figure><h3 id="stap-show-all-local-parameters-could-be-print"><a href="#stap-show-all-local-parameters-could-be-print" class="headerlink" title="stap show all local parameters could be print"></a><a href="https://github.com/baotiao/baotiao.github.com/blob/6448a8ba675cbb6ea9ec002c4d8792a2b50226d5/_posts/2017-06-14-systemtap-tips-and-example.md">stap show all local parameters could be print</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ stap -L &#x27;kernel.statement(&quot;si_mem_available@mm/page_alloc.c:*&quot;)&#x27;</span><br><span class="line">kernel.statement(<span class="string">&quot;si_mem_available@mm/page_alloc.c:3795&quot;</span>) $pages:<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>[]</span><br><span class="line">kernel.statement(<span class="string">&quot;si_mem_available@mm/page_alloc.c:3798&quot;</span>) $wmark_low:<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> $pages:<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>[] $zone:<span class="class"><span class="keyword">struct</span> <span class="title">zone</span>*</span></span><br><span class="line"><span class="class"><span class="title">kernel</span>.<span class="title">statement</span>(&quot;<span class="title">si_mem_available</span>@<span class="title">mm</span>/<span class="title">page_alloc</span>.<span class="title">c</span>:</span><span class="number">3803</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3804</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3806</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3807</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[] $zone:struct zone*</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3813</span><span class="string">&quot;) $available:long int $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3820</span><span class="string">&quot;) $pages:long unsigned int[] $zone:struct zone*</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3821</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3822</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3828</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3829</span><span class="string">&quot;) $_min2:long unsigned int $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3834</span><span class="string">&quot;) $available:long int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stap -L &#x27;process(&quot;</span>/usr/bin/bash<span class="string">&quot;).function(&quot;</span>skip_single_quoted<span class="string">&quot;)&#x27;</span></span><br><span class="line"><span class="string">process(&quot;</span>/usr/bin/bash<span class="string">&quot;).function(&quot;</span>skip_single_quoted@/usr/src/debug/bash<span class="number">-4.2</span>/subst.c:<span class="number">1022</span><span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;Mem-mapping-in-Linux&quot;&gt;&lt;a href=&quot;#Mem-mapping-in-Linux&quot; class=&quot;headerlink&quot; title=&quot;Mem mapping in Linux&quot;&gt;&lt;/a&gt;Mem mapping in Linux&lt;/h4&gt;&lt;</summary>
      
    
    
    
    <category term="Scripts" scheme="http://yoursite.com/categories/Scripts/"/>
    
    
    <category term="debug" scheme="http://yoursite.com/tags/debug/"/>
    
    <category term="trace" scheme="http://yoursite.com/tags/trace/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2020/10/11/hello-world/"/>
    <id>http://yoursite.com/2020/10/11/hello-world/</id>
    <published>2020-10-11T11:38:12.155Z</published>
    <updated>2020-10-11T11:38:12.155Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><a id="more"></a><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p><h3 id="Add-type"><a href="#Add-type" class="headerlink" title="Add type"></a>Add type</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">source/tags/index.md</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2020-09-28 00:15:41</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">tags</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">source/categories/index.md</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2020-09-28 00:16:03</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">categories</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><p><img src="/img/the_last_word_fs.jpg"><br><img src="/img/hard-disk_223cf.jpg"><br><img src="/img/PROPELLER-2-1-1024x1024.png"><br><img src="/img/operting_system_a32c6f.svg"><br><img src="/img/network-interface-card-2081371-1751392.png"><br><img src="/img/32_connection_nodes_communication_network_seo_social_community_relation-512.png"><br><img src="/img/kisspng-computer-icons-benchmarking-computer-software-clip-5ad795b068f297.2882681215240780004299.jpg"><br><img src="/img/machine-learning-3-robot-developer-working-programming-coding-ai-machine-learning-hello-world-512.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>bpftrace</title>
    <link href="http://yoursite.com/2020/07/24/bpftrace/"/>
    <id>http://yoursite.com/2020/07/24/bpftrace/</id>
    <published>2020-07-24T06:13:15.000Z</published>
    <updated>2021-09-16T14:54:24.142Z</updated>
    
    <content type="html"><![CDATA[<h3 id="bcc-tools"><a href="#bcc-tools" class="headerlink" title="bcc tools"></a>bcc tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ./vfsstat 5 10</span><br><span class="line">TIME         READ/s  WRITE/s CREATE/s   OPEN/s  FSYNC/s</span><br><span class="line">14:34:53:       575        7        0      537        0</span><br><span class="line">14:34:58:       850        9        0      792        0</span><br><span class="line">14:35:03:       842        8        0      791        0</span><br><span class="line">14:35:08:       580        8        0      535        0</span><br><span class="line">14:35:13:       839        8        0      789        0</span><br><span class="line"></span><br><span class="line">$  bpftrace -e <span class="string">&#x27;kprobe:vfs_* &#123; @[probe] = count() &#125;&#x27;</span></span><br><span class="line">Attaching 53 probes...</span><br><span class="line">^C</span><br><span class="line">@[kprobe:vfs_llseek]: 1</span><br><span class="line">@[kprobe:vfs_fsync_range]: 33</span><br><span class="line">@[kprobe:vfs_iter_write]: 61</span><br><span class="line">@[kprobe:vfs_statfs]: 93</span><br><span class="line">@[kprobe:vfs_statx_fd]: 469</span><br><span class="line">@[kprobe:vfs_statx]: 2299</span><br><span class="line">@[kprobe:vfs_getattr_nosec]: 2872</span><br><span class="line">@[kprobe:vfs_getattr]: 2873</span><br><span class="line">@[kprobe:vfs_write]: 3754</span><br><span class="line">@[kprobe:vfs_open]: 4965</span><br><span class="line">@[kprobe:vfs_read]: 8020</span><br></pre></td></tr></table></figure><h3 id="list-all-events"><a href="#list-all-events" class="headerlink" title="list all events"></a>list all events</h3><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -l </span><br><span class="line">$ bpftrace -l <span class="string">&#x27;*sleep*&#x27;</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;tracepoint:syscalls:sys_enter_*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># args is a pointer to a struct containing all the tracepoint arguments. This struct is automatically generated by bpftrace based tracepoint information. The members of this struct can be found with </span></span><br><span class="line">$ bpftrace -lv tracepoint:syscalls:sys_enter_open </span><br><span class="line">tracepoint:syscalls:sys_enter_open</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    const char * filename;</span><br><span class="line">    int flags;</span><br><span class="line">    umode_t mode;</span><br><span class="line"></span><br><span class="line"><span class="comment"># If BTF is available, it is also possible to list struct/union/emum definitions. For example:</span></span><br><span class="line">$ bpftrace -lv <span class="string">&quot;struct path&quot;</span></span><br><span class="line">BTF: using data from /sys/kernel/btf/vmlinux</span><br><span class="line">struct path &#123;</span><br><span class="line">        struct vfsmount *mnt;</span><br><span class="line">        struct dentry *dentry;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><p>@name    global<br>@name[key]    hash<br>@name[tid]    thread-local<br>$name    scratch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Timing Reads by Process</span></span><br><span class="line">                  ------Probe Types, Kernel dynamic <span class="keyword">function</span> instrumentation</span><br><span class="line">                  |                 ---------thread-local Variable, custom</span><br><span class="line">                  |                 |       -------------Builtin Variable</span><br><span class="line">                  |                 |       |      ---Builtin Variable                                ---Builtin Variable                    ---Builtin Function</span><br><span class="line">                  |                 |       |      |                                                  |            |                         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;kprobe:vfs_read &#123; @tttstart[tid] = nsecs; &#125; kretprobe:vfs_read /@tttstart[tid]/ &#123; @ns[comm] = hist(nsecs - @tttstart[tid]); delete(@tttstart[tid]); &#125;&#x27;</span></span><br><span class="line">                                                            |                                                 |</span><br><span class="line">                                                            |                                                 ---Builtin Function</span><br><span class="line">                                                            ---Probe Types, Kernel dynamic <span class="keyword">function</span> <span class="built_in">return</span> instrumentation</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="struct-nested"><a href="#struct-nested" class="headerlink" title="struct nested"></a>struct nested</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; struct sock | grep sk_lock</span><br><span class="line">    socket_lock_t sk_lock;</span><br><span class="line">                    |</span><br><span class="line">                    -----------</span><br><span class="line">crash&gt; struct socket_lock_t   |</span><br><span class="line">typedef struct &#123;              |</span><br><span class="line">    spinlock_t slock;         |</span><br><span class="line">    int owned;----------------|</span><br><span class="line">    wait_queue_head_t wq;     |</span><br><span class="line">&#125; socket_lock_t;              |</span><br><span class="line">SIZE: 32          ------------</span><br><span class="line">                  |     |</span><br><span class="line"><span class="variable">$ulock</span> = <span class="variable">$sk</span>-&gt;sk_lock.owned;</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/env bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;net/sock.h&gt;</span></span><br><span class="line"></span><br><span class="line">k:tcp_delack_timer</span><br><span class="line">&#123;</span><br><span class="line">        @sk[tid] = arg0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kr:tcp_delack_timer</span><br><span class="line">/@sk[tid]/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="variable">$sk</span> = (struct sock *)@sk[tid];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$af</span> = <span class="variable">$sk</span>-&gt;__sk_common.skc_family;</span><br><span class="line">        <span class="variable">$ulock</span> = <span class="variable">$sk</span>-&gt;sk_lock.owned;</span><br><span class="line">        //<span class="keyword">if</span> (<span class="variable">$af</span> == AF_INET) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$ulock</span> != 0) &#123;</span><br><span class="line">            <span class="variable">$daddr</span> = ntop(<span class="variable">$af</span>, <span class="variable">$sk</span>-&gt;__sk_common.skc_daddr);</span><br><span class="line">            <span class="variable">$saddr</span> = ntop(<span class="variable">$af</span>, <span class="variable">$sk</span>-&gt;__sk_common.skc_rcv_saddr);</span><br><span class="line">            <span class="variable">$lport</span> = <span class="variable">$sk</span>-&gt;__sk_common.skc_num;</span><br><span class="line">            <span class="variable">$dport</span> = <span class="variable">$sk</span>-&gt;__sk_common.skc_dport; </span><br><span class="line">            <span class="variable">$dport</span> = (<span class="variable">$dport</span> &gt;&gt; 8) | ((<span class="variable">$dport</span> &lt;&lt; 8) &amp; 0xff00);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s %d %-15s %-5d -&gt; %-15s %-5d, lock-owned: %d retval: %d\n&quot;</span>,</span><br><span class="line">                comm, tid, <span class="variable">$saddr</span>, <span class="variable">$lport</span>, <span class="variable">$daddr</span>, <span class="variable">$dport</span>, <span class="variable">$ulock</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">        delete(@sk[tid]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END &#123;</span><br><span class="line">   clear(@sk);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add bpftrace env </span></span><br><span class="line">$ BPFTRACE_STRLEN=200 bpftrace ./your_bpf.bt</span><br></pre></td></tr></table></figure><h4 id="Show-file-name"><a href="#Show-file-name" class="headerlink" title="Show file name"></a>Show file name</h4><p>filename</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e &#x27;tracepoint:syscalls:sys_enter_openat &#123; printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); &#125;&#x27;</span><br><span class="line">$ bpftrace --include linux/path.h --include linux/dcache.h     -e &#x27;kprobe:vfs_open &#123; printf(&quot;open path: %s\n&quot;, str(((path *)arg0)-&gt;dentry-&gt;d_name.name)); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/path.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/dcache.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* wait fd2path/path to the new version https://github.com/iovisor/bpftrace/issues/29 */</span></span><br><span class="line"><span class="comment">/* only print parent dir name and file name */</span></span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open path:%s/%s,uid: %d,cmd %s, &quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_name.name), str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name), uid, comm);</span><br><span class="line">    @start = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;take ns: %d\n&quot;</span>, (nsecs - @start));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##<span class="meta"># fs/open.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_open - open the file at the given path</span></span><br><span class="line"><span class="comment"> * @path: path to open</span></span><br><span class="line"><span class="comment"> * @file: newly allocated file with f_flag initialized</span></span><br><span class="line"><span class="comment"> * @cred: credentials to use</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_open</span><span class="params">(<span class="keyword">const</span> struct path *path, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">file-&gt;f_path = *path;</span><br><span class="line"><span class="keyword">return</span> do_dentry_open(file, d_backing_inode(path-&gt;dentry), <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/path.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/dcache.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line"><span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> d_flags;<span class="comment">/* protected by d_lock */</span></span><br><span class="line"><span class="keyword">seqcount_t</span> d_seq;<span class="comment">/* per dentry seqlock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span><span class="comment">/* lookup hash list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span><span class="comment">/* parent directory */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span><span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment"> * negative */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> d_iname[DNAME_INLINE_LEN];<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span><span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span><span class="comment">/* The root of the dentry tree */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_time;<span class="comment">/* used by d_revalidate */</span></span><br><span class="line"><span class="keyword">void</span> *d_fsdata;<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span><span class="comment">/* LRU list */</span></span><br><span class="line"><span class="keyword">wait_queue_head_t</span> *d_wait;<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span><span class="comment">/* child of parent list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span><span class="comment">/* our children */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span><span class="comment">/* inode alias list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span><span class="comment">/* only for in-lookup ones */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">&#125; d_u;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><h5 id="show-the-path"><a href="#show-the-path" class="headerlink" title="show the path"></a>show the path</h5><p>The same work with vfs_read and vfs_write</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;linux/fs.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">kprobe:vfs_read /pid == <span class="variable">$1</span>/</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The vfs_read parent dir:%s/%s/%s/%s,uid: %d,cmd %s;\n&quot;</span>,</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_parent-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name), uid, comm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#output:</span></span><br><span class="line">The vfs_read parent dir:yum/<span class="built_in">history</span>/history-2021-01-09.sqlite-journal/,uid: 0,cmd yum;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">stat</span>  /var/lib/yum/<span class="built_in">history</span>/history-2021-01-09.sqlite-journal</span><br><span class="line">  File: <span class="string">&#x27;/var/lib/yum/history/history-2021-01-09.sqlite-journal&#x27;</span></span><br><span class="line">  Size: 17024           Blocks: 48         IO Block: 4096   regular file</span><br><span class="line">Device: 802h/2050d      Inode: 5505368     Links: 1</span><br><span class="line">Access: (0600/-rw-------)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">(gdb) list vfs_write</span><br><span class="line">527     ssize_t vfs_write(struct file *file, const char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">(gdb) list vfs_read</span><br><span class="line">450     ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">(gdb) list vfs_open</span><br><span class="line">856     int vfs_open(const struct path *path, struct file *filp,</span><br><span class="line">857                  const struct cred *cred)</span><br><span class="line">(gdb) list rw_verify_area</span><br><span class="line">397     int rw_verify_area(int read_write, struct file *file, loff_t *ppos, size_t count)</span><br></pre></td></tr></table></figure><h4 id="trace-user-space-application"><a href="#trace-user-space-application" class="headerlink" title="trace user space application"></a><a href="https://www.percona.com/sites/default/files/presentations/Scale18x-2020-bpfTrace-finally-dTrace-replacement.pdf">trace user space application</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   binaray file ------------         -----------the <span class="keyword">function</span> from hello_world</span><br><span class="line">                           |         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:~/hello_world:hello &#123;printf(&quot;%s\n&quot;, ustack());&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p><a href="http://blog.jcix.top/2019-12-04/bpftrace-profiling/">example</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;time.h&gt;</span></span><br><span class="line"> </span><br><span class="line">void sleep_func(int sleep_time_us)</span><br><span class="line">&#123;</span><br><span class="line">    usleep(sleep_time_us);</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int lower = 0, upper = 100;</span><br><span class="line">    srand(time(0));</span><br><span class="line">    <span class="keyword">for</span> (int k = 1000; k &gt; 0; k--) &#123;</span><br><span class="line">        int sleep_time_us = 0;</span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            sleep_time_us += rand() % (upper - lower) + lower;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;us: %d\n&quot;</span>, sleep_time_us);</span><br><span class="line">        sleep_func(sleep_time_us);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">------------------------------------ </span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line">uprobe:~/sleep_prog:sleep_func</span><br><span class="line">&#123;</span><br><span class="line">    @t_start=nsecs;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">uretprobe:~/sleep_prog:sleep_func</span><br><span class="line">/@t_start/</span><br><span class="line">&#123;</span><br><span class="line">    @my_hist = lhist(nsecs - @t_start, 0, 10000000, 50000);</span><br><span class="line">    clear(@t_start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@my_hist:</span><br><span class="line">[250000, 300000)       1 |                                                    |</span><br><span class="line">[300000, 350000)       6 |@@                                                  |</span><br><span class="line">[350000, 400000)      14 |@@@@@@                                              |</span><br><span class="line">[400000, 450000)      39 |@@@@@@@@@@@@@@@@                                    |</span><br><span class="line">[450000, 500000)      63 |@@@@@@@@@@@@@@@@@@@@@@@@@@@                         |</span><br><span class="line">[500000, 550000)     120 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[550000, 600000)      82 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 |</span><br><span class="line">[600000, 650000)      96 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           |</span><br><span class="line">[650000, 700000)      53 |@@@@@@@@@@@@@@@@@@@@@@                              |</span><br><span class="line">[700000, 750000)      18 |@@@@@@@                                             |</span><br><span class="line">[750000, 800000)       7 |@@@                                                 |</span><br><span class="line">[800000, 850000)       0 |                                                    |</span><br><span class="line">[850000, 900000)       0 |                                                    |</span><br><span class="line">[900000, 950000)       0 |                                                    |</span><br><span class="line">[950000, 1000000)       0 |                                                    |</span><br><span class="line">[1000000, 1050000)       0 |                                                    |</span><br><span class="line">[1050000, 1100000)       0 |                                                    |</span><br><span class="line">[1100000, 1150000)       0 |                                                    |</span><br><span class="line">[1150000, 1200000)       1 |                                                    |</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>uprobe:/bin/bash:readline (the function begining)<br>uretprobe:/bin/bash:readline (the function end)</p><p>/sys/kernel/debug/tracing/uprobe_events</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">root@mysql1:~<span class="comment"># bpftrace -e &#x27;uprobe:/usr/sbin/</span></span><br><span class="line">mysqld:dispatch_command &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">Could not resolve symbol: /usr/sbin/mysqld:dispatch_command</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@mysql1:~# nm -D /usr/sbin/mysqld | grep dispatch_command</span></span><br><span class="line"><span class="string">00000000005af770 T</span></span><br><span class="line"><span class="string">_Z16dispatch_command19enum_server_commandP3THDPcjbb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>uprobe:/usr/sbin/mysqld:_Z16dispatch_command19enum_server_commandP3THDPcjbb &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">select @@version_comment limit 1</span></span><br><span class="line"><span class="string">select 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;join(args-&gt;filename)&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,str(args-&gt;filename))&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[pid,comm]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[2423, in:imjournal]: 10</span></span><br><span class="line"><span class="string">@[338226, worker]: 12</span></span><br><span class="line"><span class="string">@[338161, qemu-kvm]: 19</span></span><br><span class="line"><span class="string">@[338161, CPU 0/KVM]: 20</span></span><br><span class="line"><span class="string">@[1898, NetworkManager]: 22</span></span><br><span class="line"><span class="string">@[338226, CPU 0/KVM]: 23</span></span><br><span class="line"><span class="string">@[2517288, sshd]: 24</span></span><br><span class="line"><span class="string">@[338513, CPU 1/KVM]: 24</span></span><br><span class="line"><span class="string">@[338226, qemu-kvm]: 29</span></span><br><span class="line"><span class="string">@[338161, CPU 3/KVM]: 42</span></span><br><span class="line"><span class="string">@[2801247, bpftrace]: 48</span></span><br><span class="line"><span class="string">@[338098, CPU 1/KVM]: 66</span></span><br><span class="line"><span class="string">@[338161, SPICE Worker]: 169</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_* &#123;@[probe,comm]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 320 probes...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_madvise, qemu-kvm]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_select, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_getpid, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_waitid, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, irqbalance]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_inotify_add_watch, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_ioctl, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_rt_sigreturn, bpftrace]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_pwrite64, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_fdatasync, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_read, sshd]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_write, sshd]: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[ksym(*(kaddr(<span class="string">&quot;sys_call_table&quot;</span>) + args-&gt;id * 8))]=count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[__x64_sys_inotify_add_watch]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_exit]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigreturn]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_getpid]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_madvise]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_pwrite64]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_fdatasync]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_recvmmsg]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_select]: 6</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigprocmask]: 8</span></span><br><span class="line"><span class="string">@[__x64_sys_clock_gettime]: 12</span></span><br><span class="line"><span class="string">@[__x64_sys_newfstat]: 34</span></span><br><span class="line"><span class="string">@[__x64_sys_close]: 36</span></span><br><span class="line"><span class="string">@[__x64_sys_openat]: 50</span></span><br><span class="line"><span class="string">@[__x64_sys_epoll_wait]: 70</span></span><br><span class="line"><span class="string">@[__x64_sys_futex]: 81</span></span><br><span class="line"><span class="string">@[__x64_sys_ppoll]: 108</span></span><br><span class="line"><span class="string">@[__x64_sys_read]: 297</span></span><br><span class="line"><span class="string">@[__x64_sys_write]: 327</span></span><br><span class="line"><span class="string">@[__x64_sys_ioctl]: 334</span></span><br><span class="line"><span class="string">@[__x64_sys_poll]: 430</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:99 /pid == 189/ &#123;@[ustack] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:49 &#123;@[ustack, kstack, comm] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[,</span></span><br><span class="line"><span class="string">    poll_idle+45</span></span><br><span class="line"><span class="string">    cpuidle_enter_state+115</span></span><br><span class="line"><span class="string">    cpuidle_enter+44</span></span><br><span class="line"><span class="string">    do_idle+566</span></span><br><span class="line"><span class="string">    cpu_startup_entry+111</span></span><br><span class="line"><span class="string">    start_secondary+423</span></span><br><span class="line"><span class="string">    secondary_startup_64+183</span></span><br><span class="line"><span class="string">, swapper/5]: 1</span></span><br><span class="line"><span class="string">@[</span></span><br><span class="line"><span class="string">    0x7f9e88814ab4</span></span><br><span class="line"><span class="string">    0x696765725f6b6c63</span></span><br><span class="line"><span class="string">,</span></span><br><span class="line"><span class="string">    pointer+521</span></span><br><span class="line"><span class="string">    vsnprintf+892</span></span><br><span class="line"><span class="string">    seq_vprintf+48</span></span><br><span class="line"><span class="string">    seq_printf+83</span></span><br><span class="line"><span class="string">    s_show+123</span></span><br><span class="line"><span class="string">    seq_read+745</span></span><br><span class="line"><span class="string">    proc_reg_read+60</span></span><br><span class="line"><span class="string">    vfs_read+145</span></span><br><span class="line"><span class="string">    ksys_read+79</span></span><br><span class="line"><span class="string">    do_syscall_64+91</span></span><br><span class="line"><span class="string">    entry_SYSCALL_64_after_hwframe+101</span></span><br><span class="line"><span class="string">, bpftrace]: 1</span></span><br></pre></td></tr></table></figure><p>uprobe example</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:/bin/bash:readline &#123; @ = count() &#125;&#x27;</span></span><br><span class="line">$ ./gethostlatency <span class="comment"># host resoltion calls latency (DNS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Get all _IO function from the system library</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;uprobe:/lib64/libc.so.6:_IO*&#x27;</span> | head</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fclose.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fgetpos.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_fgets.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_read</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_write</span><br></pre></td></tr></table></figure><p>Tracepoint</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ls <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing/events</span><br><span class="line">$ cat <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>sched<span class="regexp">/sched_process_exec/</span>format</span><br><span class="line"><span class="attr">name:</span> sched_process_exec</span><br><span class="line"><span class="attr">ID:</span> <span class="number">305</span></span><br><span class="line"><span class="attr">format:</span></span><br><span class="line"><span class="symbol">field:</span>unsigned <span class="keyword">short</span> common_type;<span class="attr">offset:</span><span class="number">0</span>;<span class="attr">size:</span><span class="number">2</span>;<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line"><span class="symbol">field:</span>unsigned <span class="keyword">char</span> common_flags;<span class="attr">offset:</span><span class="number">2</span>;<span class="attr">size:</span><span class="number">1</span>;<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line"><span class="symbol">field:</span>unsigned <span class="keyword">char</span> common_preempt_count;<span class="attr">offset:</span><span class="number">3</span>;<span class="attr">size:</span><span class="number">1</span>;<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line"><span class="symbol">field:</span><span class="keyword">int</span> common_pid;<span class="attr">offset:</span><span class="number">4</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="symbol">field:</span>__data_loc <span class="keyword">char</span>[] filename;<span class="attr">offset:</span><span class="number">8</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"><span class="symbol">field:</span>pid_t pid;<span class="attr">offset:</span><span class="number">12</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"><span class="symbol">field:</span>pid_t old_pid;<span class="attr">offset:</span><span class="number">16</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">print <span class="attr">fmt:</span> <span class="string">&quot;filename=%s pid=%d old_pid=%d&quot;</span>, __get_str(filename), REC-&gt;pid, REC-&gt;old_pid</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;tracepoint:sched:sched_process_exec &#123;printf(&quot;exec by %s\n&quot;, comm); &#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Add USDT instrumentation</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="string">&quot;folly/tracing/StaticTracepoint.h&quot;</span></span></span><br><span class="line">readref -n usdt_sample_lib1/libusdt_sample_lib1.so</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;usdt:/tmp/tick:loop &#123;printf (&quot;got: %d\n&quot;, arg0); &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="bcc-tools-1"><a href="#bcc-tools-1" class="headerlink" title="bcc tools"></a>bcc tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">runqslower is BCC tools that lists instance of run queue latency exceeding a configurable threshold and show the process that suffered the latency and its duration</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./runqslower         <span class="comment"># trace run queue latency higher than 10000 us (default)</span></span><br><span class="line">    ./runqslower 1000    <span class="comment"># trace run queue latency higher than 1000 us</span></span><br><span class="line">    ./runqslower -p 123  <span class="comment"># trace pid 123 only</span></span><br><span class="line">[root@test-2643a /usr/share/bcc/tools]<span class="comment"># ./runqslower</span></span><br><span class="line">Tracing run queue latency higher than 10000 us</span><br><span class="line">TIME     COMM             PID           LAT(us)</span><br><span class="line">00:20:20 bwa              5836            22182</span><br><span class="line">00:20:22 sh               5844            12056</span><br><span class="line">00:20:22 bwa              5838            12061</span><br><span class="line">00:20:22 bwa              5835            13001</span><br><span class="line">00:20:22 bwa              5835            12109</span><br><span class="line"></span><br><span class="line">show the distribution of on-cpu time <span class="keyword">for</span> each thread wakeup</span><br><span class="line">tracing schduler contect switch events</span><br><span class="line">$ ./cpudist</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 209      |                                        |</span><br><span class="line">         2 -&gt; 3          : 16066    |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 125262   |****************************************|</span><br><span class="line">         8 -&gt; 15         : 59764    |*******************                     |</span><br><span class="line">        16 -&gt; 31         : 13689    |****                                    |</span><br><span class="line">        32 -&gt; 63         : 2320     |                                        |</span><br><span class="line"></span><br><span class="line"><span class="comment">#trace dd write</span></span><br><span class="line">$ ./cpudist -m -p 3826757</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     msecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 190      |****************************************|</span><br><span class="line">$ ./cpudist -p 3826757</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 11       |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 35       |***************                         |</span><br><span class="line">         8 -&gt; 15         : 41       |******************                      |</span><br><span class="line">        16 -&gt; 31         : 36       |****************                        |</span><br><span class="line">        32 -&gt; 63         : 88       |****************************************|</span><br><span class="line">        64 -&gt; 127        : 32       |**************                          |</span><br><span class="line">       128 -&gt; 255        : 25       |***********                             |</span><br><span class="line">       256 -&gt; 511        : 13       |*****                                   |</span><br><span class="line">       512 -&gt; 1023       : 6        |**                                      |</span><br><span class="line">      1024 -&gt; 2047       : 2        |                                        |</span><br><span class="line"></span><br><span class="line"><span class="comment"># stack tracing as a list of function</span></span><br><span class="line">$ ./profile -p 3826757</span><br><span class="line">Sampling at 49 Hertz of PID 3826757 by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    b<span class="string">&#x27;_raw_spin_lock&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;_raw_spin_lock&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;dmu_buf_will_dirty_impl&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_attr_op&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_bulk_update_impl&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_bulk_update&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b<span class="string">&#x27;__slab_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;__slab_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;kmem_cache_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;spl_kmem_cache_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_hdr_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_alloc_buf&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_loan_buf&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b<span class="string">&#x27;dmu_tx_hold_sa&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;dmu_tx_hold_sa&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">show the <span class="built_in">read</span> requested size since entry to the syscall was <span class="keyword">in</span> instrumented</span><br><span class="line"></span><br><span class="line">$ ./argdist -H <span class="string">&#x27;t:syscalls:sys_exit_read():int:args-&gt;ret&#x27;</span></span><br><span class="line">[00:36:40]</span><br><span class="line">     args-&gt;ret           : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 1        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 0        |                                        |</span><br><span class="line">       256 -&gt; 511        : 0        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 0        |                                        |</span><br><span class="line">      1024 -&gt; 2047       : 0        |                                        |</span><br><span class="line">      2048 -&gt; 4095       : 0        |                                        |</span><br><span class="line">      4096 -&gt; 8191       : 0        |                                        |</span><br><span class="line">      8192 -&gt; 16383      : 3584     |****************************************|</span><br><span class="line"></span><br><span class="line">$  bpftrace -lv <span class="string">&#x27;tracepoint:syscalls:sys_exit_write&#x27;</span></span><br><span class="line">tracepoint:syscalls:sys_exit_write</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    long ret;</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_exit_write &#123; @ = hist(args-&gt;ret) &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">c^C</span><br><span class="line"></span><br><span class="line">@:</span><br><span class="line">[1]                    2 |                                                    |</span><br><span class="line">[2, 4)                 0 |                                                    |</span><br><span class="line">[4, 8)                 0 |                                                    |</span><br><span class="line">[8, 16)               45 |@                                                   |</span><br><span class="line">[16, 32)              18 |                                                    |</span><br><span class="line">[32, 64)               1 |                                                    |</span><br><span class="line">[64, 128)              0 |                                                    |</span><br><span class="line">[128, 256)             0 |                                                    |</span><br><span class="line">[256, 512)             0 |                                                    |</span><br><span class="line">[512, 1K)              0 |                                                    |</span><br><span class="line">[1K, 2K)               0 |                                                    |</span><br><span class="line">[2K, 4K)               0 |                                                    |</span><br><span class="line">[4K, 8K)               0 |                                                    |</span><br><span class="line">[8K, 16K)              0 |                                                    |</span><br><span class="line">[16K, 32K)             0 |                                                    |</span><br><span class="line">[32K, 64K)             0 |                                                    |</span><br><span class="line">[64K, 128K)            0 |                                                    |</span><br><span class="line">[128K, 256K)           0 |                                                    |</span><br><span class="line">[256K, 512K)           0 |                                                    |</span><br><span class="line">[512K, 1M)             0 |                                                    |</span><br><span class="line">[1M, 2M)            1558 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">$ ./funccount -i 1  <span class="string">&#x27;tcp_*&#x27;</span></span><br><span class="line">Tracing 282 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;tcp_*&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">tcp_drop                                    1</span><br><span class="line">tcp_validate_incoming                       1</span><br><span class="line">tcp_send_dupack                             1</span><br><span class="line">tcp_oow_rate_limited                        1</span><br><span class="line">tcp_write_wakeup                            3</span><br><span class="line">tcp_xmit_probe_skb                          3</span><br><span class="line">tcp_delack_timer                            4</span><br><span class="line">tcp_delack_timer_handler                    6</span><br><span class="line">tcp_write_timer                             6</span><br><span class="line">tcp_poll                                    6</span><br><span class="line">tcp_keepalive_timer                         7</span><br><span class="line">tcp_write_timer_handler                     7</span><br><span class="line">tcp_try_rmem_schedule                       7</span><br><span class="line">tcp_init_cwnd                               8</span><br><span class="line">tcp_urg                                    12</span><br><span class="line">tcp_data_queue                             15</span><br><span class="line">tcp_check_space                            30</span><br><span class="line">tcp_set_skb_tso_segs                       38</span><br><span class="line">tcp_nagle_check                            38</span><br><span class="line">tcp_ack                                    42</span><br><span class="line">tcp_stream_memory_free                     44</span><br><span class="line">tcp_send_mss                               54</span><br><span class="line">tcp_init_tso_segs                          54</span><br><span class="line">tcp_wfree                                  57</span><br><span class="line">tcp_event_new_data_sent                    72</span><br><span class="line"></span><br><span class="line">$ ./funccount -i 1  <span class="string">&#x27;get_page_from_freelist&#x27;</span></span><br><span class="line">Tracing 1 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;get_page_from_freelist&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">get_page_from_freelist                  14785</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">get_page_from_freelist                   7397</span><br><span class="line"></span><br><span class="line">$ ./execsnoop</span><br><span class="line">PCOMM            PID    PPID   RET ARGS</span><br><span class="line">ps               205430 205429   0 /usr/bin/ps aux</span><br><span class="line">grep             205431 205429   0 /usr/bin/grep nobody</span><br><span class="line">awk              205432 205429   0 /usr/bin/awk <span class="variable">$3</span>&gt;0 &#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;</span><br><span class="line">tail             205434 205429   0 /usr/bin/tail -n 1</span><br><span class="line">ls               205436 205435   0 /usr/bin/ls /proc/204067/fd</span><br><span class="line">grep             205437 205435   0 /usr/bin/grep -v dev</span><br><span class="line">grep             205438 205435   0 /usr/bin/grep -v socket</span><br><span class="line">wc               205439 205435   0 /usr/bin/wc -l</span><br><span class="line">sleep            205440 210303   0 /usr/bin/sleep 5</span><br><span class="line"></span><br><span class="line">$ ./syscount -p 204067</span><br><span class="line">Tracing syscalls, printing top 10... Ctrl+C to quit.</span><br><span class="line">^C[12:26:18]</span><br><span class="line">SYSCALL                   COUNT</span><br><span class="line">sched_yield              187351</span><br><span class="line"><span class="built_in">read</span>                      26216</span><br><span class="line">mprotect                   7533</span><br><span class="line">futex                      1863</span><br><span class="line">write                        24</span><br><span class="line"></span><br><span class="line">$ ./profile -F 49 -U -p 204067</span><br><span class="line">Sampling at 49 Hertz of PID 204067 by user stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    ParCompactionManager::follow_marking_stacks()</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    ParallelTaskTerminator::offer_termination(TerminatorTerminator*)</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">$ ./trace <span class="string">&#x27;c:malloc &quot;size = %d&quot;, arg1&#x27;</span></span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 100</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 22</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 32</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 22</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 100</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 22</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 32</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 22</span><br><span class="line">338098  338124  CPU 1/KVM       malloc           size = 32</span><br><span class="line"></span><br><span class="line">$ ./trace /lib64/libpthread-2.28.so:pthread_create</span><br><span class="line">PID     TID     COMM            FUNC</span><br><span class="line">338161  338161  qemu-kvm        pthread_create</span><br></pre></td></tr></table></figure><h3 id="Memroy-allocators"><a href="#Memroy-allocators" class="headerlink" title="Memroy allocators"></a>Memroy allocators</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Process                         kernel          Slab allocator    page allocator</span><br><span class="line">  |                               |                   |                |</span><br><span class="line">Segments    libc allocator     ext4/scsi module-----caches-----------free lists-------DRAM(physical)</span><br><span class="line">  |             |                                                      |</span><br><span class="line">Heap----------memory----------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Application                    virtual mem                              </span><br><span class="line">   |                               |   ----------------------------------------physical mem</span><br><span class="line">   |&lt;-----------------------------||   |                                            ^</span><br><span class="line">Allocator (libc)                  ||   V                                            |</span><br><span class="line">1.malloc()--------2a blk---------&gt;heap(from high to low)----&gt;3.lookup--mmu--&gt;4.page fault</span><br><span class="line">  free()       |                   |  |</span><br><span class="line">  realloc()    |                   V  |</span><br><span class="line">  calloc()     |                      ------------------5.page out------------&gt;swap device</span><br><span class="line">               |</span><br><span class="line">               -2b mmap/munmap---&gt;mappings                          </span><br><span class="line">                             (processs address space)</span><br></pre></td></tr></table></figure><p>tcmalloc and jemalloc provide their own allocator along with garbage collection</p><p>trace PMCs for memory I/O events</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$  perf <span class="built_in">stat</span> -e LLC-loads,LLC-load-misses -a -I 1000</span><br><span class="line"><span class="comment">#           time             counts unit events</span></span><br><span class="line">     1.005137445        559,247,421      LLC-loads</span><br><span class="line">     1.005137445        269,259,408      LLC-load-misses           <span class="comment">#   48.15% of all LL-cache hits</span></span><br><span class="line">     2.007241604        551,600,432      LLC-loads</span><br><span class="line">     2.007241604        267,976,111      LLC-load-misses           <span class="comment">#   48.25% of all LL-cache hits</span></span><br><span class="line">     3.009090791        552,723,650      LLC-loads</span><br><span class="line">     3.009090791        268,186,466      LLC-load-misses           <span class="comment">#   48.36% of all LL-cache hits</span></span><br><span class="line">     4.011116721        560,135,096      LLC-loads</span><br><span class="line">     4.011116721        268,988,337      LLC-load-misses           <span class="comment">#   48.39% of all LL-cache hits</span></span><br><span class="line">$ perf record -e L1-dcache-load-misses -c 100000 -a</span><br><span class="line">$ perf report -n --stdio</span><br></pre></td></tr></table></figure><h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">page cache &lt;--&gt; filesystem              RAW block device</span><br><span class="line">                   |                        |</span><br><span class="line">                   |                        |</span><br><span class="line">                   --------------------------</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     block device interface</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     Volume manager (<span class="keyword">if</span> used)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     Device Mapper (<span class="keyword">if</span> used)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                         Block layer </span><br><span class="line">            classic scheduler  or  Multi queue scheduler</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                    Host Bus adaptor Driver(scsi)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                        Disk devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># blk_fill_rwbs</span></span><br><span class="line">R: <span class="built_in">read</span>    </span><br><span class="line">W: Write    </span><br><span class="line">M: Metadata    </span><br><span class="line">S: Synchronous</span><br><span class="line">A: Readahead</span><br><span class="line">F: Flush or force unit access</span><br><span class="line">D: Discard</span><br><span class="line">E: Erase</span><br><span class="line">N: None</span><br><span class="line"></span><br><span class="line">IO scduler</span><br><span class="line">Noop/Dealine/CFQ</span><br><span class="line">blk-mq (linux 3.13)</span><br></pre></td></tr></table></figure><p>In the event of a system failure while there are active writes, the parity of a stripe may become inconsistent with the data. If this is not detected and repaired before a disk or block fails, data loss may ensue as incorrect parity will be used to reconstruct the missing block in that stripe. This potential vulnerability is sometimes known as the write hole. Battery-backed cache and similar techniques are commonly used to reduce the window of opportunity for this to occur. The same issue occurs for RAID-6.</p><h4 id="storage-example"><a href="#storage-example" class="headerlink" title="storage example"></a><a href="https://www.informit.com/articles/article.aspx?p=2995360&seqNum=3#">storage example</a></h4><p>This tool needs to store a timestamp at the start of each I/O to record its duration (latency)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">################</span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @start[args-&gt;dev, args-&gt;sector] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/@start[args-&gt;dev, args-&gt;sector]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[args-&gt;dev, args-&gt;sector]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[args-&gt;dev, args-&gt;sector]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###############</span><br><span class="line"></span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                  |</span><br><span class="line">[<span class="number">128</span>, <span class="number">256</span>)             <span class="number">1</span> |@@@@@@@@@@@@@@@@@                                   |</span><br><span class="line">[<span class="number">256</span>, <span class="number">512</span>)             <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">512</span>, <span class="number">1</span>K)              <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">1</span>K, <span class="number">2</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">4</span>K, <span class="number">8</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">8</span>K, <span class="number">16</span>K)              <span class="number">3</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>Traces the full duration of the I/O</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12s %-16s %-6s %7s\n&quot;</span>, <span class="string">&quot;TIME(ms)&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;LAT(ms)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">        @iopid[arg0] = pid;</span><br><span class="line">        @iocomm[arg0] = comm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0] != <span class="number">0</span> &amp;&amp; @iopid[arg0] != <span class="number">0</span> &amp;&amp; @iocomm[arg0] != <span class="string">&quot;&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        $now = nsecs;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12u %-16s %-6d %7d\n&quot;</span>,</span><br><span class="line">            elapsed / <span class="number">1000000</span>, @iocomm[arg0], @iopid[arg0],</span><br><span class="line">            ($now - @start[arg0]) / <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span>(@start[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@iopid[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@iocomm[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">        clear(@iopid);</span><br><span class="line">        clear(@iocomm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME(ms)     <span class="function">COMM             PID    <span class="title">LAT</span><span class="params">(ms)</span></span></span><br><span class="line"><span class="function">4763         vim              55675        0</span></span><br><span class="line"><span class="function">4763         vim              55675        0</span></span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br></pre></td></tr></table></figure><p>biosize</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @[args-&gt;comm] = hist(args-&gt;bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nI/O size (bytes) histograms by process name:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">3</span> probes...</span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">I/<span class="function">O <span class="title">size</span> <span class="params">(bytes)</span> histograms by process name:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line">@[kworker/u434:1]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[vim]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[kworker/<span class="number">21</span>:<span class="number">2</span>]:</span><br><span class="line">[<span class="number">8</span>, <span class="number">16</span>)                <span class="number">3</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>seeksize<br>show how many sectors that processes are requesting the disks to seek</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        printf(<span class="string">&quot;Tracing block I/O requested seeks... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (@last[args-&gt;dev]) &#123;</span><br><span class="line">                <span class="comment">// calculate requested seek distance</span></span><br><span class="line">                $last = @last[args-&gt;dev];</span><br><span class="line">                $dist = (args-&gt;sector - $last) &gt; <span class="number">0</span> ?</span><br><span class="line">                    args-&gt;sector - $last : $last - args-&gt;sector;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// store details</span></span><br><span class="line">                @sectors[args-&gt;comm] = hist($dist);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// save last requested position of disk head</span></span><br><span class="line">        @last[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">clear</span>(@last);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">3</span> probes...</span><br><span class="line">Tracing block I/O requested seeks... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@sectors[bash]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/<span class="number">15</span>:<span class="number">1</span>]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/u433:<span class="number">0</span>]:</span><br><span class="line">[<span class="number">256</span>M, <span class="number">512</span>M)           <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[vim]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[xfsaild/sda3]:</span><br><span class="line">[<span class="number">128</span>M, <span class="number">256</span>M)           <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[sync]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>biopattern<br>identify the pattern of I/O: random or sequential</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %5s %5s %8s %10s\n&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;%RND&quot;</span>, <span class="string">&quot;%SEQ&quot;</span>, <span class="string">&quot;COUNT&quot;</span>,</span><br><span class="line">            <span class="string">&quot;KBYTES&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (@lastsector[args-&gt;dev] == args-&gt;sector) &#123;</span><br><span class="line">                @sequential++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @random++;</span><br><span class="line">        &#125;</span><br><span class="line">        @bytes = @bytes + args-&gt;nr_sector * <span class="number">512</span>;</span><br><span class="line">        @lastsector[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interval:s:<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">        $count = @random + @sequential;</span><br><span class="line">        $div = $count;</span><br><span class="line">        <span class="keyword">if</span> ($div == <span class="number">0</span>) &#123;</span><br><span class="line">                $div = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%5d %5d %8d %10d\n&quot;</span>, @random * <span class="number">100</span> / $div,</span><br><span class="line">            @sequential * <span class="number">100</span> / $div, $count, @bytes / <span class="number">1024</span>);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@lastsector);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME      %RND  %SEQ    COUNT     KBYTES</span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">58</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">59</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>         <span class="number">16</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">00</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">01</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">03</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">04</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">05</span>    <span class="number">75</span>    <span class="number">25</span>        <span class="number">8</span>         <span class="number">48</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">06</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">07</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">08</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure><p>biostacks</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O with init stacks. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @reqstack[arg0] = kstack;</span><br><span class="line">        @reqts[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@reqts[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs[@reqstack[arg0]] = hist(nsecs - @reqts[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@reqstack[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@reqts[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@reqstack); clear(@reqts);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">5</span> probes...</span><br><span class="line">Tracing block I/O with init stacks. Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs[</span><br><span class="line">    blk_account_io_start+<span class="number">1</span></span><br><span class="line">    generic_make_request+<span class="number">327</span></span><br><span class="line">    submit_bio+<span class="number">112</span></span><br><span class="line">    xfs_submit_ioend.isra<span class="number">.12</span>+<span class="number">97</span></span><br><span class="line">    xfs_vm_writepages+<span class="number">127</span></span><br><span class="line">    do_writepages+<span class="number">33</span></span><br><span class="line">    __filemap_fdatawrite_range+<span class="number">101</span></span><br><span class="line">    filemap_write_and_wait_range+<span class="number">65</span></span><br><span class="line">    xfs_file_fsync+<span class="number">102</span></span><br><span class="line">    do_fsync+<span class="number">103</span></span><br><span class="line">    sys_fsync+<span class="number">16</span></span><br><span class="line">    system_call_fastpath+<span class="number">37</span></span><br><span class="line">]:</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>bioerr</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">perf record -e block:block_rq_complete --filter &#x27;error != 0&#x27;</span><br><span class="line">cat /sys/kernel/debug/tracing/events/block/block_rq_complete/format</span><br><span class="line">bpftrace -e &#x27;kprobe:blk_status_to_errno /arg0/ &#123; @[arg0]++ &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue /args-&gt;dev == 0/ &#123; @[kstack]++ &#125;&#x27;</span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O errors. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/args-&gt;error != <span class="number">0</span>/</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;device: %d,%d, sector: %d, bytes: %d, flags: %s, error: %d\n&quot;</span>,</span><br><span class="line">            args-&gt;dev &gt;&gt; <span class="number">20</span>, args-&gt;dev &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">20</span>) - <span class="number">1</span>), args-&gt;sector,</span><br><span class="line">            args-&gt;nr_sector * <span class="number">512</span>, args-&gt;rwbs, args-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_OK 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NOTSUPP         ((__force blk_status_t)1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TIMEOUT         ((__force blk_status_t)2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NOSPC           ((__force blk_status_t)3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TRANSPORT       ((__force blk_status_t)4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TARGET          ((__force blk_status_t)5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NEXUS           ((__force blk_status_t)6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_MEDIUM          ((__force blk_status_t)7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_PROTECTION      ((__force blk_status_t)8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_RESOURCE        ((__force blk_status_t)9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_IOERR           ((__force blk_status_t)10)</span></span><br></pre></td></tr></table></figure><p>mdflush<br>for tracing flush events from md</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/genhd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing md flush events... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %-6s %-16s %s&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;DEVICE&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:md_flush_request</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-6d %-16s %s\n&quot;</span>, pid, comm,</span><br><span class="line">            ((struct bio *)arg1)-&gt;bi_disk-&gt;disk_name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>iosched<br>traces the time that requests were queued in the I/O scheduler</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;linux/blkdev.h&gt;</span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O schedulers. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:__elv_add_request</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg1] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="variable">$r</span> = (struct request *)arg0;</span><br><span class="line">        @usecs[<span class="variable">$r</span>-&gt;q-&gt;elevator-&gt;<span class="built_in">type</span>-&gt;elevator_name] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / 1000);</span><br><span class="line">        delete(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching 5 probes...</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Warning: could not attach probe kprobe:blk_start_request, skipping.</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Error attaching probe: <span class="string">&#x27;kprobe:__elv_add_request&#x27;</span></span><br></pre></td></tr></table></figure><p>scsilatency<br> to trace SCSI commands with latency distributions</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;scsi/scsi_cmnd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing scsi latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// SCSI opcodes from scsi/scsi_proto.h; add more mappings if desired:</span></span><br><span class="line">        @opcode[<span class="number">0x00</span>] = <span class="string">&quot;TEST_UNIT_READY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x03</span>] = <span class="string">&quot;REQUEST_SENSE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x08</span>] = <span class="string">&quot;READ_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0a</span>] = <span class="string">&quot;WRITE_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0b</span>] = <span class="string">&quot;SEEK_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x12</span>] = <span class="string">&quot;INQUIRY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x18</span>] = <span class="string">&quot;ERASE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x28</span>] = <span class="string">&quot;READ_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2a</span>] = <span class="string">&quot;WRITE_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2b</span>] = <span class="string">&quot;SEEK_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x35</span>] = <span class="string">&quot;SYNCHRONIZE_CACHE&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_init_io</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_done,</span><br><span class="line">kprobe:scsi_mq_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $cmnd = (struct scsi_cmnd *)arg0;</span><br><span class="line">        $opcode = *$cmnd-&gt;req.cmd &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$opcode, @opcode[$opcode]] = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start); clear(@opcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@usecs[<span class="number">74</span>, ]:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">9</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>scsiresult</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_OK          0x00    <span class="comment">/* NO error                                */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_NO_CONNECT  0x01    <span class="comment">/* Couldn&#x27;t connect before timeout period  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_BUS_BUSY    0x02    <span class="comment">/* BUS stayed busy through time out period */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_TIME_OUT    0x03    <span class="comment">/* TIMED OUT for other reason              */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_BAD_TARGET  0x04    <span class="comment">/* BAD target.    </span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">#!/usr/bin/bpftrace</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">BEGIN</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        printf(&quot;Tracing scsi command results. Hit Ctrl-C to end.\n&quot;);</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">        // host byte codes, from include/scsi/scsi.h:</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x00] = &quot;DID_OK&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x01] = &quot;DID_NO_CONNECT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x02] = &quot;DID_BUS_BUSY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x03] = &quot;DID_TIME_OUT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x04] = &quot;DID_BAD_TARGET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x05] = &quot;DID_ABORT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x06] = &quot;DID_PARITY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x07] = &quot;DID_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x08] = &quot;DID_RESET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x09] = &quot;DID_BAD_INTR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0a] = &quot;DID_PASSTHROUGH&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0b] = &quot;DID_SOFT_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0c] = &quot;DID_IMM_RETRY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0d] = &quot;DID_REQUEUE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0e] = &quot;DID_TRANSPORT_DISRUPTED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0f] = &quot;DID_TRANSPORT_FAILFAST&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x10] = &quot;DID_TARGET_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x11] = &quot;DID_NEXUS_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x12] = &quot;DID_ALLOC_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x13] = &quot;DID_MEDIUM_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">        // status byte codes, from include/scsi/scsi_proto.h:</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x00] = &quot;SAM_STAT_GOOD&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x02] = &quot;SAM_STAT_CHECK_CONDITION&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x04] = &quot;SAM_STAT_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x08] = &quot;SAM_STAT_BUSY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x10] = &quot;SAM_STAT_INTERMEDIATE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x14] = &quot;SAM_STAT_INTERMEDIATE_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x18] = &quot;SAM_STAT_RESERVATION_CONFLICT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x22] = &quot;SAM_STAT_COMMAND_TERMINATED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x28] = &quot;SAM_STAT_TASK_SET_FULL&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x30] = &quot;SAM_STAT_ACA_ACTIVE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x40] = &quot;SAM_STAT_TASK_ABORTED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @[@host[(args-&gt;result &gt;&gt; 16) &amp; 0xff], @status[args-&gt;result &amp; 0xff]] =</span></span></span><br><span class="line"><span class="meta"><span class="comment">            count();</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">END</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        clear(@status);</span></span></span><br><span class="line"><span class="meta"><span class="comment">        clear(@host);</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">Attaching 3 probes...</span></span></span><br><span class="line"><span class="meta"><span class="comment">Tracing scsi command results. Hit Ctrl-C to end.</span></span></span><br><span class="line"><span class="meta"><span class="comment">^C</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">@[DID_OK, SAM_STAT_CHECK_CONDITION]: 1</span></span></span><br><span class="line"><span class="meta"><span class="comment">@[DID_OK, SAM_STAT_GOOD]: 1596</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">driver_byte &lt;&lt; 24 | host_byte &lt;&lt; 16 | msg_byte &lt;&lt; 8 | status_byte</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">bpftrace -lv t:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int host_no;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int channel;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int id;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int lun;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    int result;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int opcode;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int cmd_len;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int data_sglen;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int prot_sglen;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned char prot_op;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    __data_loc unsigned char[] cmnd;</span></span></span><br></pre></td></tr></table></figure><p>nvmelatency<br>traces the nvme storage driver and shows command latencies by disk and nvme command opcode</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> bpftrace -e &#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/blkdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/nvme.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing nvme command latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// from linux/nvme.h:</span></span><br><span class="line">        @ioopcode[<span class="number">0x00</span>] = <span class="string">&quot;nvme_cmd_flush&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x01</span>] = <span class="string">&quot;nvme_cmd_write&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x02</span>] = <span class="string">&quot;nvme_cmd_read&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x04</span>] = <span class="string">&quot;nvme_cmd_write_uncor&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x05</span>] = <span class="string">&quot;nvme_cmd_compare&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x08</span>] = <span class="string">&quot;nvme_cmd_write_zeroes&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x09</span>] = <span class="string">&quot;nvme_cmd_dsm&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0d</span>] = <span class="string">&quot;nvme_cmd_resv_register&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0e</span>] = <span class="string">&quot;nvme_cmd_resv_report&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x11</span>] = <span class="string">&quot;nvme_cmd_resv_acquire&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x15</span>] = <span class="string">&quot;nvme_cmd_resv_release&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_setup_cmd</span><br><span class="line">&#123;</span><br><span class="line">        $req = (struct request *)arg1;</span><br><span class="line">        <span class="keyword">if</span> ($req-&gt;rq_disk) &#123;</span><br><span class="line">                @start[arg1] = nsecs;</span><br><span class="line">                @cmd[arg1] = arg2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @admin_commands = count();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_complete_rq</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $req = (struct request *)arg0;</span><br><span class="line">        $cmd = (struct nvme_command *)@cmd[arg0];</span><br><span class="line">        $disk = $req-&gt;rq_disk;</span><br><span class="line">        $opcode = $cmd-&gt;common.opcode &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$disk-&gt;disk_name, @ioopcode[$opcode]] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[tid]); <span class="keyword">delete</span>(@cmd[tid]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@ioopcode); clear(@start); clear(@cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e &#x27;tracepoint:block:* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;kprobe:scsi* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @bytes = hist(args-&gt;bytes); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = sum(args-&gt;bytes); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_complete /args-&gt;error/ &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dev %d type %s error %d\n&quot;</span>, args-&gt;dev, args-&gt;rwbs, args-&gt;error); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;k:blk_start_plug &#123; @ts[arg0] = nsecs; &#125;</span><br><span class="line">    k:blk_flush_plug_list /@ts[arg0]/ &#123; @plug_ns = hist(nsecs - @ts[arg0]);</span><br><span class="line">    <span class="keyword">delete</span>(@ts[arg0]); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;k:blk_mq_start_request &#123; @swqueues = lhist(cpu, 0, 100, 1); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="comment">//IO type</span></span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = count(); &#125;&#x27;</span><br></pre></td></tr></table></figure><p>not work in centos kernel</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/dcache.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_unlink,tracepoint:syscalls:sys_enter_unlinkat &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s deleted by command &#x27;%s&#x27; with pid %d\n&quot;</span>,</span><br><span class="line">            str(args-&gt;pathname), comm, pid);</span><br><span class="line">    $p = curtask-&gt;real_parent;</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        $i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; ... whose parent is &#x27;%s&#x27; command with pid %d\n&quot;</span>,</span><br><span class="line">               $p-&gt;comm,</span><br><span class="line">               $p-&gt;tgid);</span><br><span class="line">        $p = $p-&gt;parent;</span><br><span class="line">        <span class="keyword">if</span> ($p == <span class="number">0</span> || $p-&gt;tgid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WARNING: Kernel does <span class="keyword">not</span> support bounded loops. Depending on LLVMs loop unroll to generate loadable code.</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    ~~~~~</span><br><span class="line">Attaching <span class="number">2</span> probes...</span><br><span class="line"></span><br><span class="line">Error <span class="built_in">log</span>:</span><br><span class="line">back-edge from insn <span class="number">162</span> to <span class="number">78</span></span><br></pre></td></tr></table></figure><h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e &#39;BEGIN &#123; $t &#x3D; (1, 2, &quot;string&quot;); printf(&quot;%d %d %s\n&quot;,$t.0, $t.1, $t.2); &#125;&#39;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">1 2 string</span><br><span class="line"></span><br><span class="line">bpftrace -e &#39;BEGIN &#123; $x &#x3D; 1&lt;&lt;16; printf(&quot;%d %d\n&quot;, (uint16)$x, $x); &#125;&#39;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">0 65536</span><br><span class="line"></span><br><span class="line"># gdb -q &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;boot&#x2F;vmlinux-&#96;uname -r&#96; --ex &#39;disassemble do_sys_open&#39;</span><br><span class="line">Reading symbols from &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;boot&#x2F;vmlinux-5.0.0-32-generic...done.</span><br><span class="line">Dump of assembler code for function do_sys_open:</span><br><span class="line">   0xffffffff812b2ed0 &lt;+0&gt;:     callq  0xffffffff81c01820 &lt;__fentry__&gt;</span><br><span class="line">   0xffffffff812b2ed5 &lt;+5&gt;:     push   %rbp</span><br><span class="line">   0xffffffff812b2ed6 &lt;+6&gt;:     mov    %rsp,%rbp</span><br><span class="line">   0xffffffff812b2ed9 &lt;+9&gt;:     push   %r15</span><br><span class="line">...</span><br><span class="line"># bpftrace -e &#39;kprobe:do_sys_open+9 &#123; printf(&quot;in here\n&quot;); &#125;&#39;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">in here</span><br><span class="line"></span><br><span class="line">## print args</span><br><span class="line"># bpftrace -e &#39;BEGIN &#123; printf(&quot;I got %d, %s (%d args)\n&quot;, $1, str($2), $#); &#125;&#39; 42 &quot;hello&quot;</span><br><span class="line">I got 42, hello (2 args)</span><br><span class="line"></span><br><span class="line">## args</span><br><span class="line">#!&#x2F;usr&#x2F;local&#x2F;bin&#x2F;bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">printf(&quot;Tracing block I&#x2F;O sizes &gt; %d bytes\n&quot;, $1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#x2F;args-&gt;bytes &gt; $1&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">@ &#x3D; hist(args-&gt;bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## that means args-&gt;bytes</span><br><span class="line">$ bpftrace -lv tracepoint:block:block_rq_issue</span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">    dev_t dev;</span><br><span class="line">    sector_t sector;</span><br><span class="line">    unsigned int nr_sector;</span><br><span class="line">    unsigned int bytes;</span><br><span class="line">    char rwbs[8];</span><br><span class="line">    char comm[16];</span><br><span class="line">    __data_loc char[] cmd;</span><br><span class="line"></span><br><span class="line">bpftrace -e &#39;BEGIN &#123; printf(&quot;%s\n&quot;, str(*kaddr(&quot;usbcore_name&quot;))); &#125;&#39;</span><br><span class="line">const char *usbcore_name &#x3D; &quot;usbcore&quot;;</span><br><span class="line"></span><br><span class="line">BPFTRACE_STRLEN&#x3D;200 bpftrace -e &#39;tracepoint:syscalls:sys_enter_write &#x2F;pid &#x3D;&#x3D; 23506&#x2F;</span><br><span class="line">    &#123; printf(&quot;&lt;%s&gt;\n&quot;, str(args-&gt;buf, args-&gt;count)); &#125;&#39;</span><br><span class="line"></span><br><span class="line">### demo </span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;bpftrace</span><br><span class="line">#include &lt;linux&#x2F;path.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;dcache.h&gt;</span><br><span class="line"></span><br><span class="line">kprobe:vfs_open &#x2F;comm &#x3D;&#x3D; &quot;dd&quot;&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">        @start[tid] &#x3D; nsecs;</span><br><span class="line">        printf(&quot;open path: %s, &quot;, str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br><span class="line">kretprobe:vfs_open &#x2F;comm &#x3D;&#x3D; &quot;dd&quot;&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot; pid: %d, comm: %s, open take time: %d \n&quot;, pid, comm, (nsecs-@start[tid]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:vfs_write &#x2F;comm &#x3D;&#x3D; &quot;dd&quot;&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">        @wstart[tid] &#x3D; nsecs;</span><br><span class="line">        printf(&quot;write path: %s, &quot;, str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:vfs_write &#x2F;comm &#x3D;&#x3D; &quot;dd&quot;&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot; pid: %d, comm: %s, write take time: %d \n&quot;, pid, comm, (nsecs-@wstart[tid]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END &#123;</span><br><span class="line">clear(@wstart); clear(@start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Got tcp rrt large than 999 µs</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace --unsafe</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in6.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* definitions.h:11:14: error: invalid application of &#x27;sizeof&#x27; to an incomplete type &#x27;struct sockaddr_in6&#x27;</span></span><br><span class="line"><span class="comment"> definitions.h:10:28: note: forward declaration of &#x27;struct sockaddr_in6&#x27;</span></span><br><span class="line"><span class="comment"> /usr/src/linux-headers-5.4.0-58-generic/include/uapi/linux/in6.h:struct sockaddr_in6 &#123; */</span></span><br><span class="line"></span><br><span class="line">tracepoint:tcp:tcp_probe</span><br><span class="line">&#123;</span><br><span class="line">  $t = elapsed;</span><br><span class="line">  $sadr = (struct sockaddr*)(args-&gt;saddr);</span><br><span class="line">  $dadr = (struct sockaddr*)(args-&gt;daddr);</span><br><span class="line">  $s = (struct sockaddr_in*)$sadr;</span><br><span class="line">  $d = (struct sockaddr_in*)$dadr;</span><br><span class="line">  $s = (struct sockaddr_in*)$sadr;</span><br><span class="line">  $d = (struct sockaddr_in*)$dadr;</span><br><span class="line"></span><br><span class="line">  $rtt = args-&gt;srtt;</span><br><span class="line"></span><br><span class="line">  #<span class="meta"># average</span></span><br><span class="line">  @rtt[ntop(AF_INET, $s-&gt;sin_addr.s_addr), args-&gt;sport] = avg($rtt/<span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">if</span> ($rtt &gt; <span class="number">999</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%4d.%09d sec: &quot;</span>, $t / <span class="number">1000000000</span>, $t % <span class="number">1000000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;src %s:%d, dst %s:%d RTT: %d.%03d ms\n&quot;</span>,ntop(AF_INET, $s-&gt;sin_addr.s_addr), args-&gt;sport, ntop(AF_INET, $d-&gt;sin_addr.s_addr), args-&gt;dport, $rtt/<span class="number">1000</span>, $rtt%<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Trace the latency from sys_enter_read to sys_exit_read and output block size counts</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN &#123;</span><br><span class="line">   <span class="keyword">if</span> ($<span class="number">1</span> == <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="built_in">printf</span> (<span class="string">&quot;Please input pid in first parameter&quot;</span>);</span><br><span class="line">     <span class="built_in">exit</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">profile:hz:<span class="number">9117</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_open</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @open_time[tid] = nsecs;</span><br><span class="line">  @open_name[tid] = args-&gt;filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_newfstat</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @fstat_time[tid] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_close</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @close_time[tid] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_unlink</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// @unlink_time[probe,tid] = nsecs;  could not write key to probe,tid</span></span><br><span class="line">  @unlink_time[tid] = nsecs;</span><br><span class="line">  @unlink_name[tid] = args-&gt;pathname;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_write,</span><br><span class="line">tracepoint:syscalls:sys_enter_read</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @rw_time[tid] = nsecs;</span><br><span class="line">  @rw_count[tid] = args-&gt;count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_open</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@open_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @open_delta[tid] = nsecs - @open_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms, flename: %s\n&quot;</span>, probe, tid, @open_delta[tid]/<span class="number">1000000</span>, @open_delta[tid]%<span class="number">1000000</span>, str(@open_name[tid]));</span><br><span class="line">     <span class="keyword">delete</span>(@open_time[tid]); <span class="keyword">delete</span>(@open_name[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_newfstat</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@fstat_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @fstat_delta[tid] = nsecs - @fstat_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms\n&quot;</span>, probe, tid, @fstat_delta[tid]/<span class="number">1000000</span>, @fstat_delta[tid]%<span class="number">1000000</span>);</span><br><span class="line">     <span class="keyword">delete</span>(@fstat_time[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_close</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@close_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @close_delta[tid] = nsecs - @close_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms\n&quot;</span>, probe, tid, @close_delta[tid]/<span class="number">1000000</span>, @close_delta[tid]%<span class="number">1000000</span>);</span><br><span class="line">     <span class="keyword">delete</span>(@close_time[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_unlink</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@unlink_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @unlink_delta[tid] = nsecs - @unlink_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms, flename: %s\n&quot;</span>, probe, tid, @unlink_delta[tid]/<span class="number">1000000</span>, @unlink_delta[tid]%<span class="number">1000000</span>, str(@unlink_name[tid]));</span><br><span class="line">     <span class="keyword">delete</span>(@unlink_time[tid]); <span class="keyword">delete</span>(@unlink_name[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_write,</span><br><span class="line">tracepoint:syscalls:sys_exit_read</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@rw_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">    @rw_delta[tid] = nsecs - @rw_time[tid];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms, block size: %d bytes\n&quot;</span>, probe, tid, @rw_delta[tid]/<span class="number">1000000</span>, @rw_delta[tid]%<span class="number">1000000</span>, @rw_count[tid]);</span><br><span class="line">    <span class="keyword">delete</span>(@rw_time[tid]); <span class="keyword">delete</span>(@rw_delta[tid]); <span class="keyword">delete</span>(@rw_count[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END &#123;</span><br><span class="line">   clear(@rw_time);</span><br><span class="line">   clear(@rw_delta);</span><br><span class="line">   clear(@rw_count);</span><br><span class="line">   clear(@unlink_name);</span><br><span class="line">   clear(@unlink_time);</span><br><span class="line">   clear(@unlink_delta);</span><br><span class="line">   clear(@open_name);</span><br><span class="line">   clear(@open_time);</span><br><span class="line">   clear(@open_delta);</span><br><span class="line">   clear(@close_time);</span><br><span class="line">   clear(@close_delta);</span><br><span class="line">   clear(@fstat_time);</span><br><span class="line">   clear(@fstat_delta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">start</span>[tid] = (nsecs, args-&gt;<span class="keyword">id</span>);</span><br><span class="line">.....</span><br><span class="line">$start_t = @<span class="keyword">start</span>[tid]<span class="number">.0</span>;</span><br></pre></td></tr></table></figure><p>context-switches</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$  bpftrace -l | grep software</span><br><span class="line">software:alignment-faults:</span><br><span class="line">software:bpf-output:</span><br><span class="line">software:context-switches:</span><br><span class="line">software:cpu-clock:</span><br><span class="line">software:cpu-migrations:</span><br><span class="line">software:dummy:</span><br><span class="line">software:emulation-faults:</span><br><span class="line">software:major-faults:</span><br><span class="line">software:minor-faults:</span><br><span class="line">software:page-faults:</span><br><span class="line">software:task-clock:</span><br><span class="line">kprobe:software_resume</span><br><span class="line">kprobe:led_stop_software_blink</span><br><span class="line"></span><br><span class="line">$ bpftrace -e  <span class="string">&#x27;software:context-switches:100 &#123; @[comm] = count(); &#125;&#x27;</span></span><br><span class="line">Attaching <span class="number">1</span> probe...</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">@[kworker/<span class="number">0</span>:<span class="number">3</span>]: <span class="number">1</span></span><br><span class="line">@[kworker/<span class="number">15</span>:<span class="number">1</span>]: <span class="number">1</span></span><br><span class="line">@[watchdog/<span class="number">7</span>]: <span class="number">1</span></span><br><span class="line">@[swapper/<span class="number">19</span>]: <span class="number">1</span></span><br><span class="line">@[watchdog/<span class="number">19</span>]: <span class="number">1</span></span><br><span class="line">@[systemd]: <span class="number">1</span></span><br><span class="line">@[swapper/<span class="number">14</span>]: <span class="number">1</span></span><br><span class="line">@[watchdog/<span class="number">8</span>]: <span class="number">2</span></span><br><span class="line">@[<span class="keyword">in</span>:imjournal]: <span class="number">3</span></span><br><span class="line">@[swapper/<span class="number">7</span>]: <span class="number">4</span></span><br><span class="line">@[rngd]: <span class="number">4</span></span><br><span class="line">@[swapper/<span class="number">5</span>]: <span class="number">4</span></span><br><span class="line">@[bpftrace]: <span class="number">5</span></span><br><span class="line">@[rcu_sched]: <span class="number">6</span></span><br><span class="line">@[atopacctd]: <span class="number">7</span></span><br><span class="line">@[kworker/u432:<span class="number">3</span>]: <span class="number">11</span></span><br><span class="line">@[swapper/<span class="number">15</span>]: <span class="number">11</span></span><br><span class="line">@[kworker/u432:<span class="number">0</span>]: <span class="number">11</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/mikepea/bpf-noodling">bpf-noodling</a></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env bpftrace</span></span><br><span class="line">/*</span><br><span class="line">  From <span class="built_in">read</span>(<span class="number">2</span>):</span><br><span class="line">    ssize_t <span class="built_in">read</span>(int fd, void *buf, size_t <span class="built_in">count</span>)</span><br><span class="line">  arg2 <span class="keyword">is</span> &#x27;<span class="built_in">count</span>&#x27; - <span class="keyword">the</span> num bytes <span class="built_in">read</span>.</span><br><span class="line"></span><br><span class="line">  So this reports reads <span class="keyword">that</span> are <span class="keyword">less than</span> <span class="number">16</span> bytes.</span><br><span class="line">*/</span><br><span class="line">kprobe:vfs_read /arg2 &lt; <span class="number">16</span>/ &#123;</span><br><span class="line">  printf(<span class="string">&quot;small read: %d byte buffer\n&quot;</span>, arg2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bpftrace</span></span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_nanosleep</span><br><span class="line">&#123;</span><br><span class="line">   printf(<span class="string">&quot;%s is sleeping.\n&quot;</span>, comm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bpftrace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sample one in 100 page faults, and record the process name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">software:page-faults:<span class="number">100</span> &#123; @[comm] = count(); &#125;</span><br></pre></td></tr></table></figure><p>Got open full path from the function have the pathname parameter</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/path.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class">enum </span>&#123;WALK_TRAILING = <span class="number">1</span>, WALK_MORE = <span class="number">2</span>, WALK_NOFOLLOW = <span class="number">4</span>&#125;;</span><br><span class="line"><span class="comment">//struct file *do_filp_open(int dfd, struct filename *pathname,const struct open_flags *op)</span></span><br><span class="line"><span class="comment">//The dfd means (default file descriptor)</span></span><br><span class="line"><span class="comment">//Note that the vfsmount which contains the lookup is determined by the first mountpoint the path lookup reaches – absolute paths start with the vfsmount of /, and relative paths start with the dfd(default file descriptor)&#x27;s vfsmount. Magic-links are only permitted if the vfsmount of the path is unchanged.</span></span><br><span class="line"><span class="comment">//dfd是传入的AT_FDCWD，其定义在 include/uapi/linux/fcntl.h。该值表明当 filename 为相对路径的情况下将当前进程的工作目录设置为起始路径。相对而言， 你可以在另一个系统调用 openat 中为这个起始路径指定一个目录， 此时 AT_FDCWD 就会被该目录的描述符所替代。</span></span><br><span class="line"><span class="comment">//If pathname is relative and dirfd is the special value AT_FDCWD, then pathname is interpreted relative to the current working directory of the calling process </span></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        printf(<span class="string">&quot;Tracing do_filp_open calls from %d\n&quot;</span>, $<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="symbol">kprobe:</span>do_filp_open</span><br><span class="line">&#123;</span><br><span class="line">        $filename = str(((struct filename *)arg1)-&gt;uptr);</span><br><span class="line">        printf(<span class="string">&quot;do_filp_open(dfd=%d, filename-&gt;name=%s)\n&quot;</span>, arg0, $filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e &#x27;profile:hz:99 /pid == <span class="number">2007</span>1/ &#123; @[ustack] = count(); &#125;&#x27;</span><br></pre></td></tr></table></figure><h3 id="user-space"><a href="#user-space" class="headerlink" title="user space"></a>user space</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"></span><br><span class="line">void print_curr_state_one(void)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the print current state one function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void print_curr_state_two(void)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the print current state two function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int exchg2(int px, int *py)</span><br><span class="line">&#123;</span><br><span class="line">   int tmp = px;</span><br><span class="line">   px = *py;</span><br><span class="line">   *py = tmp;</span><br><span class="line">   int reval=22;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;*px = %d, *py = %d. reval = %d\n&quot;</span>, px, *py, reval);</span><br><span class="line">   <span class="built_in">return</span> reval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">   int a = 4;</span><br><span class="line">   int b = 6;</span><br><span class="line">   int c = exchg2(a, &amp;b);</span><br><span class="line">    exchg2(a, &amp;b);</span><br><span class="line">   //<span class="keyword">while</span> (1) &#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;a = %d, b = %d, c = %d.\n&quot;</span>, a, b, c);</span><br><span class="line">     print_curr_state_one();</span><br><span class="line">     sleep(1);</span><br><span class="line">     print_curr_state_two();</span><br><span class="line">   //&#125;</span><br><span class="line">   <span class="built_in">return</span>(11);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:/root/test:exchg2 &#123; printf(&quot;arg0: %d, arg1: %d\n&quot;, arg0, *arg1); &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">arg0: 4, arg1: 6</span><br><span class="line">arg0: 4, arg1: 4</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uretprobe:/root/test:exchg2 &#123; printf(&quot;return: \&quot;%d\&quot;\n&quot;, retval);&#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line"><span class="built_in">return</span>: <span class="string">&quot;22&quot;</span></span><br><span class="line"><span class="built_in">return</span>: <span class="string">&quot;22&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;bcc-tools&quot;&gt;&lt;a href=&quot;#bcc-tools&quot; class=&quot;headerlink&quot; title=&quot;bcc tools&quot;&gt;&lt;/a&gt;bcc tools&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ./vfsstat 5 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TIME         READ/s  WRITE/s CREATE/s   OPEN/s  FSYNC/s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14:34:53:       575        7        0      537        0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14:34:58:       850        9        0      792        0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14:35:03:       842        8        0      791        0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14:35:08:       580        8        0      535        0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14:35:13:       839        8        0      789        0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$  bpftrace -e &lt;span class=&quot;string&quot;&gt;&amp;#x27;kprobe:vfs_* &amp;#123; @[probe] = count() &amp;#125;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Attaching 53 probes...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;^C&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_llseek]: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_fsync_range]: 33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_iter_write]: 61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_statfs]: 93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_statx_fd]: 469&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_statx]: 2299&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_getattr_nosec]: 2872&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_getattr]: 2873&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_write]: 3754&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_open]: 4965&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@[kprobe:vfs_read]: 8020&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;list-all-events&quot;&gt;&lt;a href=&quot;#list-all-events&quot; class=&quot;headerlink&quot; title=&quot;list all events&quot;&gt;&lt;/a&gt;list all events&lt;/h3&gt;</summary>
    
    
    
    <category term="Scripts" scheme="http://yoursite.com/categories/Scripts/"/>
    
    
    <category term="debug" scheme="http://yoursite.com/tags/debug/"/>
    
    <category term="trace" scheme="http://yoursite.com/tags/trace/"/>
    
  </entry>
  
  <entry>
    <title>Network bencharmk results</title>
    <link href="http://yoursite.com/2020/07/22/network-benchmark-result/"/>
    <id>http://yoursite.com/2020/07/22/network-benchmark-result/</id>
    <published>2020-07-22T09:04:45.000Z</published>
    <updated>2020-11-10T09:19:13.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> &#123;1..3&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   ssh <span class="variable">$ip1</span> <span class="string">&quot;iperf3  -c <span class="variable">$ip2</span> -P 1 -A 2,2 -M 8960 -S 0x08 -t 36000 -p 520<span class="variable">$&#123;k&#125;</span> &quot;</span> &amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>Hardware info</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">01:00.0 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line">01:00.1 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line">01:00.2 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line">01:00.3 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line"></span><br><span class="line">$ ethtool -i em2</span><br><span class="line">driver: bnx2x</span><br><span class="line">version: 1.713.36-0 storm 7.13.1.0</span><br><span class="line">firmware-version: FFV15.05.12 bc 7.14.16</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:01:00.1</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br><span class="line"></span><br><span class="line">$ ethtool -k em2</span><br><span class="line">Features <span class="keyword">for</span> em2:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">tx-checksum-ipv4: on</span><br><span class="line">tx-checksum-ip-generic: off [fixed]</span><br><span class="line">tx-checksum-ipv6: on</span><br><span class="line">tx-checksum-fcoe-crc: off [fixed]</span><br><span class="line">tx-checksum-sctp: off [fixed]</span><br><span class="line">scatter-gather: on</span><br><span class="line">tx-scatter-gather: on</span><br><span class="line">tx-scatter-gather-fraglist: off [fixed]</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">tx-tcp-segmentation: on</span><br><span class="line">tx-tcp-ecn-segmentation: on</span><br><span class="line">tx-tcp6-segmentation: on</span><br><span class="line">tx-tcp-mangleid-segmentation: off</span><br><span class="line">udp-fragmentation-offload: off [fixed]</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">large-receive-offload: on</span><br><span class="line">rx-vlan-offload: on [fixed]</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: off [fixed]</span><br><span class="line">receive-hashing: on</span><br><span class="line">highdma: on [fixed]</span><br><span class="line">rx-vlan-filter: on</span><br><span class="line">vlan-challenged: off [fixed]</span><br><span class="line">tx-lockless: off [fixed]</span><br><span class="line">netns-local: off [fixed]</span><br><span class="line">tx-gso-robust: off [fixed]</span><br><span class="line">tx-fcoe-segmentation: off [fixed]</span><br><span class="line">tx-gre-segmentation: on</span><br><span class="line">tx-ipip-segmentation: on</span><br><span class="line">tx-sit-segmentation: on</span><br><span class="line">tx-udp_tnl-segmentation: on</span><br><span class="line">fcoe-mtu: off [fixed]</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off</span><br><span class="line">rx-fcs: off [fixed]</span><br><span class="line">rx-all: off [fixed]</span><br><span class="line">tx-vlan-stag-hw-insert: off [fixed]</span><br><span class="line">rx-vlan-stag-hw-parse: off [fixed]</span><br><span class="line">rx-vlan-stag-filter: off [fixed]</span><br><span class="line">busy-poll: off [fixed]</span><br><span class="line">tx-gre-csum-segmentation: on</span><br><span class="line">tx-udp_tnl-csum-segmentation: on</span><br><span class="line">tx-gso-partial: on</span><br><span class="line">tx-sctp-segmentation: off [fixed]</span><br><span class="line">rx-gro-hw: off</span><br><span class="line">l2-fwd-offload: off [fixed]</span><br><span class="line">hw-tc-offload: off [fixed]</span><br><span class="line">rx-udp_tunnel-port-offload: on</span><br><span class="line"></span><br><span class="line">cat /proc/net/bonding/bond0</span><br><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line"></span><br><span class="line">Bonding Mode: IEEE 802.3ad Dynamic link aggregation</span><br><span class="line">Transmit Hash Policy: layer3+4 (1)</span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line"></span><br><span class="line">802.3ad info</span><br><span class="line">LACP rate: fast</span><br><span class="line">Min links: 0</span><br><span class="line">Aggregator selection policy (ad_select): stable</span><br><span class="line">System priority: 65535</span><br><span class="line">System MAC address: 18:66:da:91:a1:c2</span><br><span class="line">Active Aggregator Info:</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Number of ports: 2</span><br><span class="line">Actor Key: 15</span><br><span class="line">Partner Key: 5697</span><br><span class="line">Partner Mac Address: a0:a3:3b:a8:47:f1</span><br><span class="line"></span><br><span class="line">Slave Interface: em1</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 10000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 18:66:da:91:a1:c2</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Actor Churn State: none</span><br><span class="line">Partner Churn State: none</span><br><span class="line">Actor Churned Count: 0</span><br><span class="line">Partner Churned Count: 0</span><br><span class="line">details actor lacp pdu:</span><br><span class="line">    system priority: 65535</span><br><span class="line">    system mac address: 18:66:da:91:a1:c2</span><br><span class="line">    port key: 15</span><br><span class="line">    port priority: 255</span><br><span class="line">    port number: 1</span><br><span class="line">    port state: 63</span><br><span class="line">details partner lacp pdu:</span><br><span class="line">    system priority: 32768</span><br><span class="line">    system mac address: a0:a3:3b:a8:47:f1</span><br><span class="line">    oper key: 5697</span><br><span class="line">    port priority: 32768</span><br><span class="line">    port number: 72</span><br><span class="line">    port state: 61</span><br><span class="line"></span><br><span class="line">Slave Interface: em2</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 10000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 18:66:da:91:a1:c4</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Actor Churn State: none</span><br><span class="line">Partner Churn State: none</span><br><span class="line">Actor Churned Count: 0</span><br><span class="line">Partner Churned Count: 0</span><br><span class="line">details actor lacp pdu:</span><br><span class="line">    system priority: 65535</span><br><span class="line">    system mac address: 18:66:da:91:a1:c2</span><br><span class="line">    port key: 15</span><br><span class="line">    port priority: 255</span><br><span class="line">    port number: 2</span><br><span class="line">    port state: 63</span><br><span class="line">details partner lacp pdu:</span><br><span class="line">    system priority: 32768</span><br><span class="line">    system mac address: a0:a3:3b:a8:47:f1</span><br><span class="line">    oper key: 5697</span><br><span class="line">    port priority: 32768</span><br><span class="line">    port number: 24</span><br><span class="line">    port state: 61</span><br><span class="line"></span><br><span class="line">$ uname -r</span><br><span class="line">3.10.0-1062.18.1.el7.x86_64</span><br></pre></td></tr></table></figure><h3 id="Network-syscall-performance"><a href="#Network-syscall-performance" class="headerlink" title="Network syscall performance"></a>Network syscall performance</h3><h4 id="net-rx-action"><a href="#net-rx-action" class="headerlink" title="net_rx_action"></a>net_rx_action</h4><h5 id="default-config"><a href="#default-config" class="headerlink" title="default config"></a>default config</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   nsecs               : count     distribution</span><br><span class="line">     0 -&gt; 1          : 0        |                                        |</span><br><span class="line">     2 -&gt; 3          : 0        |                                        |</span><br><span class="line">     4 -&gt; 7          : 0        |                                        |</span><br><span class="line">     8 -&gt; 15         : 0        |                                        |</span><br><span class="line">    16 -&gt; 31         : 0        |                                        |</span><br><span class="line">    32 -&gt; 63         : 0        |                                        |</span><br><span class="line">    64 -&gt; 127        : 0        |                                        |</span><br><span class="line">   128 -&gt; 255        : 194      |                                        |</span><br><span class="line">   256 -&gt; 511        : 69595    |**                                      |</span><br><span class="line">   512 -&gt; 1023       : 166594   |******                                  |</span><br><span class="line">  1024 -&gt; 2047       : 1073825  |****************************************|</span><br><span class="line">  2048 -&gt; 4095       : 1060807  |*************************************** |</span><br><span class="line">  4096 -&gt; 8191       : 365389   |*************                           |</span><br><span class="line">  8192 -&gt; 16383      : 35479    |*                                       |</span><br><span class="line"> 16384 -&gt; 32767      : 3227     |                                        |</span><br><span class="line"> 32768 -&gt; 65535      : 64       |                                        |</span><br><span class="line"> 65536 -&gt; 131071     : 1        |                                        |</span><br><span class="line">131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">524288 -&gt; 1048575    : 208      |                                        |</span><br></pre></td></tr></table></figure><h5 id="default-config-and-set-the-maxinum-ring-buffer"><a href="#default-config-and-set-the-maxinum-ring-buffer" class="headerlink" title="default config and set the maxinum ring buffer"></a>default config and set the maxinum ring buffer</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 981      |                                        |</span><br><span class="line">       256 -&gt; 511        : 360423   |**                                      |</span><br><span class="line">       512 -&gt; 1023       : 826344   |******                                  |</span><br><span class="line">      1024 -&gt; 2047       : 5415487  |****************************************|</span><br><span class="line">      2048 -&gt; 4095       : 5400175  |*************************************** |</span><br><span class="line">      4096 -&gt; 8191       : 1886042  |*************                           |</span><br><span class="line">      8192 -&gt; 16383      : 228200   |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 17444    |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 685      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 0        |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 1132     |                                        |</span><br></pre></td></tr></table></figure><h5 id="modify-sysctl-conf-and-the-default-ring-buffer"><a href="#modify-sysctl-conf-and-the-default-ring-buffer" class="headerlink" title="modify sysctl.conf and the default ring buffer"></a>modify sysctl.conf and the default ring buffer</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">     nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 277      |                                        |</span><br><span class="line">       256 -&gt; 511        : 359712   |****                                    |</span><br><span class="line">       512 -&gt; 1023       : 2159666  |*****************************           |</span><br><span class="line">      1024 -&gt; 2047       : 1922971  |**************************              |</span><br><span class="line">      2048 -&gt; 4095       : 2900044  |****************************************|</span><br><span class="line">      4096 -&gt; 8191       : 867530   |***********                             |</span><br><span class="line">      8192 -&gt; 16383      : 98313    |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 4252     |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 126      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 9        |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 1476     |                                        |</span><br><span class="line">   1048576 -&gt; 2097151    : 1        |                                        |</span><br><span class="line">Detaching...</span><br><span class="line"></span><br><span class="line">Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</span><br><span class="line">Average:        bond0 375553.38 374625.60 2487152.11 2487119.93      0.00      0.00      2.04</span><br><span class="line">Average:           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em3      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em1 194263.43 193304.15 1286454.93 1286414.18      0.00      0.00      1.05</span><br><span class="line">Average:          em4      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em2 181289.94 181321.45 1200697.18 1200705.74      0.00      0.00      0.98</span><br><span class="line"></span><br><span class="line">Average:     atmptf/s  estres/s retrans/s isegerr/s   orsts/s</span><br><span class="line">Average:         0.00      0.00      1.27      0.00      0.00</span><br></pre></td></tr></table></figure><h5 id="modify-sysctl-conf-and-the-maxinum-ring-buffer"><a href="#modify-sysctl-conf-and-the-maxinum-ring-buffer" class="headerlink" title="modify sysctl.conf and the maxinum ring buffer"></a>modify sysctl.conf and the maxinum ring buffer</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">./funclatency net_rx_action</span><br><span class="line">Tracing 1 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;net_rx_action&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 359      |                                        |</span><br><span class="line">       256 -&gt; 511        : 629512   |********                                |</span><br><span class="line">       512 -&gt; 1023       : 2571487  |********************************        |</span><br><span class="line">      1024 -&gt; 2047       : 2720136  |**********************************      |</span><br><span class="line">      2048 -&gt; 4095       : 3120474  |****************************************|</span><br><span class="line">      4096 -&gt; 8191       : 657204   |********                                |</span><br><span class="line">      8192 -&gt; 16383      : 114649   |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 7222     |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 177      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 12       |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 2070     |                                        |</span><br><span class="line">   1048576 -&gt; 2097151    : 3        |                                        |</span><br><span class="line">Detaching...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</span><br><span class="line">Average:        bond0 363638.62 362216.28 2404216.56 2404239.59      0.00      0.00      2.00</span><br><span class="line">Average:           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em3      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em1 182095.82 181514.64 1202063.97 1202059.47      0.00      0.00      1.02</span><br><span class="line">Average:          em4      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em2 181542.80 180701.64 1202152.59 1202180.12      0.00      0.00      0.99</span><br><span class="line"></span><br><span class="line">Average:     atmptf/s  estres/s retrans/s isegerr/s   orsts/s</span><br><span class="line">Average:         0.00      0.00      1.02      0.00      0.00</span><br><span class="line"></span><br><span class="line">again</span><br><span class="line">./funclatency net_rx_action</span><br><span class="line">Tracing 1 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;net_rx_action&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1251     |                                        |</span><br><span class="line">       256 -&gt; 511        : 1054301  |*********                               |</span><br><span class="line">       512 -&gt; 1023       : 4311900  |*************************************   |</span><br><span class="line">      1024 -&gt; 2047       : 4468684  |**************************************  |</span><br><span class="line">      2048 -&gt; 4095       : 4609367  |****************************************|</span><br><span class="line">      4096 -&gt; 8191       : 902735   |*******                                 |</span><br><span class="line">      8192 -&gt; 16383      : 156803   |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 14726    |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 313      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 23       |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 1        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 1        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 3230     |                                        |</span><br><span class="line">   1048576 -&gt; 2097151    : 2        |                                        |</span><br><span class="line">Detaching...</span><br></pre></td></tr></table></figure><h5 id="the-sysctl-conf"><a href="#the-sysctl-conf" class="headerlink" title="the sysctl.conf"></a>the sysctl.conf</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line">vm.min_free_kbytes=270336</span><br><span class="line">kernel.numa_balancing=0</span><br><span class="line">fs.pipe-max-size=104857600</span><br><span class="line">net.core.busy_poll = 50</span><br><span class="line">net.core.busy_read = 50</span><br><span class="line">kernel.sched_migration_cost_ns=500000</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=</summary>
      
    
    
    
    <category term="Benchmark" scheme="http://yoursite.com/categories/Benchmark/"/>
    
    
    <category term="test" scheme="http://yoursite.com/tags/test/"/>
    
    <category term="network" scheme="http://yoursite.com/tags/network/"/>
    
  </entry>
  
  <entry>
    <title>The mdraid info</title>
    <link href="http://yoursite.com/2020/06/01/mdadm/"/>
    <id>http://yoursite.com/2020/06/01/mdadm/</id>
    <published>2020-06-01T04:40:20.000Z</published>
    <updated>2021-08-02T09:25:38.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ops"><a href="#ops" class="headerlink" title="ops"></a>ops</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mdadm --manage /dev/md0 --fail /dev/vdb1</span><br><span class="line">mdadm --manage /dev/md0 --remove /dev/vdb1</span><br><span class="line">mdadm --manage --stop /dev/vdb1</span><br><span class="line"></span><br><span class="line"><span class="comment">##re-add there is the partition table in new vdb</span></span><br><span class="line">$ mdadm --zero-superblock /dev/vdb1</span><br><span class="line">$ mdadm --zero-superblock /dev/vdb2</span><br><span class="line"></span><br><span class="line"><span class="comment">#backup partition table by sgdisk</span></span><br><span class="line">$ sgdisk --backup=vdb_part_1 /dev/vdb</span><br><span class="line">$ sgdisk --load-backup=vdb_part_1 /dev/vdb</span><br><span class="line"></span><br><span class="line">$ mdadm --manage /dev/md0 --add /dev/vdb1</span><br><span class="line">$ mdadm --manage /dev/md1 --add /dev/vdb2</span><br><span class="line"></span><br><span class="line"><span class="comment">### assemble the raid, and the config file in the /etc/mdadm.conf</span></span><br><span class="line">$ mdadm --assemble --scan --verbose /dev/md2 /dev/disk/by-id/3500001-part1 /dev/disk/by-id/3500002-part1 /dev/disk/by-id/3500003-part1 /dev/disk/by-id/3500004-part1</span><br></pre></td></tr></table></figure><h3 id="scrub-mdraid"><a href="#scrub-mdraid" class="headerlink" title="scrub mdraid"></a>scrub mdraid</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> check &gt; /sys/block/mdX/md/sync_action</span><br><span class="line">$ <span class="built_in">echo</span> repair &gt; /sys/block/mdX/md/sync_action</span><br><span class="line">$ <span class="built_in">echo</span> idle &gt; /sys/block/mdX/md/sync_action</span><br></pre></td></tr></table></figure><h3 id="About-linux-soft-raid5"><a href="#About-linux-soft-raid5" class="headerlink" title="About linux soft raid5"></a>About linux soft raid5</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Raid 4/5/6 could include an extra disk <span class="keyword">for</span> data cache besides normal RAID disks. </span><br><span class="line">The role of RAID disks isn<span class="string">&#x27;t changed with the cache disk. </span></span><br><span class="line"><span class="string">The cache disk caches data to the RAID disks. The cache can be in write-through (supported since 4.4) or write-back mode (supported since 4.10). </span></span><br><span class="line"><span class="string">mdadm (supported since3.4) has a new option &#x27;</span>--write-journal<span class="string">&#x27; to create array with cache. Please refer to mdadm manual for details. By default (RAID array starts), the cache is in write-through mode. A user can switch it to write-back mode by:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo &quot;write-back&quot; &gt; /sys/block/md0/md/journal_mode</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">And switch it back to write-through mode by:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo &quot;write-through&quot; &gt; /sys/block/md0/md/journal_mode</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In both modes, all writes to the array will hit cache disk first. This means</span></span><br><span class="line"><span class="string">the cache disk must be fast and sustainable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /sys/block/md0/md/stripe_cache_size</span></span><br><span class="line"><span class="string">1024</span></span><br></pre></td></tr></table></figure><p>The stripe_cache_size only be set to 16~2048, you can’ t disable it, the write hole will cause data loss<br>So the raid10 or raid0 is the better choice than linux soft raid 4/5/6<br>If you add the journal device, the too many performance impact in the raid device  </p><h3 id="How-to-backup-mdraid-info-by-dd"><a href="#How-to-backup-mdraid-info-by-dd" class="headerlink" title="How to backup mdraid info by dd"></a><a href="https://raid.wiki.kernel.org/index.php/RAID_superblock_formats">How to backup mdraid info by dd</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">md8 : active raid1 sde1[1] sda1[0]</span><br><span class="line">      468717568 blocks super 1.2 [2/2] [UU]</span><br><span class="line">      bitmap: 0/4 pages [0KB], 65536KB chunk</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sda1 of=./sda1 bs=1M count=1</span><br><span class="line"></span><br><span class="line">$ hexdump -C sda1 | head -n 20</span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">Per-Array Identification &amp; Configuration area:16 Bytes</span><br><span class="line">                                                  0xc~0xf: padding block 0 </span><br><span class="line">00001000  <span class="built_in">fc</span> 4e 2b a9 01 00 00 00      01 00 00 00 00 00 00 00  |.N+.............|</span><br><span class="line">Magic num: a92b4efc Major version:1    0x8~0xb bit fearure_map:value 1 offset 0  raid map is used</span><br><span class="line">                                                   value 2 offset 1  raid recovery is progress</span><br><span class="line">                                                   value 4 offset 2 raid reshape is <span class="keyword">in</span> progress</span><br><span class="line">                                                   the others: undefined/reserved</span><br><span class="line"></span><br><span class="line">section: Per-Array Identification &amp; Configuration area 84 Bytes  </span><br><span class="line">          &lt;----------------------uuid--------------------&gt; 0x10-0x1f 16</span><br><span class="line">00001010  cb df 6a 02 54 1a 01 76  9b 9c 29 fe ab 08 8c a0  |..j.T..v..).....|</span><br><span class="line">/dev/sda1: UUID=<span class="string">&quot;cbdf6a02-541a-0176-9b9c-29feab088ca0&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;--------------------------name <span class="keyword">for</span> the array------------&gt; 0x20-0x3f 32</span><br><span class="line">00001020  74 65 73 74 2d 74 65 73  74 2d 61 31 31 2d 32 2e  |test-test-a11-2.|</span><br><span class="line">00001030  74 65 73 74 2e 73 7a 2e  68 70 63 3a 38 00 00 00  |test.sz.hpc:8...|</span><br><span class="line"></span><br><span class="line">ctime(lower 40bit are secs,high 24 bits are microsecs)</span><br><span class="line">                    |               raid1       0 means left asymmetric</span><br><span class="line">                    |                 |            |</span><br><span class="line">00001040  10 77 cc 5e 00 00 00 00  01 00 00 00 00 00 00 00  |.w.^............|a</span><br><span class="line"></span><br><span class="line">         size of component devices(<span class="keyword">in</span> <span class="comment"># of 512-byte sectors),echo $((16#37e02000))=937435136</span></span><br><span class="line">                     |             chucksize not used <span class="keyword">in</span> raid1,linear,multipath</span><br><span class="line">                     |                  |        raid disk(02 means low bit, only 2 x devs to mirror)</span><br><span class="line">00001050  00 20 e0 37 00 00 00 00  00 00 00 00 02 00 00 00  |. .7............|</span><br><span class="line"></span><br><span class="line">          of sectors after superblock that bitmap starts</span><br><span class="line">               |     </span><br><span class="line">00001060  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">Section: RAID-Reshape In-Process Metadata Storage/Recovery area 28 Bytes</span><br><span class="line">         he new RAID level being reshaped-to</span><br><span class="line">                           |       Next address of the array to reshape</span><br><span class="line">                                              |</span><br><span class="line">00001060              00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">     change <span class="keyword">in</span> <span class="comment"># of raid disks</span></span><br><span class="line">               |   new layout <span class="keyword">for</span> array</span><br><span class="line">               |           |      New chunk size; padding block</span><br><span class="line">               |           |            |           |</span><br><span class="line">00001070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Section: This-Component-Device Information area 64Bytes</span><br><span class="line"> the sector <span class="comment"># upon which data starts, sectors in the device that are used for data</span></span><br><span class="line">                     |                        |</span><br><span class="line">00001080  00 08 04 00 00 00 00 00  00 20 e0 37 00 00 00 00  |......... .7....|</span><br><span class="line">of the sector upon <span class="built_in">which</span> this superblock starts</span><br><span class="line">                     |              sectors before this offset (from data_offset) have been recovered</span><br><span class="line">00001090  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">           dev_number</span><br><span class="line">               |      Number of read-errors that were corrected by re-writing</span><br><span class="line">               |           |                uuid</span><br><span class="line">000010a0  00 00 00 00 00 00 00 00  07 a8 e4 bf b5 6f c7 d6  |.............o..|</span><br><span class="line">                   uuid           devflags  Padding block 2(1 bit)</span><br><span class="line">                    |              |  Padding block 2 (7 bit)</span><br><span class="line">000010b0  90 d1 9b 62 bf 89 <span class="built_in">cd</span> e7  00 00 08 00 10 00 00 00  |...b............|</span><br><span class="line"></span><br><span class="line">Section: Array-State Information area 64Btes</span><br><span class="line">Time of last superblock update    Event Count <span class="keyword">for</span> the Array</span><br><span class="line">                     |                        |</span><br><span class="line">000010c0  5a 73 d4 5e 00 00 00 00  e6 05 00 00 00 00 00 00  |Zs.^............|</span><br><span class="line"></span><br><span class="line">      Event Count <span class="keyword">for</span> the Array    sb_csum        max_dev 0x80=128</span><br><span class="line">                     |                  |           |</span><br><span class="line">000010d0  ff ff ff ff ff ff ff ff  cf 29 76 cf 80 00 00 00  |.........)v.....|</span><br><span class="line"></span><br><span class="line">&lt;----32Bytes------------zero---------padding-------------&gt;</span><br><span class="line">000010e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">000010f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">Section: Device-Roles (Positions-in-Array) area</span><br><span class="line">Length: Variable number of bytes (but at least 768 bytes?)</span><br><span class="line">2 Bytes per device <span class="keyword">in</span> the array, including both spare-devices and faulty-devices</span><br><span class="line">*</span><br><span class="line">00001100  00 00 01 00 ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">00001110  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">          of sectors after superblock that bitmap starts</span><br><span class="line">               |</span><br><span class="line"><span class="number">00001060</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br></pre></td></tr></table></figure><p>In mdraid superblock, you could see bitmap starts at 8 x 512B=4096<br>You could see “bitm” magic num start at 0x1000=4096</p><p>You could see the data update from 0x1200, so you could backup first 4608 Bytes in raid1<br>dd if=/dev/sdb1 of=sdb1_superblock bs=1 count=4608</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line">*</span><br><span class="line"><span class="number">00001000</span>  fc <span class="number">4</span>e <span class="number">2</span>b a9 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.N+.............|</span><br><span class="line"><span class="number">00001010</span>  a3 <span class="number">00</span> <span class="number">8f</span> <span class="number">75</span> <span class="number">49</span> <span class="number">1</span>d ee e6  <span class="number">38</span> e6 cb d0 e5 <span class="number">3</span>b <span class="number">8</span>b d2  |...uI..<span class="number">.8</span>....;..|</span><br><span class="line"><span class="number">00001020</span>  <span class="number">74</span> <span class="number">65</span> <span class="number">73</span> <span class="number">74</span> <span class="number">2</span>d <span class="number">74</span> <span class="number">65</span> <span class="number">73</span>  <span class="number">74</span> <span class="number">2</span>d <span class="number">61</span> <span class="number">31</span> <span class="number">31</span> <span class="number">2</span>d <span class="number">32</span> <span class="number">2</span>e  |test-test-a11<span class="number">-2.</span>|</span><br><span class="line"><span class="number">00001030</span>  <span class="number">74</span> <span class="number">65</span> <span class="number">73</span> <span class="number">74</span> <span class="number">2</span>e <span class="number">73</span> <span class="number">7</span>a <span class="number">2</span>e  <span class="number">68</span> <span class="number">70</span> <span class="number">63</span> <span class="number">3</span>a <span class="number">30</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |test.sz.hpc:<span class="number">0.</span>..|</span><br><span class="line"><span class="number">00001040</span>  <span class="number">16</span> <span class="number">71</span> cc <span class="number">5</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.q.^............|</span><br><span class="line"><span class="number">00001050</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">49</span> ba <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |..I.............|</span><br><span class="line"><span class="number">00001060</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00001070</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00001080</span>  <span class="number">00</span> <span class="number">08</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">49</span> ba <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |..........I.....|</span><br><span class="line"><span class="number">00001090</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">000010</span>a0  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  d5 <span class="number">31</span> <span class="number">5f</span> <span class="number">6</span>a c9 <span class="number">58</span> c2 a0  |........<span class="number">.1</span>_j.X..|</span><br><span class="line"><span class="number">000010</span>b0  <span class="number">55</span> <span class="number">50</span> <span class="number">81</span> dc <span class="number">35</span> <span class="number">4</span>b d1 e3  <span class="number">00</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |UP.<span class="number">.5</span>K..........|</span><br><span class="line"><span class="number">000010</span>c0  <span class="number">5</span>a <span class="number">99</span> d4 <span class="number">5</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>b <span class="number">0</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |Z..^............|</span><br><span class="line"><span class="number">000010</span>d0  ff ff ff ff ff ff ff ff  b5 <span class="number">64</span> <span class="number">59</span> a7 <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.........dY.....|</span><br><span class="line"><span class="number">000010e0</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line">*</span><br><span class="line"><span class="number">00001100</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line"><span class="number">00001110</span>  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line"><span class="number">00001200</span>  e8 <span class="number">0f</span> a4 c4 ee <span class="number">8</span>d <span class="number">1</span>a <span class="number">13</span>  fd <span class="number">81</span> a0 d0 <span class="number">6</span>b ef c3 <span class="number">10</span>  |............k...|</span><br><span class="line"><span class="number">00001210</span>  <span class="number">3f</span> <span class="number">90</span> <span class="number">15</span> <span class="number">39</span> <span class="number">9</span>d <span class="number">95</span> <span class="number">0</span>d <span class="number">1</span>d  <span class="number">07</span> <span class="number">32</span> <span class="number">03</span> df <span class="number">28</span> <span class="number">16</span> cc <span class="number">06</span>  |?.<span class="number">.9</span>....<span class="number">.2</span>..(...|</span><br><span class="line"><span class="number">00001220</span>  <span class="number">40</span> e6 dc <span class="number">82</span> <span class="number">43</span> <span class="number">13</span> <span class="number">36</span> <span class="number">1</span>e  c8 <span class="number">9</span>c <span class="number">3</span>b fd f9 <span class="number">00</span> e5 <span class="number">15</span>  |@...C<span class="number">.6</span>...;.....|</span><br><span class="line"><span class="number">00001230</span>  <span class="number">99</span> <span class="number">73</span> <span class="number">43</span> <span class="number">71</span> <span class="number">81</span> a1 b7 <span class="number">19</span>  <span class="number">73</span> ee <span class="number">5</span>b <span class="number">74</span> <span class="number">8</span>e <span class="number">3</span>b <span class="number">65</span> <span class="number">09</span>  |.sCq....s.[t.;e.|</span><br><span class="line"><span class="number">00001240</span>  ce fd <span class="number">51</span> d7 <span class="number">43</span> <span class="number">6</span>d ca <span class="number">07</span>  b9 <span class="number">3f</span> <span class="number">03</span> <span class="number">7</span>c ff <span class="number">61</span> <span class="number">79</span> <span class="number">1f</span>  |..Q.Cm...?.|.ay.|</span><br><span class="line"><span class="number">00001250</span>  f7 e7 a3 <span class="number">4f</span> <span class="number">3</span>e <span class="number">6</span>e be <span class="number">16</span>  fe fc f8 d5              |...O&gt;n......|</span><br></pre></td></tr></table></figure><h3 id="mdadm-raid5-xor"><a href="#mdadm-raid5-xor" class="headerlink" title="mdadm raid5 xor"></a>mdadm raid5 xor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c means cksum, i means input</span><br><span class="line">c[old]=i[old0] xor i[1] ...xor i[n]</span><br><span class="line">c[new]=i[new0] xor i[1]....xor i[n]</span><br><span class="line">1 xor 0=1  0 xor 0=0 means i xor 0=i</span><br><span class="line"> </span><br><span class="line">c[new]=i[new0] xor i[1]...xor i[n] xor 0</span><br><span class="line">0 = i[old0] xor i[old0]</span><br><span class="line">                                          ------------c[old]</span><br><span class="line">                                          |</span><br><span class="line">c[new]=i[new0] xor i[old0] xor (i[old0] xor i[1]...xor i[n])</span><br><span class="line">c[new]=i[new0] xor i[old0] xor c[old] </span><br></pre></td></tr></table></figure><p>don’t need to read each block, in raid5 4k data, only 2 device could be read, more device means more iops<br>For reduce read amplification, it will compare the old data size (i[old0] &gt; i[2]+..i[n] or i[old0] &lt; i[2]+..i[n])<br>rmw:read-modified-write, i[old0] &lt; i[2]+..i[n], only read i[old0], just read i[old0] and the old parity c[old]<br>rcw:read-construct-write, i[old0] &gt; i[2]+..i[n], only read i[2]..i[n], just read i[2]..i[n] and the old parity c[old]   </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ops&quot;&gt;&lt;a href=&quot;#ops&quot; class=&quot;headerlink&quot; title=&quot;ops&quot;&gt;&lt;/a&gt;ops&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;sp</summary>
      
    
    
    
    <category term="Storage" scheme="http://yoursite.com/categories/Storage/"/>
    
    
    <category term="md" scheme="http://yoursite.com/tags/md/"/>
    
    <category term="raid" scheme="http://yoursite.com/tags/raid/"/>
    
  </entry>
  
  <entry>
    <title>C lang</title>
    <link href="http://yoursite.com/2020/03/24/c/"/>
    <id>http://yoursite.com/2020/03/24/c/</id>
    <published>2020-03-24T08:29:06.000Z</published>
    <updated>2020-10-11T11:40:49.416Z</updated>
    
    <content type="html"><![CDATA[<h3 id="FIO-write"><a href="#FIO-write" class="headerlink" title="FIO write"></a>FIO write</h3><p>if not support fallocate, fio will switch to fadvise64 to write file<br>looks like fadvise64 cause a lot of file system fragment.</p><h3 id="10-billion-or-more-files-in-the-posix-filesystem-directory"><a href="#10-billion-or-more-files-in-the-posix-filesystem-directory" class="headerlink" title="10 billion or more files in the posix filesystem directory"></a>10 billion or more files in the posix filesystem directory</h3><p>ls take a long time, maybe three days or more<br>I moidfy form some C demo files just list some files, the program will exit , not full list</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ time ./walk /tank/<span class="built_in">test</span>/dir1 1000 | wc -l</span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line">real    0m0.016s</span><br><span class="line">user    0m0.000s</span><br><span class="line">sys     0m0.016s</span><br><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ time ls /tank/<span class="built_in">test</span>/dir1/ | wc -l</span><br><span class="line">858601</span><br><span class="line"></span><br><span class="line">real    0m3.320s</span><br><span class="line">user    0m2.841s</span><br><span class="line">sys     0m0.476s</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *fullpath;</span><br><span class="line"><span class="keyword">int</span> global_count=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readfile</span><span class="params">(<span class="keyword">char</span> *k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//printf (&quot;print global_count value: %d\n&quot;,global_count);</span></span><br><span class="line">    DIR * dp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">dirrp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    p = fullpath + <span class="built_in">strlen</span>(fullpath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == lstat(fullpath,&amp;buf))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s[lstat]%s\n&quot;</span>,fullpath,strerror(errno));</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(S_ISDIR(buf.st_mode)==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;file: %s \n&quot;</span>,k); <span class="comment">// output file name</span></span><br><span class="line">        global_count--;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;/&#x27;</span> != *(p<span class="number">-1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">*p++ = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">*p = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dir %s:\n&quot;</span>,fullpath); <span class="comment">//output dir name</span></span><br><span class="line">    global_count--;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == (dp=opendir(fullpath)))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s[opendir]%s\n&quot;</span>,fullpath,strerror(errno));</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">NULL</span> != (dirrp=readdir(dp)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((global_count &lt;= <span class="number">1</span> ))</span><br><span class="line">           <span class="keyword">goto</span> goout;</span><br><span class="line"><span class="keyword">if</span>((<span class="built_in">strcmp</span>(dirrp-&gt;d_name,<span class="string">&quot;.&quot;</span>)==<span class="number">0</span>) || (<span class="built_in">strcmp</span>(dirrp-&gt;d_name,<span class="string">&quot;..&quot;</span>)==<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"><span class="built_in">strcpy</span>(p,dirrp-&gt;d_name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span> == readfile(p))</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    p[<span class="number">-1</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( <span class="number">-1</span> == closedir(dp))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s[closedir]%s\n&quot;</span>,fullpath,strerror(errno));</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">goout:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Usage:%s &lt;Dir name&gt; &lt;List number&gt;\n&quot;</span>,argv[<span class="number">0</span>]+<span class="number">2</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fullpath = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*PATH_MAX);</span><br><span class="line">    <span class="built_in">memset</span>(fullpath,<span class="number">0</span>,PATH_MAX);</span><br><span class="line">    global_count=atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">strcpy</span>(fullpath,argv[<span class="number">1</span>]);</span><br><span class="line">    readfile(fullpath);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="C-convert-string-to-number"><a href="#C-convert-string-to-number" class="headerlink" title="C convert string to number"></a>C convert string to number</h5><p>int atoi(const char *nptr);<br>global_count=atoi(argv[2]);</p><h5 id="memset"><a href="#memset" class="headerlink" title="memset"></a><a href="https://www.geeksforgeeks.org/memset-c-example/">memset</a></h5><p>void *memset(void *ptr, int x, size_t n);<br>// ptr ==&gt; Starting address of memory to be filled<br>// x   ==&gt; Value to be filled<br>// n   ==&gt; Number of bytes to be filled starting<br>//         from ptr to be filled</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C program to demonstrate working of memset() </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; </span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printArray</span><span class="params">(<span class="keyword">int</span> arr[], <span class="keyword">int</span> n)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) </span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]); </span><br><span class="line">&#125; </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">10</span>; </span><br><span class="line">    <span class="keyword">int</span> arr[n]; </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Fill whole array with 0. </span></span><br><span class="line">    <span class="built_in">memset</span>(arr, <span class="number">0</span>, n*<span class="keyword">sizeof</span>(arr[<span class="number">0</span>])); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Array after memset()\n&quot;</span>); </span><br><span class="line">    printArray(arr, n); </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; </span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">50</span>] = <span class="string">&quot;GeeksForGeeks is for programming geeks.&quot;</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nBefore memset(): %s\n&quot;</span>, str); </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Fill 8 characters starting from str[13] with &#x27;.&#x27; </span></span><br><span class="line">    <span class="built_in">memset</span>(str + <span class="number">13</span>, <span class="string">&#x27;.&#x27;</span>, <span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>)); </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After memset():  %s&quot;</span>, str); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h5 id="Some-struct"><a href="#Some-struct" class="headerlink" title="Some struct"></a>Some struct</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/include/dirent.h</span></span><br><span class="line"></span><br><span class="line">/* This is the data <span class="built_in">type</span> of directory stream objects.</span><br><span class="line">   The actual structure is opaque to users.  */</span><br><span class="line">typedef struct __dirstream DIR;</span><br><span class="line"></span><br><span class="line">struct __dirstream   </span><br><span class="line">   &#123;   </span><br><span class="line">    void *__fd;    </span><br><span class="line">    char *__data;    </span><br><span class="line">    int __entry_data;    </span><br><span class="line">    char *__ptr;    </span><br><span class="line">    int __entry_ptr;    </span><br><span class="line">    size_t __allocation;    </span><br><span class="line">    size_t __size;    </span><br><span class="line">    __libc_lock_define (, __lock)    </span><br><span class="line">   &#125;; </span><br><span class="line"></span><br><span class="line">struct dirent   </span><br><span class="line">&#123;   </span><br><span class="line"> long d_ino; /* inode number */</span><br><span class="line"> off_t d_off; /* offset to this dirent */</span><br><span class="line"> unsigned short d_reclen; /* length of this d_name */</span><br><span class="line"> unsigned char d_type; /* the <span class="built_in">type</span> of d_name */</span><br><span class="line">long d_ino; / char d_name [NAME_MAX+1]; /* file name (null-terminated) */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /usr/include/asm/stat.h</span></span><br><span class="line"><span class="comment">#define STAT64_HAS_BROKEN_ST_INO        1</span></span><br><span class="line"></span><br><span class="line">/* This matches struct stat64 <span class="keyword">in</span> glibc2.1, hence the absolutely</span><br><span class="line"> * insane amounts of padding around dev_t<span class="string">&#x27;s.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">struct stat64 &#123;</span></span><br><span class="line"><span class="string">        unsigned long long      st_dev;</span></span><br><span class="line"><span class="string">        unsigned char   __pad0[4];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   __st_ino;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned int    st_mode;</span></span><br><span class="line"><span class="string">        unsigned int    st_nlink;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_uid;</span></span><br><span class="line"><span class="string">        unsigned long   st_gid;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long long      st_rdev;</span></span><br><span class="line"><span class="string">        unsigned char   __pad3[4];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        long long       st_size;</span></span><br><span class="line"><span class="string">        unsigned long   st_blksize;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* Number 512-byte blocks allocated. */</span></span><br><span class="line"><span class="string">        unsigned long long      st_blocks;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_atime;</span></span><br><span class="line"><span class="string">        unsigned long   st_atime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_mtime;</span></span><br><span class="line"><span class="string">        unsigned int    st_mtime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_ctime;</span></span><br><span class="line"><span class="string">        unsigned long   st_ctime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long long      st_ino;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* We don&#x27;</span>t need to memset the whole thing just to initialize the padding */</span><br><span class="line"><span class="comment">#define INIT_STRUCT_STAT64_PADDING(st) do &#123;             \</span></span><br><span class="line">        memset(&amp;st.__pad0, 0, sizeof(st.__pad0));       \</span><br><span class="line">        memset(&amp;st.__pad3, 0, sizeof(st.__pad3));       \</span><br><span class="line">&#125; <span class="keyword">while</span> (0)</span><br><span class="line"></span><br><span class="line"><span class="comment">#else /* __i386__ */</span></span><br><span class="line"></span><br><span class="line">struct <span class="built_in">stat</span> &#123;</span><br><span class="line">        unsigned long   st_dev;</span><br><span class="line">        unsigned long   st_ino;</span><br><span class="line">        unsigned long   st_nlink;</span><br><span class="line"></span><br><span class="line">        unsigned int    st_mode;</span><br><span class="line">        unsigned int    st_uid;</span><br><span class="line">        unsigned int    st_gid;</span><br><span class="line">        unsigned int    __pad0;</span><br><span class="line">        unsigned long   st_rdev;</span><br><span class="line">        long            st_size;</span><br><span class="line">        long            st_blksize;</span><br><span class="line">        long            st_blocks;      /* Number 512-byte blocks allocated. */</span><br><span class="line"></span><br><span class="line">        unsigned long   st_atime;</span><br><span class="line">        unsigned long   st_atime_nsec;</span><br><span class="line">        unsigned long   st_mtime;</span><br><span class="line">        unsigned long   st_mtime_nsec;</span><br><span class="line">        unsigned long   st_ctime;</span><br><span class="line">        unsigned long   st_ctime_nsec;</span><br><span class="line">        long            __unused[3];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="lstat"><a href="#lstat" class="headerlink" title="lstat"></a><a href="http://codewiki.wikidot.com/c:system-calls:lstat">lstat</a></h5><p>int lstat(const char *path, struct stat *buf);<br>lstat is a system call that is used to determine information about a file based on its filename.<br>lstat is exactly the same as the stat system call. The only difference between the two is when the filename refers to a link. When this is the case, lstat returns information about the link itself, whereas stat returns information about the actual file.    </p><p>const char *path    The file path of the file that is being inquired. This can be both relative and absolute.<br>struct stat *buf    A structure where data about the file will be stored. A detailed look at all of the fields in this structure can be found in the struct stat page.<br>return value    Returns a negative value on failure.</p><h5 id="File-type"><a href="#File-type" class="headerlink" title="File type"></a>File type</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/usr/include/linux/stat.h</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFMT  00170000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFSOCK 0140000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFLNK  0120000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFREG  0100000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFBLK  0060000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFDIR  0040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFCHR  0020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFIFO  0010000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISUID  0004000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISGID  0002000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISVTX  0001000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISLNK(m)      (((m) &amp; S_IFMT) == S_IFLNK) # is link ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISREG(m)      (((m) &amp; S_IFMT) == S_IFREG) # is file ? </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISDIR(m)      (((m) &amp; S_IFMT) == S_IFDIR) # is dir ? # S_ISDIR(buf.st_mode)==1 means is dir,  ==0 means not dir</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISCHR(m)      (((m) &amp; S_IFMT) == S_IFCHR) # is char ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISBLK(m)      (((m) &amp; S_IFMT) == S_IFBLK) # is blk ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISFIFO(m)     (((m) &amp; S_IFMT) == S_IFIFO) # is fifo ? </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISSOCK(m)     (((m) &amp; S_IFMT) == S_IFSOCK) # is socket ?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Here is the permission bit</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXU 00700</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRUSR 00400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWUSR 00200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXUSR 00100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXG 00070</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRGRP 00040</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWGRP 00020</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXGRP 00010</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXO 00007</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IROTH 00004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWOTH 00002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXOTH 00001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> abc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">    stat(<span class="string">&quot;/home&quot;</span>, &amp;buf);</span><br><span class="line">    abc = buf.st_mode &amp; S_IFDIR;</span><br><span class="line">    <span class="keyword">if</span>(abc == S_IFDIR) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;It&#x27;s a directory.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span> you could </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(S_ISDIR(buf.st_mode)==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;file: %s \n&quot;</span>,k); <span class="comment">// output file name</span></span><br><span class="line">    global_count--;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;FIO-write&quot;&gt;&lt;a href=&quot;#FIO-write&quot; class=&quot;headerlink&quot; title=&quot;FIO write&quot;&gt;&lt;/a&gt;FIO write&lt;/h3&gt;&lt;p&gt;if not support fallocate, fio will switch </summary>
      
    
    
    
    <category term="Scripts" scheme="http://yoursite.com/categories/Scripts/"/>
    
    
    <category term="bash" scheme="http://yoursite.com/tags/bash/"/>
    
  </entry>
  
  <entry>
    <title>bencharmk tools</title>
    <link href="http://yoursite.com/2020/03/17/benchmark-tools/"/>
    <id>http://yoursite.com/2020/03/17/benchmark-tools/</id>
    <published>2020-03-17T09:06:14.000Z</published>
    <updated>2021-10-25T02:47:46.278Z</updated>
    
    <content type="html"><![CDATA[<h3 id="stress-ng"><a href="#stress-ng" class="headerlink" title="stress-ng"></a>stress-ng</h3><h4 id="filesystem"><a href="#filesystem" class="headerlink" title="filesystem"></a>filesystem</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bogo ops/s (real time) is the value of system performance</span></span><br><span class="line"></span><br><span class="line">$ stress-ng  --hdd 16 --hdd-opts rd-rnd --hdd-opts wr-rnd --hdd-opts fadv-rnd --hdd-write-size 128k --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line">stress-ng: info:  [67477] dispatching hogs: 16 hdd</span><br><span class="line">stress-ng: info:  [67477] successful run completed <span class="keyword">in</span> 60.17s (1 min, 0.17 secs)</span><br><span class="line">stress-ng: info:  [67477] stressor       bogo ops real time  usr time  sys time   bogo ops/s   bogo ops/s</span><br><span class="line">stress-ng: info:  [67477]                           (secs)    (secs)    (secs)   (real time) (usr+sys time)</span><br><span class="line">stress-ng: info:  [67477] hdd            19033866     60.12    381.16    575.50    316618.18     19896.17</span><br><span class="line">stress-ng: info:  [67477] <span class="keyword">for</span> a 60.17s run time:</span><br><span class="line">stress-ng: info:  [67477]     962.79s available CPU time</span><br><span class="line">stress-ng: info:  [67477]     381.24s user time   ( 39.60%)</span><br><span class="line">stress-ng: info:  [67477]     575.57s system time ( 59.78%)</span><br><span class="line">stress-ng: info:  [67477]     956.81s total time  ( 99.38%)</span><br><span class="line">stress-ng: info:  [67477] load average: 11.29 4.72 1.86</span><br><span class="line"></span><br><span class="line"><span class="comment"># meta</span></span><br><span class="line">$ stress-ng --sequential 16 --class filesystem --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line">stress-ng: info:  [27612] apparmor stressor will be skipped, AppArmor is not available</span><br><span class="line">stress-ng: info:  [27612] dispatching hogs: 16 <span class="built_in">chdir</span>, 16 chmod, 16 chown, 16 copy-file, 16 dentry, 16 dir, 16 dirdeep, 16 dnotify, 16 dup, 16 eventfd, 16 fallocate, 16 fanotify, 16 fcntl, 16 fiemap, 16 filename, 16 flock, 16 fstat, 16 getdent, 16 handle, 16 inotify, 16 io, 16 iomix, 16 ioprio, 16 lease, 16 link, 16 locka, 16 lockf, 16 lockofd, 16 mknod, 16 open, 16 procfs, 16 rename, 16 symlink, 16 sync-file, 16 utime, 16 xattr</span><br><span class="line"></span><br><span class="line"><span class="comment">#syscall test, no real IO</span></span><br><span class="line">$ stress-ng --<span class="built_in">chdir</span> 8 --chmod 8 --chown 8 --fcntl 8 --filename 8 --flock 8 --fstat 8 --getdent 8 --handle 8 --io 8 -- lockf 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># parallel running</span></span><br><span class="line"><span class="comment"># if you want test IO performance, got the high IO loading from these.</span></span><br><span class="line">$ stress-ng --fallocate 8 --xattr 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># a lot of NFS not support xattr</span></span><br><span class="line">$ stress-ng --fallocate 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># the high IO loading test could got the high IOPS in ext4 with SATA SSD</span></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdb               0.00 100284.00    0.00 15955.50     0.00   452.52    58.08    97.34    6.05    0.00    6.05   0.06  95.05</span><br></pre></td></tr></table></figure><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --cpu <span class="variable">$cores_num</span> --timeout 900</span><br></pre></td></tr></table></figure><h4 id="MEM"><a href="#MEM" class="headerlink" title="MEM"></a>MEM</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --vm 4 --timeout 900s</span><br><span class="line">$ stress-ng --vm-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.9;&#125;&#x27;</span> &lt; /proc/meminfo)k --vm-keep -m 1 -t 30s --metrics-brief</span><br><span class="line">$ stress-ng --mincore 5 --mincore-random --malloc 2 --malloc-bytes 10g --mremap 2 --mremap-bytes 10g --memfd 2 --memfd-bytes 10g --vm-bytes 10g -m 2  -t 600s --metrics-brief</span><br></pre></td></tr></table></figure><h4 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --mq 0 -t 30s --<span class="built_in">times</span>  --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># The matrix stressor is a good way to exercise the CPU floating point operations as well as memory and processor data cache. Of all the tests, this one generally heats x86 CPUs the best.</span></span><br><span class="line">$ stress-ng --matrix 0 -t 1m --<span class="built_in">times</span> --metrics-brief</span><br></pre></td></tr></table></figure><h4 id="mix"><a href="#mix" class="headerlink" title="mix"></a>mix</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --cpu 2 --matrix 1 --mq 3</span><br><span class="line">$ stress-ng --all 2</span><br><span class="line"></span><br><span class="line">$ stress-ng --seq 1 -x numa,matrix,hdd</span><br><span class="line"><span class="comment">#        --sequential N</span></span><br><span class="line">sequentially run all the stressors one by one <span class="keyword">for</span> a default of 60 seconds. The number of instances of each of the individual stressors to be started is N.  If N  is  less than  zero, <span class="keyword">then</span> the number of CPUs online is used <span class="keyword">for</span> the number of instances.  If N is zero, <span class="keyword">then</span> the number of CPUs <span class="keyword">in</span> the system is used.  Use the --timeout option to specify the duration to run each stressor.</span><br></pre></td></tr></table></figure><h4 id="the-others-test"><a href="#the-others-test" class="headerlink" title="the others test"></a>the others test</h4><p>$ stress-ng –seq 1 -x nuam, –sched fifo  -t 30s –times –metrics-brief<br>$ stress-ng –vm 16 –vm-bytes 90% -t 1h –metrics-brief<br>$ stress-ng –cpu 8 –cpu-ops 800000<br>$ stress-ng –cpu 4 –cpu-method fft –cpu-ops 10000 –metrics-brief<br>$ stress-ng –cpu 0 –cpu-method all -t 1h<br>$ stress-ng –random 64<br>#run 64 stressors that are randomly chosen from all the available stressors.</p><p>$ stress-ng –cpu 64 –cpu-method all –verify -t 10m –metrics-brief<br>#run 64 instances of all the different cpu stressors and verify that the computations are correct for 10 minutes with a bogo operations summary at the end.</p><p>$ stress-ng –sequential 8 –class io -t 5m –times</p><h1 id="run-all-the-stressors-in-the-io-class-one-by-one-for-5-minutes-each-with-8-instances-of-each-stressor-running-concurrently-and-show-overall-time-utilisation-statistics-at-the-end-of-the-run"><a href="#run-all-the-stressors-in-the-io-class-one-by-one-for-5-minutes-each-with-8-instances-of-each-stressor-running-concurrently-and-show-overall-time-utilisation-statistics-at-the-end-of-the-run" class="headerlink" title="run  all  the stressors in the io class one by one for 5 minutes each, with 8 instances of each stressor running concurrently and show overall time utilisation statistics at the end of the run."></a>run  all  the stressors in the io class one by one for 5 minutes each, with 8 instances of each stressor running concurrently and show overall time utilisation statistics at the end of the run.</h1><p>$ stress-ng –all 0 –maximize –aggressive<br>#run all the stressors (1 instance of each per CPU) simultaneously, maximize the settings (memory sizes, file allocations, etc.) and select the  most  demanding/aggressive options.</p><p>$        stress-ng –sequential 4 –class vm –exclude bigheap,brk,stack<br>#run 4 instances of the VM stressors one after each other, excluding the bigheap, brk and stack stressors</p><p>$ stress-ng –taskset 0,2-3 –cpu 3<br>#run 3 instances of the CPU stressor and pin them to CPUs 0, 2 and 3.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">##### cpu-cache</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--sequential</span> <span class="number">8</span> <span class="string">--class</span> <span class="string">cpu-cache</span> <span class="string">-t</span> <span class="string">5m</span></span><br><span class="line"><span class="attr">stress-ng: info:</span>  [<span class="number">13341</span>] <span class="string">apparmor</span> <span class="string">stressor</span> <span class="string">will</span> <span class="string">be</span> <span class="string">skipped,</span> <span class="string">AppArmor</span> <span class="string">is</span> <span class="string">not</span> <span class="string">available</span></span><br><span class="line"><span class="attr">stress-ng: info:</span>  [<span class="number">13341</span>] <span class="attr">dispatching hogs:</span> <span class="number">8</span> <span class="string">bsearch,</span> <span class="number">8</span> <span class="string">cache,</span> <span class="number">8</span> <span class="string">heapsort,</span> <span class="number">8</span> <span class="string">hsearch,</span> <span class="number">8</span> <span class="string">icache,</span> <span class="number">8</span> <span class="string">lockbus,</span> <span class="number">8</span> <span class="string">lsearch,</span> <span class="number">8</span> <span class="string">malloc,</span> <span class="number">8</span> <span class="string">matrix,</span> <span class="number">8</span> <span class="string">membarrier,</span> <span class="number">8</span> <span class="string">memcpy,</span> <span class="number">8</span> <span class="string">mergesort,</span> <span class="number">8</span> <span class="string">qsort,</span> <span class="number">8</span> <span class="string">str,</span> <span class="number">8</span> <span class="string">stream,</span> <span class="number">8</span> <span class="string">tsearch,</span> <span class="number">8</span> <span class="string">vecmath,</span> <span class="number">8</span> <span class="string">wcs,</span> <span class="number">8</span> <span class="string">zlib</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--cpu</span> <span class="number">4</span> <span class="string">--cache-level</span> <span class="number">2</span> <span class="string">--cache-ways</span> <span class="number">4</span> <span class="string">-t</span> <span class="string">30s</span> <span class="string">--metrics-brief</span></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--cpu</span> <span class="number">4</span> <span class="string">--cache-level</span> <span class="number">3</span> <span class="string">--cache-ways</span> <span class="number">4</span> <span class="string">-t</span> <span class="string">30s</span> <span class="string">--metrics-brief</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--all</span> <span class="number">0</span> <span class="string">--class</span> <span class="string">cpu-cache</span> <span class="string">-t</span> <span class="string">5m</span> <span class="string">--metrics-brief</span></span><br></pre></td></tr></table></figure><h5 id="cpu-method"><a href="#cpu-method" class="headerlink" title="cpu-method"></a>cpu-method</h5><p>$ stress-ng –cpu 1 –cpu-method matrixprod -t 1m –metrics-brief<br>$ for m in double longdouble matrixprod nsqrt cfloat clongdouble decimal32 decimal128 explog bitops ln2 int64 int128 ackermann int128decimal128 gray euler fibonacci; do stress-ng –cpu 0 –cpu-method $m -t 10s –metrics-brief; done</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># float</span></span><br><span class="line">double           <span class="number">1000</span> iterations of a mix of double precision floating point operations</span><br><span class="line">longdouble       <span class="number">1000</span> iterations of a mix of long double precision floating point operations</span><br><span class="line">matrixprod       matrix  product  of  two  <span class="number">128</span> × <span class="number">128</span> matrices of double floats. Testing on <span class="number">64</span> <span class="keyword">bit </span>x86 hardware <span class="keyword">shows </span>that this is provides a good mix of memory, <span class="keyword">cache </span><span class="keyword">and </span>floating point operations <span class="keyword">and </span>is probably the <span class="keyword">best </span>CPU method to use to make a CPU run hot.</span><br><span class="line">nsqrt            compute sqrt() of long doubles using Newton-Raphson</span><br><span class="line">cfloat           <span class="number">1000</span> iterations of a mix of floating point complex operations</span><br><span class="line"><span class="keyword">clongdouble </span>     <span class="number">1000</span> iterations of a mix of long double floating point complex operations</span><br><span class="line">decimal32        <span class="number">1000</span> iterations of a mix of <span class="number">32</span> <span class="keyword">bit </span>decimal floating point operations (GCC only)</span><br><span class="line">decimal128       <span class="number">1000</span> iterations of a mix of <span class="number">128</span> <span class="keyword">bit </span>decimal floating point operations (GCC only)</span><br><span class="line">explog           iterate on n = exp(log(n) ÷ <span class="number">1</span>.<span class="number">00002</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#int</span></span><br><span class="line">int64            <span class="number">1000</span> iterations of a mix of <span class="number">64</span> <span class="keyword">bit </span>integer operations</span><br><span class="line">int128           <span class="number">1000</span> iterations of a mix of <span class="number">128</span> <span class="keyword">bit </span>integer operations (GCC only)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------------performance test--------------------------</span><br><span class="line"><span class="comment">#logic</span></span><br><span class="line"><span class="keyword">jmp </span>             Simple unoptimised <span class="built_in">compare</span> &gt;, &lt;, == <span class="keyword">and </span><span class="keyword">jmp </span><span class="keyword">branching</span></span><br><span class="line"><span class="keyword">ackermann </span>       Ackermann function: compute A(<span class="number">3</span>, <span class="number">10</span>), where:</span><br><span class="line">                 A(m, n) = n + <span class="number">1</span> if m = <span class="number">0</span>;</span><br><span class="line">                 A(m - <span class="number">1</span>, <span class="number">1</span>) if m &gt; <span class="number">0</span> <span class="keyword">and </span>n = <span class="number">0</span>;</span><br><span class="line">                 A(m - <span class="number">1</span>, A(m, n - <span class="number">1</span>)) if m &gt; <span class="number">0</span> <span class="keyword">and </span>n &gt; <span class="number">0</span></span><br><span class="line"><span class="comment"># bit</span></span><br><span class="line"><span class="keyword">bitops </span>          various <span class="keyword">bit </span>operations from <span class="keyword">bithack, </span>namely: reverse <span class="keyword">bits, </span>parity check, <span class="keyword">bit </span><span class="built_in">count</span>, round to nearest power of <span class="number">2</span></span><br><span class="line"><span class="comment"># int</span></span><br><span class="line">gray             calculate <span class="keyword">binary </span>to gray code <span class="keyword">and </span>gray code <span class="keyword">back </span>to <span class="keyword">binary </span>for integers from <span class="number">0</span> to <span class="number">65535</span> </span><br><span class="line">fibonacci        compute Fibonacci sequence of <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">8</span>...</span><br><span class="line"></span><br><span class="line"><span class="comment">#float</span></span><br><span class="line">euler            compute e using n = (<span class="number">1</span> + (<span class="number">1</span> ÷ n)) ↑ n </span><br><span class="line">ln2              compute ln(<span class="number">2</span>) <span class="keyword">based </span>on series:</span><br><span class="line"><span class="comment">#mix</span></span><br><span class="line">int128decimal32 <span class="number">1000</span> iterations of a mix of <span class="number">128</span> <span class="keyword">bit </span>integer <span class="keyword">and </span><span class="number">128</span> <span class="keyword">bit </span>decimal floating point operations (GCC only)</span><br><span class="line"><span class="comment">#rand hash</span></span><br><span class="line">djb2a            <span class="number">128</span> rounds of hash DJB2a (Dan <span class="keyword">Bernstein </span>hash using the <span class="keyword">xor </span>variant) on <span class="number">128</span> to <span class="number">1</span> <span class="keyword">bytes </span>of <span class="built_in">random</span> strings</span><br><span class="line"><span class="keyword">dither </span>          Floyd–Steinberg <span class="keyword">dithering </span>of a <span class="number">1024</span> × <span class="number">768</span> <span class="built_in">random</span> image from <span class="number">8</span> <span class="keyword">bits </span>down to <span class="number">1</span> <span class="keyword">bit </span>of depth.</span><br><span class="line">crc16            compute <span class="number">1024</span> rounds of CCITT CRC16 on <span class="built_in">random</span> data</span><br><span class="line"></span><br><span class="line">-----------------------------------END--------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#C</span></span><br><span class="line">callfunc         recursively call <span class="number">8</span> argument C function to a depth of <span class="number">1024</span> calls <span class="keyword">and </span>unwind</span><br><span class="line"></span><br><span class="line"><span class="comment">#random, hash</span></span><br><span class="line"><span class="keyword">jenkin </span>       <span class="keyword">Jenkin&#x27;s </span>integer hash on <span class="number">128</span> rounds of <span class="number">128</span>..<span class="number">1</span> <span class="keyword">bytes </span>of <span class="built_in">random</span> data</span><br><span class="line">hanoi         solve a <span class="number">21</span> <span class="keyword">disc </span>Towers of Hanoi stack using the recursive solution</span><br><span class="line">              hamming          compute Hamming H(<span class="number">8</span>,<span class="number">4</span>) codes on <span class="number">262144</span> lots of <span class="number">4</span> <span class="keyword">bit </span>data. This turns <span class="number">4</span> <span class="keyword">bit </span>data into <span class="number">8</span> <span class="keyword">bit </span>Hamming code containing <span class="number">4</span> parity <span class="keyword">bits. </span>For data <span class="keyword">bits </span> d1..d4,</span><br><span class="line">                               parity <span class="keyword">bits </span>are computed as:</span><br><span class="line">                                 p1 = d2 + d3 + d4</span><br><span class="line">                                 p2 = d1 + d3 + d4</span><br><span class="line">                                 p3 = d1 + d2 + d4</span><br><span class="line">                                 p4 = d1 + d2 + d3</span><br><span class="line">correlate        perform a <span class="number">16384</span> × <span class="number">1024</span> correlation of <span class="built_in">random</span> doubles</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--memthrash-method method</span><br><span class="line">              specify a memthrash stress method. Available memthrash stress methods are described</span><br><span class="line">              as follows:</span><br><span class="line"></span><br><span class="line">              Method           Description</span><br><span class="line">              all              iterate over all the <span class="keyword">below </span>memthrash methods</span><br><span class="line">              chunk1           memset <span class="number">1</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunk8           memset <span class="number">8</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunk64          memset <span class="number">64</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunk256         memset <span class="number">256</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunkpage        memset page size <span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              flip             flip (invert) all <span class="keyword">bits </span>in ramdom locations</span><br><span class="line">              flush            flush <span class="keyword">cache </span>line in <span class="built_in">random</span> locations</span><br><span class="line">              lock             lock randomly choosing locations (Intel x86 CPUs only)</span><br><span class="line">              matrix           treat memory as a <span class="number">2</span> × <span class="number">2</span> matrix <span class="keyword">and </span><span class="keyword">swap </span><span class="built_in">random</span> elements</span><br><span class="line">              memset           memset the memory with <span class="built_in">random</span> data</span><br><span class="line">              mfence           stores with write serialization (Intel x86 CPUs only)</span><br><span class="line">              <span class="keyword">prefetch </span>        <span class="keyword">prefetch </span>data <span class="built_in">at</span> <span class="built_in">random</span> memory locations</span><br><span class="line">              <span class="built_in">random</span>           randomly  run any of the memthrash methods except for <span class="string">&#x27;random&#x27;</span> <span class="keyword">and</span></span><br><span class="line"><span class="keyword"> </span>                              <span class="string">&#x27;all&#x27;</span></span><br><span class="line">              spinread         spin loop read the same <span class="built_in">random</span> location <span class="number">2</span>^<span class="number">19</span> times</span><br><span class="line">              spinwrite        spin loop write the same <span class="built_in">random</span> location <span class="number">2</span>^<span class="number">19</span> times</span><br></pre></td></tr></table></figure><h5 id="class"><a href="#class" class="headerlink" title="class"></a>class</h5><p>The stress-ng stressors are grouped together in different classes:</p><p>cpu - CPU intensive<br>cpu-cache - stress CPU instruction and/or data caches<br>device - raw device driver stressors<br>io - generic input/output<br>interrupt - high interrupt load generators<br>filesystem - file system activity<br>memory - stack, heap, memory mapping, shared memory stressors<br>network - TCP/IP, UDP and UNIX domain socket stressors<br>os - core kernel stressors<br>pipe - pipe and UNIX socket stressors<br>scheduler - force high levels of context switching<br>security - AppArmor stressor<br>vm - Virtual Memory stressor (paging and memory)</p><p>–matrix-method method<br>       specify a matrix stress method. Available matrix stress methods are described as follows:</p><pre><code>   Method           Description   all              iterate over all the below matrix stress methods   add              add two N × N matrices   copy             copy one N × N matrix to another   div              divide an N × N matrix by a scalar   hadamard         Hadamard product of two N × N matrices   frobenius        Frobenius product of two N × N matrices   mean             arithmetic mean of two N × N matrices   mult             multiply an N × N matrix by a scalar   prod             product of two N × N matrices   sub              subtract one N × N matrix from another N × N matrix   trans            transpose an N × N matrix</code></pre><h4 id="performance-info"><a href="#performance-info" class="headerlink" title="performance info"></a>performance info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --mq 0 -t 30s --<span class="built_in">times</span> --perf</span><br><span class="line">stress-ng: info:  [68895] dispatching hogs: 16 mq</span><br><span class="line">^Cstress-ng: info:  [68895] unsuccessful run completed <span class="keyword">in</span> 15.95s</span><br><span class="line">stress-ng: info:  [68895] mq:</span><br><span class="line">stress-ng: info:  [68895]            667,942,869,088 CPU Cycles                    41.88 B/sec</span><br><span class="line">stress-ng: info:  [68895]            343,598,563,312 Instructions                  21.54 B/sec (0.514 instr. per cycle)</span><br><span class="line">stress-ng: info:  [68895]              4,273,568,592 Cache References               0.27 B/sec</span><br><span class="line">stress-ng: info:  [68895]                108,195,424 Cache Misses                   6.78 M/sec ( 2.53%)</span><br><span class="line">stress-ng: info:  [68895]             62,069,485,136 Branch Instructions            3.89 B/sec</span><br><span class="line">stress-ng: info:  [68895]              1,391,055,360 Branch Misses                 87.21 M/sec ( 2.24%)</span><br><span class="line">stress-ng: info:  [68895]              4,911,414,496 Bus Cycles                     0.31 B/sec</span><br><span class="line">stress-ng: info:  [68895]            510,787,333,888 Total Cycles                  32.02 B/sec</span><br><span class="line">stress-ng: info:  [68895]                      3,184 Page Faults Minor            199.61 /sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Page Faults Major              0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                  3,924,080 Context Switches               0.25 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    718,208 CPU Migrations                45.03 K/sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Alignment Faults               0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                      3,088 Page Faults User             193.60 /sec</span><br><span class="line">stress-ng: info:  [68895]                         96 Page Faults Kernel             6.02 /sec</span><br><span class="line">stress-ng: info:  [68895]                 92,731,952 System Call Enter              5.81 M/sec</span><br><span class="line">stress-ng: info:  [68895]                 92,731,952 System Call Exit               5.81 M/sec</span><br><span class="line">stress-ng: info:  [68895]                 54,434,816 Kmalloc                        3.41 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    399,904 Kmalloc Node                  25.07 K/sec</span><br><span class="line">stress-ng: info:  [68895]                231,994,672 Kfree                         14.54 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    139,904 Kmem Cache Alloc               8.77 K/sec</span><br><span class="line">stress-ng: info:  [68895]                     88,848 Kmem Cache Alloc Node          5.57 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    181,568 Kmem Cache Free               11.38 K/sec</span><br><span class="line">stress-ng: info:  [68895]                     59,856 MM Page Alloc                  3.75 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    158,720 MM Page Free                   9.95 K/sec</span><br><span class="line">stress-ng: info:  [68895]                  8,842,656 RCU Utilization                0.55 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    764,352 Sched Migrate Task            47.92 K/sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Sched Move NUMA                0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                  6,617,648 Sched Wakeup                   0.41 M/sec</span><br><span class="line">stress-ng: info:  [68895]                         16 Signal Generate                1.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                         80 Signal Deliver                 5.02 /sec</span><br><span class="line">stress-ng: info:  [68895]                        672 IRQ Entry                     42.13 /sec</span><br><span class="line">stress-ng: info:  [68895]                        672 IRQ Exit                      42.13 /sec</span><br><span class="line">stress-ng: info:  [68895]                    664,704 Soft IRQ Entry                41.67 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    664,704 Soft IRQ Exit                 41.67 K/sec</span><br><span class="line">stress-ng: info:  [68895]                         16 Writeback Dirty Inode          1.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Writeback Dirty Page           0.00 /sec</span><br><span class="line">stress-ng: info:  [68895] <span class="keyword">for</span> a 15.95s run time:</span><br><span class="line">stress-ng: info:  [68895]     255.21s available CPU time</span><br><span class="line">stress-ng: info:  [68895]      25.73s user time   ( 10.08%)</span><br><span class="line">stress-ng: info:  [68895]     181.50s system time ( 71.12%)</span><br><span class="line">stress-ng: info:  [68895]     207.23s total time  ( 81.20%)</span><br><span class="line">stress-ng: info:  [68895] load average: 5.35 1.73 1.08</span><br></pre></td></tr></table></figure><h4 id="Verify-mode"><a href="#Verify-mode" class="headerlink" title="Verify mode"></a>Verify mode</h4><p>Some stressors have a verification mode. A stress test is run and the results are checked, if the results are incorrect then stress-ng will flag up a warning error message. Suppose we want to run some exhaustive memory checks on a blob of virtually mapped memory via the vm stressor, enable the –verify mode and this will sanity check that the read/write results on the memory:</p><p>$ stress-ng –vm 1 –vm-bytes 2G –verify -v<br>Note that not all stressors have a verify mode, and enabling it will reduce the bogo op stats as there is an extra verification step being invoked.</p><h4 id="Generating-major-page-faults"><a href="#Generating-major-page-faults" class="headerlink" title="Generating major page faults"></a>Generating major page faults</h4><p>You can generate major page faults (by accessing a page is not loaded in memory at the time of the fault) and see the page fault rate using:<br>$ stress-ng –fault 0 –perf -t 1m</p><p>or with newer kernels use the userfaultfd stressor to force even more major faults:<br>$ stress-ng –userfaultfd 0 –perf -t 1m</p><p>Running timers at high frequency can generate a large interrupt load. The timer stressor with an appropriately selected timer frequency can be used to force many hundreds of thousands of interrupts per second, for example, 32 instances at 1MHz:<br>$ stress-ng –timer 32 –timer-freq 1000000</p><h3 id="test-case"><a href="#test-case" class="headerlink" title="test case"></a>test case</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -------all cores CPU case1:------</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> jmp bitops fibonacci euler ln2 int128decimal32 djb2a crc16; <span class="keyword">do</span> stress-ng --cpu 0 --cpu-method <span class="variable">$m</span> -t 240s --metrics-brief; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -------4 cores CPU case1:------</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> jmp bitops fibonacci euler ln2 int128decimal32 djb2a crc16; <span class="keyword">do</span> stress-ng --cpu 4 --cpu-method <span class="variable">$m</span> -t 240s --metrics-brief; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -------mem test1:---------</span><br><span class="line">stress-ng --malloc 1 --malloc-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k  --vm-keep -m 1 --vm-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k --mremap 2 --mremap-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k --memfd 2 --memfd-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k -t 600s --metrics-brief</span><br><span class="line"><span class="built_in">echo</span> -------mem test2:---------</span><br><span class="line">stress-ng --mincore 0 --mincore-random -t 600s --metrics-brief</span><br><span class="line"><span class="built_in">echo</span> -------mem test3:---------</span><br><span class="line">stress-ng --vm-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.9;&#125;&#x27;</span> /proc/meminfo)k --vm-keep -m 1 -t 600s --metrics-brief</span><br></pre></td></tr></table></figure><h3 id="Emulate-some-error-to-test-the-block-device"><a href="#Emulate-some-error-to-test-the-block-device" class="headerlink" title="Emulate some error to test the block device"></a>Emulate some error to test the block device</h3><h4 id="dm-delay"><a href="#dm-delay" class="headerlink" title="dm-delay"></a><a href="https://enodev.fr/posts/emulate-a-slow-block-device-with-dm-delay.html#">dm-delay</a></h4><p>Device-Mapper’s “delay” target delays reads and/or writes and maps them to different devices.</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ sudo modprobe brd rd_nr=<span class="number">1</span> rd_size=<span class="number">1048576</span></span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">readwrite=randread</span><br><span class="line">blocksize=<span class="number">4</span>k</span><br><span class="line">ioengine=sync</span><br><span class="line">filename=/dev/ram0</span><br><span class="line">time_based=<span class="number">1</span></span><br><span class="line">runtime=<span class="number">10</span></span><br><span class="line"></span><br><span class="line">DDR <span class="number">1333</span></span><br><span class="line">Jobs: <span class="number">1</span> (f=<span class="number">1</span>): [r(<span class="number">1</span>)][<span class="number">100.0</span>%][r=<span class="number">1471</span>MiB/s,w=<span class="number">0</span>KiB/s][r=<span class="number">377</span>k,w=<span class="number">0</span> IOPS][eta <span class="number">00</span>m:<span class="number">00</span>s]</span><br><span class="line">rw: (groupid=<span class="number">0</span>, jobs=<span class="number">1</span>): err= <span class="number">0</span>: pid=<span class="number">13487</span>: Thu Jun  <span class="number">4</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">25</span> <span class="number">2020</span></span><br><span class="line">   read: IOPS=<span class="number">361</span>k, BW=<span class="number">1411</span>MiB/s (<span class="number">1480</span>MB/s)(<span class="number">13.8</span>GiB/<span class="number">10001</span>msec)</span><br><span class="line">    clat (nsec): min=<span class="number">790</span>, max=<span class="number">124854</span>, avg=<span class="number">1563.39</span>, stdev=<span class="number">935.07</span></span><br><span class="line">     lat (nsec): min=<span class="number">984</span>, max=<span class="number">125042</span>, avg=<span class="number">1757.85</span>, stdev=<span class="number">978.84</span></span><br><span class="line">    clat percentiles (nsec):</span><br><span class="line">     |  <span class="number">1.00</span>th=[ <span class="number">1240</span>],  <span class="number">5.00</span>th=[ <span class="number">1304</span>], <span class="number">10.00</span>th=[ <span class="number">1336</span>], <span class="number">20.00</span>th=[ <span class="number">1368</span>],</span><br><span class="line">     | <span class="number">30.00</span>th=[ <span class="number">1384</span>], <span class="number">40.00</span>th=[ <span class="number">1400</span>], <span class="number">50.00</span>th=[ <span class="number">1432</span>], <span class="number">60.00</span>th=[ <span class="number">1464</span>],</span><br><span class="line">     | <span class="number">70.00</span>th=[ <span class="number">1496</span>], <span class="number">80.00</span>th=[ <span class="number">1560</span>], <span class="number">90.00</span>th=[ <span class="number">1752</span>], <span class="number">95.00</span>th=[ <span class="number">2352</span>],</span><br><span class="line">     | <span class="number">99.00</span>th=[ <span class="number">3376</span>], <span class="number">99.50</span>th=[ <span class="number">4080</span>], <span class="number">99.90</span>th=[<span class="number">14784</span>], <span class="number">99.95</span>th=[<span class="number">24960</span>],</span><br><span class="line">     | <span class="number">99.99</span>th=[<span class="number">31360</span>]</span><br><span class="line">   bw (  MiB/s): min= <span class="number">1004</span>, max= <span class="number">1476</span>, per=<span class="number">99.79</span>%, avg=<span class="number">1408.26</span>, stdev=<span class="number">144.72</span>, samples=<span class="number">19</span></span><br><span class="line">   iops        : min=<span class="number">257224</span>, max=<span class="number">377934</span>, avg=<span class="number">360514.11</span>, stdev=<span class="number">37048.52</span>, samples=<span class="number">19</span></span><br><span class="line">  lat (nsec)   : <span class="number">1000</span>=<span class="number">0.01</span>%</span><br><span class="line">  lat (usec)   : <span class="number">2</span>=<span class="number">91.75</span>%, <span class="number">4</span>=<span class="number">7.64</span>%, <span class="number">10</span>=<span class="number">0.49</span>%, <span class="number">20</span>=<span class="number">0.03</span>%, <span class="number">50</span>=<span class="number">0.09</span>%</span><br><span class="line">  lat (usec)   : <span class="number">100</span>=<span class="number">0.01</span>%, <span class="number">250</span>=<span class="number">0.01</span>%</span><br><span class="line">  cpu          : usr=<span class="number">27.40</span>%, sys=<span class="number">72.48</span>%, ctx=<span class="number">954</span>, majf=<span class="number">0</span>, minf=<span class="number">9</span></span><br><span class="line">  IO depths    : <span class="number">1</span>=<span class="number">100.0</span>%, <span class="number">2</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">0.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     submit    : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     complete  : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     issued rwt: total=<span class="number">3613043</span>,<span class="number">0</span>,<span class="number">0</span>, short=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, dropped=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">     latency   : target=<span class="number">0</span>, window=<span class="number">0</span>, percentile=<span class="number">100.00</span>%, depth=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Run status group <span class="number">0</span> (all jobs):</span><br><span class="line">   READ: bw=<span class="number">1411</span>MiB/s (<span class="number">1480</span>MB/s), <span class="number">1411</span>MiB/s<span class="number">-1411</span>MiB/s (<span class="number">1480</span>MB/s<span class="number">-1480</span>MB/s), io=<span class="number">13.8</span>GiB (<span class="number">14.8</span>GB), run=<span class="number">10001</span><span class="number">-10001</span>msec</span><br><span class="line"></span><br><span class="line"># Create device delaying rw operation <span class="keyword">for</span> <span class="number">500</span>ms</span><br><span class="line">$ echo <span class="string">&quot;0 $(blockdev --getsz /dev/ram0) delay /dev/ram0 0 500&quot;</span> | dmsetup create delayed</span><br><span class="line">$ ls -l /dev/mapper/delayed </span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">7</span> <span class="number">6</span>   <span class="number">4</span> <span class="number">22</span>:<span class="number">47</span> /dev/mapper/delayed -&gt; ../dm<span class="number">-0</span></span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">filename=/dev/dm<span class="number">-0</span></span><br><span class="line">readwrite=randread</span><br><span class="line">blocksize=<span class="number">4</span>k</span><br><span class="line">ioengine=sync</span><br><span class="line">time_based=<span class="number">1</span></span><br><span class="line">runtime=<span class="number">10</span></span><br><span class="line"></span><br><span class="line">Starting <span class="number">1</span> process</span><br><span class="line">Jobs: <span class="number">1</span> (f=<span class="number">1</span>): [r(<span class="number">1</span>)][<span class="number">100.0</span>%][r=<span class="number">8</span>KiB/s,w=<span class="number">0</span>KiB/s][r=<span class="number">2</span>,w=<span class="number">0</span> IOPS][eta <span class="number">00</span>m:<span class="number">00</span>s]</span><br><span class="line">random: (groupid=<span class="number">0</span>, jobs=<span class="number">1</span>): err= <span class="number">0</span>: pid=<span class="number">13873</span>: Thu Jun  <span class="number">4</span> <span class="number">22</span>:<span class="number">56</span>:<span class="number">44</span> <span class="number">2020</span></span><br><span class="line">   read: IOPS=<span class="number">1</span>, BW=<span class="number">8007</span>B/s (<span class="number">8007</span>B/s)(<span class="number">80.0</span>KiB/<span class="number">10231</span>msec)</span><br><span class="line">    clat (msec): min=<span class="number">503</span>, max=<span class="number">516</span>, avg=<span class="number">511.50</span>, stdev= <span class="number">2.97</span></span><br><span class="line">     lat (msec): min=<span class="number">503</span>, max=<span class="number">516</span>, avg=<span class="number">511.50</span>, stdev= <span class="number">2.97</span></span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  <span class="number">1.00</span>th=[  <span class="number">506</span>],  <span class="number">5.00</span>th=[  <span class="number">506</span>], <span class="number">10.00</span>th=[  <span class="number">510</span>], <span class="number">20.00</span>th=[  <span class="number">510</span>],</span><br><span class="line">     | <span class="number">30.00</span>th=[  <span class="number">514</span>], <span class="number">40.00</span>th=[  <span class="number">514</span>], <span class="number">50.00</span>th=[  <span class="number">514</span>], <span class="number">60.00</span>th=[  <span class="number">514</span>],</span><br><span class="line">     | <span class="number">70.00</span>th=[  <span class="number">514</span>], <span class="number">80.00</span>th=[  <span class="number">514</span>], <span class="number">90.00</span>th=[  <span class="number">514</span>], <span class="number">95.00</span>th=[  <span class="number">518</span>],</span><br><span class="line">     | <span class="number">99.00</span>th=[  <span class="number">518</span>], <span class="number">99.50</span>th=[  <span class="number">518</span>], <span class="number">99.90</span>th=[  <span class="number">518</span>], <span class="number">99.95</span>th=[  <span class="number">518</span>],</span><br><span class="line">     | <span class="number">99.99</span>th=[  <span class="number">518</span>]</span><br><span class="line">   bw (  KiB/s): min=    <span class="number">8</span>, max=    <span class="number">8</span>, per=<span class="number">100.00</span>%, avg= <span class="number">8.00</span>, stdev= <span class="number">0.00</span>, samples=<span class="number">19</span></span><br><span class="line">   iops        : min=    <span class="number">2</span>, max=    <span class="number">2</span>, avg= <span class="number">2.00</span>, stdev= <span class="number">0.00</span>, samples=<span class="number">19</span></span><br><span class="line">  lat (msec)   : <span class="number">750</span>=<span class="number">100.00</span>%</span><br><span class="line">  cpu          : usr=<span class="number">0.00</span>%, sys=<span class="number">0.02</span>%, ctx=<span class="number">20</span>, majf=<span class="number">0</span>, minf=<span class="number">6</span></span><br><span class="line">  IO depths    : <span class="number">1</span>=<span class="number">100.0</span>%, <span class="number">2</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">0.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     submit    : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     complete  : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     issued rwt: total=<span class="number">20</span>,<span class="number">0</span>,<span class="number">0</span>, short=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, dropped=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">     latency   : target=<span class="number">0</span>, window=<span class="number">0</span>, percentile=<span class="number">100.00</span>%, depth=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Run status group <span class="number">0</span> (all jobs):</span><br><span class="line">   READ: bw=<span class="number">8007</span>B/s (<span class="number">8007</span>B/s), <span class="number">8007</span>B/s<span class="number">-8007</span>B/s (<span class="number">8007</span>B/s<span class="number">-8007</span>B/s), io=<span class="number">80.0</span>KiB (<span class="number">81.9</span>kB), run=<span class="number">10231</span><span class="number">-10231</span>msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">    dm<span class="number">-0</span>: ios=<span class="number">20</span>/<span class="number">0</span>, merge=<span class="number">0</span>/<span class="number">0</span>, ticks=<span class="number">9720</span>/<span class="number">0</span>, in_queue=<span class="number">10140</span>, util=<span class="number">99.14</span>%, aggrios=<span class="number">0</span>/<span class="number">0</span>, aggrmerge=<span class="number">0</span>/<span class="number">0</span>, aggrticks=<span class="number">0</span>/<span class="number">0</span>, aggrin_queue=<span class="number">0</span>, aggrutil=<span class="number">0.00</span>%</span><br><span class="line">  ram0: ios=<span class="number">0</span>/<span class="number">0</span>, merge=<span class="number">0</span>/<span class="number">0</span>, ticks=<span class="number">0</span>/<span class="number">0</span>, in_queue=<span class="number">0</span>, util=<span class="number">0.00</span>%</span><br><span class="line"></span><br><span class="line"># Create a block device that delays reads <span class="keyword">for</span> <span class="number">500</span> ms <span class="keyword">and</span> writes <span class="keyword">for</span> <span class="number">300</span> ms</span><br><span class="line">size=$(blockdev --getsize /dev/ram0) # Size <span class="keyword">in</span> <span class="number">512</span>-bytes sectors</span><br><span class="line">$ echo <span class="string">&quot;0 $(blockdev --getsize /dev/ram0) delay /dev/ram0 0 500 /dev/ram0 0 300&quot;</span> | dmsetup create delayed</span><br><span class="line"></span><br><span class="line">$ dmsetup remove /dev/mapper/delayed</span><br></pre></td></tr></table></figure><h4 id="dm-linear"><a href="#dm-linear" class="headerlink" title="dm-linear"></a>dm-linear</h4><p>The dm-linear target maps a linear range of blocks of the device-mapper device onto a linear range of a backend device. dm-linear is the basic building block of logical volume managers such as LVM.</p><h4 id="dm-flakey"><a href="#dm-flakey" class="headerlink" title="dm-flakey"></a>dm-flakey</h4><p>This target is the same as the linear target except that it exhibits unreliable behaviour periodically.  It’s been found useful in simulating failing devices for testing purposes.</p><ul><li>drop_writes All write I/Os are silently ignored and dropped. Read I/Os are handled correctly.</li><li>error_writes All write I/Os are failed with an error signaled. Read I/Os are handled correctly.</li><li>corrupt_bio_byte During the down time, replace the Nth byte of the data of each read or write block I/O with a specified value.<br>The default error mode is to fail all I/O requests during the down time of the simulation cycle.</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">tabled parameters:</span><br><span class="line">&lt;dev path&gt; &lt;offset&gt; &lt;up interval&gt; &lt;down interval&gt;  [&lt;num_features&gt; [&lt;feature arguments&gt;]]</span><br><span class="line">$ dmsetup create test --table <span class="string">&#x27;0 123 flakey /dev/sda1 0 4 8&#x27;</span></span><br><span class="line">$  file /dev/mapper/dm_test0 </span><br><span class="line">/dev/mapper/dm_test0: symbolic link <span class="keyword">to</span> <span class="built_in">..</span>/dm-0</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line"><span class="attribute">filename</span>=/dev/dm-0</span><br><span class="line"><span class="comment">#readwrite=randrw</span></span><br><span class="line"><span class="attribute">readwrite</span>=randread</span><br><span class="line"><span class="attribute">blocksize</span>=4k</span><br><span class="line"><span class="attribute">ioengine</span>=sync</span><br><span class="line"><span class="attribute">time_based</span>=1</span><br><span class="line"><span class="attribute">runtime</span>=130</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fio-3.1</span><br><span class="line">Starting 1 process</span><br><span class="line">fio: io_u <span class="builtin-name">error</span> on file /dev/dm-0: Input/output error: read <span class="attribute">offset</span>=0, <span class="attribute">buflen</span>=4096</span><br><span class="line">random: <span class="literal">No</span> I/O performed by sync, perhaps try <span class="attribute">--debug</span>=io option <span class="keyword">for</span> details?</span><br><span class="line">fio: <span class="attribute">pid</span>=16261, <span class="attribute">err</span>=5/file:io_u.c:1756, <span class="attribute">func</span>=io_u error, <span class="attribute">error</span>=Input/output error</span><br><span class="line"></span><br><span class="line">random: (<span class="attribute">groupid</span>=0, <span class="attribute">jobs</span>=1): err= 5 (file:io_u.c:1756, <span class="attribute">func</span>=io_u error, <span class="attribute">error</span>=Input/output error): <span class="attribute">pid</span>=16261: Fri Jun  5 00:29:08 2020</span><br><span class="line">  cpu          : <span class="attribute">usr</span>=0.00%, <span class="attribute">sys</span>=0.00%, <span class="attribute">ctx</span>=0, <span class="attribute">majf</span>=0, <span class="attribute">minf</span>=17</span><br><span class="line">  IO depths    : <span class="attribute">1</span>=100.0%, <span class="attribute">2</span>=0.0%, <span class="attribute">4</span>=0.0%, <span class="attribute">8</span>=0.0%, <span class="attribute">16</span>=0.0%, <span class="attribute">32</span>=0.0%, &gt;=<span class="attribute">64</span>=0.0%</span><br><span class="line">     submit    : <span class="attribute">0</span>=0.0%, <span class="attribute">4</span>=100.0%, <span class="attribute">8</span>=0.0%, <span class="attribute">16</span>=0.0%, <span class="attribute">32</span>=0.0%, <span class="attribute">64</span>=0.0%, &gt;=<span class="attribute">64</span>=0.0%</span><br><span class="line">     complete  : <span class="attribute">0</span>=50.0%, <span class="attribute">4</span>=50.0%, <span class="attribute">8</span>=0.0%, <span class="attribute">16</span>=0.0%, <span class="attribute">32</span>=0.0%, <span class="attribute">64</span>=0.0%, &gt;=<span class="attribute">64</span>=0.0%</span><br><span class="line">     issued rwt: <span class="attribute">total</span>=1,0,0, <span class="attribute">short</span>=0,0,0, <span class="attribute">dropped</span>=0,0,0</span><br><span class="line">     latency   : <span class="attribute">target</span>=0, <span class="attribute">window</span>=0, <span class="attribute">percentile</span>=100.00%, <span class="attribute">depth</span>=1</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">Run</span> status<span class="built_in"> group </span>0 (all jobs):</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">    dm-0: <span class="attribute">ios</span>=0/0, <span class="attribute">merge</span>=0/0, <span class="attribute">ticks</span>=0/0, <span class="attribute">in_queue</span>=0, <span class="attribute">util</span>=0.00%, <span class="attribute">aggrios</span>=0/0, <span class="attribute">aggrmerge</span>=0/0, <span class="attribute">aggrticks</span>=0/0, <span class="attribute">aggrin_queue</span>=0, <span class="attribute">aggrutil</span>=0.00%</span><br><span class="line">  sda: <span class="attribute">ios</span>=0/0, <span class="attribute">merge</span>=0/0, <span class="attribute">ticks</span>=0/0, <span class="attribute">in_queue</span>=0, <span class="attribute">util</span>=0.00%</span><br><span class="line"></span><br><span class="line">[18800.528564] buffer_io_error: 110 callbacks suppressed</span><br><span class="line">[18800.528569] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 0, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528582] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 1, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528587] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 2, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528591] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 3, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528596] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 4, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528600] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 5, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528604] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 6, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528608] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 7, async<span class="built_in"> page </span>read</span><br></pre></td></tr></table></figure><p>$ dmsetup suspend /dev/dm-0<br>$ dmsetup resume /dev/dm-0</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dm-linear</span><br><span class="line">dm-zoned</span><br><span class="line">(dm-dust)[https:<span class="regexp">//</span>www.kernel.org<span class="regexp">/doc/</span>Documentation<span class="regexp">/device-mapper/</span>dm-dust.txt]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### fio</span></span><br><span class="line"><span class="comment">#### multi-nodes test</span></span><br></pre></td></tr></table></figure><p>cat test_hosts<br>test-0<br>test-1<br>test-2<br>test-3<br>…<br>test-n</p><p>##start fio server in test-0 until test-n<br>test-0 $ fio –server –daemon=/tmp/fio.pid<br>test-1 $ fio –server –daemon=/tmp/fio.pid<br>….<br>test-n $ fio –server –daemon=/tmp/fio.pid</p><p>$ fio –client=test_hosts /config/fio_read_1.cfg</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">#### the fio demo</span><br><span class="line">```bash</span><br><span class="line">[global]</span><br><span class="line">directory=./</span><br><span class="line">iodepth=8</span><br><span class="line">rwmixread=50</span><br><span class="line">numjobs=32</span><br><span class="line">size=100M</span><br><span class="line">norandommap=1</span><br><span class="line"><span class="attribute">group_reporting</span></span><br><span class="line"><span class="attribute">refill_buffers</span></span><br><span class="line">end_fsync=1</span><br><span class="line">disable_slat=1</span><br><span class="line"><span class="attribute">exitall</span></span><br><span class="line">timeout=36000</span><br><span class="line">direct=0</span><br><span class="line">nrfiles=8</span><br><span class="line">bssplit=4k/10:32k/20:64k/20:128k/20:256k/20:1024k/10</span><br><span class="line">[job1]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job2]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job3]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job4]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job5]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job6]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job7]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job8]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job9]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job10]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job11]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=sync</span><br><span class="line">[job12]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=sync</span><br><span class="line">[job13]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=sync</span><br><span class="line">[job14]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=sync</span><br><span class="line">[job15]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=sync</span><br><span class="line">[job16]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=psync</span><br><span class="line">[job17]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=psync</span><br><span class="line">[job18]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=psync</span><br><span class="line">[job19]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=psync</span><br><span class="line">[job20]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=psync</span><br><span class="line">[job21]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job22]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job23]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job24]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job25]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=vsync</span><br></pre></td></tr></table></figure><h4 id="fio-randseed"><a href="#fio-randseed" class="headerlink" title="fio randseed"></a>fio randseed</h4><p>randseed=int<br>Seed the random number generators based on this seed value, to be able to control what sequence of output is being generated. If not set, the random sequence depends on the randrepeat setting.</p><p>If you don ‘t want rand read/write the same location, please add this parameter</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ fio -rw=randread -ioengine=libaio -name=rw -numjobs=1 -runtime=10 -filename=/dev/sda1 --debug=random | head</span><br><span class="line">fio: <span class="built_in">set</span> debug option random</span><br><span class="line">rw: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1</span><br><span class="line">fio-3.7</span><br><span class="line">Starting 1 process</span><br><span class="line">random   37670 off rand 259043585</span><br><span class="line">random   37670 off rand 3179521932</span><br><span class="line">random   37670 off rand 3621444214</span><br><span class="line">random   37670 off rand 2018697059</span><br><span class="line">random   37670 off rand 1726199243</span><br><span class="line">random   37670 off rand 3608323581</span><br><span class="line">fio: pid=37670, got signal=13</span><br><span class="line"></span><br><span class="line">$ fio -rw=randread -ioengine=libaio -name=rw -numjobs=1 -runtime=10 -filename=/dev/sda1 --debug=random | head</span><br><span class="line">fio: <span class="built_in">set</span> debug option random</span><br><span class="line">rw: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1</span><br><span class="line">fio-3.7</span><br><span class="line">Starting 1 process</span><br><span class="line">random   37700 off rand 259043585</span><br><span class="line">random   37700 off rand 3179521932</span><br><span class="line">random   37700 off rand 3621444214</span><br><span class="line">random   37700 off rand 2018697059</span><br><span class="line">random   37700 off rand 1726199243</span><br><span class="line">random   37700 off rand 3608323581</span><br><span class="line">fio: pid=37700, got signal=13</span><br><span class="line"></span><br><span class="line"><span class="comment">## Add random randseed</span></span><br><span class="line">$ fio -rw=randread -ioengine=libaio -name=rw -numjobs=1 -runtime=10 -filename=/dev/sda1 --debug=random --randseed=1111 | head</span><br><span class="line">fio: <span class="built_in">set</span> debug option random</span><br><span class="line">rw: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1</span><br><span class="line">fio-3.7</span><br><span class="line">Starting 1 process</span><br><span class="line">random   37735 off rand 467479607</span><br><span class="line">random   37735 off rand 3308212373</span><br><span class="line">random   37735 off rand 3651680361</span><br><span class="line">random   37735 off rand 4287149593</span><br><span class="line">random   37735 off rand 348379764</span><br><span class="line">random   37735 off rand 1909948585</span><br><span class="line">fio: pid=37735, got signal=13</span><br></pre></td></tr></table></figure><h4 id="fio-can-verify-the-file-contents-after-each-iteration-of-the-job"><a href="#fio-can-verify-the-file-contents-after-each-iteration-of-the-job" class="headerlink" title="fio can verify the file contents after each iteration of the job"></a>fio can verify the file contents after each iteration of the job</h4><p>–verify=crc64<br>–do_verify=1 (enable verify, default enabled)<br>–verify_pattern=’xxxxxx’<br>–verify=meta(This  option  is deprecated)    </p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">verify</span>=str</span><br><span class="line">       <span class="keyword">If</span> writing <span class="keyword">to</span> a file, fio can verify the file contents after each iteration of the job. Each verification method also implies</span><br><span class="line">       verification  of special header, which is written <span class="keyword">to</span> the beginning of each block. This header also includes meta information,</span><br><span class="line">       like offset of the block, block number, timestamp when block was written, etc. verify can  be  combined  with  verify_pattern</span><br><span class="line">       option. The allowed values are:</span><br><span class="line">              crc64  Use an experimental crc64 sum of the data<span class="built_in"> area </span><span class="keyword">and</span> store it <span class="keyword">in</span> the header of each block.</span><br><span class="line">              crc32c Use  a  crc32c sum of the data<span class="built_in"> area </span><span class="keyword">and</span> store it <span class="keyword">in</span> the header of each block. This will automatically use hard‐</span><br><span class="line">                     ware acceleration (e.g. SSE4.2 on an x86 <span class="keyword">or</span> CRC crypto extensions on ARM64) but  will  fall  back  <span class="keyword">to</span>  software</span><br><span class="line">                     crc32c <span class="keyword">if</span> none is found. Generally the fastest checksum fio supports when<span class="built_in"> hardware </span>accelerated.</span><br><span class="line">              crc32c-intel</span><br><span class="line">                     Synonym <span class="keyword">for</span> crc32c.</span><br><span class="line">              crc32  Use a crc32 sum of the data<span class="built_in"> area </span><span class="keyword">and</span> store it <span class="keyword">in</span> the header of each block.</span><br></pre></td></tr></table></figure><h4 id="fio-metadata"><a href="#fio-metadata" class="headerlink" title="fio metadata"></a>fio metadata</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--ioengine=posixaio --openfiles=10000 --numjobs=<span class="variable">$DP_NUM</span> --filesize=64k --lockfile=readwrite</span><br></pre></td></tr></table></figure><h4 id="io-uring"><a href="#io-uring" class="headerlink" title="io_uring"></a>io_uring</h4><p><a href="https://github.com/Linkerist/blog/issues/25">以上是AIO的不足之一，分析AIO缘何不足，需要较大的篇幅，这里按下不表直接总结结论。</a></p><p>这类接口，尽管形式多种多样，但它们都有一个共同的特征，就是同步，即在读写IO时，系统调用会阻塞住等待，在数据读取或写入后才返回结果。<br>同步导致的后果就是caller 在阻塞的同时无法继续执行其他的操作，只能等待IO结果返回，其实caller本可以利用这段时间继续往后执行。</p><p>仅支持direct IO。在采用AIO的时候，只能使用O_DIRECT，不能借助文件系统缓存来缓存当前的IO请求，还存在size对齐（直接操作磁盘，所有写入内存块数量必须是文件系统块大小的倍数，而且要与内存页大小对齐。）等限制，直接影响了aio在很多场景的使用。<br>仍然可能被阻塞。语义不完备。即使应用层主观上，希望系统层采用异步IO，但是客观上，有时候还是可能会被阻塞。io_getevents(2)调用read_events读取AIO的完成events，read_events中的wait_event_interruptible_hrtimeout等待aio_read_events，如果条件不成立（events未完成）则调用__wait_event_hrtimeout进入睡眠（当然，支持用户态设置最大等待时间）。<br>拷贝开销大。每个IO提交需要拷贝64+8字节，每个IO完成需要拷贝32字节，总共104字节的拷贝。这个拷贝开销是否可以承受，和单次IO大小有关：如果需要发送的IO本身就很大，相较之下，这点消耗可以忽略，而在大量小IO的场景下，这样的拷贝影响比较大。<br>API不友好。每一个IO至少需要两次系统调用才能完成（submit和wait-for-completion)，需要非常小心地使用完成事件以避免丢事件。<br>系统调用开销大。也正是因为上一条，io_submit/io_getevents造成了较大的系统调用开销，在存在spectre/meltdown（CPU熔断幽灵漏洞，CVE-2017-5754）的机器上，若如果要避免漏洞问题，系统调用性能则会大幅下降。在存储场景下，高频系统调用的性能影响较大。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/block_dump</span><br><span class="line">$ fio --name=randread --rw=randread --bs=4K --ioengine=io_uring --sqthread_poll=1 --size=1000G --numjobs=1 --filename=/dev/disk/by-id/ata-ST31000340NS_9QJ1CAAA-part1 --direct=1 --group_reporting</span><br><span class="line"></span><br><span class="line">fio(2039789): READ block 21187832 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 27664240 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 20709568 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 17529624 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 27647664 on sdb1 (8 sectors)</span><br></pre></td></tr></table></figure><h3 id="redis-benchmark"><a href="#redis-benchmark" class="headerlink" title="redis benchmark"></a>redis benchmark</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># download http://rpms.remirepo.net/enterprise/7/remi/x86_64/redis-6.2.0-1.el7.remi.x86_64.rpm</span></span><br><span class="line"><span class="comment"># not save to disk</span></span><br><span class="line"><span class="comment"># /etc/redis.conf</span></span><br><span class="line">port 6111</span><br><span class="line">save <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">#logfile /var/log/redis/redis.log</span></span><br><span class="line"><span class="comment">#pidfile /var/run/redis_6379.pid</span></span><br><span class="line"></span><br><span class="line">$ redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 91G mem, 3 x cores, 2xcores redis-benchmark, 1xcores redis server</span></span><br><span class="line">$ redis-benchmark -r 1000000000 --threads 2 -n 30000000 -t <span class="built_in">set</span>,get,incr -d 1 -p 6666</span><br><span class="line"></span><br><span class="line"><span class="comment"># 40G mem, memory compression ?</span></span><br><span class="line">$ redis-benchmark -r 1000000000 --threads 2 -n 30000000 -t <span class="built_in">set</span>,get,incr -d 1024 -p 6001</span><br><span class="line"></span><br><span class="line"><span class="comment"># -r &lt;keyspacelen&gt;   Use random keys for SET/GET/INCR, random values for SADD Using this option the benchmark will expand the string __rand_int__inside an argument with a 12 digits number in the specified range from 0 to keyspacelen-1. The substitution changes every time a command is executed. Default tests use this to hit random keys in the specified range.</span></span><br><span class="line">$ cat demo</span><br><span class="line">protected-mode yes</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize no</span><br><span class="line">loglevel notice</span><br><span class="line">databases 16</span><br><span class="line">always-show-logo no</span><br><span class="line">set-proc-title yes</span><br><span class="line">proc-title-template <span class="string">&quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&quot;</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">rdb-del-sync-files no</span><br><span class="line">dir /var/lib/redis</span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line">replica-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-diskless-load disabled</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line">acllog-max-len 128</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line">lazyfree-lazy-user-del no</span><br><span class="line">lazyfree-lazy-user-flush no</span><br><span class="line">oom-score-adj no</span><br><span class="line">oom-score-adj-values 0 200 800</span><br><span class="line">disable-thp yes</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">&quot;&quot;</span></span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">save <span class="string">&quot;&quot;</span></span><br><span class="line">dynamic-hz yes</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line">jemalloc-bg-thread yes</span><br><span class="line"></span><br><span class="line"><span class="comment">### start redis-server</span></span><br><span class="line">pkill redis-server</span><br><span class="line">i=6001</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment">#echo numactl -C $line redis-server demo --port $i</span></span><br><span class="line">  numactl -C <span class="variable">$line</span> redis-server demo --port <span class="variable">$i</span> &amp;</span><br><span class="line">  ((i++))</span><br><span class="line"><span class="keyword">done</span> &lt; server_cpu</span><br><span class="line"></span><br><span class="line"><span class="comment">#### run redis-benchmark</span></span><br><span class="line">[[ ! -d /tmp/reids ]] &amp;&amp; mkdir /tmp/redis</span><br><span class="line">i=6001</span><br><span class="line">total=30000000000</span><br><span class="line">incr_num=20</span><br><span class="line">dsize=2</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment">#echo numactl -C $line redis-benchmark -r 1000000000 --threads 2 -n $((total/dsize)) -t set,get,incr -d $dsize -p $i</span></span><br><span class="line">  (numactl -C <span class="variable">$line</span> redis-benchmark -r 1000000000 --threads 2 -n 100000000 -t <span class="built_in">set</span>,get,incr -d <span class="variable">$dsize</span> -p <span class="variable">$i</span> &gt; /tmp/redis/redis_<span class="variable">$i</span> 2&gt;&amp;1) &amp;</span><br><span class="line">  ((i++))</span><br><span class="line">  ((dsize=dsize+incr_num))</span><br><span class="line"><span class="keyword">done</span> &lt; client_cpu</span><br></pre></td></tr></table></figure><h3 id="linpack-xtreme-1-1-5-amd64-in-linux"><a href="#linpack-xtreme-1-1-5-amd64-in-linux" class="headerlink" title="linpack-xtreme-1.1.5-amd64 in linux"></a><a href="https://www.ngohq.com/linpack-xtreme.html">linpack-xtreme-1.1.5-amd64 in linux</a></h3><p>Auto calculte the problem size</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mem_var=$(awk <span class="string">&#x27;/MemAvailable/ &#123;printf &quot;%d\n&quot;, $2/1024/1024&#125;&#x27;</span> /proc/meminfo)</span><br><span class="line">$ cpu_cores=$(grep MHz /proc/cpuinfo  -c)</span><br><span class="line">$ test_size=$(awk -v cpu_cores=<span class="variable">$cpu_cores</span> -v mem_var=<span class="variable">$mem_var</span> <span class="string">&#x27;BEGIN&#123;print sqrt(((mem_var-0.067*cpu_cores)/18)*2)*35000&#125;&#x27;</span>)</span><br><span class="line">                                                                                             |              |       |</span><br><span class="line">                                                      one thread will take 0.067GB memory-----              |       |</span><br><span class="line">                                                                 problem size-------------------------------|--------</span><br><span class="line">                                                                                                            |</span><br><span class="line">                                                                                                            |</span><br><span class="line">                                                                                                            |</span><br><span class="line">take away the threads mem size, 35000 problem size will take 18Gx1 memory, 7000 problem will take 18G*2------</span><br><span class="line">105000 will take 18G*4, 140000 = 18G*8</span><br><span class="line"></span><br><span class="line">$ cat default</span><br><span class="line">Linpack data file</span><br><span class="line">Linpack Xtreme v1.1.5 by Regeneration</span><br><span class="line">1</span><br><span class="line"><span class="variable">$test_size</span> <span class="comment"># problem size</span></span><br><span class="line"><span class="variable">$test_size</span> <span class="comment"># leading dimensions</span></span><br><span class="line">1 <span class="comment"># number of times to run LINPACK</span></span><br><span class="line">4</span><br></pre></td></tr></table></figure><p>AMD EPYC2(2x 7742, 16 x 32G DDR 3200MHz) proportion to the performance not across the extra NUMA, and internal NUMA has the impact too<br>If the benchmark malloc 90% memory or more, the EPYC2 will from 2000GFLOPS down to 1000+GFLOPS, only half performance<br>It ‘s not used be in the random Memory-intensive tasks, maybe single socket is the better choice<br>In the same case(90%+ mem), the EPYC2 has the long latency than intel system   </p><h3 id="RAW-HDD-test"><a href="#RAW-HDD-test" class="headerlink" title="RAW HDD test"></a>RAW HDD test</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=sync</span><br><span class="line">numjobs=16</span><br><span class="line">bssplit=4K/100</span><br><span class="line">group_reporting</span><br><span class="line">[sda]</span><br><span class="line">filename=/dev/sda1</span><br><span class="line">[sdd]</span><br><span class="line">filename=/dev/sdb1</span><br><span class="line">....</span><br><span class="line">    AVG                     r/s     w/s     r_wait  w_wait  await</span><br><span class="line">NLSAS HUH721010AL5200  LS14 168.115 169.279 114.973 213.678 196.862</span><br><span class="line">NLSAS ST10000NM0256    TT56 128.233 128.964 290.436 852.015 425.779</span><br><span class="line">ATA   TOSHIBA MG04ACA4 FK3D 134.124 134.696 308.223 198.647 219.238</span><br><span class="line">ATA   HGST HUH721010AL LT14 155.018 155.74  157.973 781.01  219.257</span><br><span class="line">NLSAS WUH721818AL4204  C240 202.284 203.696 81.3992 405.879 268.257</span><br><span class="line">NLSAS WUH721818AL4204  C240 203.899 205.263 80.6991 379.694 255.109</span><br></pre></td></tr></table></figure><p>if numjobs large than 1, it could not use to test seq throughput for this device, but it could test the connection bandwidth.  </p><h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><h4 id="pkggen-kernel-mode"><a href="#pkggen-kernel-mode" class="headerlink" title="pkggen kernel mode"></a>pkggen kernel mode</h4><p>No more diff between 1GbE with 10GbE (BCM57800)<br><a href="https://lwn.net/Articles/629155/">The problem, Jesper said, is that the kernel developers have focused on scaling out to large numbers of cores. In the process, they have been able to hide regressions in per-core efficiency. The networking stack, as a result, works well for many workloads, but workloads that are especially latency-sensitive have suffered. The kernel, today, can only forward something between 1M and 2M packets per core every second, while some of the bypass alternatives approach a rate of 15M packets per core per second. Then there is the cost of performing a system call. On a system with SELinux and auditing enabled, that cost is just over 75ns — over the time budget on its own. Disabling auditing and SELinux reduces the time required to just under 42ns, which is better, but that is still a big part of the time budget. There are ways of amortizing that cost over multiple packets; they include system calls like sendmmsg(), recvmmsg(), sendfile(), and splice().</a><br>10GbE Full-duplex, about 2M    </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Result: OK: 958748771(c958745900+d2871) usec, 2000000000 (42byte,0frags)</span><br><span class="line">  2086052pps 700Mb/sec (700913472bps) errors: 0</span><br><span class="line"></span><br><span class="line">Result: OK: 939714052(c939699215+d14836) usec, 2000000000 (42byte,0frags)</span><br><span class="line">  2128307pps 715Mb/sec (715111152bps) errors: 0</span><br><span class="line"></span><br><span class="line">pgset <span class="string">&quot;count 2000000000&quot;</span></span><br><span class="line">pgset <span class="string">&quot;delay 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;clone_skb 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;pkt_size 8&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pgset <span class="string">&quot;count 2000000000&quot;</span></span><br><span class="line">pgset <span class="string">&quot;delay 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;clone_skb 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;pkt_size 8&quot;</span></span><br><span class="line"></span><br><span class="line">Result: OK: 184502252(c184496912+d5340) usec, 274564113 (42byte,0frags)</span><br><span class="line">  1488134pps 500Mb/sec (500013024bps) errors: 0</span><br><span class="line"></span><br><span class="line">Result: OK: 183209415(c183209277+d138) usec, 272639542 (42byte,0frags)</span><br><span class="line">  1488130pps 500Mb/sec (500011680bps) errors: 0</span><br></pre></td></tr></table></figure><h4 id="nc-test"><a href="#nc-test" class="headerlink" title="nc test"></a>nc test</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Server $ nc -l 22222 &lt; /dev/zero</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 &gt; /dev/null</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 | pv  <span class="comment"># show the speed</span></span><br></pre></td></tr></table></figure><h4 id="iperf3"><a href="#iperf3" class="headerlink" title="iperf3"></a>iperf3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ iperf3 -s -D -p 520<span class="variable">$i</span></span><br><span class="line">Client $ iperf3 -c <span class="variable">$client_ip</span> -P 1 -t 360000 -p 520<span class="variable">$i</span></span><br></pre></td></tr></table></figure><h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Server $ qperf -lp <span class="variable">$port</span> &amp;</span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 36000 -oo msg_size:1K:4K:*2 <span class="variable">$server_ip</span> tcp_bw</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 60 -oo msg_size:64:1024K:*4 <span class="variable">$server_ip</span> tcp_lat</span><br></pre></td></tr></table></figure><h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Server $ taskset -c 5 netserver &amp;</span><br><span class="line">Client $ netperf -H <span class="variable">$ipaddr</span> -l 200 -t TCP_STREAM</span><br><span class="line"></span><br><span class="line">Server $ numactl -C 2 netserver -D  -4 -v 2 -p 5000 -f -L 192.168.12.201</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_STREAM -l 15 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t UDP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br></pre></td></tr></table></figure><h4 id="sockperf"><a href="#sockperf" class="headerlink" title="sockperf"></a>sockperf</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./sockperf<span class="built_in"> server </span>--tcp -p 11111</span><br><span class="line">./sockperf<span class="built_in"> server </span>-p 11111 #udp</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf tp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf pp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br></pre></td></tr></table></figure><h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ LD_PRELOAD=libvma.so VMA_STATS_FD_NUM=500 redis-server --port 7777  --protected-mode no --maxmemory 12000mb --maxmemory-samples 10 --maxmemory-policy allkeys-lru</span><br><span class="line">Client $ numactl -C 2 redis-benchmark -r 10000000 -n 20000000 -t get,<span class="built_in">set</span>,lpush,lpop -P 16 -q -h 192.168.12.201 -p 7777 -d 16</span><br></pre></td></tr></table></figure><h4 id="RFC6349-TCP-benchmark"><a href="#RFC6349-TCP-benchmark" class="headerlink" title="RFC6349 TCP benchmark"></a><a href="https://www.viavisolutions.com/zh-cn/literature/rfc-6349-testing-truespeed-viavi-solutions-experience-your-network-your-custom-application-notes-zh.pdf">RFC6349 TCP benchmark</a></h4><ul><li>RFC 4821 through PLPMTUD make sure network path mtu</li><li>benchmark RRT(Round-Trip Time) and BB(bottle neck bandwidth)<ul><li>example:RRT=25ms, bandwidth=45Mbps, window=64KB, receiver take 12.5ms to sender BDP(bandwidth-delay product) = BB * RRT /8 = 140.625 KB, double sender ‘s window size</li><li>TCP global synchronization</li><li>RWND(Receive Window)</li><li>CWND(Congestion Window)</li><li>LFN(Long fat network)</li><li>RTD(round-trip delay time)</li><li>TDP(Tail drop polocy)</li><li>tcp transfer time<ul><li>In the 500Mbps netowrk, start 5x transmit services, each transmit means 100Mbps, actually, the 5 x tansmit bandwith are not balancing. 5 x sender transfer 100MB file.<ul><li>500MB/(500Mbps/8)=8 sec, in fact, the test use 12sec, that means 12sec/8sec=1.5, 1.5x late than the theoretically</li></ul></li></ul></li><li>tcp efficiency<ul><li>(total bytes - retrans bytes)/total bytes * 100 = 98%, in our data center , there are 2 percent tcp retrans. that too bad in some times.</li></ul></li><li>tcp cache latency percent, (test average rrt - base rrt)/base rrt * 100, if base rrt= 25ms, in the test, the average rrt=32ms, (32-25)/25*100=28%, tcp RTD increase 28%(congestion)</li></ul></li><li>if the tcp performance not reach your expect<ul><li>re-gen tcp connection, and modify tcp rwnd size, mtu size</li><li>speed limit cause tail drop polocy and cause too many tcp retrans</li><li>the maximum tcp cache size, it limit by OS memory size, and to check tcp queue</li><li>socket buffer size, a lot of OS could modify the each connection receive and transmit buffer limit. the socket buffer must be large enough.</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;stress-ng&quot;&gt;&lt;a href=&quot;#stress-ng&quot; class=&quot;headerlink&quot; title=&quot;stress-ng&quot;&gt;&lt;/a&gt;stress-ng&lt;/h3&gt;&lt;h4 id=&quot;filesystem&quot;&gt;&lt;a href=&quot;#filesystem&quot; cla</summary>
      
    
    
    
    <category term="Benchmark" scheme="http://yoursite.com/categories/Benchmark/"/>
    
    
    <category term="test" scheme="http://yoursite.com/tags/test/"/>
    
  </entry>
  
  <entry>
    <title>GDB tips</title>
    <link href="http://yoursite.com/2020/03/03/gdb/"/>
    <id>http://yoursite.com/2020/03/03/gdb/</id>
    <published>2020-03-03T14:17:33.000Z</published>
    <updated>2021-09-17T08:05:39.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun1</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun2</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun3</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b,<span class="keyword">int</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun4</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b,<span class="keyword">int</span> c,<span class="keyword">int</span> d)</span></span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun5</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b,<span class="keyword">int</span> c,<span class="keyword">int</span> d,<span class="keyword">int</span> e)</span></span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun6</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b,<span class="keyword">int</span> c,<span class="keyword">int</span> d,<span class="keyword">int</span> e,<span class="keyword">int</span> f)</span></span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> a,b,c,d,e,f;</span><br><span class="line">a=b=c=d=e=f=<span class="number">2</span>;</span><br><span class="line">fun1(a);</span><br><span class="line">fun2(a,b);</span><br><span class="line">fun3(a,b,c);</span><br><span class="line">fun4(a,b,c,d);</span><br><span class="line">fun5(a,b,c,d,e);</span><br><span class="line">fun6(a,b,c,d,e,f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ objdump -d test</span><br><span class="line"><span class="number">00000000004004</span>ed &lt;fun1&gt;:</span><br><span class="line">  <span class="number">4004</span>ed:       <span class="number">55</span>                      push   %rbp</span><br><span class="line">  <span class="number">4004</span>ee:       <span class="number">48</span> <span class="number">89</span> e5                mov    %rsp,%rbp</span><br><span class="line">  <span class="number">4004f</span>1:       <span class="number">89</span> <span class="number">7</span>d fc                mov    %edi,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">  <span class="number">4004f</span>4:       <span class="number">5</span>d                      pop    %rbp</span><br><span class="line">  <span class="number">4004f</span>5:       c3                      retq</span><br><span class="line"></span><br><span class="line"><span class="number">00000000004004f</span>6 &lt;fun2&gt;:</span><br><span class="line">  <span class="number">4004f</span>6:       <span class="number">55</span>                      push   %rbp</span><br><span class="line">  <span class="number">4004f</span>7:       <span class="number">48</span> <span class="number">89</span> e5                mov    %rsp,%rbp</span><br><span class="line">  <span class="number">4004f</span>a:       <span class="number">89</span> <span class="number">7</span>d fc                mov    %edi,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">  <span class="number">4004f</span>d:       <span class="number">89</span> <span class="number">75</span> f8                mov    %esi,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">  <span class="number">400500</span>:       <span class="number">5</span>d                      pop    %rbp</span><br><span class="line">  <span class="number">400501</span>:       c3                      retq</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400502</span> &lt;fun3&gt;:</span><br><span class="line">  <span class="number">400502</span>:       <span class="number">55</span>                      push   %rbp</span><br><span class="line">  <span class="number">400503</span>:       <span class="number">48</span> <span class="number">89</span> e5                mov    %rsp,%rbp</span><br><span class="line">  <span class="number">400506</span>:       <span class="number">89</span> <span class="number">7</span>d fc                mov    %edi,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">  <span class="number">400509</span>:       <span class="number">89</span> <span class="number">75</span> f8                mov    %esi,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">  <span class="number">40050</span>c:       <span class="number">89</span> <span class="number">55</span> f4                mov    %edx,<span class="number">-0xc</span>(%rbp)</span><br><span class="line">  <span class="number">40050f</span>:       <span class="number">5</span>d                      pop    %rbp</span><br><span class="line">  <span class="number">400510</span>:       c3                      retq</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400511</span> &lt;fun4&gt;:</span><br><span class="line">  <span class="number">400511</span>:       <span class="number">55</span>                      push   %rbp</span><br><span class="line">  <span class="number">400512</span>:       <span class="number">48</span> <span class="number">89</span> e5                mov    %rsp,%rbp</span><br><span class="line">  <span class="number">400515</span>:       <span class="number">89</span> <span class="number">7</span>d fc                mov    %edi,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">  <span class="number">400518</span>:       <span class="number">89</span> <span class="number">75</span> f8                mov    %esi,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">  <span class="number">40051b</span>:       <span class="number">89</span> <span class="number">55</span> f4                mov    %edx,<span class="number">-0xc</span>(%rbp)</span><br><span class="line">  <span class="number">40051</span>e:       <span class="number">89</span> <span class="number">4</span>d f0                mov    %ecx,<span class="number">-0x10</span>(%rbp)</span><br><span class="line">  <span class="number">400521</span>:       <span class="number">5</span>d                      pop    %rbp</span><br><span class="line">  <span class="number">400522</span>:       c3                      retq</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400523</span> &lt;fun5&gt;:</span><br><span class="line">  <span class="number">400523</span>:       <span class="number">55</span>                      push   %rbp</span><br><span class="line">  <span class="number">400524</span>:       <span class="number">48</span> <span class="number">89</span> e5                mov    %rsp,%rbp</span><br><span class="line">  <span class="number">400527</span>:       <span class="number">89</span> <span class="number">7</span>d fc                mov    %edi,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">  <span class="number">40052</span>a:       <span class="number">89</span> <span class="number">75</span> f8                mov    %esi,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">  <span class="number">40052</span>d:       <span class="number">89</span> <span class="number">55</span> f4                mov    %edx,<span class="number">-0xc</span>(%rbp)</span><br><span class="line">  <span class="number">400530</span>:       <span class="number">89</span> <span class="number">4</span>d f0                mov    %ecx,<span class="number">-0x10</span>(%rbp)</span><br><span class="line">  <span class="number">400533</span>:       <span class="number">44</span> <span class="number">89</span> <span class="number">45</span> ec             mov    %r8d,<span class="number">-0x14</span>(%rbp)</span><br><span class="line">  <span class="number">400537</span>:       <span class="number">5</span>d                      pop    %rbp</span><br><span class="line">  <span class="number">400538</span>:       c3                      retq</span><br></pre></td></tr></table></figure><h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ulimit</span> -S -c unlimited</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">break</span> *func_b+0x23</span><br><span class="line">Breakpoint 1 at 0x804898f: file backtrace.c, line 59.</span><br><span class="line"></span><br><span class="line">(gdb) list *func_b+0x23</span><br><span class="line">0x804898f is <span class="keyword">in</span> func_b (backtrace.c:59).</span><br><span class="line">54     int func_b()</span><br><span class="line">55     &#123;</span><br><span class="line">56         <span class="built_in">printf</span>(<span class="string">&quot;This is func_b\n&quot;</span>);</span><br><span class="line">57         /* illegal pointer, si_code = 128 (send by kernel) */</span><br><span class="line">58         int *p = (int *)-1;</span><br><span class="line">59         <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *p);</span><br><span class="line">60     &#125;</span><br><span class="line">61</span><br><span class="line">62     int main(int argc, char *argv[])</span><br><span class="line">63     &#123;</span><br></pre></td></tr></table></figure><h4 id="segment-fault"><a href="#segment-fault" class="headerlink" title="segment fault"></a><a href="https://wiki.debian.org/InterpretingKernelOutputAtProcessCrash">segment fault</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> * Page fault error code bits:</span><br><span class="line"> *</span><br><span class="line"> *   bit 0 == 0: no page found1: protection fault</span><br><span class="line"> *   bit 1 == 0: <span class="built_in">read</span> access1: write access</span><br><span class="line"> *   bit 2 == 0: kernel-mode access1: user-mode access</span><br><span class="line"> *   bit 3 ==1: use of reserved bit detected</span><br><span class="line"> *   bit 4 ==1: fault was an instruction fetch</span><br><span class="line"> *   bit 5 ==1: protection keys block access</span><br><span class="line"> */</span><br><span class="line">enum x86_pf_error_code &#123;</span><br><span class="line">X86_PF_PROT=1 &lt;&lt; 0,</span><br><span class="line">X86_PF_WRITE=1 &lt;&lt; 1,</span><br><span class="line">X86_PF_USER=1 &lt;&lt; 2,</span><br><span class="line">X86_PF_RSVD=1 &lt;&lt; 3,</span><br><span class="line">X86_PF_INSTR=1 &lt;&lt; 4,</span><br><span class="line">X86_PF_PK=1 &lt;&lt; 5,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">#endif /* _ASM_X86_TRAPS_H */</span></span><br></pre></td></tr></table></figure><ul><li>bit2: 值为 1 时表示是用户态程序内存访问越界，值为 0 时表示是内核态程序内存访问越界</li><li>bit1: 值为 1 时表示是写操作导致内存访问越界，值为 0 时表示是读操作导致内存访问越界</li><li>bit0: 值为 1 表示没有足够的权限访问非法地址的内容， 值为 0 时表示访问的非法地址根本没有对应的页面，也就是无效地址</li></ul><h5 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h5><p>err 4</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ cat cpp_crash.cpp</span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line">void myprint(int* ptr) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    int *ptr = NULL;</span><br><span class="line">    myprint(ptr);</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ulimit</span> -S -c unlimited</span><br><span class="line">$ g++ cpp_crash.cpp -o a.out -g -rdynamic -finstrument-functions</span><br><span class="line">$ ./a.out</span><br><span class="line">$ dmesg </span><br><span class="line">a.out[36921]: segfault at 0 ip 00005585d34141d1 sp 00007ffc0e9c19b0 error 4 <span class="keyword">in</span> a.out[5585d3414000+1000]</span><br><span class="line">Code: ff ff f3 0f 1e fa 55 48 89 e5 53 48 83 ec 18 48 89 7d e8 48 8b 45 08 48 89 c6 48 8d 3d e1 ff ff ff e8 c3 fe ff ff 48 8b 45 e8 &lt;8b&gt; 00 89 c6 48 8d 3d 28 0e 00 00 b8 00 00 00 00 e8 9a fe ff ff 48</span><br><span class="line"></span><br><span class="line">$ $ gdb ./a.out core</span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">...</span><br><span class="line">Program terminated with signal SIGSEGV, Segmentation fault.</span><br><span class="line"><span class="comment">#0  0x00005585d34141d1 in myprint (ptr=0x0) at cpp_crash.cpp:5</span></span><br><span class="line">5    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *ptr);</span><br><span class="line">(gdb) </span><br><span class="line"></span><br><span class="line">$ nm -gC a.out </span><br><span class="line">0000000000004018 B __bss_start</span><br><span class="line">                 w __cxa_finalize@@GLIBC_2.2.5</span><br><span class="line">                 U __cyg_profile_func_enter@@GLIBC_2.2.5</span><br><span class="line">                 U __cyg_profile_func_exit@@GLIBC_2.2.5</span><br><span class="line">0000000000004000 D __data_start</span><br><span class="line">0000000000004000 W data_start</span><br><span class="line">0000000000004018 D _edata</span><br><span class="line">0000000000004020 B _end</span><br><span class="line">                 w __gmon_start__</span><br><span class="line">                 U __gxx_personality_v0@@CXXABI_1.3</span><br><span class="line">0000000000002000 R _IO_stdin_used</span><br><span class="line">                 w _ITM_deregisterTMCloneTable</span><br><span class="line">                 w _ITM_registerTMCloneTable</span><br><span class="line">0000000000001320 T __libc_csu_fini</span><br><span class="line">00000000000012b0 T __libc_csu_init</span><br><span class="line">                 U __libc_start_main@@GLIBC_2.2.5</span><br><span class="line">0000000000001227 T main</span><br><span class="line">                 U <span class="built_in">printf</span>@@GLIBC_2.2.5</span><br><span class="line">00000000000010c0 T _start</span><br><span class="line">                 U _Unwind_Resume@@GCC_3.0</span><br><span class="line">00000000000011a9 T myprint(int*)</span><br></pre></td></tr></table></figure><p>Got the issue line by gdb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Mon May 10 10:57:22 2021] a.out[733]: segfault at 0 ip 000000000040092f sp 00007ffe8e80aa80 error 4 <span class="keyword">in</span> a.out[400000+1000]</span><br><span class="line"></span><br><span class="line"><span class="comment"># calculate the relative address</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123; printf &quot;%x\n&quot;, strtonum(0x40092f-0x400000) &#125;&#x27;</span></span><br><span class="line">92f</span><br><span class="line">$ objdump -d a.out &gt; a.obj</span><br><span class="line"></span><br><span class="line"><span class="comment">## the myprint function</span></span><br><span class="line">$ grep -i 92f a.obj -A 5 -B 11</span><br><span class="line">000000000040090d &lt;_Z7myprintPi&gt;:</span><br><span class="line">  40090d:55                   push   %rbp</span><br><span class="line">  40090e:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  400911:53                   push   %rbx</span><br><span class="line">  400912:48 83 ec 18          sub    <span class="variable">$0x18</span>,%rsp</span><br><span class="line">  400916:48 89 7d e8          mov    %rdi,-0x18(%rbp)</span><br><span class="line">  40091a:48 8b 45 08          mov    0x8(%rbp),%rax</span><br><span class="line">  40091e:48 89 c6             mov    %rax,%rsi</span><br><span class="line">  400921:bf 0d 09 40 00       mov    <span class="variable">$0x40090d</span>,%edi</span><br><span class="line">  400926:e8 b5 fe ff ff       callq  4007e0 &lt;__cyg_profile_func_enter@plt&gt;</span><br><span class="line">  40092b:48 8b 45 e8          mov    -0x18(%rbp),%rax</span><br><span class="line">  40092f:8b 00                mov    (%rax),%eax</span><br><span class="line">  400931:89 c6                mov    %eax,%esi</span><br><span class="line">  400933:bf 80 0a 40 00       mov    <span class="variable">$0x400a80</span>,%edi</span><br><span class="line">  400938:b8 00 00 00 00       mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">  40093d:e8 6e fe ff ff       callq  4007b0 &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">  400942:48 8b 45 08          mov    0x8(%rbp),%rax</span><br></pre></td></tr></table></figure><p>err 6, not exist addr     </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line">        *ptr = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>err 6, system protect addr</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> *ptr = (<span class="keyword">int</span> *)<span class="number">0</span>;</span><br><span class="line">        *ptr = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>err 7, write readonly addr</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> *ptr = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">        <span class="built_in">strcpy</span>(ptr, <span class="string">&quot;TEST&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>err 6, stack overflow</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="OS-settting"><a href="#OS-settting" class="headerlink" title="OS settting"></a>OS settting</h3><h4 id="Core-pattern"><a href="#Core-pattern" class="headerlink" title="Core pattern"></a>Core pattern</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/sys/kernel/core_pattern</span><br><span class="line">/usr/share/apport/apport %p %s %c %d %P %E</span><br><span class="line"><span class="comment">## kernel variable</span></span><br><span class="line">kernel.core_pattern = |/usr/share/apport/apport %p %s %c %d %P %E</span><br><span class="line"><span class="comment">#If the first character of the pattern is a &#x27;|&#x27;, the kernel will treat the rest of the pattern as a command to run.  The core dump will be written to the standard input of that program instead of to a file.</span></span><br><span class="line"></span><br><span class="line">kernel.core_pipe_limit = 0</span><br><span class="line"><span class="comment"># This sysctl is only applicable when core_pattern is configured to pipe core files to a user space helper (when the first character of core_pattern is a &#x27;|&#x27;, see above).  When collecting cores via a pipe to an application, it is occasionally useful for the collecting application to gather data about the crashing process from its /proc/pid directory.  In order to do this safely, the kernel must wait for the collecting process to exit, so as not to remove the crashing processes proc files prematurely.  This in turn creates the possibility that a misbehaving userspace collecting process can block the reaping of a crashed process simply by never exiting.  This sysctl defends against that. It defines how many concurrent crashing processes may be piped to user space applications in parallel.  If this value is exceeded, then those crashing processes above that value are noted via the kernel log and their cores are skipped.  0 is a special value, indicating that unlimited processes may be captured in parallel, but that no waiting will take place (i.e. the collecting process is not guaranteed access to `/proc/&lt;crashing pid&gt;/`).</span></span><br><span class="line"></span><br><span class="line">kernel.core_uses_pid = 0</span><br><span class="line">kernel.core_patternfs.suid_dumpable = 2</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ulimit</span> -S -c unlimited</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable genarate the core file</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -c n</span><br></pre></td></tr></table></figure><h4 id="Core-single"><a href="#Core-single" class="headerlink" title="Core single"></a>Core single</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">  Standard signals</span><br><span class="line">       Linux supports the standard signals listed below.  Several signal  numbers  are  architecture-dependent,  as</span><br><span class="line">       indicated  <span class="keyword">in</span>  the  <span class="string">&quot;Value&quot;</span> column.  (Where three values are given, the first one is usually valid <span class="keyword">for</span> alpha</span><br><span class="line">       and sparc, the middle one <span class="keyword">for</span> x86, arm, and most other architectures, and the last one  <span class="keyword">for</span>  mips.   (Values</span><br><span class="line">       <span class="keyword">for</span>  parisc  are  not shown; see the Linux kernel <span class="built_in">source</span> <span class="keyword">for</span> signal numbering on that architecture.)  A dash</span><br><span class="line">       (-) denotes that a signal is absent on the corresponding architecture.</span><br><span class="line"></span><br><span class="line">       First the signals described <span class="keyword">in</span> the original POSIX.1-1990 standard.</span><br><span class="line"></span><br><span class="line">       Signal     Value     Action   Comment</span><br><span class="line">       ──────────────────────────────────────────────────────────────────────</span><br><span class="line">       SIGQUIT       3       Core    Quit from keyboard</span><br><span class="line">       SIGILL        4       Core    Illegal Instruction</span><br><span class="line">       SIGABRT       6       Core    Abort signal from abort(3)</span><br><span class="line">       SIGFPE        8       Core    Floating-point exception</span><br><span class="line">       SIGSEGV      11       Core    Invalid memory reference</span><br><span class="line"></span><br><span class="line">       The signals SIGKILL and SIGSTOP cannot be caught, blocked, or ignored.</span><br><span class="line"></span><br><span class="line">       Next the signals not <span class="keyword">in</span> the POSIX.1-1990 standard but described <span class="keyword">in</span> SUSv2 and POSIX.1-2001.</span><br><span class="line"></span><br><span class="line">       Signal       Value     Action   Comment</span><br><span class="line">       ────────────────────────────────────────────────────────────────────</span><br><span class="line">       SIGBUS      10,7,10     Core    Bus error (bad memory access)</span><br><span class="line">       SIGSYS      12,31,12    Core    Bad system call (SVr4);</span><br><span class="line">                                       see also seccomp(2)</span><br><span class="line">       SIGTRAP        5        Core    Trace/breakpoint <span class="built_in">trap</span></span><br><span class="line">       SIGXCPU     24,24,30    Core    CPU time <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">                                       see setrlimit(2)</span><br><span class="line">       SIGXFSZ     25,25,31    Core    File size <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">                                       see setrlimit(2)</span><br><span class="line">       Up to and including Linux 2.2, the default behavior <span class="keyword">for</span> SIGSYS,  SIGXCPU,  SIGXFSZ,  and  (on  architectures</span><br><span class="line">       other  than  SPARC and MIPS) SIGBUS was to terminate the process (without a core dump).  (On some other UNIX</span><br><span class="line">       systems the default action <span class="keyword">for</span> SIGXCPU and SIGXFSZ is to terminate the process without a core dump.)   Linux</span><br><span class="line">       2.4 conforms to the POSIX.1-2001 requirements <span class="keyword">for</span> these signals, terminating the process with a core dump.</span><br><span class="line"></span><br><span class="line">       Next various other signals.</span><br><span class="line"></span><br><span class="line">       Signal       Value     Action   Comment</span><br><span class="line">       ────────────────────────────────────────────────────────────────────</span><br><span class="line">       SIGIOT         6        Core    IOT <span class="built_in">trap</span>. A synonym <span class="keyword">for</span> SIGABRT</span><br><span class="line">       SIGUNUSED    -,31,-     Core    Synonymous with SIGSYS</span><br><span class="line"></span><br><span class="line">       (Signal 29 is SIGINFO / SIGPWR on an alpha but SIGLOST on a sparc.)</span><br><span class="line"></span><br><span class="line">       SIGEMT  is  not  specified  <span class="keyword">in</span>  POSIX.1-2001, but nevertheless appears on most other UNIX systems, <span class="built_in">where</span> its</span><br><span class="line">       default action is typically to terminate the process with a core dump.</span><br><span class="line"></span><br><span class="line">       SIGPWR (<span class="built_in">which</span> is not specified <span class="keyword">in</span> POSIX.1-2001) is typically ignored by default on those other UNIX  systems</span><br><span class="line">       <span class="built_in">where</span> it appears.</span><br><span class="line"></span><br><span class="line">       SIGIO (<span class="built_in">which</span> is not specified <span class="keyword">in</span> POSIX.1-2001) is ignored by default on several other UNIX systems.</span><br><span class="line"></span><br><span class="line">       Where defined, SIGUNUSED is synonymous with SIGSYS on most architectures.  Since glibc 2.26, SIGUNUSED is no</span><br><span class="line">       longer defined on any architecture.</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">kill</span> -l</span><br><span class="line"> 1) SIGHUP   2) SIGINT   3) SIGQUIT  4) SIGILL   5) SIGTRAP</span><br><span class="line"> 6) SIGABRT  7) SIGBUS   8) SIGFPE   9) SIGKILL 10) SIGUSR1</span><br><span class="line">11) SIGSEGV 12) SIGUSR2 13) SIGPIPE 14) SIGALRM 15) SIGTERM</span><br><span class="line">16) SIGSTKFLT   17) SIGCHLD 18) SIGCONT 19) SIGSTOP 20) SIGTSTP</span><br><span class="line">21) SIGTTIN 22) SIGTTOU 23) SIGURG  24) SIGXCPU 25) SIGXFSZ</span><br><span class="line">26) SIGVTALRM   27) SIGPROF 28) SIGWINCH    29) SIGIO   30) SIGPWR</span><br><span class="line">31) SIGSYS  34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3</span><br><span class="line">38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8</span><br><span class="line">43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13</span><br><span class="line">48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12</span><br><span class="line">53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7</span><br><span class="line">58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2</span><br><span class="line">63) SIGRTMAX-1  64) SIGRTMAX</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SigPnd: 0000000000000000: Signals Pending (Raised, but waiting to be acted upon potentially because they are blocked).</span><br><span class="line">SigBlk: 0000000056727a01: Signals that are blocked by the process. This can be a temporary thing. The application can be coded <span class="keyword">in</span> such a way to temporarily block a signal. The kernel will <span class="keyword">then</span> delay delivery of that signal until such time as it becomes unblocked or the signals are asked to be delivered.</span><br><span class="line">SigIgn: 0000000000381000: Signals that are ignored by the process. They are simply thrown away. (Except <span class="keyword">for</span> SIGKILL and SIGSTOP, <span class="built_in">which</span> cannot be ignored)</span><br><span class="line">SigCgt: 000000004b817efb: Signals that can be caught by the process.</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 4b817efb | xxd -r -p | xxd -b</span><br><span class="line">01001011 10000001 01111110 11111011</span><br><span class="line"> |  | || |      |  ||||||  ||||| ||</span><br><span class="line"> |  | || |      |  ||||||  ||||| |+--  1 SIGHUP (hangup)</span><br><span class="line"> |  | || |      |  ||||||  ||||| +---  2 SIGINT (interrupt)</span><br><span class="line"> |  | || |      |  ||||||  ||||+-----  4 SIGILL (illegal instruction)</span><br><span class="line"> |  | || |      |  ||||||  |||+------  5 SIGTRAP (trace/<span class="built_in">trap</span>)</span><br><span class="line"> |  | || |      |  ||||||  ||+-------  6 SIGABRT (abort)</span><br><span class="line"> |  | || |      |  ||||||  |+--------  7 SIGEMT (emulation <span class="built_in">trap</span>)</span><br><span class="line"> |  | || |      |  ||||||  +---------  8 SIGFPE (floating point exception)</span><br><span class="line"> |  | || |      |  |||||+------------ 10 SIGBUS (bus error)</span><br><span class="line"> |  | || |      |  ||||+------------- 11 SIGSEGV (segmentation violation)</span><br><span class="line"> |  | || |      |  |||+-------------- 12 SIGSYS (bad system call)</span><br><span class="line"> |  | || |      |  ||+--------------- 13 SIGPIPE (broken pipe)</span><br><span class="line"> |  | || |      |  |+---------------- 14 SIGALRM (alarm)</span><br><span class="line"> |  | || |      |  +----------------- 15 SIGTERM (termination)</span><br><span class="line"> |  | || |      +-------------------- 17 SIGUSR2 (user signal 2)</span><br><span class="line"> |  | || +--------------------------- 24 SIGTSTP (stop -- can be ignored)</span><br><span class="line"> |  | |+----------------------------- 25 SIGCONT (<span class="built_in">continue</span>)</span><br><span class="line"> |  | +------------------------------ 26 SIGTTIN (terminal input)</span><br><span class="line"> |  +-------------------------------- 28 SIGVTALRM (timer expiration)</span><br><span class="line"> +----------------------------------- 31 SIGXFSZ (file size exceeded)</span><br><span class="line"></span><br><span class="line">cat /proc/<span class="variable">$pid</span>/status | grep Sig</span><br><span class="line">SigQ:6/513952</span><br><span class="line">SigPnd:0000000000040100</span><br><span class="line">SigBlk:0000000000000000</span><br><span class="line">SigIgn:0000000000000000</span><br><span class="line">SigCgt:0000000180000000</span><br></pre></td></tr></table></figure><h5 id="Test-SIGSEGV"><a href="#Test-SIGSEGV" class="headerlink" title="Test SIGSEGV"></a><a href="http://blog.cuicc.com/blog/2012/09/17/core-dump-and-backtrace/">Test SIGSEGV</a></h5><ul><li>kill -11 $pid means send the SIGSEGV to trigger the segment fault</li><li>define the invaid point signal code=128 (SI_KERNEL)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *foo = (<span class="keyword">int</span> *)<span class="number">-1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *foo);</span><br></pre></td></tr></table></figure></li><li>define the empty point and evaluation signal code=1 (SEGV_MAPERR)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *foo = <span class="literal">NULL</span>;</span><br><span class="line">*foo = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *foo);</span><br></pre></td></tr></table></figure></li><li>Malloc the memory and protect it (signal code=2 (SEGV_ACCERR))<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *foo;</span><br><span class="line">posix_memalign(&amp;foo, getpagesize(), getpagesize());</span><br><span class="line"><span class="built_in">memset</span>(foo, <span class="string">&#x27;A&#x27;</span>, getpagesize());</span><br><span class="line">mprotect(foo, getpagesize(), PROT_NONE);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, foo[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure></li></ul><h4 id="Enable-ptrace-permissions"><a href="#Enable-ptrace-permissions" class="headerlink" title="Enable ptrace permissions"></a>Enable ptrace permissions</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysctl.d/10-ptrace.conf</span><br><span class="line">kernel.yama.ptrace_scope = 0</span><br><span class="line"></span><br><span class="line">0 - classic ptrace permissions: a process can PTRACE_ATTACH to any other</span><br><span class="line">    process running under the same uid, as long as it is dumpable (i.e.</span><br><span class="line">    did not transition uids, start privileged, or have called</span><br><span class="line">    prctl(PR_SET_DUMPABLE...) already). Similarly, PTRACE_TRACEME is</span><br><span class="line">    unchanged.</span><br><span class="line"></span><br><span class="line">1 - restricted ptrace: a process must have a predefined relationship</span><br><span class="line">    with the inferior it wants to call PTRACE_ATTACH on. By default,</span><br><span class="line">    this relationship is that of only its descendants when the above</span><br><span class="line">    classic criteria is also met. To change the relationship, an</span><br><span class="line">    inferior can call prctl(PR_SET_PTRACER, debugger, ...) to <span class="built_in">declare</span></span><br><span class="line">    an allowed debugger PID to call PTRACE_ATTACH on the inferior.</span><br><span class="line">    Using PTRACE_TRACEME is unchanged.</span><br><span class="line"></span><br><span class="line">2 - admin-only attach: only processes with CAP_SYS_PTRACE may use ptrace</span><br><span class="line">    with PTRACE_ATTACH, or through children calling PTRACE_TRACEME.</span><br><span class="line"></span><br><span class="line">3 - no attach: no processes may use ptrace with PTRACE_ATTACH nor via</span><br><span class="line">    PTRACE_TRACEME. Once <span class="built_in">set</span>, this sysctl value cannot be changed.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Genarate-the-debug-info"><a href="#Genarate-the-debug-info" class="headerlink" title="Genarate the debug info"></a>Genarate the debug info</h3><ul><li>-g produces debugging information in theOS native format</li><li>-ggdb produces debugging information specifically intennded for gdb</li><li>-ggdb3 produces extra debugging information, for example: including macro definitions</li><li>wall means enable warnning</li><li>-O0  turn off all optimization</li><li>-O1 ,-O2, -O3  optimization<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./configure CFLAGS=<span class="string">&quot;-Wall -O2 -ggdb3&quot;</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### Genarate the core file</span></span><br><span class="line">usage:  gcore [-a] [-o filename] pid</span><br><span class="line">```bash</span><br><span class="line">$ gcore -o /tmp/core -p <span class="variable">$pid</span></span><br></pre></td></tr></table></figure></li></ul><p>for the kernel</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br></pre></td></tr></table></figure><h3 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install ubuntu-dbgsym-keyring</span><br></pre></td></tr></table></figure><h3 id="Open-the-core-file"><a href="#Open-the-core-file" class="headerlink" title="Open the core file"></a>Open the core file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ gdb ./a.out ./bubble_sort_core</span><br><span class="line"></span><br><span class="line">GNU gdb (Ubuntu 8.1-0ubuntu3.2) 8.1.0.20180409-git</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">Reading symbols from ./a.out...done.</span><br><span class="line">[New LWP 20410]</span><br><span class="line">Core was generated by `./a.out<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGABRT, Aborted.</span></span><br><span class="line"><span class="string">#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51</span></span><br><span class="line"><span class="string">51../sysdeps/unix/sysv/linux/raise.c: No such file or directory.</span></span><br></pre></td></tr></table></figure><h3 id="attach-the-process"><a href="#attach-the-process" class="headerlink" title="attach the process"></a>attach the process</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gdb attach <span class="variable">$PID</span></span><br><span class="line">$ gdb ./the_programA_binray <span class="variable">$pid_of_the_programA</span></span><br></pre></td></tr></table></figure><h3 id="gdb-basic-cmd"><a href="#gdb-basic-cmd" class="headerlink" title="gdb basic cmd"></a>gdb basic cmd</h3><p>break<br>break +offset<br>break -offset<br>break linenum<br>break filename:linenum<br>break func_name<br>break filename:func_name<br>break *address<br>break … if <condition><br>break where if </p><p>(gdb) break *func_b+0x23<br>Breakpoint 1 at 0x804898f: file backtrace.c, line 59.</p><p>display ## ultra print</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta"># not work</span></span><br><span class="line"><span class="keyword">break</span> foo <span class="keyword">if</span> i&gt;<span class="number">0</span></span><br><span class="line">commands</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;i is %d\n&quot;</span>, i</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="built_in">end</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b func_name <span class="keyword">if</span> var_name == 5</span><br></pre></td></tr></table></figure><p>info break (i b)<br>i b n</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x564b218ff830: file ./bubble_sort_bug.c, line 29.</span><br><span class="line">(gdb) b <span class="built_in">exit</span></span><br><span class="line">Breakpoint 2 at 0x7f258be23120: file exit.c, line 139.</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x0000564b218ff830 <span class="keyword">in</span> main at ./bubble_sort_bug.c:29</span><br><span class="line">2       breakpoint     keep y   0x00007f258be23120 <span class="keyword">in</span> __GI_exit at exit.c:139</span><br><span class="line">(gdb) i b 2</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">2       breakpoint     keep y   0x00007f258be23120 <span class="keyword">in</span> __GI_exit at exit.c:139</span><br><span class="line">(gdb) b main <span class="keyword">if</span> i==1</span><br><span class="line">Breakpoint 4 at 0x555555554830: file ./bubble_sort_bug.c, line 29.</span><br></pre></td></tr></table></figure><p>watch var   It is stopped by the gdb after the write has occurred<br>rwatch var  It is stopped by the gdb after the read has occurred<br>awatch var  It is stopped by the gdb after the read and write have occurred</p><p>step  (in function0<br>next  (not go to function)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info b</span><br><span class="line">No breakpoints or watchpoints.</span><br><span class="line">(gdb) watch a <span class="keyword">if</span> a==5 </span><br><span class="line">Hardware watchpoint 3: a</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">3       hw watchpoint  keep y                      a</span><br><span class="line">stop only <span class="keyword">if</span> a==5</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 2 <span class="string">&quot;a.out&quot;</span> hit Hardware watchpoint 3: a</span><br><span class="line"></span><br><span class="line">Old value = 4</span><br><span class="line">New value = 5</span><br><span class="line">thread1_func (p_arg=0x555555554844) at thread1.c:10</span><br><span class="line">10                sleep(10);</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">(gdb) info watchpoints</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">3       hw watchpoint  keep y                      a</span><br><span class="line">stop only <span class="keyword">if</span> a==5</span><br><span class="line">breakpoint already hit 1 time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(gdb) watch 0x600850</span><br><span class="line">Cannot watch constant value 0x600850.</span><br><span class="line">(gdb) watch *(int *) 0x600850</span><br><span class="line">Watchpoint 1: *(int *) 6293584 </span><br></pre></td></tr></table></figure><p>catch <event><br>tcatch <event>  (temp catch)<br>event: throw,catch,exec,fork,load,unload,exception,exception unhandled,assert,syscall [name | number ],</p><p>(gdb) catch syscall open<br>Catchpoint 7 (syscall ‘open’ [2])<br>(gdb) catch syscall 5<br>Catchpoint 8 (syscall ‘fstat’ [5])<br>(gdb) help catch syscall<br>Catch system calls by their names, groups and/or numbers.<br>Arguments say which system calls to catch.  If no arguments are given,<br>every system call will be caught.  Arguments, if given, should be one<br>or more system call names (if your system supports that), system call<br>groups or system call numbers.</p><p>for more syscall<br>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</p><p>clear #clear all<br>clear function<br>clear linenum</p><p>delete beakpoints [range,eg: 1-5]</p><p>enable/disable breakpoints [range]<br>enable breakpoints once range<br>enable breakpoints delete range</p><p>set logging file the_log_filename<br>set logging on/off<br>set env PATH=/tmp/bin<br>set listsize 25</p><h1 id="set-print-variable-length"><a href="#set-print-variable-length" class="headerlink" title="set print variable length"></a>set print variable length</h1><p>set print elements 250<br>set print elements 0 #no limit</p><p>set step-mode on<br>This is useful in cases where you may be interested in inspecting the machine instructions of a function which has no symbolic info and do not want GDB to automatically skip over this function.</p><p>save br .gdb_20200601<br>-x .gdb_20200601</p><p>finish<br>Continue running until just after function in the selected stack frame returns. Print the returned value (if any). This command can be abbreviated as fin.</p><p>return</p><p>print expr<br>Evaluate the expression expr and display the resulting value. The expression may include calls to functions in the program being debugged.</p><p>call expr<br>Evaluate the expression expr without displaying void returned values.<br>You can use this variant of the print command if you want to execute a function from your program that does not return anything (a.k.a. a void function), but without cluttering the output with void returned values that GDB will otherwise print. If the result is not void, it is printed and saved in the value history.<br>It is possible for the function you call via the print or call command to generate a signal (e.g., if there’s a bug in the function, or if you passed it incorrect arguments). What happens in that case is controlled by the set unwindonsignal command.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51</span></span><br><span class="line"><span class="comment">#1  0x00007f258be20801 in __GI_abort () at abort.c:79</span></span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort, </span></span><br><span class="line">    fmt=fmt@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line"><span class="comment">#3  0x00007f258bf14cd1 in __GI___fortify_fail_abort (need_backtrace=need_backtrace@entry=false, </span></span><br><span class="line">    msg=msg@entry=0x7f258bf96966 <span class="string">&quot;stack smashing detected&quot;</span>) at fortify_fail.c:33</span><br><span class="line"><span class="comment">#4  0x00007f258bf14c92 in __stack_chk_fail () at stack_chk_fail.c:29</span></span><br><span class="line"><span class="comment">#5  0x0000564b218ff8e9 in main () at ./bubble_sort_bug.c:43</span></span><br><span class="line"></span><br><span class="line">(gdb) f 2</span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort, </span></span><br><span class="line">    fmt=fmt@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line">181../sysdeps/posix/libc_fatal.c: No such file or directory.</span><br><span class="line">(gdb) up</span><br><span class="line"><span class="comment">#3  0x00007f258bf14cd1 in __GI___fortify_fail_abort (need_backtrace=need_backtrace@entry=false, </span></span><br><span class="line">    msg=msg@entry=0x7f258bf96966 <span class="string">&quot;stack smashing detected&quot;</span>) at fortify_fail.c:33</span><br><span class="line">33fortify_fail.c: No such file or directory.</span><br><span class="line">(gdb) down</span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort, </span></span><br><span class="line">    fmt=fmt@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line">181../sysdeps/posix/libc_fatal.c: No such file or directory.</span><br><span class="line"></span><br><span class="line">(gdb) f 5</span><br><span class="line"><span class="comment">#5  0x0000564b218ff8e9 in main () at ./bubble_sort_bug.c:43</span></span><br><span class="line">43&#125;</span><br><span class="line">(gdb) info f</span><br><span class="line">Stack level 5, frame at 0x7ffd58ea9f80:</span><br><span class="line"> rip = 0x564b218ff8e9 <span class="keyword">in</span> main (./bubble_sort_bug.c:43); saved rip = 0x7f258be01b97</span><br><span class="line"> <span class="built_in">caller</span> of frame at 0x7ffd58ea9e40</span><br><span class="line"> <span class="built_in">source</span> language c.</span><br><span class="line"> Arglist at 0x7ffd58ea9f70, args: </span><br><span class="line"> Locals at 0x7ffd58ea9f70, Previous frame<span class="string">&#x27;s sp is 0x7ffd58ea9f80</span></span><br><span class="line"><span class="string"> Saved registers:</span></span><br><span class="line"><span class="string">  rbx at 0x7ffd58ea9f68, rbp at 0x7ffd58ea9f70, rip at 0x7ffd58ea9f78</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) info args</span></span><br><span class="line"><span class="string">No arguments.</span></span><br><span class="line"><span class="string">(gdb) info locals</span></span><br><span class="line"><span class="string">array = &#123;20424913, 207764369, 232957269, 286304630, 340051919, 418929367, 428095442, 560929304, 622631137, </span></span><br><span class="line"><span class="string">  681405812, 702646332, 717507172, 771731937, 844764348, 871741416, 893622553, 939367001, 953569863, 983680782, </span></span><br><span class="line"><span class="string">  1133421906, 1150235085, 1170267861, 1267699692, 1278859841, 1351132359, 1478380837, 1618765791, 1747714870, </span></span><br><span class="line"><span class="string">  2015283722, 2027462427, 2046956728, 2080576919&#125;</span></span><br><span class="line"><span class="string">i = 36</span></span><br></pre></td></tr></table></figure><p>info</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info <span class="built_in">functions</span> thread1_func </span><br><span class="line">All <span class="built_in">functions</span> matching regular expression <span class="string">&quot;thread1_func&quot;</span>:</span><br><span class="line"></span><br><span class="line">File thread1.c:</span><br><span class="line">void *thread1_func(void *);</span><br></pre></td></tr></table></figure><p>print</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">(gdb) list</span><br><span class="line">1<span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line">2<span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line">3</span><br><span class="line">4void printArray(int arr[], int n)</span><br><span class="line">5&#123;</span><br><span class="line">6   <span class="keyword">for</span> (int i=0; i&lt;n; i++) &#123;</span><br><span class="line">7     arr[i]=arr[i]+i;</span><br><span class="line">8     <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line">9   &#125;</span><br><span class="line">10&#125;</span><br><span class="line">11</span><br><span class="line">12int main()</span><br><span class="line">13&#123;</span><br><span class="line">14    int n = 10;</span><br><span class="line">15    int arr[n];</span><br><span class="line">16</span><br><span class="line">17    // Fill whole array with 100.</span><br><span class="line">18    memset(arr, 10, n*sizeof(arr[0]));</span><br><span class="line">19    <span class="built_in">printf</span>(<span class="string">&quot;Array after memset()\n&quot;</span>);</span><br><span class="line">20    printArray(arr, n);</span><br><span class="line">21</span><br><span class="line">22    <span class="built_in">return</span> 0;</span><br><span class="line">23&#125;</span><br><span class="line"></span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x00000000004005d5 <span class="keyword">in</span> printArray at test2.c:7</span><br><span class="line">breakpoint already hit 10 <span class="built_in">times</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span><br><span class="line">7     arr[i]=arr[i]+i;</span><br><span class="line">(gdb) <span class="built_in">print</span> arr</span><br><span class="line"><span class="variable">$13</span> = (int *) 0x7fffffffe0d0</span><br><span class="line">(gdb) <span class="built_in">print</span> *arr</span><br><span class="line"><span class="variable">$14</span> = 168430090</span><br><span class="line">(gdb) <span class="built_in">print</span> *arr@</span><br><span class="line">A syntax error <span class="keyword">in</span> expression, near `<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 3</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430090, 168430090, 168430090, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">$15 = 4</span></span><br><span class="line"><span class="string">(gdb) p arr[i]</span></span><br><span class="line"><span class="string">$16 = 168430090</span></span><br><span class="line"><span class="string">(gdb) p arr[20]</span></span><br><span class="line"><span class="string">$17 = -7664</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">Continuing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">7     arr[i]=arr[i]+i;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">$20 = 5</span></span><br><span class="line"><span class="string">(gdb) set arr[4]=125</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 5</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430093, 125, 168430090, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">Continuing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">7     arr[i]=arr[i]+i;</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 6</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430093, 168430094, 168430095, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">No symbol &quot;i&quot; in current context.</span></span><br><span class="line"><span class="string">(gdb) p $i</span></span><br><span class="line"><span class="string">$24 = 5</span></span><br><span class="line"><span class="string">(gdb) set arr[$i]=10</span></span><br><span class="line"><span class="string">(gdb) set arr[$i++]=11</span></span><br><span class="line"><span class="string">(gdb) p arr[5]</span></span><br><span class="line"><span class="string">$26 = 10</span></span><br><span class="line"><span class="string">(gdb) p arr[6]</span></span><br><span class="line"><span class="string">$27 = 11</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) p/t arr[6]</span></span><br><span class="line"><span class="string">$28 = 1011</span></span><br><span class="line"><span class="string">(gdb) p/x arr[6]</span></span><br><span class="line"><span class="string">$29 = 0xb</span></span><br><span class="line"><span class="string">(gdb) p/f arr[6]</span></span><br><span class="line"><span class="string">$30 = 1.54142831e-44</span></span><br><span class="line"><span class="string">(gdb) p/c arr[6]</span></span><br><span class="line"><span class="string">$31 = 11 &#x27;</span>\v<span class="string">&#x27;</span></span><br><span class="line"><span class="string">(gdb) p/d arr[6]</span></span><br><span class="line"><span class="string">$32 = 11</span></span><br><span class="line"><span class="string">(gdb) p/o arr[6]</span></span><br><span class="line"><span class="string">$33 = 013</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">examine (x command)</span></span><br><span class="line"><span class="string">(gdb) p arr</span></span><br><span class="line"><span class="string">$37 = &#123;168430090, 168430091, 168430092, 168430093, 168430094, 10, 11, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">      __________ same with print format</span></span><br><span class="line"><span class="string">      |</span></span><br><span class="line"><span class="string">x/[n][f][u]</span></span><br><span class="line"><span class="string">   |     |</span></span><br><span class="line"><span class="string"> number  -------------- b. Bytes. h. Halfwords (two bytes). w. Words (four bytes) This is the initial default.  g. Giant words (eight bytes)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) x/10d arr</span></span><br><span class="line"><span class="string">0x7fffffffe0d0:168430090168430091168430092168430093</span></span><br><span class="line"><span class="string">0x7fffffffe0e0:1684300941011168430090</span></span><br><span class="line"><span class="string">0x7fffffffe0f0:168430090168430090</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) info reg</span></span><br><span class="line"><span class="string">rax            0x400aaae297396d094614688658370948361</span></span><br><span class="line"><span class="string">rbx            0x7fffffffe100140737488347392</span></span><br><span class="line"><span class="string">rcx            0x7fffdfafe9b0140736946235824</span></span><br><span class="line"><span class="string">rdx            0xa10</span></span><br><span class="line"><span class="string">rsi            0xa10</span></span><br><span class="line"><span class="string">rdi            0x7fffffffe0d0140737488347344</span></span><br><span class="line"><span class="string">rbp            0x7fffffffe0c00x7fffffffe0c0</span></span><br><span class="line"><span class="string">rsp            0x7fffffffe0900x7fffffffe090</span></span><br><span class="line"><span class="string">r8             0xffffffffffffffff-1</span></span><br><span class="line"><span class="string">r9             0x00</span></span><br><span class="line"><span class="string">r10            0x2234</span></span><br><span class="line"><span class="string">r11            0x246582</span></span><br><span class="line"><span class="string">r12            0x4004d04195536</span></span><br><span class="line"><span class="string">r13            0x7fffffffe210140737488347664</span></span><br><span class="line"><span class="string">r14            0x00</span></span><br><span class="line"><span class="string">r15            0x00</span></span><br><span class="line"><span class="string">rip            0x4005da0x4005da &lt;printArray+29&gt;</span></span><br><span class="line"><span class="string">eflags         0x206[ PF IF ]</span></span><br><span class="line"><span class="string">cs             0x3351</span></span><br><span class="line"><span class="string">ss             0x2b43</span></span><br><span class="line"><span class="string">ds             0x00</span></span><br><span class="line"><span class="string">es             0x00</span></span><br><span class="line"><span class="string">fs             0x00</span></span><br><span class="line"><span class="string">gs             0x00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) list</span></span><br><span class="line"><span class="string">1#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">2int main()</span></span><br><span class="line"><span class="string">3&#123;</span></span><br><span class="line"><span class="string">4        float x = 456.876;</span></span><br><span class="line"><span class="string">5        printf (&quot;\nx = %f\n&quot;, x);</span></span><br><span class="line"><span class="string">6        return 0;</span></span><br><span class="line"><span class="string">7&#125;</span></span><br><span class="line"><span class="string">(gdb) b 4</span></span><br><span class="line"><span class="string">Breakpoint 1 at 0x400535: file float.c, line 4.</span></span><br><span class="line"><span class="string">(gdb) b 5</span></span><br><span class="line"><span class="string">Breakpoint 2 at 0x40053e: file float.c, line 5.</span></span><br><span class="line"><span class="string">(gdb) b 6</span></span><br><span class="line"><span class="string">Breakpoint 3 at 0x400555: file float.c, line 6.</span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">The program is not being run.</span></span><br><span class="line"><span class="string">(gdb) start</span></span><br><span class="line"><span class="string">Temporary breakpoint 4 at 0x400535: file float.c, line 4.</span></span><br><span class="line"><span class="string">Starting program: /root/./a.out</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, main () at float.c:4</span></span><br><span class="line"><span class="string">4        float x = 456.876;</span></span><br><span class="line"><span class="string">(gdb) n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 2, main () at float.c:5</span></span><br><span class="line"><span class="string">5        printf (&quot;\nx = %f\n&quot;, x);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) p x</span></span><br><span class="line"><span class="string">$5 = 456.876007</span></span><br><span class="line"><span class="string">(gdb) x/fw &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe12c:456.876007</span></span><br><span class="line"><span class="string">(gdb) x/tw &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe12c:01000011111001000111000000100001</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### modify the float to double</span></span><br><span class="line"><span class="string">(gdb) list</span></span><br><span class="line"><span class="string">1#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">2int main()</span></span><br><span class="line"><span class="string">3&#123;</span></span><br><span class="line"><span class="string">4        //float x = 456.876;</span></span><br><span class="line"><span class="string">5        double x = 456.876;</span></span><br><span class="line"><span class="string">6        printf (&quot;\nx = %lf\n&quot;, x);</span></span><br><span class="line"><span class="string">7        return 0;</span></span><br><span class="line"><span class="string">8&#125;</span></span><br><span class="line"><span class="string">(gdb) x/1fg &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe128:456.87599999999998</span></span><br><span class="line"><span class="string">(gdb) x/1tg &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe128:0100000001111100100011100000010000011000100100110111010010111100</span></span><br><span class="line"><span class="string">(gdb) p x</span></span><br><span class="line"><span class="string">$6 = 456.87599999999998</span></span><br></pre></td></tr></table></figure><h3 id="print-argv"><a href="#print-argv" class="headerlink" title="print argv"></a><a href="https://wizardforcel.gitbooks.io/100-gdb-tips/set-program-args.html">print argv</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -g3 walk1.c -o walk</span><br><span class="line">$ gdb ./walk <span class="comment"># or you could $ gdb -args ./walk /tmp 10</span></span><br><span class="line">Reading symbols from /root/walk...done.</span><br><span class="line"></span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x400bb8: file walk1.c, line 73.</span><br><span class="line">(gdb) r /tmp 10 <span class="comment">#  or you could (gdb) set args /tmp 10</span></span><br><span class="line">Starting program: /root/./walk /tmp 10</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main (argc=3, argv=0x7fffffffe138) at walk1.c:73</span><br><span class="line">73    <span class="keyword">if</span>(argc != 3)</span><br><span class="line">(gdb) p argc</span><br><span class="line"><span class="variable">$1</span> = 3</span><br><span class="line">(gdb) p argv</span><br><span class="line"><span class="variable">$2</span> = (char **) 0x7fffffffe138</span><br><span class="line">(gdb) p argv[0]</span><br><span class="line"><span class="variable">$3</span> = 0x7fffffffe414 <span class="string">&quot;/root/./walk&quot;</span></span><br><span class="line">(gdb) p argv[1]</span><br><span class="line"><span class="variable">$4</span> = 0x7fffffffe421 <span class="string">&quot;/tmp&quot;</span></span><br><span class="line">(gdb) p argv[2]</span><br><span class="line"><span class="variable">$5</span> = 0x7fffffffe426 <span class="string">&quot;10&quot;</span></span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"><span class="comment"># attach args</span></span><br><span class="line">$ gdb --args /bin/bash -c <span class="string">&#x27;ls -l&#x27;</span></span><br><span class="line">$ <span class="built_in">set</span> listsize 40</span><br><span class="line">$ p *args@4 </span><br><span class="line"></span><br><span class="line"><span class="comment"># if the software was install by source, you could add --directory for import debug symbol</span></span><br><span class="line"><span class="comment"># re-complie bash</span></span><br><span class="line"></span><br><span class="line">$ gdb --args /usr/<span class="built_in">local</span>/bin/bash -c <span class="string">&#x27;echo [1g]&#x27;</span> --directory ~/tools/bash-4.4</span><br><span class="line">(gdb) la src</span><br><span class="line"></span><br><span class="line"><span class="comment">## if you want disable optimze</span></span><br><span class="line">$ CFLAGS=<span class="string">&quot;-g -O0&quot;</span> CXXFLAGS=<span class="string">&quot;-g -O0&quot;</span> LDFLAGS=<span class="string">&quot;-g&quot;</span>  ./configure --enable-debugger</span><br><span class="line">$ CFLAGS=<span class="string">&quot;-g -O0&quot;</span> CXXFLAGS=<span class="string">&quot;-g -O0&quot;</span> LDFLAGS=<span class="string">&quot;-g&quot;</span>  ./make -j 2</span><br><span class="line"></span><br><span class="line"><span class="comment">## set debug directory</span></span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory &lt;directory&gt;</span><br><span class="line">(gdb) show debug-file-directory</span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory /usr/lib/debug</span><br><span class="line">add-symbol-file filename address</span><br><span class="line">add-symbol-file filename address [ -readnow ] [ -mapped ]</span><br><span class="line">add-symbol-file filename -ssection address ...</span><br></pre></td></tr></table></figure><h4 id="threads"><a href="#threads" class="headerlink" title="threads"></a>threads</h4><p>Demo code</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">mutex _mutex;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//g++ -std=c++11 testthread.cpp -o testthread -lpthread -g</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        lock_guard&lt;mutex&gt;lock(_mutex);</span><br><span class="line">        total +=num;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;num:&quot;</span>&lt;&lt;num&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(fun,<span class="number">3</span>)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(fun,<span class="number">5</span>)</span></span>;</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ gdb ./testthread</span><br><span class="line">$ info threads</span><br><span class="line">$ thread <span class="number">3</span> </span><br><span class="line">$ <span class="built_in">set</span> scheduler-locking on</span><br></pre></td></tr></table></figure><p>generate-core-file<br>``bash<br>(gdb) generate-core-file</p><h1 id="or"><a href="#or" class="headerlink" title="or"></a>or</h1><p>gcore $pid</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### golang</span><br><span class="line">```bash</span><br><span class="line">go build -gcflags <span class="string">&quot;-N -l&quot;</span> gdbsandbox.go</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -p <span class="variable">$pid</span></span><br><span class="line">(gdb) disas readline</span><br></pre></td></tr></table></figure><h3 id="debug-with-python"><a href="#debug-with-python" class="headerlink" title="debug with python"></a><a href="https://mozillazg.com/2017/07/debug-running-python-process-with-gdb.html">debug with python</a></h3><h3 id="gdb-note"><a href="#gdb-note" class="headerlink" title="gdb note"></a>gdb note</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">arch/x86/entry/calling<span class="number">.</span>h</span><br><span class="line">x86 function <span class="keyword">call</span> convention, <span class="number">64</span>-bit:</span><br><span class="line">-------------------------------------</span><br><span class="line"> arguments           | callee-saved       | extra caller-saved | return</span><br><span class="line">[callee-clobbered]   |                    | [callee-clobbered] |</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">rdi</span> <span class="built_in">rsi</span> <span class="built_in">rdx</span> <span class="built_in">rcx</span> <span class="built_in">r8</span>-<span class="number">9</span> | <span class="built_in">rbx</span> <span class="built_in">rbp</span> [*] <span class="built_in">r12</span>-<span class="number">15</span> | <span class="built_in">r10</span>-<span class="number">11</span>             | <span class="built_in">rax</span>, <span class="built_in">rdx</span> [**]</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> v1 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">float</span> v2 = <span class="number">0.01</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">long</span> b, <span class="keyword">short</span> c,<span class="keyword">char</span> d, <span class="keyword">long</span> <span class="keyword">long</span> e, <span class="keyword">float</span> f, <span class="keyword">double</span> g, <span class="keyword">int</span> *h, <span class="keyword">float</span> *i, <span class="keyword">char</span> *j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;a: %d, b:%ld, c:%d, d: %c, e: %lld\n&quot;</span></span><br><span class="line">   <span class="string">&quot;f: %.3e, g:%.3e\nh: %p, i: %p, j:%p\n&quot;</span>, a, b, c, d, e, f, g, h, i, j);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  func(<span class="number">100</span>, <span class="number">35000L</span>, <span class="number">5</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">123456789L</span>L, <span class="number">3.14</span>, <span class="number">2.99792458e8</span>, &amp;v1, &amp;v2, <span class="string">&quot;string&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b *func</span><br><span class="line">Breakpoint 1 at 0x40052d: file c_para.c, line 7.</span><br><span class="line">(gdb) run</span><br><span class="line">Starting program: /root/codes/./c_para</span><br><span class="line"></span><br><span class="line">Breakpoint 1, func (a=0, b=1, c=1629, d=0 <span class="string">&#x27;\000&#x27;</span>, e=0, f=2.21061657e-38, g=0, h=0x76, i=0x601038 &lt;v2&gt;, j=0x4006e7 <span class="string">&quot;string&quot;</span>) at c_para.c:7</span><br><span class="line">7&#123;</span><br><span class="line">(gdb) i r</span><br><span class="line">rax            0x41b1de784a0000004733809291562057728</span><br><span class="line">rbx            0x00</span><br><span class="line">rcx            0x4165                     -------&gt; args[3]</span><br><span class="line">rdx            0x55                      -------&gt; args[2]</span><br><span class="line">rsi            0x88b835000                  -------&gt; args[1]</span><br><span class="line">rdi            0x64100                    -------&gt; args[0]</span><br><span class="line">rbp            0x7fffffffe4000x7fffffffe400</span><br><span class="line">rsp            0x7fffffffe3d80x7fffffffe3d8</span><br><span class="line">r8             0x75bcd15123456789      -------&gt; args[4], args[5] and args[6] is the <span class="built_in">float</span> and double <span class="built_in">type</span>, save <span class="keyword">in</span> xmm (128 bits)</span><br><span class="line">r9             0x6010346295604                -------&gt; args[7]</span><br><span class="line">r10            0x7fffffffdf20140737488346912</span><br><span class="line">r11            0x7ffff7a2f460140737348039776</span><br><span class="line">r12            0x4004404195392</span><br><span class="line">r13            0x7fffffffe4e0140737488348384</span><br><span class="line">r14            0x00</span><br><span class="line">r15            0x00</span><br><span class="line">rip            0x40052d0x40052d &lt;func&gt;</span><br><span class="line">eflags         0x202[ IF ]</span><br><span class="line">cs             0x3351</span><br><span class="line">ss             0x2b43</span><br><span class="line">ds             0x00</span><br><span class="line">es             0x00</span><br><span class="line">fs             0x00</span><br><span class="line">gs             0x00</span><br><span class="line"></span><br><span class="line"><span class="comment">#because no enough register, two parameters save in stack (rsp register)</span></span><br><span class="line"><span class="comment">#In the stack begining, there is the function return addr, In x86_64, int and point size is the giant word (32 bits, 4 Bytes)</span></span><br><span class="line">0x7fffffffe3e8-0x7fffffffe3d8=16(dec)</span><br><span class="line"></span><br><span class="line">(gdb) x/3g <span class="variable">$rsp</span></span><br><span class="line">0x7fffffffe3d8:41958446295608</span><br><span class="line">0x7fffffffe3e8:4196071</span><br><span class="line"></span><br><span class="line"><span class="comment">#$rsp+0xc means The memory location 12 bytes above current stack pointer</span></span><br><span class="line"></span><br><span class="line">6295608=0x601038</span><br><span class="line">(gdb) <span class="built_in">printf</span> <span class="string">&quot;%.2f\n&quot;</span>, *(<span class="built_in">float</span>*)0x601038</span><br><span class="line">0.01</span><br><span class="line"></span><br><span class="line">or </span><br><span class="line">(gdb) <span class="built_in">printf</span> <span class="string">&quot;%.2f\n&quot;</span>, *(<span class="built_in">float</span>*)(*(unsigned long*)(<span class="variable">$rsp</span>+0x8))</span><br><span class="line">0.01</span><br><span class="line"></span><br><span class="line">4196071=0x4006E7</span><br><span class="line">(gdb) p (char*)0x4006E7</span><br><span class="line"><span class="variable">$9</span> = 0x4006e7 <span class="string">&quot;string&quot;</span></span><br><span class="line"></span><br><span class="line">long 8 bytes (64bit OS), 4 bytes (32bit OS)</span><br><span class="line">Add 8 bytes, go to <span class="variable">$rsp</span>+0x10</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line">0x10=16</span><br><span class="line">(gdb) p (char*)(*(unsigned long*)(<span class="variable">$rsp</span>+0x10))</span><br><span class="line"><span class="variable">$11</span> = 0x4006e7 <span class="string">&quot;string&quot;</span></span><br><span class="line"></span><br><span class="line">(gdb) disas func</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> func:</span><br><span class="line">=&gt; 0x000000000040052d &lt;+0&gt;:push   %rbp</span><br><span class="line">   0x000000000040052e &lt;+1&gt;:mov    %rsp,%rbp</span><br><span class="line">   0x0000000000400531 &lt;+4&gt;:sub    <span class="variable">$0x50</span>,%rsp</span><br><span class="line">   0x0000000000400535 &lt;+8&gt;:mov    %edi,-0x4(%rbp)</span><br><span class="line">   0x0000000000400538 &lt;+11&gt;:mov    %rsi,-0x10(%rbp)</span><br><span class="line">   0x000000000040053c &lt;+15&gt;:mov    %ecx,%eax</span><br><span class="line">   0x000000000040053e &lt;+17&gt;:mov    %r8,-0x20(%rbp)</span><br><span class="line">   0x0000000000400542 &lt;+21&gt;:movss  %xmm0,-0x18(%rbp)</span><br><span class="line">   0x0000000000400547 &lt;+26&gt;:movsd  %xmm1,-0x28(%rbp)</span><br><span class="line">   0x000000000040054c &lt;+31&gt;:mov    %r9,-0x30(%rbp)</span><br><span class="line">   0x0000000000400550 &lt;+35&gt;:mov    %dx,-0x8(%rbp)</span><br><span class="line">   0x0000000000400554 &lt;+39&gt;:mov    %al,-0x14(%rbp)</span><br><span class="line">   0x0000000000400557 &lt;+42&gt;:movss  -0x18(%rbp),%xmm0</span><br><span class="line">   0x000000000040055c &lt;+47&gt;:cvtps2pd %xmm0,%xmm0</span><br><span class="line">   0x000000000040055f &lt;+50&gt;:movsbl -0x14(%rbp),%r8d</span><br><span class="line">   0x0000000000400564 &lt;+55&gt;:movswl -0x8(%rbp),%ecx</span><br><span class="line">   0x0000000000400568 &lt;+59&gt;:mov    -0x28(%rbp),%rax</span><br><span class="line">   0x000000000040056c &lt;+63&gt;:mov    -0x20(%rbp),%r9</span><br><span class="line">   0x0000000000400570 &lt;+67&gt;:mov    -0x10(%rbp),%rdx</span><br><span class="line">   0x0000000000400574 &lt;+71&gt;:mov    -0x4(%rbp),%esi</span><br><span class="line">   0x0000000000400577 &lt;+74&gt;:mov    0x18(%rbp),%rdi</span><br><span class="line">   0x000000000040057b &lt;+78&gt;:mov    %rdi,0x10(%rsp)</span><br><span class="line">   0x0000000000400580 &lt;+83&gt;:mov    0x10(%rbp),%rdi</span><br><span class="line">   0x0000000000400584 &lt;+87&gt;:mov    %rdi,0x8(%rsp)</span><br><span class="line">   0x0000000000400589 &lt;+92&gt;:mov    -0x30(%rbp),%rdi</span><br><span class="line">   0x000000000040058d &lt;+96&gt;:mov    %rdi,(%rsp)</span><br><span class="line">   0x0000000000400591 &lt;+100&gt;:mov    %rax,-0x38(%rbp)</span><br><span class="line">   0x0000000000400595 &lt;+104&gt;:movsd  -0x38(%rbp),%xmm1</span><br><span class="line">   0x000000000040059a &lt;+109&gt;:mov    <span class="variable">$0x4006a0</span>,%edi</span><br><span class="line">   0x000000000040059f &lt;+114&gt;:mov    <span class="variable">$0x2</span>,%eax</span><br><span class="line">   0x00000000004005a4 &lt;+119&gt;:callq  0x400410 &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">   0x00000000004005a9 &lt;+124&gt;:leaveq</span><br><span class="line">   0x00000000004005aa &lt;+125&gt;:retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure><ul><li><p>stack</p><ul><li>LIFO (Last In first out)</li><li>push data in stack</li><li>pop data out of the stack</li></ul></li><li><p>stack frame</p><ul><li>Lower to high addr</li><li>frame point (FP)<ul><li>the start of the last frame<ul><li>in the bottom</li><li>$rbp register</li></ul></li></ul></li><li>stack point (SP)<ul><li>the end of the last frame<ul><li>always in the top addr</li><li>$sp register</li></ul></li></ul></li></ul></li></ul><p>$rip (instruction pointer)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  sum_till_MAX (n=4) at sum.c:14</span></span><br><span class="line"><span class="comment">#1  0x0000000000400698 in sum_till_MAX (n=4) at sum.c:18</span></span><br><span class="line"><span class="comment">#2  0x0000000000400698 in sum_till_MAX (n=3) at sum.c:18</span></span><br><span class="line"><span class="comment">#3  0x0000000000400698 in sum_till_MAX (n=2) at sum.c:18</span></span><br><span class="line"><span class="comment">#4  0x0000000000400698 in sum_till_MAX (n=1) at sum.c:18</span></span><br><span class="line"><span class="comment">#5  0x0000000000400757 in main (argc=2, argv=0x7fffffffe4e8) at sum.c:33</span></span><br><span class="line">(gdb) i r rip rbp</span><br><span class="line">rip            0x4006980x400698 &lt;sum_till_MAX+43&gt;</span><br><span class="line">rbp            0x7fffffffe3700x7fffffffe370</span><br><span class="line">(gdb) x/40w <span class="variable">$sp</span></span><br><span class="line">0x7fffffffe350:0x000000000x000000000x000000000x00000003</span><br><span class="line">0x7fffffffe360:0x000000000x000000000x000000030x00000000</span><br><span class="line">0x7fffffffe370:0xffffe3a00x00007fff0x004006980x00000000</span><br><span class="line">0x7fffffffe380:0x000000000x000000000xffffe4050x00000002</span><br><span class="line">0x7fffffffe390:0xffffffff0xffffffff0x000000020x00000000</span><br><span class="line">0x7fffffffe3a0:0xffffe3d00x00007fff0x004006980x00000000</span><br><span class="line">0x7fffffffe3b0:0xffffe4000x00007fff0x004005800x00000001</span><br><span class="line">0x7fffffffe3c0:0xffffe4e00x00007fff0x000000010x00000000</span><br><span class="line">0x7fffffffe3d0:0xffffe4000x00007fff0x004007570x00000000</span><br><span class="line">0x7fffffffe3e0:0xffffe4e80x00007fff0x004005800x00000002</span><br><span class="line">(gdb) i frame 1</span><br><span class="line">Stack frame at 0x7fffffffe350:</span><br><span class="line"> rip = 0x400698 <span class="keyword">in</span> sum_till_MAX (sum.c:18); saved rip 0x400698</span><br><span class="line"> called by frame at 0x7fffffffe380, <span class="built_in">caller</span> of frame at 0x7fffffffe320</span><br><span class="line"> <span class="built_in">source</span> language c.</span><br><span class="line"> Arglist at 0x7fffffffe340, args: n=4</span><br><span class="line"> Locals at 0x7fffffffe340, Previous frame<span class="string">&#x27;s sp is 0x7fffffffe350</span></span><br><span class="line"><span class="string"> Saved registers:</span></span><br><span class="line"><span class="string">  rbp at 0x7fffffffe340, rip at 0x7fffffffe348</span></span><br><span class="line"><span class="string">(gdb) x/i $pc</span></span><br><span class="line"><span class="string">=&gt; 0x400698 &lt;sum_till_MAX+43&gt;:add    %rax,-0x8(%rbp)</span></span><br><span class="line"><span class="string">(gdb) p $sp</span></span><br><span class="line"><span class="string">$7 = (void *) 0x7fffffffe350</span></span><br><span class="line"><span class="string">(gdb) i proc mapping</span></span><br><span class="line"><span class="string">process 1868</span></span><br><span class="line"><span class="string">Mapped address spaces:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          Start Addr           End Addr       Size     Offset objfile</span></span><br><span class="line"><span class="string">            0x400000           0x401000     0x1000        0x0 /root/codes/sum</span></span><br><span class="line"><span class="string">            0x600000           0x601000     0x1000        0x0 /root/codes/sum</span></span><br><span class="line"><span class="string">            0x601000           0x602000     0x1000     0x1000 /root/codes/sum</span></span><br><span class="line"><span class="string">      0x7ffff7a0d000     0x7ffff7bd1000   0x1c4000        0x0 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7bd1000     0x7ffff7dd0000   0x1ff000   0x1c4000 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7dd0000     0x7ffff7dd4000     0x4000   0x1c3000 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7dd4000     0x7ffff7dd6000     0x2000   0x1c7000 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7dd6000     0x7ffff7ddb000     0x5000        0x0</span></span><br><span class="line"><span class="string">      0x7ffff7ddb000     0x7ffff7dfd000    0x22000        0x0 /usr/lib64/ld-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7ff1000     0x7ffff7ff4000     0x3000        0x0</span></span><br><span class="line"><span class="string">      0x7ffff7ff9000     0x7ffff7ffa000     0x1000        0x0</span></span><br><span class="line"><span class="string">      0x7ffff7ffa000     0x7ffff7ffc000     0x2000        0x0 [vdso]</span></span><br><span class="line"><span class="string">      0x7ffff7ffc000     0x7ffff7ffd000     0x1000    0x21000 /usr/lib64/ld-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7ffd000     0x7ffff7ffe000     0x1000    0x22000 /usr/lib64/ld-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7ffe000     0x7ffff7fff000     0x1000        0x0</span></span><br><span class="line"><span class="string">      0x7ffffffde000     0x7ffffffff000    0x21000        0x0 [stack]</span></span><br><span class="line"><span class="string">  0xffffffffff600000 0xffffffffff601000     0x1000        0x0 [vsyscall]</span></span><br></pre></td></tr></table></figure><h3 id="User-space"><a href="#User-space" class="headerlink" title="User space"></a>User space</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">GNU</span> <span class="string">gdb</span> <span class="string">(GDB)</span> <span class="string">Red</span> <span class="string">Hat</span> <span class="string">Enterprise</span> <span class="string">Linux</span> <span class="number">7.6</span><span class="number">.1</span><span class="number">-119.</span><span class="string">el7</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(C)</span> <span class="number">2013 </span><span class="string">Free</span> <span class="string">Software</span> <span class="string">Foundation,</span> <span class="string">Inc.</span></span><br><span class="line"><span class="string">License</span> <span class="string">GPLv3+:</span> <span class="string">GNU</span> <span class="string">GPL</span> <span class="string">version</span> <span class="number">3</span> <span class="string">or</span> <span class="string">later</span> <span class="string">&lt;http://gnu.org/licenses/gpl.html&gt;</span></span><br><span class="line"><span class="attr">This is free software:</span> <span class="string">you</span> <span class="string">are</span> <span class="string">free</span> <span class="string">to</span> <span class="string">change</span> <span class="string">and</span> <span class="string">redistribute</span> <span class="string">it.</span></span><br><span class="line"><span class="string">There</span> <span class="string">is</span> <span class="literal">NO</span> <span class="string">WARRANTY,</span> <span class="string">to</span> <span class="string">the</span> <span class="string">extent</span> <span class="string">permitted</span> <span class="string">by</span> <span class="string">law.</span>  <span class="string">Type</span> <span class="string">&quot;show copying&quot;</span></span><br><span class="line"><span class="string">and</span> <span class="string">&quot;show warranty&quot;</span> <span class="string">for</span> <span class="string">details.</span></span><br><span class="line"><span class="string">This</span> <span class="string">GDB</span> <span class="string">was</span> <span class="string">configured</span> <span class="string">as</span> <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span><span class="string">.</span></span><br><span class="line"><span class="string">For</span> <span class="string">bug</span> <span class="string">reporting</span> <span class="string">instructions,</span> <span class="attr">please see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span></span><br><span class="line"><span class="string">Reading</span> <span class="string">symbols</span> <span class="string">from</span> <span class="string">/usr/lib64/libc-2.17.so...Reading</span> <span class="string">symbols</span> <span class="string">from</span> <span class="string">/usr/lib/debug/usr/lib64/libc-2.17.so.debug...done.</span></span><br><span class="line"><span class="string">done.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## show the offset</span></span><br><span class="line"><span class="string">(gdb)</span> <span class="string">disas</span> <span class="string">memcmp</span></span><br><span class="line"><span class="attr">Dump of assembler code for function memcmp:</span></span><br><span class="line">   <span class="number">0x000000000008f2f0</span> <span class="string">&lt;+0&gt;:</span><span class="string">mov</span>    <span class="number">0x337b51</span><span class="string">(%rip),%rdx</span>        <span class="comment"># 0x3c6e48</span></span><br><span class="line">   <span class="number">0x000000000008f2f7</span> <span class="string">&lt;+7&gt;:</span><span class="string">testl</span>  <span class="string">$0x200,0x80(%rdx)</span></span><br><span class="line">   <span class="number">0x000000000008f301</span> <span class="string">&lt;+17&gt;:</span><span class="string">jne</span>    <span class="number">0x8f30b</span> <span class="string">&lt;memcmp+27&gt;</span></span><br><span class="line">   <span class="number">0x000000000008f303</span> <span class="string">&lt;+19&gt;:</span><span class="string">lea</span>    <span class="number">0x26</span><span class="string">(%rip),%rax</span>        <span class="comment"># 0x8f330 &lt;__memcmp_sse2&gt;</span></span><br><span class="line">   <span class="number">0x000000000008f30a</span> <span class="string">&lt;+26&gt;:</span><span class="string">retq</span></span><br><span class="line">   <span class="number">0x000000000008f30b</span> <span class="string">&lt;+27&gt;:</span><span class="string">testl</span>  <span class="string">$0x80000,0x80(%rdx)</span></span><br><span class="line">   <span class="number">0x000000000008f315</span> <span class="string">&lt;+37&gt;:</span><span class="string">je</span>     <span class="number">0x8f31f</span> <span class="string">&lt;memcmp+47&gt;</span></span><br><span class="line">   <span class="number">0x000000000008f317</span> <span class="string">&lt;+39&gt;:</span><span class="string">lea</span>    <span class="number">0xdac92</span><span class="string">(%rip),%rax</span>        <span class="comment"># 0x169fb0 &lt;__memcmp_sse4_1&gt;</span></span><br><span class="line">   <span class="number">0x000000000008f31e</span> <span class="string">&lt;+46&gt;:</span><span class="string">retq</span></span><br><span class="line">   <span class="number">0x000000000008f31f</span> <span class="string">&lt;+47&gt;:</span><span class="string">lea</span>    <span class="number">0xde5ba</span><span class="string">(%rip),%rax</span>        <span class="comment"># 0x16d8e0 &lt;__memcmp_ssse3&gt;</span></span><br><span class="line">   <span class="number">0x000000000008f326</span> <span class="string">&lt;+54&gt;:</span><span class="string">retq</span></span><br><span class="line"><span class="string">End</span> <span class="string">of</span> <span class="string">assembler</span> <span class="string">dump.</span></span><br></pre></td></tr></table></figure><ul><li><a href="http://tacy.github.io/post/binary/">To</a> retrieve a section header table:readelf -S <object></li><li>To retrieve a program header table: readelf -l <object></li><li>To retrieve a symbol table: readelf -s <object></li><li>To retrieve the ELF file header data: readelf -e <object></li><li>To retrieve relocation entries: readelf -r <object></li><li>To retrieve a dynamic segment: readelf -d <object></li></ul><h3 id="source-code-directory"><a href="#source-code-directory" class="headerlink" title="source code directory"></a>source code directory</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) directory /opt/src</span><br></pre></td></tr></table></figure><h3 id="gcc-parameters-and-show-macro"><a href="#gcc-parameters-and-show-macro" class="headerlink" title="gcc parameters and show macro"></a><a href="http://www.lenky.info/archives/2012/08/1910">gcc parameters and show macro</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Wall -O2 -pg -o t.O2.pg t.c</span><br></pre></td></tr></table></figure><ul><li>pg: Generate extra code to write profile information suitable for the analysis program gprof.  You must use this option when compiling the source files you want data about, and you must also use it when linking.   </li><li>time[=file]: Report the CPU time taken by each subprocess in the compilation sequence</li><li>“-Q”:  Makes the compiler print out each function name as it is compiled, and print some statistics about each pass when it finishes.   </li><li>fno-inline: Do not expand any functions inline apart from those marked with the “always_inline” attribute.  This is the default when not optimizing.</li><li>-g produces debugging information in theOS native format</li><li>-ggdb produces debugging information specifically intennded for gdb</li><li>-ggdb3 produces extra debugging information, for example: including macro definitions</li><li>wall means enable warnning</li><li>-O0  turn off all optimization</li><li>-O1 ,-O2, -O3  optimization</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">cat t.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;t.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> A 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> B (2+A)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">myfunc</span><span class="params">(<span class="keyword">long</span> a, <span class="keyword">long</span> b, <span class="keyword">long</span> c, <span class="keyword">long</span> d,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> e, <span class="keyword">long</span> f, <span class="keyword">long</span> g, <span class="keyword">long</span> h)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> xx = a * b * c * d * e * f * g * h;</span><br><span class="line">    <span class="keyword">long</span> yy = a + b + c + d + e + f + g + h;</span><br><span class="line">    <span class="keyword">long</span> zz = utilfunc(xx, yy, xx % yy);</span><br><span class="line">    <span class="keyword">return</span> zz + <span class="number">20</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    myfunc(<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">77</span>, <span class="number">88</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, B);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat t.h</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _T_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _T_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">utilfunc</span><span class="params">(<span class="keyword">long</span> a, <span class="keyword">long</span> b, <span class="keyword">long</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> xx = a + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">long</span> yy = b + <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">long</span> zz = c + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">long</span> sum = xx + yy + zz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> xx * yy * zz + sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">$ gcc -Wall -O2 -g -o t.O2.g t.c</span><br><span class="line">$ gdb t.O2.g -q</span><br><span class="line">Reading symbols from /home/log_IO1/test/t.O2.g...done.</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x400440</span>: file t.c, line <span class="number">16.</span></span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /home/log_IO1/test/t.O2.g</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, main (argc=<span class="number">1</span>, argv=<span class="number">0x7fffffffe288</span>) at t.c:<span class="number">16</span></span><br><span class="line"><span class="number">16</span>&#123;</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc<span class="number">-2.17</span><span class="number">-307.</span>el7<span class="number">.1</span>.x86_64</span><br><span class="line">(gdb) info macro A</span><br><span class="line">The symbol `A<span class="number">&#x27;</span> has no definition as a C/C++ preprocessor macro</span><br><span class="line">at &lt;user-defined&gt;:<span class="number">-1</span></span><br><span class="line"></span><br><span class="line">### Add -ggdb3</span><br><span class="line"></span><br><span class="line">$ gcc -Wall -O2 -ggdb3 -o t.O2.gdb3.noinline.g t.c</span><br><span class="line">$ gdb t.O2.gdb3.noinline.g -q</span><br><span class="line">Reading symbols from /home/log_IO1/test/t.O2.gdb3.noinline.g...done.</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x400440</span>: file t.c, line <span class="number">16.</span></span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /home/log_IO1/test/t.O2.gdb3.noinline.g</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, main (argc=<span class="number">1</span>, argv=<span class="number">0x7fffffffe278</span>) at t.c:<span class="number">16</span></span><br><span class="line"><span class="number">16</span>&#123;</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc<span class="number">-2.17</span><span class="number">-307.</span>el7<span class="number">.1</span>.x86_64</span><br><span class="line">(gdb)  info macro A</span><br><span class="line">Defined at /home/log_IO1/test/t.c:<span class="number">3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> A 1</span></span><br><span class="line">(gdb)  info macro B</span><br><span class="line">Defined at /home/log_IO1/test/t.c:<span class="number">4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> B (2+A)</span></span><br><span class="line">(gdb) macro expand A</span><br><span class="line">expands to: <span class="number">1</span></span><br><span class="line">(gdb) macro expand B</span><br><span class="line">expands to: (<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">(gdb) <span class="built_in">list</span> utilfunc</span><br><span class="line"><span class="number">3</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">utilfunc</span><span class="params">(<span class="keyword">long</span> a, <span class="keyword">long</span> b, <span class="keyword">long</span> c)</span></span></span><br><span class="line"><span class="function">6</span>&#123;</span><br><span class="line"><span class="number">7</span>    <span class="keyword">long</span> xx = a + <span class="number">2</span>;</span><br><span class="line"><span class="number">8</span>    <span class="keyword">long</span> yy = b + <span class="number">3</span>;</span><br><span class="line"><span class="number">9</span>    <span class="keyword">long</span> zz = c + <span class="number">4</span>;</span><br><span class="line"><span class="number">10</span>    <span class="keyword">long</span> sum = xx + yy + zz;</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span>    <span class="keyword">return</span> xx * yy * zz + sum;</span><br><span class="line">(gdb) quit</span><br><span class="line">A debugging session is active.</span><br><span class="line"></span><br><span class="line">Inferior <span class="number">1</span> [process <span class="number">28148</span>] will be killed.</span><br><span class="line"></span><br><span class="line">Quit anyway? (y <span class="keyword">or</span> n) y</span><br></pre></td></tr></table></figure><h3 id="rsync-debug-example"><a href="#rsync-debug-example" class="headerlink" title="rsync debug example"></a>rsync debug example</h3><p>copy the gz file, In rsync-3.0.6 with the z parameter, it use level 0<br>copy the gz file, In rsync-3.1.2 with the z parameter, it use level 6<br>it impact the system speed</p><p>In perf ,you could see the diff compress system call</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 3.1.2</span></span><br><span class="line">[.] longest_match</span><br><span class="line">[.] deflate_slow</span><br><span class="line">[.] inflate_fast</span><br><span class="line">[.] md5_process</span><br><span class="line">[.] fill_window</span><br><span class="line">[.] compress_block</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.0.6</span></span><br><span class="line">[.] match_sums</span><br><span class="line">[.] send_files</span><br><span class="line">matched (inlined)</span><br><span class="line">[.] send_token</span><br><span class="line">send_deflated_token (inlined)</span><br><span class="line">[.] deflate</span><br><span class="line">[.] deflate_stored</span><br><span class="line">[.] md5_process</span><br><span class="line">md5_update (inlined)</span><br></pre></td></tr></table></figure><p>You could got the deflate_stored only work for level 0, deflate_slow work for level 6   </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">zlib/deflate.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FASTEST</span></span><br><span class="line">local <span class="keyword">const</span> config configuration_table[<span class="number">2</span>] = &#123;</span><br><span class="line"><span class="comment">/*      good lazy nice chain */</span></span><br><span class="line"><span class="comment">/* 0 */</span> &#123;<span class="number">0</span>,    <span class="number">0</span>,  <span class="number">0</span>,    <span class="number">0</span>, deflate_stored&#125;,  <span class="comment">/* store only */</span></span><br><span class="line"><span class="comment">/* 1 */</span> &#123;<span class="number">4</span>,    <span class="number">4</span>,  <span class="number">8</span>,    <span class="number">4</span>, deflate_fast&#125;&#125;; <span class="comment">/* max speed, no lazy matches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">local <span class="keyword">const</span> config configuration_table[<span class="number">10</span>] = &#123;</span><br><span class="line"><span class="comment">/*      good lazy nice chain */</span></span><br><span class="line"><span class="comment">/* 0 */</span> &#123;<span class="number">0</span>,    <span class="number">0</span>,  <span class="number">0</span>,    <span class="number">0</span>, deflate_stored&#125;,  <span class="comment">/* store only */</span></span><br><span class="line"><span class="comment">/* 1 */</span> &#123;<span class="number">4</span>,    <span class="number">4</span>,  <span class="number">8</span>,    <span class="number">4</span>, deflate_fast&#125;, <span class="comment">/* max speed, no lazy matches */</span></span><br><span class="line"><span class="comment">/* 2 */</span> &#123;<span class="number">4</span>,    <span class="number">5</span>, <span class="number">16</span>,    <span class="number">8</span>, deflate_fast&#125;,</span><br><span class="line"><span class="comment">/* 3 */</span> &#123;<span class="number">4</span>,    <span class="number">6</span>, <span class="number">32</span>,   <span class="number">32</span>, deflate_fast&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4 */</span> &#123;<span class="number">4</span>,    <span class="number">4</span>, <span class="number">16</span>,   <span class="number">16</span>, deflate_slow&#125;,  <span class="comment">/* lazy matches */</span></span><br><span class="line"><span class="comment">/* 5 */</span> &#123;<span class="number">8</span>,   <span class="number">16</span>, <span class="number">32</span>,   <span class="number">32</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 6 */</span> &#123;<span class="number">8</span>,   <span class="number">16</span>, <span class="number">128</span>, <span class="number">128</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 7 */</span> &#123;<span class="number">8</span>,   <span class="number">32</span>, <span class="number">128</span>, <span class="number">256</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 8 */</span> &#123;<span class="number">32</span>, <span class="number">128</span>, <span class="number">258</span>, <span class="number">1024</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 9 */</span> &#123;<span class="number">32</span>, <span class="number">258</span>, <span class="number">258</span>, <span class="number">4096</span>, deflate_slow&#125;&#125;; <span class="comment">/* max compression */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">##<span class="meta"># the deflate_stored comment</span></span><br><span class="line"><span class="comment">/* ===========================================================================</span></span><br><span class="line"><span class="comment"> * Copy without compression as much as possible from the input stream, return</span></span><br><span class="line"><span class="comment"> * the current block state.</span></span><br><span class="line"><span class="comment"> * This function does not insert new strings in the dictionary since</span></span><br><span class="line"><span class="comment"> * uncompressible data is probably not useful. This function is used</span></span><br><span class="line"><span class="comment"> * only for the level=0 compression option.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> this function should be optimized to avoid extra copying from</span></span><br><span class="line"><span class="comment"> * window to pending_buf.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>The key function was _tr_flush_block and the key struct is “deflate_state *s;” in zlib/trees.c</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> address on</span><br><span class="line">show <span class="built_in">print</span> address</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> array</span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> array on</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> array off</span><br><span class="line">show <span class="built_in">print</span> array</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> elements</span><br><span class="line">show <span class="built_in">print</span> elements</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> null-stop (defualt off)</span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> pretty on</span><br><span class="line"></span><br><span class="line">$ grep -Rin <span class="string">&quot;FAR deflate_state&quot;</span> rsync-3.1.2/zlib</span><br><span class="line">rsync-3.1.2/zlib/deflate.h:273:&#125; FAR deflate_state;</span><br><span class="line"></span><br><span class="line">/* A Pos is an index <span class="keyword">in</span> the character window. We use short instead of int to</span><br><span class="line"> * save space <span class="keyword">in</span> the various tables. IPos is used only <span class="keyword">for</span> parameter passing.</span><br><span class="line"> */</span><br><span class="line">typedef struct internal_state &#123;</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">&#125; FAR deflate_state;</span><br><span class="line"></span><br><span class="line">(gdb) b set_compression</span><br><span class="line">(gdb) b lp_dont_compress</span><br><span class="line">(gdb) b send_deflated_token</span><br><span class="line">(gdb) b init_set_compression</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### found the no compress suffix name</span></span><br><span class="line">(gdb) bt full</span><br><span class="line"><span class="comment">#0  init_set_compression () at token.c:125</span></span><br><span class="line">        f = 0x44e258 <span class="string">&quot;*.gz *.zip *.z *.rpm *.deb *.iso *.bz2 *.t[gb]z *.7z *.mp[34] *.mov *.avi *.ogg *.jpg *.jpeg&quot;</span></span><br><span class="line"></span><br><span class="line">loadparm.c:63</span><br><span class="line"><span class="comment">#define DEFAULT_DONT_COMPRESS &quot;*.gz *.zip *.z *.rpm *.deb *.iso *.bz2&quot; \</span></span><br><span class="line">        <span class="string">&quot; *.t[gb]z *.7z *.mp[34] *.mov *.avi *.ogg *.jpg *.jpeg&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### default rsync version is 3.1.2</span></span><br><span class="line"></span><br><span class="line">$ rm -f linux-5.4.121-1.tar.gz ; gdb --args rsync -zP linux-5.4.121.tar.gz linux-5.4.121-2.tar.gz</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /usr/bin/rsync...Reading symbols from /usr/lib/debug/usr/bin/rsync.debug...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">(gdb) b trees.c:908</span><br><span class="line">Breakpoint 1 at 0x565c0: file zlib/trees.c, line 908.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /usr/bin/rsync -zP linux-5.4.121.tar.gz linux-5.4.121-2.tar.gz</span><br><span class="line">[Detaching after fork from child process 36449]</span><br><span class="line">linux-5.4.121.tar.gz</span><br><span class="line">         32,768   0%    0.00kB/s    0:00:00</span><br><span class="line">Breakpoint 1, _tr_flush_block (s=0x5555557df640, buf=0x55555580f4d0 <span class="string">&quot;linux-5.4.121/&quot;</span>, stored_len=53256, last=0) at zlib/trees.c:912</span><br><span class="line">912&#123;</span><br><span class="line"></span><br><span class="line">(gdb) p *s</span><br><span class="line">or</span><br><span class="line">(gdb) p *((struct internal_state *) s)</span><br><span class="line"><span class="variable">$2</span> = &#123;strm = 0x5555557da7c0 &lt;tx_strm&gt;, status = 113, pending_buf = 0x55555583f500 <span class="string">&quot;&quot;</span>, pending_buf_size = 65536, pending_out = 0x55555583f500 <span class="string">&quot;&quot;</span>, pending = 0, wrap = 0,</span><br><span class="line">  gzhead = 0x0, gzindex = 0, method = 8 <span class="string">&#x27;\b&#x27;</span>, last_flush = 0, w_size = 32768, w_bits = 15, w_mask = 32767, window = 0x55555580f4d0 <span class="string">&quot;linux-5.4.121/&quot;</span>, window_size = 65536,</span><br><span class="line">  prev = 0x55555581f4e0, head = 0x55555582f4f0, ins_h = 8135, hash_size = 32768, hash_bits = 15, hash_mask = 32767, hash_shift = 5, block_start = 0, match_length = 2,</span><br><span class="line">  prev_match = 53234, match_available = 0, strstart = 53256, match_start = 53234, lookahead = 12280, prev_length = 0, max_chain_length = 128, max_lazy_match = 16,</span><br><span class="line">  level = 6</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### print offset</span></span><br><span class="line">(gdb) p &amp;((struct internal_state *)0)-&gt;level</span><br><span class="line"><span class="variable">$3</span> = (int *) 0xb4</span><br><span class="line">oxb4=180</span><br><span class="line"></span><br><span class="line">(gdb) x/181x s</span><br><span class="line">0x5555557df640:0xc00xa70x7d0x550x550x550x000x00</span><br><span class="line">0x5555557df648:0x710x000x000x000xff0x7f0x000x00</span><br><span class="line">0x5555557df650:0x000xf50x830x550x550x550x000x00</span><br><span class="line">0x5555557df658:0x000x000x010x000x000x000x000x00</span><br><span class="line">0x5555557df660:0x000xf50x830x550x550x550x000x00</span><br><span class="line">0x5555557df668:0x000x000x000x000x000x000x000x00</span><br><span class="line">0x5555557df670:0x000x000x000x000x000x000x000x00</span><br><span class="line">0x5555557df678:0x000x000x000x000x080x000x000x00</span><br><span class="line">0x5555557df680:0x000x000x000x000x000x800x000x00</span><br><span class="line">0x5555557df688:0x0f0x000x000x000xff0x7f0x000x00</span><br><span class="line">0x5555557df690:0xd00xf40x800x550x550x550x000x00</span><br><span class="line">0x5555557df698:0x000x000x010x000x000x000x000x00</span><br><span class="line">0x5555557df6a0:0xe00xf40x810x550x550x550x000x00</span><br><span class="line">0x5555557df6a8:0xf00xf40x820x550x550x550x000x00</span><br><span class="line">0x5555557df6b0:0xc70x1f0x000x000x000x800x000x00</span><br><span class="line">0x5555557df6b8:0x0f0x000x000x000xff0x7f0x000x00</span><br><span class="line">0x5555557df6c0:0x050x000x000x000x000x000x000x00</span><br><span class="line">0x5555557df6c8:0x000x000x000x000x000x000x000x00</span><br><span class="line">0x5555557df6d0:0x020x000x000x000xf20xcf0x000x00</span><br><span class="line">0x5555557df6d8:0x000x000x000x000x080xd00x000x00</span><br><span class="line">0x5555557df6e0:0xf20xcf0x000x000xf80x2f0x000x00</span><br><span class="line">0x5555557df6e8:0x000x000x000x000x800x000x000x00</span><br><span class="line">0x5555557df6f0:0x100x000x000x000x06</span><br><span class="line">                                                ^</span><br><span class="line">                                                |</span><br><span class="line">------------------------------------------------- level=6</span><br></pre></td></tr></table></figure><h3 id="gen-the-debuginfo"><a href="#gen-the-debuginfo" class="headerlink" title="gen the debuginfo"></a><a href="http://www.lenky.info/archives/2013/04/2261">gen the debuginfo</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># cat t.c </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">$ objcopy --only-keep-debug t t.debuginfo</span><br><span class="line">$ objcopy --strip-debug t</span><br><span class="line">$ objcopy --add-gnu-debuglink=t.debuginfo t ### add the .gnu_debuglink section</span><br><span class="line"><span class="keyword">or</span> </span><br><span class="line">$ cp t t.debuginfo</span><br><span class="line">$ strip --only-keep-debug t.debuginfo</span><br><span class="line">## stripe will <span class="keyword">delete</span> the symtab</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"> </span><br><span class="line">scriptdir=`dirname <span class="variable">$&#123;0&#125;</span>`</span><br><span class="line">scriptdir=`(<span class="built_in">cd</span> <span class="variable">$&#123;scriptdir&#125;</span>; <span class="built_in">pwd</span>)`</span><br><span class="line">scriptname=`basename <span class="variable">$&#123;0&#125;</span>`</span><br><span class="line"> </span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> errorexit()</span><br><span class="line">&#123;</span><br><span class="line">  errorcode=<span class="variable">$&#123;1&#125;</span></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$@</span></span><br><span class="line">  <span class="built_in">exit</span> <span class="variable">$&#123;errorcode&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> usage()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;USAGE <span class="variable">$&#123;scriptname&#125;</span> &lt;tostrip&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">tostripdir=`dirname <span class="string">&quot;<span class="variable">$1</span>&quot;</span>`</span><br><span class="line">tostripfile=`basename <span class="string">&quot;<span class="variable">$1</span>&quot;</span>`</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;tostripfile&#125;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  usage</span><br><span class="line">  errorexit 0 <span class="string">&quot;tostrip must be specified&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;tostripdir&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">debugdir=.debug</span><br><span class="line">debugfile=<span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>.debug&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;creating dir <span class="variable">$&#123;tostripdir&#125;</span>/<span class="variable">$&#123;debugdir&#125;</span>&quot;</span></span><br><span class="line">  mkdir -p <span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stripping <span class="variable">$&#123;tostripfile&#125;</span>, putting debug info into <span class="variable">$&#123;debugfile&#125;</span>&quot;</span></span><br><span class="line">objcopy --only-keep-debug <span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>/<span class="variable">$&#123;debugfile&#125;</span>&quot;</span></span><br><span class="line">strip --strip-debug --strip-unneeded <span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>&quot;</span></span><br><span class="line">objcopy --add-gnu-debuglink=<span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>/<span class="variable">$&#123;debugfile&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">$ ./cdbi.sh t</span><br><span class="line">$ ls -l .debug/</span><br><span class="line"></span><br><span class="line"><span class="comment">## gdb import the debuginfo, copy to the same dir</span></span><br><span class="line">$ cp -a .debug/ /tmp/</span><br><span class="line">$ cp -a t /tmp/</span><br><span class="line">or </span><br><span class="line">$ cp -a t.debug /tmp/</span><br><span class="line">$ cp -a t /tmp/</span><br><span class="line">or</span><br><span class="line">gdb -s .debug/t.debug -e /tmp/t -q</span><br><span class="line">or</span><br><span class="line"><span class="built_in">set</span> debug-file-directory directories</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;</summary>
      
    
    
    
    <category term="Scripts" scheme="http://yoursite.com/categories/Scripts/"/>
    
    
    <category term="debug" scheme="http://yoursite.com/tags/debug/"/>
    
    <category term="trace" scheme="http://yoursite.com/tags/trace/"/>
    
  </entry>
  
  <entry>
    <title>crash practice</title>
    <link href="http://yoursite.com/2020/03/03/crash/"/>
    <id>http://yoursite.com/2020/03/03/crash/</id>
    <published>2020-03-03T14:17:33.000Z</published>
    <updated>2021-08-18T03:31:28.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="compression"><a href="#compression" class="headerlink" title="compression"></a>compression</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  [-c|-l|-p]:</span><br><span class="line">      Compress dump data by each page using zlib <span class="keyword">for</span> -c option, lzo <span class="keyword">for</span> -l option</span><br><span class="line">      or snappy <span class="keyword">for</span> -p option. A user cannot specify either of these options with</span><br><span class="line">      -E option, because the ELF format does not support compressed data.</span><br><span class="line">      THIS IS ONLY FOR THE CRASH UTILITY.</span><br><span class="line">                             -------------------lzo </span><br><span class="line">                             |</span><br><span class="line">core_collector makedumpfile -l --message-level 1 -d 31</span><br></pre></td></tr></table></figure><h3 id="loading-modules"><a href="#loading-modules" class="headerlink" title="loading modules"></a>loading modules</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mod -S /usr/lib/debug/lib/modules/</span><br></pre></td></tr></table></figure><p><a href="https://blogs.oracle.com/linux/post/extracting-kernel-stack-function-arguments-from-linux-x86-64-kernel-crash-dumps">In Linux on x86-64, the kernel stack grows down, from larger towards smaller memory addresses</a>    </p><h3 id="basic"><a href="#basic" class="headerlink" title="basic"></a><a href="https://blogs.oracle.com/linux/post/extracting-kernel-stack-function-arguments-from-linux-x86-64-kernel-crash-dumps">basic</a></h3><ul><li>mov %r12,%rdi<ul><li>places the contents of cpu register %r12 into register %rdi</li></ul></li><li>mov 0x8(%r14),%rcx <ul><li>takes the value of register %r14, adds 8 to it, takes the result as the address of a memory location, reads the value at that memory location and puts it into register %rcx<ul><li>The GAS syntax 0x8(%r14) uses base indirect addressing mode; the NASM syntax for this is perhaps a little clearer: [%r14+0x8]. Both denote the content of memory at address location %r14+0x8.</li></ul></li></ul></li><li>The calling function might retrieve the values from:<ul><li>Memory</li><li>The calling function’s stack, via an offset from the (fixed) base of the stack</li><li>Another register, which got its value from one of these above in turnz</li></ul></li><li>The called function might save the values it received in the registers<ul><li>Memory</li><li>The called function’s stack, via push</li><li>Another register, which might itself then be saved in turn</li></ul></li><li>Disassemble either or both of<ul><li>The calling function, leading up to the callq instruction, to see from where it obtains the values it passes to the called function in the registers</li><li>The called function, to see whether it puts the values from the registers onto its stack, or into memory</li></ul></li><li>Inspect those areas (caller/callee stack and/or memory) to see if the values may be extracted</li><li>The 1st argument will be passed in %rdi, %edi, %di or %dil. Note that all the names contain “di”.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">##<span class="meta"># linux/arch/x86/entry/common.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">                <span class="keyword">if</span> (arch == AUDIT_ARCH_X86_64) &#123;</span><br><span class="line">                        sd.args[<span class="number">0</span>] = regs-&gt;di;</span><br><span class="line">                        sd.args[<span class="number">1</span>] = regs-&gt;si;</span><br><span class="line">                        sd.args[<span class="number">2</span>] = regs-&gt;dx;</span><br><span class="line">                        sd.args[<span class="number">3</span>] = regs-&gt;r10;</span><br><span class="line">                        sd.args[<span class="number">4</span>] = regs-&gt;r8;</span><br><span class="line">                        sd.args[<span class="number">5</span>] = regs-&gt;r9;</span><br><span class="line">                &#125; <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">                &#123;</span><br><span class="line">                        sd.args[<span class="number">0</span>] = regs-&gt;bx;</span><br><span class="line">                        sd.args[<span class="number">1</span>] = regs-&gt;cx;</span><br><span class="line">                        sd.args[<span class="number">2</span>] = regs-&gt;dx;</span><br><span class="line">                        sd.args[<span class="number">3</span>] = regs-&gt;si;</span><br><span class="line">                        sd.args[<span class="number">4</span>] = regs-&gt;di;</span><br><span class="line">                        sd.args[<span class="number">5</span>] = regs-&gt;bp;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure></li><li>Whilst the function is executing, this is stored in the %rbp register, the function’s stack frame base pointer.</li><li>-sx tells bt to try to show addresses as as symbol name plus a hex offset<ul><li>bt -sx</li></ul></li><li>to see the actual stack content, i.e. the content of the stack frames, for each function call<ul><li>bt -FFsx</li><li>-FF tells bt to show all the data for a stack frame, symbolically, with its slab cache name, if appropriate<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   crash7latest&gt; bt -FFsx</span><br><span class="line">       ...</span><br><span class="line">   ffff88180dc37ca8: ***ffff88180dc37d58*** do_last+<span class="number">901</span> &lt;&lt;&lt;------ The <span class="built_in">stack</span> frame of the calling function do_last is shown above</span><br><span class="line">#<span class="number">5</span> [ffff88180dc37cb0] do_last+<span class="number">0x385</span> at ffffffff812140b5           Its <span class="built_in">stack</span> frame base pointer <span class="number">0xffff88180dc37d58</span> appears in two locations, shown highlighted with ***</span><br><span class="line">   ffff88180dc37cb8: <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">   ffff88180dc37cc8: [ffff883f64c7cda0:mnt_cache] [ffff881d4601f740:dentry]</span><br><span class="line">   ffff88180dc37cd8: [ffff881d4603e600:ext3_inode_cache] kmem_cache_alloc+<span class="number">546</span></span><br><span class="line">   ffff88180dc37ce8: [ffff881d4603e600:ext3_inode_cache] [ffff881dfc120000:kmalloc<span class="number">-4096</span>]</span><br><span class="line">   ffff88180dc37cf8: <span class="number">000001000000002</span>a [ffff8817ec6b7600:kmalloc<span class="number">-256</span>]</span><br><span class="line">   ffff88180dc37d08: ffff88180dc37da4 [ffff881d4601f740:dentry]</span><br><span class="line">   ffff88180dc37d18: ffff88180dc37d58 path_init+<span class="number">185</span></span><br><span class="line">   ffff88180dc37d28: ffff88180dc37d58 [ffff8817ec6b7600:kmalloc<span class="number">-256</span>]</span><br><span class="line">   ffff88180dc37d38: ffff88180dc37e08 ffff88180dc37ef4</span><br><span class="line">   ffff88180dc37d48: [ffff881dfc120000:kmalloc<span class="number">-4096</span>] <span class="number">0000000000000041</span></span><br><span class="line">***ffff88180dc37d58***: ffff88180dc37df8 path_openat+<span class="number">128</span></span><br><span class="line">#<span class="number">6</span> [ffff88180dc37d60] path_openat+<span class="number">0x80</span> at ffffffff81214fc0</span><br></pre></td></tr></table></figure></li></ul></li><li>The stack frame base pointer, for a function, may be found:<ul><li>As the second-last value in the stack frame above the function (i.e. above in the bt output)</li><li>As the location of the second-last value in the stack frame for the function</li></ul></li></ul><h3 id="genarate-the-debuginfo"><a href="#genarate-the-debuginfo" class="headerlink" title="genarate the debuginfo"></a>genarate the debuginfo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `find /lib/modules/5.10.41 -name <span class="string">&#x27;*.ko&#x27;</span> -<span class="built_in">print</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        buildid=`eu-readelf -n <span class="variable">$file</span>| grep Build.ID: | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>`</span><br><span class="line">        dir=`<span class="built_in">echo</span> <span class="variable">$buildid</span> | cut -c1-2`</span><br><span class="line">        fn=`<span class="built_in">echo</span> <span class="variable">$buildid</span> | cut -c3-`</span><br><span class="line">        mkdir -p /usr/lib/debug/.build-id/<span class="variable">$dir</span></span><br><span class="line">        ln -s <span class="variable">$file</span> /usr/lib/debug/.build-id/<span class="variable">$dir</span>/<span class="variable">$fn</span></span><br><span class="line">        ln -s <span class="variable">$file</span> /usr/lib/debug/.build-id/<span class="variable">$dir</span>/<span class="variable">$&#123;fn&#125;</span>.debug</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="base-cmd"><a href="#base-cmd" class="headerlink" title="[base cmd]"></a>[base cmd]</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; struct skb_shared_info ls | head</span><br><span class="line">symbol not found: ls</span><br><span class="line">possible alternatives:</span><br><span class="line">  f760 (d) shadow_tls_desc</span><br><span class="line">  1a540 (d) cpu_worker_pools</span><br><span class="line">  ffffffff9c61b4a0 (t) xen_load_tls</span><br><span class="line">  ffffffff9c6350f0 (T) arch_check_bp_in_kernelspace</span><br><span class="line">  ffffffff9c63c250 (t) set_tls_desc</span><br><span class="line">  ffffffff9c63c6d0 (T) regset_tls_active</span><br><span class="line">  ffffffff9c63c710 (T) regset_tls_get</span><br><span class="line">  ffffffff9c63c860 (T) regset_tls_set</span><br><span class="line">... &lt;-------------- show all</span><br><span class="line"></span><br><span class="line">foreach IN bt</span><br><span class="line">foreach bt -tf</span><br><span class="line">bt -t <span class="variable">$pid</span></span><br><span class="line">bt -l <span class="variable">$pid</span></span><br><span class="line">bt -a</span><br><span class="line">task | grep rsp</span><br><span class="line">rsp0 = 0xx0</span><br><span class="line">rsp = 0xx1</span><br><span class="line">rd <span class="variable">$rsp</span> -e <span class="variable">$rsp0</span> -s</span><br><span class="line">dev == cat /proc/ioports /proc/iomem</span><br><span class="line">kem -s </span><br><span class="line">kmem -i</span><br><span class="line">kmem -p</span><br><span class="line">kmem 0x<span class="variable">$addr</span></span><br><span class="line">the addr <span class="keyword">in</span> the [0xxxx] means not release</span><br><span class="line">whatis moduels</span><br><span class="line">list modules</span><br><span class="line">whatis ip_packet_type</span><br><span class="line">struct -o packet_type</span><br><span class="line">list -o 0x30 ip_packet_type</span><br><span class="line">list -o 0x30 ip_packet_type -s packet_type.func</span><br><span class="line">net</span><br><span class="line">struct net_device <span class="variable">$addr</span></span><br><span class="line">runq</span><br><span class="line">sig</span><br><span class="line">sig -l = <span class="built_in">kill</span> -l</span><br><span class="line">swap</span><br><span class="line">sym</span><br><span class="line">sym -l = system.map</span><br><span class="line">sys</span><br><span class="line">sys config</span><br><span class="line">task</span><br><span class="line">timer</span><br><span class="line">wr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---need stap inject---</span><br><span class="line">sys</span><br><span class="line">rd jiffies_64</span><br><span class="line">wr jiffies_64 10ffc7651</span><br><span class="line">rd jiffies_64</span><br><span class="line">sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> line</span><br><span class="line">cat crash_cmd.txt</span><br><span class="line"><span class="built_in">help</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">crash -s -i crash_cmd.txt</span><br><span class="line">       |</span><br><span class="line">       ----------- silent mode</span><br><span class="line"></span><br><span class="line"><span class="comment">### show module info</span></span><br><span class="line">crash&gt; mod |grep -e NAME -e i40e</span><br><span class="line">     MODULE       NAME                             SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0220da0  i40e                           510664  /lib/modules/3.10.0-1160.2.1.el7_lustre.x86_64/updates/drivers/net/ethernet/intel/i40e/i40e.ko</span><br><span class="line">     |</span><br><span class="line">     ------------------------------------------------</span><br><span class="line">                                                    |</span><br><span class="line">crash&gt; module.name,version,srcversion,sig_ok ffffffffc0220da0</span><br><span class="line">  name = <span class="string">&quot;i40e\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span></span><br><span class="line">  version = 0xffff8a7184389380 <span class="string">&quot;2.13.10&quot;</span></span><br><span class="line">  srcversion = 0xffff8a7183fc26a0 <span class="string">&quot;597EBD96218776AAA546464&quot;</span></span><br><span class="line">  sig_ok = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /sys/module/nfsd/sections</span><br><span class="line">$ cat .text .data .bss</span><br><span class="line">0xffffffffc1422000------------------------------------------------------------------------</span><br><span class="line">0xffffffffc1462000-----------------------------------------------------------------------|---------------------------</span><br><span class="line">0xffffffffc1468040-----------------------------------------------------------------------|--------------------------|-------------------------</span><br><span class="line">                                                                                         |                          |                        |</span><br><span class="line">crash&gt; add-symbol-file /lib/modules/3.10.0-1127.el7.x86_64/kernel/fs/nfsd/nfsd.ko 0xffffffffc1422000 -s .data 0xffffffffc1462000 -s .bss 0xffffffffc1468040</span><br><span class="line"></span><br><span class="line">add symbol table from file <span class="string">&quot;/lib/modules/3.10.0-1127.el7.x86_64/kernel/fs/nfsd/nfsd.ko&quot;</span> at</span><br><span class="line">        .text_addr = 0xffffffffc1422000</span><br><span class="line">        .data_addr = 0xffffffffc1462000</span><br><span class="line">        .bss_addr = 0xffffffffc1468040</span><br><span class="line">Reading symbols from /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/fs/nfsd/nfsd.ko...Reading symbols from /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/fs/nfsd/nfsd.ko.debug...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="dump-file-content-in-memory"><a href="#dump-file-content-in-memory" class="headerlink" title="dump file content in memory"></a><a href="http://oliveryang.net/2015/07/linux-crash-page-cache-debug/#1-new-page-cache-debug-options">dump file content in memory</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">$ vim anaconda-ks.cfg</span><br><span class="line"><span class="comment">#version=DEVEL</span></span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth --enableshadow --passalgo=sha512</span><br><span class="line"><span class="comment"># Use CDROM installation media</span></span><br><span class="line">cdrom</span><br><span class="line"><span class="comment"># Use graphical install</span></span><br><span class="line">graphical</span><br><span class="line"><span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line">firstboot --<span class="built_in">enable</span></span><br><span class="line">ignoredisk --only-use=vda</span><br><span class="line"><span class="comment"># Keyboard layouts</span></span><br><span class="line">keyboard --vckeymap=us --xlayouts=<span class="string">&#x27;us&#x27;</span></span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US.UTF-8</span><br><span class="line">....</span><br><span class="line">crash&gt; foreach files -c -R anaconda-ks.cfg</span><br><span class="line">PID: 28525  TASK: ffff9c7890232100  CPU: 1   COMMAND: <span class="string">&quot;vim&quot;</span></span><br><span class="line">ROOT: /    CWD: /root</span><br><span class="line"> FD      INODE          I_MAPPING     NRPAGES TYPE PATH</span><br><span class="line">  4 ffff9c78db8f2a88 ffff9c78db8f2bd8       3 REG  /root/.anaconda-ks.cfg.swp</span><br><span class="line"></span><br><span class="line">crash&gt; files -p ffff9c78db8f2a88</span><br><span class="line">     INODE        NRPAGES</span><br><span class="line">ffff9c78db8f2a88        3</span><br><span class="line"></span><br><span class="line">      PAGE       PHYSICAL      MAPPING       INDEX CNT FLAGS</span><br><span class="line">ffffdb8784317180 10c5c6000 ffff9c78db8f2bd8        0  2 2fffff0000082c referenced,uptodate,lru,private</span><br><span class="line">ffffdb87851e7d80 1479f6000 ffff9c78db8f2bd8        1  2 2fffff0000082c referenced,uptodate,lru,private</span><br><span class="line">ffffdb87851e7dc0 1479f7000 ffff9c78db8f2bd8        2  2 2fffff0000082c referenced,uptodate,lru,private</span><br><span class="line">crash&gt; rd -p -a 1479f7000 4096 | tail -12</span><br><span class="line">       1479f7ed6:  keyboard --vckeymap=us --xlayouts=<span class="string">&#x27;us&#x27;</span></span><br><span class="line">       1479f7efd:  <span class="comment"># Keyboard layouts</span></span><br><span class="line">       1479f7f10:  ignoredisk --only-use=vda</span><br><span class="line">       1479f7f2a:  firstboot --<span class="built_in">enable</span></span><br><span class="line">       1479f7f3d:  <span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line">       1479f7f61:  graphical</span><br><span class="line">       1479f7f6b:  <span class="comment"># Use graphical install</span></span><br><span class="line">       1479f7f83:  cdrom</span><br><span class="line">       1479f7f89:  <span class="comment"># Use CDROM installation media</span></span><br><span class="line">       1479f7fa8:  auth --enableshadow --passalgo=sha512</span><br><span class="line">       1479f7fce:  <span class="comment"># System authorization information</span></span><br><span class="line">       1479f7ff1:  <span class="comment">#version=DEVEL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  show you top 10 page cache consumers</span></span><br><span class="line">$ crash&gt; foreach files -c -R REG | sort -k4 -nr | head -n10</span><br><span class="line"></span><br><span class="line"><span class="comment"># display the number of pages that are in the page cache</span></span><br><span class="line">$ crash&gt; files -c 28525</span><br><span class="line">PID: 28525  TASK: ffff9c7890232100  CPU: 1   COMMAND: <span class="string">&quot;vim&quot;</span></span><br><span class="line">ROOT: /    CWD: /root</span><br><span class="line"> FD      INODE          I_MAPPING     NRPAGES TYPE PATH</span><br><span class="line">  0 ffff9c78ee33b390 ffff9c78ee33b4e0       0 CHR  /dev/pts/2</span><br><span class="line">  1 ffff9c78ee33b390 ffff9c78ee33b4e0       0 CHR  /dev/pts/2</span><br><span class="line">  2 ffff9c78ee33b390 ffff9c78ee33b4e0       0 CHR  /dev/pts/2</span><br><span class="line">  4 ffff9c78db8f2a88 ffff9c78db8f2bd8       3 REG  /root/.anaconda-ks.cfg.swp</span><br><span class="line"></span><br><span class="line">display all of its pages that are <span class="keyword">in</span> the page cache</span><br><span class="line">$ files -p ffff9c78db8f2a88</span><br><span class="line">     INODE        NRPAGES</span><br><span class="line">ffff9c78db8f2a88        3</span><br><span class="line"></span><br><span class="line">      PAGE       PHYSICAL      MAPPING       INDEX CNT FLAGS</span><br><span class="line">ffffdb8784317180 10c5c6000 ffff9c78db8f2bd8        0  2 2fffff0000082c referenced,uptodate,lru,private</span><br><span class="line">ffffdb87851e7d80 1479f6000 ffff9c78db8f2bd8        1  2 2fffff0000082c referenced,uptodate,lru,private</span><br><span class="line">ffffdb87851e7dc0 1479f7000 ffff9c78db8f2bd8        2  2 2fffff0000082c referenced,uptodate,lru,private</span><br></pre></td></tr></table></figure><h4 id="memory-hacking"><a href="#memory-hacking" class="headerlink" title="memory hacking"></a><a href="http://oliveryang.net/2017/03/linux-kernel-memory-hacking/">memory hacking</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; wr panic_on_oops 1</span><br><span class="line">wr: cannot write to /dev/crash!</span><br><span class="line"></span><br><span class="line">linux-3.10.0-1127.el7/arch/x86/mm/init.c</span><br><span class="line">/*</span><br><span class="line"> * devmem_is_allowed() checks to see <span class="keyword">if</span> /dev/mem access to a certain address</span><br><span class="line"> * is valid. The argument is a physical page number.</span><br><span class="line"> *</span><br><span class="line"> * On x86, access has to be given to the first megabyte of RAM because that</span><br><span class="line"> * area traditionally contains BIOS code and data regions used by X, dosemu,</span><br><span class="line"> * and similar apps. Since they map the entire memory range, the whole range</span><br><span class="line"> * must be allowed (<span class="keyword">for</span> mapping), but any areas that would otherwise be</span><br><span class="line"> * disallowed are flagged as being <span class="string">&quot;zero filled&quot;</span> instead of rejected.</span><br><span class="line"> * Access has to be given to non-kernel-ram areas as well, these contain the</span><br><span class="line"> * PCI mmio resources as well as potential bios/acpi data regions.</span><br><span class="line"> */</span><br><span class="line">int devmem_is_allowed(unsigned long pagenr)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (region_intersects_ram(PFN_PHYS(pagenr), PAGE_SIZE)</span><br><span class="line">                        != REGION_DISJOINT) &#123;</span><br><span class="line">                /*</span><br><span class="line">                 * For disallowed memory regions <span class="keyword">in</span> the low 1MB range,</span><br><span class="line">                 * request that the page be shown as all zeros.</span><br><span class="line">                 */</span><br><span class="line">                <span class="keyword">if</span> (pagenr &lt; 256)</span><br><span class="line">                        <span class="built_in">return</span> 2;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">return</span> 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * This must follow RAM <span class="built_in">test</span>, since System RAM is considered a</span><br><span class="line">         * restricted resource under CONFIG_STRICT_IOMEM.</span><br><span class="line">         */</span><br><span class="line">        <span class="keyword">if</span> (iomem_is_exclusive(pagenr &lt;&lt; PAGE_SHIFT)) &#123;</span><br><span class="line">                /* Low 1MB bypasses iomem restrictions. */</span><br><span class="line">                <span class="keyword">if</span> (pagenr &lt; 256)</span><br><span class="line">                        <span class="built_in">return</span> 1;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">return</span> 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ crash /dev/mem</span><br><span class="line">crash&gt; wr panic_on_oops 1</span><br><span class="line">wr: write error: kernel virtual address: ffffffffbae47ed4  <span class="built_in">type</span>: <span class="string">&quot;write memory&quot;</span></span><br><span class="line"></span><br><span class="line">$ stap -g -e <span class="string">&#x27;probe kernel.function(&quot;devmem_is_allowed&quot;).return &#123; $return = 1 &#125;&#x27;</span></span><br><span class="line"><span class="comment">#### bpftrace -e &#x27;k:devmem_is_allowed &#123;return 1; &#125;&#x27; --unsafe ### bpftrace not work</span></span><br><span class="line"><span class="comment">#### btw, if is another kernel module, eg:</span></span><br><span class="line"><span class="comment">#### $ stap -g -e &#x27;probe module(&quot;ptlrpc&quot;).function(&quot;ptlrpc_expire_one_request&quot;).return &#123; $return = 1 &#125;&#x27;</span></span><br><span class="line"><span class="comment">#### $ stap -g -e &#x27;probe module(&quot;osc&quot;).function(&quot;osc_enter_cache_try&quot;).return &#123; printf (&quot;return value: %d\n&quot;,$return); &#125;&#x27;</span></span><br><span class="line"><span class="comment">#### $ bpftrace -e &#x27;kretprobe:osc_enter_cache_try &#123; printf(&quot;returned: %d\n&quot;, retval); &#125;&#x27;</span></span><br><span class="line">crash&gt; wr panic_on_oops 0</span><br><span class="line">crash&gt; p panic_on_oops</span><br><span class="line">panic_on_oops = <span class="variable">$1</span> = 0</span><br></pre></td></tr></table></figure><h3 id="Got-the-kernel-module"><a href="#Got-the-kernel-module" class="headerlink" title="Got the kernel module"></a>Got the kernel module</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### ring buffer</span></span><br><span class="line">[36794.588796] BUG: Bad page state <span class="keyword">in</span> process swapper/7  pfn:137bba</span><br><span class="line">[36794.589974] page:ffffcb3d44deee80 count:-1 mapcount:0 mapping:          (null) index:0x0</span><br><span class="line">[36794.591073] page flags: 0x2fffff00000000()</span><br><span class="line">[36794.592149] page dumped because: nonzero _count</span><br><span class="line">[36794.593218] Modules linked <span class="keyword">in</span>: osp(OE) ofd(OE) lfsck(OE) ost(OE) mgc(OE) osd_ldiskfs(OE) ldiskfs(OE) lquota(OE) fid(OE) fld(OE) ksocklnd(OE) ptlrpc(OE) mbcache jbd2 obdclass(OE) lnet(OE) libcfs(OE) bonding mpt2sas mptctl mptbase dell_rbu dcdbas sunrpc vfat fat iTCO_wdt iTCO_vendor_support zfs(POE) zunicode(POE) zavl(POE) icp(POE) sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr nvme nvme_core joydev zcommon(POE) znvpair(POE) spl(OE) lpc_ich mei_me mei raid0 i2c_i801 ses enclosure sg ioatdma ipmi_si ipmi_devintf ipmi_msghandler acpi_power_meter acpi_pad wmi binfmt_misc ip_tables xfs libcrc32c raid1 sd_mod crc_t10dif crct10dif_generic ast drm_kms_helper syscopyarea sysfillrect</span><br><span class="line">[36794.600275]  sysimgblt fb_sys_fops ttm drm ixgbe mpt3sas ahci igb libahci i40e(OE) raid_class mdio crct10dif_pclmul crct10dif_common libata crc32c_intel ptp drm_panel_orientation_quirks scsi_transport_sas dca i2c_algo_bit pps_core</span><br><span class="line">[36794.603927] CPU: 7 PID: 0 Comm: swapper/7 Kdump: loaded Tainted: P           OE  ------------   3.10.0-1160.2.1.el7_lustre.x86_64 <span class="comment">#1</span></span><br><span class="line">[36794.606340] Hardware name: Supermicro SSG-2028R-DE2CR24L/X10DRS-2U, BIOS 2.1 11/04/2016</span><br><span class="line">[36794.607569] Call Trace:</span><br><span class="line">[36794.608749]  &lt;IRQ&gt;  [&lt;ffffffff94f813c0&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[36794.609958]  [&lt;ffffffff94f7bf7d&gt;] bad_page.part.75+0xdc/0xf9</span><br><span class="line">[36794.611190]  [&lt;ffffffff949c8625&gt;] get_page_from_freelist+0x7a5/0xac0</span><br><span class="line">[36794.612395]  [&lt;ffffffff94e07e29&gt;] ? __domain_mapping+0x209/0x3c0</span><br><span class="line">[36794.613525]  [&lt;ffffffff949c8aa6&gt;] __alloc_pages_nodemask+0x166/0x450</span><br><span class="line">[36794.614737]  [&lt;ffffffffc0380578&gt;] i40e_alloc_rx_buffers+0x158/0x2f0 [i40e]</span><br><span class="line">[36794.615952]  [&lt;ffffffffc0380c8c&gt;] i40e_clean_rx_irq+0x57c/0xb40 [i40e]</span><br><span class="line">[36794.617189]  [&lt;ffffffffc03815a1&gt;] i40e_napi_poll+0x351/0x7a0 [i40e]</span><br><span class="line">[36794.618342]  [&lt;ffffffff94e5561f&gt;] net_rx_action+0x26f/0x390</span><br><span class="line">[36794.619425]  [&lt;ffffffff948a4b95&gt;] __do_softirq+0xf5/0x280</span><br><span class="line">[36794.620544]  [&lt;ffffffff94f974ec&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[36794.621622]  [&lt;ffffffff9482f715&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[36794.622749]  [&lt;ffffffff948a4f15&gt;] irq_exit+0x105/0x110</span><br><span class="line">[36794.623874]  [&lt;ffffffff94f98936&gt;] do_IRQ+0x56/0xf0</span><br><span class="line">[36794.624903]  [&lt;ffffffff94f8a36a&gt;] common_interrupt+0x16a/0x16a</span><br><span class="line">[36794.625943]  &lt;EOI&gt;  [&lt;ffffffff94f897b2&gt;] ? poll_idle+0x92/0xab</span><br><span class="line">[36794.626987]  [&lt;ffffffff94f897bc&gt;] ? poll_idle+0x9c/0xab</span><br><span class="line">[36794.628027]  [&lt;ffffffff94dc71f5&gt;] cpuidle_enter_state+0x45/0xd0</span><br><span class="line">[36794.629035]  [&lt;ffffffff94dc735e&gt;] cpuidle_idle_call+0xde/0x230</span><br><span class="line">[36794.629964]  [&lt;ffffffff94837c8e&gt;] arch_cpu_idle+0xe/0xc0</span><br><span class="line">[36794.630938]  [&lt;ffffffff949011ea&gt;] cpu_startup_entry+0x14a/0x1e0</span><br><span class="line">[36794.631895]  [&lt;ffffffff9485a7f7&gt;] start_secondary+0x1f7/0x270</span><br><span class="line">[36794.632856]  [&lt;ffffffff948000d5&gt;] start_cpu+0x5/0x14</span><br><span class="line">[36794.622749]  [&lt;ffffffff948a4f15&gt;] irq_exit+0x105/0x110</span><br><span class="line"></span><br><span class="line">crash&gt; mod -s i40e /lib/modules/3.10.0-1160.2.1.el7_lustre.x86_64/updates/drivers/net/ethernet/intel/i40e/i40e.ko</span><br><span class="line">     MODULE       NAME                             SIZE  OBJECT FILE</span><br><span class="line">ffffffffc03b6da0  i40e                           510664  /lib/modules/3.10.0-1160.2.1.el7_lustre.x86_64/updates/drivers/net/ethernet/intel/i40e/i40e.ko</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">crash&gt; mod|grep i40e</span><br><span class="line">ffffffffc03b6da0  i40e                           510664  /lib/modules/3.10.0-1160.2.1.el7_lustre.x86_64/updates/drivers/net/ethernet/intel/i40e/i40e.ko</span><br><span class="line"></span><br><span class="line">crash&gt; mod -t</span><br><span class="line">NAME         TAINTS</span><br><span class="line">i40e         OE</span><br><span class="line"></span><br><span class="line">crash&gt; module.version ffffffffc03b6da0</span><br><span class="line">  version = 0xffff986f02be7098 <span class="string">&quot;2.13.10&quot;</span></span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[5257172.312256] BUG: Bad page state <span class="keyword">in</span> process ksoftirqd/6  pfn:882556</span><br><span class="line">[5257172.314826] page:ffffe28a62095580 count:0 mapcount:-1 mapping:          (null) index:0x0</span><br><span class="line">[5257172.317284] page flags: 0x2fffff00008000(tail)</span><br><span class="line">[5257172.319614] page dumped because: nonzero mapcount</span><br><span class="line">[5257172.418956] Modules linked <span class="keyword">in</span>: ipmi_poweroff ipmi_watchdog osp(OE) ofd(OE) lfsck(OE) ost(OE) mgc(OE) osd_zfs(OE) lquota(OE) fid(OE) fld(OE) ksocklnd(OE) ptlrpc(OE) obdclass(OE) lnet(OE) libcfs(OE) bonding vfat fat iTCO_wdt iTCO_vendor_support mxm_wmi sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr i2c_i801 lpc_ich mei_me joydev mei ioatdma zfs(POE) zunicode(POE) zavl(POE) icp(POE) zcommon(POE) znvpair(POE) spl(OE) ses enclosure sg ipmi_si ipmi_devintf ipmi_msghandler wmi acpi_power_meter acpi_pad rpcrdma sunrpc ib_isert iscsi_target_mod ib_iser libiscsi scsi_transport_iscsi ib_srpt target_core_mod ib_srp scsi_transport_srp scsi_tgt ib_ipoib rdma_ucm ib_umad rdma_cm ib_cm iw_cm</span><br><span class="line">[5257172.429763]  mlx5_ib ib_uverbs ib_core binfmt_misc ip_tables xfs libcrc32c sd_mod crc_t10dif crct10dif_generic ast i2c_algo_bit drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm ahci mlx5_core drm ixgbe libahci mdio mlxfw crct10dif_pclmul crct10dif_common devlink mpt3sas(OE) libata megaraid_sas crc32c_intel ptp pps_core raid_class drm_panel_orientation_quirks scsi_transport_sas dca</span><br><span class="line">[5257172.437256] CPU: 6 PID: 41 Comm: ksoftirqd/6 Kdump: loaded Tainted: P    B      OE  ------------ T 3.10.0-1160.2.1.el7_lustre.x86_64 <span class="comment">#1</span></span><br><span class="line">[5257172.441017] Hardware name: Supermicro X10DRH/X10DRH-CT, BIOS 3.1 06/18/2018</span><br><span class="line">[5257172.442716] Call Trace:</span><br><span class="line">[5257172.444506]  [&lt;ffffffff963813c0&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[5257172.446313]  [&lt;ffffffff9637bf7d&gt;] bad_page.part.75+0xdc/0xf9</span><br><span class="line">[5257172.448054]  [&lt;ffffffff95dc6b32&gt;] free_pages_prepare+0x1f2/0x210</span><br><span class="line">[5257172.449757]  [&lt;ffffffff95dc6e69&gt;] __free_pages_ok+0x19/0xc0</span><br><span class="line">[5257172.451481]  [&lt;ffffffff95dc6f2b&gt;] free_compound_page+0x1b/0x20</span><br><span class="line">[5257172.453212]  [&lt;ffffffff9637d110&gt;] __put_compound_page+0x25/0x28</span><br><span class="line">[5257172.454879]  [&lt;ffffffff9637d279&gt;] put_compound_page+0x166/0x174</span><br><span class="line">[5257172.456587]  [&lt;ffffffff95dcc1f6&gt;] put_page+0x56/0x60</span><br><span class="line">[5257172.458259]  [&lt;ffffffff9623d67f&gt;] skb_release_data+0x8f/0x150</span><br><span class="line">[5257172.459915]  [&lt;ffffffff9623d764&gt;] skb_release_all+0x24/0x30</span><br><span class="line">[5257172.461531]  [&lt;ffffffff9623dd68&gt;] napi_consume_skb+0xa8/0x100</span><br><span class="line">[5257172.463265]  [&lt;ffffffffc083b87f&gt;] mlx5e_poll_tx_cq+0x1ff/0x590 [mlx5_core]</span><br><span class="line">[5257172.464969]  [&lt;ffffffff95cdab02&gt;] ? default_wake_function+0x12/0x20</span><br><span class="line">[5257172.466692]  [&lt;ffffffff95cc6d3b&gt;] ? autoremove_wake_function+0x2b/0x40</span><br><span class="line">[5257172.468391]  [&lt;ffffffffc084042b&gt;] mlx5e_napi_poll+0x7b/0xd10 [mlx5_core]</span><br><span class="line">[5257172.470088]  [&lt;ffffffff95cd2ba0&gt;] ? task_rq_unlock+0x20/0x20</span><br><span class="line">[5257172.471777]  [&lt;ffffffff9625561f&gt;] net_rx_action+0x26f/0x390</span><br><span class="line">[5257172.473413]  [&lt;ffffffff95ca4b95&gt;] __do_softirq+0xf5/0x280</span><br><span class="line">[5257172.475042]  [&lt;ffffffff95ca4d58&gt;] run_ksoftirqd+0x38/0x50</span><br><span class="line">[5257172.476676]  [&lt;ffffffff95cce674&gt;] smpboot_thread_fn+0x144/0x1a0</span><br><span class="line">[5257172.478371]  [&lt;ffffffff95cce530&gt;] ? lg_double_unlock+0x40/0x40</span><br><span class="line">[5257172.480081]  [&lt;ffffffff95cc5c21&gt;] kthread+0xd1/0xe0</span><br><span class="line">[5257172.481747]  [&lt;ffffffff95cc5b50&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[5257172.483458]  [&lt;ffffffff96393df7&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line"></span><br><span class="line">crash&gt; page.first_page ffffe28a62095580</span><br><span class="line">    first_page = 0xffffe28a62095400</span><br><span class="line">crash&gt; page.flags,slab_cache 0xffffe28a62095400</span><br><span class="line">  flags = 13510794587144192</span><br><span class="line">    slab_cache = 0xffff8e19ffc03200</span><br><span class="line">crash&gt; kmem 0xffff8e19ffc03200</span><br><span class="line">CACHE            NAME                 OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE</span><br><span class="line">ffff8e19ffc02000 kmem_cache               216        127       384     12     8k</span><br><span class="line">  SLAB              MEMORY            NODE  TOTAL  ALLOCATED  FREE</span><br><span class="line">  ffffe28a45ff0080  ffff8e19ffc02000     0     32         32     0</span><br><span class="line">  FREE / [ALLOCATED]</span><br><span class="line">  [ffff8e19ffc03200]</span><br><span class="line"></span><br><span class="line">      PAGE         PHYSICAL      MAPPING       INDEX CNT FLAGS</span><br><span class="line">ffffe28a45ff00c0  17fc03000                0        0  0 2fffff00008000 tail</span><br><span class="line">crash&gt; struct kmem_cache.name 0xffff8e19ffc03200</span><br><span class="line">  name = 0xffffffff9668fcb6 <span class="string">&quot;kmalloc-8192&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;compression&quot;&gt;&lt;a href=&quot;#compression&quot; class=&quot;headerlink&quot; title=&quot;compression&quot;&gt;&lt;/a&gt;compression&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table</summary>
      
    
    
    
    <category term="Scripts" scheme="http://yoursite.com/categories/Scripts/"/>
    
    
    <category term="debug" scheme="http://yoursite.com/tags/debug/"/>
    
    <category term="trace" scheme="http://yoursite.com/tags/trace/"/>
    
  </entry>
  
  <entry>
    <title>lfs command</title>
    <link href="http://yoursite.com/2019/12/29/lfs_command/"/>
    <id>http://yoursite.com/2019/12/29/lfs_command/</id>
    <published>2019-12-29T07:41:16.000Z</published>
    <updated>2021-11-07T13:41:25.894Z</updated>
    
    <content type="html"><![CDATA[<h3 id="All"><a href="#All" class="headerlink" title="All"></a>All</h3><h4 id="check-lfs-log"><a href="#check-lfs-log" class="headerlink" title="check lfs log"></a>check lfs log</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">$ lctl  get_param  at_max</span><br><span class="line">at_max=600</span><br><span class="line">Maximum adaptive timeout (<span class="keyword">in</span> seconds). The at_max parameter is an upper-limit on the service time estimate. If at_max is reached, an RPC request <span class="built_in">times</span> out.Setting at_max to 0 causes adaptive timeouts to be disabled and a fixed timeout method to be used instead (see the section called “Setting Static Timeouts” Note If slow hardware causes the service estimate to increase beyond the default value of at_max, increase at_max to the maximum time you are willing to <span class="built_in">wait</span> <span class="keyword">for</span> an RPC completion.</span><br><span class="line">$ lctl  get_param  at_min</span><br><span class="line">at_min=50</span><br><span class="line">Minimum adaptive timeout (<span class="keyword">in</span> seconds). The default value is 0. The at_min parameter is the minimum processing time that a server will report. Ideally, at_min should be <span class="built_in">set</span> to its default value. Clients base their timeouts on this value, but they <span class="keyword">do</span> not use this value directly.If, <span class="keyword">for</span> unknown reasons (usually due to temporary network outages), the adaptive timeout value is too short and clients time out their RPCs, you can increase the at_min value to compensate <span class="keyword">for</span> this.</span><br><span class="line">$ lctl get_param at_extra</span><br><span class="line">at_extra=30</span><br><span class="line"><span class="comment">#Incremental amount of time that a server requests with each early reply (in seconds). The server does not know how much time the RPC will take, so it asks for a fixed value. The default is 30, which provides a balance between sending too many early replies for the same RPC and overestimating the actual completion time.When a server finds a queued request about to time out and needs to send an early reply out, the server adds the at_extra value. If the time expires, the Lustre server drops the request, and the client enters recovery status and reconnects to restore the connection to normal status.If you see multiple early replies for the same RPC asking for 30-second increases, change the at_extra value to a larger number to cut down on early replies sent and, therefore, network load.</span></span><br><span class="line"></span><br><span class="line">$ lctl  get_param  timeout</span><br><span class="line">timeout=300</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lctl get_param -n debug</span><br><span class="line">$ lctl set_param debug=<span class="string">&quot;ioctl neterror warning error emerg ha config console lfsck mmap page dentry cache malloc reada quota dlmtrace&quot;</span></span><br><span class="line">$ lctl set_param debug=<span class="string">&quot;ioctl neterror warning error emerg ha config console lfsck cache reada quota&quot;</span></span><br><span class="line">$ lctl set_param debug=<span class="string">&quot;ioctl neterror warning error emerg ha config console lfsck&quot;</span></span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.dump_namespaces</span><br><span class="line"><span class="comment">##no output</span></span><br><span class="line">$ lctl set_param ldlm.dump_namespaces <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">$ lctl get_param llite.*.dump_page_cache | grep -cEi <span class="string">&#x27;lockd|dirty|writeback&#x27;</span></span><br><span class="line"></span><br><span class="line">$ strings dk</span><br><span class="line">$ lctl df &lt;input file&gt; &lt;output file&gt;</span><br><span class="line"></span><br><span class="line">lfs rpm package install will not overvide the /lib/modules/$(uname -r)/extra</span><br><span class="line">$ rm -rf /lib/modules/$(uname -r)/extra/; mkdir /lib/modules/$(uname -r)/extra</span><br><span class="line"></span><br><span class="line">$ lctl get_param debug_path</span><br><span class="line">debug_path=/tmp/lfs-log</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable(set to 1) bulk pages dump upon error on Client</span></span><br><span class="line">Client $ lctl get_param osc.*osc-[^mM]*.checksum_dump</span><br><span class="line">osc.fsname-OST0000-osc-ffff8dab2cce8800.checksum_dump=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable(set to 1) bulk pages dump upon error on OSS</span></span><br><span class="line">Oss$ lctl get_param obdfilter.*-OST*.checksum_dump</span><br><span class="line">obdfilter.fsname-OST0000.checksum_dump=0</span><br><span class="line"></span><br><span class="line"><span class="comment">## mds and oss</span></span><br><span class="line">can1=$(do_facet mds1 <span class="string">&quot;<span class="variable">$LCTL</span> get_param -n ldlm.services.ldlm_canceld.stats&quot;</span> |awk <span class="string">&#x27;/ldlm_cancel/ &#123;print $2&#125;&#x27;</span>)</span><br><span class="line">blk1=$(<span class="variable">$LCTL</span> get_param -n ldlm.services.ldlm_cbd.stats |awk <span class="string">&#x27;/ldlm_bl_callback/ &#123;print $2&#125;&#x27;</span>) </span><br><span class="line"></span><br><span class="line">test_mkdir -i0 -c1 <span class="variable">$DIR</span>/<span class="variable">$tdir</span>/d1</span><br><span class="line"></span><br><span class="line">can2=$(do_facet mds1 <span class="string">&quot;<span class="variable">$LCTL</span> get_param -n ldlm.services.ldlm_canceld.stats&quot;</span> |awk <span class="string">&#x27;/ldlm_cancel/ &#123;print $2&#125;&#x27;</span>)</span><br><span class="line">blk2=$(<span class="variable">$LCTL</span> get_param -n ldlm.services.ldlm_cbd.stats | awk <span class="string">&#x27;/ldlm_bl_callback/ &#123;print $2&#125;&#x27;</span>)</span><br><span class="line">[ <span class="variable">$can1</span> -eq <span class="variable">$can2</span> ] || error $((can2-can1)) <span class="string">&quot;cancel RPC occured.&quot;</span></span><br><span class="line">[ <span class="variable">$blk1</span> -eq <span class="variable">$blk2</span> ] || error $((blk2-blk1)) <span class="string">&quot;blocking RPC occured.&quot;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="list-all-parameters"><a href="#list-all-parameters" class="headerlink" title="list all parameters"></a>list all parameters</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lctl list_param -R <span class="string">&#x27;*&#x27;</span></span><br><span class="line">$ lctl list_param osc.*.*</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> $(ls /proc/fs/lfs); <span class="keyword">do</span> lctl get_param <span class="variable">$&#123;i&#125;</span>.*.*; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h3><h4 id="MDS-ops"><a href="#MDS-ops" class="headerlink" title="MDS ops"></a>MDS ops</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### the same deploy like add OST, just change the index, don &#x27;t need to add the MGS </span></span><br><span class="line"><span class="comment">### </span></span><br><span class="line">$ lfs mkdir -c stripe_count ./<span class="built_in">dirs</span> <span class="comment">## stripe dirs in MDT DNE, loading balancing in diff MDT</span></span><br><span class="line">$ lfs mkdir -i mdt_index ./<span class="built_in">dirs</span></span><br><span class="line">$ lctl set_param fsname.mdt.enable_remote_dir=1</span><br><span class="line">$ lctl conf_param fsname.mdt.enable_remote_dir_gid=-1</span><br><span class="line">$ lctl get_param mdt.*.enable_remote_dir mdt.*.enable_remote_dir_gid</span><br><span class="line"></span><br><span class="line">$ mkdir /mdtest&#123;0..5&#125; <span class="comment"># for 6 mdt</span></span><br><span class="line">clinet $ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..5&#125; </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  lfs mkdir -i <span class="variable">$i</span> /mdtest/<span class="variable">$I</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">## how to test DNE feature in mdtest</span></span><br><span class="line"><span class="comment">## add &quot;-u&quot; and &quot; -d /mdtest/0/@/mdtest/1/@/mdtest/2/@/mdtest/3/@/mdtest/4/@/mdtest/5/&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## DNE2</span></span><br><span class="line">$ lfs setdirstripe -c <span class="variable">$mdt</span> -i -1 <span class="variable">$OUTDIR</span></span><br><span class="line">$ lfs setdirstripe -D -c <span class="variable">$mdt</span> -i -1 <span class="variable">$OUTDIR</span></span><br><span class="line">$ lfs setstripe -c <span class="variable">$OSTCOUNT</span> --pool capacity <span class="variable">$OUTDIR</span></span><br><span class="line">$ lfs setstripe -L mdt -E 64K -E -1 <span class="variable">$OUTDIR</span> (DoM testing)</span><br><span class="line"></span><br><span class="line"><span class="comment">### https://www.opensfs.org/wp-content/uploads/Evaluation-of-DoM-SNE-scaling_Simmons_revised051821.pdf</span></span><br><span class="line">$ lctl set_param mdt.*.enable_dir_auto_split=1</span><br><span class="line">$ lctl <span class="built_in">set</span> param mdt.*.dir_split_delta=1</span><br><span class="line">$ lctl <span class="built_in">set</span> param mdt.*.dir_split_count=15000</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify service node</span></span><br><span class="line"><span class="comment"># --erase-params </span></span><br><span class="line">$ tunefs.lustre --param=servicenode=192.168.0.10@tcp /dev/sdb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lctl get_param mdt.lfs-MDT0000.recovery_status</span><br><span class="line"></span><br><span class="line">$ lfs getstripe -m ./stripe/test.2</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">$ lfs getstripe -m ./stripe/test.1</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ lfs mkdir -c 8 ./your_dir</span><br><span class="line"></span><br><span class="line">$ lfs find --mdt-index 0 ./stripe</span><br><span class="line">./stripe/test.2</span><br><span class="line">./stripe/test.8</span><br><span class="line">./stripe/test.6</span><br><span class="line">./stripe/test.4</span><br><span class="line">./stripe/test.0</span><br><span class="line"></span><br><span class="line">$ lfs find --mdt-index 1 ./stripe</span><br><span class="line">./stripe</span><br><span class="line">./stripe/test.1</span><br><span class="line">./stripe/test.5</span><br><span class="line">./stripe/test.7</span><br><span class="line">./stripe/test.3</span><br><span class="line">./stripe/test.9</span><br><span class="line"></span><br><span class="line"><span class="comment">## read only</span></span><br><span class="line">$ lctl set_param mdt.fs-MDT0000.readonly=1</span><br><span class="line"></span><br><span class="line"><span class="comment">### show the recovery status</span></span><br><span class="line">$ lctl get_param mdt.testfs-MDT0000.recovery_status</span><br><span class="line">mdt.testsfs-MDT0000.recovery_status=</span><br><span class="line">status: COMPLETE</span><br><span class="line">recovery_start: 47</span><br><span class="line">recovery_duration: 23</span><br><span class="line">completed_clients: 2/2</span><br><span class="line">replayed_requests: 0</span><br><span class="line">last_transno: 5673970243</span><br><span class="line">VBR: DISABLED</span><br><span class="line">IR: DISABLED</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set all clients parameters</span></span><br><span class="line"><span class="comment">## Hidden QoS</span></span><br><span class="line">$ lctl set_param -P osc.*.grant_shrink=0 <span class="comment">## not in /sys and /proc</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## for SSD</span></span><br><span class="line">MDS $ lctl set_param -P osc.*.max_pages_per_rpc=256 osc.*.max_rpcs_in_flight=64  mdc.*.max_rpcs_in_flight=64 osc.*.max_dirty_mb=512 llite.*.max_read_ahead_mb=0 osc.*.grant_shrink=0 </span><br><span class="line"></span><br><span class="line">MDS $ lctl set_param -P osc.*.max_read_ahead_mb=0</span><br><span class="line"><span class="comment">## it &#x27;not </span></span><br><span class="line">$ lctl set_param -P llite.*.max_read_ahead_mb=0</span><br><span class="line"></span><br><span class="line">$  lctl get_param ldlm.*.*.lock_timeouts</span><br><span class="line">ldlm.namespaces.MGC10.53.18.238@tcp.lock_timeouts=0</span><br><span class="line">ldlm.namespaces.MGS.lock_timeouts=0</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.lock_timeouts=0</span><br><span class="line">ldlm.namespaces.fsname-OST0000-osc-MDT0000.lock_timeouts=0</span><br><span class="line">ldlm.namespaces.fsname-OST0001-osc-MDT0000.lock_timeouts=0</span><br><span class="line">ldlm.namespaces.mdt-fsname-MDT0000_UUID.lock_timeouts=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param osp.*.active</span><br><span class="line">osp.fsname-OST0000-osc-MDT0000.active=1</span><br><span class="line">osp.fsname-OST0001-osc-MDT0000.active=1</span><br><span class="line">$  lctl get_param osd-zfs.fsname-MDT0000.mntdev</span><br><span class="line">osd-zfs.fsname-MDT0000.mntdev=test_mdt/test_mdt0</span><br><span class="line">$ lctl get_param mgs.MGS.mntdev</span><br><span class="line">mgs.MGS.mntdev=test_mdt/test_mdt0</span><br><span class="line">$ lctl barrier_stat fsname</span><br><span class="line">state: init</span><br><span class="line">timeout: 0 seconds</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n mdt.*MDT*.enable_dir_migration</span><br><span class="line">1</span><br><span class="line">$ lctl get_param -n mdt.*MDT*.enable_remote_dir</span><br><span class="line">1</span><br><span class="line">$ lctl get_param -n mdt.*MDT*.enable_striped_dir</span><br><span class="line">1</span><br><span class="line">$ lctl get_param -n mdt.*MDT*.enable_dir_migration</span><br><span class="line">1</span><br><span class="line">$ lctl get_param -n mdt.*MDT*.enable_remote_dir</span><br><span class="line">1</span><br><span class="line">$ lctl get_param -n mdt.*MDT*.enable_striped_dir</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment">## The global write barriers</span></span><br><span class="line">Snapshots are non-atomic across multiple MDTs and OSTs, <span class="built_in">which</span> means that <span class="keyword">if</span> there is activity on the file system <span class="keyword">while</span> a snapshot is being taken, there may be user-visible namespace inconsistencies with files created or destroyed <span class="keyword">in</span> the interval between the MDT and OST snapshots. In order to create a consistent snapshot of the file system, we are able to <span class="built_in">set</span> a global write barrier, or “freeze” the system. Once <span class="built_in">set</span>, all metadata modifications will be blocked until the write barrier is actively removed (“thawed”) or expired. The user can <span class="built_in">set</span> a timeout parameter on a global barrier or the barrier can be explicitly removed. The default timeout period is 30 seconds.</span><br><span class="line">$ lctl barrier_freeze <span class="variable">$FSNAME</span> 30</span><br><span class="line">$ lctl barrier_thaw <span class="variable">$FSNAME</span></span><br><span class="line">$ lctl barrier_rescan <span class="variable">$FSNAME</span></span><br><span class="line"></span><br><span class="line">$ lctl get_param  lod.*.qos_prio_free</span><br><span class="line">lod.fsname-MDT0000-mdtlov.qos_prio_free=91%</span><br><span class="line">$ lctl get_param  lod.*.qos_threshold_rr</span><br><span class="line">lod.fsname-MDT0000-mdtlov.qos_threshold_rr=17%</span><br><span class="line">lod.*.qos_threshold_rr - </span><br><span class="line">The threshold at <span class="built_in">which</span> the allocation method switches from round-robin to weighted is <span class="built_in">set</span> <span class="keyword">in</span> this file. The default is to switch to the weighted algorithm when any two OSTs are out of balance by more than 17 percent.</span><br><span class="line">lod.*.qos_prio_free - </span><br><span class="line">The weighting priority used by the weighted allocator can be adjusted <span class="keyword">in</span> this file. Increasing the value of qos_prio_free puts more weighting on the amount of free space available on each OST and less on how stripes are distributed across OSTs. The default value is 91 percent weighting <span class="keyword">for</span> free space rebalancing and 9 percent <span class="keyword">for</span> OST balancing. When the free space priority is <span class="built_in">set</span> to 100, weighting is based entirely on free space and location is no longer used by the striping algorithm</span><br><span class="line"></span><br><span class="line">$ lctl get_param osp.*.max_create_count</span><br><span class="line">osp.fsname-OST0000-osc-MDT0000.max_create_count=20000</span><br><span class="line"></span><br><span class="line">With Lustre 2.9 and later, the MDS should be <span class="built_in">set</span> to only <span class="built_in">disable</span> file creation on that OST by setting max_create_count to zero:</span><br><span class="line">$ lctl set_param osp.osc_name.max_create_count=0</span><br><span class="line"></span><br><span class="line">This ensures that files deleted or migrated off of the OST will have their corresponding OST objects destroyed, and the space will be freed. For example, to <span class="built_in">disable</span> OST0000 <span class="keyword">in</span> the filesystem testfs, run:</span><br><span class="line">$ lctl set_param osp.testfs-OST0000-osc-MDT*.max_create_count=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param osp.fsname-OST0000-osc-MDT0000.active</span><br><span class="line">osp.fsname-OST0000-osc-MDT0000.active=1</span><br><span class="line"><span class="comment">#to deactivate the OSC on the MDS node(s) use:</span></span><br><span class="line">$ lctl set_param osp.fsname-OST0000-osc-MDT0000.active=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n mdt.*.dom_lock</span><br><span class="line">always</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n lod.*.dom_stripesize</span><br><span class="line">1048576</span><br><span class="line">$ lctl get_param osp.*.reserved_mb_high</span><br><span class="line">osp.fsname-OST0000-osc-MDT0000.reserved_mb_high=255329</span><br><span class="line">$ lctl get_param osp.*.reserved_mb_low</span><br><span class="line">osp.fsname-OST0000-osc-MDT0000.reserved_mb_low=127664</span><br><span class="line"><span class="comment"># osp.*.reserved_mb_high - The high watermark used to start object allocation if available space is more than this. The default is 0.2% of total OST size.</span></span><br><span class="line"><span class="comment">#osp.*.reserved_mb_low - The low watermark used to stop object allocation if available space is less than this. The default is 0.1% of total OST size.</span></span><br><span class="line"></span><br><span class="line">$ lctl set_param osp.*.force_sync=1</span><br><span class="line">osp.fsname-OST0000-osc-MDT0000.force_sync=1</span><br><span class="line"></span><br><span class="line">$ lctl get_param  osp.*MDT*.sync_changes</span><br><span class="line">osp.fsname-OST0000-osc-MDT0000.sync_changes=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.namespaces.*.max_nolock_bytes</span><br><span class="line">ldlm.namespaces.MGC10.53.18.238@tcp.max_nolock_bytes=0</span><br><span class="line">ldlm.namespaces.MGS.max_nolock_bytes=0</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.max_nolock_bytes=0</span><br><span class="line">ldlm.namespaces.fsname-OST0000-osc-MDT0000.max_nolock_bytes=0</span><br><span class="line">ldlm.namespaces.mdt-fsname-MDT0000_UUID.max_nolock_bytes=0</span><br><span class="line">$ lctl get_param ldlm.namespaces.*.contention_seconds</span><br><span class="line">ldlm.namespaces.MGC10.53.18.238@tcp.contention_seconds=2</span><br><span class="line">ldlm.namespaces.MGS.contention_seconds=2</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.contention_seconds=2</span><br><span class="line">ldlm.namespaces.fsname-OST0000-osc-MDT0000.contention_seconds=2</span><br><span class="line">ldlm.namespaces.mdt-fsname-MDT0000_UUID.contention_seconds=2</span><br><span class="line">$ lctl get_param ldlm.namespaces.*.contended_locks</span><br><span class="line">ldlm.namespaces.MGC10.53.18.238@tcp.contended_locks=32</span><br><span class="line">ldlm.namespaces.MGS.contended_locks=32</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.contended_locks=32</span><br><span class="line">ldlm.namespaces.fsname-OST0000-osc-MDT0000.contended_locks=32</span><br><span class="line">ldlm.namespaces.mdt-fsname-MDT0000_UUID.contended_locks=32</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.lock_reclaim_threshold_mb</span><br><span class="line">ldlm.lock_reclaim_threshold_mb=783</span><br><span class="line"></span><br><span class="line"><span class="comment">### you could replace stats to * to get more info, lctl get_param mds.MDS.mdt.*</span></span><br><span class="line">$ lctl get_param mdt.*MDT*.exports.*@*.stats</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lctl get_param mdt.*-MDT0000.md_stats osd-*.*MDT*.filesfree osd-*.*MDT*.filestotal  osd-*.*MDT*.kbytesfree  osd-*.*MDT*.kbytestotal</span><br><span class="line">mdt.fsname-MDT0000.md_stats=</span><br><span class="line">snapshot_time             1619838866.314148577 secs.nsecs</span><br><span class="line">open                      599 samples [reqs]</span><br><span class="line">close                     137 samples [reqs] 1 1 137</span><br><span class="line">mknod                     23 samples [reqs] 1 1 23 (min, max, sum)</span><br><span class="line">unlink                    9 samples [reqs]</span><br><span class="line">mkdir                     3 samples [reqs]</span><br><span class="line">rename                    6 samples [reqs]</span><br><span class="line">getattr                   87 samples [reqs]</span><br><span class="line">setattr                   17 samples [reqs]</span><br><span class="line">getxattr                  25 samples [reqs]</span><br><span class="line">setxattr                  11 samples [reqs]</span><br><span class="line">statfs                    25 samples [reqs]</span><br><span class="line">sync                      4 samples [reqs]</span><br><span class="line">samedir_rename            3 samples [reqs]</span><br><span class="line">crossdir_rename           3 samples [reqs]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lctl set_param mdt.*.md_stats=clear</span><br><span class="line"></span><br><span class="line">$ lctl list_param mdt.*.rename_stats</span><br><span class="line">mdt.fsname-MDT0000.rename_stats</span><br><span class="line">$ lctl get_param mdt.*.rename_stats</span><br><span class="line">mdt.fsname-MDT0000.rename_stats=</span><br><span class="line">rename_stats:</span><br><span class="line">- snapshot_time:  1619838907.404363357</span><br><span class="line">- same_dir</span><br><span class="line">      16KB: &#123; sample:   3, pct: 100, cum_pct: 100 &#125;</span><br><span class="line">- crossdir_src</span><br><span class="line">      16KB: &#123; sample:   3, pct: 100, cum_pct: 100 &#125;</span><br><span class="line">- crossdir_tgt</span><br><span class="line">      16KB: &#123; sample:   3, pct: 100, cum_pct: 100 &#125;</span><br><span class="line"></span><br><span class="line">$ lctl get_param mds.MDS.mdt.stats</span><br><span class="line">mds.MDS.mdt.stats=</span><br><span class="line">snapshot_time             1619836421.293308463 secs.nsecs</span><br><span class="line">req_waittime              13090 samples [usec] 5 994 1420115 197067923 (max, min, sum, sum of squares)</span><br><span class="line">req_qdepth                13090 samples [reqs] 0 1 1 1</span><br><span class="line">req_active                13090 samples [reqs] 1 2 13094 13102</span><br><span class="line">req_timeout               13090 samples [sec] 50 50 654500 32725000</span><br><span class="line">reqbuf_avail              26152 samples [bufs] 63 64 1673657 107109575</span><br><span class="line">ldlm_ibits_enqueue        519 samples [reqs] 1 1 519 519</span><br><span class="line">mds_reint_rename          2 samples [reqs] 1 1 2 2</span><br><span class="line">mds_reint_open            162 samples [reqs] 1 1 162 162</span><br><span class="line">mds_getattr               2 samples [usec] 65 75 140 9850</span><br><span class="line">mds_getattr_lock          3 samples [usec] 44 192 296 42400</span><br><span class="line">mds_connect               5 samples [usec] 17 10421 10865 108662423</span><br><span class="line">mds_disconnect            1 samples [usec] 210 210 210 44100</span><br><span class="line">mds_get_root              2 samples [usec] 16 41 57 1937</span><br><span class="line">mds_statfs                22 samples [usec] 27 203 1414 122592</span><br><span class="line">obd_ping                  12530 samples [usec] 4 565 439527 19537985</span><br><span class="line"></span><br><span class="line">$ lctl get_param mds.MDS.mdt_setattr.stats</span><br><span class="line">mds.MDS.mdt_setattr.stats=</span><br><span class="line">snapshot_time             1619836714.197733538 secs.nsecs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Metadata readdir service</span></span><br><span class="line">$ lctl get_param mds.MDS.mdt_readpage.stats</span><br><span class="line">mds.MDS.mdt_readpage.stats=</span><br><span class="line">snapshot_time             1619794903.241168757 secs.nsecs</span><br><span class="line">req_waittime              13 samples [usec] 10 86 509 25623</span><br><span class="line">req_qdepth                13 samples [reqs] 0 0 0 0</span><br><span class="line">req_active                13 samples [reqs] 1 1 13 13</span><br><span class="line">req_timeout               13 samples [sec] 50 50 650 32500</span><br><span class="line">reqbuf_avail              32 samples [bufs] 63 64 2042 130310</span><br><span class="line">mds_close                 7 samples [usec] 21 153 578 60484</span><br><span class="line">mds_readpage              6 samples [usec] 270 498 2423 1031057</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.*0000-osc-*.stats</span><br><span class="line">osc.fsname-OST0000-osc-MDT0000.stats=</span><br><span class="line">snapshot_time             1619794678.828478520 secs.nsecs</span><br><span class="line">req_waittime              18644 samples [usec] 237 8040 18490448 19195339776</span><br><span class="line">req_active                18644 samples [reqs] 1 2 18645 18647</span><br><span class="line">ost_create                2 samples [usec] 237 685 922 525394</span><br><span class="line">ost_get_info              1 samples [usec] 1951 1951 1951 3806401</span><br><span class="line">ost_connect               1 samples [usec] 1074 1074 1074 1153476</span><br><span class="line">ost_statfs                18640 samples [usec] 306 8040 18486501 19189854505</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.services.ldlm_canceld.stats</span><br><span class="line">ldlm.services.ldlm_canceld.stats=</span><br><span class="line">snapshot_time             1619836833.236763001 secs.nsecs</span><br><span class="line">req_waittime              20 samples [usec] 17 683 2564 723094</span><br><span class="line">req_qdepth                20 samples [reqs] 0 0 0 0</span><br><span class="line">req_active                20 samples [reqs] 1 1 20 20</span><br><span class="line">req_timeout               20 samples [sec] 50 50 1000 50000</span><br><span class="line">reqbuf_avail              53 samples [bufs] 63 64 3388 216580</span><br><span class="line">ldlm_cancel               20 samples [usec] 5 224 1432 162534</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.services.ldlm_cbd.stats</span><br><span class="line">ldlm.services.ldlm_cbd.stats=</span><br><span class="line">snapshot_time             1619836850.112362316 secs.nsecs</span><br><span class="line">req_waittime              5 samples [usec] 25 189 549 80843</span><br><span class="line">req_qdepth                5 samples [reqs] 0 0 0 0</span><br><span class="line">req_active                5 samples [reqs] 1 1 5 5</span><br><span class="line">req_timeout               5 samples [sec] 50 50 250 12500</span><br><span class="line">reqbuf_avail              13 samples [bufs] 1 1 13 13</span><br><span class="line">ldlm_bl_callback          5 samples [usec] 14 67 146 6134</span><br><span class="line"></span><br><span class="line">$ lctl --device MGS llog_print <span class="variable">$&#123;fsname&#125;</span>-MDT0000</span><br><span class="line">$ lctl get_param mdc.*.import | grep <span class="string">&quot;target: <span class="variable">$FSNAME</span>-MDT&quot;</span></span><br><span class="line">$ lctl get_param mdc.*.import | grep <span class="string">&quot;connect_flags&quot;</span> | grep disp_stripe</span><br><span class="line">$ lctl get_param mdc.*.import | grep <span class="string">&quot;import flags&quot;</span> <span class="comment">### compare with under export flags</span></span><br><span class="line">$ lct get_param -n mgc.*.uuid</span><br><span class="line">or</span><br><span class="line">$ cat /proc/fs/lfs/mgc/MGC192.168.0.1@tcp1/uuid</span><br><span class="line"></span><br><span class="line">$ lctl get_param -N mgs.MGS.exports.*</span><br><span class="line">mgs.MGS.exports.<span class="variable">$client_ip</span>@tcp1</span><br><span class="line"></span><br><span class="line"><span class="comment">## Got client uuid from mds</span></span><br><span class="line">$ lctl get_param mgs.MGS.exports.192.168.0.2@tcp1.export</span><br><span class="line">mgs.MGS.exports.192.168.0.2@tcp1.export=</span><br><span class="line">e3373379-bb9d-e581-58ee-ce0b83ce9779:</span><br><span class="line">    name: MGS</span><br><span class="line">    client: 192.168.0.2@tcp1</span><br><span class="line">    connect_flags: [ version, barrier, adaptive_timeouts, full20, imp_recov, bulk_mbits ]</span><br><span class="line">    connect_data:</span><br><span class="line">       flags: 0x2000011001002020</span><br><span class="line">       instance: 0</span><br><span class="line">       target_version: 2.12.3.0</span><br><span class="line">    export_flags: [  ]</span><br><span class="line"></span><br><span class="line">$ lctl get_param mgs.MGS.exports.192.168.0.2@tcp1.export | grep <span class="string">&#x27;export flags&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define OBD_FAIL_MDS_LOV_PREP_CREATE 0x141</span></span><br><span class="line">$ lctl set_param fail_loc=0x80000141</span><br><span class="line"><span class="comment">#define OBD_FAIL_MDS_READLINK_EPROTO     0x143</span></span><br><span class="line">touch <span class="variable">$DIR</span>/<span class="variable">$tdir</span>/<span class="variable">$tfile</span> || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">$ lctl set_param fail_loc=0x80000143</span><br><span class="line">ls -l /lfs/<span class="variable">$foo</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;no error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define OBD_FAIL_OSD_LMA_INCOMPAT 0x194</span></span><br><span class="line">$ lctl set_param fail_loc=0x194</span><br><span class="line">ls -l <span class="variable">$wdir</span>/<span class="variable">$tfile</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;no error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define OBD_FAIL_LDLM_ENQUEUE_OLD_EXPORT 0x30e</span></span><br><span class="line">touch <span class="variable">$DIR</span>/f74a</span><br><span class="line">lctl set_param fail_loc=0x8000030e</span><br><span class="line">ls <span class="variable">$DIR</span>/f74a</span><br><span class="line">lctl set_param fail_loc=0</span><br><span class="line"></span><br><span class="line"><span class="comment">#define OBD_FAIL_OSC_CHECKSUM_RECEIVE       0x408</span></span><br><span class="line">$ lctl set_param fail_loc=0x80000408</span><br><span class="line">$ dd <span class="keyword">if</span>=<span class="variable">$DIR</span>/<span class="variable">$tfile</span> of=/dev/null bs=1M || error <span class="string">&quot;dd read error: $?&quot;</span></span><br><span class="line">$ lctl set_param fail_loc=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n lod.*.stripesize</span><br><span class="line">1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># 72 bytes is the minimum space required to store striping</span></span><br><span class="line"><span class="comment"># information for a file striped across one OST:</span></span><br><span class="line"><span class="comment"># (sizeof(struct lov_user_md_v3) +</span></span><br><span class="line"><span class="comment">#  sizeof(struct lov_user_ost_data_v1))</span></span><br><span class="line"><span class="comment"># not work in 2.12.6 ?</span></span><br><span class="line">$ lctl set_param -n llite.*.default_easize 72</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0 means Disable O_APPEND striping, verify it works</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ lctl get_param mdd.*.append_stripe_count</span><br><span class="line">mdd.lfs-MDT0000.append_stripe_count=1</span><br><span class="line">$ lctl set_param mdd.*.append_stripe_count=2</span><br><span class="line"></span><br><span class="line">$ lctl get_param mdd.*.append_pool</span><br><span class="line">mdd.lfs-MDT0000.append_pool=</span><br><span class="line">$ lctl set_param mdd.*.append_pool=<span class="string">&#x27;none&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Add pool</span></span><br><span class="line">$ lctl pool_add <span class="variable">$FSNAME</span>.pool1 OST[0-10/2] </span><br><span class="line">$ lctl pool_list <span class="variable">$FSNAME</span></span><br><span class="line">$ lctl setstripe -p <span class="variable">$FSNAME</span>.pool1 /lfs/<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OSTs by default only hold a transient atime that is updated when clients do read requests. Permanent atime is written to the MDT when the file is closed. However, on-disk atime is only updated if it is more than 60 seconds old </span></span><br><span class="line">In Lustre 2.14, it is possible to <span class="built_in">set</span> the OSTs to persistently store atime with each object, <span class="keyword">in</span> order to get more accurate persistent atime updates <span class="keyword">for</span> files that are open <span class="keyword">for</span> a long time via the similarly-named obdfilter.*.atime_diff parameter. </span><br><span class="line">$ lctl get_param -n mdd.*MDT0000*.atime_diff</span><br><span class="line">60</span><br><span class="line"></span><br><span class="line">$ lctl get_param osp.*.prealloc_last_id</span><br><span class="line">osp.lfs-OST0000-osc-MDT0000.prealloc_last_id=121337627</span><br><span class="line">osp.lfs-OST0001-osc-MDT0000.prealloc_last_id=122220489</span><br><span class="line">osp.lfs-OST0002-osc-MDT0000.prealloc_last_id=62659128</span><br><span class="line"></span><br><span class="line">$ lctl get_param osp.*.prealloc_next_id</span><br><span class="line">osp.lfs-OST0000-osc-MDT0000.prealloc_next_id=121337612</span><br><span class="line">osp.lfs-OST0001-osc-MDT0000.prealloc_next_id=122220456</span><br><span class="line">osp.lfs-OST0002-osc-MDT0000.prealloc_next_id=62659083</span><br><span class="line"></span><br><span class="line"><span class="comment"># With Lustre software version 2.8, a new tunable is available to allow users with a specific group ID to create and delete remote and striped directories. This tunable is enable_remote_dir_gid. For example, setting this parameter to the &#x27;wheel&#x27; or &#x27;admin&#x27; group ID allows users with that GID to create and delete remote and striped directories. Setting this parameter to -1 on MDT0000 to permanently allow any non-root users create and delete remote and striped directories. On the MGS execute the following command: </span></span><br><span class="line">$ lctl get_param mdt.*.enable_remote_dir_gid</span><br><span class="line">mdt.fsname-MDT0000.enable_remote_dir_gid=0</span><br><span class="line">$ lctl get_param mdt.*.enable_remote_dir_gid=-1</span><br><span class="line"></span><br><span class="line"><span class="comment">##defualt </span></span><br><span class="line">$ lctl get_param mdt.*.enable_remote_dir_gid</span><br><span class="line">mdt.lfs-MDT0000.enable_remote_dir_gid=0</span><br><span class="line"></span><br><span class="line">$ lctl lfsck_start -M $(facet_svc mds1) -A -C -t namespace</span><br><span class="line">$ lctl lfsck_start --device $(facet_svc mds1) -A -C -t namespace</span><br><span class="line">$ lctl get_param mdd.*.lfsck_namespace<span class="string">&quot;</span></span><br><span class="line"><span class="string">mdd.lfs-MDT0000.lfsck_namespace=</span></span><br><span class="line"><span class="string">name: lfsck_namespace</span></span><br><span class="line"><span class="string">magic: 0xa06249ff</span></span><br><span class="line"><span class="string">version: 2</span></span><br><span class="line"><span class="string">status: init</span></span><br><span class="line"><span class="string">flags:</span></span><br><span class="line"><span class="string">param:</span></span><br><span class="line"><span class="string">last_completed_time: N/A</span></span><br><span class="line"><span class="string">time_since_last_completed: N/A</span></span><br><span class="line"><span class="string">latest_start_time: N/A</span></span><br><span class="line"><span class="string">time_since_latest_start: N/A</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param  lo[vd].*-mdtlov.qos_prio_free</span></span><br><span class="line"><span class="string">lod.fsname-MDT0000-mdtlov.qos_prio_free=91%</span></span><br><span class="line"><span class="string">lov.fsname-MDT0000-mdtlov.qos_prio_free=91%</span></span><br><span class="line"><span class="string">#This setting controls how much Lustre prioritizes free space (versus location) in allocation. The higher this number, the more Lustre takes empty space on an OST into consideration for its allocation. When set to 100%, Lustre uses ONLY empty space as the deciding factor for writes. Remember, this setting is only taken into consideration when Lustre believes the OSTs to be imbalanced If you have set qos_threshold_rr to 100, this setting will have no effect. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param *.*MDT0000-mdtlov.qos_threshold_rr</span></span><br><span class="line"><span class="string">lod.fsname-MDT0000-mdtlov.qos_threshold_rr=17% ## set 100 means forces Lustre to round-robin because it believes the OSTs are balanced</span></span><br><span class="line"><span class="string">lov.fsname-MDT0000-mdtlov.qos_threshold_rr=17%</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## open files</span></span><br><span class="line"><span class="string">$ cat /proc/fs/lustre/mdt/*/exports/*/open_files</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h3><h4 id="format"><a href="#format" class="headerlink" title="format"></a>format</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### in the over loading storage, increase the value</span></span><br><span class="line">$ lctl get_param -n ost.*.ost_io.timeouts</span><br><span class="line"></span><br><span class="line"><span class="comment">## grant info</span></span><br><span class="line">$ lctl get_param ldlm.namespaces.testfs-MDT0000*.pool.*</span><br><span class="line"></span><br><span class="line">$ lctl get_param obdfilter.*.filesfree</span><br><span class="line">obdfilter.fsname-OST0000.filesfree=4183295296</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n osd-*.*OST0000.kbytesfree</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.namespaces.*.max_nolock_bytes</span><br><span class="line">ldlm.namespaces.MGC10.53.18.238@tcp.max_nolock_bytes=0</span><br><span class="line">ldlm.namespaces.filter-fsname-OST0000_UUID.max_nolock_bytes=0</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-lwp-OST0000.max_nolock_bytes=0</span><br><span class="line">$ lctl get_param ldlm.namespaces.*.contention_seconds</span><br><span class="line">ldlm.namespaces.MGC10.53.18.238@tcp.contention_seconds=2</span><br><span class="line">ldlm.namespaces.filter-fsname-OST0000_UUID.contention_seconds=2</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-lwp-OST0000.contention_seconds=2</span><br><span class="line">$ lctl get_param ldlm.namespaces.*.contended_locks</span><br><span class="line">ldlm.namespaces.MGC10.53.18.238@tcp.contended_locks=32</span><br><span class="line">ldlm.namespaces.filter-fsname-OST0000_UUID.contended_locks=32</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-lwp-OST0000.contended_locks=32</span><br><span class="line"><span class="comment">##contended_locks- If the number of lock conflicts in the scan of granted and waiting queues at contended_locks is exceeded, the resource is considered to be contended.</span></span><br><span class="line"><span class="comment">##contention_seconds- The resource keeps itself in a contended state as set in the parameter.</span></span><br><span class="line"><span class="comment">##max_nolock_bytes- Server-side locking set only for requests less than the blocks set in the max_nolock_bytes parameter. If this tunable is set to zero (0), it disables server-side locking for read/write requests.</span></span><br><span class="line">$ lctl set_param -n ldlm.namespaces.*.max_nolock_bytes=2000000</span><br><span class="line">$ lctl set_param -n ldlm.namespaces.*.max_nolock_bytes=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.lock_reclaim_threshold_mb</span><br><span class="line">ldlm.lock_reclaim_threshold_mb=736</span><br><span class="line"></span><br><span class="line">$ lctl get_param obdfilter.*.stats obdfilter.*OST*.kbytesfree ldlm.namespaces.filter-*.pool.granted</span><br><span class="line">obdfilter.fsname-OST0000.stats=</span><br><span class="line">snapshot_time             1619839622.706200894 secs.nsecs</span><br><span class="line">read_bytes                130 samples [bytes] 4096 1048576 109461504</span><br><span class="line">write_bytes               115 samples [bytes] 444 1048576 105471940</span><br><span class="line">setattr                   10 samples [reqs]</span><br><span class="line">punch                     4 samples [reqs]</span><br><span class="line">sync                      4 samples [reqs]</span><br><span class="line">destroy                   9 samples [reqs]</span><br><span class="line">create                    3 samples [reqs]</span><br><span class="line">statfs                    27512 samples [reqs]</span><br><span class="line">get_info                  5 samples [reqs]</span><br><span class="line"></span><br><span class="line">$ lctl set_param obdfilter.*.stats=clear</span><br><span class="line"></span><br><span class="line">$ lctl get_param obdfilter.*OST*.exports.*@*.stats</span><br><span class="line"></span><br><span class="line">$ lctl get_param obdfilter.*.exports.*.stats</span><br><span class="line">obdfilter.fsname-OST0000.exports.10.53.18.238@tcp.stats=</span><br><span class="line">snapshot_time             1619839674.573369178 secs.nsecs</span><br><span class="line">setattr                   1 samples [reqs]</span><br><span class="line">destroy                   9 samples [reqs]</span><br><span class="line">create                    3 samples [reqs]</span><br><span class="line">statfs                    27498 samples [reqs]</span><br><span class="line">get_info                  1 samples [reqs]</span><br><span class="line">obdfilter.fsname-OST0000.exports.192.168.0.233@tcp.stats=</span><br><span class="line">snapshot_time             1619839674.573451068 secs.nsecs</span><br><span class="line">read_bytes                130 samples [bytes] 4096 1048576 109461504</span><br><span class="line">write_bytes               115 samples [bytes] 444 1048576 105471940</span><br><span class="line">setattr                   9 samples [reqs]</span><br><span class="line">punch                     4 samples [reqs]</span><br><span class="line">sync                      4 samples [reqs]</span><br><span class="line">statfs                    25 samples [reqs]</span><br><span class="line">get_info                  4 samples [reqs]</span><br><span class="line"></span><br><span class="line">$ lctl set_param obdfilter.*.exports.*.stats=clear</span><br><span class="line"></span><br><span class="line">$ lctl get_param ost.OSS.ost.stats</span><br><span class="line">ost.OSS.ost.stats=</span><br><span class="line">snapshot_time             1619837407.840675602 secs.nsecs</span><br><span class="line">req_waittime              1786 samples [usec] 18 309 235121 35937999</span><br><span class="line">req_qdepth                1786 samples [reqs] 0 0 0 0</span><br><span class="line">req_active                1786 samples [reqs] 1 2 1788 1792</span><br><span class="line">req_timeout               1786 samples [sec] 50 50 89300 4465000</span><br><span class="line">reqbuf_avail              5344 samples [bufs] 61 64 338434 21434154</span><br><span class="line">ldlm_glimpse_enqueue      5 samples [reqs] 1 1 5 5</span><br><span class="line">ldlm_extent_enqueue       3 samples [reqs] 1 1 3 3</span><br><span class="line">ost_create                2 samples [usec] 49 528 577 281185</span><br><span class="line">ost_get_info              1 samples [usec] 1498 1498 1498 2244004</span><br><span class="line">ost_connect               3 samples [usec] 669 1574 3159 3764093</span><br><span class="line">ost_disconnect            1 samples [usec] 305 305 305 93025</span><br><span class="line">obd_ping                  1771 samples [usec] 12 126 78662 3931506</span><br><span class="line"></span><br><span class="line">$ lctl get_param ost.OSS.ost_create.stats</span><br><span class="line">ost.OSS.ost_create.stats=</span><br><span class="line">snapshot_time             1619837439.899464538 secs.nsecs</span><br><span class="line">req_waittime              27072 samples [usec] 23 523 3523516 532341790</span><br><span class="line">req_qdepth                27072 samples [reqs] 0 0 0 0</span><br><span class="line">req_active                27072 samples [reqs] 1 1 27072 27072</span><br><span class="line">req_timeout               27072 samples [sec] 50 50 1353600 67680000</span><br><span class="line">reqbuf_avail              54351 samples [bufs] 63 64 3424493 215767379</span><br><span class="line">ost_statfs                27072 samples [usec] 21 252 1600400 103030806</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.services.ldlm_canceld.stats</span><br><span class="line">ldlm.services.ldlm_canceld.stats=</span><br><span class="line">snapshot_time             1619837467.579931100 secs.nsecs</span><br><span class="line">req_waittime              3 samples [usec] 100 171 423 62345</span><br><span class="line">req_qdepth                3 samples [reqs] 0 0 0 0</span><br><span class="line">req_active                3 samples [reqs] 1 1 3 3</span><br><span class="line">req_timeout               3 samples [sec] 50 50 150 7500</span><br><span class="line">reqbuf_avail              9 samples [bufs] 64 64 576 36864</span><br><span class="line">ldlm_cancel               3 samples [usec] 49 121 248 23126</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.services.ldlm_canceld.stats</span><br><span class="line">ldlm.services.ldlm_canceld.stats=</span><br><span class="line">snapshot_time             1619837467.579931100 secs.nsecs</span><br><span class="line">req_waittime              3 samples [usec] 100 171 423 62345</span><br><span class="line">req_qdepth                3 samples [reqs] 0 0 0 0</span><br><span class="line">req_active                3 samples [reqs] 1 1 3 3</span><br><span class="line">req_timeout               3 samples [sec] 50 50 150 7500</span><br><span class="line">reqbuf_avail              9 samples [bufs] 64 64 576 36864</span><br><span class="line">ldlm_cancel               3 samples [usec] 49 121 248 23126</span><br><span class="line">$ lctl get_param ldlm.services.ldlm_cbd.stats</span><br><span class="line">ldlm.services.ldlm_cbd.stats=</span><br><span class="line">snapshot_time             1619837479.839607820 secs.nsecs</span><br><span class="line"></span><br><span class="line">$ </span><br><span class="line"><span class="comment"># mdt</span></span><br><span class="line">FSNAME=lfs</span><br><span class="line">MDS1NID=1.1.1.1@tcp</span><br><span class="line">MDS2NID=2.2.2.2@tcp</span><br><span class="line"></span><br><span class="line">mkfs.lfs --mgs --backfstype=zfs --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;MDS1NID&#125;</span> --servicenode=<span class="variable">$&#123;MDS2NID&#125;</span> mdt_0/mgt_0</span><br><span class="line">mkfs.lfs --mdt --mgsnode=<span class="variable">$&#123;MDS1NID&#125;</span> --mgsnode=<span class="variable">$&#123;MDS2NID&#125;</span> --backfstype=zfs --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;MDS1NID&#125;</span> --servicenode=<span class="variable">$&#123;MDS2NID&#125;</span> --index=0 mdt_0/mdt_0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ost</span></span><br><span class="line">FSNAME=lfs</span><br><span class="line">MDS1NID=1.1.1.1@tcp</span><br><span class="line">MDS2NID=2.2.2.2@tcp</span><br><span class="line">OSS1NID=3.3.3.3@tcp </span><br><span class="line">OSS2NID=4.4.4.4@tcp </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..6&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> mkfs.lfs --reformat --backfstype=zfs --ost  --index=<span class="variable">$i</span>  --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;OSS1NID&#125;</span> --servicenode=<span class="variable">$&#123;OSS2NID&#125;</span> --mgsnode=<span class="variable">$&#123;MDS1NID&#125;</span> --mgsnode=<span class="variable">$&#123;MDS2NID&#125;</span>  ost_<span class="variable">$i</span>/ost_<span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="change-ipaddr"><a href="#change-ipaddr" class="headerlink" title="change ipaddr"></a>change ipaddr</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tunefs.lfs --erase-params --mgsnode=<span class="variable">$new_mgs_ip</span>@tcp --servicenode=<span class="variable">$new_service_ip</span>@tcp0 --writeconf /dev/md4</span><br></pre></td></tr></table></figure><h4 id="Enable-large-dir-feature"><a href="#Enable-large-dir-feature" class="headerlink" title="Enable large_dir feature"></a>Enable large_dir feature</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tune2fs -O large_dir /dev/nvme0n1p1</span><br><span class="line">$ dumpe2fs -h /dev/nvme0n1p1 | grep feat</span><br><span class="line">$ dumpe2fs 1.45.2.wc1 (27-May-2019)</span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery mmp flex_bg ea_inode dirdata large_dir sparse_super large_file huge_file uninit_bg dir_nlink quota</span><br><span class="line">Journal features:         journal_incompat_revoke</span><br></pre></td></tr></table></figure><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><h4 id="set-stripe-size-for-tiny-files"><a href="#set-stripe-size-for-tiny-files" class="headerlink" title="set stripe size for tiny files"></a>set stripe size for tiny files</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## deactivate imperative recovery</span></span><br><span class="line">$ lctl set_param mgs.MGS.live.testfs=<span class="string">&quot;state=disabled&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## activate imperative recovery</span></span><br><span class="line">$ lctl set_param mgs.MGS.live.testfs=<span class="string">&quot;state=full&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## disable xattr cache</span></span><br><span class="line">$ lctl set_param llite.*.xattr_cache=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param  llite.*.fast_read</span><br><span class="line">llite.fsname-ffff8dab2cce8800.fast_read=1</span><br><span class="line"></span><br><span class="line"><span class="comment">## stripe info</span></span><br><span class="line">$ lctl get_param  lov.fsname-clilov-\*.stripe*</span><br><span class="line">lov.fsname-clilov-ffff8dab2cce8800.stripecount=1</span><br><span class="line">lov.fsname-clilov-ffff8dab2cce8800.stripeoffset=-1</span><br><span class="line">lov.fsname-clilov-ffff8dab2cce8800.stripesize=1048576</span><br><span class="line">lov.fsname-clilov-ffff8dab2cce8800.stripetype=1</span><br><span class="line"></span><br><span class="line">$ lctl get_param llite.*.xattr_cache</span><br><span class="line">llite.fsname-ffff8dab2cce8800.xattr_cache=1</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n mdc.*MDT0000*.blocksize</span><br><span class="line">4096</span><br><span class="line">$ lctl get_param mdc.*MDT0000*.active</span><br><span class="line">mdc.fsname-MDT0000-mdc-ffff8dab2cce8800.active=1</span><br><span class="line">$ lctl get_param mdc.*MDT0000*.state</span><br><span class="line">$ lctl get_param mdc.*MDT0000*.stats | grep -Ei <span class="string">&#x27;ost_read|ldlm_glimpse&#x27;</span></span><br><span class="line">$ lctl get_param mdc.*MDT0000*.timeouts</span><br><span class="line">mdc.fsname-MDT0000-mdc-ffff8dab2cce8800.timeouts=</span><br><span class="line">last reply : 1619838998, 0s ago</span><br><span class="line">network    : cur  50  worst  50 (at 1619704491, 134507s ago)   1   1   1   1</span><br><span class="line">portal 12  : cur  50  worst  50 (at 1619704491, 134507s ago)  50  50  50  50</span><br><span class="line">portal 17  : cur  50  worst  50 (at 1619708441, 130557s ago)  50  50   0  50</span><br><span class="line">portal 23  : cur  50  worst  50 (at 1619769781, 69217s ago)  50  50  50   0</span><br><span class="line">portal 30  : cur  50  worst  50 (at 1619769796, 69202s ago)  50   0   0   0</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.*OST0000*.state</span><br><span class="line">$ lctl get_param osc.*OST0000*.stats</span><br><span class="line">$ lctl get_param osc.*OST0000*.timeouts</span><br><span class="line">osc.fsname-OST0000-osc-ffff8dab2cce8800.timeouts=</span><br><span class="line">last reply : 1619838981, 36s ago</span><br><span class="line">network    : cur  50  worst  50 (at 1619704492, 134525s ago)   1   1   1   1</span><br><span class="line">portal 28  : cur  50  worst  50 (at 1619704491, 134526s ago)  50  50  50  50</span><br><span class="line">portal 7   : cur  50  worst  50 (at 1619704492, 134525s ago)  50  50   0   0</span><br><span class="line">portal 6   : cur  50  worst  50 (at 1619769796, 69221s ago)  50   0   0  50</span><br><span class="line">portal 17  : cur  50  worst  50 (at 1619770886, 68131s ago)  50   0   0   0</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.*OST0000*.unstable_stats</span><br><span class="line">osc.fsname-OST0000-osc-ffff8dab2cce8800.unstable_stats=</span><br><span class="line">unstable_pages:                    0</span><br><span class="line">unstable_mb:                       0</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.*OST0000*.blocksize</span><br><span class="line">1048576</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Client-Based I/O Extent Size Survey</span></span><br><span class="line">$ lctl get_param llite.fsname-*.extents_stats</span><br><span class="line">llite.fsname-ffff8dab2cce8800.extents_stats=</span><br><span class="line">disabled</span><br><span class="line"> write anything to this file to activate, <span class="keyword">then</span> <span class="string">&#x27;0&#x27;</span> or <span class="string">&#x27;disable&#x27;</span> to deactivate</span><br><span class="line"></span><br><span class="line"><span class="comment">##The file can be cleared and enabled by issuing the following command:</span></span><br><span class="line">$ lctl set_param llite.testfs-*.extents_stats=1</span><br><span class="line">llite.fsname-ffff8dab2cce8800.extents_stats=1</span><br><span class="line">$ lctl get_param llite.fsname-*.extents_stats</span><br><span class="line">llite.fsname-ffff8dab2cce8800.extents_stats=</span><br><span class="line">snapshot_time:         1619838099.035887547 (secs.nsecs)</span><br><span class="line">                               <span class="built_in">read</span>       |                write</span><br><span class="line">      extents            calls    % cum%  |          calls    % cum%</span><br><span class="line">   0K -    4K :              0    0    0  |              0    0    0</span><br><span class="line">$ lctl get_param llite.fsname-*.extents_stats</span><br><span class="line">llite.fsname-ffff8dab2cce8800.extents_stats=</span><br><span class="line">snapshot_time:         1619838110.284058497 (secs.nsecs)</span><br><span class="line">                               <span class="built_in">read</span>       |                write</span><br><span class="line">      extents            calls    % cum%  |          calls    % cum%</span><br><span class="line">   0K -    4K :              0    0    0  |              0    0    0</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/urandom of=test_5 bs=4k count=100</span><br><span class="line">100+0 records <span class="keyword">in</span></span><br><span class="line">100+0 records out</span><br><span class="line">409600 bytes (410 kB) copied, 0.0048456 s, 84.5 MB/s</span><br><span class="line"></span><br><span class="line">$ ls -l test_5</span><br><span class="line">-rw-r--r-- 1 root root 409600 May  1 11:02 test_5</span><br><span class="line">$ lctl get_param llite.fsname-*.extents_stats</span><br><span class="line">llite.fsname-ffff8dab2cce8800.extents_stats=</span><br><span class="line">snapshot_time:         1619838165.554498620 (secs.nsecs)</span><br><span class="line">                               <span class="built_in">read</span>       |                write</span><br><span class="line">      extents            calls    % cum%  |          calls    % cum%</span><br><span class="line">   0K -    4K :              0    0    0  |              0    0    0</span><br><span class="line">   4K -    8K :              0    0    0  |            100  100  100</span><br><span class="line">$ dd <span class="keyword">if</span>=test_5 of=test_6 bs=16k count=25</span><br><span class="line">25+0 records <span class="keyword">in</span></span><br><span class="line">25+0 records out</span><br><span class="line">409600 bytes (410 kB) copied, 0.00201437 s, 203 MB/s</span><br><span class="line">$ lctl get_param llite.fsname-*.extents_stats</span><br><span class="line">llite.fsname-ffff8dab2cce8800.extents_stats=</span><br><span class="line">snapshot_time:         1619838225.522203239 (secs.nsecs)</span><br><span class="line">                               <span class="built_in">read</span>       |                write</span><br><span class="line">      extents            calls    % cum%  |          calls    % cum%</span><br><span class="line">   0K -    4K :              0    0    0  |              0    0    0</span><br><span class="line">   4K -    8K :              0    0    0  |            100   80   80</span><br><span class="line">   8K -   16K :              0    0    0  |              0    0   80</span><br><span class="line">  16K -   32K :              0    0    0  |             25   20  100</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=test_5 of=test_7 bs=16k count=25 iflag=direct</span><br><span class="line">25+0 records <span class="keyword">in</span></span><br><span class="line">25+0 records out</span><br><span class="line">409600 bytes (410 kB) copied, 0.010213 s, 40.1 MB/s</span><br><span class="line"></span><br><span class="line">$ lctl get_param llite.fsname-*.extents_stats</span><br><span class="line">llite.fsname-ffff8dab2cce8800.extents_stats=</span><br><span class="line">snapshot_time:         1619838404.667431860 (secs.nsecs)</span><br><span class="line">                               <span class="built_in">read</span>       |                write</span><br><span class="line">      extents            calls    % cum%  |          calls    % cum%</span><br><span class="line">   0K -    4K :              0    0    0  |              0    0    0</span><br><span class="line">   4K -    8K :              0    0    0  |            100   66   66</span><br><span class="line">   8K -   16K :              0    0    0  |              0    0   66</span><br><span class="line">  16K -   32K :             25  100  100  |             50   33  100</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.*0000-osc-*.stats</span><br><span class="line">osc.fsname-OST0000-osc-ffff8dab2cce8800.stats=</span><br><span class="line">snapshot_time             1619795318.676450713 secs.nsecs</span><br><span class="line">req_waittime              1321 samples [usec] 282 81340 2770704 62526834430</span><br><span class="line">req_active                1321 samples [reqs] 1 27 2605 27949</span><br><span class="line">read_bytes                10 samples [bytes] 1048576 1048576 10485760 10995116277760</span><br><span class="line">write_bytes               85 samples [bytes] 32768 1048576 87162880 91210072981504</span><br><span class="line">ost_read                  10 samples [usec] 5584 15595 111076 1326778432</span><br><span class="line">ost_write                 85 samples [usec] 3899 81340 1826891 60616504085</span><br><span class="line">ost_connect               1 samples [usec] 2156 2156 2156 4648336</span><br><span class="line">ost_statfs                16 samples [usec] 282 753 8835 5208451</span><br><span class="line">ldlm_cancel               3 samples [usec] 547 1141 2390 2093894</span><br><span class="line">obd_ping                  1198 samples [usec] 319 1351 815234 569338326</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n llite.*.client_type</span><br><span class="line"><span class="built_in">local</span> client</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.fsname-OST0000-osc*.resend_count</span><br><span class="line">osc.fsname-OST0000-osc-ffff8dab2cce8800.resend_count=10</span><br><span class="line"></span><br><span class="line"><span class="comment">#show it in the lnetctl</span></span><br><span class="line">$  lnetctl stats show</span><br><span class="line">statistics:</span><br><span class="line">...</span><br><span class="line">    resend_count: 0</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.<span class="variable">$FSNAME</span>*.checksums</span><br><span class="line"></span><br><span class="line"><span class="comment"># cancel_lru_locks</span></span><br><span class="line">$ lctl set_param -n ldlm.namespaces.*osc*.lru_size=clear</span><br><span class="line">$ lctl set_param -n ldlm.namespaces.*mdc*.lru_size=clear</span><br><span class="line">$ lctl get_param ldlm.namespaces.*.lock_unused_count</span><br><span class="line">ldlm.namespaces.MGC192.168.0.1@tcp.lock_unused_count=0</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-mdc-ffffa05245a8c800.lock_unused_count=488</span><br><span class="line">ldlm.namespaces.fsname-OST0000-osc-ffffa05245a8c800.lock_unused_count=1</span><br><span class="line">ldlm.namespaces.fsname-OST0001-osc-ffffa05245a8c800.lock_unused_count=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param ldlm.namespaces.*mdc-*.lru_size</span><br><span class="line">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.lru_size=1</span><br><span class="line">$ lctl get_param ldlm.namespaces.*osc-*.lru_size</span><br><span class="line">ldlm.namespaces.fsname-OST0000-osc-ffff8dab2cce8800.lru_size=0</span><br><span class="line"></span><br><span class="line">$ lctl get_param mdc.*.import </span><br><span class="line">$ lctl get_param mdc.*.import | grep <span class="string">&quot;state: FULL&quot;</span></span><br><span class="line">$ lctl get_param mdc.*.import | grep <span class="string">&quot;connect_flags&quot;</span>  </span><br><span class="line">or </span><br><span class="line">$ lctl get_param  mdc.*.connect_flags | grep early_lock_cancel</span><br><span class="line"></span><br><span class="line">$ lctl get_param -n llite.*.sbi_flags</span><br><span class="line">checksum            acl       lru_resize lazy_statfs 64bit_hash agl verbose layout xattr_cache fast_read file_secctx</span><br><span class="line">checksum user_xattr acl flock lru_resize lazy_statfs 64bit_hash agl verbose layout xattr_cache fast_read file_secctx</span><br><span class="line"></span><br><span class="line">$ lfs setstripe -S 65536 /lfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Flush all of the metadata client (mdc) locks on this node</span></span><br><span class="line">$ lctl set_param ldlm.namespaces.*mdc*.lru_size=clear</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.*.grant_shrink_interval</span><br><span class="line">osc.lfs-OST0000-osc-ffff8dab37559000.grant_shrink_interval=1200</span><br><span class="line">osc.lfs-OST0001-osc-ffff8dab37559000.grant_shrink_interval=1200</span><br><span class="line">osc.lfs-OST0002-osc-ffff8dab37559000.grant_shrink_interval=1200</span><br><span class="line"></span><br><span class="line"><span class="comment"># This example reports the amount of space this client has reserved for writeback cache with each OST</span></span><br><span class="line">$ lctl get_param osc.*.cur_grant_bytes</span><br><span class="line">osc.fsname-OST0000-osc-ffff8dab2cce8800.cur_grant_bytes=3407872</span><br><span class="line"></span><br><span class="line"><span class="comment">### calculator the max_cur_granted</span></span><br><span class="line">undirty 34209792 + grant_chunk 3407872 = max_cur_granted 37617664</span><br><span class="line"></span><br><span class="line"><span class="comment">#### grant_chunk</span></span><br><span class="line">$  lctl get_param osc.*.import  | grep -Ei <span class="string">&#x27;max_brw_size|grant_extent_tax&#x27;</span></span><br><span class="line">       max_brw_size: 1048576</span><br><span class="line">       grant_extent_tax: 655360</span><br><span class="line">grant_chunk = $(((<span class="number">1048576</span>+<span class="number">655360</span>)*<span class="number">2</span>)) = 3407872 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment">#### undirty</span></span><br><span class="line">nrpages:256 rpc_in_flight:8</span><br><span class="line">rpc_in_flight++</span><br><span class="line">nrpegs 256 x  rpc_in_flight 9 = nrpages 2304</span><br><span class="line">max_dirty_mb:32 MB</span><br><span class="line">MB to pages = dirty_max_pages: 8192</span><br><span class="line"><span class="keyword">if</span> dirty_max_pages 8192 &gt; nrpages 2304; nrpages = dirty_max_pages:8192</span><br><span class="line">nrpages 8192 x 4096 = undirty 33554432 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lctl grant_max_extent_size 1073741824</span><br><span class="line">lctl grant_max_extent_size = max_extent_size/4096 to pages:262144</span><br><span class="line">(nrpages 8192 + max_extent_pages 262144 -1) / max_extent_pages 262144 = nrextents = 1</span><br><span class="line">grant_extent_tax: 655360</span><br><span class="line">undirty 34209792 bytes = undirty bytes: 33554432 + nrextents 1 * grant_extent_tax (bytes):655360</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client $ lctl get_param osc.*.grant_shrink</span><br><span class="line">client $ lctl set_param osc.*.grant_shrink=0</span><br><span class="line"><span class="comment"># replace</span></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;k:osc_should_shrink_grant &#123; override(0); &#125;&#x27;</span> --unsafe</span><br><span class="line"></span><br><span class="line"><span class="comment">### clear cache info </span></span><br><span class="line">$ lctl set_param osc.*-osc*.rpc_stats 0 </span><br><span class="line">$ lctl set_param llite.*.read_ahead_stats 0</span><br><span class="line">$ lctl set_param -n llite.*.max_cached_mb 128 <span class="comment">## 128MB</span></span><br><span class="line"><span class="comment">## randomly read 1000 of 32K chunks from file large than 1G size</span></span><br><span class="line">find /fsname -<span class="built_in">type</span> f -size +1G | head -n 128 | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> dd <span class="keyword">if</span>=<span class="variable">$line</span> of=/dev/null bs=128K count=1000 skip=$(shuf -i 2000-65000 -n 1) &amp; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## check status</span></span><br><span class="line">$ lctl get_param osc.*-osc*.rpc_stats</span><br><span class="line"></span><br><span class="line">$ lctl get_param llite.*.max_cached_mb</span><br><span class="line">llite.fsname-ffff8dab2cce8800.max_cached_mb=</span><br><span class="line">users: 16</span><br><span class="line">max_cached_mb: 128  <span class="comment">##128MB=32768 pages</span></span><br><span class="line">used_mb: 128</span><br><span class="line">unused_mb: 0</span><br><span class="line">reclaim_count: 36</span><br><span class="line"></span><br><span class="line"><span class="comment">## 128M</span></span><br><span class="line">$ lctl get_param llite.*.read_ahead_stats</span><br><span class="line">llite.fsname-ffff8dab2cce8800.read_ahead_stats=</span><br><span class="line">snapshot_time             1619771017.155433340 secs.nsecs</span><br><span class="line">llite.fsname-ffff8d9b21dd4000.read_ahead_stats=</span><br><span class="line">snapshot_time             1619771017.155499531 secs.nsecs</span><br><span class="line">hits                      2464263 samples [pages]</span><br><span class="line">misses                    6306 samples [pages] <span class="comment">## misses means misses too much for small reads</span></span><br><span class="line">readpage not consecutive  82 samples [pages]</span><br><span class="line">miss inside window        652 samples [pages]</span><br><span class="line">failed grab_cache_page    185 samples [pages]</span><br><span class="line"><span class="built_in">read</span> but discarded        335911 samples [pages] <span class="comment">## not enough space</span></span><br><span class="line">zero size window          139998 samples [pages]</span><br><span class="line">read-ahead to EOF         1 samples [pages]</span><br><span class="line">hit max r-a issue         59302 samples [pages]</span><br><span class="line">failed to reach end       66123 samples [pages]</span><br><span class="line"></span><br><span class="line">$ size=1; lctl get_param -n osc.*.rpc_stats | awk <span class="string">&#x27;($1 == &quot;&#x27;</span><span class="variable">$size</span><span class="string">&#x27;:&quot; &amp;&amp; $2!=0) &#123;print $2;&#125;&#x27;</span></span><br><span class="line">$ size=2; lctl get_param -n osc.*.rpc_stats | awk <span class="string">&#x27;($1 == &quot;&#x27;</span><span class="variable">$size</span><span class="string">&#x27;:&quot; &amp;&amp; $2!=0) &#123;print $2;&#125;&#x27;</span></span><br><span class="line">$ size=4; lctl get_param -n osc.*.rpc_stats | awk <span class="string">&#x27;($1 == &quot;&#x27;</span><span class="variable">$size</span><span class="string">&#x27;:&quot; &amp;&amp; $2!=0) &#123;print $2;&#125;&#x27;</span></span><br><span class="line">$ size=8; lctl get_param -n osc.*.rpc_stats | awk <span class="string">&#x27;($1 == &quot;&#x27;</span><span class="variable">$size</span><span class="string">&#x27;:&quot; &amp;&amp; $2!=0) &#123;print $2;&#125;&#x27;</span></span><br><span class="line">$ size=16; lctl get_param -n osc.*.rpc_stats | awk <span class="string">&#x27;($1 == &quot;&#x27;</span><span class="variable">$size</span><span class="string">&#x27;:&quot; &amp;&amp; $2!=0) &#123;print $2;&#125;&#x27;</span></span><br><span class="line">36 </span><br><span class="line"><span class="keyword">if</span> size 4 * PAGE_SIZE 4096 = 32768 &lt; rsize 131072(means dd bs=128k); means Small 16384 <span class="built_in">read</span> IO 36</span><br><span class="line"></span><br><span class="line"><span class="comment">## for example, just print first line </span></span><br><span class="line">$ size=1; lctl get_param -n osc.*.rpc_stats | awk <span class="string">&#x27;($1 == &quot;&#x27;</span><span class="variable">$size</span><span class="string">&#x27;:&quot; &amp;&amp; $2!=0) &#123;print $2; exit&#125;&#x27;</span></span><br><span class="line">209</span><br><span class="line">the size=1 * PAGE_SIZE 4096 = 4096 &lt; rsize 131072 (means dd bs=128k); means Small 4096 <span class="built_in">read</span> IO 209</span><br><span class="line">$ size=8; lctl get_param -n osc.*.rpc_stats | awk <span class="string">&#x27;($1 == &quot;&#x27;</span><span class="variable">$size</span><span class="string">&#x27;:&quot; &amp;&amp; $2!=0) &#123;print $2; exit&#125;&#x27;</span></span><br><span class="line">14</span><br><span class="line">the size=8 * PAGE_SIZE 4096 = 32768 &lt; rsize 131072 (means dd bs=128k); means Small 32768 <span class="built_in">read</span> IO 14</span><br><span class="line"></span><br><span class="line">$ $ lctl set_param osc.*-osc*.rpc_stats 0</span><br><span class="line">$ lctl set_param llite.*.read_ahead_stats 0</span><br><span class="line">$ lctl set_param -n llite.*.max_cached_mb 64 <span class="comment">#default 64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## read, read_ahead cache</span></span><br><span class="line"><span class="comment">#disable the client read ahead </span></span><br><span class="line">$ lctl set_param llite.*.max_read_ahead_mb=0</span><br><span class="line"></span><br><span class="line"><span class="comment">#limit ldlm threads, ldlm threads will exhaust all CPUs resources like LU-7330</span></span><br><span class="line">options ptlrpc ldlm_num_threads=16</span><br><span class="line"></span><br><span class="line"><span class="comment">## In lfs script, the check stripe_size aligned read-ahead is very simple</span></span><br><span class="line"><span class="built_in">disable</span> readahead and <span class="built_in">set</span> stripe count = 1, compare the <span class="built_in">read</span> performance, <span class="keyword">if</span> not aligned, the result will slow than disabled readahead result.</span><br><span class="line"></span><br><span class="line"><span class="comment">####</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=test_3 bs=1M count=70</span><br><span class="line">$ lctl set_param -n ldlm.namespaces.*osc*.lru_size=clear</span><br><span class="line">$ lctl set_param -n ldlm.namespaces.*mdc*.lru_size=clear</span><br><span class="line">$ lctl set_param -n llite.*.read_ahead_stats 0</span><br><span class="line">$ dd <span class="keyword">if</span>=test_3 of=/dev/null bs=10M skip=6 count=1</span><br><span class="line">$ lctl  get_param -n llite.*.read_ahead_stats | grep <span class="string">&#x27;misses&#x27;</span></span><br><span class="line">misses                    1 samples [pages]</span><br><span class="line"><span class="keyword">if</span> misses = 1 , it <span class="string">&#x27;s ok, else the misses value is not right</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># setstripe</span></span><br><span class="line"><span class="string">$ lfs setstripe -S 4000M -c 50 /mnt/striped</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Monitor</span></span><br><span class="line"><span class="string">$ lctl get_param  osc.*OST0000*.stats</span></span><br><span class="line"><span class="string">osc.$FSNAME-OST0000-osc-ffff8dab37559000.stats=</span></span><br><span class="line"><span class="string">snapshot_time             1619689024.314392020 secs.nsecs</span></span><br><span class="line"><span class="string">req_waittime              128 samples [usec] 138 2599 61091 35024171</span></span><br><span class="line"><span class="string">req_active                128 samples [reqs] 1 1 128 128</span></span><br><span class="line"><span class="string">ost_connect               1 samples [usec] 2599 2599 2599 6754801</span></span><br><span class="line"><span class="string">ost_statfs                3 samples [usec] 459 512 1433 686269</span></span><br><span class="line"><span class="string">obd_ping                  124 samples [usec] 138 575 57059 27583101</span></span><br><span class="line"><span class="string">$ lctl get_param mdc.lfs*.stats</span></span><br><span class="line"><span class="string">mdc.lfs-MDT0000-mdc-ffff8dab3afe6000.stats=</span></span><br><span class="line"><span class="string">snapshot_time             1619689557.206806185 secs.nsecs</span></span><br><span class="line"><span class="string">req_waittime              112 samples [usec] 71 1525 18376 7048052</span></span><br><span class="line"><span class="string">req_active                112 samples [reqs] 1 1 112 112</span></span><br><span class="line"><span class="string">mds_getattr               1 samples [usec] 86 86 86 7396</span></span><br><span class="line"><span class="string">mds_connect               1 samples [usec] 734 734 734 538756</span></span><br><span class="line"><span class="string">mds_get_root              1 samples [usec] 101 101 101 10201</span></span><br><span class="line"><span class="string">mds_statfs                3 samples [usec] 71 145 293 31995</span></span><br><span class="line"><span class="string">ldlm_cancel               1 samples [usec] 92 92 92 8464</span></span><br><span class="line"><span class="string">obd_ping                  103 samples [usec] 93 1525 16863 6429731</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## All OST available bytes</span></span><br><span class="line"><span class="string">$ lctl get_param lov.zfsz2-clilov-*.kbytesavail</span></span><br><span class="line"><span class="string">lov.zfsz2-clilov-ffff8dab3afe6000.kbytesavail=139702738176</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param lov.zfsz2-clilov-*.kbytestotal</span></span><br><span class="line"><span class="string">lov.zfsz2-clilov-ffff8dab3afe6000.kbytestotal=1038674946560</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param osc.*.rpc_stats</span></span><br><span class="line"><span class="string">snapshot_time:         1619688798.673860765 (secs.nsecs)</span></span><br><span class="line"><span class="string">read RPCs in flight:  0</span></span><br><span class="line"><span class="string">write RPCs in flight: 0</span></span><br><span class="line"><span class="string">pending write pages:  0</span></span><br><span class="line"><span class="string">pending read pages:   0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">readwrite</span></span><br><span class="line"><span class="string">pages per rpc         rpcs   % cum % |       rpcs   % cum %</span></span><br><span class="line"><span class="string">1:         0   0   0   |          0   0   0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">readwrite</span></span><br><span class="line"><span class="string">rpcs in flight        rpcs   % cum % |       rpcs   % cum %</span></span><br><span class="line"><span class="string">0:         0   0   0   |          0   0   0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">readwrite</span></span><br><span class="line"><span class="string">offset                rpcs   % cum % |       rpcs   % cum %</span></span><br><span class="line"><span class="string">0:         0   0   0   |          0   0   0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl lov_getconfig /mnt</span></span><br><span class="line"><span class="string">default_stripe_count: 1</span></span><br><span class="line"><span class="string">default_stripe_size: 1048576</span></span><br><span class="line"><span class="string">default_stripe_offset: 18446744073709551615</span></span><br><span class="line"><span class="string">default_stripe_pattern: 1</span></span><br><span class="line"><span class="string">obd_count: 15</span></span><br><span class="line"><span class="string">OBDS:obdidxobdgen obduuid</span></span><br><span class="line"><span class="string">     0             1 lfs-OST0000_UUID</span></span><br><span class="line"><span class="string">     1             1 lfs-OST0001_UUID</span></span><br><span class="line"><span class="string">     2             1 lfs-OST0002_UUID</span></span><br><span class="line"><span class="string">     3             1 lfs-OST0003_UUID</span></span><br><span class="line"><span class="string">     4             1 lfs-OST0004_UUID</span></span><br><span class="line"><span class="string">     5             1 lfs-OST0005_UUID</span></span><br><span class="line"><span class="string">     6             1 lfs-OST0006_UUID</span></span><br><span class="line"><span class="string">     7             1 lfs-OST0007_UUID</span></span><br><span class="line"><span class="string">     8             1 lfs-OST0008_UUID</span></span><br><span class="line"><span class="string">     9             1 lfs-OST0009_UUID</span></span><br><span class="line"><span class="string">    10             1 lfs-OST000a_UUID</span></span><br><span class="line"><span class="string">    11             1 lfs-OST000b_UUID</span></span><br><span class="line"><span class="string">    12             1 lfs-OST000c_UUID</span></span><br><span class="line"><span class="string">    13             1 lfs-OST000d_UUID</span></span><br><span class="line"><span class="string">    14             1 lfs-OST000e_UUID</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param osc.*OST0000-osc-[^mM]*.cur_grant_bytes</span></span><br><span class="line"><span class="string">osc.fsname-OST0000-osc-ffff8dab37559000.cur_grant_bytes=2097152</span></span><br><span class="line"><span class="string">osc.zfsz2-OST0000-osc-ffff8dab3afe6000.cur_grant_bytes=3407872</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">###$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param -n osc.fsname-OST0000-osc*.import  | grep &quot;target:&quot;</span></span><br><span class="line"><span class="string">    target: fsname-OST0000_UUID</span></span><br><span class="line"><span class="string">obdfilter_name=fsname-OST0000_UUID</span></span><br><span class="line"><span class="string">### ???</span></span><br><span class="line"><span class="string">$ lctl --device $&#123;obdfilter_name&#125;_osc cleanup</span></span><br><span class="line"><span class="string">$ lctl --device $&#123;obdfilter_name&#125;_osc detach</span></span><br><span class="line"><span class="string">$ lctl attach echo_client ec ec_uuid</span></span><br><span class="line"><span class="string">$ lctl --device ec create 1 | awk &#x27;</span>/object id/ &#123;<span class="built_in">print</span> <span class="variable">$6</span>&#125;<span class="string">&#x27; </span></span><br><span class="line"><span class="string">## Get the id</span></span><br><span class="line"><span class="string">$ lctl --device ec getattr $id</span></span><br><span class="line"><span class="string">$ lctl --device ec getattr $id</span></span><br><span class="line"><span class="string">$ lctl --device ec</span></span><br><span class="line"><span class="string">$ lctl --device ec destroy $id 1</span></span><br><span class="line"><span class="string">$ lctl --device ec cleanup</span></span><br><span class="line"><span class="string">$ lctl --device ec detach</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># re-compile the lfs 2.13.0 client, you must import openmpi PATH</span></span><br><span class="line"><span class="string">$ export PATH=/usr/lib64/openmpi/bin/:$PATH</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">or you can delele all openmpi info from lfs.spec, and you could got these rpms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ rpmbuild --rebuild --without servers  lfs-2.10.3-1.src.rpm</span></span><br><span class="line"><span class="string">$ rpmbuild  --rebuild --without servers --with lnet-dlc  lfs-2.10.3-1.src.rpm</span></span><br><span class="line"><span class="string">$ rpmbuild --rebuild --without lfs-tests lfs-2.10.3-1.src.rpm</span></span><br><span class="line"><span class="string">$ rpmbuild --define &#x27;</span>kversion 2.6.32-220.4.1.el6.x86_64<span class="string">&#x27; --define &#x27;</span>kdir /usr/src/kernels/2.6.32-220.4.1.el6.x86_64/<span class="string">&#x27; --rebuild lustre-client-2.1.0-2.6.32_131.6.1.el6.x86_64_g9d71fe8.src.rpm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># centos 7.7</span></span><br><span class="line"><span class="string"># /root/rpmbuild/BUILD/lfs-2.10.8/lnet/klnds/o2iblnd/o2iblnd.h:69:27: fatal error: linux/pci-dma.h: No such file or directory</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># copy the file from the old kernel</span></span><br><span class="line"><span class="string">copy /usr/src/kernels/$&#123;the old version kernel&#125;/include/linux/pci-dma.h /usr/src/kernels/$&#123;the centos 7.7 kernel&#125;/include/linux/pci-dma.h</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># New stupid bug when you compile lfs 2.10.3-1, if you are not export $PATH with openmpi, the compile will failed.</span></span><br><span class="line"><span class="string">If you want it pass, I was clear /tmp/tmp.* rpmbuild not help I guess maybe the old config in some tmpfs path.</span></span><br><span class="line"><span class="string">after you reboot and re-export the env, the compile will be successful.</span></span><br><span class="line"><span class="string">#Is real the realease production ? `too stupid` bug. just waste my time to type these words.</span></span><br><span class="line"><span class="string">There is no test team in lfs develop team, All users was the test team except you are going to buy DDN.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># from source</span></span><br><span class="line"><span class="string">$ ./configure --enable-client --disable-server --with-linux=/usr/src/kernels/$(uname -r) --with-linux-obj=/usr/src/kernels/$(uname -r);make rpms/deps</span></span><br><span class="line"><span class="string">$ ./configure --enable-client --disable-server --with-linux=/usr/src/kernels/linux-5.4.123 --with-linux-obj=/usr/src/kernels/linux-5.4.123;make rpms/deps</span></span><br><span class="line"><span class="string">## install in ubuntu 18.04</span></span><br><span class="line"><span class="string">$ apt install uuid-dev libblkid-dev dietlibc-dev</span></span><br><span class="line"><span class="string">$ apt install build-essential debhelper devscripts fakeroot kernel-wedge libudev-dev pciutils-dev</span></span><br><span class="line"><span class="string">$ apt install module-assistant libreadline-dev dpatch libsnmp-dev quilt</span></span><br><span class="line"><span class="string">$ apt install linux-headers-$(uname -r)</span></span><br><span class="line"><span class="string">$ cd $&#123;BUILDPATH&#125;/lfs-release</span></span><br><span class="line"><span class="string">$ git reset --hard &amp;&amp; git clean -dfx</span></span><br><span class="line"><span class="string">$ sh autogen.sh</span></span><br><span class="line"><span class="string">$ ./configure --disable-server --with-linux=/usr/src/linux-headers-4.15.0-64-generic</span></span><br><span class="line"><span class="string">$ make install</span></span><br><span class="line"><span class="string">$ rm -rf  /lib/modules/4.15.0-64-generic/kernel/drivers/staging/lfs/</span></span><br><span class="line"><span class="string">$ depmod -a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># LU-14116 cause could not support rhel 8.3, you could replace krb5 rpms by rhel 8.2</span></span><br><span class="line"><span class="string">### set lfs client for a lot metadata ops</span></span><br><span class="line"><span class="string">Otherwise, the file attributes will be dropped from the client cache if the file has not been accessed before the LDLM lock timeout. The timeout is stored via lctl get_param ldlm.namespaces.*mdc*.lru_max_age</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#restricting the number of locks kept on the client (10000 locks, 10 minutes age)</span></span><br><span class="line"><span class="string">$ lctl set_param ldlm.namespaces.*.lru_size=10000 ldlm.namespaces.*.lru_max_age=600000</span></span><br><span class="line"><span class="string">$ lctl set_param ldlm.namespaces.*.lru_size=10000 ldlm.namespaces.*.lru_max_age=3900000</span></span><br><span class="line"><span class="string">$ lctl get_param ldlm.namespaces.*.lru_size ldlm.namespaces.*.lru_max_age</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># default</span></span><br><span class="line"><span class="string">MDS$ lctl get_param ldlm.namespaces.*.lru_size</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC192.168.0.1@tcp.lru_size=400</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGS.lru_size=400</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.lru_size=0</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-OST0000-osc-MDT0000.lru_size=0</span></span><br><span class="line"><span class="string">ldlm.namespaces.mdt-fsname-MDT0000_UUID.lru_size=400</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSS$ lctl get_param ldlm.namespaces.*.lru_size</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC192.168.0.1@tcp.lru_size=400</span></span><br><span class="line"><span class="string">ldlm.namespaces.filter-fsname-OST0000_UUID.lru_size=400</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-OST0000.lru_size=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">client $ lctl get_param ldlm.namespaces.*.lru_size</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC192.168.0.1@tcp.lru_size=2400</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.lru_size=0</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-OST0000-osc-ffff8dab2cce8800.lru_size=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># The lru_size parameter is used to control the number of client-side locks in the LRU cached locks queue</span></span><br><span class="line"><span class="string">client $ lctl get_param ldlm.namespaces.*mdc-*.lru_size #default dynamic</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.lru_size=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#disable </span></span><br><span class="line"><span class="string">client$ lctl set_param ldlm.namespaces.*osc*.lru_size=5000</span></span><br><span class="line"><span class="string">#The total number of locks available is a function of the server RAM. The default limit is 50 locks/1 MB of RAM. If memory pressure is too high, the LRU size is shrunk. The number of locks on the server is limited tonum_osts_per_oss * num_clients * lru_size as followsa</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To determine the number of locks being granted with dynamic LRU resizing, run:</span></span><br><span class="line"><span class="string">client$ lctl get_param ldlm.namespaces.*.pool.limit</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC192.168.0.1@tcp.pool.limit=0</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.pool.limit=195699</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-OST0000-osc-ffff8dab2cce8800.pool.limit=183850</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSS $ lctl get_param ldlm.namespaces.*.pool.limit</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC192.168.0.1@tcp.pool.limit=0</span></span><br><span class="line"><span class="string">ldlm.namespaces.filter-fsname-OST0000_UUID.pool.limit=183850</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-OST0000.pool.limit=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MDS $ lctl get_param ldlm.namespaces.*.pool.limit</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC192.168.0.1@tcp.pool.limit=0</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGS.pool.limit=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.pool.limit=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-OST0000-osc-MDT0000.pool.limit=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.mdt-fsname-MDT0000_UUID.pool.limit=195699</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The lru_max_age parameter is used to control the age of client-side locks in the LRU cached locks queue. This limits how long unused locks are cached on the client, and avoids idle clients from holding locks for an excessive time, which reduces memory usage on both the client and server, as well as reducing work during server recovery.</span></span><br><span class="line"><span class="string">Client$ lctl set_param ldlm.namespaces.*MDT*.lru_max_age=900s</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.lru_max_age=900s</span></span><br><span class="line"><span class="string">Client$ lctl get_param ldlm.namespaces.*MDT*.lru_max_age</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.lru_max_age=900000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#modify client not change mds and oss</span></span><br><span class="line"><span class="string">MDS $ lctl get_param ldlm.namespaces.*MDT*.lru_max_age</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.lru_max_age=3900000</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-OST0000-osc-MDT0000.lru_max_age=3900000</span></span><br><span class="line"><span class="string">ldlm.namespaces.mdt-fsname-MDT0000_UUID.lru_max_age=3900000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSS $ lctl get_param ldlm.namespaces.*MDT*.lru_max_age</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-OST0000.lru_max_age=3900000 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MDS $ lctl get_param ldlm.namespaces.*.pool.lock_volume_factor</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC10.53.18.238@tcp.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGS.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-MDT0000.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-OST0000-osc-MDT0000.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.mdt-fsname-MDT0000_UUID.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OSS $ lctl get_param ldlm.namespaces.*.pool.lock_volume_factor</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC10.53.18.238@tcp.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.filter-fsname-OST0000_UUID.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-lwp-OST0000.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Client $  lctl get_param ldlm.namespaces.*.pool.lock_volume_factor</span></span><br><span class="line"><span class="string">ldlm.namespaces.MGC10.53.18.238@tcp.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-OST0000-osc-ffff8dab2cce8800.pool.lock_volume_factor=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Only client$ lctl get_param ldlm.namespaces.*-MDT0000-mdc-*.lock_unused_count; </span></span><br><span class="line"><span class="string">Only client$ lctl get_param ldlm.namespaces.*-MDT0000-mdc-*.pool.recalc_period</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.lock_unused_count=0</span></span><br><span class="line"><span class="string">ldlm.namespaces.fsname-MDT0000-mdc-ffff8dab2cce8800.pool.recalc_period=10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># check object server status</span></span><br><span class="line"><span class="string">client $ lfs osts</span></span><br><span class="line"><span class="string">client $ cat /proc/fs/lfs/lov/$fsname-clilov-fffff882037467800/target_obd</span></span><br><span class="line"><span class="string">mds    $ cat /proc/fs/lfs/lov/$fsname-MDT0000-mdtlov/target_obd</span></span><br><span class="line"><span class="string">client $ lctl get_param osc.*-OST*.active</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># check object server status in my production env</span></span><br><span class="line"><span class="string">$ (lfs osts | awk -F &#x27;</span>[ :_]+<span class="string">&#x27; &#x27;</span><span class="variable">$0</span>~/OST/&#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;<span class="string">&#x27; | while read line; do grep &quot;FULL&quot; /proc/fs/lfs/osc/$&#123;line&#125;-*/state &gt;/dev/null 2&gt;&amp;1 || echo -e &quot;Got these bad OSTs:&quot; $&#123;RED&#125;$line$&#123;NC&#125; ; done) &amp;&amp; exit 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># show ost ip  addr</span></span><br><span class="line"><span class="string">$ lctl dl -t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># list nids</span></span><br><span class="line"><span class="string">$ lctl lst_nids</span></span><br><span class="line"><span class="string">$ lctl which_nid $your_ipaddr@tcp</span></span><br><span class="line"><span class="string">$ lctl ping $your_ipaddr@tcp </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># mount namespace &quot;D&quot; and clear mds info from client</span></span><br><span class="line"><span class="string">client $ echo 0 &gt; cat /sys/fs/lfs/mdc/$FNAME-*/active</span></span><br><span class="line"><span class="string">client $ lctl set_param mdc.$FNAME-*.active=0 #better than degarde</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># lfs rpc</span></span><br><span class="line"><span class="string">## 2.12.6 default</span></span><br><span class="line"><span class="string">$ lctl get_param -n osc.*OST0000-osc-[^mM]*.max_rpcs_in_flight</span></span><br><span class="line"><span class="string">64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param mdc.*.max_rpcs_in_flight</span></span><br><span class="line"><span class="string">mdc.test0-MDT0000-mdc-ffff95067b45a000.max_rpcs_in_flight=8</span></span><br><span class="line"><span class="string">$ lctl set_param mdc.*.max_rpcs_in_flight=16</span></span><br><span class="line"><span class="string">mdc.test0-MDT0000-mdc-ffff95067b45a000.max_rpcs_in_flight=16</span></span><br><span class="line"><span class="string">$ cat /sys/module/mdt/parameters/max_mod_rpcs_per_client</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#In lfs 2.13 client</span></span><br><span class="line"><span class="string">#direct IO could reach high 120k, but the buffered IO only 4k. there are read </span></span><br><span class="line"><span class="string">#When I disable</span></span><br><span class="line"><span class="string">$ lctl set_param llite.*.read_ahead_async_file_threshold_mb=0</span></span><br><span class="line"><span class="string">echo 0 &gt; /sys/fs/lfs/llite/lfs-ffff9455c0a4b800/read_ahead_async_file_threshold_mb</span></span><br><span class="line"><span class="string">#I could got the high IOPS too.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 2.12.X readahead setting</span></span><br><span class="line"><span class="string">$ ls -1 /sys/kernel/debug/lfs/llite/lfs-ffff92fab9235800</span></span><br><span class="line"><span class="string">dump_page_cache</span></span><br><span class="line"><span class="string">extents_stats</span></span><br><span class="line"><span class="string">extents_stats_per_process</span></span><br><span class="line"><span class="string">max_cached_mb</span></span><br><span class="line"><span class="string">max_read_ahead_mb</span></span><br><span class="line"><span class="string">max_read_ahead_per_file_mb</span></span><br><span class="line"><span class="string">max_read_ahead_whole_mb</span></span><br><span class="line"><span class="string">nosquash_nids</span></span><br><span class="line"><span class="string">offset_stats</span></span><br><span class="line"><span class="string">read_ahead_stats</span></span><br><span class="line"><span class="string">root_squash</span></span><br><span class="line"><span class="string">sbi_flags</span></span><br><span class="line"><span class="string">site</span></span><br><span class="line"><span class="string">statahead_stats</span></span><br><span class="line"><span class="string">stats</span></span><br><span class="line"><span class="string">unstable_stats</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Many system commands, such as ls –l, du, and find, traverse a directory sequentially. To make these commands run efficiently, the directory statahead can be enabled to improve the performance of directory traversal</span></span><br><span class="line"><span class="string"># Controls the maximum number of file attributes (metadata) that will be prefetched by the statahead thread. By default, statahead is enabled and statahead_max is 32 files, The maximum statahead_max is 8192 files</span></span><br><span class="line"><span class="string">$ lctl get_param llite.*.statahead_max</span></span><br><span class="line"><span class="string">llite.fsname-ffff8dab2cce8800.statahead_max=32</span></span><br><span class="line"><span class="string">$ lctl set_param llite.*.statahead_max=128</span></span><br><span class="line"><span class="string">$ lctl set_param -P llite.*.statahead_max=128</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The directory statahead thread will also prefetch the file size/block attributes from the OSTs, so that all file attributes are available on the client when requested by an application. This is controlled by the asynchronous glimpse lock (AGL) setting. The AGL behaviour can be disabled by setting:</span></span><br><span class="line"><span class="string">$ lctl set_param llite.*.statahead_agl=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#default enable</span></span><br><span class="line"><span class="string">$ lctl set_param llite.*.statahead_agl=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl get_param -n llite.*.statahead_stats</span></span><br><span class="line"><span class="string">statahead total: 4</span></span><br><span class="line"><span class="string">statahead wrong: 0 ## Does it increase, monitor</span></span><br><span class="line"><span class="string">agl total: 4</span></span><br><span class="line"><span class="string">#A read-only interface that provides current statahead and AGL statistics, such as how many times statahead/AGL has been triggered since the last mount, how many statahead/AGL failures have occurred due to an incorrect prediction or other causes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># client max read ahead size</span></span><br><span class="line"><span class="string">cat /sys/kernel/debug/lfs/llite/lfs-ffff91b225941800/max_read_ahead_mb</span></span><br><span class="line"><span class="string">64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /proc/fs/lfs/osc/fsname-*/state</span></span><br><span class="line"><span class="string">$ grep -Ri current_state  /proc/fs/lfs/osc/fsname-*/state</span></span><br><span class="line"><span class="string">current_state: FULL</span></span><br><span class="line"><span class="string">state_history:</span></span><br><span class="line"><span class="string"> - [ 1616015179, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616015179, IDLE ]</span></span><br><span class="line"><span class="string"> - [ 1616018598, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616018598, FULL ]</span></span><br><span class="line"><span class="string"> - [ 1616019092, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616019092, IDLE ]</span></span><br><span class="line"><span class="string"> - [ 1616019285, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616019285, FULL ]</span></span><br><span class="line"><span class="string"> - [ 1616021199, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616021199, IDLE ]</span></span><br><span class="line"><span class="string"> - [ 1616023761, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616023761, FULL ]</span></span><br><span class="line"><span class="string"> - [ 1616023908, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616023908, IDLE ]</span></span><br><span class="line"><span class="string"> - [ 1616147184, CONNECTING ]</span></span><br><span class="line"><span class="string"> - [ 1616147184, FULL ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grep generation /proc/fs/lfs/osc/*-OST0000*/import</span></span><br><span class="line"><span class="string">       generation: 11</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">or </span></span><br><span class="line"><span class="string">client $ lctl get_param osc.fsname-OST0000*.import</span></span><br><span class="line"><span class="string">client $ lctl get_param osc.fsname-OST0000*.state</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lctl set_param osc.*.idle_timeout=20</span></span><br></pre></td></tr></table></figure><h3 id="mds"><a href="#mds" class="headerlink" title="mds"></a>mds</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/module/mdt/parameters/max_mod_rpcs_per_client</span><br><span class="line"><span class="number">8</span></span><br><span class="line">$ echo <span class="number">16</span> &gt; /sys/module/mdt/parameters/max_mod_rpcs_per_client</span><br><span class="line"></span><br><span class="line"><span class="comment"># oss, lfs is extended to support RPCs up to 16MB in size</span></span><br><span class="line"><span class="comment"># Lfs is extended to support RPCs up to 16MB in size. By enabling a larger RPC size, fewer RPCs will be required to transfer the same amount of data between clients and servers. With a larger RPC size, the OSS can submit more data to the underlying disks at once, therefore it can produce larger disk I/Os to fully utilize the increasing bandwidth of disks.</span></span><br><span class="line"><span class="comment">#At client connection time, clients will negotiate with servers what the maximum RPC size it is possible to use, but the client can always send RPCs smaller than this maximum.</span></span><br><span class="line"><span class="comment">#The parameter brw_size is used on the OST to tell the client the maximum (preferred) IO size. All clients that talk to this target should never send an RPC greater than this size. Clients can individually set a smaller RPC size limit via the osc.*.max_pages_per_rpc tunable.</span></span><br><span class="line"><span class="comment">#The smallest brw_size that can be set for ZFS OSTs is the recordsize of that dataset. This ensures that the client can always write a full ZFS file block if it has enough dirty data, and does not otherwise force it to do read- modify-write operations for every RPC. </span></span><br><span class="line"></span><br><span class="line">$ lctl get_param obdfilter.test0-OST*.brw_size</span><br><span class="line">obdfilter.test0-OST0000.brw_size=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">$ lctl set_param obdfilter.*.brw_size=<span class="number">16</span> #<span class="number">16</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get all client info from mds</span></span><br><span class="line">$ cat /<span class="keyword">proc</span>/fs/lfs/nodemap/default/exports</span><br><span class="line"></span><br><span class="line">##client</span><br><span class="line">$<span class="title"> lctl</span> get_param<span class="title"> osc.*.max_pages_per_rpc</span> osc.*.max_rpcs_in_flight<span class="title"> osc.*.max_dirty_mb</span> llite.*.max_read_ahead_mb</span><br><span class="line">#<span class="title"> In</span> order<span class="title"> to</span> enable<span class="title"> a</span> larger<span class="title"> RPC</span> size,<span class="title"> brw_size</span> must<span class="title"> be</span> changed<span class="title"> to</span> an<span class="title"> IO</span> size<span class="title"> value</span> up<span class="title"> to</span> 16MB.<span class="title"> To</span> temporarily<span class="title"> change</span> brw_size,<span class="title"> the</span> following<span class="title"> command</span> should<span class="title"> be</span> run<span class="title"> on</span> the<span class="title"> OSS:</span></span><br><span class="line"><span class="title">oss#</span> lctl<span class="title"> set_param</span> obdfilter.fsname-OST*.brw_size=16</span><br><span class="line"></span><br><span class="line">To<span class="title"> persistently</span> change<span class="title"> brw_size,</span> the<span class="title"> following</span> command<span class="title"> should</span> be<span class="title"> run:</span></span><br><span class="line"><span class="title">oss#</span> lctl<span class="title"> set_param</span> -P<span class="title"> obdfilter.fsname-OST*.brw_size=16</span></span><br><span class="line"><span class="title">When</span> a<span class="title"> client</span> connects<span class="title"> to</span> an<span class="title"> OST</span> target,<span class="title"> it</span> will<span class="title"> fetch</span> brw_size<span class="title"> from</span> the<span class="title"> target</span> and<span class="title"> pick</span> the<span class="title"> maximum</span> value<span class="title"> of</span> brw_size<span class="title"> and</span> its<span class="title"> local</span> setting<span class="title"> for</span> max_pages_per_rpc<span class="title"> as</span> the<span class="title"> actual</span> RPC<span class="title"> size.</span> Therefore,<span class="title"> the</span> max_pages_per_rpc<span class="title"> on</span> the<span class="title"> client</span> side<span class="title"> would</span> have<span class="title"> to</span> be<span class="title"> set</span> to 16M,<span class="title"> or</span> 4096<span class="title"> if</span> the<span class="title"> PAGESIZE</span> is 4KB,<span class="title"> to</span> enable<span class="title"> a</span> 16MB<span class="title"> RPC.</span> To<span class="title"> temporarily</span> make<span class="title"> the</span> change,<span class="title"> the</span> following<span class="title"> command</span> should<span class="title"> be</span> run<span class="title"> on</span> the<span class="title"> client</span> to<span class="title"> setmax_pages_per_rpc:</span></span><br><span class="line"><span class="title">client$</span> lctl<span class="title"> set_param</span> osc.fsname-OST*.max_pages_per_rpc=16M</span><br><span class="line">client$<span class="title"> lctl</span> set_param -P<span class="title"> obdfilter.fsname-OST*.osc.max_pages_per_rpc=16M</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">client$</span> lctl<span class="title"> set_param</span> osc.*.max_pages_per_rpc=256<span class="title"> osc.*.max_rpcs_in_flight=64</span> osc.*.max_dirty_mb=256</span><br><span class="line">client$<span class="title"> lctl</span> get_param<span class="title"> osc.*.max_pages_per_rpc</span></span><br><span class="line"><span class="title">osc.fsname-OST0000-osc-ffff8dab2cce8800.max_pages_per_rpc=256</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">#</span> cancel_lru_locks</span><br><span class="line">$<span class="title"> lctl</span> set_param -n<span class="title"> ldlm.namespaces.*osc*.lru_size=clear</span></span><br><span class="line"><span class="title">$</span> lctl<span class="title"> set_param</span> -n<span class="title"> ldlm.namespaces.*mdc*.lru_size=clear</span></span><br><span class="line"><span class="title">$</span> lctl<span class="title"> set_param</span> -n<span class="title"> osc.*.rpc_stats=0</span></span><br><span class="line"><span class="title">$</span> dd<span class="title"> if=/dev/zero</span> of=/lfs/test<span class="title"> bs=1M</span> count=10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###<span class="title"> example</span> for<span class="title"> single</span> OST</span><br><span class="line">$<span class="title"> lctl</span> get_param -n &#x27;osc.*.rpc_stats&#x27; |<span class="title"> sed</span> -n &#x27;/pages<span class="title"> per</span> rpc/,/^$/p&#x27;</span><br><span class="line">pages<span class="title"> per</span> rpc<span class="title">         rpcs</span>   %<span class="title"> cum</span> % |<span class="title">       rpcs</span>   %<span class="title"> cum</span> %</span><br><span class="line">1:         0   0   0   |          0   0   0</span><br><span class="line">2:         0   0   0   |          0   0   0</span><br><span class="line">4:         0   0   0   |          0   0   0</span><br><span class="line">8:         0   0   0   |          0   0   0</span><br><span class="line">16:         0   0   0   |          0   0   0</span><br><span class="line">32:         0   0   0   |          0   0   0</span><br><span class="line">64:         0   0   0   |          0   0   0</span><br><span class="line">128:         0   0   0   |          0   0   0</span><br><span class="line">256:         0   0   0   |         10 100 100  ##<span class="title"> why</span> 256 ?<span class="title"> in</span> my<span class="title"> test</span> env,<span class="title"> the</span> brw_size=1 * 1048576 / 4096<span class="title"> PAGE_SIZE</span> = 256</span><br><span class="line">                         |                       |</span><br><span class="line">                         |                      ----------<span class="title"> means</span> dd<span class="title"> bs=1M</span> count=10 , 10<span class="title"> x</span> read<span class="title"> rpcs</span></span><br><span class="line"><span class="title"></span>                         ---------------------------------write<span class="title"> rpcs</span></span><br><span class="line"><span class="title">###</span> if<span class="title"> you</span> set<span class="title"> brw_size</span> in<span class="title"> OSS,</span> and<span class="title"> make</span> sure<span class="title"> it</span> by<span class="title"> the</span> client </span><br><span class="line"></span><br><span class="line">#<span class="title"> The</span> parameter<span class="title"> brw_size</span> is<span class="title"> used</span> on<span class="title"> the</span> OST<span class="title"> to</span> tell<span class="title"> the</span> client<span class="title"> the</span> maximum (preferred)<span class="title"> IO</span> size.<span class="title"> All</span> clients<span class="title"> that</span> talk<span class="title"> to</span> this<span class="title"> target</span> should<span class="title"> never</span> send<span class="title"> an</span> RPC<span class="title"> greater</span> than<span class="title"> this</span> size.<span class="title"> Clients</span> can<span class="title"> individually</span> set<span class="title"> a</span> smaller<span class="title"> RPC</span> size<span class="title"> limit</span> via<span class="title"> the</span> osc.*.max_pages_per_rpc<span class="title"> tunable.</span></span><br><span class="line"><span class="title">#</span> The<span class="title"> smallest</span> brw_size<span class="title"> that</span> can<span class="title"> be</span> set<span class="title"> for</span> ZFS<span class="title"> OSTs</span> is<span class="title"> the</span> recordsize<span class="title"> of</span> that<span class="title"> dataset.</span> This<span class="title"> ensures</span> that<span class="title"> the</span> client<span class="title"> can</span> always<span class="title"> write</span> a<span class="title"> full</span> ZFS<span class="title"> file</span> block<span class="title"> if</span> it<span class="title"> has</span> enough<span class="title"> dirty</span> data,<span class="title"> and</span> does<span class="title"> not</span> otherwise<span class="title"> force</span> it<span class="title"> to</span> do<span class="title"> read-</span> modify-write<span class="title"> operations</span> for<span class="title"> every</span> RPC. </span><br><span class="line">$<span class="title"> lctl</span> set_param<span class="title"> obdfilter.fsname-OST*.brw_size=16</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">#</span> No<span class="title"> root</span> squash</span><br><span class="line">mds $<span class="title"> lctl</span> set_param $fsname.mdt.root_squash=108:108</span><br><span class="line">or</span><br><span class="line">mds $<span class="title"> lctl</span> set_param<span class="title"> mdt.$</span>&#123;fsname&#125;-MDT0000.root_squash=<span class="number">108</span>:<span class="number">108</span></span><br><span class="line">mds $ lctl set_param mdt.$&#123;fsname&#125;-MDT0000.nosquash_nids=<span class="string">&quot;ip.ip.ip.ip@tcp ip1.ip1.ip1.ip@tcp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">error</span>: set_param: param_path &#x27;$fsname/mdt/root_squash&#x27;: No such <span class="keyword">file</span> or directory</span><br><span class="line">mds $ lctl conf_param $fsname.mdt.root_squash=<span class="number">108</span>:<span class="number">108</span></span><br><span class="line">mds $ lctl conf_param $fsname.mdt.nosquash_nids=<span class="string">&quot;ip.ip.ip.ip@tcp ip1.ip1.ip1.ip@tcp&quot;</span></span><br><span class="line">mds $ cat /<span class="keyword">proc</span>/fs/lf/mdt/$FNAME-MDT0000/nosquash_nids</span><br><span class="line">ip.ip.ip.ip@tcp<span class="title"> ip1.ip1.ip1.ip@tcp</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">client</span> $<span class="title"> lctl</span> set_param<span class="title"> llite.$FNAME-*.nosquash_nids=&quot;ip.ip.ip.ip@tcp</span> ip1.ip1.ip1.ip@tcp&quot;</span><br><span class="line"></span><br><span class="line">#<span class="title"> MDS</span> to<span class="title"> totally</span> avoid<span class="title"> new</span> object<span class="title"> creation</span> on<span class="title"> that</span> OST</span><br><span class="line">$<span class="title"> lctl</span> set_param<span class="title"> osp.$FNAME-OST00XX.max_create_count=0</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">#degrade</span> will<span class="title"> only</span> prefer<span class="title"> to</span> skip<span class="title"> the</span> OST</span><br><span class="line">OSS $<span class="title"> lctl</span> set_param<span class="title"> obdfilter.$FNAME-OST0000.degraded=1</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">#disable</span> pre-create</span><br><span class="line">OSS $<span class="title"> lctl</span> set_param<span class="title"> obdfilter.$FNAME-OST0000*.no_precreate=1</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">$</span> lctl<span class="title"> set_param</span> -P<span class="title"> timeout=300</span></span><br><span class="line"><span class="title">$</span> lctl<span class="title"> set_param</span> timeout=300 </span><br><span class="line">#<span class="title"> if</span> you<span class="title"> want</span> it<span class="title"> work</span> ,you<span class="title"> have</span> set<span class="title"> it</span> twice...</span><br><span class="line"></span><br><span class="line">#<span class="title"> Monitor</span> status</span><br><span class="line">$<span class="title"> cat</span> /<span class="keyword">proc</span>/fs/lfs/mdc/$&#123;fname&#125;-MDT0000-mdc-ffff88091eff0800/state </span><br><span class="line">$ lctl get_param mdc.$fname-MDT*.state</span><br><span class="line"></span><br><span class="line">$ watch -d lctl get_param mdt.*.md_stats</span><br><span class="line">snapshot_time             <span class="number">1556726087.189561170</span> secs.nsecs</span><br><span class="line"><span class="keyword">open</span>                      <span class="number">3412130101</span> samples [reqs]</span><br><span class="line"><span class="keyword">close</span>                     <span class="number">2926922120</span> samples [reqs]</span><br><span class="line">mknod                     <span class="number">293730475</span> samples [reqs]</span><br><span class="line">link                      <span class="number">20713305</span> samples [reqs]</span><br><span class="line">unlink                    <span class="number">316042257</span> samples [reqs]</span><br><span class="line">mkdir                     <span class="number">3275032</span> samples [reqs]</span><br><span class="line">rmdir                     <span class="number">2731821</span> samples [reqs]</span><br><span class="line"><span class="keyword">rename</span>                    <span class="number">7687699</span> samples [reqs]</span><br><span class="line">getattr                   <span class="number">2060900881</span> samples [reqs]</span><br><span class="line">setattr                   <span class="number">320658776</span> samples [reqs]</span><br><span class="line">getxattr                  <span class="number">1080139037</span> samples [reqs]</span><br><span class="line">setxattr                  <span class="number">222105</span> samples [reqs]</span><br><span class="line">statfs                    <span class="number">11587278</span> samples [reqs]</span><br><span class="line">sync                      <span class="number">20670980</span> samples [reqs]</span><br><span class="line">samedir_rename            <span class="number">7199107</span> samples [reqs]</span><br><span class="line">crossdir_rename           <span class="number">488592</span> samples [reqs]</span><br></pre></td></tr></table></figure><h3 id="OSS-1"><a href="#OSS-1" class="headerlink" title="OSS"></a>OSS</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">obdfilter.lfsfs-OST*.brw_size=16</span></span><br><span class="line"></span><br><span class="line"><span class="string">osc.lfsfs-OST*.max_pages_per_rpc=4096</span></span><br><span class="line"><span class="string">lite.lfs*.max_read_aqhead_mb=1024</span></span><br><span class="line"><span class="string">osc.lfsfs-OST*.max_rpcs_in_flight=16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># osd_sync_destroy_max_size &quot;Maximum object size to use synchronous destroy</span></span><br><span class="line"><span class="string">options</span> <span class="string">osd_zfs</span> <span class="string">osd_sync_destroy_max_size=1048576</span></span><br><span class="line"></span><br><span class="line"><span class="string">options</span> <span class="string">ost</span> <span class="string">oss_num_threads=0</span></span><br><span class="line"><span class="comment"># you can limit the server performance by num_threads </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#default ost io threads</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">ost.OSS.ost_io.threads_max</span></span><br><span class="line"><span class="string">ost.OSS.ost_io.threads_max=128</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">ost.OSS.ost_io.threads_started</span></span><br><span class="line"><span class="string">ost.OSS.ost_io.threads_started=21</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpc info</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/proc/fs/lfs/osc/lfs-OST0000-osc-ffff88103a993000/import</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get status</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">osc.*OST0000*.&#123;state,timeouts&#125;</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">at_*</span> <span class="string">timeout</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">llite.*$FNAME*.stats</span></span><br><span class="line"><span class="comment">### clear stats, lctl set_param llite.*.stats=c</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">obdfilter.*OST005e*.brw_stats</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Read and print the last_rcvd file from a device</span></span><br><span class="line"><span class="comment">#display client information</span></span><br><span class="line"><span class="string">$</span> <span class="string">lr_reader</span> <span class="string">-c</span> <span class="string">/dev/sdh</span></span><br><span class="line"><span class="attr">last_rcvd:</span></span><br><span class="line"><span class="attr">uuid:</span> <span class="string">fsms-MDT0000_UUID</span></span><br><span class="line"> <span class="attr">feature_compat:</span> <span class="number">0x8</span></span><br><span class="line"> <span class="attr">feature_incompat:</span> <span class="number">0x61c</span></span><br><span class="line"> <span class="attr">feature_rocompat:</span> <span class="number">0x1</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">4294967298</span></span><br><span class="line"> <span class="attr">target_index:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">mount_count:</span> <span class="number">1</span></span><br><span class="line"> <span class="attr">client_area_start:</span> <span class="number">8192</span></span><br><span class="line"> <span class="attr">client_area_size:</span> <span class="number">128</span></span><br><span class="line"> <span class="attr">79136f3b-7d85-e265-37aa-dbb40ec5a30c:</span></span><br><span class="line"> <span class="attr">generation:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_xid:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_result:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_data:</span> <span class="number">0</span></span><br><span class="line"><span class="comment">#display reply data information</span></span><br><span class="line"><span class="string">$</span> <span class="string">lr_reader</span> <span class="string">-r</span> <span class="string">/dev/sdh</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">reply_data:</span></span><br><span class="line"> <span class="attr">0:</span></span><br><span class="line"> <span class="attr">client_generation:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">4426736549</span></span><br><span class="line"> <span class="attr">last_xid:</span> <span class="number">1511845291497772</span></span><br><span class="line"> <span class="attr">last_result:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_data:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">1:</span></span><br><span class="line"> <span class="attr">client_generation:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">4426736566</span></span><br><span class="line"> <span class="attr">last_xid:</span> <span class="number">1511845291498048</span></span><br><span class="line"> <span class="attr">last_result:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_data:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># disable ost cache</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">osd-ldiskfs.*.read_cache_enable</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">ldlm.namespaces.*.lru_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make sure ost mount parameters and flag</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/proc/fs/ldiskfs/dm-xx/options</span></span><br><span class="line"><span class="string">rw</span></span><br><span class="line"><span class="string">barrier</span></span><br><span class="line"><span class="string">no_mbcache</span></span><br><span class="line"><span class="string">user_xattr</span></span><br><span class="line"><span class="string">acl</span></span><br><span class="line"><span class="string">resuid=0</span></span><br><span class="line"><span class="string">resgid=0</span></span><br><span class="line"><span class="string">errors=remount-ro</span></span><br><span class="line"><span class="string">commit=5</span></span><br><span class="line"><span class="string">min_batch_time=0</span></span><br><span class="line"><span class="string">max_batch_time=15000</span></span><br><span class="line"><span class="string">stripe=0</span></span><br><span class="line"><span class="string">data=ordered</span></span><br><span class="line"><span class="string">inode_readahead_blks=32</span></span><br><span class="line"><span class="string">init_itable=10</span></span><br><span class="line"><span class="string">max_dir_size_kb=0</span></span><br></pre></td></tr></table></figure><h4 id="TCP-Ethernet-network"><a href="#TCP-Ethernet-network" class="headerlink" title="TCP Ethernet network"></a>TCP Ethernet network</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">options lnet networks=<span class="string">&quot;tcp0(myri10ge),tcp1(eth0)&quot;</span></span><br><span class="line">lctl</span><br><span class="line">lctl &gt; network tcp1</span><br><span class="line">lctl &gt; peer_list</span><br><span class="line">12345-xx.xx.xx.xx@tcp [0]0.0.0.0-&gt;0.0.0.0:0 <span class="comment">#0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ldlm_enqueue_min = max(2*net_latency, net_latency + quiescent_time) +\\ 2*service_time</span></span><br><span class="line"><span class="comment"># ldlm_enqueue_min = max(2*50, 50 + 140) + 2*50 = 50+140 + 100 = 290</span></span><br><span class="line"><span class="comment">#Minimum lock enqueue time (in seconds). The default is 100. The time it takes to enqueue a lock, ldlm_enqueue, is the maximum of the measured enqueue estimate (influenced by at_min and at_max parameters), multiplied by a weighting factor and the value of ldlm_enqueue_min.Lustre Distributed Lock Manager (LDLM) lock enqueues have a dedicated minimum value for ldlm_enqueue_min. Lock enqueue timeouts increase as the measured enqueue times increase (similar to adaptive timeouts).</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#at_max The largest potential RPC timeout that a client can set is 2*at_max. By lowering at_max from 600 to 400 seconds we reduce the worst case I/O delay from 1200 seconds, or 20 minutes, to 800 seconds or just over 13 minutes.</span></span><br><span class="line"><span class="comment">#at_min The 40 second value factors into our calculation for an appropriate LDLM timeout as discussed in section LDLM Timeouts. Our recommendation for Lfs servers is also 40 seconds</span></span><br><span class="line"><span class="comment">#Adaptive Timeouts: In a Lfs file system servers keep track of the time it takes for RPCs to be completed</span></span><br><span class="line"><span class="comment">#The quiescent_time in this formula is to account for the time it takes all Lfs clients to reestablish connections with all Lfs targets following an HSN quiesce. We&#x27;ve experimentally determined an average time to be approximately 140 seconds, but it is possible that this value may vary based on different factors such as the number of Lfs clients, the number of Lfs targets, the number of Lfs file systems mounted on each client, etc. Thus, given an at_min of 40 seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">options ptlrpc ldlm_enqueue_min=250</span><br><span class="line"></span><br><span class="line"><span class="comment"># readonly mount</span></span><br><span class="line">$ mount.lfs <span class="variable">$zpool</span> /ost0 -o rdonly_dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># mount a network</span></span><br><span class="line">$ mount.lfs -o device=192.168.1.1@tcp1:/lfs1 /mnt </span><br></pre></td></tr></table></figure><p><a href="http://wiki.lfs.org/Lfs_Resiliency:_Understanding_Lfs_Message_Loss_and_Tuning_for_Resiliency#Tuning_Lfs_for_Resiliency">Understanding Lfs Message Loss and Tuning for Resiliency</a></p><p>I think in some the bad Ethernet tcp quality env, you must improve them</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /sys/module/lnet/parameters</span><br><span class="line">$ chmod 755 ./*</span><br><span class="line">$ <span class="built_in">echo</span> 1024 &gt; accept_backlog</span><br><span class="line">$ <span class="built_in">echo</span> 5 &gt; lnet_retry_count</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; use_tcp_bonding</span><br><span class="line">$ cat accept_backlog lnet_retry_count use_tcp_bonding</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /sys/module/ksocklnd/parameters</span><br><span class="line">chmod 755 ./*</span><br><span class="line"><span class="built_in">echo</span> 128 &gt; peer_credits</span><br><span class="line"><span class="built_in">echo</span> 1024 &gt; credits</span><br><span class="line"><span class="built_in">echo</span> 80 &gt; sock_timeout</span><br><span class="line">cat credits peer_credits sock_timeout</span><br><span class="line"></span><br><span class="line"><span class="comment">#What is the mean about Peer ?</span></span><br><span class="line"><span class="comment">#Dynamic Peer Discovery</span></span><br><span class="line"><span class="comment">#Dynamic Peer Discovery (&quot;Discovery&quot; for short) is the process by which a node can discover the network interfaces it can reach a peer on without being pre-configured. This involves sending a ping to the peer. The ping response carries a flag bit to indicate that the peer is multi-rail capable. If it is the node then pushes its own network interface information to the peer. This protocol distributes the network interface information to both nodes and subsequently the nodes can excercise the peer network interfaces as well as its own, as described in further detail in this section. Discovery can be enabled, disabled or in verification mode. If it is in verification mode, then it will cross reference the discovered peer NIDs with the configured NIDs and complain if there is a discrepancy, but will continue to use the configured NIDs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Peer Credits</span></span><br><span class="line"><span class="comment">#Governs the number of concurrent sends to a single peer, End-to-end flow control accomplished at higher layer. e.g. max_rpcs_in_flight</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/sys/lnet/peers </span><br><span class="line">$ cat /sys/kernel/debug/lnet/peers</span><br><span class="line">nid                      refs state  last   max   rtr   min    tx   min queue </span><br><span class="line">xx.xx.xx.xx@o2ib            3    up    -1   126   126   126   126   110 0</span><br><span class="line">tx is the number of peer credits currently available <span class="keyword">for</span> this peer</span><br><span class="line">min is the smallest number of peer credits seen </span><br><span class="line">Negative credit count indicates the number of messages awaiting a credit</span><br><span class="line"></span><br><span class="line"><span class="comment">#lnet network Interface Credits</span></span><br><span class="line">$ cat /proc/sys/lnet/nis</span><br><span class="line">nid                      status alive refs peer  rtr   max    tx   min </span><br><span class="line">xx.xx.xx.xx@o2ib              up    -1    9  126    0  2048  2048  1796 </span><br><span class="line">max is total available (i.e. value of ko2iblnd credits) </span><br><span class="line">tx is the number currently available, Negative number indicates number of messages awaiting a credit</span><br><span class="line">min is the low water mark</span><br><span class="line"></span><br><span class="line"><span class="comment">#Lctl conn_list–List active TCP connections, type (bulk/control), tx_buffer_size, rx_buffer_size</span></span><br><span class="line">$ lctl --net tcp conn_list</span><br><span class="line"></span><br><span class="line">chmod a+w /sys/module/ksocklnd/parameters/*</span><br><span class="line"><span class="built_in">echo</span> 2000 &gt; /sys/module/ksocklnd/parameters/credits</span><br><span class="line"><span class="comment"># the number of concurrent sends (to all peers), defaults:64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 240 &gt; /sys/module/ksocklnd/parameters/peer_timeout</span><br><span class="line"><span class="comment">## default 180</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## not test</span></span><br><span class="line"><span class="built_in">echo</span> 256 &gt; /sys/module/ksocklnd/parameters/peer_buffer_credits</span><br><span class="line"><span class="comment">#default: 0; peer_buffer_credits=256 # per-peer router buffer credits</span></span><br><span class="line"><span class="comment"># concurrent_sends=256 - send work-queue sizing # not test</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 32 &gt; /sys/module/ksocklnd/parameters/peer_credits</span><br><span class="line"><span class="comment">## the number of concurrent sends to a single peer, #default:8</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 70 &gt; /sys/module/ksocklnd/parameters/sock_timeout</span><br><span class="line"><span class="comment">## default: 50 sec</span></span><br><span class="line"></span><br><span class="line">chmod a+w /sys/module/lnet/parameters/*</span><br><span class="line"><span class="built_in">echo</span> 15 &gt; /sys/module/lnet/parameters/accept_timeout</span><br><span class="line"><span class="comment">##default: 5  Acceptor&#x27;s timeout (seconds)</span></span><br><span class="line">options lnet accept_timeout=15</span><br><span class="line"><span class="comment">## Specifies the number of seconds the server waits for data to arrive from the client. If data does not arrive before the timeout expires then the connection is closed. By setting it to less than the default 30 seconds, you can free up threads sooner. However, you may also disconnect users with slower connections.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 2000 &gt; /sys/module/lnet/parameters/accept_backlog</span><br><span class="line"><span class="comment">##default: 127 Acceptor&#x27;s listen backlog</span></span><br><span class="line">options lnet accept_backlog=2000</span><br><span class="line"><span class="comment">## Acceptor&#x27;s listen backlog, the number of the connections the server instance can buffer in the wait queue.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 6 &gt; /sys/module/lnet/parameters/lnet_retry_count</span><br><span class="line"><span class="comment">## default: 3 lnet_retry_count:Maximum number of times to retry transmitting a message</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/module/lnet/parameters/use_tcp_bonding</span><br><span class="line"><span class="comment">## default: 1  use_tcp_bonding:Set to 1 to use socklnd bonding. 0 to use Multi-Rail</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## default lfs.conf</span></span><br><span class="line">options lnet networks=tcp(bond0)</span><br><span class="line">options lnet use_tcp_bonding=1</span><br><span class="line">options lnet accept_backlog=2000</span><br><span class="line">options lnet accept_timeout=15</span><br><span class="line">options lnet lnet_retry_count=6</span><br><span class="line">options ksocklnd credits=2000</span><br><span class="line">options ksocklnd peer_credits=32</span><br><span class="line">options ksocklnd sock_timeout=70</span><br><span class="line">options ptlrpc at_max=320</span><br><span class="line">options ptlrpc at_min=50</span><br><span class="line">options ptlrpc ldlm_enqueue_min=240</span><br><span class="line"></span><br><span class="line"><span class="comment"># The maximum number of pages that will be sent in a single RPC request to the OST</span></span><br><span class="line">$ lctl get_param osc.*.max_pages_per_rpc</span><br><span class="line">$ lctl set_param osc.*.max_pages_per_rpc=1024 <span class="comment"># 1024 = 1024*4KB =4MB per RPC</span></span><br><span class="line"><span class="comment">#Max RPCS in flight between OSC and OST</span></span><br><span class="line">$ lctl set_param -P <span class="variable">$FNAME</span>.osc.max_pages_per_rpc=1024</span><br><span class="line"></span><br><span class="line">$ lctl set_param osc.*.max_rpcs_in_flight=64;</span><br><span class="line"><span class="comment"># Max number of 4K pages per RPC</span></span><br><span class="line"><span class="comment"># Increase for small IO or long fast network paths (high BDP), May want to decrease to preempt TCP congestion</span></span><br><span class="line"></span><br><span class="line">256 = 1MB per RPC</span><br><span class="line"><span class="comment"># max_pages_per_rpc*4*max_rpcs_in_flight*2=max_dirty_mb</span></span><br><span class="line">1024*4KB/1024(KB to MB)*64*2=512</span><br><span class="line">$ lctl set_param osc.*.max_dirty_mb=512</span><br><span class="line"><span class="comment"># Maximum MBs of dirty data that can be written and queued on a client</span></span><br><span class="line"><span class="comment">## Got the current dirty bytes</span></span><br><span class="line">$ lctl get_param osc.*.cur_dirty_bytes</span><br><span class="line"><span class="comment">##  reports the amount of space this client has reserved for writeback cache with each OST</span></span><br><span class="line">$ lctl get_param osc.*.cur_grant_bytes</span><br><span class="line"></span><br><span class="line">Set per OST or each clients</span><br><span class="line">256*4/1024*64*2=128</span><br><span class="line">lctl set_param osc.*.max_pages_per_rpc=256; lctl set_param osc.*.max_rpcs_in_flight=64;lctl set_param osc.*.max_dirty_mb=128</span><br><span class="line"></span><br><span class="line">$ modinfo mdt | grep max_mod_rpcs_per_client</span><br><span class="line">parm:           max_mod_rpcs_per_client:maximum number of modify RPCs <span class="keyword">in</span> flight allowed per client (uint)</span><br><span class="line"></span><br><span class="line">mds $ <span class="built_in">echo</span> 16 &gt; /sys/module/mdt/parameters/max_mod_rpcs_per_client</span><br><span class="line"></span><br><span class="line"><span class="comment"># config</span></span><br><span class="line">lctl network up/down</span><br><span class="line">lctl list_nids</span><br><span class="line">lctl ping xxxxx@tcp</span><br><span class="line">lctl network unconfigure</span><br><span class="line"><span class="comment">### from lfs 2.7</span></span><br><span class="line">lnetctl lnet configure/unconfigure</span><br><span class="line">lnetctl net show -v</span><br><span class="line">lnetctl peer show -v</span><br><span class="line">lnetctl net add --net LNET --<span class="keyword">if</span> eth0</span><br><span class="line">lnetctl net del --net LNET</span><br><span class="line">// To <span class="built_in">export</span> the current configuration to a YAML file</span><br><span class="line">lnetctl <span class="built_in">export</span> FILE.yaml</span><br><span class="line">lnetctl <span class="built_in">export</span> &gt; FILE.yaml</span><br><span class="line">// To import the configuration from a YAML file</span><br><span class="line">lnetctl import FILE.yaml</span><br><span class="line">lnetctl import &lt; FILE.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment">### Lnet multiple-plane</span></span><br><span class="line">options lnet networks=<span class="string">&quot;tcp1(eth1),tcp2(eth2),o2ib0(ib0)&quot;</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">options lnet ip2nets=<span class="string">&quot;tcp1(eth0) 192.168.0.[2,4] \</span></span><br><span class="line"><span class="string"> tcp1 192.168.0.*; o2ib1 132.6.[1-3],[2-8/2]&quot;</span></span><br><span class="line"><span class="comment">### [2-8/2] means 2,4,6,8</span></span><br></pre></td></tr></table></figure><h3 id="Trace-log"><a href="#Trace-log" class="headerlink" title="Trace log"></a>Trace log</h3><h4 id="lfs-log"><a href="#lfs-log" class="headerlink" title="lfs log"></a>lfs log</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># F_SETPIPE_SZ F_GETPIPE_SZ</span></span><br><span class="line"><span class="comment"># echo 104857600 &gt; /proc/sys/fs/pipe-max-size</span></span><br><span class="line"><span class="comment"># fs.pipe-max-size=104857600</span></span><br><span class="line"><span class="comment"># ulimit pipe size            (512 bytes, -p) 8 = 4096 bytes, it &#x27;s pipe buffer size in the ulimit, not pipe size</span></span><br><span class="line"><span class="comment">## POSIX.1-2001 says that write(2)s of less than PIPE_BUF  bytes  must  be atomic:  the  output  data  is  written  to  the  pipe  as a contiguous sequence.  Writes of more than PIPE_BUF bytes may  be  non-atomic:  the kernel  may  interleave the data with data written by other processes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here 2 tools for pipe</span></span><br><span class="line"><span class="comment"># pv - Pipe Viewer - is a terminal-based tool for monitoring the progress of data through a pipeline.</span></span><br><span class="line"><span class="comment"># process1 | pv -pterbTCB 1G | process2</span></span><br><span class="line"></span><br><span class="line">$ pv -cN sources linux-image-unsigned-4.15.0-65-generic-dbgsym_4.15.0-65.74_amd64.ddeb | dd of=/tmp/tmp bs=512 | pv -cN cat</span><br><span class="line">      cat: 0.00 B 0:00:00 [0.00 B/s] [&lt;=&gt;                                                                                                                                                                                                    ]</span><br><span class="line">  sources:  751MiB 0:00:03 [ 191MiB/s] [===================================================================================================================================================================================&gt;] 100%            </span><br><span class="line">1538323+1 records <span class="keyword">in</span></span><br><span class="line">1538323+1 records out</span><br><span class="line">787621648 bytes (788 MB, 751 MiB) copied, 3.92424 s, 201 MB/s</span><br><span class="line"></span><br><span class="line">$ lctl set_param debug_mb=500</span><br><span class="line">$ mkfifo -m 777 /tmp/lfs.log; lctl debug_daemon start /tmp/lfs.log; tail -f /tmp/lfs.log | strings</span><br><span class="line">or</span><br><span class="line"><span class="comment">## 500M</span></span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.log 500</span><br><span class="line"></span><br><span class="line">$ trace-cmd record -p <span class="keyword">function</span> mount <span class="variable">$ipaddr</span>@tcp:/lfs /mnt</span><br><span class="line"><span class="comment"># it &#x27;ll create trace.dat</span></span><br><span class="line">$ trace-cmd report</span><br><span class="line"></span><br><span class="line">$ lctl get_param debug_mb</span><br><span class="line">debug_mb=41</span><br><span class="line"></span><br><span class="line">$ lctl set_param debug_mb=512</span><br><span class="line">$ lctl set_param debug=-1</span><br><span class="line">$ lctl set_param debug=<span class="string">&quot;ioctl neterror warning error emerg ha config console lfsck reada malloc cache dentry mmap page info console rpctrace&quot;</span></span><br><span class="line">traceFunction entry/<span class="built_in">exit</span> markers</span><br><span class="line">dlmtraceDistributed locking-related information</span><br><span class="line">inode</span><br><span class="line">super</span><br><span class="line">mallocMemory allocation or free information</span><br><span class="line">cacheCache-related information</span><br><span class="line">infoNon-critical general information</span><br><span class="line">dentrykernel namespace cache handling</span><br><span class="line">mmapMemory-mapped IO interface</span><br><span class="line">pagePage cache and bulk data transfers</span><br><span class="line">infoMiscellaneous informational messages</span><br><span class="line">netLNet network related debugging</span><br><span class="line">consoleSignificant system events, printed to console</span><br><span class="line">warningSignificant but non-fatal exceptions, printed to console</span><br><span class="line">errorCritical error messages, printed to console</span><br><span class="line">neterrorSignificant LNet error messages</span><br><span class="line">emergFatal system errors, printed to console</span><br><span class="line">configConfiguration and setup, enabled by default</span><br><span class="line">haFailover and recovery-related information, enabled by default</span><br><span class="line">hsmHierarchical space management/tiering</span><br><span class="line">ioctlIOCTL-related information, enabled by default</span><br><span class="line">layoutFile layout handling (PFL, FLR, DoM)</span><br><span class="line">lfsckFilesystem consistency checking, enabled by default</span><br><span class="line">otherMiscellaneious other debug messages</span><br><span class="line">quotaSpace accounting and management</span><br><span class="line">readaClient readahead management</span><br><span class="line">rpctraceRemote request/reply tracing and debugging</span><br><span class="line">secSecurity, Kerberos, Shared Secret Key handling</span><br><span class="line">snapshotFilesystem snapshot management</span><br><span class="line">vfstraceKernel VFS interface operations</span><br><span class="line"></span><br><span class="line"><span class="comment">### Got the mds process with client</span></span><br><span class="line">mds $ lctl set_param debug=+rpctrace</span><br><span class="line">mds $ lctl dk &gt; dk</span><br><span class="line">00000100:00100000:3.0:1621645680.953924:0:5370:0:(service.c:2089:ptlrpc_server_handle_request()) Handling RPC pname:cluuid+ref:pid:xid:nid:opc ll_mgs_0002:781f6010-0ac2-a476-4567-56bb7b70d013+9:86470:x1700165046065472:12345-<span class="variable">$client_IP</span>@tcp:400</span><br><span class="line"></span><br><span class="line"><span class="comment">### Got the client process info</span></span><br><span class="line">client $ lctl set_param debug=+rpctrace</span><br><span class="line">client $ lctl dk &gt; dk</span><br><span class="line">00000100:00100000:15.0:1621645914.531574:0:77490:0:(client.c:1682:ptlrpc_send_new_req()) Sending RPC pname:cluuid:pid:xid:nid:opc vim:8c1a0181-62fb-78ee-8651-31b8edfd4244:77490:1700165046080640:<span class="variable">$MDS_IP</span>@tcp:101</span><br></pre></td></tr></table></figure><h4 id="kdump"><a href="#kdump" class="headerlink" title="kdump"></a>kdump</h4><p>yum -y install kexec-tools<br>cat /etc/kdump.conf<br>nfs my.nfsserver.example.org:/path/to/expor<br>core_collector makedumpfile -d 16 -c<br>#-c Compress dump data by each page<br>#core_collector makedumpfile -d 16 -c message_level 16</p><h1 id="1-Zero-Pages-2-Cache-Pages-4-Cache-Private-8-User-Pages-16-Free-Pages"><a href="#1-Zero-Pages-2-Cache-Pages-4-Cache-Private-8-User-Pages-16-Free-Pages" class="headerlink" title="1 Zero Pages 2 Cache Pages 4 Cache Private 8 User Pages 16 Free Pages"></a>1 Zero Pages 2 Cache Pages 4 Cache Private 8 User Pages 16 Free Pages</h1><h1 id="1-Progress-Indicators-2-Common-Messages-4-Error-Messages-8-Debug-Messages-16-Report-Messages"><a href="#1-Progress-Indicators-2-Common-Messages-4-Error-Messages-8-Debug-Messages-16-Report-Messages" class="headerlink" title="1 Progress Indicators 2 Common Messages 4 Error Messages 8 Debug Messages 16 Report Messages"></a>1 Progress Indicators 2 Common Messages 4 Error Messages 8 Debug Messages 16 Report Messages</h1><p>#ssh <a href="mailto:&#117;&#x73;&#101;&#114;&#64;&#x6d;&#121;&#x2e;&#x73;&#101;&#x72;&#118;&#x65;&#114;&#x2e;&#101;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x6f;&#x72;&#x67;">&#117;&#x73;&#101;&#114;&#64;&#x6d;&#121;&#x2e;&#x73;&#101;&#x72;&#118;&#x65;&#114;&#x2e;&#101;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#x6f;&#x72;&#x67;</a>:/dest/path<br>#By default, uses ssh key at /root/.ssh/kdump_id_rsa<br>#core_collector makedumpfile <options></p><h3 id="changelog"><a href="#changelog" class="headerlink" title="changelog"></a>changelog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* MARK – Internal record keeping</span><br><span class="line">* CREAT – Regular file creation</span><br><span class="line">* MKDIR – Directory creation</span><br><span class="line">* HLINK – Hard link</span><br><span class="line">* SLINK – Soft link</span><br><span class="line">* OPEN – open file</span><br><span class="line">* CLOSE – close file</span><br><span class="line">* MKNOD – Other file creation</span><br><span class="line">* UNLNK – Regular file removal</span><br><span class="line">* RMDIR – Directory removal</span><br><span class="line">* RNMFM – Rename, original</span><br><span class="line">* RNMTO – Rename, final</span><br><span class="line">* IOCTL – ioctl on file or directory</span><br><span class="line">* TRUNC – Regular file truncated</span><br><span class="line">* SATTR – Attribute change</span><br><span class="line">* XATTR – Extended Attribute change</span><br><span class="line">* HSM – HSM action</span><br><span class="line">* UNKNW – Unkown operation</span><br></pre></td></tr></table></figure><h4 id="Enable"><a href="#Enable" class="headerlink" title="Enable"></a>Enable</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ lctl set_param mdt.$FNAME-MDT000<span class="number">0</span>.hsm_control=enabled</span><br><span class="line">$ lctl set_param -P  mdt.$FNAME-MDT000<span class="number">0</span>.hsm_control=enabled</span><br><span class="line">$ lctl set_param mdt.$FNAME-MDT000<span class="number">0</span>.hsm.max_requests=<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create user</span></span><br><span class="line">$ lctl --device $FNAME-MDT000<span class="number">0</span> changelog_register</span><br><span class="line"><span class="comment"># del user</span></span><br><span class="line">$ lctl --device fsname-MDT000<span class="number">0</span> changelog_deregister cl1</span><br><span class="line"><span class="comment"># Get the size</span></span><br><span class="line">$ lctl get_param mdd.$FNAME-MDT000<span class="number">0</span>.changelog_users mdd.$FNAME-MDT000<span class="number">0</span>.changelog_size</span><br><span class="line"></span><br><span class="line"><span class="comment"># changelog mask</span></span><br><span class="line">$ lctl set_param mdd.$FNAME-MDT*.changelog_mask=MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RNMFM RNMTO OPEN LYOUT TRUNC CLOSE IOCTL TRUNC SATTR XATTR HSM MTIME CTIME</span><br><span class="line">$ lctl get_param mdd.$FNAME-MDT*.changelog_mask</span><br><span class="line">MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the changelog</span></span><br><span class="line">$ lfs changelog $FNAME-MDT000<span class="number">0</span> &gt; lfs-changelog</span><br><span class="line">$ fs changelog $fsname-MDT000<span class="number">0</span> [startrec [endrec]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear all</span></span><br><span class="line">$ lctl changelog_clear mdt_name userid endrec</span><br><span class="line"><span class="string">``</span><span class="string">``</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Disable </span></span><br></pre></td></tr></table></figure><p>#Notify a device that user cl1 no longer needs records (up toand including 3)<br>$ lfs changelog_clear $FNAME-MDT0000 cl1 3</p><p>#To stop changelogs, changelog_mask should be set to MARK only<br>$ lctl set_param mdd.$FNAME-MDT0000.changelog_mask=MARK<br>mdd.lfs-MDT0000.changelog_mask=MARK</p><p>#or youcan set it -all<br>$ lctl set_param mdd.$FNAME-MDT0000.changelog_mask=-all</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### FSCK</span><br><span class="line">```bash</span><br><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: LDISKFS-fs error (device sdz): ldiskfs_lookup: unlinked inode <span class="number">5384166</span> <span class="keyword">in</span> dir #<span class="number">145170469</span></span><br><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: Remounting filesystem read-only</span><br></pre></td></tr></table></figure><h4 id="Flush-the-journal"><a href="#Flush-the-journal" class="headerlink" title="Flush the journal"></a>Flush the journal</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ umount /lfs</span><br><span class="line">$ mount -t ldiskfs /dev/sdx /lfs</span><br><span class="line">$ umount /lfs</span><br></pre></td></tr></table></figure><ul><li><p>Ensure e2fsprogs version ,it ‘s not default linux version ,it ‘s lfs version</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep e2fsprogs</span><br><span class="line">e2fsprogs-1.42.12.wc1-7.el6.x86_64</span><br><span class="line">e2fsprogs-libs-1.42.12.wc1-7.el6.x86_64</span><br></pre></td></tr></table></figure></li><li><p>Before fsck，make sure the mount point has been <font color=red>umount</font></p></li><li><p>Can check multiple MDT/OSTs in parallel</p></li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check only mode</span></span><br><span class="line">$ e2fsck -fn <span class="regexp">/dev/</span>sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prudent mode</span></span><br><span class="line">$ e2fsck -fp <span class="regexp">/dev/</span>sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Answer yes</span></span><br><span class="line">$ e2fsck -fy <span class="regexp">/dev/</span>sdx</span><br></pre></td></tr></table></figure><h4 id="re-writeconf"><a href="#re-writeconf" class="headerlink" title="re-writeconf"></a>re-writeconf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mds$ tunefs.lfs --writeconf /dev/sdx</span><br><span class="line">oss$ tunefs.lfs --writeconf /dev/ost0</span><br></pre></td></tr></table></figure><p>If MGS and MDT in single block device, you can add “-o nosvc” to avoid mount MDT</p><h3 id="User-group-quota"><a href="#User-group-quota" class="headerlink" title="User group quota"></a>User group quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## you can &#x27;t use lctl set_param, it &#x27;s not work</span></span><br><span class="line">mds $ lctl conf_param fsname.quota.ost|mdt=u|g|p|ugp|none</span><br><span class="line"></span><br><span class="line">mds $ lctl conf_param <span class="variable">$FNAME</span>.quota.mdt=ug</span><br><span class="line">mds $ cat /proc/fs/lfs/osd-ldiskfs/<span class="variable">$FNAME</span>-MDT0000/quota_slave/info</span><br><span class="line">mds $ lctl get_param osd-*.*.quota_slave.info</span><br><span class="line">quota enabled:  <span class="string">&quot;ug&quot;</span></span><br><span class="line">mds $ lctl conf_param <span class="variable">$FNAME</span>.quota.ost=ug</span><br><span class="line">or</span><br><span class="line">mds $ lctl set_param -P <span class="variable">$FNAME</span>.quota.ost=ug</span><br><span class="line"></span><br><span class="line"><span class="comment">### lctl set_param -P must reboot, no -P not work, if you don&#x27; t reboot ,you have too use conf_param</span></span><br><span class="line"></span><br><span class="line">client $ lfs setquota -u user1 -b 307200 -B 309200 -i 10000 -I 11000 /mnt/lfs</span><br><span class="line">client $ lfs setquota -g group1 -b 5120000 -B 5150000 -i 100000 -I 101000 /mnt/lfs</span><br><span class="line"></span><br><span class="line">client $ lfs quota –u user1 -v /mnt/lfs</span><br><span class="line">client $ lfs quota -t -p /mnt/lfs</span><br><span class="line">Block grace time: 1w; Inode grace time: 1w</span><br></pre></td></tr></table></figure><h3 id="Disable-the-ost"><a href="#Disable-the-ost" class="headerlink" title="Disable the ost"></a>Disable the ost</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mds $ mds lctl dl | grep osc</span><br><span class="line">8 UP osp lfs-OST0000-osc-MDT0000 lfs-MDT0000-mdtlov_UUID 5</span><br><span class="line"></span><br><span class="line">mds $ lctl --device 8 deactivate</span><br><span class="line">or </span><br><span class="line">mds $ lctl conf_param fsname-OST000.osc.active=0</span><br><span class="line">mds $ lctl --device MGS llog_print fsname-MDT0000</span><br><span class="line"></span><br><span class="line">mds $ lctl --device 8 activate</span><br></pre></td></tr></table></figure><h3 id="Skip-recovery"><a href="#Skip-recovery" class="headerlink" title="Skip recovery"></a>Skip recovery</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mds</span> $ mds lctl dl | grep osc</span><br><span class="line"><span class="attribute">8</span> UP mdt ltfs<span class="number">0</span>-MDT<span class="number">0000</span> ltfs<span class="number">0</span>-MDT<span class="number">0000</span>_UUID <span class="number">10</span></span><br><span class="line"><span class="attribute">mds</span> $ lctl dl | grep <span class="string">&quot;UP mdt&quot;</span> | awk &#x27;&#123;print $<span class="number">1</span>&#125;&#x27;</span><br><span class="line"><span class="attribute">8</span></span><br><span class="line"><span class="attribute">mds</span> $ lctl --device <span class="number">8</span> abort_recovery</span><br><span class="line"></span><br><span class="line"><span class="attribute">or</span> </span><br><span class="line"></span><br><span class="line"><span class="attribute">mount</span>.lfs xxx xxx -o abort_recov</span><br></pre></td></tr></table></figure><h3 id="lfs-migarate"><a href="#lfs-migarate" class="headerlink" title="lfs migarate"></a>lfs migarate</h3><p>Strong not recommand this command, because the command will cause loss the data, I suggest you copy data by index and checksum the copy file</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ lfs setstripe -c 1  -i 4 /lfs/dir1</span><br><span class="line">$ copy /lfs/old_dir1/file1 /lfs/dir1</span><br><span class="line">$ md5sum /lfs/old_dir1/file1 /lfs/dir1/file1</span><br><span class="line"></span><br><span class="line"><span class="comment"># dont &#x27;t use lfs migrate, it &#x27;s too dangerous, it will cause data loss</span></span><br><span class="line"><span class="comment">## lfs find /opt/lfswh -obd lfswh-OST000c_UUID -size +4G | lfs_migrate -y</span></span><br><span class="line"><span class="comment">## lfs migrate -c 1  -i 4 filepath</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### Job status</span></span><br><span class="line">```bash</span><br><span class="line">client $  lctl get_param jobid_var</span><br><span class="line">client $  jobid_var=<span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line">SLURM: jobid_var=SLURM_JOB_ID</span><br><span class="line">SGE: jobid_var=JOB_ID</span><br><span class="line">LSF: jobid_var=LSB_JOBID</span><br><span class="line">Loadleveler: jobid_var=LOADL_STEP_ID</span><br><span class="line">PBS: jobid_var=PBS_JOBID</span><br><span class="line">Maui/MOAB: jobid_var=PBS_JOBID</span><br><span class="line"><span class="comment"># Enable for sge</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=JOB_ID</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=<span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If there isn&#x27;t any job scheduler is running over the system, or user just want to collect the stats for process &amp; uid:</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=procname_uid</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check Job status</span></span><br><span class="line">oss $ lctl get_param obdfilter.testfs5-OST0004.job_stats</span><br><span class="line">job_stats:</span><br><span class="line">- job_id:          9158530</span><br><span class="line">  snapshot_time:   1503038800</span><br><span class="line">  read_bytes:      &#123; samples:           0, unit: bytes, min:       0, max:       0, sum:               0 &#125;</span><br><span class="line">  write_bytes:     &#123; samples:       32452, unit: bytes, min:  262144, max: 1048576, sum:     34009513984 &#125;</span><br><span class="line">  getattr:         &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  setattr:         &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># get mdt ops</span></span><br><span class="line">mds $ lctl get_param mdt.*.job_stats</span><br><span class="line">mds $ lctl get_param  mdt.testfs5-MDT0000.job_stats</span><br><span class="line">mdt.testfs5-MDT0000.job_stats=</span><br><span class="line">job_stats:</span><br><span class="line">- job_id:          278685</span><br><span class="line">  snapshot_time:   1503068243</span><br><span class="line">  open:            &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  close:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  mknod:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  link:            &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  unlink:          &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  mkdir:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># clear stats for all job on testfs-OST0001</span></span><br><span class="line">oss $ lctl set_param obdfilter.testfs-OST0001.job_stats=clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear stats for job &quot;dd.0&quot; on lfs-MDT0000</span></span><br><span class="line">mds $ lctl set_param mdt.lfs-MDT0000.job_stats=dd.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># cleanup interval (seconds)</span></span><br><span class="line">lctl set_param -P testfs5.mdt.job_cleanup_interval=604800</span><br><span class="line">lctl set_param  testfs5.mdt.job_cleanup_interval=604800</span><br><span class="line">mds $  cat /proc/fs/lfs/mdt/testfs5-MDT0000/job_cleanup_interval</span><br></pre></td></tr></table></figure><h3 id="lfs-fid-and-path"><a href="#lfs-fid-and-path" class="headerlink" title="lfs fid and path"></a>lfs fid and path</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[client]<span class="comment"># lfs fid2path /mnt      [0x200000400:0x1:0x0]</span></span><br><span class="line">                                       |<span class="string">         </span>|<span class="string">   </span>|</span><br><span class="line">                                       |<span class="string">         </span>|<span class="string">   -- version</span></span><br><span class="line"><span class="string">                                       </span>|<span class="string">         ---- object id</span></span><br><span class="line"><span class="string">                                       ----------Sequence</span></span><br><span class="line"><span class="string">[client]# lfs path2fid /mnt</span></span><br><span class="line"><span class="string">[0x200000007:0x1:0x0]</span></span><br></pre></td></tr></table></figure><h3 id="increase-openzfs-sync-performance-in-test-env"><a href="#increase-openzfs-sync-performance-in-test-env" class="headerlink" title="increase openzfs sync performance in test env"></a>increase openzfs sync performance in test env</h3><p><code>this setting will cause data loss, if client roll back log failed</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lctl set_param osd-zfs.*.osd_obj_sync_delay_us=0</span><br><span class="line">or</span><br><span class="line">lctl set_param osd-zfs.*.osd_object_sync_delay_us=0</span><br><span class="line">or</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/module/osd_zfs/parameters/osd_object_sync_delay_us</span><br><span class="line"></span><br><span class="line"><span class="comment">## to default</span></span><br><span class="line"><span class="built_in">echo</span> -1 &gt; /sys/module/osd_zfs/parameters/osd_object_sync_delay_us</span><br><span class="line">osd_object_sync_delay_us</span><br><span class="line">To improve fsync() performance until ZIL device,it is possible <span class="built_in">disable</span> the code <span class="built_in">which</span> causes Lfs to block waiting on a TXG to sync</span><br></pre></td></tr></table></figure><h3 id="Lfs-issues"><a href="#Lfs-issues" class="headerlink" title="Lfs issues"></a>Lfs issues</h3><h4 id="Don-‘t-use-openzfs-with-lfs-file-system"><a href="#Don-‘t-use-openzfs-with-lfs-file-system" class="headerlink" title="Don ‘t use openzfs with lfs file system"></a>Don ‘t use openzfs with lfs file system</h4><ul><li>No bility to support openzfs</li><li>If your zpool brain split, they will not show you any help</li><li>If you enable openzfs MMP, if single HDD will broken, your zpool have to suspend once<ul><li><a href="https://github.com/zfsonlinux/zfs/issues/7045">https://github.com/zfsonlinux/zfs/issues/7045</a><ul><li><a href="https://github.com/zfsonlinux/zfs/issues/7118">https://github.com/zfsonlinux/zfs/issues/7118</a></li><li>this issue impact from zfs 0.7 to 0.7.9, I ‘m not sure 0.8 has the same issue, the best way is disable MMP and use single link for your SAS devices</li></ul></li></ul></li></ul><h4 id="Multipath-failed-cause"><a href="#Multipath-failed-cause" class="headerlink" title="Multipath failed cause"></a>Multipath failed cause</h4><ul><li>Found error log; <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi 14:0:5:31: attempting task abort! scmd(ffff97ac51784a80)</span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi 14:0:5:31: [sg64] tag<span class="comment">#76 CDB: Read(6) 08 00 02 61 01 00</span></span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi target14:0:5: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c66c014), phy(4)</span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi target14:0:5: enclosurelogical id(0x51866da0a8a62200), slot(4)</span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi target14:0:5: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:16:01 lfs-node21 systemd: Started Session 361698 of user root.</span><br><span class="line">Sep 22 03:16:01 lfs-node21 systemd: Starting Session 361698 of user root.</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: sd 14:0:5:6: attempting task abort! scmd(ffff97b2ae507b80)</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: sd 14:0:5:6: [sdp] tag<span class="comment">#8 CDB: Write(16) 8a 00 00 00 00 07 c6 2a 89 e8 00 00 08 00 00 00</span></span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: scsi target14:0:5: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c66c014), phy(4)</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: scsi target14:0:5: enclosurelogical id(0x51866da0a8a62200), slot(4)</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: scsi target14:0:5: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:16:30 lfs-node21 kernel: mpt3sas_cm3: Command Timeout</span><br><span class="line">Sep 22 03:16:30 lfs-node21 kernel: mf:<span class="comment">#012#0110100000a 00000100 00000000 00001f00 00000000 00000000 00000000 00000000 #012#01100000000 00000000 00000000 00000000 0000004d</span></span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi 13:0:0:31: attempting task abort! scmd(ffff97bc6aad1c00)</span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi 13:0:0:31: [sg45] tag<span class="comment">#197 CDB: Read(6) 08 00 02 00 01 00</span></span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi target13:0:0: _scsih_tm_display_info: handle(0x0009), sas_address(0x500a098b4c6c3014), phy(0)</span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi target13:0:0: enclosurelogical id(0x51866da0a8a62100), slot(0)</span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi target13:0:0: enclosure level(0x0000), connector name( 0   )</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: sd 13:0:1:6: attempting task abort! scmd(ffff97b2ae506680)</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: sd 13:0:1:6: [sdap] tag<span class="comment">#4 CDB: Write(16) 8a 00 00 00 00 07 c5 fd 27 10 00 00 08 00 00 00</span></span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: scsi target13:0:1: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c5d9014), phy(4)</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: scsi target13:0:1: enclosurelogical id(0x51866da0a8a62100), slot(4)</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: scsi target13:0:1: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:16:40 lfs-node21 kernel: mpt3sas_cm3: sending diag reset !!</span><br><span class="line">Sep 22 03:16:41 lfs-node21 kernel: mpt3sas_cm3: diag reset: SUCCESS</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: IOC Number : 0</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: CurrentHostPageSize is 0: Setting default host page size to 4k</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: FW Package Version(16.17.00.03)</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: LSISAS3008: FWVersion(16.00.04.00), ChipRevision(0x02), BiosVersion(18.00.00.00)</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: Dell 12Gbps SAS HBA</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: Protocol=(Initiator,Target), Capabilities=(TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: sending port <span class="built_in">enable</span> !!</span><br><span class="line"></span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: sdbb - rdac checker reports path is down: inquiry failed</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: checker failed path 67:80 <span class="keyword">in</span> map 3600a098000b4c3060000024359244375</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: remaining active paths: 1</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 8:240: reinstated</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: sdbg: mark as failed</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c66c0000020d59243745: remaining active paths: 1</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: sdbi: mark as failed</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c66c00000213592437d2: remaining active paths: 1</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdu, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdv, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdw, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdx, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdy, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdar, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdas, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdat, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdau, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdav, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdaw, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdax, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sday, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdaz, open() failed: No such device</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: sdbb - rdac checker reports path is upa</span><br><span class="line"></span><br><span class="line"><span class="comment">### All devices single link offline at the same time, I have 4 x 9300-8E, impossible offline at the same time</span></span><br><span class="line"><span class="comment">### Filter all error devices and make sure just single HBA status not correct, and you can found mpt3sas_cm0 in the system message</span></span><br><span class="line"></span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: sdbb - rdac checker reports path is up</span><br><span class="line">Sep 22 03:32:14 lfs-node21 kernel: device-mapper: multipath: Reinstating path 67:80.</span><br><span class="line">Sep 22 03:32:14 lfs-node21 kernel: device-mapper: multipath: Reinstating path 67:160.</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 67:80: reinstated</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: remaining active paths: 2</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c0000020d59243745: sdbg - rdac checker reports path is up</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 67:160: reinstated</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c0000020d59243745: remaining active paths: 2</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c00000213592437d2: sdbi - rdac checker reports path is up</span><br><span class="line">Sep 22 03:32:14 lfs-node21 kernel: device-mapper: multipath: Reinstating path 67:192.</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 67:192: reinstated</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c00000213592437d2: remaining active paths: 2</span><br><span class="line"></span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi 1:0:0:31: attempting task abort! scmd(ffff97b265c7b2c0)</span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi 1:0:0:31: [sg9] tag<span class="comment">#17 CDB: Read(6) 08 00 02 00 01 00</span></span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi target1:0:0: _scsih_tm_display_info: handle(0x0009), sas_address(0x500a098b4c834014), phy(0)</span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi target1:0:0: enclosurelogical id(0x51866da09fad6700), slot(0)</span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi target1:0:0: enclosure level(0x0000), connector name( 0   )</span><br><span class="line">Sep 22 03:34:46 lfs-node21 kernel: mpt3sas_cm0: Command Timeout</span><br><span class="line">Sep 22 03:34:46 lfs-node21 kernel: mf:<span class="comment">#012#01101000009 00000100 00000000 00001f00 00000000 00000000 00000000 00000000 #012#01100000000 00000000 00000000 00000000 00000012</span></span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: sd 1:0:1:24: attempting task abort! scmd(ffff97a35d8c9500)</span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: sd 1:0:1:24: [sdk] tag<span class="comment">#42 CDB: Read(16) 88 00 00 00 00 09 1f 1d 30 00 00 00 00 08 00 00</span></span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: scsi target1:0:1: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c810014), phy(4)</span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: scsi target1:0:1: enclosurelogical id(0x51866da09fad6700), slot(4)</span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: scsi target1:0:1: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:34:56 lfs-node21 kernel: mpt3sas_cm0: sending diag reset !!</span><br><span class="line">Sep 22 03:34:57 lfs-node21 kernel: mpt3sas_cm0: diag reset: SUCCESS</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: IOC Number : 0</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: CurrentHostPageSize is 0: Setting default host page size to 4k</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: FW Package Version(16.17.00.03)</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: LSISAS3008: FWVersion(16.00.04.00), ChipRevision(0x02), BiosVersion(18.00.00.00)</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: Dell 12Gbps SAS HBA</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: Protocol=(Initiator,Target), Capabilities=(TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: sending port <span class="built_in">enable</span> !!</span><br><span class="line"></span><br><span class="line"><span class="comment"># del the others</span></span><br><span class="line"></span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: port <span class="built_in">enable</span>: SUCCESS</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: handle(0x0009), sas_address(0x500a098b4c834014), port: 255</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: enclosure logical id(0x51866da09fad6700), slot(0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:1: handle(0x000a), sas_address(0x500a098b4c810014), port: 255</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:1: enclosure logical id(0x51866da09fad6700), slot(4)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: <span class="comment">#011break from _scsih_search_responding_sas_devices: ioc_status(0x0022), loginfo(0x310f0400)</span></span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> end-devices: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> PCIe end-devices: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> expanders: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> expanders: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi 1:0:0:31: task abort: SUCCESS scmd(ffff97b265c7b2c0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: sas end-devices</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: pcie end-devices</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: expanders</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: scan devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: sd 1:0:0:13: attempting task abort! scmd(ffff97b37ad6a4c0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: sd 1:0:0:13: [sdg] tag<span class="comment">#89 CDB: Inquiry 12 01 c9 00 30 00</span></span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: _scsih_tm_display_info: handle(0x0009), sas_address(0x500a098b4c834014), phy(0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: enclosurelogical id(0x51866da09fad6700), slot(0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: enclosure level(0x0000), connector name( 0   )</span><br></pre></td></tr></table></figure>Single link offline, after reset the link attch back, and try to recovery the connnection</li></ul><p>But lfs has a <a href="https://jira.whamcloud.com/browse/LU-10510">bug, LU-10510</a>, lfs will modify the value when it mount, but the designer not consider link/HBA/IO expander offline or some reason cause the value back to default value. what a pity, the operate (modify to 16383) only trigger on mount.lfs operation, the link back to recovery the connection ? no way.</p><p>It ‘s a simple logic. Why the desiger not consider the link offline ? I can ‘t understand. it must be an intern.<br>When the link recovery, the max_sectors_kb recovery to default value (512)<br>You have to use echo 16383 to improve it, why 16383, sorry , I don ‘t know.<br>Does the lfs system rigorous enough ? hahahahaahaha……………….<br>Does is it for Enterprise file system ? hahahahahahaha……………….</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ grep . /sys/block/*/queue/max_sectors_kb</span><br><span class="line">/sys/block/sdak/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdal/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdal/queue/max_sectors_kb 512</span><br><span class="line">/sys/block/sda/queue/max_hw_sectors_kb 256</span><br><span class="line">/sys/block/sda/queue/max_sectors_kb 256</span><br><span class="line">/sys/block/sdba/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdba/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdbb/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbb/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdbc/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbc/queue/max_sectors_kb 512</span><br><span class="line">/sys/block/sdbd/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbd/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdbe/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbe/queue/max_sectors_kb 512</span><br><span class="line">/sys/block/sdbf/queue/max_hw_sectors_kb 16383</span><br><span class="line"></span><br><span class="line">it could cause the multipath error too.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:176.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:160.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:240.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:240.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:144.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:144.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:176.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:176.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:240.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:240.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:144.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:176.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:240.</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    0.02   47.92    0.00   52.06</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00    67.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdc               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdi               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdf               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdd               0.00     0.00    0.00    0.00     0.00     0.00     0.00   104.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdh               0.00     0.00    0.00    0.00     0.00     0.00     0.00    31.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdj               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdk               0.00     0.00    0.00    0.00     0.00     0.00     0.00    63.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdl               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdm               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdn               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdo               0.00     0.00    0.00    0.00     0.00     0.00     0.00    64.00    0.00    0.00    0.00   0.00 100.00</span><br></pre></td></tr></table></figure><h4 id="disable-OSS-read-cache"><a href="#disable-OSS-read-cache" class="headerlink" title="disable OSS read cache"></a>disable OSS read cache</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#disable read cache on all the OSTs of an OSS</span></span><br><span class="line">$ lctl set_param osd-ldiskfs.*.read_cache_enable=0</span><br><span class="line"></span><br><span class="line"><span class="comment">#re-enable read cache </span></span><br><span class="line">$ lctl set_param osd-ldiskfs.&#123;OST_name&#125;.read_cache_enable=1</span><br><span class="line">$ lctl get_param osd-ldiskfs.*.read_cache_enable</span><br></pre></td></tr></table></figure><p>writethrough_cache_enable - Controls whether data sent to the OSS as a write request is kept in the read cache and available for later reads, or if it is discarded from cache when the write is completed. By default, the writethrough cache is enabled (writethrough_cache_enable=1).</p><p>If the writethrough cache is disabled (writethrough_cache_enabled=0), the OSS discards the data after the write request from the client is completed. For subsequent read requests, or partial-page write requests, the OSS must re-read the data from disk.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#disable writethrough_cache</span></span><br><span class="line">$ lctl osd-ldiskfs.*.read_cache_enable=0</span><br><span class="line">$ lctl set_param osd-ldiskfs.*.writethrough_cache_enable=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># re-enable </span></span><br><span class="line">$ lctl set_param osd-ldiskfs.&#123;OST_name&#125;.writethrough_cache_enable=1</span><br><span class="line">$ lctl get_param osd-ldiskfs.*.writethrough_cache_enable</span><br></pre></td></tr></table></figure><p>readcache_max_filesize - Controls the maximum size of a file that both the read cache and writethrough cache will try to keep in memory. Files larger than readcache_max_filesize will not be kept in cache for either reads or writes.</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ lctl <span class="keyword">set</span>_param obdfilter.*<span class="string">.readcache_max_filesize=32M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#disable the maxinum cached file size on the OST</span></span><br><span class="line">$ lctl <span class="keyword">set</span>_param obdfilter.&#123;OST_name&#125;<span class="string">.readcache_max_filesize=-1</span></span><br><span class="line">$ lctl get_param obdfilter.*<span class="string">.readcache_max_filesize</span></span><br></pre></td></tr></table></figure><h3 id="client-metadata-setting"><a href="#client-metadata-setting" class="headerlink" title="client metadata setting"></a>client metadata setting</h3><p>The MDC max_rpcs_in_flight parameter defines the maximum number of metadata RPCs, both modifying and non-modifying RPCs, that can be sent in parallel by a client to a MDT target. This includes every file system metadata operations, such as file or directory stat, creation, unlink. The default setting is 8, minimum setting is 1 and maximum setting is 256.</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client $ lctl <span class="keyword">set</span>_param mdc.*<span class="string">.max_rpcs_in_flight=16</span></span><br></pre></td></tr></table></figure><p>The MDC max_mod_rpcs_in_flight parameter defines the maximum number of file system modifying RPCs that can be sent in parallel by a client to a MDT target. For example, the Lfs client sends modify RPCs when it performs file or directory creation, unlink, access permission modification or ownership modification. The default setting is 7, minimum setting is 1 and maximum setting is 256.</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clinet $  lctl <span class="keyword">set</span>_param mdc.*<span class="string">.max_mod_rpcs_in_flight=12</span></span><br></pre></td></tr></table></figure><p>The max_mod_rpcs_in_flight value must be strictly less than the max_rpcs_in_flight value. It must also be less or equal to the MDT max_mod_rpcs_per_client value. If one of theses conditions is not enforced, the setting fails and an explicit message is written in the Lfs log.</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mds $ echo <span class="number">12</span> &gt; <span class="regexp">/sys/m</span>odule<span class="regexp">/mdt/</span>parameters/max_mod_rpcs_per_client</span><br></pre></td></tr></table></figure><h3 id="record-several-years-ago-trace-the-file-by-debugfs"><a href="#record-several-years-ago-trace-the-file-by-debugfs" class="headerlink" title="record several years ago trace the file by debugfs"></a>record several years ago trace the file by debugfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=RHEL5.5_x86_64.iso of=rhel5-1 bs=1M count=1 oflag=sync</span><br><span class="line"></span><br><span class="line">$ cat $(blktrace.log)</span><br><span class="line">  8,32   0     2591  1720.406537446 14972  Q   W 19144704 + 2048 [ll_ost_io00_002]</span><br><span class="line">  8,32   0     2592  1720.406539742 14972  G   W 19144704 + 2048 [ll_ost_io00_002]</span><br><span class="line">  8,32   0     2593  1720.406542136 14972  P   N [ll_ost_io00_002]</span><br><span class="line">  8,32   0     2594  1720.406543690 14972  I   W 19144704 + 2048 [ll_ost_io00_002]</span><br><span class="line"></span><br><span class="line">$ line=19144704</span><br><span class="line">$ debugfs -c -R <span class="string">&quot;icheck <span class="subst">$(($line/8)</span>)&quot;</span> /dev/sdc</span><br><span class="line">debugfs 1.42.12.wc1 (15-Sep-2014)</span><br><span class="line">/dev/sdc: catastrophic mode - not reading inode or group bitmaps</span><br><span class="line">BlockInode number</span><br><span class="line">23930882623</span><br><span class="line">$ debugfs -R <span class="string">&quot;ncheck 2623&quot;</span> /dev/sdc</span><br><span class="line">debugfs 1.42.12.wc1 (15-Sep-2014)</span><br><span class="line">InodePathname</span><br><span class="line">2623/O/0/d13/2669</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lfs getstripe rhel5-1</span><br><span class="line">rhel5-1</span><br><span class="line">lmm_stripe_count:   1</span><br><span class="line">lmm_stripe_size:    1048576</span><br><span class="line">lmm_pattern:        1</span><br><span class="line">lmm_layout_gen:     0</span><br><span class="line">lmm_stripe_offset:  3</span><br><span class="line">lmm_pool:           OST0003</span><br><span class="line">obdidx objid objid group</span><br><span class="line">     3          2669        0xa6d             0</span><br><span class="line"></span><br><span class="line">$ debugfs -c -R <span class="string">&quot;stat &lt;2623&gt;&quot;</span> /dev/sdc</span><br><span class="line">debugfs 1.42.12.wc1 (15-Sep-2014)</span><br><span class="line">/dev/sdc: catastrophic mode - not reading inode or group bitmaps</span><br><span class="line">Inode: 2623   Type: regular    Mode:  0666   Flags: 0x80000</span><br><span class="line">Generation: 2790813459    Version: 0x00000005:00002bf8</span><br><span class="line">User:     0   Group:     0   Size: 1048576</span><br><span class="line">File ACL: 0    Directory ACL: 0</span><br><span class="line">Links: 1   Blockcount: 2048</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line"> ctime: 0x5715e344:00000000 -- Tue Apr 19 15:50:28 2016</span><br><span class="line"> atime: 0x00000000:00000000 -- Thu Jan  1 08:00:00 1970</span><br><span class="line"> mtime: 0x5715e344:00000000 -- Tue Apr 19 15:50:28 2016</span><br><span class="line">crtime: 0x57148057:dfa2ff44 -- Mon Apr 18 14:36:07 2016</span><br><span class="line">Size of extra inode fields: 28</span><br><span class="line">Extended attributes stored <span class="keyword">in</span> inode body:</span><br><span class="line">  lma = <span class="string">&quot;08 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 6d 0a 00 00 00 00 00 00 &quot;</span> (24)</span><br><span class="line">  lma: fid=[0x100000000:0xa6d:0x0] compat=8 incompat=0</span><br><span class="line">  fid = <span class="string">&quot;d2 0b 00 00 02 00 00 00 40 00 00 00 00 00 00 00 &quot;</span> (16)</span><br><span class="line">  fid: parent=[0x200000bd2:0x40:0x0] stripe=0</span><br><span class="line">EXTENTS:</span><br><span class="line">(0-255):2393088-2393343</span><br><span class="line"></span><br><span class="line">$ lfs fid2path /opt/ [0x200000bd2:0x40:0x0]</span><br><span class="line">/opt/OST0003/rhel5-1</span><br></pre></td></tr></table></figure><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ lctl get_param osc.testfs-OST0001*.*max*</span><br><span class="line">$ lctl get_param osc.testfs-OST0001*.*grant*</span><br><span class="line"></span><br><span class="line">client</span><br><span class="line">$ lctl get_param llite.*.stats</span><br><span class="line"></span><br><span class="line">#OSS</span><br><span class="line">$ lctl get_param obdfilter.*.brw_stats</span><br><span class="line">obdfilter.testfs-OST0000.brw_stats=</span><br><span class="line">snapshot_time:         <span class="number">1593407004.726097825</span> (secs.nsecs)</span><br><span class="line"></span><br><span class="line">                           read      |     write</span><br><span class="line">pages per bulk r/w     rpcs  % cum % |  rpcs        % cum %</span><br><span class="line"><span class="number">1</span>:   <span class="number">6006159</span>   <span class="number">2</span>   <span class="number">2</span>   | <span class="number">1239974</span>   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">2</span>:  <span class="number">45845506</span>  <span class="number">16</span>  <span class="number">18</span>   | <span class="number">1809852</span>   <span class="number">2</span>   <span class="number">4</span></span><br><span class="line"><span class="number">4</span>:   <span class="number">1952464</span>   <span class="number">0</span>  <span class="number">18</span>   | <span class="number">53814</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">8</span>:  <span class="number">33533746</span>  <span class="number">11</span>  <span class="number">30</span>   | <span class="number">832520</span>   <span class="number">1</span>   <span class="number">5</span></span><br><span class="line"><span class="number">16</span>:  <span class="number">12859649</span>   <span class="number">4</span>  <span class="number">35</span>   | <span class="number">91425</span>   <span class="number">0</span>   <span class="number">5</span></span><br><span class="line"><span class="number">32</span>:    <span class="number">620131</span>   <span class="number">0</span>  <span class="number">35</span>   | <span class="number">81660</span>   <span class="number">0</span>   <span class="number">5</span></span><br><span class="line"><span class="number">64</span>:  <span class="number">38856531</span>  <span class="number">13</span>  <span class="number">49</span>   | <span class="number">307195</span>   <span class="number">0</span>   <span class="number">5</span></span><br><span class="line"><span class="number">128</span>:   <span class="number">1697223</span>   <span class="number">0</span>  <span class="number">49</span>   | <span class="number">223084</span>   <span class="number">0</span>   <span class="number">6</span></span><br><span class="line"><span class="number">256</span>: <span class="number">142793845</span>  <span class="number">50</span> <span class="number">100</span>   | <span class="number">69219436</span>  <span class="number">93</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">                           read      |     write</span><br><span class="line">discontiguous pages    rpcs  % cum % |  rpcs        % cum %</span><br><span class="line"><span class="number">0</span>: <span class="number">284165254</span> <span class="number">100</span> <span class="number">100</span>   | <span class="number">1244480</span>   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">1</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">1810011</span>   <span class="number">2</span>   <span class="number">4</span></span><br><span class="line"><span class="number">2</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">14961</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">3</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">38853</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">4</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">10409</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">5</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">23853</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"></span><br><span class="line">$ lctl get_param ost.OSS.ost_io.req_history</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">### [lfs zfs direct IO support](https:<span class="comment">//lfs-discuss.lfs.narkive.com/S7kbvnG2/lfs-on-zfs-pooer-direct-i-o-performance)</span></span><br><span class="line">```bash</span><br><span class="line">John, with newer Lfs clients it <span class="keyword">is</span> possible <span class="keyword">for</span> multiple threads to submit non-overlapping writes concurrently (also <span class="keyword">not</span> conflicting within a single page), see LU<span class="number">-1669</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Even so, O_DIRECT writes need to be synchronous to disk on the OSS, as Patrick reports, because <span class="keyword">if</span> the OSS fails before the write <span class="keyword">is</span> on disk there <span class="keyword">is</span> no cached copy of the data on the client that can be used to resend the RPC.</span><br><span class="line"></span><br><span class="line">The problem <span class="keyword">is</span> that the ZFS OSD has very long transaction commit times <span class="keyword">for</span> synchronous writes because it does <span class="keyword">not</span> yet have support <span class="keyword">for</span> the ZIL. Using buffered writes, <span class="keyword">or</span> having very large O_DIRECT writes (e.g. <span class="number">40</span>MB <span class="keyword">or</span> larger) <span class="keyword">and</span> large RPCs (<span class="number">4</span>MB, <span class="keyword">or</span> up to <span class="number">16</span>MB <span class="keyword">in</span> <span class="number">2.9</span><span class="number">.0</span>) to amortize the sync overhead may be beneficial <span class="keyword">if</span> you really want to use O_DIRECT.</span><br></pre></td></tr></table></figure><h3 id="Got-the-client-uuid-map-nid"><a href="#Got-the-client-uuid-map-nid" class="headerlink" title="Got the client uuid map nid"></a>Got the client uuid map nid</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/fs/lfs/nodemap/default/exports</span><br><span class="line"><span class="comment"># too many....          </span></span><br><span class="line">&#123; nid: 192.168.11.1@tcp, uuid: b19f57a2-d206-41ea-0c1e-e13650c4de6d &#125;</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ost/OSS/ost/timeouts</span><br><span class="line">  <span class="built_in"> service </span>: cur  50  worst  92 (at 1616674042, 8947s ago)   3  18   1   3</span><br><span class="line">  <span class="built_in"> service </span>: cur  50  worst  50 (at 1616674036, 8953s ago)   1   1   1   1</span><br></pre></td></tr></table></figure><h3 id="lnet"><a href="#lnet" class="headerlink" title="lnet"></a><a href="http://wiki.lfsfs.cn/index.php?title=LNet%E8%B7%AF%E7%94%B1%E5%99%A8%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97">lnet</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Servers:</span><br><span class="line">options lnet networks=<span class="string">&quot;o2ib1(ib0)&quot;</span> routes=<span class="string">&quot;o2ib2 10.10.0.20@o2ib1&quot;</span></span><br><span class="line">Routers:</span><br><span class="line">options lnet networks=<span class="string">&quot;o2ib1(ib0),o2ib2(ib1)&quot;</span> <span class="string">&quot;forwarding=enabled&quot;</span></span><br><span class="line">Clients:</span><br><span class="line">options lnet networks=<span class="string">&quot;o2ib2(ib0)&quot;</span> routes=<span class="string">&quot;o2ib1 10.20.0.29@o2ib2&quot;</span> </span><br><span class="line"></span><br><span class="line">Servers:</span><br><span class="line">lnetctl net add --net o2ib1 --<span class="keyword">if</span> ib0,ib1</span><br><span class="line">lnetctl route add --net o2ib2 --gateway 10.10.0.20@o2ib1</span><br><span class="line">lnetctl peer add --nid 10.10.0.20@o2ib1,10.10.0.21@o2ib1</span><br><span class="line"> </span><br><span class="line">Routers:</span><br><span class="line">lnetctl net add --net o2ib1 --<span class="keyword">if</span> ib0,ib1</span><br><span class="line">lnetctl net add --net o2ib2 --<span class="keyword">if</span> ib2,ib3</span><br><span class="line">lnetctl peer add --nid 10.10.0.1@o2ib1,10.10.0.2@o2ib1</span><br><span class="line">lnetctl peer add --nid 10.20.0.1@o2ib2,10.20.0.2@o2ib2</span><br><span class="line">lnetctl <span class="built_in">set</span> routing 1</span><br><span class="line">   </span><br><span class="line">Clients:</span><br><span class="line">lnetctl net add --net o2ib2 --<span class="keyword">if</span> ib0,ib1</span><br><span class="line">lnetctl route add --net o2ib1 --gateway 10.20.0.29@o2ib2</span><br><span class="line">lnetctl peer add --nid 10.20.0.29@o2ib2,10.20.0.30@o2ib2</span><br><span class="line"></span><br><span class="line">$ lnetctl <span class="built_in">export</span> FILE.yaml</span><br><span class="line">$ lnetctl <span class="built_in">export</span> &gt; FILE.yaml</span><br><span class="line">$ lnetctl import FILE.yaml</span><br><span class="line">$ lnetctl import &lt; FILE.yaml </span><br></pre></td></tr></table></figure><p>Parameters</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mark the route status, set 0 means disable</span></span><br><span class="line">options lnet auto_down=1 </span><br><span class="line"></span><br><span class="line"><span class="comment"># avoid_asym_router_failure, avoid push data to the block route cause data loss</span></span><br><span class="line">options lnet avoid_asym_router_failure=1 </span><br><span class="line"></span><br><span class="line"><span class="comment"># ping check the active route time interval, default: 60s</span></span><br><span class="line">options lnet live_router_check_interval=50  </span><br><span class="line"></span><br><span class="line"><span class="comment"># dead_router_check_interval, default:60s</span></span><br><span class="line">options lnet dead_router_check_interval=50 </span><br><span class="line"></span><br><span class="line"><span class="comment"># ping timeout</span></span><br><span class="line">options lnet router_ping_timeout=60</span><br><span class="line"></span><br><span class="line"><span class="comment"># check the route status from</span></span><br><span class="line">$ cat /sys/kernel/debug/lnet/stats</span><br><span class="line">0 23 0 49912 49912 0 0 18468672 27625832 0 0</span><br><span class="line"></span><br><span class="line">$ lnetctl stats show</span><br><span class="line">statistics:</span><br><span class="line">    msgs_alloc: 0</span><br><span class="line">    msgs_max: 23</span><br><span class="line">    rst_alloc: 0</span><br><span class="line">    errors: 0</span><br><span class="line">    send_count: 49912</span><br><span class="line">    resend_count: 0</span><br><span class="line">    response_timeout_count: 0</span><br><span class="line">    local_interrupt_count: 0</span><br><span class="line">    local_dropped_count: 0</span><br><span class="line">    local_aborted_count: 0</span><br><span class="line">    local_no_route_count: 0</span><br><span class="line">    local_timeout_count: 0</span><br><span class="line">    local_error_count: 0</span><br><span class="line">    remote_dropped_count: 0</span><br><span class="line">    remote_error_count: 0</span><br><span class="line">    remote_timeout_count: 0</span><br><span class="line">    network_timeout_count: 0</span><br><span class="line">    recv_count: 49912</span><br><span class="line">    route_count: 0</span><br><span class="line">    drop_count: 0</span><br><span class="line">    send_length: 18468672</span><br><span class="line">    recv_length: 27625832</span><br><span class="line">    route_length: 0</span><br><span class="line">    drop_length: 0</span><br></pre></td></tr></table></figure><p>OPA setting</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> ko2iblnd-opa ko2iblnd</span><br><span class="line">options ko2iblnd-opa peer_credits=128 peer_credits_hiw=64 credits=1024 concurrent_sends=256 ntx=2048 map_on_demand=32 fmr_pool_size=2048 fmr_flush_trigger=512 fmr_cache=1</span><br><span class="line"></span><br><span class="line">//The default value is 8, /sys/kernel/debug/lnet/peers, LNet使用peer_credits和network_interface_credits通过网络发送块大小固定为1MB的数据。peer_credits参数管理可以同时发送到单个对等节点的并行数量</span><br><span class="line">ko2iblnd-opa peer_credits=128  </span><br><span class="line"></span><br><span class="line">增加peer_credits的数量并不一定能获得良好的性能，因为在大型的配置中，增加数量会导致网络过载并增加OFED堆栈的内存利用率。可调参数network interface credits(credits)能够限制并行发送到单个网络的数量，并通过proc/sys/lnet/nis接口进行监控。可以通过特定Lustre网络驱动程序(LND)的模块参数来增加network interface credits的数量:</span><br><span class="line">// The default value is 64 and is shared across all the CPU partitions (CPTs).</span><br><span class="line">ko2iblnd-opa credits=1024 </span><br><span class="line"></span><br><span class="line">// The default value is 0</span><br><span class="line">ko2iblnd-opa map_on_demand=32 </span><br></pre></td></tr></table></figure><h4 id="lnet-health"><a href="#lnet-health" class="headerlink" title="lnet health"></a><a href="http://wiki.lfsfs.cn/index.php?title=LNet%E5%81%A5%E5%BA%B7%E5%8A%9F%E8%83%BD%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C">lnet health</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the more value, the long recovery time, the default is disabled means lnet_health_sensitivity and lnet_retry_count set to 0</span></span><br><span class="line">$ lnetctl <span class="built_in">set</span> health_sensitivity: sensitivity to failure</span><br><span class="line">        0 - turn off health evaluation</span><br><span class="line">        &gt;0 - sensitivity value not more than 1000</span><br><span class="line"></span><br><span class="line">$ lnetctl <span class="built_in">set</span> recovery_interval: interval to ping unhealthy interfaces</span><br><span class="line">        &gt;0 - timeout <span class="keyword">in</span> seconds</span><br><span class="line"></span><br><span class="line">$ lnetctl <span class="built_in">set</span> retry_count: number of retries</span><br><span class="line">        0 - turn of retries</span><br><span class="line">        &gt;0 - number of retries</span><br><span class="line"></span><br><span class="line"><span class="comment">###Important</span></span><br><span class="line">$ lnetctl <span class="built_in">set</span> transaction_timeout: Message/Response timeout</span><br><span class="line">        &gt;0 - timeout <span class="keyword">in</span> seconds</span><br><span class="line"></span><br><span class="line">lnet_lnd_timeout = lnet_transaction_timeout / retry_count</span><br><span class="line"></span><br><span class="line"><span class="comment">### dump all config</span></span><br><span class="line">$ lnetctl global show</span><br><span class="line">global:</span><br><span class="line">    numa_range: 0</span><br><span class="line">    max_intf: 200</span><br><span class="line">    discovery: 1</span><br><span class="line">    drop_asym_route: 0</span><br><span class="line">    retry_count: 2</span><br><span class="line">    transaction_timeout: 50</span><br><span class="line">    health_sensitivity: 100</span><br><span class="line">    recovery_interval: 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># show local health</span></span><br><span class="line">$ lnetctl net show -v 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># show remote health</span></span><br><span class="line">$ lnetctl peer show -v 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># show status</span></span><br><span class="line">$ lnetctl stats show</span><br></pre></td></tr></table></figure><h3 id="ban-the-lfs-client"><a href="#ban-the-lfs-client" class="headerlink" title="ban the lfs client"></a>ban the lfs client</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;192.168.1.1@tcp1&#x27;</span> &gt; /proc/fs/lfs/obdfilter/fsname-OST0000/evict_client</span><br></pre></td></tr></table></figure><h3 id="rocev2-test"><a href="#rocev2-test" class="headerlink" title="rocev2 test"></a>rocev2 test</h3><p><a href="http://blog.sysu.tech/RoCE/OpenMPI%E4%BD%BF%E7%94%A8RoCEv2%E7%9A%84%E6%96%B9%E6%B3%95/">http://blog.sysu.tech/RoCE/OpenMPI%E4%BD%BF%E7%94%A8RoCEv2%E7%9A%84%E6%96%B9%E6%B3%95/</a><br><a href="https://wiki.whamcloud.com/display/LNet/Setting+Type+of+Service+%28ToS%29+from+o2iblnd">https://wiki.whamcloud.com/display/LNet/Setting+Type+of+Service+%28ToS%29+from+o2iblnd</a><br><a href="https://download.lenovo.com/servers/mig/2020/05/27/21909/mlnx-lnvgy_dd_nic_cx.ib-5.0-2.1.8.0-0_sles12_x86-64.pdf">https://download.lenovo.com/servers/mig/2020/05/27/21909/mlnx-lnvgy_dd_nic_cx.ib-5.0-2.1.8.0-0_sles12_x86-64.pdf</a><br><a href="http://wiki.lustrefs.cn/index.php?title=%E4%BB%8Eo2iblnd%E8%AE%BE%E7%BD%AE%E6%9C%8D%E5%8A%A1%E7%B1%BB%E5%9E%8B(ToS)">http://wiki.lustrefs.cn/index.php?title=%E4%BB%8Eo2iblnd%E8%AE%BE%E7%BD%AE%E6%9C%8D%E5%8A%A1%E7%B1%BB%E5%9E%8B(ToS)</a><br><a href="https://www.cnblogs.com/burningTheStar/p/8563347.html">https://www.cnblogs.com/burningTheStar/p/8563347.html</a><br><a href="https://community.mellanox.com/s/article/roce-configuration-for-linux-drivers-in-dscp-based-qos-mode">https://community.mellanox.com/s/article/roce-configuration-for-linux-drivers-in-dscp-based-qos-mode</a><br><a href="https://community.mellanox.com/s/article/howto-set-egress-tos-dscp-on-rdma-cm-qps">https://community.mellanox.com/s/article/howto-set-egress-tos-dscp-on-rdma-cm-qps</a><br><a href="https://community.mellanox.com/s/article/howto-setup-rdma-connection-using-inbox-driver--rhel--ubuntu-x">https://community.mellanox.com/s/article/howto-setup-rdma-connection-using-inbox-driver--rhel--ubuntu-x</a><br><a href="https://community.mellanox.com/s/article/howto-configure-resilient-roce-end-to-end-using-connectx-4-and-spectrum--no-qos-x">https://community.mellanox.com/s/article/howto-configure-resilient-roce-end-to-end-using-connectx-4-and-spectrum--no-qos-x</a><br><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/configuring_infiniband_and_rdma_networks/index">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/configuring_infiniband_and_rdma_networks/index</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options lnet networks=o2ib0(p4p1)</span><br></pre></td></tr></table></figure><h3 id="lfs-magic-num"><a href="#lfs-magic-num" class="headerlink" title="lfs magic num"></a>lfs magic num</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magic: 0xa0629d03 </span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;All&quot;&gt;&lt;a href=&quot;#All&quot; class=&quot;headerlink&quot; title=&quot;All&quot;&gt;&lt;/a&gt;All&lt;/h3&gt;&lt;h4 id=&quot;check-lfs-log&quot;&gt;&lt;a href=&quot;#check-lfs-log&quot; class=&quot;headerlink&quot; title=&quot;check lfs log&quot;&gt;&lt;/a&gt;check lfs log&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ lctl  get_param  at_max&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at_max=600&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Maximum adaptive timeout (&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; seconds). The at_max parameter is an upper-limit on the service time estimate. If at_max is reached, an RPC request &lt;span class=&quot;built_in&quot;&gt;times&lt;/span&gt; out.Setting at_max to 0 causes adaptive timeouts to be disabled and a fixed timeout method to be used instead (see the section called “Setting Static Timeouts” Note If slow hardware causes the service estimate to increase beyond the default value of at_max, increase at_max to the maximum time you are willing to &lt;span class=&quot;built_in&quot;&gt;wait&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; an RPC completion.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl  get_param  at_min&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at_min=50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Minimum adaptive timeout (&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; seconds). The default value is 0. The at_min parameter is the minimum processing time that a server will report. Ideally, at_min should be &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; to its default value. Clients base their timeouts on this value, but they &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; not use this value directly.If, &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; unknown reasons (usually due to temporary network outages), the adaptive timeout value is too short and clients time out their RPCs, you can increase the at_min value to compensate &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; this.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl get_param at_extra&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;at_extra=30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Incremental amount of time that a server requests with each early reply (in seconds). The server does not know how much time the RPC will take, so it asks for a fixed value. The default is 30, which provides a balance between sending too many early replies for the same RPC and overestimating the actual completion time.When a server finds a queued request about to time out and needs to send an early reply out, the server adds the at_extra value. If the time expires, the Lustre server drops the request, and the client enters recovery status and reconnects to restore the connection to normal status.If you see multiple early replies for the same RPC asking for 30-second increases, change the at_extra value to a larger number to cut down on early replies sent and, therefore, network load.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl  get_param  timeout&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;timeout=300&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl get_param -n debug&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl set_param debug=&lt;span class=&quot;string&quot;&gt;&amp;quot;ioctl neterror warning error emerg ha config console lfsck mmap page dentry cache malloc reada quota dlmtrace&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl set_param debug=&lt;span class=&quot;string&quot;&gt;&amp;quot;ioctl neterror warning error emerg ha config console lfsck cache reada quota&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl set_param debug=&lt;span class=&quot;string&quot;&gt;&amp;quot;ioctl neterror warning error emerg ha config console lfsck&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl get_param ldlm.dump_namespaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;##no output&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl set_param ldlm.dump_namespaces &lt;span class=&quot;string&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl get_param llite.*.dump_page_cache | grep -cEi &lt;span class=&quot;string&quot;&gt;&amp;#x27;lockd|dirty|writeback&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ strings dk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl df &amp;lt;input file&amp;gt; &amp;lt;output file&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;lfs rpm package install will not overvide the /lib/modules/$(uname -r)/extra&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ rm -rf /lib/modules/$(uname -r)/extra/; mkdir /lib/modules/$(uname -r)/extra&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ lctl get_param debug_path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;debug_path=/tmp/lfs-log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# enable(set to 1) bulk pages dump upon error on Client&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Client $ lctl get_param osc.*osc-[^mM]*.checksum_dump&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;osc.fsname-OST0000-osc-ffff8dab2cce8800.checksum_dump=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# enable(set to 1) bulk pages dump upon error on OSS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Oss$ lctl get_param obdfilter.*-OST*.checksum_dump&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;obdfilter.fsname-OST0000.checksum_dump=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## mds and oss&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;can1=$(do_facet mds1 &lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;span class=&quot;variable&quot;&gt;$LCTL&lt;/span&gt; get_param -n ldlm.services.ldlm_canceld.stats&amp;quot;&lt;/span&gt; |awk &lt;span class=&quot;string&quot;&gt;&amp;#x27;/ldlm_cancel/ &amp;#123;print $2&amp;#125;&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;blk1=$(&lt;span class=&quot;variable&quot;&gt;$LCTL&lt;/span&gt; get_param -n ldlm.services.ldlm_cbd.stats |awk &lt;span class=&quot;string&quot;&gt;&amp;#x27;/ldlm_bl_callback/ &amp;#123;print $2&amp;#125;&amp;#x27;&lt;/span&gt;) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;test_mkdir -i0 -c1 &lt;span class=&quot;variable&quot;&gt;$DIR&lt;/span&gt;/&lt;span class=&quot;variable&quot;&gt;$tdir&lt;/span&gt;/d1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;can2=$(do_facet mds1 &lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;span class=&quot;variable&quot;&gt;$LCTL&lt;/span&gt; get_param -n ldlm.services.ldlm_canceld.stats&amp;quot;&lt;/span&gt; |awk &lt;span class=&quot;string&quot;&gt;&amp;#x27;/ldlm_cancel/ &amp;#123;print $2&amp;#125;&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;blk2=$(&lt;span class=&quot;variable&quot;&gt;$LCTL&lt;/span&gt; get_param -n ldlm.services.ldlm_cbd.stats | awk &lt;span class=&quot;string&quot;&gt;&amp;#x27;/ldlm_bl_callback/ &amp;#123;print $2&amp;#125;&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[ &lt;span class=&quot;variable&quot;&gt;$can1&lt;/span&gt; -eq &lt;span class=&quot;variable&quot;&gt;$can2&lt;/span&gt; ] || error $((can2-can1)) &lt;span class=&quot;string&quot;&gt;&amp;quot;cancel RPC occured.&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[ &lt;span class=&quot;variable&quot;&gt;$blk1&lt;/span&gt; -eq &lt;span class=&quot;variable&quot;&gt;$blk2&lt;/span&gt; ] || error $((blk2-blk1)) &lt;span class=&quot;string&quot;&gt;&amp;quot;blocking RPC occured.&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Storage" scheme="http://yoursite.com/categories/Storage/"/>
    
    
    <category term="lfs" scheme="http://yoursite.com/tags/lfs/"/>
    
  </entry>
  
  <entry>
    <title>smartctl</title>
    <link href="http://yoursite.com/2019/11/26/smartctl/"/>
    <id>http://yoursite.com/2019/11/26/smartctl/</id>
    <published>2019-11-26T08:12:19.000Z</published>
    <updated>2020-10-11T07:30:02.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Enable-sas-sata-write-cache"><a href="#Enable-sas-sata-write-cache" class="headerlink" title="Enable sas/sata write cache"></a>Enable sas/sata write cache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl --get=wcache /dev/sdc</span><br><span class="line">$ smartctl --<span class="built_in">set</span>=wcache,off /dev/sdc</span><br><span class="line">$ smartctl --<span class="built_in">set</span>=wcache,on /dev/sdc</span><br><span class="line">smartctl 6.6 2016-05-31 r4324 [x86_64-linux-4.15.0-118-generic] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">Write cache enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="smart-test"><a href="#smart-test" class="headerlink" title="smart test"></a>smart test</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl -t long /dev/sdx</span><br><span class="line">$ smartctl -t short /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment">#self test result</span></span><br><span class="line">$ smartctl --capabilities /dev/sdxx</span><br><span class="line">$ smartctl --<span class="built_in">log</span>=selftest /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># During selected tests the specified range of LBAs is checked. The LBAs to be scanned are specified in the following formats:</span></span><br><span class="line">$ smartctl -t select,0-10 -t select,5-15 -t select,10-20 /dev/sdxx</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="disable-self-test-and-smart"><a href="#disable-self-test-and-smart" class="headerlink" title="disable self test and smart"></a>disable self test and smart</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#disable smart</span></span><br><span class="line">$ smartctl --smart=off /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#disbale automatic test</span></span><br><span class="line">$ smartctl --offlineauto=off /dev/sdxx</span><br></pre></td></tr></table></figure><h3 id="check-status"><a href="#check-status" class="headerlink" title="check status"></a>check status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">smartctl -x /dev/sdxx</span><br><span class="line">smartctl 6.5 2016-05-07 r4318 [x86_64-linux-3.10.0-693.5.2.el7_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">=== START OF INFORMATION SECTION ===</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0        0         0         0     187056      15672.508           0</span><br><span class="line">write:         0        0         0         0      94787       5143.822           0</span><br><span class="line">verify:        0        0         0         0        478        101.563           0</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br><span class="line"></span><br><span class="line">SMART Self-test <span class="built_in">log</span></span><br><span class="line">Num  Test              Status                 segment  LifeTime  LBA_first_err [SK ASC ASQ]</span><br><span class="line">     Description                              number   (hours)</span><br><span class="line"><span class="comment"># 1  Reserved(7)       Completed                  64       5                 - [-   -    -]</span></span><br><span class="line"></span><br><span class="line">Long (extended) Self Test duration: 65305 seconds [1088.4 minutes]</span><br><span class="line"></span><br><span class="line">Background scan results <span class="built_in">log</span></span><br><span class="line">  Status: scan is active</span><br><span class="line">    Accumulated power on time, hours:minutes 344:48 [20688 minutes]</span><br><span class="line">    Number of background scans performed: 2,  scan progress: 18.40%</span><br><span class="line">    Number of background medium scans performed: 2</span><br><span class="line"></span><br><span class="line">Protocol Specific port <span class="built_in">log</span> page <span class="keyword">for</span> SAS SSP</span><br><span class="line">relative target port id = 1</span><br><span class="line">  generation code = 2</span><br><span class="line">  number of phys = 1</span><br><span class="line">  phy identifier = 0</span><br><span class="line">    attached device <span class="built_in">type</span>: expander device</span><br><span class="line">    attached reason: power on</span><br><span class="line">    reason: unknown</span><br><span class="line">    negotiated logical link rate: phy enabled; 6 Gbps</span><br><span class="line">    attached initiator port: ssp=0 stp=0 smp=1</span><br><span class="line">    attached target port: ssp=0 stp=0 smp=1</span><br><span class="line">    SAS address = 0x5000cca2735b5ba1</span><br><span class="line">    attached SAS address = 0x50050cc11a5481ff</span><br><span class="line">    attached phy identifier = 32</span><br><span class="line">    Invalid DWORD count = 0</span><br><span class="line">    Running disparity error count = 0</span><br><span class="line">    Loss of DWORD synchronization = 0</span><br><span class="line">    Phy reset problem = 0</span><br><span class="line">    Phy event descriptors:</span><br><span class="line">     Invalid word count: 0</span><br><span class="line">     Running disparity error count: 0</span><br><span class="line">     Loss of dword synchronization count: 0</span><br><span class="line">     Phy reset problem count: 0</span><br><span class="line">relative target port id = 2</span><br><span class="line">  generation code = 2</span><br><span class="line">  number of phys = 1</span><br><span class="line">  phy identifier = 1</span><br><span class="line">    attached device <span class="built_in">type</span>: expander device</span><br><span class="line">    attached reason: power on</span><br><span class="line">    reason: unknown</span><br><span class="line">    negotiated logical link rate: phy enabled; 6 Gbps</span><br><span class="line">    attached initiator port: ssp=0 stp=0 smp=1</span><br><span class="line">    attached target port: ssp=0 stp=0 smp=1</span><br><span class="line">    SAS address = 0x5000cca2735b5ba2</span><br><span class="line">    attached SAS address = 0x50050cc11a919cff</span><br><span class="line">    attached phy identifier = 10</span><br><span class="line">    Invalid DWORD count = 0</span><br><span class="line">    Running disparity error count = 0</span><br><span class="line">    Loss of DWORD synchronization = 0</span><br><span class="line">    Phy reset problem = 0</span><br><span class="line">    Phy event descriptors:</span><br><span class="line">     Invalid word count: 0</span><br><span class="line">     Running disparity error count: 0</span><br><span class="line">     Loss of dword synchronization count: 0</span><br><span class="line">     Phy reset problem count: 0</span><br></pre></td></tr></table></figure><h3 id="SSD-write-monitor-for-more-info-go-to-vendor-spec-file"><a href="#SSD-write-monitor-for-more-info-go-to-vendor-spec-file" class="headerlink" title="SSD write monitor, for more info go to vendor spec file"></a>SSD write monitor, for more info go to vendor spec file</h3><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">233 </span>Media_Wearout_Indicator <span class="number">0</span>x0032   <span class="number">097</span>   <span class="number">097</span>   <span class="number">000</span>    Old_age   Always       -       <span class="number">0</span></span><br><span class="line"><span class="symbol">251 </span>NAND_Writes             -O--CK   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    -    <span class="number">7546253904</span></span><br></pre></td></tr></table></figure><p>diff vendor has the diff defines</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Enable-sas-sata-write-cache&quot;&gt;&lt;a href=&quot;#Enable-sas-sata-write-cache&quot; class=&quot;headerlink&quot; title=&quot;Enable sas/sata write cache&quot;&gt;&lt;/a&gt;Enable sas/sata write cache&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl --get=wcache /dev/sdc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl --&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt;=wcache,off /dev/sdc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl --&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt;=wcache,on /dev/sdc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;smartctl 6.6 2016-05-31 r4324 [x86_64-linux-4.15.0-118-generic] (&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; build)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Write cache enabled&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;smart-test&quot;&gt;&lt;a href=&quot;#smart-test&quot; class=&quot;headerlink&quot; title=&quot;smart test&quot;&gt;&lt;/a&gt;smart test&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl -t long /dev/sdx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl -t short /dev/sdx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#self test result&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl --capabilities /dev/sdxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl --&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;=selftest /dev/sdxx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# During selected tests the specified range of LBAs is checked. The LBAs to be scanned are specified in the following formats:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ smartctl -t select,0-10 -t select,5-15 -t select,10-20 /dev/sdxx&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Storage" scheme="http://yoursite.com/categories/Storage/"/>
    
    
    <category term="scsi" scheme="http://yoursite.com/tags/scsi/"/>
    
    <category term="smart" scheme="http://yoursite.com/tags/smart/"/>
    
  </entry>
  
  <entry>
    <title>xfs</title>
    <link href="http://yoursite.com/2019/11/26/xfs/"/>
    <id>http://yoursite.com/2019/11/26/xfs/</id>
    <published>2019-11-26T08:12:19.000Z</published>
    <updated>2021-02-07T03:42:23.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://fibrevillage.com/storage">reference</a></p><h4 id="format"><a href="#format" class="headerlink" title="format"></a>format</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Raid 60  24 HDD ，12HDD/per raid6   （12-2）× 2 ， Raid stripe size 64KB</span></span><br><span class="line">$ mkfs.xfs -f -d sunit=64,swidth=$((<span class="number">64</span>*<span class="number">20</span>)) /dev/sdxx1</span><br><span class="line"><span class="comment">#su: Stripe unit, which is the RAID chunk size, in bytes</span></span><br><span class="line"><span class="comment">#sw: Multiplier of the stripe unit, i.e. number of data disks</span></span><br><span class="line"></span><br><span class="line">$ mkfs.xfs /dev/device</span><br><span class="line">$ mkfs. xfs -d su= 64k,sw= 4 /dev/device</span><br></pre></td></tr></table></figure><p>su = value<br>    Specifies a stripe unit or RAID chunk size. The value must be specified in bytes, with an optional k, m, or g suffix.<br>sw= value<br>    Specifies the number of data disks in a RAID device, or the number of stripe units in the stripe.</p><a id="more"></a><h4 id="Grow"><a href="#Grow" class="headerlink" title="Grow"></a>Grow</h4><p>While XFS file systems can be grown while mounted</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_growfs /mount/point -D size</span><br></pre></td></tr></table></figure><h4 id="Suspend-file-system"><a href="#Suspend-file-system" class="headerlink" title="Suspend file system"></a>Suspend file system</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_freeze -f /mount/point</span><br><span class="line"></span><br><span class="line"><span class="comment">#unfreeze</span></span><br><span class="line">$ xfs_freeze -u /mount/point</span><br></pre></td></tr></table></figure><p>When taking an LVM snapshot, it is not necessary to use xfs_freeze to suspend the file system first.</p><h4 id="Quota"><a href="#Quota" class="headerlink" title="Quota"></a>Quota</h4><p>uquota User quotas<br>gquota Group quotas<br>pquota Project quota</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mount -o uquota /dev/mapper/LUN13 /lun13</span><br><span class="line">$ xfs_quota  /lun13</span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27;limit isoft=500 ihard=700 trteam&#x27;</span> /lun13</span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27; limit -g bsoft=1000 m bhard=1200m test &#x27;</span> /lun13</span><br><span class="line"></span><br><span class="line"><span class="comment"># report</span></span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27;report -bih&#x27;</span> /lun13</span><br><span class="line"></span><br><span class="line"><span class="comment">#project quota</span></span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27; project -s projectname&#x27;</span> project_path</span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27; limit -p bsoft=1000m bhard=1200m projectname&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="Backup-and-restore"><a href="#Backup-and-restore" class="headerlink" title="Backup and restore"></a>Backup and restore</h4><p>To perform a full backup, perform a level 0 dump on the file system.<br>A level 1 dump is the first incremental backup after a full backup. The next incremental backup would be level 2, which only backs up files that have changed since the last level 1 dump; and so on, to a maximum of level 9.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ xfsdump -l level [-L label] -f backup-destination path-to-xfs-filesystem</span><br><span class="line">$ xfsdump -l 0 -f /backup-files/data.xfsdump /data</span><br><span class="line">$ xfsdump -l 0 -L <span class="string">&quot;backup_data&quot;</span> -f /dev/st0 /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># restore</span></span><br><span class="line">$ xfsrestore [-r] [-S session-id] [-L session-label] [-i] -f backup-location restoration-path</span><br><span class="line">$ xfsrestore -f /backup-files/data.xfsdump /mnt/data/</span><br><span class="line">$ xfsrestore -f /dev/st0 -L <span class="string">&quot;backup_data&quot;</span> /mnt/data/</span><br><span class="line"></span><br><span class="line">$ xfsrestore -I <span class="comment"># get the session ID</span></span><br><span class="line">$ xfsrestore -f /dev/st0 -S <span class="string">&quot;45e9af35-efd2-4244-87bc-4762e476cbab&quot;</span> /mnt/data/</span><br><span class="line"></span><br><span class="line">$ xfs_metadump /dev/mapper/vg0-data /home/vg0-data.metadump</span><br><span class="line">$ xfs_mdrestore /home/vg0-data.metadump /home/vg0-data.img</span><br></pre></td></tr></table></figure><h4 id="Compare-with-ext4"><a href="#Compare-with-ext4" class="headerlink" title="Compare with ext4"></a>Compare with ext4</h4><table><thead><tr><th>Task</th><th>Ext3/4</th><th>XFS</th></tr></thead><tbody><tr><td>File System check</td><td>e2fsck</td><td>xfs_repair</td></tr><tr><td>REsizing a File System</td><td>resize2fs</td><td>xfs_growfs</td></tr><tr><td>Save an image of a file system</td><td>e2image</td><td>xfs_metadump and xfs_mdrestore</td></tr><tr><td>Label or tune a File System</td><td>tune2fs</td><td>xfs_admin</td></tr><tr><td>Backup a File System</td><td>dump and restore</td><td>xfsdump xfsrestore</td></tr></tbody></table><h4 id="Defragment"><a href="#Defragment" class="headerlink" title="Defragment"></a>Defragment</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_db -r  /dev/sdb</span><br><span class="line">$ xfs_db&gt; frag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Defragment</span></span><br><span class="line">$ xfs_fsr -t 3600  -v /lun10</span><br></pre></td></tr></table></figure><h4 id="xfs-admin"><a href="#xfs-admin" class="headerlink" title="xfs_admin"></a>xfs_admin</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_admin -l /dev/sdb</span><br><span class="line">$ xfs_admin -L <span class="string">&quot;data&quot;</span> /dev/sdb</span><br><span class="line"></span><br><span class="line">$ xfs_admin -u /dev/sdb</span><br><span class="line">$ xfs_admin -U generate-id /dev/sdb</span><br><span class="line">$ xfs_admin -U nil /dev/sdb</span><br><span class="line"></span><br><span class="line">$ xfs_admin -c 0 /dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment">#Enable xfs lazy counters</span></span><br><span class="line">$ xfs_admin -c 1 /dev/sdb</span><br></pre></td></tr></table></figure><h4 id="Repair"><a href="#Repair" class="headerlink" title="Repair"></a>Repair</h4><p>-n     No modify mode. Specifies that xfs_repair should not modify the filesystem  but  should  only  scan the filesystem and indicate what repairs would have been made</p><p>-L The xfs_repair utility cannot repair an XFS file system with a dirty log. To clear the log, mount and unmount the XFS file system. force log zeroing to clean log<br>-v option gives you xfs_repair verbose outpt, inaddition to the regular repair message +extra verbosity, it has a summary for each repair phase.<br>-d Repair  dangerously.  Allow  xfs_repair to repair an XFS filesystem mounted read only. This is typically done on a root filesystem from single user mode, immediately followed by a reboot.<br>-l option, external log<br>-f Specifies  that  the  filesystem  image  to  be processed is stored in a regular file at device (see the mkfs.xfs -d file option). This might happen if an image copy of a filesystem has been copied or written into an ordinary file.  This option implies that any external log or realtime section is also in an ordinary file.<br>-P option, disable prefetching<br>-t interval Modify reporting interval, specified in seconds. During long runs xfs_repair outputs its progress every 15 minutes. Reporting is only activated when ag_stride is enabled.<br>-m Specifies the approximate maximum amount of memory, in megabytes, to use for xfs_repair.  xfs_repair has its own internal block cache which  will  scale  out  up  to  the lesser of the process’s virtual address limit or about 75% of the system’s physical RAM.  This option overrides these limits. NOTE: These memory limits are only approximate and may use more than the specified limit</p><p>If xfs_repair failed in phase 1, you must restore lost files from backups.<br>If xfs_repair failed in phase 2 or later, you may be able to restore files from the disk by backing up and restoring the files on the file system<br>    * Mount the file system using mount -r (read-only).<br>    * Make a file system backup with xfsdump.<br>    * Use mkfs to a make new file system on the same disk partition or XLV logical volume.<br>    * Restore the files from the backup with xfsrestore.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mount -r /dev/sdb /mnt</span><br><span class="line">$ mount /dev/sdb /mnt -o norecover</span><br></pre></td></tr></table></figure><p>Without any option, xfs_repair will check and repair errors that it encounters.</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_repair -n /dev/device</span><br><span class="line">Phase 1 - find<span class="built_in"> and </span>verify superblock...</span><br><span class="line">Phase 2 - using internal log</span><br><span class="line">        - scan filesystem freespace<span class="built_in"> and </span>inode maps...</span><br><span class="line">        - found root inode chunk</span><br><span class="line">Phase 3 - for each AG...</span><br><span class="line">        - scan (but don&#x27;t clear) agi unlinked lists...</span><br><span class="line">        - process known inodes<span class="built_in"> and </span>perform inode discovery...</span><br><span class="line">        - agno = 0</span><br><span class="line">        - agno = 1</span><br><span class="line">        - agno = 2</span><br><span class="line">        - agno = 3</span><br><span class="line">        - process newly discovered inodes...</span><br><span class="line">Phase 4 -<span class="built_in"> check </span>for duplicate blocks...</span><br><span class="line">        - setting up duplicate extent list...</span><br><span class="line">        -<span class="built_in"> check </span>for inodes claiming duplicate blocks...</span><br><span class="line">        - agno = 0</span><br><span class="line">        - agno = 1</span><br><span class="line">        - agno = 2</span><br><span class="line">        - agno = 3</span><br><span class="line">No modify flag set, skipping phase 5</span><br><span class="line">Phase 6 -<span class="built_in"> check </span>inode connectivity...</span><br><span class="line">        - traversing filesystem ...</span><br><span class="line">        - traversal finished ...</span><br><span class="line">        - moving disconnected inodes to lost+found ...</span><br><span class="line">Phase 7 - verify link counts...</span><br><span class="line">No modify flag set, skipping filesystem flush<span class="built_in"> and </span>exiting.</span><br><span class="line"></span><br><span class="line">$ xfs_repair -L /dev/device</span><br><span class="line">$ xfs_repair -d /</span><br></pre></td></tr></table></figure><ol><li>Inode  and inode blockmap (addressing) checks:bad magic number  in inode, bad magic numbers in inode blockmap  blocks,  extents out  of  order,  incorrect  number of records in inode blockmap blocks, blocks claimed that are not in a legal data area of the filesystem, blocks that are claimed by more than one inode.</li><li>Inode  allocation  map  checks:bad  magic number in inode map blocks, inode state as indicated by map (free or in-use) inconsistent with state indicated by the inode, inodes referenced by the filesystem that do not appear in the inode allocation  map, inode  allocation  map referencing blocks that do not appear to contain inodes.</li><li>Size checks:number of blocks  claimed  by  inode  inconsistent with  inode  size, directory size not block aligned, inode size not consistent with inode format.</li><li>Directory checks:bad magic numbers in directory blocks, incorrect  number  of  entries  in  a directory block, bad freespace information in a directory leaf block,  entry  pointing  to  an unallocated  (free) or out of range inode, overlapping entries, missing or incorrect dot and dotdot  entries,  entries  out  of hashvalue  order, incorrect internal directory pointers, directory type not consistent with inode format and size.</li><li>Pathname checks:files or directories not referenced by a pathname starting from the filesystem root, illegal pathname components.</li><li>Link count checks:link counts that do not agree with the  number of directory references to the inode.</li><li>Freemap  checks: blocks  claimed  free by the freemap but also claimed by an inode, blocks unclaimed  by  any  inode  but  not appearing in the freemap.</li><li>Super  Block  checks: total free block and/or free i-node count incorrect, filesystem geometry inconsistent, secondary and primary superblocks contradictory.</li></ol><h4 id="Recover-file"><a href="#Recover-file" class="headerlink" title="Recover file"></a>Recover file</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ih</span><br><span class="line">70179 -r-xr-xr-x 1 solexa solexa    0 Jan 10  2013 report.htm</span><br><span class="line"></span><br><span class="line">$ xfs_db -r /dev/sdb -c <span class="string">&quot;inode 70179&quot;</span> -c <span class="string">&quot;bmap&quot;</span></span><br><span class="line">data offset 0 startblock 2459337662 (9/43418558) count 1 flag 0a</span><br><span class="line"></span><br><span class="line">$ agblocks=$(xfs_db -r /dev/sdb1 -c sb -c p | grep ^agblocks | sed <span class="string">&#x27;s/.* = //&#x27;</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$agblocks</span></span><br><span class="line">268435455</span><br><span class="line">$ agcount=$(xfs_db -r /dev/sdb1 -c sb -c p | awk <span class="string">&#x27;$0~/agcount/&#123;print $3&#125;&#x27;</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$agcount</span></span><br><span class="line">9</span><br><span class="line">$ b=43418558</span><br><span class="line">$ c=1</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) </span><br><span class="line">2459337653</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">2459337662</span>-<span class="number">9</span>))</span><br><span class="line">2459337653</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdb bs=4096 skip=$((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) count=<span class="variable">$c</span> of=/tmp/report.htm</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB) copied, 4.6345e-05 s, 88.4 MB/s</span><br><span class="line"></span><br><span class="line">$ cat /tmp/report.htm   <span class="comment"># file come back</span></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=gbk&quot;</span>/&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ls -li</span><br><span class="line">total 8344</span><br><span class="line">201802827 -rw-r--r-- 1 root root 4270448 Jan 20 20:37 files.md5</span><br><span class="line"></span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c <span class="string">&quot;inode 201802827&quot;</span> -c <span class="string">&quot;bmap&quot;</span></span><br><span class="line">data offset 0 startblock 25205566 (3/39742) count 1043 flag 0</span><br><span class="line"></span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c sb -c p | grep agblocks</span><br><span class="line">agblocks = 7781888</span><br><span class="line"></span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c <span class="string">&quot;convert inode 201802827 agino&quot;</span></span><br><span class="line">0x7444b (476235)</span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c <span class="string">&quot;convert inode 201802827 agno&quot;</span></span><br><span class="line">0x3 (3)</span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c <span class="string">&quot;convert inode 201802827 agblock&quot;</span></span><br><span class="line">0xe889 (59529)</span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c <span class="string">&quot;convert inode 201802827 offset&quot;</span></span><br><span class="line">0x3 (3)</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/mapper/cl-root bs=4096 skip=$((<span class="variable">$agno</span>*<span class="variable">$agblocks</span>+<span class="number">39742</span>)) count=1043 of=files.md5.copy</span><br><span class="line"><span class="comment">## there are some zero in the end of the recovery file</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####</span></span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c <span class="string">&quot;inode <span class="variable">$inode</span>&quot;</span> -c <span class="string">&quot;bmap&quot;</span></span><br><span class="line">data offset 0 startblock 25205566 (3/39742) count 1043 flag 0</span><br><span class="line"><span class="comment">## Got the offset=39742 and count=1043</span></span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c <span class="string">&quot;convert inode <span class="variable">$inode</span> agno&quot;</span></span><br><span class="line">0x3 (3)</span><br><span class="line">xfs_db -r /dev/mapper/cl-root -c sb -c p | grep agblocks</span><br><span class="line">agblocks = 7781888</span><br><span class="line"><span class="comment">## Got the agblock and agno</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/xxx bs=4096 skip=$((<span class="variable">$agno</span>*<span class="variable">$agblocks</span>+<span class="variable">$offset</span>)) count=1043 of=files.copy</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="xfs-estimate"><a href="#xfs-estimate" class="headerlink" title="xfs_estimate"></a>xfs_estimate</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xfs_estimate -v /mnt</span><br><span class="line">directory                               bsize   blocks    megabytes    logsize</span><br><span class="line">/mnt                                     <span class="number">4096</span>     <span class="number">1138</span>        <span class="number">4.4</span>MB    <span class="number">4096000</span></span><br><span class="line">$ xfs_estimate -v -b <span class="number">512</span> /mnt</span><br><span class="line">directory                               bsize   blocks    megabytes    logsize</span><br><span class="line">/mnt                                      <span class="number">512</span>     <span class="number">1138</span>        <span class="number">0.6</span>MB     <span class="number">512000</span></span><br><span class="line">$ xfs_estimate -v -b <span class="number">4096</span> /mnt</span><br><span class="line">directory                               bsize   blocks    megabytes    logsize</span><br><span class="line">/mnt                                     <span class="number">4096</span>     <span class="number">1138</span>        <span class="number">4.4</span>MB    <span class="number">4096000</span></span><br></pre></td></tr></table></figure><h3 id="xfs-info"><a href="#xfs-info" class="headerlink" title="xfs_info"></a>xfs_info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_info /mnt</span><br><span class="line">meta-data=/dev/sdb               isize=512    agcount=16, agsize=4799984 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0 spinodes=0</span><br><span class="line">data     =                       bsize=4096   blocks=76799744, imaxpct=25</span><br><span class="line">         =                       sunit=16     swidth=32 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal               bsize=4096   blocks=37504, version=2</span><br><span class="line">         =                       sectsz=512   sunit=16 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure><h3 id="xfs-logprint"><a href="#xfs-logprint" class="headerlink" title="xfs_logprint"></a>xfs_logprint</h3><p>-t print out transactional view of an xfs log</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">xfs_logprint -t  /dev/sdb</span><br><span class="line">xfs_logprint:</span><br><span class="line">xfs_logprint: /dev/sdb contains a mounted and writable filesystem</span><br><span class="line">    data device: 0x810</span><br><span class="line">    <span class="built_in">log</span> device: 0x810 daddr: 307199104 length: 300032</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> tail: 256 head: 512 state: &lt;DIRTY&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOG REC AT LSN cycle 1 block 256 (0x1, 0x100)</span><br><span class="line">============================================================================</span><br><span class="line">TRANS: tid:0xb4cdd37c  <span class="built_in">type</span>:SWAPEXT  <span class="comment">#items:2  trans:0xb4cdd37c  q:0x20bcbe0</span></span><br><span class="line">BUF: cnt:2 total:2 a:0x20bd010 len:24 a:0x20bd060 len:384</span><br><span class="line">BUF:  <span class="comment">#regs:2   start blkno:0x0   len:1   bmap size:1   flags:0x9000</span></span><br><span class="line">SUPER Block Buffer:</span><br><span class="line"></span><br><span class="line">LOG REC AT LSN cycle 1 block 384 (0x1, 0x180)</span><br><span class="line">============================================================================</span><br><span class="line">TRANS: tid:0xb84fc956  <span class="built_in">type</span>:SWAPEXT  <span class="comment">#items:2  trans:0xb84fc956  q:0x20bcbe0</span></span><br><span class="line">BUF: cnt:2 total:2 a:0x20bd010 len:24 a:0x20cd250 len:384</span><br><span class="line">BUF:  <span class="comment">#regs:2   start blkno:0x0   len:1   bmap size:1   flags:0x9000</span></span><br><span class="line">SUPER Block Buffer:</span><br></pre></td></tr></table></figure><p>-i extract and print inode info<br>-q extract and print quota info<br>-e, exit when an error is found in the log<br>-c, Attempt to continue when an error is detected</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_logprint -C xfs.log /dev/sdb</span><br></pre></td></tr></table></figure><h4 id="About-barriers"><a href="#About-barriers" class="headerlink" title="About barriers"></a><a href="https://xfs.org/index.php/XFS_FAQ#Write_barrier_support.">About barriers</a></h4><p>Write barrier support is enabled by default in XFS since kernel version 2.6.17. It is disabled by mounting the filesystem with “nobarrier”. Barrier support will flush the write back cache at the appropriate times (such as on XFS log writes). </p><h3 id="The-file-block"><a href="#The-file-block" class="headerlink" title="The file block"></a>The file block</h3><p>sdc is the 4K block device, the xfs count by 512 Bytes  </p><p>Here is the 1MB file, it ‘s aligned   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ df -h /mnt</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdc2       948M   36M  913M   4% /mnt</span><br><span class="line"></span><br><span class="line">$ xfs_info /dev/sdc2</span><br><span class="line">meta-data=/dev/sdc2              isize=512    agcount=4, agsize=61056 blks</span><br><span class="line">         =                       sectsz=4096  attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=1 spinodes=0 rmapbt=0</span><br><span class="line">         =                       reflink=0</span><br><span class="line">data     =                       bsize=4096   blocks=244224, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal               bsize=4096   blocks=1605, version=2</span><br><span class="line">         =                       sectsz=4096  sunit=1 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=1M count=1</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.00214354 s, 489 MB/s</span><br><span class="line"></span><br><span class="line">$ ls -shl</span><br><span class="line">total 1.0M</span><br><span class="line">1.0M -rw-r--r-- 1 root root 1.0M April 17 22:16 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ xfs_bmap -v ./<span class="built_in">test</span></span><br><span class="line">./<span class="built_in">test</span>:</span><br><span class="line"> EXT: FILE-OFFSET      BLOCK-RANGE      AG AG-OFFSET        TOTAL</span><br><span class="line">   0: [0..2047]:       160..2207         0 (160..2207)       2048</span><br><span class="line"></span><br><span class="line"><span class="comment">#BLOCK-RANGE start at 160 block and total blocks: 2048; 2048 x 512</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdc2 of=dd-test bs=512 skip=160 count=2048</span><br><span class="line">2048+0 records <span class="keyword">in</span></span><br><span class="line">2048+0 records out</span><br><span class="line">1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.00779449 s, 135 MB/s</span><br><span class="line"></span><br><span class="line">$ du -hs <span class="built_in">test</span> dd-test</span><br><span class="line">1.0M<span class="built_in">test</span></span><br><span class="line">1.0Mdd-test</span><br><span class="line"></span><br><span class="line">$ md5sum ./*</span><br><span class="line">b6d81b360a5672d80c27430f39153e2c  ./<span class="built_in">test</span></span><br><span class="line">b6d81b360a5672d80c27430f39153e2c  ./dd-test</span><br></pre></td></tr></table></figure><p>Not aligned example  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rand -hex 255 &gt; flag1</span><br><span class="line">$ openssl rand -hex 255 &gt; flag2</span><br><span class="line">$ openssl rand -hex 255 &gt; flag3</span><br><span class="line">$ cat flag* &gt; flag</span><br><span class="line"></span><br><span class="line">$ xfs_bmap -v ./flag</span><br><span class="line">./flag:</span><br><span class="line"> EXT: FILE-OFFSET      BLOCK-RANGE      AG AG-OFFSET          TOTAL</span><br><span class="line">   0: [0..7]:          1052728..1052735  0 (1052728..1052735)     8</span><br><span class="line"></span><br><span class="line"><span class="comment">## it &#x27;s 4K file ?</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdc2 of=flag-copy bs=512 skip=1052728 count=8</span><br><span class="line">8+0 records <span class="keyword">in</span></span><br><span class="line">8+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 0.00178995 s, 2.3 MB/s</span><br><span class="line"></span><br><span class="line">$ md5sum flag-copy flag</span><br><span class="line">fd39ee533070b2bbd46f38f81e16c72f  flag-copy</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ hexdump -C flag</span><br><span class="line">...</span><br><span class="line">000005c0  34 33 31 66 63 62 63 30  64 35 66 31 31 32 63 33  |431fcbc0d5f112c3|</span><br><span class="line">000005d0  64 34 34 35 30 30 33 35  65 38 35 37 33 38 36 63  |d4450035e857386c|</span><br><span class="line">000005e0  32 34 32 33 31 34 39 30  36 32 64 62 36 39 61 30  |2423149062db69a0|</span><br><span class="line">000005f0  64 33 31 66 61 64 34 66  38 37 62 30 0a           |d31fad4f87b0.|</span><br><span class="line">000005fd</span><br><span class="line"></span><br><span class="line">$ hexdump -C flag-copy</span><br><span class="line">000005d0  64 34 34 35 30 30 33 35  65 38 35 37 33 38 36 63  |d4450035e857386c|</span><br><span class="line">000005e0  32 34 32 33 31 34 39 30  36 32 64 62 36 39 61 30  |2423149062db69a0|</span><br><span class="line">000005f0  64 33 31 66 61 64 34 66  38 37 62 30 0a 00 00 00  |d31fad4f87b0....|</span><br><span class="line">00000600  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00001000</span><br><span class="line"></span><br><span class="line"><span class="comment"># it &#x27;s just 1533 Bytes, not 4K</span></span><br><span class="line">$  <span class="built_in">stat</span> flag</span><br><span class="line">  File: flag</span><br><span class="line">  Size: 1533      Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 822h/2082dInode: 105         Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2020-04-18 01:00:50.197468163 +0800</span><br><span class="line">Modify: 2020-04-18 01:00:48.173261473 +0800</span><br><span class="line">Change: 2020-04-18 01:00:48.173261473 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line"><span class="comment"># just overwrite the 1533 Bytes in the 4K file...</span></span><br><span class="line">$  dd <span class="keyword">if</span>=/dev/sdc2 of=flag-copy conv=notrunc bs=1 skip=$((<span class="number">1052728</span>*<span class="number">512</span>)) count=1533</span><br><span class="line">1533+0 records <span class="keyword">in</span></span><br><span class="line">1533+0 records out</span><br><span class="line">1533 bytes (1.5 kB, 1.5 KiB) copied, 0.00655476 s, 234 kB/s</span><br><span class="line">root@homerl-To-be-filled-by-O-E-M:/mnt<span class="comment"># md5sum flag-copy flag</span></span><br><span class="line">fd39ee533070b2bbd46f38f81e16c72f  flag-copy</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag</span><br><span class="line"></span><br><span class="line">$ ls -shl</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  1.5K April  18 01:00 flag</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag1</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag2</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag3</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  4.0K April  18 01:07 flag-copy</span><br><span class="line"></span><br><span class="line">$ rm flag-copy</span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdc2 of=flag-copy conv=notrunc bs=1 skip=$((<span class="number">1052728</span>*<span class="number">512</span>)) count=1533</span><br><span class="line">$ ls -shl</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  1.5K April  18 01:00 flag</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag1</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag2</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag3</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  1.5K April  18 01:07 flag-copy</span><br><span class="line"></span><br><span class="line">$ md5sum flag-copy flag</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag-copy</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag</span><br></pre></td></tr></table></figure><p>Big file   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=big-file bs=1M count=1000</span><br><span class="line">$ xfs_bmap -v big-file </span><br><span class="line">big-file:</span><br><span class="line"> EXT: FILE-OFFSET         BLOCK-RANGE      AG AG-OFFSET          TOTAL</span><br><span class="line">   0: [0..1048447]:       4280..1052727     0 (4280..1052727)  1048448</span><br><span class="line">   1: [1048448..2047999]: 1953376..2952927  1 (96..999647)      999552</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">stat</span> big-file </span><br><span class="line">  File: big-file</span><br><span class="line">  Size: 1048576000Blocks: 2048000    IO Block: 4096   regular file</span><br><span class="line">Device: 822h/2082dInode: 104         Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2020-04-18 01:00:37.464167969 +0800</span><br><span class="line">Modify: 2020-04-18 01:00:39.196344841 +0800</span><br><span class="line">Change: 2020-04-18 01:38:26.999014414 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line">$ hexdump -C big-file</span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">3e800000</span><br><span class="line"></span><br><span class="line">$ cat flag1 flag2 flag3 </span><br><span class="line">56c80696e82e2f88984e369e5dcee45142b3682020adf733e68f692a70747b99b307b15022ed21f3d843cba8abf52e3432e6203fe2bf5bc2ecd79891dcfc133ae3350c0b8ea8d5c7d9e449938959a411ee96ca9a56653b34f2de236ddd3007b30a9876bcedcfeb73489d17a263b0af5b7a069848280dc55ecfeaccca6af46f0a637d97fcd94dd3c3d75bd871398753da6abe52d3c8d54abc6339acb094a2c33a1b772c8d51a0306ad20920c8a749d334030b5a072049572fc2d7c1183e575bd66aa2020f115b62d05bb15ddd07000e6fde5387d2807ec21605286190bfe3b77e2d3f4991bed0a716c8419ca5d4ddd7815f39e3579090040ff77be5fe730dbc</span><br><span class="line">6baa2fc5a2115063030d7d4a8633974f2fc14cd502ec6df38f575d2d6dcff299b7dcdeca9d4dd513d7d77a6099aa8604108628109f871ac414942f0f5efe58b61f5b160f5bdf34bb30ff6655f958b62731c0097ed92090ec1c2433e7baa0bca9e385f9c7b3dd1188aaedaefdfd6a9e6dadaf6bd08a7096c2219b4c8e9d9cf1daa0bbeb3dd9994666cbbd1c45e5d07afefbe0af42f508b49869f54edd34865423cb0bdd71a99f6c2f0f19f1aa494f0694b6baa3ebe090b3aeb6443b7b5f210b00560aba8bdbfdd15ab8ae909c6d99477dde90a5ad9ac28338dbe2abc663cb8092519b7258fdbba92f62d2c9dd70861274acb5180dbd8371ccf6469d5fc4940c</span><br><span class="line">b621e3e516b0a54defdde7e05b846dc8a91c29f191d2f74305b7d6e5f742c5cb1ce793450b83f2d1e5f692d78994d558ed47e8e3fe58db32aab4dc87d10452db5cf99bab7fa5915b30cc6844e4d1393bd41c56c65a7ed8eb916976d122dbf955035bd2c39ba320838d39b0e1d4cee3db53c35bfa860412f4aeef71f3e3b4d6d1edaff216e385fa667c0e08cbd780e1246adb8ae932a261f0df9c8e4a0e627e6775ddb602308efaa49e0e6413edcb577660b0ea749a3b737a00f9ef56dbb834505f4ce0950a04dce4c159d2c459f382e4d41cf517c4329d3b241e5d8eb8872b0bdd431fcbc0d5f112c3d4450035e857386c2423149062db69a0d31fad4f87b0</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=flag1 of=/dev/sdc2 bs=512 seek=4280</span><br><span class="line">0+1 records <span class="keyword">in</span></span><br><span class="line">0+1 records out</span><br><span class="line">511 bytes copied, 0.000275702 s, 1.9 MB/s</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=flag2 of=/dev/sdc2 bs=512 seek=1953376</span><br><span class="line">0+1 records <span class="keyword">in</span></span><br><span class="line">0+1 records out</span><br><span class="line">511 bytes copied, 0.0125594 s, 40.7 kB/s</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~</span><br><span class="line">$ umount /mnt</span><br><span class="line">$ mount /dev/sdc2 /mnt</span><br><span class="line">$ <span class="built_in">cd</span> /mnt/</span><br><span class="line">$ hexdump -C big-file</span><br><span class="line">00000000  35 36 63 38 30 36 39 36  65 38 32 65 32 66 38 38  |56c80696e82e2f88|</span><br><span class="line">.....</span><br><span class="line">000001f0  66 37 37 62 65 35 66 65  37 33 30 64 62 63 0a 00  |f77be5fe730dbc..|</span><br><span class="line">00000200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">1fff0000  36 62 61 61 32 66 63 35  61 32 31 31 35 30 36 33  |6baa2fc5a2115063|</span><br><span class="line">.....</span><br><span class="line">1fff01f0  66 36 34 36 39 64 35 66  63 34 39 34 30 63 0a 00  |f6469d5fc4940c..|</span><br><span class="line">1fff0200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">3e800000</span><br><span class="line"></span><br><span class="line">$ cp big-file big-file-2</span><br><span class="line">$ xfs_bmap -v big-file-2</span><br><span class="line">big-file-2:</span><br><span class="line"> EXT: FILE-OFFSET         BLOCK-RANGE      AG AG-OFFSET           TOTAL</span><br><span class="line">   0: [0..900551]:        1052728..1953279  0 (1052728..1953279) 900552</span><br><span class="line">   1: [900552..902695]:   160..2303         0 (160..2303)          2144</span><br><span class="line">   2: [902696..1854375]:  2952928..3904607  1 (999648..1951327)  951680</span><br><span class="line">   3: [1854376..2047999]: 4975584..5169207  2 (1069024..1262647) 193624</span><br><span class="line">$ big-file*</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file-2</span><br><span class="line"></span><br><span class="line">$ ls -lhs big-file-2-p* </span><br><span class="line">440M -rw-r--r-- 1 root root 440M April  18 01:54 big-file-2-p1</span><br><span class="line">1.1M -rw-r--r-- 1 root root 1.1M April  18 01:55 big-file-2-p2</span><br><span class="line">465M -rw-r--r-- 1 root root 465M April  18 01:55 big-file-2-p3</span><br><span class="line"> 95M -rw-r--r-- 1 root root  95M April  18 01:56 big-file-2-p4</span><br><span class="line"></span><br><span class="line"><span class="comment"># if the file not out of order</span></span><br><span class="line">$ hexdump -C big-file-2-p1 </span><br><span class="line">00000000  35 36 63 38 30 36 39 36  65 38 32 65 32 66 38 38  |56c80696e82e2f88|</span><br><span class="line">...</span><br><span class="line">000001f0  66 37 37 62 65 35 66 65  37 33 30 64 62 63 0a 00  |f77be5fe730dbc..|</span><br><span class="line">00000200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">1b7b9000</span><br><span class="line"></span><br><span class="line">$ hexdump -C big-file-2-p2 </span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0010c000</span><br><span class="line"></span><br><span class="line">$ hexdump -C big-file-2-p3</span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0472b000  36 62 61 61 32 66 63 35  61 32 31 31 35 30 36 33  |6baa2fc5a2115063|</span><br><span class="line">...</span><br><span class="line">0472b1f0  66 36 34 36 39 64 35 66  63 34 39 34 30 63 0a 00  |f6469d5fc4940c..|</span><br><span class="line">0472b200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">1d0b0000</span><br><span class="line"></span><br><span class="line"><span class="comment"># second flag show at 1fff0000 (536805376)</span></span><br><span class="line"><span class="comment"># p1 end at 1b7b9000 (461082624)</span></span><br><span class="line"><span class="comment"># p2 from 0x0 to 0010c000 (1097728)</span></span><br><span class="line"><span class="comment"># p3 from 0x0 to 0472b000 (74625024)</span></span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">461082624</span>+<span class="number">1097728</span>+<span class="number">74625024</span>))</span><br><span class="line">536805376</span><br><span class="line"></span><br><span class="line"><span class="comment"># it &#x27;s the 1fff0000 (536805376)</span></span><br><span class="line"></span><br><span class="line">$ cat big-file-2-p1 big-file-2-p2 big-file-2-p3 big-file-2-p4 &gt; big-file-3</span><br><span class="line">$ md5sum big-file-2 big-file-3</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file-2</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file-3</span><br></pre></td></tr></table></figure><h3 id="copy-from-this-article"><a href="#copy-from-this-article" class="headerlink" title="copy from this article"></a><a href="https://righteousit.wordpress.com/2018/05/21/xfs-part-1-superblock/">copy from this article</a></h3><p>XFS magic num: “58 46 53 42”</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">00000000  58 46 53 42 00 00 10 00  00 00 00 00 06 <span class="built_in">fc</span> 85 00  |XFSB............|</span><br><span class="line">magicnum = 0x58465342  <span class="comment"># 0-3 bytes mangic num: &quot;58 46 53 42&quot; XFSB</span></span><br><span class="line">blocksize = 4096       <span class="comment"># 4-7  &quot;00 00 10 00&quot;</span></span><br><span class="line">dblocks = 117212416    <span class="comment"># 8-15 &quot;00 00 00 00 06 fc 85 00&quot; Total blocks in file system</span></span><br><span class="line">                       <span class="comment"># echo $((117212416*4096))=480102055936 ;</span></span><br><span class="line">                  <span class="comment"># blockdev --getsz /dev/sdg1 937699328; echo $((937699328*512))=480102055936</span></span><br><span class="line"></span><br><span class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">rblocks = 0 <span class="comment"># 16-23    Num blocks in real-time device</span></span><br><span class="line">rextents = 0 <span class="comment"># 24-31    Num extents in real-time device</span></span><br><span class="line"></span><br><span class="line">00000020  ce 72 48 bd 0f 2e 4b 04  a4 77 bc <span class="built_in">cd</span> a5 91 67 <span class="built_in">cd</span>  |.rH...K..w....g.|</span><br><span class="line">uuid = ce7248bd-0f2e-4b04-a477-bccda59167cd</span><br><span class="line"></span><br><span class="line">00000030  00 00 00 00 04 00 00 07  00 00 00 00 00 00 00 60  |...............`|</span><br><span class="line">logstart = 67108871  <span class="comment">## 48-55 bytes,First block of journal &quot;00 00 00 00 04 00 00 07&quot;</span></span><br><span class="line">rootino = 96  <span class="comment">## 56-63 bytes,Root directory&#x27;s inode &quot;00 00 00 00 00 00 00 60&quot;</span></span><br><span class="line"></span><br><span class="line">00000040  00 00 00 00 00 00 00 61  00 00 00 00 00 00 00 62  |.......a.......b|</span><br><span class="line">rbmino = 97 <span class="comment"># 64-71    Real-time extents bitmap inode</span></span><br><span class="line">rsumino = 98 <span class="comment"># 72-79    Real-time bitmap summary inode</span></span><br><span class="line"></span><br><span class="line">00000050  00 00 00 01 01 bf 21 40  00 00 00 04 00 00 00 00  |......!@........|</span><br><span class="line">rextsize = 1 <span class="comment">#80-83    Real-time extent size (in blocks)</span></span><br><span class="line">agblocks = 29303104 <span class="comment">#84-87 1bf2140=29303104   single AG size (in blocks), there are 4x AGs , awk &#x27;BEGIN&#123;print 29303104*4096*4&#125;&#x27; = 480102055936, same with dblocks echo $((117212416*4096))=480102055936</span></span><br><span class="line">agcount = 4    <span class="comment">#88-91    Number of AGs # 4 x AG</span></span><br><span class="line">rbmblocks = 0  <span class="comment">#92-95    Num of real-time bitmap blocks</span></span><br><span class="line"></span><br><span class="line">00000060  00 00 df 90 bc a5 10 00  02 00 00 08 00 00 00 00  |................|</span><br><span class="line">logblocks = 57232 <span class="comment"># 96-99, 00 00 df 90, Num of journal blocks</span></span><br><span class="line">versionnum = 0xbca5 <span class="comment">#100-101 File system version and flags</span></span><br><span class="line">sectsize = 4096 <span class="comment">#102-103, 10 00 ,Sector size</span></span><br><span class="line">inodesize = 512 <span class="comment">#104-105, 02 00 ,inode size</span></span><br><span class="line">inopblock = 8   <span class="comment">#106-107, indoes/block, 00 08</span></span><br><span class="line"></span><br><span class="line">                                              <span class="comment">#108</span></span><br><span class="line">00000060  00 00 df 90 bc a5 10 00  02 00 00 08 00 00 00 00  |................|</span><br><span class="line">00000070  00 00 00 00 00 00 00 00  0c 0c 09 03 19 00 00 19  |................|</span><br><span class="line">fname = <span class="string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span> <span class="comment">#108-119 file system name, not set</span></span><br><span class="line">                                  <span class="comment">#120</span></span><br><span class="line">00000070  00 00 00 00 00 00 00 00  0c 0c 09 03 19 00 00 19  |................|</span><br><span class="line">blocklog = 12 <span class="comment">#120      log2(block size)           0xc</span></span><br><span class="line">sectlog = 12  <span class="comment">#121      log2(sector size)          0xc</span></span><br><span class="line">inodelog = 9  <span class="comment">#122      log2(inode size)           0x9</span></span><br><span class="line">inopblog = 3  <span class="comment">#123      log2(inode/block)          0x3</span></span><br><span class="line">agblklog = 25 <span class="comment">#124      log2(AG size) rounded up   0x19</span></span><br><span class="line"><span class="comment"># From logstart = 67108871(10) 0x4000007  ## 48-55 bytes First block of journal</span></span><br><span class="line"><span class="comment">#0x4000007 =      10          0 000 000 000 000 000 000 000 111</span></span><br><span class="line"><span class="comment">#AG# in upper 2 bits---/\---22 bits of relative block offset</span></span><br><span class="line"><span class="comment">#10 means beginning of AG 2</span></span><br><span class="line"><span class="comment">#111 means the journal starts at relative block offset 7</span></span><br><span class="line"><span class="comment">#The physical block offset can be calculated as follows</span></span><br><span class="line"><span class="comment">#AG num (2) x  (blocks per ag, #84-87, agblocks = 29303104) + (relative block offset 7)=58606215</span></span><br><span class="line"><span class="comment">#dd if=/dev/sdg1 bs=4096 skip=$((2*29303104 + 4)) count=1 | xxd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#inode addr</span></span><br><span class="line"><span class="comment">#123(3) + #124(25) = 28</span></span><br><span class="line"><span class="comment">#The inode address of the root directory just inode offset 64 from AG 0</span></span><br><span class="line"><span class="comment"># rootino = 96 0x60  ## 56-63 bytes,Root directory&#x27;s inode</span></span><br><span class="line"></span><br><span class="line">rextslog = 0  <span class="comment"># 125      log2(real-time extents)   0</span></span><br><span class="line">inprogress = 0 <span class="comment"># 126      log2(real-time extents)  0</span></span><br><span class="line">imax_pct = 25  <span class="comment"># 127      log2(real-time extents)  0x19</span></span><br><span class="line"></span><br><span class="line">00000080  00 00 00 00 00 00 00 40  00 00 00 00 00 00 00 3b  |.......@.......;|</span><br><span class="line">icount = 128  <span class="comment"># 128-135  Number of allocated inodes , 0x40=64=1000000 2^7=128</span></span><br><span class="line">ifree = 119   <span class="comment"># 136-143  Number of free inodes, 3b=111011, 2^1+2^2+2^0+2^4+2^5+2^6=119</span></span><br><span class="line">??? <span class="comment"># not understand</span></span><br><span class="line"></span><br><span class="line">00000090  00 00 00 00 06 f7 bd 4b  00 00 00 00 00 00 00 00  |.......K........|</span><br><span class="line">fdblocks = 116890690 <span class="comment">#144-151  Number of free blocks</span></span><br><span class="line">frextents = 0        <span class="comment">#152-159  Number of free real-time extents</span></span><br><span class="line"></span><br><span class="line">000000a0  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">uquotino = null <span class="comment"># 160-167  User quota inode</span></span><br><span class="line">gquotino = null <span class="comment"># 168-175  Group quota inode</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">000000b0  00 00 00 00 00 00 00 04  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">qflags = 0 <span class="comment">#176-177  Quota flags</span></span><br><span class="line">flags = 0  <span class="comment">#178      Misc flags</span></span><br><span class="line">shared_vn = 0  <span class="comment">#178      Misc flags</span></span><br><span class="line">inoalignmt = 4 <span class="comment">#180-183  Inode alignment (in blocks)</span></span><br><span class="line">unit = 0       <span class="comment">#184-187  RAID unit (in blocks)</span></span><br><span class="line">width = 0      <span class="comment">#188-191  RAID stripe (in blocks)</span></span><br><span class="line"></span><br><span class="line">000000c0  00 0c 10 00 00 00 10 00  00 00 01 8a 00 00 01 8a  |................|</span><br><span class="line">dirblklog = 0    <span class="comment">#192      log2(dir blk allocation granularity)</span></span><br><span class="line">logsectlog = 12  <span class="comment">#193      log2(sector size of externl journal device)</span></span><br><span class="line">logsectsize = 4096 <span class="comment">#194-195  Sector size of external journal device</span></span><br><span class="line">logsunit = 4096  <span class="comment">#196-199  Stripe/unit size of external journal device</span></span><br><span class="line">features2 = 0x18a <span class="comment">#200-203  Additional flags</span></span><br><span class="line">bad_features2 = 0x18a <span class="comment">#204-207  Repeat additional flags (for alignment)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">000000d0  00 00 00 00 00 00 00 00  00 00 00 01 00 00 00 00  |................|</span><br><span class="line">features_compat = 0   <span class="comment">#204-207  Repeat additional flags (for alignment)</span></span><br><span class="line">features_ro_compat = 0 <span class="comment">#212-215  Read-only feature flags</span></span><br><span class="line">features_incompat = 0x1 <span class="comment">#216-219  Read-write incompatibility flags</span></span><br><span class="line">features_log_incompat = 0 <span class="comment">#220-223  Read-write incompat flags for log (unused)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">000000e0  1f c6 e0 48 00 00 00 00  ff ff ff ff ff ff ff ff  |...H............|</span><br><span class="line">crc = 0x64b05119 (correct)  <span class="comment">#224-227  CRC32 checksum for superblock</span></span><br><span class="line">spino_align = 0  <span class="comment">#228-231  Sparse inode alignment</span></span><br><span class="line">pquotino = null <span class="comment">#232-239  Project quota inode</span></span><br><span class="line"></span><br><span class="line">000000f0  00 00 00 01 00 00 00 90  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">lsn = 0x1000000c8 240-247  Log seq number of last superblock update</span><br><span class="line">meta_uuid = 00000000-0000-0000-0000-000000000000 <span class="comment"># 248-263  UUID used if INCOMPAT_META_UUID feature      zeroed</span></span><br><span class="line"></span><br><span class="line">                                  <span class="comment">#264</span></span><br><span class="line">00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">264-271  If INCOMPAT_META_RMAPBT, inode of RM btree   zeroed</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;http://fibrevillage.com/storage&quot;&gt;reference&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&quot;format&quot;&gt;&lt;a href=&quot;#format&quot; class=&quot;headerlink&quot; title=&quot;format&quot;&gt;&lt;/a&gt;format&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Raid 60  24 HDD ，12HDD/per raid6   （12-2）× 2 ， Raid stripe size 64KB&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mkfs.xfs -f -d sunit=64,swidth=$((&lt;span class=&quot;number&quot;&gt;64&lt;/span&gt;*&lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;)) /dev/sdxx1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#su: Stripe unit, which is the RAID chunk size, in bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#sw: Multiplier of the stripe unit, i.e. number of data disks&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mkfs.xfs /dev/device&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mkfs. xfs -d su= 64k,sw= 4 /dev/device&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;su = value&lt;br&gt;    Specifies a stripe unit or RAID chunk size. The value must be specified in bytes, with an optional k, m, or g suffix.&lt;br&gt;sw= value&lt;br&gt;    Specifies the number of data disks in a RAID device, or the number of stripe units in the stripe.&lt;/p&gt;</summary>
    
    
    
    <category term="Storage" scheme="http://yoursite.com/categories/Storage/"/>
    
    
    <category term="xfs" scheme="http://yoursite.com/tags/xfs/"/>
    
  </entry>
  
  <entry>
    <title>Trace by bcc tools</title>
    <link href="http://yoursite.com/2019/10/31/bcc/"/>
    <id>http://yoursite.com/2019/10/31/bcc/</id>
    <published>2019-10-31T08:25:34.000Z</published>
    <updated>2021-01-27T08:26:36.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="bcc-tools"><a href="#bcc-tools" class="headerlink" title="bcc tools"></a>bcc tools</h3><h4 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">http://blog.witalis.net/linux%20dropwatch.html</span><br><span class="line">$ dropwatch -l kas</span><br><span class="line">Initalizing kallsyms db</span><br><span class="line">dropwatch&gt; start</span><br><span class="line">Enabling monitoring...</span><br><span class="line">Kernel monitoring activated.</span><br><span class="line">Issue Ctrl-C to stop monitoring</span><br><span class="line">1 drops at skb_queue_purge+18 (0xffffffff9a23c808)</span><br><span class="line">3 drops at skb_queue_purge+18 (0xffffffff9a23c808)</span><br><span class="line"></span><br><span class="line">$ /usr/share/bcc/tools/trace <span class="string">&#x27;r::skb_queue_purge &quot;%d&quot;, retval&#x27;</span></span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">1       1       systemd         skb_queue_purge  0</span><br><span class="line"></span><br><span class="line"><span class="comment">#include/linux/skbuff.h</span></span><br><span class="line">/**</span><br><span class="line"> *__skb_queue_purge - empty a list</span><br><span class="line"> *@list: list to empty</span><br><span class="line"> *</span><br><span class="line"> *Delete all buffers on an &amp;sk_buff list. Each buffer is removed from</span><br><span class="line"> *the list and one reference dropped. This <span class="keyword">function</span> does not take the</span><br><span class="line"> *list lock and the <span class="built_in">caller</span> must hold the relevant locks to use it.</span><br><span class="line"> */</span><br><span class="line">void skb_queue_purge(struct sk_buff_head *list);</span><br><span class="line">static inline void __skb_queue_purge(struct sk_buff_head *list)</span><br><span class="line">&#123;</span><br><span class="line">struct sk_buff *skb;</span><br><span class="line"><span class="keyword">while</span> ((skb = __skb_dequeue(list)) != NULL)</span><br><span class="line">kfree_skb(skb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat /proc/56531/stack  | grep do_sys_open</span><br><span class="line">[&lt;ffffffff89249924&gt;] do_sys_open+0x124/0x220</span><br><span class="line"></span><br><span class="line">$ ./trace -p 56531 <span class="string">&#x27;do_sys_open &quot;%d,%s&quot;, arg3,arg2&#x27;</span></span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">56531   56531   touch           do_sys_open      35137,/455f50ec5f4beedd/8f03548dd535b880</span><br><span class="line"></span><br><span class="line">include/linux/fs.h</span><br><span class="line">extern long do_sys_open(int dfd, const char __user *filename, int flags,</span><br><span class="line">                        umode_t mode);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ./trace <span class="string">&#x27;sys_execve &quot;%s&quot;, arg1&#x27;</span></span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">13312   13312   bash            sys_execve       /usr/bin/bpftrace</span><br><span class="line">13326   13326   bash            sys_execve       /usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">$ ./trace <span class="string">&#x27;sys_read (arg3 &gt; 20000) &quot;read %d bytes&quot;, arg3&#x27;</span></span><br><span class="line">49911   49911   rsync           sys_read         <span class="built_in">read</span> 32768 bytes</span><br><span class="line">49911   49911   rsync           sys_read         <span class="built_in">read</span> 32768 bytes</span><br><span class="line">49909   49909   rsync           sys_read         <span class="built_in">read</span> 262144 bytes</span><br><span class="line">49911   49911   rsync           sys_read         <span class="built_in">read</span> 32768 bytes</span><br><span class="line">49911   49911   rsync           sys_read         <span class="built_in">read</span> 32768 bytes</span><br><span class="line"></span><br><span class="line">  -K, --kernel-stack    output kernel stack trace</span><br><span class="line">  -U, --user-stack      output user stack trace</span><br><span class="line">  -n NAME, --name NAME  only <span class="built_in">print</span> process names containing this name</span><br><span class="line"></span><br><span class="line">$ ./trace <span class="string">&#x27;do_sys_open &quot;%s&quot;, arg2@user&#x27;</span> -UK -n rsync</span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">49909   49909   rsync           do_sys_open      data/test_file</span><br><span class="line">        do_sys_open+0x1 [kernel]</span><br><span class="line">        system_call_fastpath+0x25 [kernel]</span><br><span class="line">        __open_nocancel+0x7 [libc-2.17.so]</span><br><span class="line">        [unknown]</span><br><span class="line">        [unknown]</span><br><span class="line"></span><br><span class="line">The special retval keyword stands <span class="keyword">for</span> the <span class="keyword">function</span><span class="string">&#x27;s return value, and can be used only in a retprobe, specified by the &#x27;</span>r<span class="string">&#x27; prefix</span></span><br><span class="line"><span class="string">$ ./trace &#x27;</span>r:bash:readline <span class="string">&quot;%s&quot;</span>, retval<span class="string">&#x27;</span></span><br><span class="line"><span class="string">PID     TID     COMM            FUNC             -</span></span><br><span class="line"><span class="string">51006   51006   bash            readline         echo test</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   -a, --address         print virtual address in stacks</span></span><br><span class="line"><span class="string">$ ./trace -U -a &#x27;</span>r::sys_futex <span class="string">&quot;%d&quot;</span>, retval<span class="string">&#x27;</span></span><br><span class="line"><span class="string">PID     TID     COMM            FUNC             -</span></span><br><span class="line"><span class="string">1       51216   systemd         sys_futex        0</span></span><br><span class="line"><span class="string">            7f86f0025ef4 start_thread+0x154 [libpthread-2.17.so]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   -T, --time            print time column</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ trace &#x27;</span>r:c:<span class="built_in">read</span> ((int)retval &lt; 0) <span class="string">&quot;read failed: %d&quot;</span>, retval<span class="string">&#x27; &#x27;</span>r:c:write ((int)retval &lt; 0) <span class="string">&quot;write failed: %d&quot;</span>, retval<span class="string">&#x27; -T</span></span><br><span class="line"><span class="string">TIME     PID    COMM         FUNC             -</span></span><br><span class="line"><span class="string">05:31:57 3388   bash         write            write failed: -1</span></span><br><span class="line"><span class="string">05:32:00 3388   bash         write            write failed: -1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## kernel tracepoint</span></span><br><span class="line"><span class="string">$ ./trace &#x27;</span>t:block:block_rq_complete <span class="string">&quot;sectors=%d&quot;</span>, args-&gt;nr_sector<span class="string">&#x27; -T</span></span><br><span class="line"><span class="string">TIME     PID     TID     COMM            FUNC             -</span></span><br><span class="line"><span class="string">17:26:16 0       0       swapper/12      block_rq_complete sectors=0</span></span><br><span class="line"><span class="string">17:26:18 0       0       swapper/12      block_rq_complete sectors=0</span></span><br><span class="line"><span class="string">17:26:21 0       0       swapper/12      block_rq_complete sectors=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Suppose that you want to trace a system-call in a short-lived process, you can use the -s option to trace. The option is followed by list of libraries/executables to use for symbol resolution.</span></span><br><span class="line"><span class="string">$ trace -s /lib/x86_64-linux-gnu/libc.so.6,/bin/ping &#x27;</span>p:c:inet_pton<span class="string">&#x27; -U</span></span><br><span class="line"><span class="string">Note: Kernel bpf will report stack map with ip/build_id</span></span><br><span class="line"><span class="string">53298   53298   ping            inet_pton</span></span><br><span class="line"><span class="string">        [unknown]</span></span><br><span class="line"><span class="string">        [unknown]</span></span><br><span class="line"><span class="string">        _init+0xf08 [ping]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">More and more high-level libraries are instrumented with USDT probe support.</span></span><br><span class="line"><span class="string">The &quot;%U&quot; format specifier tells trace to resolve arg3 as a user-space symbol, if possible. Similarly, use &quot;%K&quot; for kernel symbols.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ./trace &#x27;</span>u:pthread:pthread_create <span class="string">&quot;%U&quot;</span>, arg3<span class="string">&#x27; -T -C</span></span><br><span class="line"><span class="string">TIME     CPU PID     TID     COMM            FUNC             -</span></span><br><span class="line"><span class="string">17:39:51 4   1       1       systemd         pthread_create   [unknown] [systemd]</span></span><br><span class="line"><span class="string">17:39:53 4   1       1       systemd         pthread_create   [unknown] [systemd]</span></span><br><span class="line"><span class="string">17:39:54 4   1       1       systemd         pthread_create   [unknown] [systemd]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Ruby, Node, and OpenJDK are also instrumented with USDT. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># trace &#x27;</span>u:ruby:method__entry <span class="string">&quot;%s.%s&quot;</span>, arg1, arg2<span class="string">&#x27; -p $(pidof irb) -T</span></span><br><span class="line"><span class="string">TIME     PID    COMM         FUNC             -</span></span><br><span class="line"><span class="string">12:08:43 18420  irb          method__entry    IRB::Context.verbose?</span></span><br><span class="line"><span class="string">12:08:43 18420  irb          method__entry    RubyLex.ungetc</span></span><br><span class="line"><span class="string">12:08:43 18420  irb          method__entry    RuxyLex.debug?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can also trace exported functions from shared libraries, or an imported</span></span><br><span class="line"><span class="string">function on the actual executable:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ./trace.py &#x27;</span>r:/usr/lib64/libtinfo.so:curses_version <span class="string">&quot;Version=%s&quot;</span>, retval<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$  trace &#x27;</span>p:c:open (STRCMP(<span class="string">&quot;test.txt&quot;</span>, arg1)) <span class="string">&quot;opening %s&quot;</span>, arg1<span class="string">&#x27; -T</span></span><br><span class="line"><span class="string">TIME     PID     TID     COMM            FUNC             -</span></span><br><span class="line"><span class="string">17:44:39 53592   53592   cat             open             opening test.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ trace &#x27;</span>p:c:open(char *filename) <span class="string">&quot;opening %s&quot;</span>, filename<span class="string">&#x27;</span></span><br><span class="line"><span class="string">PID     TID     COMM            FUNC             -</span></span><br><span class="line"><span class="string">53665   53665   bash            open             opening test2.txt</span></span><br><span class="line"><span class="string">53665   53665   cat             open             opening test1.txt</span></span><br><span class="line"><span class="string">2381    2381    irqbalance      open             opening /proc/interrupts</span></span><br><span class="line"><span class="string">2381    2381    irqbalance      open             opening /proc/stat</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ./trace &#x27;</span>p::SyS_nanosleep(struct timespec *ts) <span class="string">&quot;sleep for %lld ns&quot;</span>, ts-&gt;tv_nsec<span class="string">&#x27;</span></span><br><span class="line"><span class="string">PID     TID     COMM            FUNC             -</span></span><br><span class="line"><span class="string">2381    2381    irqbalance      SyS_nanosleep    sleep for 998581000 ns</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Remember to use the -I argument include the appropriate header file. We didn&#x27;</span>t need to <span class="keyword">do</span> that here because `struct timespec` is used internally by the tool, so it always includes this header file.</span><br><span class="line"></span><br><span class="line">$ ./trace -I <span class="string">&#x27;/usr/include/linux/perf_event.h&#x27;</span> <span class="string">&#x27;t:syscalls:sys_enter_perf_event_open &quot;%d&quot;, args-&gt;attr_uptr-&gt;config1&#x27;</span></span><br><span class="line"></span><br><span class="line">$ trace -p 2740 <span class="string">&#x27;do_sys_open &quot;%s&quot;, arg2@user&#x27;</span> -T</span><br><span class="line">extern long do_sys_open(int dfd, const char __user *filename, int flags,</span><br><span class="line">umode_t mode);</span><br><span class="line"></span><br><span class="line">$  ./trace sys_open</span><br><span class="line">PID     TID     COMM            FUNC</span><br><span class="line">2551    2551    irqbalance      sys_open</span><br><span class="line"></span><br><span class="line">The perf ring buffer size can be changed with -b. The unit is size per-CPU buffer size and is measured <span class="keyword">in</span> pages. The value must be a power of two and defaults to 64 pages.</span><br><span class="line">asmlinkage long sys_setsockopt(int fd, int level, int optname,</span><br><span class="line">char __user *optval, int optlen);</span><br><span class="line"></span><br><span class="line">$ ./trace <span class="string">&#x27;sys_setsockopt(int fd, int level, int optname, char* optval, int optlen)(level==0 &amp;&amp; optname == 1 &amp;&amp; STRCMP(&quot;&#123;0x6C, 0x00, 0x00, 0x00&#125;&quot;, optval))&#x27;</span> -U -M 1 --bin_cmp</span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">1855611 1863183 worker          sys_setsockopt   found</span><br><span class="line"></span><br><span class="line">In this example we are catching setsockopt syscall to change IPv4 IP_TOS value only <span class="keyword">for</span> the cases <span class="built_in">where</span> new TOS value is equal to 108. we are using STRCMP helper <span class="keyword">in</span> binary mode (--bin_cmp flag) to compare optval array against int value of 108 (parametr of setsockopt call) <span class="keyword">in</span> hex representation (little endian format)</span><br></pre></td></tr></table></figure><h4 id="profile"><a href="#profile" class="headerlink" title="profile"></a>profile</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.<span class="built_in">/profile </span>            #<span class="built_in"> profile </span>stack traces at 49 Hertz until Ctrl-C</span><br><span class="line">.<span class="built_in">/profile </span>-F 99       #<span class="built_in"> profile </span>stack traces at 99 Hertz</span><br><span class="line">.<span class="built_in">/profile </span>-c 1000000  #<span class="built_in"> profile </span>stack traces every 1 <span class="keyword">in</span> a million events</span><br><span class="line">.<span class="built_in">/profile </span>5           #<span class="built_in"> profile </span>at 49 Hertz <span class="keyword">for</span> 5 seconds only</span><br><span class="line">.<span class="built_in">/profile </span>-f 5        # output <span class="keyword">in</span> folded format <span class="keyword">for</span> flame graphs</span><br><span class="line">     .<span class="built_in">/profile </span>-df -p `pgrep -n func_ab` 5 &gt; out.profile</span><br><span class="line">     ./FlameGraph/flamegraph.pl &lt; out.profile &gt; out.svg</span><br><span class="line"></span><br><span class="line">.<span class="built_in">/profile </span>-p 185      # only<span class="built_in"> profile </span>process with PID 185</span><br><span class="line">.<span class="built_in">/profile </span>-L 185      # only<span class="built_in"> profile </span>thread with TID 185</span><br><span class="line">.<span class="built_in">/profile </span>-U          # only show<span class="built_in"> user </span>space stacks (<span class="literal">no</span> kernel)</span><br><span class="line">.<span class="built_in">/profile </span>-K          # only show kernel space stacks (<span class="literal">no</span> user)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./profile -adf -p `pgrep -n touch` 10</span><br><span class="line">touch;__close_nocancel;-;system_call_fastpath;SyS_close;__close_fd;filp_close;nfs_file_flush;nfs_file_fsync;nfs_file_fsync 1</span><br><span class="line">touch;__open_nocancel;-;system_call_fastpath;sys_open;do_sys_open;do_filp_open;path_openat;do_last;lookup_real;nfs_lookup;nfs3_proc_lookup;nfs3_rpc_wrapper.constprop.11;rpc_call_sync;rpc_run_task;rpc_execute;__rpc_execute;out_of_line_wait_on_bit;__wait_on_bit;rpc_wait_bit_killable;schedule;__schedule;finish_task_switch;finish_task_switch 1</span><br><span class="line">touch;__close_nocancel;-;int_signal;do_notify_resume;task_work_run;____fput;__fput;nfs_file_release;nfs_file_clear_open_context;__put_nfs_open_context;kfree;kfree 1</span><br><span class="line">touch;__open_nocancel;-;system_call_fastpath;sys_open;do_sys_open;do_filp_open;path_openat;do_last;vfs_create;nfs_create;nfs3_proc_create;nfs3_do_create;nfs3_rpc_wrapper.constprop.11;rpc_call_sync;rpc_run_task;rpc_execute;__rpc_execute;out_of_line_wait_on_bit;__wait_on_bit;rpc_wait_bit_killable;schedule;__schedule;finish_task_switch;finish_task_switch 1</span><br><span class="line">touch;futimens;-;system_call_fastpath;sys_utimensat;do_utimes;utimes_common;notify_change;nfs_setattr;nfs3_proc_setattr;nfs3_rpc_wrapper.constprop.11;rpc_call_sync;rpc_run_task;rpc_execute;__rpc_execute;out_of_line_wait_on_bit;__wait_on_bit;rpc_wait_bit_killable;schedule;__schedule;finish_task_switch;finish_task_switch 1</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p><a href="https://zhuanlan.zhihu.com/p/266596607">reference</a></p><h4 id="Network"><a href="#Network" class="headerlink" title="Network"></a><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking">Network</a></h4><ul><li><p>tcpaccept </p><ul><li>Each time the kernel accepts a connection, tcpaccept displays the details of the connections<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tcpaccept -t        # include timestamps</span><br><span class="line">./tcpaccept -P 80,81  # only trace<span class="built_in"> port </span>80 <span class="keyword">and</span> 81</span><br><span class="line">./tcpaccept -p 181    # only trace PID 181</span><br></pre></td></tr></table></figure></li></ul></li><li><p>tcpconnect</p><ul><li>Each time the kernel processes an outgoing connection, tcpconnect displays the details of the connections<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./tcpconnect           # trace all TCP connect()s</span><br><span class="line">./tcpconnect -t        # include timestamps</span><br><span class="line">./tcpconnect -p 181    # only trace PID 181</span><br><span class="line">./tcpconnect -P 80     # only trace<span class="built_in"> port </span>80</span><br><span class="line">./tcpconnect -P 80,81  # only trace<span class="built_in"> port </span>80 <span class="keyword">and</span> 81</span><br><span class="line">./tcpconnect -U        # include UID</span><br><span class="line">./tcpconnect -u 1000   # only trace UID 1000</span><br><span class="line">./tcpconnect -c        # count connects per src<span class="built_in"> ip </span><span class="keyword">and</span> dest ip/port</span><br></pre></td></tr></table></figure></li></ul></li><li><p>tcpconnlat</p><ul><li>Each time the kernel processes an outgoing connection, tcpconnlat displays the details of the connection after the kernel receives the response packet<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./tcpconnlat</span>           <span class="comment"># trace all TCP connect()s</span></span><br><span class="line"><span class="string">./tcpconnlat</span> -t        <span class="comment"># include timestamps</span></span><br><span class="line"><span class="string">./tcpconnlat</span> -p 181    <span class="comment"># only trace PID 181</span></span><br><span class="line"><span class="string">./tcpconnlat</span> 1         <span class="comment"># only show connects longer than 1 ms</span></span><br><span class="line"><span class="string">./tcpconnlat</span> 0.1       <span class="comment"># only show connects longer than 100 us</span></span><br><span class="line"><span class="string">./tcpconnlat</span> -v        <span class="comment"># Show the BPF program</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>tcpdrop</p><ul><li>Each time the kernel drops TCP packets and segments, tcpdrop displays the details of the connection, including the kernel stack trace that led to the dropped package</li></ul></li><li><p>tcplife</p><ul><li>Each time a connection is closed, tcplife displays the details of the connections<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./tcplife           # trace all TCP connect()s</span><br><span class="line">./tcplife -t        # include time column (HH:MM:SS)</span><br><span class="line">./tcplife -w        # wider colums (fit IPv6)</span><br><span class="line">./tcplife -stT      # csv output, with times &amp; timestamps</span><br><span class="line">./tcplife -p 181    # only trace PID 181</span><br><span class="line">./tcplife -L 80     # only trace local<span class="built_in"> port </span>80</span><br><span class="line">./tcplife -L 80,81  # only trace local ports 80 <span class="keyword">and</span> 81</span><br><span class="line">./tcplife -D 80     # only trace remote<span class="built_in"> port </span>80</span><br></pre></td></tr></table></figure></li></ul></li><li><p>tcpretrans</p><ul><li>Each time the kernel calls the TCP retransmit function, tcpretrans displays the details of the connection</li></ul></li><li><p>tcpstates</p><ul><li>Each time a connection changes its state, tcpstates displays a new line with updated connection details<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./tcpstates           # trace all TCP state changes</span><br><span class="line">./tcpstates -t        # include timestamp column</span><br><span class="line">./tcpstates -T        # include time column (HH:MM:SS)</span><br><span class="line">./tcpstates -w        # wider colums (fit IPv6)</span><br><span class="line">./tcpstates -stT      # csv output, with times &amp; timestamps</span><br><span class="line">./tcpstates -Y        # log events <span class="keyword">to</span> the systemd journal</span><br><span class="line">./tcpstates -L 80     # only trace local<span class="built_in"> port </span>80</span><br><span class="line">./tcpstates -L 80,81  # only trace local ports 80 <span class="keyword">and</span> 81</span><br><span class="line">./tcpstates -D 80     # only trace remote<span class="built_in"> port </span>80</span><br></pre></td></tr></table></figure></li></ul></li><li><p>tcpsubnet</p><ul><li>This command displays the traffic in bytes for the specified subnets once per second<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./tcpsubnet -f K            # Trace TCP sent <span class="keyword">to</span> the<span class="built_in"> default </span>subnets</span><br><span class="line">                            # aggregated <span class="keyword">in</span> KBytes.</span><br><span class="line">./tcpsubnet 10.80.0.0/24    # Trace TCP sent <span class="keyword">to</span> 10.80.0.0/24 only</span><br><span class="line">./tcpsubnet -J              # Format the output <span class="keyword">in</span> JSON.</span><br></pre></td></tr></table></figure></li></ul></li><li><p>tcptop</p><ul><li>The output of the command includes only active TCP connections. If the local or remote system closes a connection, the connection is no longer visible in the output<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./tcptop</span>           <span class="comment"># trace TCP send/recv by host</span></span><br><span class="line"><span class="string">./tcptop</span> -C        <span class="comment"># don&#x27;t clear the screen</span></span><br><span class="line"><span class="string">./tcptop</span> -p 181    <span class="comment"># only trace PID 181</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>tcptracer</p><ul><li>Each time the kernel connects, accepts, or closes a connection, tcptracer displays the details of the connections</li></ul></li><li><p>solisten</p><ul><li>This tool traces the kernel function called when a program wants to listen for TCP connections. It will not see UDP neither UNIX domain sockets<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ./solisten.py --show-netns</span><br><span class="line">PID    COMM         NETNS        PROTO  BACKLOG  ADDR                                    PORT</span><br><span class="line"><span class="number">3643</span>   nc           <span class="number">4026531957</span>   TCPv4  <span class="number">1</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>                                 <span class="number">4242</span></span><br><span class="line"><span class="number">3659</span>   nc           <span class="number">4026531957</span>   TCPv6  <span class="number">1</span>        <span class="number">2001</span>:f0d0:<span class="number">1002</span>:<span class="number">51</span>::<span class="number">4</span>                    <span class="number">4242</span></span><br><span class="line"><span class="number">4221</span>   redis-server <span class="number">4026532165</span>   TCPv6  <span class="number">128</span>      ::                                      <span class="number">6379</span></span><br><span class="line"><span class="number">4221</span>   redis-server <span class="number">4026532165</span>   TCPv4  <span class="number">128</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>                                 <span class="number">6379</span></span><br><span class="line"><span class="number">6067</span>   nginx        <span class="number">4026531957</span>   TCPv4  <span class="number">128</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>                                 <span class="number">80</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>softirqs</p><ul><li>This program traces soft interrupts (irqs), and stores timing statistics in-kernel for efficiency<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./softirqs            # sum soft<span class="built_in"> irq </span>event time</span><br><span class="line">./softirqs -d         # show soft<span class="built_in"> irq </span>event time as histograms</span><br><span class="line">./softirqs 1 10       # <span class="builtin-name">print</span> 1 second summaries, 10 times</span><br><span class="line">./softirqs -NT 1      # 1s summaries, nanoseconds, <span class="keyword">and</span> timestamps</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="func"><a href="#func" class="headerlink" title="func"></a>func</h4><ul><li><p>funclatency</p><ul><li>Time functions and print latency as a histogram<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/bcc/tools/funclatency -T -m -d 3600 dsl_pool_sync</span><br><span class="line"></span><br><span class="line">    ./funclatency do_sys_open       <span class="comment"># time the do_sys_open() kernel function</span></span><br><span class="line">    ./funclatency c:<span class="built_in">read</span>            <span class="comment"># time the read() C library function</span></span><br><span class="line">    ./funclatency -u vfs_read       <span class="comment"># time vfs_read(), in microseconds</span></span><br><span class="line">    ./funclatency -m do_nanosleep   <span class="comment"># time do_nanosleep(), in milliseconds</span></span><br><span class="line">    ./funclatency -i 2 -d 10 c:open <span class="comment"># output every 2 seconds, for duration 10s</span></span><br><span class="line">    ./funclatency -mTi 5 vfs_read   <span class="comment"># output every 5 seconds, with timestamps</span></span><br><span class="line">    ./funclatency -p 181 vfs_read   <span class="comment"># time process 181 only</span></span><br><span class="line">    ./funclatency <span class="string">&#x27;vfs_fstat*&#x27;</span>      <span class="comment"># time both vfs_fstat() and vfs_fstatat()</span></span><br><span class="line">    ./funclatency <span class="string">&#x27;c:*printf&#x27;</span>       <span class="comment"># time the *printf family of functions</span></span><br><span class="line">    ./funclatency -F <span class="string">&#x27;vfs_r*&#x27;</span>       <span class="comment"># show one histogram per matched function</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>funccount</p><ul><li>This program traces functions, tracepoints, or USDT probes that match a specified pattern<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./funccount <span class="string">&#x27;vfs_*&#x27;</span>             # <span class="built_in">count</span> kernel fns starting with <span class="string">&quot;vfs&quot;</span></span><br><span class="line">./funccount -r <span class="string">&#x27;^vfs.*&#x27;</span>         # same <span class="keyword">as</span> above, using regular expressions</span><br><span class="line">./funccount -Ti <span class="number">5</span> <span class="string">&#x27;vfs_*&#x27;</span>       # output every <span class="number">5</span> seconds, with timestamps</span><br><span class="line">./funccount -d <span class="number">10</span> <span class="string">&#x27;vfs_*&#x27;</span>       # trace <span class="keyword">for</span> <span class="number">10</span> seconds <span class="keyword">only</span></span><br><span class="line">./funccount -<span class="keyword">p</span> <span class="number">185</span> <span class="string">&#x27;vfs_*&#x27;</span>      # <span class="built_in">count</span> vfs calls <span class="keyword">for</span> PID <span class="number">181</span> <span class="keyword">only</span></span><br><span class="line">./funccount <span class="variable">t:sched</span>:sched_fork  # <span class="built_in">count</span> calls <span class="keyword">to</span> the sched_fork tracepoint</span><br><span class="line">./funccount -<span class="keyword">p</span> <span class="number">185</span> <span class="keyword">u</span>:node:gc*   # <span class="built_in">count</span> <span class="keyword">all</span> GC USDT probes in node, PID <span class="number">185</span></span><br><span class="line">./funccount <span class="keyword">c</span>:malloc            # <span class="built_in">count</span> <span class="keyword">all</span> malloc() calls in libc</span><br><span class="line">./funccount <span class="keyword">go</span>:os.*             # <span class="built_in">count</span> <span class="keyword">all</span> <span class="string">&quot;os.*&quot;</span> calls in libgo</span><br><span class="line">./funccount -<span class="keyword">p</span> <span class="number">185</span> <span class="keyword">go</span>:os.*      # <span class="built_in">count</span> <span class="keyword">all</span> <span class="string">&quot;os.*&quot;</span> calls in libgo, PID <span class="number">185</span></span><br><span class="line">./funccount ./tes<span class="variable">t:read</span>*        # <span class="built_in">count</span> <span class="string">&quot;read*&quot;</span> calls in the ./test binary</span><br></pre></td></tr></table></figure></li></ul></li><li><p>funcslower</p><ul><li>funcslower shows kernel or user function invocations slower than a threshold<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./funcslower</span> vfs_write       <span class="comment"># trace vfs_write calls slower than 1ms</span></span><br><span class="line"><span class="string">./funcslower</span> -m 10 vfs_write <span class="comment"># same, but slower than 10ms</span></span><br><span class="line"><span class="string">./funcslower</span> -u 10 c<span class="function">:open</span>    <span class="comment"># trace open calls slower than 10us</span></span><br><span class="line"><span class="string">./funcslower</span> -p 135 c<span class="function">:open</span>   <span class="comment"># trace pid 135 only</span></span><br><span class="line"><span class="string">./funcslower</span> c<span class="function">:malloc</span> c<span class="function">:free</span> <span class="comment"># trace both malloc and free slower than 1ms</span></span><br><span class="line"><span class="string">./funcslower</span> -a 2 c<span class="function">:open</span>     <span class="comment"># show first two arguments to open</span></span><br></pre></td></tr></table></figure></li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;bcc-tools&quot;&gt;&lt;a href=&quot;#bcc-tools&quot; class=&quot;headerlink&quot; title=&quot;bcc tools&quot;&gt;&lt;/a&gt;bcc tools&lt;/h3&gt;&lt;h4 id=&quot;trace&quot;&gt;&lt;a href=&quot;#trace&quot; class=&quot;header</summary>
      
    
    
    
    <category term="Scripts" scheme="http://yoursite.com/categories/Scripts/"/>
    
    
    <category term="debug" scheme="http://yoursite.com/tags/debug/"/>
    
    <category term="trace" scheme="http://yoursite.com/tags/trace/"/>
    
  </entry>
  
  <entry>
    <title>golang</title>
    <link href="http://yoursite.com/2019/10/10/golang/"/>
    <id>http://yoursite.com/2019/10/10/golang/</id>
    <published>2019-10-10T15:38:16.000Z</published>
    <updated>2020-10-11T07:44:55.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="runtime-pprof-example"><a href="#runtime-pprof-example" class="headerlink" title="runtime/pprof example"></a>runtime/pprof example</h3><a id="more"></a><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pprof</span></span><br><span class="line"><span class="string">&quot;runtime/pprof&quot;</span></span><br><span class="line"><span class="comment">//end</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//pprof</span></span><br><span class="line"><span class="keyword">var</span> cpuprofile = flag.String(<span class="string">&quot;cpuprofile&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;write cpu profile to file.&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> memprofile = flag.String(<span class="string">&quot;memprofile&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;write memory profile to `file`&quot;</span>)</span><br><span class="line"><span class="comment">//end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Send the sequence 2, 3, 4, ... to channel &#x27;ch&#x27;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Generate</span><span class="params">(ch <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span>; ;i++ &#123;</span><br><span class="line">          ch &lt;- i <span class="comment">// Send &#x27;i&#x27; to channel &#x27;ch&#x27;.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Copy the values from channel &#x27;in&#x27; to channel &#x27;out&#x27;,</span></span><br><span class="line"><span class="comment">// removing those divisible by &#x27;prime&#x27;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Filter</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, out <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>, prime <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        i := &lt;-in <span class="comment">// Receive value from &#x27;in&#x27;.</span></span><br><span class="line">        <span class="keyword">if</span> i%prime != <span class="number">0</span> &#123;</span><br><span class="line">            out &lt;- i <span class="comment">// Send &#x27;i&#x27; to &#x27;out&#x27;.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The prime sieve: Daisy-chain Filter processes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pprof</span></span><br><span class="line">    flag.Parse()</span><br><span class="line">    <span class="keyword">if</span> *cpuprofile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">         f,err := os.Create(*cpuprofile)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             log.Fatal(err)</span><br><span class="line">         &#125;</span><br><span class="line">         pprof.StartCPUProfile(f)</span><br><span class="line">         <span class="keyword">defer</span> pprof.StopCPUProfile()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *memprofile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">         f,err := os.Create(*memprofile)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             log.Fatal(err)</span><br><span class="line">         &#125;</span><br><span class="line">         runtime.GC()</span><br><span class="line">         <span class="keyword">if</span> err := pprof.WriteHeapProfile(f); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             log.Fatal(err)</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//f.Close()</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ch := make(chan int, runtime.NumCPU()) // Create a new channel.</span></span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">128</span>) <span class="comment">// Create a new channel.</span></span><br><span class="line">    <span class="keyword">go</span> Generate(ch)      <span class="comment">// Launch Generate goroutine.</span></span><br><span class="line">    now := time.Now()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">200000</span>; i++ &#123;</span><br><span class="line">          prime := &lt;-ch</span><br><span class="line">          <span class="keyword">if</span> (i!=<span class="number">0</span> &amp;&amp; i%<span class="number">1000</span>==<span class="number">0</span>) &#123;</span><br><span class="line">            fmt.Println(i)</span><br><span class="line">            fmt.Println(<span class="string">&quot;time consuming:&quot;</span>, time.Since(now))</span><br><span class="line">            now = time.Now()</span><br><span class="line">          &#125;</span><br><span class="line">          ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">128</span>)</span><br><span class="line">          <span class="keyword">go</span> Filter(ch, ch1, prime)</span><br><span class="line">          ch = ch1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">go</span> <span class="string">build</span> <span class="string">prime.go</span></span><br><span class="line"><span class="string">$</span> <span class="string">./prime</span> <span class="string">-cpuprofile</span> <span class="string">cpu.prof</span> <span class="string">-memprofile</span> <span class="string">mem.prof</span></span><br><span class="line"><span class="string">$</span> <span class="string">go</span> <span class="string">tool</span> <span class="string">pprof</span> <span class="string">prime</span> <span class="string">./cpu.prof</span></span><br><span class="line"><span class="attr">File:</span> <span class="string">prime</span></span><br><span class="line"><span class="attr">Type:</span> <span class="string">cpu</span></span><br><span class="line"><span class="attr">Time:</span> <span class="string">Oct</span> <span class="number">10</span><span class="string">,</span> <span class="number">2019 </span><span class="string">at</span> <span class="number">11</span><span class="string">:46pm</span> <span class="string">(HKT)</span></span><br><span class="line"><span class="attr">Duration:</span> <span class="number">5.</span><span class="string">09mins,</span> <span class="string">Total</span> <span class="string">samples</span> <span class="string">=</span> <span class="number">49.</span><span class="string">93mins</span> <span class="string">(980.06%)</span></span><br><span class="line"><span class="string">Entering</span> <span class="string">interactive</span> <span class="string">mode</span> <span class="string">(type</span> <span class="string">&quot;help&quot;</span> <span class="string">for</span> <span class="string">commands,</span> <span class="string">&quot;o&quot;</span> <span class="string">for</span> <span class="string">options)</span></span><br><span class="line"><span class="string">(pprof)</span> <span class="string">top</span></span><br><span class="line"><span class="string">Showing</span> <span class="string">nodes</span> <span class="string">accounting</span> <span class="string">for</span> <span class="number">46.</span><span class="string">37mins,</span> <span class="number">92.87</span><span class="string">%</span> <span class="string">of</span> <span class="number">49.</span><span class="string">93mins</span> <span class="string">total</span></span><br><span class="line"><span class="string">Dropped</span> <span class="number">97</span> <span class="string">nodes</span> <span class="string">(cum</span> <span class="string">&lt;=</span> <span class="number">0.</span><span class="string">25mins)</span></span><br><span class="line"><span class="string">Showing</span> <span class="string">top</span> <span class="number">10</span> <span class="string">nodes</span> <span class="string">out</span> <span class="string">of</span> <span class="number">17</span></span><br><span class="line">      <span class="string">flat</span>  <span class="string">flat%</span>   <span class="string">sum%</span>        <span class="string">cum</span>   <span class="string">cum%</span></span><br><span class="line"> <span class="number">10.</span><span class="string">78mins</span> <span class="number">21.59</span><span class="string">%</span> <span class="number">21.59</span><span class="string">%</span>  <span class="number">10.</span><span class="string">79mins</span> <span class="number">21.61</span><span class="string">%</span>  <span class="string">runtime.lock</span></span><br><span class="line"> <span class="number">10.</span><span class="string">64mins</span> <span class="number">21.31</span><span class="string">%</span> <span class="number">42.90</span><span class="string">%</span>  <span class="number">10.</span><span class="string">64mins</span> <span class="number">21.31</span><span class="string">%</span>  <span class="string">runtime.unlock</span></span><br><span class="line">  <span class="number">5.</span><span class="string">78mins</span> <span class="number">11.58</span><span class="string">%</span> <span class="number">54.48</span><span class="string">%</span>  <span class="number">49.</span><span class="string">41mins</span> <span class="number">98.96</span><span class="string">%</span>  <span class="string">main.Filter</span></span><br><span class="line">  <span class="number">5.</span><span class="string">28mins</span> <span class="number">10.58</span><span class="string">%</span> <span class="number">65.06</span><span class="string">%</span>  <span class="number">22.</span><span class="string">28mins</span> <span class="number">44.63</span><span class="string">%</span>  <span class="string">runtime.chanrecv</span></span><br><span class="line">  <span class="number">4.</span><span class="string">19mins</span>  <span class="number">8.38</span><span class="string">%</span> <span class="number">73.44</span><span class="string">%</span>  <span class="number">19.</span><span class="string">19mins</span> <span class="number">38.43</span><span class="string">%</span>  <span class="string">runtime.chansend</span></span><br><span class="line">  <span class="number">3.</span><span class="string">03mins</span>  <span class="number">6.06</span><span class="string">%</span> <span class="number">79.50</span><span class="string">%</span>   <span class="number">5.</span><span class="string">33mins</span> <span class="number">10.68</span><span class="string">%</span>  <span class="string">runtime.typedmemmove</span></span><br><span class="line">  <span class="number">2.</span><span class="string">31mins</span>  <span class="number">4.62</span><span class="string">%</span> <span class="number">84.12</span><span class="string">%</span>   <span class="number">2.</span><span class="string">31mins</span>  <span class="number">4.62</span><span class="string">%</span>  <span class="string">runtime.memmove</span></span><br><span class="line">  <span class="number">1.</span><span class="string">70mins</span>  <span class="number">3.40</span><span class="string">%</span> <span class="number">87.52</span><span class="string">%</span>   <span class="number">2.</span><span class="string">86mins</span>  <span class="number">5.72</span><span class="string">%</span>  <span class="string">runtime.typedmemclr</span></span><br><span class="line">  <span class="number">1.</span><span class="string">46mins</span>  <span class="number">2.92</span><span class="string">%</span> <span class="number">90.45</span><span class="string">%</span>   <span class="number">1.</span><span class="string">46mins</span>  <span class="number">2.92</span><span class="string">%</span>  <span class="string">runtime.(*waitq).dequeue</span></span><br><span class="line">  <span class="number">1.</span><span class="string">21mins</span>  <span class="number">2.42</span><span class="string">%</span> <span class="number">92.87</span><span class="string">%</span>  <span class="number">20.</span><span class="string">40mins</span> <span class="number">40.85</span><span class="string">%</span>  <span class="string">runtime.chansend1</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">(pprof)</span> <span class="string">web</span></span><br><span class="line"><span class="string">failed</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">dot.</span> <span class="string">Is</span> <span class="string">Graphviz</span> <span class="string">installed?</span> <span class="attr">Error: exec:</span> <span class="attr">&quot;dot&quot;:</span> <span class="string">executable</span> <span class="string">file</span> <span class="string">not</span> <span class="string">found</span> <span class="string">in</span> <span class="string">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">go</span> <span class="string">tool</span> <span class="string">pprof</span> <span class="string">-http=:8080</span> <span class="string">cpu.prof</span></span><br><span class="line"><span class="string">Failed</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">dot.</span> <span class="string">Is</span> <span class="string">Graphviz</span> <span class="string">installed?</span></span><br><span class="line"><span class="attr">exec:</span> <span class="attr">&quot;dot&quot;:</span> <span class="string">executable</span> <span class="string">file</span> <span class="string">not</span> <span class="string">found</span> <span class="string">in</span> <span class="string">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">graphviz</span> <span class="string">graphviz-devel</span></span><br></pre></td></tr></table></figure><h3 id="bitwise-operators-example"><a href="#bitwise-operators-example" class="headerlink" title="bitwise operators example"></a>bitwise operators example</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 2</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 2     = 00000010</span></span><br><span class="line">    <span class="comment">// 1 | 2 = 00000011 = 3</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 5</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 5     = 00000101</span></span><br><span class="line">    <span class="comment">// 1 | 5 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise XOR ^ to get the bits that are in 3 OR 6 BUT NOT BOTH</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 ^ 6 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> ^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise AND &amp; to get the bits that are in 3 AND 6</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 &amp; 6 = 00000010 = 2</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> &amp; <span class="number">6</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bit clear AND NOT &amp;^ to get the bits that are in 3 AND NOT 6 (order matters)</span></span><br><span class="line">    <span class="comment">// 26     = 00011010</span></span><br><span class="line">    <span class="comment">// 6      = 00000110</span></span><br><span class="line">    <span class="comment">// turn          11111001</span></span><br><span class="line">    <span class="comment">// 3 &amp;^ 6 = 00011000 = 1</span></span><br><span class="line">    fmt.Println(<span class="number">26</span> &amp;^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-5  11111010+1=1111011 (two&#x27;s complement of 5, the value was -5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6  00000110</span></span><br><span class="line"><span class="comment">//-6  11111001+1=11111010</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-6  11111010 (one&#x27;s complement of 5, the value was -6)</span></span><br><span class="line"></span><br><span class="line">     fmt.Println(^<span class="number">5</span>) </span><br><span class="line"></span><br><span class="line">     a := <span class="number">1</span></span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">2</span> </span><br><span class="line">     <span class="comment">// 0000100 | 00000001 = 0000101 =5 </span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">6</span> </span><br><span class="line">     <span class="comment">// 0000101 | 0100000 = 0100101 =69</span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     fmt.Println(<span class="number">1</span>&lt;&lt;<span class="number">6</span>) </span><br><span class="line">     <span class="comment">//0000001 &lt;&lt;6 = 1000000 = 64</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="number">-6</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">69</span></span><br><span class="line"><span class="number">64</span></span><br></pre></td></tr></table></figure><p>###Reader to string</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">s := buf.String() <span class="comment">// Does a complete copy of the bytes in the buffer.</span></span><br><span class="line"></span><br><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">b := buf.Bytes()</span><br><span class="line">s := *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b, err := ioutil.ReadAll(rc); err == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">or gzip the buffer</span><br><span class="line">   raw := bytes.NewBuffer(data)</span><br><span class="line">   unz, err := gzip.NewReader(raw)</span><br><span class="line">   buf, err := ioutil.ReadAll(unz)</span><br><span class="line">   <span class="keyword">return</span> json.Unmarshal(buf, &amp;v)</span><br></pre></td></tr></table></figure><h3 id="string-to-reader"><a href="#string-to-reader" class="headerlink" title="string to reader"></a>string to reader</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">r:=strings.NewReader(<span class="string">&quot;(1,2,34,55,666)&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> d [<span class="number">5</span>]<span class="keyword">int</span></span><br><span class="line">fmt.Fscanf(r,<span class="string">&quot;(%d,%d,%d,%d,%d)&quot;</span>,&amp;d[<span class="number">0</span>],&amp;d[<span class="number">1</span>],&amp;d[<span class="number">2</span>],&amp;d[<span class="number">3</span>],&amp;d[<span class="number">4</span>])</span><br><span class="line">fmt.Println(d)</span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">buf := bytes.NewBufferString(<span class="string">&quot;R29waGVycyBydWxlIQ==&quot;</span>)</span><br><span class="line">dec := base64.NewDecoder(base64.StdEncoding, buf)</span><br><span class="line">io.Copy(os.Stdout, dec)</span><br></pre></td></tr></table></figure><h3 id="Ouput-to-stdout"><a href="#Ouput-to-stdout" class="headerlink" title="Ouput to stdout"></a>Ouput to stdout</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reader := bufio.NewReader(os.Stdin)</span><br><span class="line">fmt.Print(<span class="string">&quot;What is your name:&quot;</span>)</span><br><span class="line">data, _, _ := reader.ReadLine()</span><br><span class="line">fmt.Printf(<span class="string">&quot;Your name is %s.\r\n&quot;</span>, data)</span><br></pre></td></tr></table></figure><p><a href="http://stackoverflow.com/questions/9644139/from-io-reader-to-string-in-go">reference1</a><br><a href="https://www.datadoghq.com/blog/crossing-streams-love-letter-gos-io-reader/">reference2</a></p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;runtime-pprof-example&quot;&gt;&lt;a href=&quot;#runtime-pprof-example&quot; class=&quot;headerlink&quot; title=&quot;runtime/pprof example&quot;&gt;&lt;/a&gt;runtime/pprof example&lt;/h3&gt;</summary>
    
    
    
    <category term="Scripts" scheme="http://yoursite.com/categories/Scripts/"/>
    
    
    <category term="golang" scheme="http://yoursite.com/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Linux</title>
    <link href="http://yoursite.com/2019/07/18/centos/"/>
    <id>http://yoursite.com/2019/07/18/centos/</id>
    <published>2019-07-18T07:37:02.000Z</published>
    <updated>2021-11-02T03:17:18.392Z</updated>
    
    <content type="html"><![CDATA[<h3 id="audit"><a href="#audit" class="headerlink" title="audit"></a><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/security_guide/sec-understanding_audit_log_files">audit</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ auditctl -e0</span><br><span class="line"></span><br><span class="line"><span class="comment">## /etc/audit/auditd.conf</span></span><br><span class="line">$ systemctl start auditd</span><br><span class="line">$ auditctl -b 8192 <span class="comment">#buff</span></span><br><span class="line">$ auditctl -f 2 <span class="comment"># Set  failure  mode  0=silent 1=printk 2=panic. This option lets you determine how you want the kernel to handle critical errors</span></span><br><span class="line">$ auditctl -r 0 <span class="comment"># not limit speed</span></span><br><span class="line">$ auditctl -e 2 <span class="comment"># Set enabled flag. When 0 is passed, this can be used to temporarily disable auditing. When 1 is passed as an argument, it will enable auditing.  To  lock the  audit  configuration  so  that  it  can&#x27;t  be  changed,  pass  a  2 as the argument</span></span><br><span class="line">$ auditctl -s <span class="comment"># Report  the  kernel&#x27;s  audit  subsystem status</span></span><br><span class="line">$ auditctl -l <span class="comment"># list rule</span></span><br><span class="line">$ auditctl -D <span class="comment"># del all policy</span></span><br><span class="line">$ auditctl -w path_to_file -p permissions -k key_name</span><br><span class="line"><span class="comment">#&quot;a&quot; means change the dir/file attribute, the others same with r w x</span></span><br><span class="line">$ auditctl -w /etc/passwd -p wa -k passwd_changes</span><br><span class="line">$ auditctl -w /etc/selinux/ -p wa -k selinux_changes</span><br><span class="line">$ auditctl -w /sbin/insmod -p x -k module_insertion</span><br><span class="line">$ auditctl -a always,<span class="built_in">exit</span> -F arch=b64 -S adjtimex -S settimeofday -k time_change</span><br><span class="line">$ auditctl -a always,<span class="built_in">exit</span> -S unlink -S unlinkat -S rename -S renameat -F auid&gt;=500 -F auid!=4294967295 -k delete</span><br><span class="line">$ auditctl -a always,<span class="built_in">exit</span> -F path=/etc/shadow -F perm=wa</span><br><span class="line">$ auditctl -R /usr/share/doc/audit-version/stig.rules <span class="comment"># Read rules from a file</span></span><br><span class="line"></span><br><span class="line">$ auditctl -w /etc/ssh/sshd_config -p warx -k sshd_config</span><br><span class="line"></span><br><span class="line">$ tail audit.log </span><br><span class="line"><span class="built_in">type</span>=SYSCALL msg=audit(1364481363.243:24287): arch=c000003e syscall=2 success=no <span class="built_in">exit</span>=-13 a0=7fffd19c5592 a1=0 a2=7fffd19c4b50 a3=a items=1 ppid=2686 pid=3538 auid=500 uid=500 gid=500 euid=500 suid=500 fsuid=500 egid=500 sgid=500 fsgid=500 tty=pts0 ses=1 comm=<span class="string">&quot;cat&quot;</span> exe=<span class="string">&quot;/bin/cat&quot;</span> subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key=<span class="string">&quot;sshd_config&quot;</span></span><br><span class="line"><span class="built_in">type</span>=CWD msg=audit(1364481363.243:24287):  cwd=<span class="string">&quot;/home/shadowman&quot;</span></span><br><span class="line"><span class="built_in">type</span>=PATH msg=audit(1364481363.243:24287): item=0 name=<span class="string">&quot;/etc/ssh/sshd_config&quot;</span> inode=409248 dev=fd:00 mode=0100600 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:etc_t:s0</span><br><span class="line"></span><br><span class="line"><span class="comment">#may be the ausearch is not a good choice</span></span><br></pre></td></tr></table></figure><h3 id="rsync-debug"><a href="#rsync-debug" class="headerlink" title="rsync debug"></a>rsync debug</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -h --debug=<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Use OPT or OPT1 <span class="keyword">for</span> level 1 output, OPT2 <span class="keyword">for</span> level 2, etc.; OPT0 silences.</span><br><span class="line"></span><br><span class="line">ACL        Debug extra ACL info</span><br><span class="line">BACKUP     Debug backup actions (levels 1-2)</span><br><span class="line">BIND       Debug socket <span class="built_in">bind</span> actions</span><br><span class="line">CHDIR      Debug when the current directory changes</span><br><span class="line">CONNECT    Debug connection events (levels 1-2)</span><br><span class="line">CMD        Debug commands+options that are issued (levels 1-2)</span><br><span class="line">DEL        Debug delete actions (levels 1-3)</span><br><span class="line">DELTASUM   Debug delta-transfer checksumming (levels 1-4)</span><br><span class="line">DUP        Debug weeding of duplicate names</span><br><span class="line">EXIT       Debug <span class="built_in">exit</span> events (levels 1-3)</span><br><span class="line">FILTER     Debug filter actions (levels 1-2)</span><br><span class="line">FLIST      Debug file-list operations (levels 1-4)</span><br><span class="line">FUZZY      Debug fuzzy scoring (levels 1-2)</span><br><span class="line">GENR       Debug generator <span class="built_in">functions</span></span><br><span class="line">HASH       Debug hashtable code</span><br><span class="line">HLINK      Debug hard-link actions (levels 1-3)</span><br><span class="line">ICONV      Debug iconv character conversions (levels 1-2)</span><br><span class="line">IO         Debug I/O routines (levels 1-4)</span><br><span class="line">OWN        Debug ownership changes <span class="keyword">in</span> users &amp; groups (levels 1-2)</span><br><span class="line">PROTO      Debug protocol information</span><br><span class="line">RECV       Debug receiver <span class="built_in">functions</span></span><br><span class="line">SEND       Debug sender <span class="built_in">functions</span></span><br><span class="line">TIME       Debug setting of modified <span class="built_in">times</span> (levels 1-2)</span><br><span class="line"></span><br><span class="line">ALL        Set all --debug options (e.g. all4)</span><br><span class="line">NONE       Silence all --debug options (same as all0)</span><br><span class="line">HELP       Output this <span class="built_in">help</span> message</span><br><span class="line"></span><br><span class="line">Options added <span class="keyword">for</span> each increase <span class="keyword">in</span> verbose level:</span><br><span class="line">2) BIND,CONNECT,CMD,DEL,DELTASUM,DUP,FILTER,FLIST,ICONV</span><br><span class="line">3) ACL,BACKUP,CONNECT2,DEL2,DELTASUM2,EXIT,FILTER2,FLIST2,FUZZY,GENR,OWN,RECV,SEND,TIME</span><br><span class="line">4) CMD2,DEL3,DELTASUM3,EXIT2,FLIST3,ICONV2,OWN2,PROTO,TIME2</span><br><span class="line">5) CHDIR,DELTASUM4,FLIST4,FUZZY2,HASH,HLINK</span><br></pre></td></tr></table></figure><h3 id="chrome-enable-dns-over-https"><a href="#chrome-enable-dns-over-https" class="headerlink" title="chrome enable dns over https"></a>chrome enable dns over https</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome://flags/<span class="comment">#dns-over-https</span></span><br></pre></td></tr></table></figure><h3 id="call"><a href="#call" class="headerlink" title="call"></a>call</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### kernel read/write lock</span></span><br><span class="line">rwsem_down_failed_common</span><br></pre></td></tr></table></figure><h3 id="traceroute"><a href="#traceroute" class="headerlink" title="traceroute"></a>traceroute</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ traceroute -q 1 -m 16 12.34.56.78 <span class="comment"># avoid linux kernel peer limit</span></span><br><span class="line">$ mtr -c 50 -i 0.2 -rw 12.34.56.78</span><br></pre></td></tr></table></figure><h3 id="mapping-file-to-loop-dev"><a href="#mapping-file-to-loop-dev" class="headerlink" title="mapping file to loop dev"></a>mapping file to loop dev</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ losetup /dev/loop0 /opt/test_file</span><br><span class="line">$ losetup -D <span class="comment">## remove all loop dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### export tcmalloc</span></span><br><span class="line">```bash</span><br><span class="line">$ yum install gperftools-libs</span><br><span class="line">$ <span class="built_in">export</span> LD_PRELOAD=/usr/lib64/libtcmalloc.so.4</span><br></pre></td></tr></table></figure><h3 id="vi-paste-not-auto-inherit-the-file-type"><a href="#vi-paste-not-auto-inherit-the-file-type" class="headerlink" title="vi paste not auto inherit the file type"></a>vi paste not auto inherit the file type</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:<span class="built_in">set</span> paste</span><br><span class="line">:<span class="built_in">set</span> nopaste</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> TERM=xterm-256color</span><br><span class="line">$ <span class="built_in">export</span> TERM=screen-256color</span><br></pre></td></tr></table></figure><h3 id="ubuntu-20-04"><a href="#ubuntu-20-04" class="headerlink" title="ubuntu 20.04"></a>ubuntu 20.04</h3><p>take screenshot of selected Area in Ubuntu 20.04<br>shortcut key, shift + Print screen</p><p>disable fstrim service</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm /var/lib/systemd/timers/stamp-fstrim.timer</span><br><span class="line">systemctl stop fstrim.service fstrim.timer</span><br><span class="line">systemctl <span class="built_in">disable</span> fstrim.service fstrim.timer</span><br><span class="line">systemctl mask fstrim.service fstrim.timer</span><br></pre></td></tr></table></figure><p>Delete the conection</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /etc/NetworkManager/system-connections</span><br><span class="line">delete the wifi connection </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">system program problem detected</span><br><span class="line">```bash</span><br><span class="line">sudo rm /var/crash/*</span><br></pre></td></tr></table></figure><p>installation</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">$ apt update</span><br><span class="line">$ apt install gcc make automake autoconf perl ethtool bpfcc-tools fio gdb crash python3-bpfcc smartmontools sg3-utils nfs-kernel-server tcpdump screen sysstat iotop iftop openssh-server linux-tools-5.4.0-58-generic atop collectl net-tools axel remmina tightvncserver ffmpeg gimp gimp-resynthesizer</span><br><span class="line"></span><br><span class="line">$ vi /etc/ssh/sshd_config</span><br><span class="line"><span class="comment">#PermitRootLogin prohibit-password</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">$ systemctl restart sshd</span><br><span class="line">$ passwd root <span class="comment"># set root passwd</span></span><br><span class="line">$ apt remove libreoffice-core</span><br><span class="line">$ apt upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment">##bridge network config example</span></span><br><span class="line">vi /etc/network/interfaces </span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet static</span><br><span class="line">        address 192.168.0.10</span><br><span class="line">        network 192.168.0.0</span><br><span class="line">        netmask 255.255.255.0</span><br><span class="line">        broadcast 192.168.0.255</span><br><span class="line">        gateway 192.168.0.1</span><br><span class="line">        dns-nameservers 192.168.0.5 8.8.8.8</span><br><span class="line">        dns-search example.com</span><br><span class="line">        bridge_ports eth0</span><br><span class="line">        bridge_stp off</span><br><span class="line">        bridge_fd 0</span><br><span class="line">        bridge_maxwait 0</span><br><span class="line"></span><br><span class="line"><span class="comment">### debug-info</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;deb http://ddebs.ubuntu.com <span class="subst">$(lsb_release -cs)</span> main restricted universe multiverse</span></span><br><span class="line"><span class="string">      deb http://ddebs.ubuntu.com <span class="subst">$(lsb_release -cs)</span>-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">      deb http://ddebs.ubuntu.com <span class="subst">$(lsb_release -cs)</span>-proposed main restricted universe multiverse&quot;</span> | \</span><br><span class="line">      sudo tee -a /etc/apt/sources.list.d/ddebs.list</span><br><span class="line"></span><br><span class="line">$ apt install ubuntu-dbgsym-keyring</span><br><span class="line">$ apt update</span><br><span class="line">$ apt install debian-goodies</span><br><span class="line"></span><br><span class="line"><span class="comment">### kernel source</span></span><br><span class="line">$ apt-get install linux-source linux-crashdump</span><br><span class="line">$ kdump-config show</span><br><span class="line">$ dmesg | grep -i crash</span><br><span class="line">$ cat /proc/sys/kernel/sysrq</span><br><span class="line">176</span><br><span class="line"></span><br><span class="line">$ sysctl -w kernel.sysrq=1</span><br><span class="line">$ <span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br><span class="line">$ cat /etc/default/grub.d/kdump-tools.cfg</span><br><span class="line">$ update-grub</span><br><span class="line">$ kdump-config load</span><br><span class="line">$ kdump-config unload</span><br><span class="line"></span><br><span class="line">find-dbgsym-packages [core_path|running_pid|binary_path]</span><br><span class="line">$ find-dbgsym-packages /bin/ls</span><br><span class="line">coreutils-dbgsym libpcre2-8-0-dbgsym libselinux1-dbgsym</span><br><span class="line"></span><br><span class="line">$ apt-get install coreutils-dbgsym </span><br><span class="line"></span><br><span class="line">$ crash  /usr/lib/debug/boot/vmlinux-5.4.0-58-generic</span><br><span class="line"></span><br><span class="line">$ apt install linux-image-5.4.0-58-generic-dbgsym</span><br><span class="line"></span><br><span class="line">$ vi /etc/apt/sources.list <span class="comment"># Enable src </span></span><br><span class="line">$ apt-get <span class="built_in">source</span> linux-image-unsigned-$(uname -r)</span><br><span class="line"><span class="comment">### ubuntu </span></span><br><span class="line">http://ddebs.ubuntu.com/ubuntu/pool/main/l/linux/linux-image-unsigned-5.4.0-58-generic-dbgsym_5.4.0-58.64_amd64.ddeb</span><br><span class="line"></span><br><span class="line"><span class="comment">### debain</span></span><br><span class="line">http://mirrors.ustc.edu.cn/debian/pool/main/l/linux/linux-image-4.19.0-13-amd64-dbg_4.19.160-2_amd64.deb</span><br><span class="line"></span><br><span class="line"><span class="comment">### cat /etc/apt/sources.list</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ buster main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ buster-updates main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ buster-backports main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian-security buster/updates main contrib non-free</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### add dbgsym</span></span><br><span class="line"><span class="comment">#deb http://deb.debian.org/debian-debug/ buster-debug main</span></span><br><span class="line">deb http://debug.mirrors.debian.org/debian-debug/ buster-debug main</span><br><span class="line"><span class="comment"># for security updates</span></span><br><span class="line"><span class="comment">#deb http://deb.debian.org/debian-debug/ buster-proposed-updates-debug main</span></span><br><span class="line">deb http://debug.mirrors.debian.org/debian-debug/ buster-proposed-updates-debug main</span><br><span class="line"></span><br><span class="line">$ apt install linux-image-4.19.0-13-amd64-dbg</span><br></pre></td></tr></table></figure><p>Install wechat</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://deepin-wine.i-m.dev/</span><br><span class="line">$ wget -O- https://deepin-wine.i-m.dev/setup.sh | sh</span><br><span class="line">$ sudo apt install com.qq.weixin.deepin</span><br><span class="line">$ sudo apt-get install -y libjpeg62:i386</span><br></pre></td></tr></table></figure><h3 id="install-newer-glibc-deb-packages-and-apt-source-not-update-cause-the-deps-issue"><a href="#install-newer-glibc-deb-packages-and-apt-source-not-update-cause-the-deps-issue" class="headerlink" title="install newer glibc deb packages and apt source not update cause the deps issue"></a><a href="https://askubuntu.com/questions/1315906/unmet-dependencies-libc6-the-package-system-is-broken">install newer glibc deb packages and apt source not update cause the deps issue</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## apt install specify version</span></span><br><span class="line">$ sudo apt install libc6=2.31-0ubuntu9.2 libc-bin=2.31-0ubuntu9.2</span><br><span class="line"></span><br><span class="line"><span class="comment">## snap remove </span></span><br><span class="line">$ sudo snap remove chromium</span><br></pre></td></tr></table></figure><h4 id="setup-vnc"><a href="#setup-vnc" class="headerlink" title="setup vnc"></a><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-20-04">setup vnc</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># change the vnc default port</span></span><br><span class="line">$ grep <span class="string">&quot;59&quot;</span> /usr/bin/vncserver -n </span><br><span class="line"><span class="comment">#modify 5900 to xxxx</span></span><br><span class="line"></span><br><span class="line">$ apt update</span><br><span class="line">$ apt install xfce4 xfce4-goodies tightvncserver</span><br><span class="line">$ vncpasswd</span><br><span class="line">Password:</span><br><span class="line">Verify:</span><br><span class="line"></span><br><span class="line">$ vncserver</span><br><span class="line">$ vncserver -<span class="built_in">kill</span> :1</span><br><span class="line"></span><br><span class="line"><span class="comment">#or delete the vnc lock</span></span><br><span class="line">$ rm -f /tmp/.X11-unix/X1</span><br><span class="line"></span><br><span class="line">$ mv ~/.vnc/xstartup ~/.vnc/xstartup.bak</span><br><span class="line">$ cat ~/.vnc/xstartup</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">xrdb <span class="variable">$HOME</span>/.Xresources</span><br><span class="line">startxfce4 &amp;</span><br><span class="line">$ chmod +x ~/.vnc/xstartup</span><br><span class="line"></span><br><span class="line">$ ssh -L 59000:localhost:5901 -C -N -l <span class="variable">$username</span> <span class="variable">$your_server_ip</span></span><br><span class="line">-L 59000:localhost:5901: The -L switch specifies that the given port on the <span class="built_in">local</span> computer (59000) is to be forwarded to the given host and port on the destination server (localhost:5901, meaning port 5901 on the destination server, defined as your_server_ip). Note that the <span class="built_in">local</span> port you specify is somewhat arbitrary; as long as the port isn’t already bound to another service, you can use it as the forwarding port <span class="keyword">for</span> your tunnel.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="centos"><a href="#centos" class="headerlink" title="centos"></a>centos</h3><h4 id="printk-messages"><a href="#printk-messages" class="headerlink" title="printk messages"></a><a href="https://unix.stackexchange.com/questions/13019/description-of-kernel-printk-values">printk messages</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta"># linux/kernel.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_EMERG <span class="meta-string">&quot;&lt;0&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ALERT <span class="meta-string">&quot;&lt;1&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_CRIT <span class="meta-string">&quot;&lt;2&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ERR <span class="meta-string">&quot;&lt;3&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_WARNING <span class="meta-string">&quot;&lt;4&gt;&quot;</span> <span class="comment">//default level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_NOTICE <span class="meta-string">&quot;&lt;5&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_INFO <span class="meta-string">&quot;&lt;6&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEBUG <span class="meta-string">&quot;&lt;7&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line">#<span class="meta"># <span class="meta-keyword">define</span> in kernel/printk.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEFAULT <span class="meta-string">&quot;&lt;d&gt;&quot;</span> </span></span><br></pre></td></tr></table></figure><p>DEFAULT_MESSAGE_LOGLEVEL </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/kernel/printk</span><br><span class="line">4(console level) 4(default) 1 7</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">kernel.printk = 4 4 1 7</span><br><span class="line"></span><br><span class="line"><span class="comment">#modify the console log level</span></span><br><span class="line">$ <span class="built_in">echo</span> 5 &gt; /proc/sys/kernel/printk</span><br><span class="line">or</span><br><span class="line">$ <span class="built_in">echo</span> 8 &gt; /proc/sys/kernel/printk</span><br><span class="line"></span><br><span class="line"><span class="comment">## Some warning messages are rate limited. printk_ratelimit specifies the minimum length of time between these messages (in jiffies), by default we allow one every 5 seconds</span></span><br><span class="line">$ cat /proc/sys/kernel/printk_ratelimit</span><br><span class="line">5</span><br><span class="line"></span><br><span class="line"><span class="comment">## While long term we enforce one message per printk_ratelimit seconds, we do allow a burst of messages to pass through</span></span><br><span class="line">$ cat /proc/sys/kernel/printk_ratelimit_burst</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line"><span class="comment">#set the log level</span></span><br><span class="line">$ dmesg -n 5 </span><br><span class="line">$ dmesg --follow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The four values <span class="keyword">in</span> printk denote: console_loglevel, default_message_loglevel, minimum_console_loglevel and default_console_loglevel respectively.</span><br><span class="line">console_loglevel: messages with a higher priority than this will be printed to the console</span><br><span class="line">default_message_loglevel: messages without an explicit priority will be printed with this priority</span><br><span class="line">minimum_console_loglevel: minimum (highest) value to <span class="built_in">which</span> console_loglevel can be <span class="built_in">set</span></span><br><span class="line">default_console_loglevel: default value <span class="keyword">for</span> console_loglevel</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;0&quot;</span> → Emergency messages, system is about to crash or is unstable pr_emerg</span><br><span class="line"><span class="string">&quot;1&quot;</span> → Something bad happened and action must be taken immediately pr_alert</span><br><span class="line"><span class="string">&quot;2&quot;</span> → A critical condition occurred like a serious hardware/software failure pr_crit</span><br><span class="line"><span class="string">&quot;3&quot;</span> → An error condition, often used by drivers to indicate difficulties with the hardware pr_err</span><br><span class="line"><span class="string">&quot;4&quot;</span> → A warning, meaning nothing serious by itself but might indicate problems pr_warning</span><br><span class="line"><span class="string">&quot;5&quot;</span> → Nothing serious, but notably nevertheless. Often used to report security events. pr_notice</span><br><span class="line"><span class="string">&quot;6&quot;</span> → Informational message e.g. startup information at driver initialization pr_info</span><br><span class="line"><span class="string">&quot;7&quot;</span> → Debug messages pr_debug, pr_devel <span class="keyword">if</span> DEBUG is defined</span><br><span class="line">KERN_DEFAULT <span class="string">&quot;d&quot;</span> The default kernel loglevel</span><br><span class="line">KERN_CONT <span class="string">&quot;&quot;</span> <span class="string">&quot;continued&quot;</span> line of <span class="built_in">log</span> printout (only <span class="keyword">done</span> after a line that had no enclosing)</span><br></pre></td></tr></table></figure><h4 id="centos-7-7-not-report-kenrel-symbols"><a href="#centos-7-7-not-report-kenrel-symbols" class="headerlink" title="centos 7.7 not report kenrel symbols"></a><a href="https://access.redhat.com/solutions/4797281">centos 7.7 not report kenrel symbols</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure><h4 id="kill-sockets"><a href="#kill-sockets" class="headerlink" title="kill sockets"></a><a href="https://unix.stackexchange.com/questions/71940/killing-tcp-connection-in-linux">kill sockets</a></h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ss -K dst 192.168.1.214 dport = 49029</span><br><span class="line">       -K, --kill</span><br><span class="line">              Attempts <span class="keyword">to</span> forcibly close sockets. This option displays sockets that are successfully closed <span class="keyword">and</span> silently skips sockets that the kernel does <span class="keyword">not</span> support closing. It sup‐</span><br><span class="line">              ports IPv4 <span class="keyword">and</span><span class="built_in"> IPv6 </span>sockets only. </span><br></pre></td></tr></table></figure><h4 id="compress-by-xz"><a href="#compress-by-xz" class="headerlink" title="compress by xz"></a>compress by xz</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar cf - <span class="variable">$dir</span> | xz -T 8 &gt; <span class="variable">$&#123;dir&#125;</span>.tar.xz</span><br></pre></td></tr></table></figure><h4 id="systemd-rc-local"><a href="#systemd-rc-local" class="headerlink" title="systemd rc.local"></a>systemd rc.local</h4><p>set ubuntu shutdown slow</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/systemd/system.conf</span><br><span class="line">DefaultTimeoutStartSec=10s</span><br><span class="line">DefaultTimeoutStopSec=5s</span><br><span class="line"></span><br><span class="line">$ sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/systemd/system/rc-local.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=/etc/rc.local Compatibility</span><br><span class="line">ConditionPathExists=/etc/rc.local</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/etc/rc.local start</span><br><span class="line">TimeoutSec=0</span><br><span class="line">StandardOutput=tty</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line">SysVStartPriority=99</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;exit 0&quot;</span> &gt; /etc/rc.local</span><br><span class="line"></span><br><span class="line">$ sudo chmod +x /etc/rc.local</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> rc-local</span><br></pre></td></tr></table></figure><h4 id="date"><a href="#date" class="headerlink" title="date"></a>date</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## a week ago</span></span><br><span class="line">today=$(date -d <span class="string">&quot;<span class="subst">$(date +%Y%m%d)</span> 00:00:00&quot;</span> +%s)</span><br><span class="line">aweekago=$(date -d <span class="string">&quot;@<span class="subst">$((today-3600*24*7)</span>)&quot;</span> <span class="string">&quot;+%Y%m%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ date -s <span class="string">&quot;2 OCT 2018 18:18:18&quot;</span></span><br><span class="line">$ date -d <span class="string">&quot;@1595260885&quot;</span> +<span class="string">&quot;%m/%d/%Y %H:%M:%S&quot;</span></span><br><span class="line">07/21/2020 00:01:25</span><br><span class="line"></span><br><span class="line">$ date -d <span class="string">&quot;07/21/2020 00:01:25&quot;</span> +%s</span><br><span class="line">159526088</span><br><span class="line"></span><br><span class="line">$ date -d @12345 -u +%H:%M:%S</span><br><span class="line">03:25:45</span><br><span class="line"></span><br><span class="line">$ date -d <span class="string">&quot;09/04/2020 03:25:45&quot;</span> +%s</span><br><span class="line">1599186345</span><br><span class="line">$ date -d <span class="string">&quot;09/04/2020 00:00:00&quot;</span> +%s</span><br><span class="line">1599174000</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">1599186345</span>-<span class="number">1599174000</span>))</span><br><span class="line">12345</span><br></pre></td></tr></table></figure><h4 id="dd"><a href="#dd" class="headerlink" title="dd"></a><a href="https://stackoverflow.com/questions/8554568/add-a-big-buffer-to-a-pipe-between-two-commands">dd</a></h4><p>dd modify pipe buffer block size</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ commandA | dd status=none iflag=fullblock bs=1M | commandB</span><br><span class="line">$ process1 | mbuffer -m 1024M | process2</span><br></pre></td></tr></table></figure><h4 id="selinux"><a href="#selinux" class="headerlink" title="selinux"></a>selinux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ setenforce 0</span><br><span class="line">$ getenforce</span><br><span class="line">Permissive</span><br></pre></td></tr></table></figure><h4 id="Software-Collections-SCL-Repository"><a href="#Software-Collections-SCL-Repository" class="headerlink" title="Software Collections ( SCL ) Repository"></a>Software Collections ( SCL ) Repository</h4><p>$ yum install centos-release-scl-rh<br>$ yum install devtoolset-9-toolchain</p><h1 id="centos-8"><a href="#centos-8" class="headerlink" title="centos 8"></a>centos 8</h1><p>$ dnf install gcc-toolset-9</p><p>$ gfortran –version | head -2<br>GNU Fortran (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36)<br>Copyright (C) 2015 Free Software Foundation, Inc.</p><p>$ scl enable devtoolset-9 bash</p><p>$  gfortran –version | head -2<br>GNU Fortran (GCC) 8.2.1 20180905 (Red Hat 8.2.1-3)<br>Copyright (C) 2018 Free Software Foundation, Inc.</p><a id="more"></a><h3 id="Nofile"><a href="#Nofile" class="headerlink" title="Nofile"></a><a href="https://unix.stackexchange.com/questions/447583/ulimit-vs-file-max">Nofile</a></h3><p>/proc/sys/fs/file-max<br>ulimit -n</p><p>file-max is the maximum File Descriptors (FD) enforced on a kernel level, which cannot be surpassed by all processes without increasing.<br>The ulimit is enforced on a process level, which can be less than the file-max.</p><p>/proc/sys/fs/file-nr<br>This will return three values denote the number of allocated file handles the number of allocated but unused file handles, and the maximum number of file handles. </p><h3 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pidstat -C <span class="string">&#x27;linpack|stream&#x27;</span> -d 2 -rsuw</span><br></pre></td></tr></table></figure><h3 id="nfsstat"><a href="#nfsstat" class="headerlink" title="nfsstat"></a>nfsstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nfsiostat -d /mount 2</span><br></pre></td></tr></table></figure><h3 id="user-space-pipe-size"><a href="#user-space-pipe-size" class="headerlink" title="user space pipe size"></a>user space pipe size</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># F_SETPIPE_SZ F_GETPIPE_SZ</span></span><br><span class="line"><span class="comment"># echo 104857600 &gt; /proc/sys/fs/pipe-max-size</span></span><br><span class="line"><span class="comment"># fs.pipe-max-size=104857600</span></span><br><span class="line"><span class="comment"># ulimit pipe size            (512 bytes, -p) 8 = 4096 bytes, it &#x27;s pipe buffer size in the ulimit, not pipe size</span></span><br><span class="line"><span class="comment">## POSIX.1-2001 says that write(2)s of less than PIPE_BUF  bytes  must  be atomic:  the  output  data  is  written  to  the  pipe  as a contiguous sequence.  Writes of more than PIPE_BUF bytes may  be  non-atomic:  the kernel  may  interleave the data with data written by other processes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here 2 tools for pipe</span></span><br><span class="line"><span class="comment"># pv - Pipe Viewer - is a terminal-based tool for monitoring the progress of data through a pipeline.</span></span><br><span class="line"><span class="comment"># process1 | pv -pterbTCB 1G | process2</span></span><br><span class="line"></span><br><span class="line">$ pv -cN sources linux-image-unsigned-4.15.0-65-generic-dbgsym_4.15.0-65.74_amd64.ddeb | dd of=/tmp/tmp bs=512 | pv -cN cat</span><br><span class="line"></span><br><span class="line">$ mkfifo -m 777 /tmp/lfs.log</span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.log</span><br><span class="line"></span><br><span class="line"><span class="comment">## lfs 40MB log</span></span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.80.bin 80</span><br></pre></td></tr></table></figure><h3 id="rand-file"><a href="#rand-file" class="headerlink" title="rand file"></a>rand file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -out 1G.file 1073741824</span><br></pre></td></tr></table></figure><h3 id="samba"><a href="#samba" class="headerlink" title="samba"></a>samba</h3><h4 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /bin/<span class="literal">false</span>  <span class="variable">$USER</span></span><br><span class="line">PASSINPUT=`<span class="built_in">echo</span> <span class="variable">$USER</span>|cut -c1-3`123 </span><br><span class="line">(<span class="built_in">echo</span> <span class="variable">$PASSINPUT</span> ; <span class="built_in">echo</span> <span class="variable">$PASSINPUT</span>)  | smbpasswd -s -a <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><h4 id="config"><a href="#config" class="headerlink" title="config"></a>config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">workgroup = MYGROUP</span><br><span class="line">server string = Samba Server Version %v</span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/samba/<span class="built_in">log</span>.%m</span><br><span class="line">max <span class="built_in">log</span> size = 50</span><br><span class="line">security = user</span><br><span class="line">passdb backend = tdbsam</span><br><span class="line">load printers = no</span><br><span class="line">printing = bsd</span><br><span class="line">printcap name = /dev/null</span><br><span class="line"><span class="built_in">disable</span> spoolss = yes</span><br><span class="line"></span><br><span class="line">[SMB_DATA]</span><br><span class="line">path = /samba/data</span><br><span class="line">valid users =  test1,test2,test3,test4</span><br><span class="line">create mask = 0744</span><br><span class="line">force create mode = 0744</span><br><span class="line">security mask = 0744</span><br><span class="line">force security mode = 0744</span><br><span class="line">directory mask = 0755</span><br><span class="line">force directory mode = 0755</span><br><span class="line">directory security mask = 0755</span><br><span class="line">force directory security mode = 0755</span><br><span class="line">writable = yes</span><br><span class="line">fileid:mapping = smb_data</span><br><span class="line">use mmap = no</span><br><span class="line">nt acl support = yes</span><br><span class="line">ea support = yes</span><br></pre></td></tr></table></figure><h4 id="Show-status"><a href="#Show-status" class="headerlink" title="Show status"></a>Show status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient -L localhost <span class="comment">#show share point</span></span><br><span class="line">$ pdbedit -L <span class="comment"># show users</span></span><br><span class="line">$ mount.cifs //<span class="variable">$domain_addr</span>/SMB_DATA -o username=test1,password=<span class="variable">$your_pass</span> /mnt</span><br><span class="line"></span><br><span class="line">$ ls -l /var/lib/samba/private/</span><br><span class="line">total 936</span><br><span class="line">-rw------- 1 root root 528384 Aug 22 10:36 passdb.tdb</span><br><span class="line">-rw------- 1 root root 430080 Dec 29  2013 secrets.tdb</span><br><span class="line"><span class="comment"># backup data</span></span><br><span class="line">$ pdbedit -e smbpasswd:/root/samba-users.backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># import </span></span><br><span class="line">$ pdbedit -i smbpasswd:/root/samba-users.backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># Please backup all users from /etc/passwd too</span></span><br></pre></td></tr></table></figure><h3 id="update-kernel-moduels-in-lib-moduels-uname-r"><a href="#update-kernel-moduels-in-lib-moduels-uname-r" class="headerlink" title="update kernel moduels in /lib/moduels/$(uname -r)"></a>update kernel moduels in /lib/moduels/$(uname -r)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># re-generate modules.alias modules.dep</span></span><br><span class="line">$ depmod -a</span><br></pre></td></tr></table></figure><h3 id="syscalls"><a href="#syscalls" class="headerlink" title="syscalls"></a>syscalls</h3><p>Get these names from <a href="https://github.com/torvalds/linux/blob/master/include/linux/syscalls.h">syscalls.h</a></p><h3 id="filter-syslog"><a href="#filter-syslog" class="headerlink" title="filter syslog"></a><a href="https://access.redhat.com/solutions/1564823">filter syslog</a></h3><p>Created slice user-0.slice.<br>Starting Session 150 of user root.<br>Started Session 150 of user root.<br>Created slice user-0.slice.<br>Starting Session 151 of user root.<br>Started Session 151 of user root.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;if $programname == &quot;l_getidentity.*&quot; then stop&#x27;</span> &gt;/etc/rsyslog.d/ignore-lustre-id-session.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;if $programname == &quot;systemd&quot; and ($msg contains &quot;Starting Session&quot; or $msg contains &quot;Started Session&quot; or $msg contains &quot;Created slice&quot; or $msg contains &quot;Starting user-&quot; or $msg contains &quot;Starting User Slice of&quot; or $msg contains &quot;Removed session&quot; or $msg contains &quot;Removed slice User Slice of&quot; or $msg contains &quot;Stopping User Slice of&quot;) then stop&#x27;</span> &gt;/etc/rsyslog.d/ignore-systemd-session-slice.conf</span><br><span class="line"></span><br><span class="line">$ systemctl restart rsyslog</span><br></pre></td></tr></table></figure><h3 id="xfs"><a href="#xfs" class="headerlink" title="xfs"></a>xfs</h3><h4 id="Check-fragmentation"><a href="#Check-fragmentation" class="headerlink" title="Check fragmentation"></a>Check fragmentation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xfs_db -r -c frag /dev/md127</span><br><span class="line">actual 310296, ideal 306296, fragmentation factor 1.29%</span><br><span class="line">Note, this number is largely meaningless.</span><br><span class="line">Files on this filesystem average 1.01 extents per file</span><br></pre></td></tr></table></figure><h3 id="tmp-permission"><a href="#tmp-permission" class="headerlink" title="tmp permission"></a>tmp permission</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 1777 /tmp</span><br></pre></td></tr></table></figure><h3 id="taskset"><a href="#taskset" class="headerlink" title="taskset"></a>taskset</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ taskset -p a 205344</span><br><span class="line">pid 205344<span class="string">&#x27;s current affinity mask: ffffffffff</span></span><br><span class="line"><span class="string">pid 205344&#x27;</span>s new affinity mask: a</span><br><span class="line"></span><br><span class="line">$ taskset -c -p 205344</span><br><span class="line">pid 205344<span class="string">&#x27;s current affinity list: 1,3</span></span><br><span class="line"><span class="string">$ taskset -cp 0-3 $pid</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ echo &quot;obase=2; ibase=16; A&quot; | bc</span></span><br><span class="line"><span class="string">1010 # core 1,3</span></span><br></pre></td></tr></table></figure><h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><h4 id="ssh-key-not-work"><a href="#ssh-key-not-work" class="headerlink" title="ssh key not work"></a><a href="https://stackoverflow.com/questions/6377009/adding-public-key-to-ssh-authorized-keys-does-not-log-me-in-automatically">ssh key not work</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 700 ~/.ssh</span><br><span class="line">$ chmod 600 ~/.ssh/authorized_keys</span><br><span class="line">$ chmod go-w ~</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bind $vnc_server_ip:5910 to localhost:7910</span></span><br><span class="line">$ ssh -L 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># to 0.0.0.0:7910</span></span><br><span class="line">$ ssh -L 7910:0.0.0.0:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"><span class="comment"># same with 0.0.0.0</span></span><br><span class="line">$ ssh -g -L 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"><span class="comment"># limit the client ip</span></span><br><span class="line">$ ssh -g -L 7910:<span class="variable">$&#123;ssh_client_ip&#125;</span>:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># bind $vnc_server_ip:5910 to $vnc_server_ip:7910 by $ssh_client</span></span><br><span class="line"><span class="comment"># modify -L to -R</span></span><br><span class="line">$ ssh -R 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># share all ip addr</span></span><br><span class="line"><span class="comment"># modify /etc/ssh/sshd_config &#x27;GatewayPorts clientspecified&#x27;</span></span><br><span class="line">$ ssh -R 7910:0.0.0.0:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># vnc_server_ip2 and ip1 in the same LAN, bind vnc_server_ip2 5910 to ssh client 7910 and forward by vnc_server_ip1</span></span><br><span class="line">$ ssh -L 7910:<span class="variable">$&#123;vnc_server_ip2&#125;</span>:5910 user@<span class="variable">$&#123;vnc_server_ip1&#125;</span></span><br><span class="line">vnc_server_ip1 $ vncview localhost:7910</span><br><span class="line"><span class="comment"># Enable all ip access</span></span><br><span class="line">$ ssh -L 7910:0.0.0.0:5910 user@<span class="variable">$&#123;vnc_server_ip1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vnc_server_ip1 access ssh_client_ip2 vnc service</span></span><br><span class="line">$ ssh -R 7910:ssh_client_ip2:5910 user@vnc_server_ip1</span><br><span class="line">vnc_server_ip1 $ vncviewer localhost::7910 </span><br><span class="line"><span class="comment"># Enable all ip access</span></span><br><span class="line">$ ssh -R 7910:0.0.0.0:5910 user@vnc_server_ip1</span><br><span class="line"></span><br><span class="line"><span class="comment">#### [pass through another machine to forward sock5](https://superuser.com/questions/332850/ssh-as-socks-proxy-through-multiple-hosts)</span></span><br><span class="line">A-&gt;B-&gt;C  </span><br><span class="line">C could connecnt internet, A and B could not, A pass through B to forward sock5 port to <span class="variable">$A_local_sock_port</span></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># make these port have not block by firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### In A, you could set sock5 localhost:$A_local_sock_port to connect internnet</span></span><br><span class="line">client $ ssh -C -f -N -D <span class="variable">$local_sock_port</span> -oProxyCommand=<span class="string">&quot;ssh -C -W %h:%p username@<span class="variable">$B_ipaddr</span>&quot;</span> username@<span class="variable">$C_ipaddr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or </span></span><br><span class="line">client $ ssh -L <span class="variable">$local_sock_port</span>:localhost:<span class="variable">$PORT2</span> <span class="variable">$B_IPADDR</span></span><br><span class="line">A $ ssh -f -N -D <span class="variable">$PORT2</span> <span class="variable">$C_IPADDR</span></span><br><span class="line"><span class="comment">#merge dual command to single command</span></span><br><span class="line">client $ ssh -f -L <span class="variable">$local_sock_port</span>:localhost:<span class="variable">$PORT2</span> liyan@192.168.210.3 <span class="string">&quot;ssh -f -N -D <span class="variable">$PORT2</span> liyan@<span class="variable">$C_IPADDR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># forward remote port to local</span></span><br><span class="line">client $ ssh -fNT -R 1025:127.0.0.1:1025 -J user@<span class="variable">$B_IP</span> user@<span class="variable">$C_IP</span></span><br><span class="line">AllowTcpForwarding yes</span><br><span class="line">GatewayPorts yes</span><br></pre></td></tr></table></figure><h4 id="ssh-config-allow-users"><a href="#ssh-config-allow-users" class="headerlink" title="ssh config allow users"></a>ssh config allow users</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AllowUsers *@192.168.1.0/24 *@*.example.com *@1.2.3.4</span><br><span class="line">AllowGroups ssh</span><br></pre></td></tr></table></figure><h3 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h3><p>-ttt If given thrice, the time printed will include the microseconds and the leading portion will be printed as the number of seconds since the epoch</p><p>-s strsize  Specify the maximum string size to print (the default is 32).  Note that filenames are not considered strings and are always printed in full.</p><p>-f Trace child processes as they are created by currently traced processes  as  a  result  of  the  fork(2),  vfork(2)  and clone(2)  system  calls. Note that -p PID -f will attach all threads of process PID if it is multi-threaded, not only thread with thread_id = PID</p><p>-T Show the time spent in system calls.  This records the time difference between the beginning and the end of each  system call</p><p>-c Count time, calls, and errors for each system call and report a summary on program exit, suppressing the regular output. This attempts to show system time (CPU time spent running in the kernel) independent of wall clock time.  If -c is used with -f, only aggregate totals for all traced processes are kept.<br>-C Like -c but also print regular output while processes are running.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ strace -f -c -p 49285 </span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"> 92.89   69.955928        2530     27640      1203 futex</span><br><span class="line">  2.33    1.754302       70172        25        25 restart_syscall</span><br><span class="line">  1.56    1.172474          52     22512           write</span><br><span class="line">  1.54    1.156547          63     18080           <span class="built_in">read</span></span><br><span class="line">  1.09    0.821847         119      6873           unlink</span><br><span class="line">  0.28    0.211894          30      6874           open</span><br><span class="line">  0.14    0.108041          15      6859           munmap</span><br><span class="line">  0.07    0.049564           7      6874           close</span><br><span class="line">  0.05    0.035222           2     13733           fstat</span><br><span class="line">  0.03    0.024198           3      6859           mmap</span><br><span class="line">  0.02    0.015568           2      5522           clock_gettime</span><br><span class="line">  0.01    0.006484           2      2208           getrusage</span><br><span class="line">  0.00    0.001998           3       552           mprotect</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00   75.314067                124611      1228 total</span><br><span class="line"></span><br><span class="line">$ strace -k cmd  <span class="comment">#show backtrace for each syscall</span></span><br><span class="line">$ strace -t cmd  <span class="comment">#prefix each syscall with walllock time</span></span><br><span class="line">$ strace -D cmd  strace process runs as detached grandchild of cmd</span><br><span class="line">$ strace -p 1234 -f <span class="comment">#addatch to all threads in process-group 1234</span></span><br><span class="line"></span><br><span class="line">strace -Tfe trace=open,<span class="built_in">read</span>,write  ./program</span><br><span class="line">$ strace -f -FF -tt -T -s 128 -p <span class="variable">$pid</span></span><br><span class="line">$ strace -ttt -T -s 1024 -e trace=%memory -C -o ~/memory.log -f -p <span class="variable">$pid</span></span><br><span class="line">$ strace -ttt -T -s 1024 -e trace=%desc -C -o ~/desc.log -f -p <span class="variable">$pid</span></span><br></pre></td></tr></table></figure><h3 id="Calculated-CPU-usage"><a href="#Calculated-CPU-usage" class="headerlink" title="Calculated CPU usage"></a><a href="https://github.com/Leo-G/DevopsWiki/wiki/How-Linux-CPU-Usage-Time-and-Percentage-is-calculated">Calculated CPU usage</a></h3><p>cpu usage=(idle2-idle1)/(cpu2-cpu1)*100 # script example<br>cpu usage=[(user_2 +sys_2+nice_2) - (user_1 + sys_1+nice_1)]/(total_2 - total_1)*100</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> cat /proc/<span class="built_in">stat</span></span><br><span class="line">     user nice system idle iowait  irq  softirq steal guest guest_nice</span><br><span class="line">cpu  4705 356  584    3699   23    23     0       0     0          0</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"> <span class="comment"># by Paul Colby (http://colby.id.au), no rights reserved ;)</span></span><br><span class="line"></span><br><span class="line"> PREV_TOTAL=0</span><br><span class="line"> PREV_IDLE=0</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">   <span class="comment"># Get the total CPU statistics, discarding the &#x27;cpu &#x27; prefix.</span></span><br><span class="line">   CPU=(`sed -n <span class="string">&#x27;s/^cpu\s//p&#x27;</span> /proc/<span class="built_in">stat</span>`)</span><br><span class="line">   IDLE=<span class="variable">$&#123;CPU[3]&#125;</span> <span class="comment"># Just the idle CPU time.</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Calculate the total CPU time.</span></span><br><span class="line">   TOTAL=0</span><br><span class="line">   <span class="keyword">for</span> VALUE <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;CPU[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">     ((TOTAL=<span class="variable">$TOTAL</span>+<span class="variable">$VALUE</span>))</span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Calculate the CPU usage since we last checked.</span></span><br><span class="line">   ((DIFF_IDLE=<span class="variable">$IDLE</span>-<span class="variable">$PREV_IDLE</span>))</span><br><span class="line">   ((DIFF_TOTAL=<span class="variable">$TOTAL</span>-<span class="variable">$PREV_TOTAL</span>))</span><br><span class="line">    </span><br><span class="line">   <span class="comment">## </span></span><br><span class="line">   DIFF_USAGE=$(awk -v diff_idle=<span class="variable">$DIFF_IDLE</span> -v diff_total=<span class="variable">$DIFF_TOTAL</span> <span class="string">&#x27;BEGIN&#123;printf &quot;%.2f&quot;, (diff_total-diff_idle)/diff_total*100&#125;&#x27;</span>)</span><br><span class="line">   <span class="built_in">echo</span> -en <span class="string">&quot;\rCPU: <span class="variable">$DIFF_USAGE</span>%  \b\b&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Remember the total and idle CPU times for the next check.</span></span><br><span class="line">   PREV_TOTAL=<span class="string">&quot;<span class="variable">$TOTAL</span>&quot;</span></span><br><span class="line">   PREV_IDLE=<span class="string">&quot;<span class="variable">$IDLE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Wait before checking again.</span></span><br><span class="line">   usleep 100000</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## the lib messages</span></span><br><span class="line">$ <span class="built_in">read</span>(3, <span class="string">&quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\273\0\0\0\0\0\0&quot;</span>..., 832) = 832</span><br><span class="line"></span><br><span class="line">$ od -bc /lib/x86_64-linux-gnu/libc.so.6 | head -n4</span><br><span class="line">0000000 177 105 114 106 002 001 001 003 000 000 000 000 000 000 000 000</span><br><span class="line">        177   E   L   F 002 001 001 003  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000020 003 000 076 000 001 000 000 000 260 034 002 000 000 000 000 000</span><br><span class="line">        003  \0   &gt;  \0 001  \0  \0  \0 260 034 002  \0  \0  \0  \0  \0</span><br></pre></td></tr></table></figure><h3 id="tuna"><a href="#tuna" class="headerlink" title="tuna"></a><a href="https://access.redhat.com/solutions/2144921">tuna</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check kernel threads</span></span><br><span class="line">$ tuna -U -P</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  2      OTHER     0    0xfff 386420266      1048922        kthreadd</span><br><span class="line">  4      OTHER     0        0         7            0    kworker/0:0H</span><br><span class="line">  6      OTHER     0        0   4030025         3019     ksoftirqd/0</span><br><span class="line">  7       FIFO    99        0    155252            0     migration/0</span><br><span class="line"></span><br><span class="line">$ tuna --threads=7861 --priority=RR:40</span><br><span class="line">$ tuna --threads=sshd --show_threads --priority=RR:40 --show_threads</span><br><span class="line"></span><br><span class="line"><span class="comment"># Got the voluntary and nonvoluntary ctxt switch</span></span><br><span class="line"><span class="comment"># pid is the io test app</span></span><br><span class="line">grep ctxt_switches /proc/<span class="variable">$&#123;pid&#125;</span>/status</span><br><span class="line">voluntary_ctxt_switches:        2940930 (I/O bound)</span><br><span class="line">nonvoluntary_ctxt_switches:     9042</span><br><span class="line"></span><br><span class="line"><span class="comment"># 147095 is the cpu test app</span></span><br><span class="line">grep ctxt_switches /proc/147095/status</span><br><span class="line">voluntary_ctxt_switches:478</span><br><span class="line">nonvoluntary_ctxt_switches:1565 (CPU bound)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling automatic IRQ balancing</span></span><br><span class="line">$ systemctl stop irqbalance.service</span><br><span class="line">$ systemctl <span class="built_in">disable</span> irqbalance.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#  the kernel will automatically try to balance the load based on its understanding of the hardware&#x27;s NUMA layout</span></span><br><span class="line">$  <span class="built_in">echo</span> kernel.numa_balancing=0 &gt;&gt; /etc/sysctl.conf ; sysctl -p</span><br><span class="line"></span><br><span class="line">j$ cat /sys/class/net/eth0/device/numa_node</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Isolating CPUs from the process scheduler</span></span><br><span class="line">This step involves setting isolcpus on the kernel<span class="string">&#x27;s cmdline. This removes cores from the process scheduler that you would like to dedicate to your application, so other userland processes do not migrate to them. Please see this solutions document for more information: https://access.redhat.com/solutions/480473</span></span><br><span class="line"><span class="string">NOTE: kernel threads are not able to be disabled and will always be visible on all cores. In ps -eLf output, these show up in brackets, like [ksoftirqd/0]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grubby --update-kernel=ALL --args=&#x27;</span>isolcpus=1-3,5-31, iommu=pt<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ grubby --update-kernel=ALL --args=&#x27;</span>intel_pstate=<span class="built_in">disable</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ grubby --update-kernel=ALL --remove-args=&#x27;</span>mem=66G<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## disable the irqbalance</span></span><br><span class="line"><span class="string">$ systemctl stop irqbalance</span></span><br><span class="line"><span class="string">## Show numa node for dev </span></span><br><span class="line"><span class="string">$ numactl -a -N netdev:em1 grep allowed /proc/self/status</span></span><br><span class="line"><span class="string">Cpus_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000055,55555555</span></span><br><span class="line"><span class="string">Cpus_allowed_list:0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38</span></span><br><span class="line"><span class="string">Mems_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span></span><br><span class="line"><span class="string">Mems_allowed_list:0-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## bind to 0,2,4 cores</span></span><br><span class="line"><span class="string">$ numactl -a -N netdev:em1 -C 0,2,4 grep allowed /proc/self/status</span></span><br><span class="line"><span class="string">Cpus_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000015</span></span><br><span class="line"><span class="string">Cpus_allowed_list:0,2,4</span></span><br><span class="line"><span class="string">Mems_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span></span><br><span class="line"><span class="string">Mems_allowed_list:0-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lspci  | grep Ethernet</span></span><br><span class="line"><span class="string">01:00.0 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span></span><br><span class="line"><span class="string"> | |  |</span></span><br><span class="line"><span class="string"> | |  ---func</span></span><br><span class="line"><span class="string"> | ---slot</span></span><br><span class="line"><span class="string"> ---bus</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#show dev</span></span><br><span class="line"><span class="string">$ numactl --prefer netdev:em1 --show</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#not work</span></span><br><span class="line"><span class="string">$ numactl --prefer pci:01:00 --show</span></span><br><span class="line"><span class="string">                        |  |</span></span><br><span class="line"><span class="string">                        |  ---slot</span></span><br><span class="line"><span class="string">                        ---bus</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## write the it to systemd service config file</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">...other lines...</span></span><br><span class="line"><span class="string">ExecStart=/bin/numactl -aN netdev:em1 -C 6 /path/to/ptpd</span></span><br><span class="line"><span class="string">...other lines...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Instead of a number a node can also be:</span></span><br><span class="line"><span class="string">  netdev:DEV the node connected to network device DEV</span></span><br><span class="line"><span class="string">  file:PATH  the node the block device of path is connected to</span></span><br><span class="line"><span class="string">  ip:HOST    the node of the network device host routes through</span></span><br><span class="line"><span class="string">  block:PATH the node of block device path</span></span><br><span class="line"><span class="string">  pci:[seg:]bus:dev[:func] The node of a PCI device</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Dell H330 IR</span></span><br><span class="line"><span class="string">$ lspci -ttv | grep &quot;MegaRAID SAS-3 3008&quot; -B 1</span></span><br><span class="line"><span class="string"> \-[0000:00]-+-00.0  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D DMI2</span></span><br><span class="line"><span class="string">             +-01.0-[02]----00.0  LSI Logic / Symbios Logic MegaRAID SAS-3 3008 [Fury]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ls -l /sys/class/block</span></span><br><span class="line"><span class="string">sda -&gt; ../../devices/pci0000:00/0000:00:01.0/0000:02:00.0/host0/target0:0:0/0:0:0:0/block/sda</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU ID</span></span><br><span class="line"><span class="string">Zero-based CPU ID0123456789101112</span></span><br><span class="line"><span class="string">Decimal Value        1248163264128256512102420484096</span></span><br><span class="line"><span class="string">Hexadecimal Value1248102040801002004008001000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Zero-based CPU ID1314151617181920212223</span></span><br><span class="line"><span class="string">Decimal Value        8192    16384   32768   65536   131072  262144  524288  1048576 2097152 4194304 8388608</span></span><br><span class="line"><span class="string">Hexadecimal Value2000    4000    8000    10000   20000   40000   80000   100000  200000  400000  800000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">printf &#x27;</span>%x %x\n<span class="string">&#x27; 1024 4096</span></span><br><span class="line"><span class="string">400 1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ awk -F &#x27;</span>[ :]+<span class="string">&#x27; &#x27;</span><span class="variable">$0</span>!~/CPU/ &amp;&amp; <span class="variable">$0</span>~/em1/&#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;<span class="string">&#x27; /proc/interrupts</span></span><br><span class="line"><span class="string">88</span></span><br><span class="line"><span class="string">90</span></span><br><span class="line"><span class="string">91</span></span><br><span class="line"><span class="string">92</span></span><br><span class="line"><span class="string">93</span></span><br><span class="line"><span class="string">94</span></span><br><span class="line"><span class="string">95</span></span><br><span class="line"><span class="string">96</span></span><br><span class="line"><span class="string">97</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ echo 400 &gt; /proc/irq/88/smp_affinitya</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">$ echo 1000 &gt; /proc/irq/97/smp_affinity</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ seq 63 88 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span></span><br><span class="line"><span class="string">/proc/irq/63/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000001</span></span><br><span class="line"><span class="string">/proc/irq/64/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000004</span></span><br><span class="line"><span class="string">/proc/irq/65/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000010</span></span><br><span class="line"><span class="string">/proc/irq/66/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000040</span></span><br><span class="line"><span class="string">/proc/irq/67/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000100</span></span><br><span class="line"><span class="string">/proc/irq/68/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000400</span></span><br><span class="line"><span class="string">/proc/irq/69/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00001000</span></span><br><span class="line"><span class="string">/proc/irq/70/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00004000</span></span><br><span class="line"><span class="string">/proc/irq/71/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00010000</span></span><br><span class="line"><span class="string">/proc/irq/72/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00aaaaaa</span></span><br><span class="line"><span class="string">/proc/irq/73/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00aaaaaa</span></span><br><span class="line"><span class="string">/proc/irq/74/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00040000</span></span><br><span class="line"><span class="string">/proc/irq/75/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00100000</span></span><br><span class="line"><span class="string">/proc/irq/76/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00400000</span></span><br><span class="line"><span class="string">/proc/irq/77/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000002</span></span><br><span class="line"><span class="string">/proc/irq/78/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000008</span></span><br><span class="line"><span class="string">/proc/irq/79/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000020</span></span><br><span class="line"><span class="string">/proc/irq/80/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000080</span></span><br><span class="line"><span class="string">/proc/irq/81/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000200</span></span><br><span class="line"><span class="string">/proc/irq/82/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000800</span></span><br><span class="line"><span class="string">/proc/irq/83/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00002000</span></span><br><span class="line"><span class="string">/proc/irq/84/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00008000</span></span><br><span class="line"><span class="string">/proc/irq/85/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00020000</span></span><br><span class="line"><span class="string">/proc/irq/86/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00080000</span></span><br><span class="line"><span class="string">/proc/irq/87/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00200000</span></span><br><span class="line"><span class="string">/proc/irq/88/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00800000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=72 --show_irqs</span></span><br><span class="line"><span class="string">   # users            affinity</span></span><br><span class="line"><span class="string">  72 dmar0            0xaaaaaa</span></span><br><span class="line"><span class="string">0xaaaaaa = 101010101010101010101010  == numa1 all cores</span></span><br><span class="line"><span class="string">                                          -----------------------------cpu23</span></span><br><span class="line"><span class="string">                                          |                     -------cpu1</span></span><br><span class="line"><span class="string">$ tuna --irqs=88 --show_irqs              |                     |------cpu0</span></span><br><span class="line"><span class="string">   # users            affinity            |                     ||</span></span><br><span class="line"><span class="string">  88 mpt3sas0-msix23        23  (0x800000=100000000000000000000000) </span></span><br><span class="line"><span class="string">$ tuna --irqs=77 --show_irqs</span></span><br><span class="line"><span class="string">   # users            affinity            </span></span><br><span class="line"><span class="string">  77 mpt3sas0-msix12         1  (0x00000002=10), cpu1 not cpu0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lspci | grep 3008</span></span><br><span class="line"><span class="string">82:00.0 Serial Attached SCSI controller: Broadcom / LSI SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /sys/devices/pci0000:80/0000:80:03.0/0000:82:00.0/numa_node</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ lspcu</span></span><br><span class="line"><span class="string">NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19,21,23</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=mpt3sas1\* --cpus=0,1 --move </span></span><br><span class="line"><span class="string">$ echo 0xff &gt; /proc/irq/125/smp_affinity</span></span><br><span class="line"><span class="string">-bash: echo: write error: Input/output error</span></span><br><span class="line"><span class="string">### mpt3sas could not be modified that why tuna not work</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grep em3 /proc/interrupts</span></span><br><span class="line"><span class="string">114 116 117 118 119 120 121 122 123</span></span><br><span class="line"><span class="string">$ seq 114 123 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span></span><br><span class="line"><span class="string">/proc/irq/114/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000040</span></span><br><span class="line"><span class="string">grep: /proc/irq/115/smp_affinity: No such file or directory</span></span><br><span class="line"><span class="string">/proc/irq/116/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000400</span></span><br><span class="line"><span class="string">/proc/irq/117/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00001000</span></span><br><span class="line"><span class="string">/proc/irq/118/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00040000</span></span><br><span class="line"><span class="string">/proc/irq/119/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00100000</span></span><br><span class="line"><span class="string">/proc/irq/120/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00400000</span></span><br><span class="line"><span class="string">/proc/irq/121/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000001</span></span><br><span class="line"><span class="string">/proc/irq/122/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000004</span></span><br><span class="line"><span class="string">/proc/irq/123/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000010</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=114 --show_irqs                                                   -----------cpu6, seventh cpu core, 0,1,2,3,4,5,6</span></span><br><span class="line"><span class="string">   # users            affinity                                                  |</span></span><br><span class="line"><span class="string"> 114 em3                     6  bnx2x  6 not means 110,,,,, it &#x27;</span>s means cpu6   0x40 = 1000000 </span><br><span class="line"></span><br><span class="line">$ tuna --irqs=em3\* --show_irqs</span><br><span class="line">   <span class="comment"># users            affinity</span></span><br><span class="line"> 114 em3                     6  bnx2x      --------------cpu12</span><br><span class="line"> 116 em3-fp-0               10  bnx2x      |</span><br><span class="line"> 117 em3-fp-1               12  bnx2x  eg: 1000000000000 = 0x1000</span><br><span class="line"> 118 em3-fp-2               18  bnx2x</span><br><span class="line"> 119 em3-fp-3               20  bnx2x</span><br><span class="line"> 120 em3-fp-4               22  bnx2x</span><br><span class="line"> 121 em3-fp-5                0  bnx2x</span><br><span class="line"> 122 em3-fp-6                2  bnx2x</span><br><span class="line"> 123 em3-fp-7                4  bnx2x</span><br><span class="line"></span><br><span class="line">$ cat /sys/class/net/em3/device/numa_node </span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18,20,22</span><br><span class="line"></span><br><span class="line">$ tuna --irqs=em3\* --cpus=0,1,2,3,4,5,6,7 --move <span class="comment">## it &#x27;s 0xff and it &#x27;s worked</span></span><br><span class="line">$ seq 114 123 | xargs -I% grep -H . /proc/irq/%/smp_affinity </span><br><span class="line">/proc/irq/114/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">grep: /proc/irq/115/smp_affinity: No such file or directory</span><br><span class="line">/proc/irq/116/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/117/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/118/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/119/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/120/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/121/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/122/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line">/proc/irq/123/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span><br><span class="line"></span><br><span class="line">$ tuna --threads=watchdog\* \</span><br><span class="line">        --show_threads \</span><br><span class="line">        --cpus=0 \</span><br><span class="line">        --move \</span><br><span class="line">        --show_threads \</span><br><span class="line">        --cpus=1 \</span><br><span class="line">        --move \</span><br><span class="line">        --show_threads \</span><br><span class="line">        --cpus=+0 \</span><br><span class="line">        --move \</span><br><span class="line">        --show_threads</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## show pid numa stats</span></span><br><span class="line">$ perl numa-maps-summary.pl &lt; /proc/1/numa_maps</span><br><span class="line">N0        :          676 (  0.00 GB)</span><br><span class="line">N1        :          230 (  0.00 GB)</span><br><span class="line">active    :          385 (  0.00 GB)</span><br><span class="line">anon      :          443 (  0.00 GB)</span><br><span class="line">dirty     :          443 (  0.00 GB)</span><br><span class="line">kernelpagesize_kB:          268 (  0.00 GB)</span><br><span class="line">mapmax    :          146 (  0.00 GB)</span><br><span class="line">mapped    :          463 (  0.00 GB)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ numastat -mczs</span><br><span class="line"></span><br><span class="line">Per-node system memory usage (<span class="keyword">in</span> MBs):</span><br><span class="line">                 Node 0 Node 1  Total</span><br><span class="line">                 ------ ------ ------</span><br><span class="line">MemTotal          64230  64448 128678</span><br><span class="line">MemUsed           45328  34761  80089</span><br><span class="line">FilePages         42949  32954  75903</span><br><span class="line">Inactive          42669  31659  74328</span><br><span class="line">Inactive(file)    42668  29360  72028</span><br><span class="line">MemFree           18901  29687  48589</span><br><span class="line">Shmem                 1   3530   3531</span><br><span class="line">Inactive(anon)        2   2298   2300</span><br><span class="line">Slab                872   1168   2041</span><br><span class="line">SReclaimable        669   1027   1695</span><br><span class="line">Active              285   1332   1617</span><br><span class="line">Active(anon)          5   1272   1277</span><br><span class="line">SUnreclaim          204    142    345</span><br><span class="line">Active(file)        280     60    341</span><br><span class="line">AnonPages             5     37     42</span><br><span class="line">Mapped                6     20     26</span><br><span class="line">KernelStack           5      5     10</span><br><span class="line">AnonHugePages         0     10     10</span><br><span class="line">PageTables            2      3      5</span><br><span class="line">Dirty                 0      0      0</span><br><span class="line"></span><br><span class="line">https://gist.github.com/sitano/c2269ed158e15ab97829</span><br></pre></td></tr></table></figure><h3 id="NFS-client"><a href="#NFS-client" class="headerlink" title="NFS client"></a>NFS client</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options sunrpc tcp_slot_table_entries=128&quot;</span> &gt;&gt; /etc/modprobe.d/sunrpc.conf</span><br><span class="line"><span class="comment"># the value default only 2</span></span><br></pre></td></tr></table></figure><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><h4 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">nwchan     WCHAN     address of the kernel <span class="keyword">function</span> <span class="built_in">where</span> the process</span><br><span class="line">                     is sleeping (use wchan <span class="keyword">if</span> you want the kernel</span><br><span class="line">                     <span class="keyword">function</span> name).  Running tasks will display a</span><br><span class="line">                     dash (<span class="string">&#x27;-&#x27;</span>) <span class="keyword">in</span> this column.</span><br><span class="line">wchan      WCHAN     name of the kernel <span class="keyword">function</span> <span class="keyword">in</span> <span class="built_in">which</span> the process</span><br><span class="line">                     is sleeping, a <span class="string">&quot;-&quot;</span> <span class="keyword">if</span> the process is running, or</span><br><span class="line">                     a <span class="string">&quot;*&quot;</span> <span class="keyword">if</span> the process is multi-threaded and ps is</span><br><span class="line">                     not displaying threads.</span><br><span class="line"><span class="comment"># show full username</span></span><br><span class="line">$ ps axo user:20,pid,pcpu,pmem,vsz,rss,tty,<span class="built_in">stat</span>,start,time,comm</span><br><span class="line"></span><br><span class="line"><span class="comment"># show thread and whan</span></span><br><span class="line">$ ps axHo <span class="built_in">stat</span>,pid,tid,pgid,ppid,comm,cls,cmd,wchan</span><br><span class="line">S&lt;      139    139      0      2 kblockd          TS [kblockd]                   rescuer_thread</span><br><span class="line">S&lt;      141    141      0      2 md               TS [md]                        rescuer_thread</span><br><span class="line">S&lt;      142    142      0      2 edac-poller      TS [edac-poller]               rescuer_thread</span><br><span class="line">S&lt;      143    143      0      2 watchdogd        TS [watchdogd]                 rescuer_thread</span><br><span class="line">S       152    152      0      2 kswapd0          TS [kswapd0]                   kswapd</span><br><span class="line">S       153    153      0      2 kswapd1          TS [kswapd1]                   kswapd</span><br><span class="line"></span><br><span class="line"><span class="comment">#show the pid info process schdule and show the parent id ppid</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -r 99</span><br><span class="line">$ <span class="built_in">setcap</span>  cap_sys_nice=eip  /usr/bin/chrt <span class="comment">## for the non-root user</span></span><br><span class="line">$ chrt -p <span class="variable">$pid</span></span><br><span class="line">$ chrt -b -p <span class="variable">$priority</span> <span class="variable">$pid</span> <span class="comment">## the number higher ,the highest prority is 99</span></span><br><span class="line">$ chrt -m</span><br><span class="line">$ nice -n 5 ./a.out -20~19 <span class="comment"># -19 is the highest prority , it not real-time</span></span><br><span class="line">$ renice 10 <span class="variable">$pid</span></span><br><span class="line">$ pstree -aps <span class="variable">$pid</span></span><br><span class="line">$ ps -efj </span><br><span class="line">$ ps -eo pid,ppid,cmd,%mem,rss,%cpu,policy,ni --sort=-%cpu | head</span><br><span class="line">$ ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head</span><br><span class="line"></span><br><span class="line"><span class="comment"># check the process on which cpu cores</span></span><br><span class="line">$ ps -mo pid,tid,%cpu,psr -p 198851 | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span> | sort -n  | uniq -c</span><br><span class="line">   PID    TID %CPU PSR</span><br><span class="line">198851      -  0.1   -</span><br><span class="line">     - 198851  0.1  15</span><br></pre></td></tr></table></figure><h3 id="selinux-1"><a href="#selinux-1" class="headerlink" title="selinux"></a>selinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setroubleshoot</span><br></pre></td></tr></table></figure><h3 id="handle-overflow-in-jiffies"><a href="#handle-overflow-in-jiffies" class="headerlink" title="handle overflow in jiffies"></a><a href="https://stackoverflow.com/questions/8206762/how-does-linux-handle-overflow-in-jiffies">handle overflow in jiffies</a></h3><p>1ms = millisecond<br>1us = microsecond !=ms, microsecond = us<br>1ns = billisecond = nanosecond<br>1ps = picosecond</p><p>/usr/src/kernels/$(uname -r)/include/linux/jiffies.h</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">These inlines deal with timer wrapping correctly. You are </span><br><span class="line">strongly encouraged to use them</span><br><span class="line">1. Because people otherwise forget</span><br><span class="line">2. Because <span class="keyword">if</span> the timer wrap changes <span class="keyword">in</span> future you won<span class="string">&#x27;t have to</span></span><br><span class="line"><span class="string">   alter your driver code.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">time_after(a,b) returns true if the time a is after time b.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>time_before(jiffies, timeout)<br>#define time_before(jiffies, timeout) ((long)(jiffies) - (long)(timeout) &lt; 0)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (time_before(jiffies, timeout)</span><br><span class="line">&#123;</span><br><span class="line">    /* we did not time out, good ... */</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    /* we timed out, error ...*</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,time_before(jiffies,timeout));   </span><br></pre></td></tr></table></figure><p>/usr/src/kernels/3.10.0-862.11.6.el7.x86_64/include/generated/autoconf.h</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define CONFIG_HZ 1000</span></span><br></pre></td></tr></table></figure><p>/usr/src/kernels/$(uname -r)/include/asm-generic/param.h<br>1GHz=1000,000,000 Hz<br>1 second/1000000000<br>awk ‘BEGIN{printf “%.9f\n”,1/1000000000}’<br>0.000000001 (1ns/Hz system precision)</p><p>Linux kenrel CONFIG_HZ = 1000</p><p>Tick = 1sec / CONFIG_HZ= 1ms<br>average 1ms with once interrput, 1000 time interrupt in single second</p><p>The timer tick is a timer interrupt that is usually generated HZ times per second<br>jiffies means the unit of time</p><p>the kernel use some macros prevent an overflow, eg: time_before</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#incldue <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> i,j,k</span><br><span class="line">j = jiffies;</span><br><span class="line">i = j + HZ;</span><br><span class="line">k = j + HZ*<span class="number">1000</span>;</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uapi/asm-generic/param.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">undef</span> HZ</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> HZCONFIG_HZ<span class="comment">/* Internal kernel timer frequency */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> USER_HZ100<span class="comment">/* some user interfaces are */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CLOCKS_PER_SEC(USER_HZ)       <span class="comment">/* in &quot;ticks&quot; like times() */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __ASM_GENERIC_PARAM_H */</span></span></span><br></pre></td></tr></table></figure><h3 id="Prevent-the-data-be-deleted"><a href="#Prevent-the-data-be-deleted" class="headerlink" title="Prevent the data be deleted"></a>Prevent the data be deleted</h3><p>If you files system support attr</p><ul><li>: Adds the attribute to the existing attribute of the files.<br>– : Removes the attribute to the existing attribute of the files.<br>= : Keep the existing attributes that the files have.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ chattr +i -R demo</span><br><span class="line">$ rm -rf demo/</span><br><span class="line">rm: cannot remove ‘demo/0’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/1’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/2’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/3’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/4’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/5’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/6’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/7’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/8’: Permission denied</span><br><span class="line">rm: cannot remove ‘demo/9’: Permission denied</span><br><span class="line"></span><br><span class="line">$ lsattr demo/</span><br><span class="line">----i----------- demo/0</span><br><span class="line">----i----------- demo/1</span><br><span class="line">----i----------- demo/2</span><br><span class="line">----i----------- demo/3</span><br><span class="line">----i----------- demo/4</span><br><span class="line">----i----------- demo/5</span><br><span class="line">----i----------- demo/6</span><br><span class="line">----i----------- demo/7</span><br><span class="line">----i----------- demo/8</span><br><span class="line">----i----------- demo/9</span><br><span class="line">$ chattr -i -R demo/</span><br><span class="line">$ rm -f demo/*</span><br><span class="line"></span><br><span class="line"><span class="comment">### could be append</span></span><br><span class="line">$ chattr -R +a demo/</span><br><span class="line">$ <span class="built_in">cd</span> demo/</span><br><span class="line">$ ls</span><br><span class="line">0  1  2  3  4  5  6  7  8  9</span><br><span class="line">$ cat 0</span><br><span class="line">0</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; 0</span><br><span class="line">-bash: 0: Operation not permitted</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt;&gt; 0</span><br><span class="line">$ cat 0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">$ lsattr 0</span><br><span class="line">-----a---------- 0</span><br><span class="line">$ rm -f 0</span><br><span class="line">rm: cannot remove ‘0’: Operation not permitted</span><br><span class="line"></span><br><span class="line">$ chattr -R -a demo</span><br><span class="line">$ rm -f demo/*</span><br></pre></td></tr></table></figure><h3 id="errno"><a href="#errno" class="headerlink" title="errno"></a>errno</h3><p><a href="https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/errno.h">https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/errno.h</a><br>$ man 3 erron</p><h3 id="tc"><a href="#tc" class="headerlink" title="tc"></a><a href="https://colobu.com/2017/04/21/tc-introduction/">tc</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## fixed delay</span></span><br><span class="line">$ tc qdisc add dev eth0 root netem delay 100ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## fixed delay range 100ms ± 10ms</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 10ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## This causes the added delay to be 100ms ± 10ms with the next random element depending 25% on the last one. This isn&#x27;t true statistical correlation, but an approximation.</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 10ms 25%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 0.1% package loss</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem loss 0.1%</span><br><span class="line"></span><br><span class="line">$ tc qdisc change dev eth0 root netem loss 0.3% 25%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 1% duplicate package</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem duplicate 1%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 0.1% randomly modify single bit</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem corrupt 0.1%</span><br><span class="line"></span><br><span class="line"><span class="comment">## out of order, 5,10,15,20,25... package send right now, the others delay 10ms, it &#x27;s fixed, not random</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem gap 5 delay 10ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## out of order randomly, 25% will be transmit, the others will be delay 10ms, next and previos has the 50% relevance ??</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 10ms reorder 25% 50%</span><br><span class="line"></span><br><span class="line"><span class="comment">## delay time range at 100ms ± 75ms, it could cause the package out of order</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 75ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## flow control </span></span><br><span class="line">$ tc qdisc add dev eth0 root handle 1:0 netem delay 100ms</span><br><span class="line">$ tc qdisc add dev eth0 parent 1:1 handle 10: tbf rate 256kbit buffer 1600 <span class="built_in">limit</span> 3000</span><br><span class="line">$ tc -s qdisc ls dev eth0</span><br></pre></td></tr></table></figure><h3 id="VNC"><a href="#VNC" class="headerlink" title="VNC"></a>VNC</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall -y <span class="string">&quot;GNOME Desktop&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#if there is no another data in this file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;exec gnome-session&quot;</span> &gt; ~/.xinitrc</span><br><span class="line"></span><br><span class="line">systemctl is-enabled vncserver@.service</span><br><span class="line">systemctl <span class="built_in">enable</span> vncserver@.service</span><br><span class="line"></span><br><span class="line">systemctl get-default</span><br><span class="line">systemctl set-default multi-user.target</span><br><span class="line"></span><br><span class="line">cp /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@:4.service</span><br><span class="line">vi /etc/systemd/system/vncserver@:4.service <span class="comment">## replace root user to normal user</span></span><br><span class="line">ExecStart=/usr/sbin/runuser -l root -c <span class="string">&quot;/usr/bin/vncserver %i&quot;</span></span><br><span class="line">PIDFile=/root/.vnc/%H%i.pid</span><br><span class="line"></span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">ln -s <span class="string">&#x27;/etc/systemd/system/vncserver@:4.service&#x27;</span> <span class="string">&#x27;/etc/systemd/system/multi-user.target.wants/vncserver@:4.service&#x27;</span></span><br><span class="line">systemctl <span class="built_in">enable</span> vncserver@:4.service</span><br><span class="line">systemctl start vncserver@:4.service</span><br></pre></td></tr></table></figure><h3 id="Vncserer-was-runing-but-there-is-no-desktop-in-centos-7"><a href="#Vncserer-was-runing-but-there-is-no-desktop-in-centos-7" class="headerlink" title="Vncserer was runing, but there is no desktop in centos 7"></a>Vncserer was runing, but there is no desktop in centos 7</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ yum groupinstall Xfce</span><br><span class="line">$ yum install xorg-x11-twm xterm xorg-x11-xinit </span><br><span class="line">$ chmod  755 ~/.vnc/xstartup</span><br><span class="line">$ cat ~/.vnc/xstartup</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> SESSION_MANAGER</span><br><span class="line"><span class="built_in">unset</span> DBUS_SESSION_BUS_ADDRESS</span><br><span class="line"><span class="built_in">exec</span> startxfce4</span><br></pre></td></tr></table></figure><h3 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h3><p>copy mode<br>ctrl + A + esc, press space, scroll up and select the text you want<br>and press “space/blank” to copied<br>ctrl + A + c, create a new session, and use vim open a file, press i go to insert mode, and press ctrl + a + ], it will copy all text to vim.<br>background running by screen</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;screen -dmS collectl su -s /bin/bash nobody -c &quot;</span>\<span class="string">&#x27;&quot;collectl --export graphite,10.53.20.206:2003,d=1 -i60 -s CMDN --netfilt &quot;\&quot;&quot;eth|en|p[0-9]|em&quot;\&quot;&quot; --dskfilt &quot;\&quot;&quot;nvme|sd&quot;\&quot;\&#x27;</span></span><br><span class="line">$ ssh -n <span class="variable">$line</span> <span class="string">&quot;sh /home/test001/kill.sh;&quot;</span></span><br><span class="line">$ cat /home/test001/kill.sh</span><br><span class="line">pstree -p | awk -F <span class="string">&#x27;[)( ]+&#x27;</span> <span class="string">&#x27;$0~/screen/&#123;print $3&#125;&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;to kill &quot;</span><span class="variable">$line</span></span><br><span class="line">   pkill -9 -P <span class="variable">$line</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ ssh -n <span class="variable">$line</span> <span class="string">&quot;top -n 3 -b | head&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ssh and awk</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;timeout 60 ssh <span class="variable">$line</span> \&quot;echo ps auxn \\| awk \&#x27;\\\\\\\$1!=0\&#x27; | bash \&quot;&quot;</span></span><br><span class="line">$ ssh root@test_node1 <span class="string">&quot;echo cat /tmp/tmp  \| awk \&#x27;\\\$1!=0\&#x27; | bash &quot;</span></span><br><span class="line">1 1 1</span><br><span class="line"></span><br><span class="line">$ cat hosts | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$line</span> ; ssh -n <span class="variable">$line</span> <span class="string">&quot;pkill lustre_exporter; ps aux | grep run.sh&quot;</span>; scp run.sh <span class="variable">$line</span>:/root/; ssh -n <span class="variable">$line</span> <span class="string">&quot;screen -dmS test_screen /root/run.sh&quot;</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">i=1</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$line</span></span><br><span class="line">ssh <span class="variable">$line</span> <span class="string">&quot;screen -dmS test su -s /bin/bash -c \&quot;cd /<span class="variable">$&#123;i&#125;</span>/test/; source test.sh;sh ./run.sh;\&quot;&quot;</span> &amp;</span><br><span class="line">((i++))</span><br><span class="line"><span class="keyword">done</span> &lt; test_hosts</span><br></pre></td></tr></table></figure><h3 id="VLC"><a href="#VLC" class="headerlink" title="VLC"></a>VLC</h3><h4 id="Not-show-media-title"><a href="#Not-show-media-title" class="headerlink" title="Not show media title"></a>Not show media title</h4><p><a href="https://forum.videolan.org/viewtopic.php?t=50202">Same question</a><br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Show media title on media start (disable it)<br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Enable on screen display (disable it)</p><h4 id="Not-resize-interface"><a href="#Not-resize-interface" class="headerlink" title="Not resize interface"></a>Not resize interface</h4><p><img src="/img/vlc-set1.png"></p><h3 id="grub"><a href="#grub" class="headerlink" title="grub"></a>grub</h3><p>CentOS 7 add kernel parameter</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disable pcie power save</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;pcie_aspm=off scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y consoleblank=0&#x27;</span></span><br><span class="line"></span><br><span class="line">grubby --remove-args=<span class="string">&quot;argX argY&quot;</span> --args=<span class="string">&quot;argA argB&quot;</span> --update-kernel /boot/kernel</span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## kernel boot blacklist</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;modprobe.blacklist=mpt2sas&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## disable screen saver,  The console blank (screen saver) timeout in seconds. </span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;consoleblank=0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## debug boot information, Enabling this can be very useful for tracking down hardware issues.</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;earlyprintk=[ vga | serial ][,ttyS n [, baudrate ]][,keep]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Disable consistent network device naming</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;biosdevname=0&#x27;</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;net.ifnames=0&#x27;</span></span><br><span class="line">or</span><br><span class="line">ln -s /dev/null /etc/udev/rules.d/80-net-name-slot.rules</span><br><span class="line"></span><br><span class="line"><span class="comment">## disable hugepage and avoid vmware hang in ubuntu 20.04</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;transparent_hugepage=never&#x27;</span></span><br><span class="line">$ sysctl -w vm.swappiness=5</span><br><span class="line">And Add swap to 2GB and <span class="built_in">disable</span> nvme write cache <span class="keyword">in</span> vmware disk setting, not the nvme block device</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## set boot order</span></span><br><span class="line">grubby --default-kernel</span><br><span class="line">grubby --default-index</span><br><span class="line">grubby --set-default /boot/vmlinuz-4.2.0-1.fc23.x86_64</span><br><span class="line">grubby --info=ALL</span><br><span class="line">grubby --info /boot/vmlinuz-4.2.0-1.fc23.x86_64</span><br></pre></td></tr></table></figure><p>set default boot</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">grubby --info=ALL</span><br><span class="line">index=0</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-514.6.1.el7.x86_64</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-514.6.1.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-514.6.1.el7.x86_64) 7 (Core)</span><br><span class="line">index=1</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-327.el7.x86_64</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-327.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)</span><br><span class="line">index=2</span><br><span class="line">kernel=/boot/vmlinuz-0-rescue-f614a3c482eb4b21add5ae750b3871bb</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-0-rescue-f614a3c482eb4b21add5ae750b3871bb.img</span><br><span class="line">title=CentOS Linux (0-rescue-f614a3c482eb4b21add5ae750b3871bb) 7 (Core)</span><br><span class="line">index=3</span><br><span class="line">non linux entry</span><br><span class="line"></span><br><span class="line">grubby --set-default /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br><span class="line">grubby --info /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br></pre></td></tr></table></figure><p>set debug parameters    </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;mem=66G&#x27;</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;rd.debug rdudevdebug systemd.log_level=debug systemd.log_target=console console=ttyS1,115200n8&#x27;</span></span><br></pre></td></tr></table></figure><p>set kdump</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grubby --update-kernel=ALL --remove-args=<span class="string">&quot;crashkernel=auto&quot;</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;crashkernel=256M@16M&#x27;</span></span><br><span class="line"><span class="comment">#an additional 64MB added for each TB of physical RAM present in the system. So for example if a system has 1TB of memory 192MB (128MB + 64MB) will be reserved</span></span><br><span class="line"><span class="comment">#after you set 256M@16M</span></span><br><span class="line">$ cat /sys/kernel/kexec_crash_size</span><br><span class="line">268435456</span><br></pre></td></tr></table></figure><p>crashkernel=X@Y<br>X: denotes how much memory to reserve for the second kernel(capture kernel)<br>Y: denotes what physical address the reserved memory section starts<br>X-Y=Z: Capture kernel runs form reserved memory location(Z)    </p><p><a href="https://access.redhat.com/solutions/3700611">set the early kdump in RHEL 8</a></p><ul><li>Early kdump is a new feature of the kdump mechanism to capture the kernel crash dump of the booting kernel</li><li>In earlier releases of RHEL(5/6/7), the kdump service starts too late during the boot sequence, so early crashes will have no chance to get kdump kernel booting, this will cause crash information to be lost.</li><li>Early Kdump stores the vmlinuz and initramfs of the crash kernel inside the initramfs of the booting kernel and load them directly into the reserved memory (crashkernel) during early boot stage.</li><li>Two dracut modules are added in the kexec-tools package in order to load crash kernel and initramfs as early as possible during the boot sequence to capture the kernel crash dump of the booting kernel.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> kdump</span><br><span class="line">$ systemctl start kdump</span><br><span class="line">$ dracut --list-modules | grep earlykdump</span><br><span class="line">$ touch /etc/systemd/system/sysrq.service</span><br><span class="line">$ chmod 664 /etc/systemd/system/sysrq.service</span><br><span class="line">$ cat /etc/systemd/system/sysrq.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Custom SysRq Service to <span class="built_in">test</span> early kdump</span><br><span class="line">Before=kdump.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/early-kdump-test.sh</span><br><span class="line">Type=simple</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line"></span><br><span class="line">$ cat /usr/<span class="built_in">local</span>/early-kdump-test.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">/usr/bin/grep <span class="string">&quot;early_panic&quot;</span> /proc/cmdline&gt; /dev/null</span><br><span class="line">output=$(<span class="built_in">echo</span> $?)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$output</span> -eq <span class="string">&quot;0&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/early-kdump-test.sh</span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> sysrq.service</span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;early_panic&#x27;</span></span><br><span class="line">or</span><br><span class="line">$ dracut -f --add earlykdump </span><br><span class="line">$ journalctl -x | grep early-kdump </span><br></pre></td></tr></table></figure><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><h4 id="nolock"><a href="#nolock" class="headerlink" title="nolock"></a><a href="https://linux.die.net/man/5/nfs">nolock</a></h4><p>NLM locking is used for this mount point. When using the nolock option, applications can lock files, but such locks provide exclusion only against other applications running on the same client. Remote applications are not affected by these locks.</p><h4 id="file-lock"><a href="#file-lock" class="headerlink" title="file lock"></a><a href="https://docstore.mik.ua/orelly/networking_2ndEd/nfs/ch11_02.htm">file lock</a></h4><p>The NFS (Versions 2 and 3) protocol does not support file locking, but the NFS environment supports an ancillary protocol called NLM, which originally stood for “Network Lock Manager.” When an NFS filesystem on an NFS client gets a request to lock a file, instead of an NFS remote procedure call, it generates an NLM remote procedure call.</p><p>The NLM protocol consists of remote procedure calls that pattern fcntl arguments and results. Because blocking locks are supported (a process blocks waiting for a lock that conflicts with another holder), the NLM protocol has the notion of callbacks, from the file server to the NLM client to notify that a lock is available. In this way, the NLM client sometimes acts as an RPC server in order to receive delayed results from lock calls.</p><h3 id="How-could-I-found-which-file-cause-pipe-hang"><a href="#How-could-I-found-which-file-cause-pipe-hang" class="headerlink" title="How could I found which file cause pipe hang"></a>How could I found which file cause pipe hang</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat /dev/zero | tee /tank/the_file</span><br><span class="line">$ ps aux | grep 63488</span><br><span class="line">root      63488  5.2  0.0 107972   676 pts/9    S+   04:32   0:19 cat /dev/zero</span><br><span class="line"></span><br><span class="line">$ strace -p 63488</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536</span><br><span class="line">strace: Process 63488 detached</span><br><span class="line"></span><br><span class="line">$ ls -l /proc/63488/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 0 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 1 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 3 -&gt; /dev/zero</span><br><span class="line">$ lsof | grep 36710085</span><br><span class="line">cat        63488           root    1w     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line">tee        63489           root    0r     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line">$ ls -l /proc/63489/fd</span><br><span class="line">total 0</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 0 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 1 -&gt; /dev/pts/9</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 3 -&gt; /tank/the_file</span><br></pre></td></tr></table></figure><h4 id="If-pipe-change-to-socket"><a href="#If-pipe-change-to-socket" class="headerlink" title="If pipe change to socket"></a>If pipe change to socket</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ll /proc/333709/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 0 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 10 -&gt; socket:[326105]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 11 -&gt; socket:[326106]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 3 -&gt; socket:[304292]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 4 -&gt; socket:[304294]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 5 -&gt; socket:[304295]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 6 -&gt; socket:[304296]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 7 -&gt; socket:[304297]</span><br><span class="line">lr-x------ 1 root root 64 Mar 20 03:24 8 -&gt; /run/rpcbind.lock</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 9 -&gt; socket:[334786]</span><br><span class="line"></span><br><span class="line"><span class="comment">#304294 is inode</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/net/tcp | grep -Ei <span class="string">&#x27;local_address|304294&#x27;</span></span><br><span class="line">sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode</span><br><span class="line">8: 00000000:006F 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 304294 1 ffff9ac0e2f8be00 100 0 0 10 0</span><br></pre></td></tr></table></figure><h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a><a href="https://gist.github.com/tuxfight3r/9ac030cb0d707bb446c7">tcpdump</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define ETH_P_PAUSE 0x8808 /* IEEE Pause frames</span></span><br><span class="line">$ tcpdump -w test.pcap -i bond0 ether proto 0x8808</span><br><span class="line"></span><br><span class="line"><span class="comment"># get ack and syn packet</span></span><br><span class="line">$ tcpdump <span class="string">&quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">$ tcpdump -n -i eth0 -A -x dst port 443 and greater 100</span><br><span class="line">$ tcpdump -i eth0 -nt -s 500 port 53 and udp</span><br><span class="line">$ tcpdump -ni enp97s0f0 -s0 -w /tmp/capture.pcap host <span class="variable">$hostname1</span></span><br><span class="line"></span><br><span class="line">$ <span class="comment">##TCP FLAGS##</span></span><br><span class="line"></span><br><span class="line">Unskilled Attackers Pester Real Security Folks</span><br><span class="line">==============================================</span><br><span class="line">                     TCPDUMP FLAGS</span><br><span class="line">Unskilled =  URG  =  (Not Displayed <span class="keyword">in</span> Flag Field, Displayed elsewhere) </span><br><span class="line">Attackers =  ACK  =  (Not Displayed <span class="keyword">in</span> Flag Field, Displayed elsewhere)</span><br><span class="line">Pester    =  PSH  =  [P] (Push Data)</span><br><span class="line">Real      =  RST  =  [R] (Reset Connection)</span><br><span class="line">Security  =  SYN  =  [S] (Start Connection)</span><br><span class="line">Folks     =  FIN  =  [F] (Finish Connection)</span><br><span class="line">          SYN-ACK =  [S.] (SynAcK Packet)</span><br><span class="line">                     [.] (No Flag Set)</span><br><span class="line"></span><br><span class="line"><span class="comment">##USAGE##</span></span><br><span class="line">Basic communication // see the basics without many options</span><br><span class="line"><span class="comment"># tcpdump -nS</span></span><br><span class="line"></span><br><span class="line">Basic communication (very verbose) // see a good amount of traffic, with verbosity and no name <span class="built_in">help</span></span><br><span class="line"><span class="comment"># tcpdump -nnvvS</span></span><br><span class="line"></span><br><span class="line">A deeper look at the traffic // adds -X <span class="keyword">for</span> payload but doesn’t grab any more of the packet</span><br><span class="line"><span class="comment"># tcpdump -nnvvXS</span></span><br><span class="line"></span><br><span class="line">Heavy packet viewing // the final “s” increases the snaplength, grabbing the whole packet</span><br><span class="line"><span class="comment"># tcpdump -nnvvXSs 1514</span></span><br><span class="line"></span><br><span class="line">host // look <span class="keyword">for</span> traffic based on IP address (also works with hostname <span class="keyword">if</span> you’re not using -n) </span><br><span class="line"><span class="comment"># tcpdump host 1.2.3.4</span></span><br><span class="line"></span><br><span class="line">src, dst // find traffic from only a <span class="built_in">source</span> or destination (eliminates one side of a host conversation) </span><br><span class="line"><span class="comment"># tcpdump src 2.3.4.5 </span></span><br><span class="line"><span class="comment"># tcpdump dst 3.4.5.6</span></span><br><span class="line"></span><br><span class="line">net // capture an entire network using CIDR notation </span><br><span class="line"><span class="comment"># tcpdump net 1.2.3.0/24</span></span><br><span class="line"></span><br><span class="line">proto // works <span class="keyword">for</span> tcp, udp, and icmp. Note that you don’t have to <span class="built_in">type</span> proto </span><br><span class="line"><span class="comment"># tcpdump icmp</span></span><br><span class="line"></span><br><span class="line">port // see only traffic to or from a certain port </span><br><span class="line"><span class="comment"># tcpdump port 3389</span></span><br><span class="line"></span><br><span class="line">src, dst port // filter based on the <span class="built_in">source</span> or destination port </span><br><span class="line"><span class="comment"># tcpdump src port 1025 # tcpdump dst port 389</span></span><br><span class="line"></span><br><span class="line">src/dst, port, protocol // combine all three </span><br><span class="line"><span class="comment"># tcpdump src port 1025 and tcp </span></span><br><span class="line"><span class="comment"># tcpdump udp and src port 53</span></span><br><span class="line"></span><br><span class="line">You also have the option to filter by a range of ports instead of declaring them individually, and to only see packets that are above or below a certain size.</span><br><span class="line"></span><br><span class="line">Port Ranges // see traffic to any port <span class="keyword">in</span> a range </span><br><span class="line">tcpdump portrange 21-23</span><br><span class="line"></span><br><span class="line">Packet Size Filter // only see packets below or above a certain size (<span class="keyword">in</span> bytes) </span><br><span class="line">tcpdump less 32 </span><br><span class="line">tcpdump greater 128</span><br><span class="line">[ You can use the symbols <span class="keyword">for</span> less than, greater than, and less than or equal / greater than or equal signs as well. ]</span><br><span class="line"></span><br><span class="line">// filtering <span class="keyword">for</span> size using symbols </span><br><span class="line">tcpdump &gt; 32 </span><br><span class="line">tcpdump &lt;= 128</span><br><span class="line"></span><br><span class="line">[ Note: Only the PSH, RST, SYN, and FIN flags are displayed <span class="keyword">in</span> tcpdump‘s flag field output. URGs and ACKs are displayed, but they are shown elsewhere <span class="keyword">in</span> the output rather than <span class="keyword">in</span> the flags field ]</span><br><span class="line"></span><br><span class="line">Keep <span class="keyword">in</span> mind the reasons these filters work. The filters above find these various packets because tcp[13] looks at offset 13 <span class="keyword">in</span> the TCP header, the number represents the location within the byte, and the !=0 means that the flag <span class="keyword">in</span> question is <span class="built_in">set</span> to 1, i.e. it’s on.</span><br><span class="line"></span><br><span class="line">Show all URG packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 32 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all ACK packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 16 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all PSH packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 8 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all RST packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 4 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all SYN packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 2 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all FIN packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] &amp; 1 != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all SYN-ACK packets:</span><br><span class="line"><span class="comment"># tcpdump &#x27;tcp[13] = 18&#x27;</span></span><br><span class="line"></span><br><span class="line">Show icmp <span class="built_in">echo</span> request and reply</span><br><span class="line"><span class="comment">#tcpdump -n icmp and &#x27;icmp[0] != 8 and icmp[0] != 0&#x27;</span></span><br><span class="line"></span><br><span class="line">Show all IP packets with a non-zero TOS field (one byte TOS field is at offset 1 <span class="keyword">in</span> IP header):</span><br><span class="line"><span class="comment"># tcpdump -v -n ip and ip[1]!=0</span></span><br><span class="line"></span><br><span class="line">Show all IP packets with TTL less than some value (on byte TTL field is at offset 8 <span class="keyword">in</span> IP header):</span><br><span class="line"><span class="comment"># tcpdump -v ip and &#x27;ip[8]&lt;2&#x27;</span></span><br><span class="line"></span><br><span class="line">Show TCP SYN packets:</span><br><span class="line"><span class="comment"># tcpdump -n tcp and port 80 and &#x27;tcp[tcpflags] &amp; tcp-syn == tcp-syn&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump tcp and port 80 and &#x27;tcp[tcpflags] == tcp-syn&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-syn) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show TCP ACK packets:</span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-ack) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show TCP SYN/ACK packets (typically, responses from servers):</span><br><span class="line"><span class="comment"># tcpdump -n tcp and &#x27;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) == (tcp-syn|tcp-ack)&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump -n tcp and &#x27;tcp[tcpflags] &amp; tcp-syn == tcp-syn&#x27; and &#x27;tcp[tcpflags] &amp; tcp-ack == tcp-ack&#x27;</span></span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show TCP FIN packets:</span><br><span class="line"><span class="comment"># tcpdump -i &lt;interface&gt; &quot;tcp[tcpflags] &amp; (tcp-fin) != 0&quot;</span></span><br><span class="line"></span><br><span class="line">Show ARP Packets with MAC address</span><br><span class="line"><span class="comment"># tcpdump -vv -e -nn ether proto 0x0806</span></span><br><span class="line"></span><br><span class="line">Show packets of a specified length (IP packet length (16 bits) is located at offset 2 <span class="keyword">in</span> IP header):</span><br><span class="line"><span class="comment"># tcpdump -l icmp and &#x27;(ip[2:2]&gt;50)&#x27; -w - |tcpdump -r - -v ip and &#x27;(ip[2:2]&lt;60)&#x27;</span></span><br><span class="line"></span><br><span class="line">http://danielmiessler.com/study/tcpdump/</span><br></pre></td></tr></table></figure><p><a href="https://www.wains.be/pub/networking/tcpdump_advanced_filters.txt">tcpdump_advanced_filters</a>  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- This rule will match any TCP traffic on port 80 (web) with 192.168.1.254 or 192.168.1.200 as destination host</span><br><span class="line"><span class="comment"># tcpdump -i eth1 &#x27;((tcp) and (port 80) and ((dst host 192.168.1.254) or (dst host 192.168.1.200)))&#x27;</span></span><br><span class="line"></span><br><span class="line">- Will match any ICMP traffic involving the destination with physical/MAC address 00:01:02:03:04:05</span><br><span class="line"><span class="comment"># tcpdump -i eth1 &#x27;((icmp) and ((ether dst host 00:01:02:03:04:05)))&#x27;</span></span><br><span class="line"></span><br><span class="line">- Will match any traffic <span class="keyword">for</span> the destination network 192.168 except destination host 192.168.1.200</span><br><span class="line"><span class="comment"># tcpdump -i eth1 &#x27;((tcp) and ((dst net 192.168) and (not dst host 192.168.1.200)))&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="calculate-upload-download-speed-by-ping"><a href="#calculate-upload-download-speed-by-ping" class="headerlink" title="calculate upload/download speed by ping"></a><a href="http://stackoverflow.com/questions/4575537/calculate-upload-download-speed-by-ping">calculate upload/download speed by ping</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ping -f -c 10000 -s 1472 10.100.100.100</span><br></pre></td></tr></table></figure><p>At the end of the result i get: round-trip min/avg/max/stddev = 0.174/0.219/2.078/0.020 ms<br>so in average it takes 0.219 ms to send 1500 bytes and receive 1500 bytes, that’s 24 kb. 24 kb / 0.219 ms = 110 Mb/s<br>If you want to use that to a server on the internet, you need to lower the packet size to something like 1464 (for MTU 1492), drop the -f option and lower the count so it won’t take too long to finish.</p><p>1500 TX Bytes + 1500 RX Bytes= 3000 Bytes = 3000 * 8 = 24000 bits<br>24000 / 0.219 = 109.589 Mb/s</p><p>It ‘s not represent full throughput. just test single link in your ethernet adapter. not parallel.</p><h3 id="MTU-problem-check"><a href="#MTU-problem-check" class="headerlink" title="MTU problem check"></a>MTU problem check</h3><p>Level 3 network, between 2 nodes pass through gateway<br>Tcpdump show some packets loss, nmap show 10.xx.xx.clent port is “open”.<br>There are some packages return, some will not. Does it MTU problem ? ping could check it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping -f -c 20000 -M <span class="keyword">do</span> -s 8972 10.xx.xx.client</span><br><span class="line">PING 10.xx.xx.client (10.xx.xx.client) 8972(9000) bytes of data.</span><br><span class="line">...................................................................^C</span><br><span class="line">--- 10.xx.xx.client ping statistics ---</span><br><span class="line">67 packets transmitted, 0 received, 100% packet loss, time 1076ms</span><br></pre></td></tr></table></figure><p>You can got the issue from tcpdump, all larger than 1500 packets are loss.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">client <span class="comment"># tcpdump -v host 10.53.19.52 and greater 1500</span></span><br><span class="line">tcpdump: listening on bond0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">11:23:58.134708 IP (tos 0x0, ttl 63, id 27071, offset 0, flags [DF], proto TCP (6), length 8532)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [P.], cksum 0x496d (incorrect -&gt; 0x5fe6), seq 2359537411:2359545891, ack 3804990367, win 53, options [nop,nop,TS val 1203816317 ecr 81802289], length 8480</span><br><span class="line">11:23:58.136045 IP (tos 0x0, ttl 63, id 27077, offset 0, flags [DF], proto TCP (6), length 7292)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [.], cksum 0x4495 (incorrect -&gt; 0xe386), seq 8480:15720, ack 1, win 53, options [nop,nop,TS val 1203816318 ecr 81802294], length 7240</span><br><span class="line">11:23:58.148023 IP (tos 0x0, ttl 63, id 27083, offset 0, flags [DF], proto TCP (6), length 8588)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [P.], cksum 0x49a5 (incorrect -&gt; 0x4006), seq 17016:25552, ack 1, win 53, options [nop,nop,TS val 1203816330 ecr 81802295], length 8536</span><br></pre></td></tr></table></figure><p>If client MTU is 1500, tcpdump(client) will not receive any large packages. they are loss in switch.</p><h3 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h3><h4 id="Exclude-packages"><a href="#Exclude-packages" class="headerlink" title="Exclude packages"></a>Exclude packages</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install --enablerepo=<span class="string">&quot;epel&quot;</span> iotop</span><br><span class="line">$ yum update --exclude=kernel*</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">cachedir=/var/cache/yum/<span class="variable">$basearch</span>/<span class="variable">$releasever</span></span><br><span class="line">keepcache=0</span><br><span class="line">debuglevel=2</span><br><span class="line">logfile=/var/<span class="built_in">log</span>/yum.log</span><br><span class="line">exclude=kernel* redhat-release* *.i?86</span><br></pre></td></tr></table></figure><p><a href="https://access.redhat.com/solutions/10185">reference</a></p><h4 id="Switch-version"><a href="#Switch-version" class="headerlink" title="Switch version"></a>Switch version</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ yum --showduplicates list kernel</span><br><span class="line">Installed Packages</span><br><span class="line">Installed Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       @anaconda-CentOS-201508042137.x86_64/6.7</span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   @update                                 </span><br><span class="line">Available Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       base                                    </span><br><span class="line">kernel.x86_64       2.6.32-573.1.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.3.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.7.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.12.1.el6  update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.18.1.el6  update  </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### Yum.conf</span></span><br><span class="line">```apacheconf</span><br><span class="line">keepcache = 1</span><br></pre></td></tr></table></figure><h4 id="Download-to-local"><a href="#Download-to-local" class="headerlink" title="Download to local"></a>Download to local</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">yum-plugin-downloadonly</span></span><br><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">--downloadonly</span> <span class="string">--downloaddir=&lt;directory&gt;</span> <span class="string">&lt;package&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://access.redhat.com/solutions/10154">reference</a></p><h4 id="Resolve-dependency-resolution-errors"><a href="#Resolve-dependency-resolution-errors" class="headerlink" title="Resolve dependency resolution errors"></a>Resolve dependency resolution errors</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum update</span></span><br><span class="line">** Found 5 pre-existing rpmdb problem(s), <span class="string">&#x27;yum check&#x27;</span> output follows:</span><br><span class="line">MegaCli-8.04.10-1.noarch is a duplicate with MegaCli-8.04.07-1.noarch</span><br><span class="line">kernel-2.6.32-279.5.1.el6_lustre.gb16fe80.x86_64 has missing requires of kernel-firmware &gt;= (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2.6.32&#x27;</span>, <span class="string">&#x27;279.5.1.el6_lustre.gb16fe80&#x27;</span>)</span><br><span class="line">kernel-firmware-2.6.32-279.5.1.el6.noarch is a duplicate with kernel-firmware-2.6.32-279.el6.noarch</span><br><span class="line">kernel-headers-2.6.32-279.5.1.el6.x86_64 is a duplicate with kernel-headers-2.6.32-279.el6.x86_64</span><br><span class="line">libcom_err-1.42.3.wc3-7.el6.x86_64 is a duplicate with libcom_err-1.41.12-12.el6.i686</span><br><span class="line">......</span><br><span class="line">You could try using --skip-broken to work around the problem</span><br><span class="line">You could try running: rpm -Va --nofiles --nodigest</span><br></pre></td></tr></table></figure><h4 id="Uninstall-rpm-packages-from-rpmdb"><a href="#Uninstall-rpm-packages-from-rpmdb" class="headerlink" title="Uninstall rpm packages from rpmdb"></a>Uninstall rpm packages from rpmdb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -e --justdb --nodeps <span class="string">&quot;bad rpm packages&quot;</span></span><br><span class="line">$ rpm -ivh --force <span class="string">&quot;replace normal rpm packages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rebuild rpmdb</span></span><br><span class="line">$ <span class="built_in">cd</span> /var/lib/rpm</span><br><span class="line">$ rm  -f __db*</span><br><span class="line">$ rpm --rebuilddb </span><br><span class="line"></span><br><span class="line">$ yum clean all</span><br><span class="line">$ yum -y update</span><br></pre></td></tr></table></figure><h3 id="upgrade-kernel"><a href="#upgrade-kernel" class="headerlink" title="upgrade kernel"></a>upgrade kernel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://sourceware.org/elfutils/ftp/0.170/elfutils-0.170.tar.bz2</span><br><span class="line">$ tar xjvf elfutils-0.170.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> ./elfutils-0.170</span><br><span class="line">$ ./configire; make -j 8; make install</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=/sources/kernel/elfutils-0.170/libelf:/sources/lib/el7/mpich-3.2.1/include/:<span class="variable">$C_INCLUDE_PATH</span></span><br><span class="line">$ cp -v /boot/config-3.10.0-693.21.1.el7.x86_64 .config</span><br><span class="line">make menuconfig</span><br><span class="line">make rpm-pkg</span><br><span class="line"><span class="comment">### enable what your want</span></span><br></pre></td></tr></table></figure><h4 id="BBR"><a href="#BBR" class="headerlink" title="BBR"></a>BBR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;net.core.default_qdisc=fq&#x27;</span> | sudo tee -a /etc/sysctl.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.tcp_congestion_control=bbr&#x27;</span> | sudo tee -a /etc/sysctl.conf</span><br><span class="line">sudo sysctl -p</span><br><span class="line"></span><br><span class="line">$ sysctl net.ipv4.tcp_available_congestion_control</span><br><span class="line">net.ipv4.tcp_available_congestion_control = cubic bbr reno</span><br><span class="line"></span><br><span class="line">$ sysctl -n net.ipv4.tcp_congestion_control</span><br><span class="line">bbr</span><br></pre></td></tr></table></figure><h3 id="reinstall-grub2-from-boot-livecd"><a href="#reinstall-grub2-from-boot-livecd" class="headerlink" title="reinstall grub2 from boot livecd"></a>reinstall grub2 from boot livecd</h3><p>/dev/sdd2 is my linux root partition, OS is pinguyos(ubuntu)</p><h4 id="LVM-partition"><a href="#LVM-partition" class="headerlink" title="LVM partition"></a>LVM partition</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vgscan</span><br><span class="line">$ lvscan</span><br><span class="line">$ lvchange -a y /dev/centos_vg/lv_root</span><br></pre></td></tr></table></figure><h4 id="Test-in-ubuntu"><a href="#Test-in-ubuntu" class="headerlink" title="Test in ubuntu"></a>Test in ubuntu</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdd2 /opt</span><br><span class="line">mount --<span class="built_in">bind</span> /dev/ /opt/dev</span><br><span class="line">mount --<span class="built_in">bind</span> /sys/ /opt/sys</span><br><span class="line">mount --<span class="built_in">bind</span> /proc /opt/proc</span><br><span class="line">chroot /opt</span><br><span class="line">grub-install /dev/sdd</span><br><span class="line">grub-install --root-directory=/mnt/sysimages/boot/efi /dev/sdd</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure><h4 id="Test-in-CentOS-7-set-boot-menu"><a href="#Test-in-CentOS-7-set-boot-menu" class="headerlink" title="Test in CentOS 7, set boot menu"></a>Test in CentOS 7, set boot menu</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat   /boot/grub2/grub.cfg | grep Windows</span><br><span class="line">menuentry <span class="string">&quot;Windows 7 (loader) (on /dev/sda1)&quot;</span></span><br><span class="line">grub2-set-default  <span class="string">&quot;Windows 7 (loader) (on /dev/sda1)&quot;</span></span><br><span class="line">grub2-editenv list</span><br><span class="line">saved_entry=Windows 7 (loader) (on /dev/sda1)</span><br><span class="line">or </span><br><span class="line">grub2-set-default <span class="string">&quot;windows&quot;</span></span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.conf</span><br></pre></td></tr></table></figure><h4 id="Re-install-EFI"><a href="#Re-install-EFI" class="headerlink" title="Re-install EFI"></a>Re-install EFI</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /opt/boot /opt/root</span><br><span class="line">$ mount /dev/sda1 /opt/root</span><br><span class="line">$ mount /dev/sda2 /opt/root/boot/efi</span><br><span class="line"></span><br><span class="line">$ mount --<span class="built_in">bind</span> /dev/ /opt/dev</span><br><span class="line">$ mount --<span class="built_in">bind</span> /sys/ /opt/sys</span><br><span class="line">$ mount --<span class="built_in">bind</span> /proc /opt/proc</span><br><span class="line"></span><br><span class="line">$ chroot /opt</span><br><span class="line"></span><br><span class="line">$ grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class="line">$ yum install grub2-efi</span><br><span class="line">$ efibootmgr -c --disk /dev/sda --part 2 -l <span class="string">&#x27;\EFI\centos\shimx64.efi&#x27;</span> -L <span class="string">&quot;CentOS Linux&quot;</span>    </span><br><span class="line">// --part 2 point EFI partition number,-l \\EFI\\FEDORA\\GRUBX64.EFI point the GRUB EFI boot loader</span><br></pre></td></tr></table></figure><h3 id="rdesktop-to-win10"><a href="#rdesktop-to-win10" class="headerlink" title="rdesktop to win10"></a>rdesktop to win10</h3><h4 id="Enable-remote-desktop"><a href="#Enable-remote-desktop" class="headerlink" title="Enable remote desktop"></a>Enable remote desktop</h4><p><img src="/img/e_desktop.png"><br><img src="/img/e_firewall.png"></p><h4 id="Modify-registry-from-win10"><a href="#Modify-registry-from-win10" class="headerlink" title="Modify registry from win10"></a>Modify registry from win10</h4><p>\HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\SecurityLayer<br>from DWORD Hex ‘2’ to a value of ‘1’</p><p><a href="http://ubuntuforums.org/showthread.php?t=2287213">reference</a></p><h3 id="record-and-replay-linux-terminal"><a href="#record-and-replay-linux-terminal" class="headerlink" title="record and replay linux terminal"></a>record and replay linux terminal</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ script --timing=time.txt script.log</span><br><span class="line"><span class="comment"># record what you do</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ scriptreplay --timing=time.txt script.log</span><br><span class="line"><span class="comment"># replay</span></span><br></pre></td></tr></table></figure><h3 id="traceroute-error"><a href="#traceroute-error" class="headerlink" title="traceroute error"></a><a href="https://www.ibm.com/support/knowledgecenter/TI0003M/p8hcg/p8hcg_traceroute.htm">traceroute error</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">!H</span><br><span class="line">Host unreachable</span><br><span class="line">!N</span><br><span class="line">Network unreachable</span><br><span class="line">!P</span><br><span class="line">Protocol unreachable</span><br><span class="line">!S</span><br><span class="line">Source route failed</span><br><span class="line">!F</span><br><span class="line">Fragmentation needed</span><br></pre></td></tr></table></figure><h3 id="Getting-Error-su-cannot-set-user-id-Resource-temporarily-unavailable"><a href="#Getting-Error-su-cannot-set-user-id-Resource-temporarily-unavailable" class="headerlink" title="Getting Error su: cannot set user id: Resource temporarily unavailable"></a>Getting Error su: cannot set user id: Resource temporarily unavailable</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -u </span><br><span class="line"><span class="number">1024</span></span><br><span class="line"></span><br><span class="line">$ ulimit -u <span class="number">10240</span></span><br><span class="line"></span><br><span class="line">$ <span class="regexp">/etc/</span>security/limits.conf</span><br><span class="line">testuser         -      nproc          <span class="number">10240</span></span><br><span class="line"></span><br><span class="line">$ cat <span class="regexp">/proc/</span>sys<span class="regexp">/kernel/</span>threads-max</span><br><span class="line"><span class="number">1026188</span></span><br></pre></td></tr></table></figure><h3 id="lshw"><a href="#lshw" class="headerlink" title="lshw"></a>lshw</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lshw -c network -businfo</span><br><span class="line">Bus info          Device      Class          Description</span><br><span class="line">========================================================</span><br><span class="line">pci@0000:04:00.0  em1         network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe</span><br><span class="line">pci@0000:04:00.1  em2         network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe</span><br><span class="line">pci@0000:65:00.0  p2p1        network        Ethernet 10G 2P X520 Adapter</span><br><span class="line">pci@0000:65:00.1  p2p2        network        Ethernet 10G 2P X520 Adapter</span><br><span class="line">                  bond0       network        Ethernet interface</span><br></pre></td></tr></table></figure><h3 id="CentOS8"><a href="#CentOS8" class="headerlink" title="CentOS8"></a>CentOS8</h3><h4 id="bonding"><a href="#bonding" class="headerlink" title="bonding"></a>bonding</h4><p>Because my ansible was generate the config file in network-scripts, but restart NetworkManger centos 8 not work.<br>I got the compatible mode.</p><p>Load the config same with centos 7, after loading, it will work in centos 8<br>Please don’t add “NM_CONTROLLED=no”</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-bond0</span><br><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-enp1s0f0</span><br><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-enp1s0f1</span><br><span class="line">$ nmcli connection reload</span><br></pre></td></tr></table></figure><h5 id="bonding-parameters"><a href="#bonding-parameters" class="headerlink" title="bonding parameters"></a>bonding parameters</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BONDING_OPTS=<span class="string">&quot;mode=4 miimon=100 lacp_rate=fast xmit_hash_policy=layer3+4 arp_validate=0 updelay=30000&quot;</span></span><br><span class="line"></span><br><span class="line">BONDING_OPTS=<span class="string">&quot;mode=1 arp_interval=1000 arp_ip_target=&#123;&#123; gateway &#125;&#125; arp_validate=all&quot;</span></span><br></pre></td></tr></table></figure><ul><li><a href="https://access.redhat.com/solutions/30732">none (0)</a><ul><li>active<ul><li>MII Status is UP as long as any network frame is received within arp_interval × 2</li></ul></li><li>inactive<ul><li>MII Status is UP as long as any network frame is received within arp_interval × 2</li></ul></li></ul></li><li>active (1)<ul><li>active<ul><li>MII Status is UP as long as an ARP Response is received from the arp_ip_target within arp_interval × 2</li></ul></li><li>inactive<ul><li>MII Status is UP as long as any network frame is received within arp_interval × 2</li></ul></li></ul></li><li>backup (2)<ul><li>active<ul><li>MII Status is UP as long as any network frame is received within arp_interval × 2</li></ul></li><li>inactive<ul><li>MII Status is UP as long as the broadcast ARP Requests sent to the arp_ip_target by the Active Slave are seen within arp_interval × 2</li></ul></li></ul></li><li>all (3)<ul><li>active<ul><li>MII Status is UP as long as an ARP Response is received from the arp_ip_target within arp_interval × 2</li></ul></li><li>inactive<ul><li>MII Status is UP as long as the broadcast ARP Requests sent to the arp_ip_target by the Active Slave are seen within arp_interval × 2</li></ul></li></ul></li><li>filter (4)<ul><li>active<ul><li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li></ul></li><li>inactive<ul><li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li></ul></li></ul></li><li>filter_active (5)<ul><li>active<ul><li>MII Status is UP as long as an ARP Response is received from the arp_ip_target within arp_interval × 2</li></ul></li><li>inactive<ul><li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li></ul></li></ul></li><li>filter_backup (6)<ul><li>active<ul><li>MII Status is UP as long as any ARP packet is received within arp_interval × 2</li></ul></li><li>inactive<ul><li>MII Status is UP as long as the broadcast ARP Requests sent to the arp_ip_target by the Active Slave are seen within arp_interval × 2</li></ul></li></ul></li></ul><h3 id="fio-test-multiple-nodes"><a href="#fio-test-multiple-nodes" class="headerlink" title="fio test multiple nodes"></a>fio test multiple nodes</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ fio --server</span><br><span class="line"><span class="comment">## start fio process in each test server</span></span><br><span class="line"></span><br><span class="line">$ cat fio-test</span><br><span class="line">Server-A-ip</span><br><span class="line">Server-B-ip</span><br><span class="line">Server-C-ip</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ fio --client=fio_hosts.list /mnt/fio.cfg</span><br><span class="line"></span><br><span class="line">All clients: (groupid=0, <span class="built_in">jobs</span>=8): err= 0: pid=0: Fri Mar  6 17:08:04 2020</span><br><span class="line">   <span class="built_in">read</span>: IOPS=1147, BW=1148Mi (1203M)(1011GiB/902172msec)</span><br><span class="line">    slat (nsec): min=58, max=368519, avg=450.92, stdev=799.19</span><br><span class="line">    clat (usec): min=1355, max=4778.4k, avg=58198.62, stdev=114448.04</span><br><span class="line">     lat (usec): min=1356, max=4778.4k, avg=58199.07, stdev=114448.07</span><br><span class="line">   bw (  KiB/s): min= 2043, max=2654208, per=12.74%, avg=149910.02, stdev=178032.72, samples=14109</span><br><span class="line">   iops        : min=    1, max= 2592, avg=146.33, stdev=173.87, samples=14109</span><br><span class="line">  write: IOPS=1146, BW=1146Mi (1202M)(1010GiB/902172msec)</span><br><span class="line">    slat (nsec): min=162, max=916488, avg=799.05, stdev=783.74</span><br><span class="line">    clat (usec): min=1345, max=3839.9k, avg=52775.15, stdev=105530.38</span><br><span class="line">     lat (usec): min=1346, max=3839.9k, avg=52775.95, stdev=105530.41</span><br></pre></td></tr></table></figure><h3 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SUID (Set owner User ID up on execution)</span><br><span class="line">chmod 4555/u+s /<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">ls -l /usr/bin/passwd  /etc/shadow</span><br><span class="line">----------  1 root root  1005 Feb 14 14:15 /etc/shadow</span><br><span class="line">-rwsr-xr-x. 1 root root 27856 Aug  9  2019 /usr/bin/passwd</span><br><span class="line"></span><br><span class="line">SUID is defined as giving temporary permissions to a user to run a program/file with the permissions of the file owner rather that the user who runs it</span><br><span class="line"></span><br><span class="line">SGID</span><br><span class="line">chmod 2555/g+s /dir </span><br><span class="line">similar with SUID, it <span class="string">&#x27;s the group bit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Sticky Bit</span></span><br><span class="line"><span class="string">chmod 1777/chmod +t /tmp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- T refers to when the execute permissions are off.</span></span><br><span class="line"><span class="string">- t refers to when the execute permissions are on.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The sticky bit is primarily used on shared directories. </span></span><br><span class="line"><span class="string">[For example if user bob creates a file named /tmp/bob, other user tom can not delete this file even when the /tmp directory has permission of 777. If sticky bit is not set then tom can delete /tmp/bob, as the /tmp/bob file inherits the parent directory permissions.](https://www.thegeekdiary.com/what-is-suid-sgid-and-sticky-bit/)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### set time</span></span><br><span class="line"><span class="string">#### back access time</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">$ atime=$(stat -c%X $filename)</span></span><br><span class="line"><span class="string">$ touch -a --date=@$&#123;atime&#125; $newpath</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ mtime=$(stat -c%Z $filename)</span></span><br><span class="line"><span class="string">$ touch -m --date=@$&#123;mtime&#125; $newpath</span></span><br></pre></td></tr></table></figure><h3 id="screen-1"><a href="#screen-1" class="headerlink" title="screen"></a>screen</h3><p>background run command</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;screen -dmS collectl su -s /bin/bash nobody -c &quot;</span>\<span class="string">&#x27;&quot;collectl --export graphite,$ip,d=2 -i60 -s CMDN --netfilt &quot;\&quot;&quot;eth|en|p[0-9]|em&quot;\&quot;&quot; --dskfilt &quot;\&quot;&quot;nvme|sd&quot;\&quot;\&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Add-systemd-service"><a href="#Add-systemd-service" class="headerlink" title="Add systemd service"></a>Add systemd service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/etc/systemd/system/apm.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Local system resume actions</span><br><span class="line">After=suspend.target hybrid-sleep.target hibernate.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/hdparm -B 254 /dev/sda</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sleep.target</span><br></pre></td></tr></table></figure><h3 id="route-config"><a href="#route-config" class="headerlink" title="route config"></a>route config</h3><h4 id="static-route"><a href="#static-route" class="headerlink" title="static route"></a>static route</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">subnet mask could be</span><br><span class="line">01011000  255.255.255.88</span><br><span class="line"></span><br><span class="line">just recommend against using noncontiguous subnet masks.</span><br><span class="line"></span><br><span class="line">cat /etc/sysconfig/network-scripts/route-em1</span><br><span class="line">ADDRESS0=10.64.0.0</span><br><span class="line">NETMASK0=255.240.0.0</span><br><span class="line">GATEWAY0=192.168</span><br><span class="line">ADDRESS1=10.200.0.0</span><br><span class="line">NETMASK1=255.252.0.0</span><br><span class="line">GATEWAY1=10.64.64.247</span><br><span class="line">ADDRESS2=10.236.0.0</span><br><span class="line">NETMASK2=255.255.0.0</span><br><span class="line">GATEWAY2=10.64.64.247</span><br></pre></td></tr></table></figure><h3 id="Check-NIC-driver-err"><a href="#Check-NIC-driver-err" class="headerlink" title="Check NIC driver err"></a>Check NIC driver err</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S enp129s0f0 | grep -Ei <span class="string">&#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="collectl"><a href="#collectl" class="headerlink" title="collectl"></a>collectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ collectl --top iokb</span><br><span class="line">$ collectl --vmstat</span><br><span class="line">$ collectl -sZ</span><br><span class="line">$ collectl -c10 -f /opt</span><br><span class="line"></span><br><span class="line"><span class="comment">## replay collectl</span></span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT</span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT --from 15:02:00 --thru 15:02:05</span><br><span class="line">$ collectl --<span class="built_in">export</span> graphite,locahost,d=9 -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz</span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT --from <span class="string">&quot;03:30:18&quot;</span> --thru <span class="string">&quot;06:32:08&quot;</span></span><br><span class="line"></span><br><span class="line">$ collectl --showoptions</span><br><span class="line">$ collectl --showsubsys</span><br><span class="line">$ collectl --showsubopts</span><br><span class="line">$ collectl --showtopopts</span><br><span class="line">$ collectl -i3 --<span class="built_in">export</span> graphite,192.168.1.1:2003,b=test-node -sCMDNt --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -m -r00:00,7 -f /var/<span class="built_in">log</span>/collectl --rawtoo</span><br><span class="line">$ collectl -i3 -P -sCMDNt --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -m -r00:00,7 -f /var/<span class="built_in">log</span>/collectl --rawtoo</span><br><span class="line">$ collectl -i3 --<span class="built_in">export</span> graphite,192.168.1.1:2003,d=1,s=dn -sCMDNT --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -rawtoo -f /var/<span class="built_in">log</span>/collectl</span><br><span class="line">$ collectl -i3 --<span class="built_in">export</span> graphite,192.168.1.1:2003,b=test-node -s CMDNt --netfilt <span class="string">&quot;eth|en|p[0-9]|em|bond&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> --rawtoo -f /var/<span class="built_in">log</span>/collectl/</span><br><span class="line"><span class="comment">### tip - if you add 8 to the debug flag, eg d=9, this tells the graphite module not to actually establish the connection with graphite&#x27;s carbon listener but to only echo the data that would have been sent.</span></span><br><span class="line">$ collectl --all --<span class="built_in">export</span> graphite,locahost,d=9 --rawtoo -f /var/<span class="built_in">log</span>/collectl/</span><br><span class="line">$ collectl -i3 -sCDNMJFt --<span class="built_in">export</span> graphite,locahost,d=9 --rawtoo -f /var/<span class="built_in">log</span>/collectl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># collectl.conf</span></span><br><span class="line">DaemonCommands = collectl -i30 -sCDEFJMNTXYZs --netfilt <span class="string">&quot;eth|en|p[0-9]|em&quot;</span> --dskfilt <span class="string">&quot;nvme|sd&quot;</span> -f /var/<span class="built_in">log</span>/collectl -r00:00,7 -m -F60 --rawtoo -P</span><br></pre></td></tr></table></figure><h3 id="process-mointor"><a href="#process-mointor" class="headerlink" title="process mointor"></a>process mointor</h3><p>atop -PMEM not got the right value, do it by yourself</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##process memory overhead</span></span><br><span class="line">awk <span class="string">&#x27;$0~/Pss/&#123;mem+=$2&#125;; END &#123;printf &quot;%.2f GiB\n&quot;, mem/1024/1024&#125;&#x27;</span> /proc/44833/smaps</span><br><span class="line"></span><br><span class="line"><span class="comment">##the system memory overhead</span></span><br><span class="line">awk <span class="string">&#x27;$0~/Pss/&#123;mem+=$2&#125;; END &#123;printf &quot;%.2f GiB\n&quot;, mem/1024/1024&#125;&#x27;</span> /proc/[1-9]*/smaps</span><br></pre></td></tr></table></figure><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">## Kill all processes with the ppid</span><br><span class="line">$ pkill -P $$ </span><br><span class="line">$ kill $(ps -o pid= --ppid $$)</span><br><span class="line"></span><br><span class="line">$ top -<span class="keyword">n</span> 3 -b</span><br><span class="line">$ top -b -p 12345</span><br><span class="line">$ pstree -sg 25153 # get process tree</span><br><span class="line">systemd(1)───sshd(3266)───sshd(32704)───hydra_pmi_proxy(32706)───<span class="keyword">test</span>.<span class="keyword">sh</span>(32725)</span><br><span class="line"></span><br><span class="line">$ pstree -sga 32725</span><br><span class="line">systemd,1 --switched-root --system --deserialize 22</span><br><span class="line">  └─sshd,3266 -<span class="keyword">D</span></span><br><span class="line">      └─sshd,32704</span><br><span class="line">          └─hydra_pmi_proxy,32706 --control-port centos7-<span class="keyword">test</span>:38001 --rmk user --launcher ssh --demux poll --pgid 0 --retries 10--<span class="keyword">u</span></span><br><span class="line">              └─<span class="keyword">test</span>.<span class="keyword">sh</span>,32725 /root/<span class="keyword">test</span>.<span class="keyword">sh</span> /mnt</span><br><span class="line"></span><br><span class="line">$ pidstat -drsuw</span><br><span class="line"><span class="comment">    * CPU utilization</span></span><br><span class="line"><span class="comment">    * IO</span></span><br><span class="line"><span class="comment">    * page faults and memory utilization</span></span><br><span class="line"><span class="comment">    * stack utilization</span></span><br><span class="line"><span class="comment">    * task switching</span></span><br><span class="line">$ collectl -i:1 -sZ --procopts wt --procfilt p<span class="variable">$pid</span> -oT</span><br><span class="line">$ collectl -i:1 -sZ --procopts wt --procfilt <span class="keyword">u</span><span class="variable">$uid</span> -oT</span><br><span class="line"></span><br><span class="line">$ iotop -b -n1 -o -P</span><br><span class="line"></span><br><span class="line">sys%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> <span class="variable">$9</span>/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line"><span class="keyword">use</span>%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> (<span class="variable">$10</span>+<span class="variable">$11</span>)/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line"></span><br><span class="line">idle%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> <span class="variable">$12</span>/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line">wait%</span><br><span class="line">$  atop -P CPU 2 | awk &#x27;<span class="variable">$0</span>~/CPU/&#123;<span class="keyword">print</span> <span class="variable">$13</span>/(<span class="variable">$9</span>+<span class="variable">$10</span>+<span class="variable">$11</span>+<span class="variable">$12</span>+<span class="variable">$13</span>+<span class="variable">$14</span>+<span class="variable">$15</span>+<span class="variable">$16</span>+<span class="variable">$17</span>)<span class="string">&quot;%&quot;</span>&#125;&#x27;</span><br><span class="line"></span><br><span class="line">$ atop -<span class="keyword">d</span> -c -PPRD 1 1  | <span class="keyword">sort</span> -nr -k 13 -k 15  | head</span><br><span class="line">                                                                           reads    <span class="keyword">read</span> sec     writes write sec(512B)</span><br><span class="line">PRD kvm-manager-a23-1 1585239068 2020/03/27 00:11:08 4256 4006 (bash) S <span class="keyword">n</span> y 1758081744 1758081744 64      64              48 4006 <span class="keyword">n</span> y</span><br><span class="line">last <span class="keyword">line</span> &#x27;y&#x27; <span class="keyword">means</span> not thread</span><br><span class="line"> (2097152/1024=2048KB)</span><br><span class="line">$ atop -c -<span class="keyword">m</span> 5 # show cpu and mem, interval 5s                                                                          huge page size (bytes)</span><br><span class="line">$ atop -PCPU,MEM 5 # Batch-mode output cpu and <span class="keyword">memory</span>                                                                               |</span><br><span class="line">                                                        interval   <span class="keyword">total</span>(page)          cache       slab  slab-rec  shmem  shswp hugesz hpfre</span><br><span class="line">                                                             |         |                  |           |          |      |     |    |      |</span><br><span class="line">MEM cngb-compute-h3c-amd-<span class="keyword">test</span> 1608821373 2020/12/24 22:49:33 2 4096 264131575 217895897 230834 13135 222600 16 44190 0 2598 8 0 2097152 0 0 0</span><br><span class="line">                                                                |               |               |           |        |      |           |   |</span><br><span class="line">                                                             pagesize         free            fsbuff      dirty  vmball  shrss       hptot arc</span><br><span class="line">                                <span class="keyword">total</span>       free           cache buff   slap dirty</span><br><span class="line">awk &#x27;BEGIN&#123;printf <span class="string">&quot;%f GB\n&quot;</span>, ((264131575-217895897)*4096-(230834+13135+222600+16+44190+2598)*4096)/1024/1024/1024&#125;&#x27;</span><br><span class="line"></span><br><span class="line">## <span class="keyword">man</span> page is wrong, source code is right, and I make sure with /proc/meminfo </span><br><span class="line">print_MEM(<span class="keyword">char</span> *hp, struct sstat *ss, struct tstat *ps, int nact)</span><br><span class="line">&#123;</span><br><span class="line">printf(<span class="string">&quot;%s %u %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld\n&quot;</span>,</span><br><span class="line">hp,</span><br><span class="line">pagesize,</span><br><span class="line">ss-&gt;mem.physmem,</span><br><span class="line">ss-&gt;mem.freemem,</span><br><span class="line">ss-&gt;mem.cachemem,</span><br><span class="line">ss-&gt;mem.buffermem,</span><br><span class="line">ss-&gt;mem.slabmem,</span><br><span class="line">ss-&gt;mem.cachedrt,</span><br><span class="line">ss-&gt;mem.slabreclaim,</span><br><span class="line">        ss-&gt;mem.vmwballoon,</span><br><span class="line">        ss-&gt;mem.shmem,</span><br><span class="line">        ss-&gt;mem.shmrss,</span><br><span class="line">        ss-&gt;mem.shmswp,</span><br><span class="line">        ss-&gt;mem.hugepagesz,</span><br><span class="line">        ss-&gt;mem.tothugepage,</span><br><span class="line">        ss-&gt;mem.freehugepage,</span><br><span class="line">        ss-&gt;mem.zfsarcsize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ atop -<span class="keyword">d</span> -c -PPRD 1 1  | awk &#x27;NF&gt;10 &#123;<span class="keyword">if</span>($(NF-6)+$(NF-4)&gt;120000) &#123;<span class="keyword">if</span>(<span class="variable">$NF</span>==<span class="string">&quot;y&quot;</span>) <span class="keyword">print</span> <span class="variable">$0&#125;</span>&#125;&#x27; </span><br><span class="line"># show the proc/thread <span class="keyword">read</span> or write &gt; 60MB</span><br></pre></td></tr></table></figure><h3 id="time"><a href="#time" class="headerlink" title="time"></a>time</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/time -f <span class="string">&quot;%E real,%U user,%S sys&quot;</span> sleep 2</span><br><span class="line">0:02.00 real,0.00 user,0.00 sys</span><br><span class="line"></span><br><span class="line">$ /usr/bin/time -f <span class="string">&quot;%e real&quot;</span> sleep 70</span><br><span class="line">70.00 real</span><br></pre></td></tr></table></figure><h3 id="youtube-download"><a href="#youtube-download" class="headerlink" title="youtube download"></a>youtube download</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 youtube-dl -F https://www.youtube.com/watch?v=_xxxxxx</span><br><span class="line">[info] Available formats <span class="keyword">for</span> _12OJxATpsA:</span><br><span class="line">format code  extension  resolution note</span><br><span class="line">249          webm       audio only tiny   62k , opus @ 50k (48000Hz), 51.86MiB</span><br><span class="line">250          webm       audio only tiny   81k , opus @ 70k (48000Hz), 68.24MiB</span><br><span class="line">140          m4a        audio only tiny  136k , m4a_dash container, mp4a.40.2@128k (44100Hz), 139.88MiB</span><br><span class="line">251          webm       audio only tiny  158k , opus @160k (48000Hz), 136.13MiB</span><br><span class="line">278          webm       256x144    144p  103k , webm container, vp9, 30fps, video only, 100.43MiB</span><br><span class="line">160          mp4        256x144    144p  115k , avc1.4d400c, 30fps, video only, 83.46MiB</span><br><span class="line">242          webm       426x240    240p  250k , vp9, 30fps, video only, 202.66MiB</span><br><span class="line">133          mp4        426x240    240p  257k , avc1.4d4015, 30fps, video only, 168.64MiB</span><br><span class="line">243          webm       640x360    360p  611k , vp9, 30fps, video only, 377.13MiB</span><br><span class="line">134          mp4        640x360    360p  665k , avc1.4d401e, 30fps, video only, 442.58MiB</span><br><span class="line">244          webm       854x480    480p 1052k , vp9, 30fps, video only, 677.08MiB</span><br><span class="line">135          mp4        854x480    480p 1343k , avc1.4d401f, 30fps, video only, 868.67MiB</span><br><span class="line">247          webm       1280x720   720p 2410k , vp9, 30fps, video only, 1.35GiB</span><br><span class="line">136          mp4        1280x720   720p 2678k , avc1.4d401f, 30fps, video only, 1.66GiB</span><br><span class="line">248          webm       1920x1080  1080p 4356k , vp9, 30fps, video only, 2.42GiB</span><br><span class="line">137          mp4        1920x1080  1080p 4525k , avc1.640028, 30fps, video only, 3.06GiB</span><br><span class="line">271          webm       2560x1440  1440p 9330k , vp9, 30fps, video only, 7.15GiB</span><br><span class="line">18           mp4        640x360    360p  622k , avc1.42001E, mp4a.40.2@ 96k (44100Hz), 685.04MiB</span><br><span class="line">22           mp4        1280x720   720p 1673k , avc1.64001F, mp4a.40.2@192k (44100Hz) (best)</span><br><span class="line"></span><br><span class="line">$ proxychains4 youtube-dl -f 137+bestaudio --merge-output-format mkv https://www.youtube.com/watch?v=_xxxxxx</span><br></pre></td></tr></table></figure><h3 id="uptime-and-vmstat-running"><a href="#uptime-and-vmstat-running" class="headerlink" title="uptime and vmstat running"></a>uptime and vmstat running</h3><ul><li><p>(uptime) number of processes that are either in a runnable or uninterruptable state.</p><ul><li>runnable state is either using the CPU or waiting to use the  CPU. <ul><li>A process in uninterruptable state is waiting for some I/O access.</li></ul></li></ul></li><li><p>(vmstat) Procs r: The number of runnable processes (running or waiting for run time, no contains uninterruptable state)</p></li></ul><h3 id="kernel-do-IRQ-X-Y-No-irq-handler-for-vector-irq-1"><a href="#kernel-do-IRQ-X-Y-No-irq-handler-for-vector-irq-1" class="headerlink" title="kernel: do_IRQ: X.Y No irq handler for vector (irq -1)"></a>kernel: do_IRQ: X.Y No irq handler for vector (irq -1)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * do_IRQ handles all normal device IRQ&#x27;s (the special</span></span><br><span class="line"><span class="comment"> * SMP cross-CPU interrupts have their own specific</span></span><br><span class="line"><span class="comment"> * handlers).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">__visible <span class="keyword">void</span> __irq_entry <span class="title">do_IRQ</span><span class="params">(struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> *<span class="title">old_regs</span> = <span class="title">set_irq_regs</span>(<span class="title">regs</span>);</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> * <span class="title">desc</span>;</span></span><br><span class="line"><span class="comment">/* high bit used in ret_from_ code  */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="built_in">vector</span> = ~regs-&gt;orig_ax;</span><br><span class="line"></span><br><span class="line">entering_irq();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* entering_irq() tells RCU that we&#x27;re not quiescent.  Check it. */</span></span><br><span class="line">RCU_LOCKDEP_WARN(!rcu_is_watching(), <span class="string">&quot;IRQ failed to wake up RCU&quot;</span>);</span><br><span class="line"></span><br><span class="line">desc = __this_cpu_read(vector_irq[<span class="built_in">vector</span>]);</span><br><span class="line"><span class="keyword">if</span> (likely(!IS_ERR_OR_NULL(desc))) &#123;</span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_X86_32))</span><br><span class="line">handle_irq(desc, regs);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">generic_handle_irq_desc(desc);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ack_APIC_irq();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (desc == VECTOR_UNUSED) &#123;</span><br><span class="line">pr_emerg_ratelimited(<span class="string">&quot;%s: %d.%d No irq handler for vector\n&quot;</span>,</span><br><span class="line">     __func__, smp_processor_id(),</span><br><span class="line">     <span class="built_in">vector</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">__this_cpu_write(vector_irq[<span class="built_in">vector</span>], VECTOR_UNUSED);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exiting_irq();</span><br><span class="line"></span><br><span class="line">set_irq_regs(old_regs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>system log</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Tue Apr 28 09:09:19 2020] do_IRQ: 6.95 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:23:21 2020] do_IRQ: 2.163 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:38:13 2020] do_IRQ: 2.151 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:48:55 2020] do_IRQ: 0.155 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:49:25 2020] do_IRQ: 2.205 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:51:51 2020] do_IRQ: 4.123 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:53:05 2020] do_IRQ: 2.208 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 10:29:52 2020] do_IRQ: 6.180 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 10:41:23 2020] do_IRQ: 2.133 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:30:06 2020] do_IRQ: 6.191 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:39:22 2020] do_IRQ: 4.234 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:42:23 2020] do_IRQ: 0.137 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:46:53 2020] do_IRQ: 2.38 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:57:25 2020] do_IRQ: 6.98 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 12:35:11 2020] do_IRQ: 4.121 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 12:39:12 2020] do_IRQ: 2.163 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 13:05:26 2020] do_IRQ: 0.223 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:00:30 2020] do_IRQ: 6.91 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:08:06 2020] do_IRQ: 0.159 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:26:09 2020] do_IRQ: 6.110 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line"></span><br><span class="line">$ grep -wEi <span class="string">&#x27;95|98|38|91|121|163&#x27;</span> /proc/interrupts</span><br><span class="line">  38:   98081083          0  142920345          0  123688922          0  172399026          0   PCI-MSI-edge      0000:00:11.4</span><br><span class="line">  91:         34          0         11          0         23          0         18          0   PCI-MSI-edge      em4-fp-7</span><br><span class="line"></span><br><span class="line">00:11.4 SATA controller: Intel Corporation C610/X99 series chipset sSATA Controller [AHCI mode] (rev 05)</span><br></pre></td></tr></table></figure><ul><li><p>Hardware issue # ipmi elist is ok</p></li><li><p>The hardware driver register num overflow</p></li><li><p>The hardware driver/firmware bug cause responds hobbledown</p></li><li><p>The bad APIC(programmable interrupt controller) got the wrong IRQ number</p><ul><li>disable APIC,  noapic pci=nomsi,noaer,acpi=off</li></ul></li></ul><h3 id="multipath-issue"><a href="#multipath-issue" class="headerlink" title="multipath issue"></a><a href="https://access.redhat.com/solutions/2437991">multipath issue</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: device-mapper: multipath: Failing path 70:64.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: device-mapper: multipath: Failing path 71:80.</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: 70:64: mark as failed</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: nsd_crs_04: remaining active paths: 1</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: 71:80: mark as failed</span><br><span class="line"></span><br><span class="line">$ cat /etc/udev/rules.d/99-custom.rules <span class="comment"># lfs must set to 16383</span></span><br><span class="line">ACTION!=<span class="string">&quot;add|change&quot;</span>, GOTO=<span class="string">&quot;rule_end&quot;</span> ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;NETAPP*&quot;</span>,  RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 16383 &gt; /sys%p/queue/max_sectors_kb&#x27;&quot;</span> LABEL=<span class="string">&quot;rule_end&quot;</span></span><br><span class="line"></span><br><span class="line">or you could add <span class="string">&quot; max_sectors_kb          16383 &quot;</span> to multipath.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">### add to initramfs</span></span><br><span class="line">$ cp  -av  /boot/initramfs-$(uname -r).img  /boot/initramfs-$(uname -r).img.bak</span><br><span class="line">dracut -f -v -i /etc/udev/rules.d/99-custom.rules /etc/udev/rules.d/99-custom.rules</span><br><span class="line">or</span><br><span class="line">dracut -f -v -i /etc/udev/rules.d/99-custom.rules /etc/multipath.conf</span><br></pre></td></tr></table></figure><h3 id="sshfs"><a href="#sshfs" class="headerlink" title="sshfs"></a>sshfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sshfs -p <span class="variable">$port</span> <span class="variable">$&#123;user&#125;</span>@<span class="variable">$&#123;ipaddr&#125;</span>:/mnt/sshfs ~/Downloads -o noatime,nonempty,reconnect,ServerAliveInterval=15,ServerAliveCountMax=3</span><br></pre></td></tr></table></figure><h3 id="scan-file-size"><a href="#scan-file-size" class="headerlink" title="scan file size"></a>scan file size</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## the diff performance in the diff file system</span></span><br><span class="line">$ find /tank -<span class="built_in">printf</span> <span class="string">&#x27;%p\t%Y\t%b\t%s\t%U\t%G\t%A@\n&#x27;</span></span><br><span class="line">$ ls -flsR --time=atime --time-style=<span class="string">&#x27;+%s&#x27;</span> /root/rpmbuild | awk <span class="string">&#x27;/:$/&amp;&amp;f&#123;f=0;&#125;;/:$/&amp;&amp;!f&#123;sub(/:$/,&quot;&quot;);s=$0;f=1;next&#125;;NF&amp;&amp;f&#123; print $0&quot; &quot;s &#125;&#x27;</span></span><br><span class="line">       |                                                               |                   |</span><br><span class="line">       |                                                               |                   --- first line trigger</span><br><span class="line">       |                                                               |</span><br><span class="line">       |                                                               ----- just change f value <span class="keyword">for</span> parent <span class="built_in">dirs</span> <span class="string">&quot;the last char is : , means no file, the next dir&quot;</span></span><br><span class="line">       |                                                                     next change the f value and try to the <span class="string">&quot;first line trigger&quot;</span> part to record the s val</span><br><span class="line">       --- the parameter could not out of order</span><br><span class="line"></span><br><span class="line"><span class="comment">## you should find too many &quot;.&quot; files </span></span><br><span class="line">$ find /tank -name <span class="string">&quot;.*&quot;</span> -<span class="built_in">printf</span> <span class="string">&#x27;%P\t%Y\t%b\t%s\t%U\t%G\t%A@\n&#x27;</span> &gt; tank.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#exclude 2 dirs</span></span><br><span class="line">$ find /opt/test1 -<span class="built_in">type</span> f -not -path <span class="string">&quot;/opt/test1/linux1/*&quot;</span> -not -path <span class="string">&quot;/opt/test1/linux2/*&quot;</span></span><br></pre></td></tr></table></figure><h3 id="System-err-for-monitor"><a href="#System-err-for-monitor" class="headerlink" title="System err for monitor"></a>System err for monitor</h3><p>scsi:<br>has been suspended<br>attempting host reset<br>mpt.*sas_cm.*Command Timeout<br>Medium.*Error<br>Unrecovered</p><p>kernel:<br>Got BUG: soft lockup<br>NMI watchdog.*BUG</p><p>mem:<br>page allocation failure<br>Err.*bit ECC</p><p>irq:<br>No irq handler for vector</p><p>nvme:<br>nvme nvme.*I/O.*timeout, aborting<br>reset controller<br>Device not ready; aborting reset<br>probe failure status</p><p>kernel:<br>INFO: task xxx:xxx blocked for more than 120 seconds.<br>kernel process or thread hang, could not be wake up at 120s<br>    hungtask<br>        hung_task_panic        0<br>        hung_task_check_count  32768<br>        hung_task_timeout_secs 120s<br>        hung_task_warnings     10x times</p><p>softlockup<br>NMI watchdog: BUG: soft lockup - CPU#0 stuck for 23s! [cat:153]<br>softlockup deadlock, check the kernel schdule is ok, if trigger the softlockup, the kernel could not be schduled.<br>When hrtimer wake up the kernel thread and update watchdog_touch_ts, if time now - watchdog_touch_ts &gt; timeout value, it will show this error, that mean schdule timeout.<br>/proc/sys/kernel/nmi_watchdog      hard lockup<br>/proc/sys/kernel/soft_watchdog     soft lockup<br>/proc/sys/kernel/watchdog          watchdog<br>/proc/sys/kernel/watchdog_cpumask  watchdog cpumaks，<br>/proc/sys/kernel/watchdog_thresh   watchdog timeoout</p><p>softlockup : the kernel loop in kernel mode without giving other tasks a chance to run, a kernel task won’t be unlock the CPU.<br>             A soft lockup is when a running task is executing kernel code and wont yield the CPU to allow other tasks to run.<br>             The default soft lockup threshold is 60 seconds for RHEL5/6 and 20 seconds on RHEL7.<br>hardlockup : the kernel loop in kernel mode without letting other interrupts have change to run, the interrupts aren’t being processes.<br>             A hard lockup is when a CPU has interrupts disabled for a long time, which might block important communication between processes or hardware.<br>             The default hard lockup threshold is 30 second on RHEL5/6 and 10 seconds on RHEL7.</p><p>In redhat <a href="https://access.redhat.com/articles/1353303">doc</a><br>Each CPU has registered it’s own high resolution timer and both hard and soft lockup detection are closely connected with it.<br>This timer is fired approximately every [watchdog_thresh * 2 / 5]-seconds and does mainly three things:</p><ol><li><p>Wakes up a CPU specific watchdog task with the highest possible priority, in order to get scheduled as soon as possible. This task’s main job is to update a PER_CPU timestamp called watchdog_touch_ts.</p></li><li><p>Checks if watchdog_touch_ts + watchdog_thresh is smaller than current actual time. If yes, or in other words, if the watchdog task didn’t run for longer than watchdog_thresh, then a soft lockup is reported.</p></li><li><p>Increments a CPU specific interrupt counter called hrtimer_interrupts, denoting that an interrupt happened on the CPU.</p></li></ol><p>Detecting a hard lockup is a bit trickier, since the CPU is stuck and has disabled interrupts. In order to detect it, each CPU has registered a watchdog perf event, which ensures that the CPU hardware issues an NMI (non-maskable interrupt) every [hard lockup threshold]-seconds. Generally approximately 2-3 high resolution timer interrupts are supposed to happen in-between 2 of these NMIs.<br>The handler function of this NMI will check the hrtimer_interrupts counter and copy-save it’s current value. If it sees the same value as it has saved before, it reports a hard lockup, because it means that no interrupt happened during [hard lockup threshold]-seconds.</p><p>Usually a CPU lockup is caused by a task stuck in a loop. Sometimes it’s due to a code loop where the termination condition has not yet been met. For example it may be an unbounded list (ie while !list_empty()). In cases like this the code should limit the maximum iterations of the loop before voluntarily yielding the CPU (ie cond_resched()).</p><p>Often CPU lockups are caused by tasks trying to acquire a spinlock that for some reason cannot be acquired in a reasonable time. This could be due to current owner of the lock not relinquishing the lock or it may be a case of starvation where excessive activity on the lock delays some tasks long enough to exceed the watchdog threshold (ie RHEL5 spinlocks on numa).</p><p>Other cases involve a loop where the termination condition is never going to be met. For example the code expects a state change that isn’t going to happen.</p><p>It’s also possible to get false reports from the watchdog on virtual machines where the host system stalls the guest for longer than the watchdog threshold period. The watchdog will think the guest has been running during that time but the CPUs have not been able to make progress.</p><p>##default is enabled<br>$ sysctl kernel.softlockup_panic kernel.hardlockup_panic<br>kernel.softlockup_panic = 0<br>kernel.hardlockup_panic = 0</p><p>##disable, there is no soft lockup watchdog here<br>echo 1 &gt; /proc/sys/kernel/softlockup_panic</p><p><a href="https://blog.seibert-media.com/2018/01/04/log-book-linux-cpu-lockups/#:~:text=A%20'hard%20lockup'%20is%20defined,the%20good%20old%20DOS%20days.">Provoke lockups with your own kernel module</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hog.c</span></span><br><span class="line"><span class="comment">#include &lt;linux/init.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/module.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/kernel.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/kthread.h&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="string">MODULE_LICENSE(&quot;GPL&quot;);</span></span><br><span class="line"> </span><br><span class="line"><span class="string">static</span> <span class="string">int</span></span><br><span class="line"><span class="string">hog_thread(void</span> <span class="string">*data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">printk(KERN_INFO</span> <span class="string">&quot;Hogging a CPU now\n&quot;</span><span class="string">);</span></span><br><span class="line">    <span class="string">while</span> <span class="string">(1);</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">/*</span> <span class="string">unreached</span> <span class="string">*/</span></span><br><span class="line">    <span class="string">return</span> <span class="number">0</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">static</span> <span class="string">int</span> <span class="string">__init</span></span><br><span class="line"><span class="string">hog_init(void)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">kthread_run(hog_thread</span>, <span class="literal">NULL</span>, <span class="string">&quot;hog&quot;</span><span class="string">);</span></span><br><span class="line">    <span class="string">return</span> <span class="number">0</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">module_init(hog_init);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#makefile</span></span><br><span class="line"><span class="string">obj-m</span> <span class="string">+=</span> <span class="string">hog.o</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">    <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(shell</span> <span class="string">uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(PWD)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">clean:</span></span><br><span class="line">    <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(shell</span> <span class="string">uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(PWD)</span> <span class="string">clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in centos </span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">Makefile</span></span><br><span class="line"><span class="string">obj-m</span> <span class="string">+=</span> <span class="string">hog.o</span></span><br><span class="line"></span><br><span class="line"><span class="attr">all:</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">clean:</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">clean</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">Entering</span> <span class="string">directory</span> <span class="string">`/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span></span><br><span class="line">  <span class="string">CC</span> [<span class="string">M</span>]  <span class="string">/root/hog/hog.o</span></span><br><span class="line">  <span class="string">Building</span> <span class="string">modules,</span> <span class="string">stage</span> <span class="number">2</span><span class="string">.</span></span><br><span class="line">  <span class="string">MODPOST</span> <span class="number">1</span> <span class="string">modules</span></span><br><span class="line">  <span class="string">CC</span>      <span class="string">/root/hog/hog.mod.o</span></span><br><span class="line">  <span class="string">LD</span> [<span class="string">M</span>]  <span class="string">/root/hog/hog.ko</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">Leaving</span> <span class="string">directory</span> <span class="string">`/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ls</span> </span><br><span class="line"><span class="string">hog.c</span>  <span class="string">hog.ko</span>  <span class="string">hog.mod.c</span>  <span class="string">hog.mod.o</span>  <span class="string">hog.o</span>  <span class="string">Makefile</span>  <span class="string">modules.order</span>  <span class="string">Module.symvers</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">insmod</span> <span class="string">hog.ko</span></span><br><span class="line"><span class="string">$</span> <span class="string">lsmod</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">hog</span></span><br><span class="line"><span class="string">hog</span>                    <span class="number">12386</span>  <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">kernel:NMI watchdog: BUG:</span> <span class="string">soft</span> <span class="string">lockup</span> <span class="bullet">-</span> <span class="string">CPU#0</span> <span class="string">stuck</span> <span class="string">for</span> <span class="string">23s!</span> [<span class="string">hog:2308</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">NMI watchdog: BUG:</span> <span class="string">soft</span> <span class="string">lockup</span> <span class="bullet">-</span> <span class="string">CPU#0</span> <span class="string">stuck</span> <span class="string">for</span> <span class="string">23s!</span> [<span class="string">hog:2308</span>]</span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Modules linked in:</span> <span class="string">hog(OE)</span> <span class="string">dell_rbu</span> <span class="string">dcdbas</span> <span class="string">sunrpc</span> <span class="string">nfit</span> <span class="string">libnvdimm</span> <span class="string">zfs(POE)</span> <span class="string">zunicode(POE)</span> <span class="string">zavl(POE)</span> <span class="string">icp(POE)</span> <span class="string">ppdev</span> <span class="string">iosf_mbi</span> <span class="string">crc32_pclmul</span> <span class="string">ghash_clmulni_intel</span> <span class="string">joydev</span> <span class="string">zcommon(POE)</span> <span class="string">znvpair(POE)</span> <span class="string">spl(OE)</span> <span class="string">sg</span> <span class="string">aesni_intel</span> <span class="string">virtio_balloon</span> <span class="string">virtio_rng</span> <span class="string">lrw</span> <span class="string">gf128mul</span> <span class="string">glue_helper</span> <span class="string">ablk_helper</span> <span class="string">cryptd</span> <span class="string">pcspkr</span> <span class="string">i2c_piix4</span> <span class="string">parport_pc</span> <span class="string">parport</span> <span class="string">binfmt_misc</span> <span class="string">ip_tables</span> <span class="string">xfs</span> <span class="string">libcrc32c</span> <span class="string">sr_mod</span> <span class="string">sd_mod</span> <span class="string">cdrom</span> <span class="string">crc_t10dif</span> <span class="string">crct10dif_generic</span> <span class="string">ata_generic</span> <span class="string">pata_acpi</span> <span class="string">virtio_console</span> <span class="string">virtio_net</span> <span class="string">virtio_blk</span> <span class="string">virtio_scsi</span> <span class="string">qxl</span> <span class="string">drm_kms_helper</span> <span class="string">syscopyarea</span> <span class="string">sysfillrect</span> <span class="string">sysimgblt</span> <span class="string">fb_sys_fops</span> <span class="string">ttm</span> <span class="string">drm</span> <span class="string">crct10dif_pclmul</span> <span class="string">crct10dif_common</span> <span class="string">crc32c_intel</span> <span class="string">ata_piix</span> <span class="string">ahci</span> <span class="string">libahci</span> <span class="string">libata</span> <span class="string">serio_raw</span> <span class="string">virtio_pci</span> <span class="string">virtio_ring</span> <span class="string">virtio</span> <span class="string">floppy</span> <span class="string">drm_panel_orientation_quirks</span> <span class="string">dm_mirror</span> <span class="string">dm_region_hash</span> <span class="string">dm_log</span> <span class="string">dm_mod</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CPU: 0 PID: 2308 Comm: hog Kdump: loaded Tainted:</span> <span class="string">P</span>           <span class="string">OE</span>  <span class="string">------------</span>   <span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span><span class="string">.el7.x86_64</span> <span class="comment">#1</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Hardware name:</span> <span class="string">Red</span> <span class="string">Hat</span> <span class="string">KVM,</span> <span class="string">BIOS</span> <span class="number">1.11</span><span class="number">.1</span><span class="number">-4.</span><span class="string">module_el8.0.0+189+f9babebb</span> <span class="number">04</span><span class="string">/01/2014</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">task: ffff9c0335878000 ti: ffff9c03356a4000 task.ti:</span> <span class="string">ffff9c03356a4000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RIP:</span> <span class="number">0010</span><span class="string">:[&lt;ffffffffc0721017&gt;]</span>  [<span class="string">&lt;ffffffffc0721017&gt;</span>] <span class="string">hog_thread+0x17/0x1000</span> [<span class="string">hog</span>]</span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RSP: 0018:ffff9c03356a7ec0  EFLAGS:</span> <span class="number">00000246</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RAX: 0000000000000011 RBX: ffff9c03356a7e50 RCX:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RDX: 0000000000000000 RSI: ffff9c033dc13898 RDI:</span> <span class="string">ffff9c033dc13898</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RBP: ffff9c03356a7ec0 R08: 0000000000000000 R09:</span> <span class="number">0000000000000040</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">R10: 000000000000029a R11: 0000000000aaaaaa R12:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">R13: ffffffffc0721000 R14: 0000000000000000 R15:</span> <span class="string">ffff9c03352ebc90</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">FS:</span>  <span class="number">0000000000000000</span><span class="string">(0000)</span> <span class="string">GS:ffff9c033dc00000(0000)</span> <span class="string">knlGS:0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CS:  0010 DS: 0000 ES: 0000 CR0:</span> <span class="number">0000000080050033</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CR2: 0000561560589e20 CR3: 0000000006010000 CR4:</span> <span class="string">00000000003606f0</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">DR0: 0000000000000000 DR1: 0000000000000000 DR2:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7:</span> <span class="number">0000000000000400</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Call Trace:</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c50d1&gt;</span>] <span class="string">kthread+0xd1/0xe0</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c5000&gt;</span>] <span class="string">?</span> <span class="string">insert_kthread_work+0x40/0x40</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa0f8cd37&gt;</span>] <span class="string">ret_from_fork_nospec_begin+0x21/0x21</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c5000&gt;</span>] <span class="string">?</span> <span class="string">insert_kthread_work+0x40/0x40</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Code:</span> <span class="string">&lt;eb&gt;</span> <span class="string">fe</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p>Enable nmi_watchdog=1 in kernel</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat hard.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"> </span><br><span class="line">static int</span><br><span class="line">hog_thread(void *data)</span><br><span class="line">&#123;</span><br><span class="line">    static DEFINE_SPINLOCK(lock);</span><br><span class="line">    unsigned long flags;</span><br><span class="line"> </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hogging a CPU now\n&quot;</span>);</span><br><span class="line">    spin_lock_irqsave(<span class="variable">&amp;lock</span>, flags);</span><br><span class="line">    while (<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* unreached */</span></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static int __init</span><br><span class="line">hog_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    kthread_run(hog_thread, NULL, <span class="string">&quot;hog&quot;</span>);</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hog_init);</span><br><span class="line"></span><br><span class="line">obj-m += hard.o</span><br><span class="line"></span><br><span class="line"><span class="symbol">all:</span> make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) modules</span><br><span class="line"><span class="symbol">clean:</span> make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) clean</span><br><span class="line"></span><br><span class="line">$  make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) modules</span><br><span class="line"><span class="symbol">make:</span> Entering directory `<span class="meta-keyword">/usr/</span>src<span class="meta-keyword">/kernels/</span><span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span>.el7.x86_64&#x27;</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>hardhog/hard.o</span><br><span class="line">  Building modules, stage <span class="number">2.</span></span><br><span class="line">  MODPOST <span class="number">1</span> modules</span><br><span class="line">  CC      <span class="meta-keyword">/root/</span>hardhog/hard.mod.o</span><br><span class="line">  LD [M]  <span class="meta-keyword">/root/</span>hardhog/hard.ko</span><br><span class="line"></span><br><span class="line">$ insmod hard.ko</span><br><span class="line"></span><br><span class="line"><span class="meta"># after insmod, the KVM ssh not respond too.</span></span><br></pre></td></tr></table></figure><p><a href="https://kernelnewbies.org/FAQ/FastpathAndSlowpath">In general</a>, “fast path” is the commonly run code that should finish very quickly. For example, when it comes to spinlocks the fast path is that nobody is holding the spinlock and the CPU that wants it can just take it.<br>Conversely, the slow path for spinlocks is that the lock is already taken by somebody else and the CPU will have to wait for the lock to be freed.<br>The first case is the common one that should be optimized.<br>The second one is not as important and does not need to be optimized much at all.</p><h3 id="cgroup-limit-resource"><a href="#cgroup-limit-resource" class="headerlink" title="cgroup limit resource"></a>cgroup limit resource</h3><p>command line mode</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /sys/fs/cgroup/memory/</span><br><span class="line">$ mkdir <span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">cd</span> /sys/fs/cgroup/memory/<span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">echo</span> 5M &gt; memory.limit_in_bytes</span><br><span class="line">$ <span class="built_in">echo</span> $$ &gt;&gt; cgroup.procs <span class="comment">## add local bash </span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; memory.swappiness</span><br><span class="line"></span><br><span class="line">$ cat memory.oom_control</span><br><span class="line"><span class="comment"># disable oom</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt;&gt; memory.oom_control<span class="string">&quot;</span></span><br></pre></td></tr></table></figure><p>limit memory size</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cgcreate -g memory:DBLimitedGroup</span><br><span class="line">$ <span class="built_in">echo</span> 16G &gt; /sys/fs/cgroup/memory/DBLimitedGroup/memory.limit_in_bytes</span><br><span class="line">$ sync; <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ cgclassify -g memory:DBLimitedGroup $(pid)</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=<span class="string">&quot;test&quot;</span></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/<span class="built_in">test</span>/<span class="built_in">test</span> 1234</span><br><span class="line">MemoryAccounting=<span class="literal">true</span></span><br><span class="line">MemoryHigh=1024K</span><br><span class="line">MemoryMax=4096K</span><br></pre></td></tr></table></figure><h3 id="About-WB-SYNC-NONE-and-WB-SYNC-ALL"><a href="#About-WB-SYNC-NONE-and-WB-SYNC-ALL" class="headerlink" title="About WB_SYNC_NONE and WB_SYNC_ALL"></a>About WB_SYNC_NONE and WB_SYNC_ALL</h3><p><a href="https://elixir.bootlin.com/linux/v3.10.108/source/fs/fs-writeback.c#L140">https://elixir.bootlin.com/linux/v3.10.108/source/fs/fs-writeback.c#L140</a><br>/**</p><ul><li>bdi_start_writeback - start writeback</li><li>@bdi: the backing device to write from</li><li>@nr_pages: the number of pages to write</li><li>@reason: reason why some writeback work was initiated</li><li></li><li>Description:</li><li>This does WB_SYNC_NONE opportunistic writeback. The IO is only</li><li>started when this function returns, we make no guarantees on</li><li>completion. Caller need not hold sb s_umount semaphore.</li><li></li><li>/</li></ul><p><a href="https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/writeback.h#L34">https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/writeback.h#L34</a></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">writeback_sync_modes</span> &#123;</span></span><br><span class="line">WB_SYNC_NONE,<span class="regexp">/* Don&#x27;t wait on anything */</span></span><br><span class="line">WB_SYNC_ALL,<span class="regexp">/* Wait on every mapping */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><h4 id="ldd"><a href="#ldd" class="headerlink" title="ldd"></a>ldd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ldd /bin/ls</span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007fff59353000)</span><br><span class="line">libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007fa12b999000)</span><br><span class="line">libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007fa12b794000)</span><br><span class="line">libacl.so.1 =&gt; /lib64/libacl.so.1 (0x00007fa12b58b000)</span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fa12b1bd000)</span><br><span class="line">libpcre.so.1 =&gt; /lib64/libpcre.so.1 (0x00007fa12af5b000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007fa12ad57000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007fa12bbc0000)</span><br><span class="line">libattr.so.1 =&gt; /lib64/libattr.so.1 (0x00007fa12ab52000)</span><br><span class="line">libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fa12a936000)</span><br></pre></td></tr></table></figure><h4 id="Read-ELF-Executable-and-Linking-Format"><a href="#Read-ELF-Executable-and-Linking-Format" class="headerlink" title="Read ELF(Executable and Linking Format)"></a>Read ELF(Executable and Linking Format)</h4><p>Relocatable file (eg: xx.o)<br>Executable file<br>Dynamic Linking Library (eg: xx.so)<br>Static Linking Library  (eg: xx.a)</p><p>ELF Header<br>ELF Program Header Table/Program Headers<br>ELF Section Header Table/Section Headers<br>ELF Sections<br>multiple sections merge to a segment</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -h /bin/ls</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              EXEC (Executable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x404324</span></span><br><span class="line"><span class="string">  Start of program headers:          64 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          115688 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           56 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         9</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         30</span></span><br><span class="line"><span class="string">  Section header string table index: 29</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$  readelf -S /bin/ls | grep debug</span></span><br><span class="line"><span class="string">  [27] .gnu_debuglink    PROGBITS         0000000000000000  0001b600</span></span><br><span class="line"><span class="string">  [28] .gnu_debugdata    PROGBITS         0000000000000000  0001b610 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf -all /bin/ls</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure><h4 id="objdump"><a href="#objdump" class="headerlink" title="objdump"></a>objdump</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -i </span><br><span class="line"><span class="comment"># Display a list showing all architectures and object formats available for specification with -b or -m.</span></span><br><span class="line">...</span><br><span class="line">$ gcc -O2 -ggdb3 -c -o sort.o sort.c</span><br><span class="line">$ objdump -d sort.o</span><br><span class="line"><span class="comment">#Display the assembler mnemonics for the machine instructions from objfile</span></span><br><span class="line"></span><br><span class="line">sort.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;sort&gt;:</span><br><span class="line">   0:31 c0                xor    %eax,%eax</span><br><span class="line">   2:b9 01 00 00 00       mov    <span class="variable">$0x1</span>,%ecx</span><br><span class="line">   7:83 f8 1e             cmp    <span class="variable">$0x1e</span>,%eax</span><br><span class="line">   a:7e 0b                jle    17 &lt;sort+0x17&gt;</span><br><span class="line">   c:84 c9                <span class="built_in">test</span>   %cl,%cl</span><br><span class="line">   e:75 36                jne    46 &lt;sort+0x46&gt;</span><br><span class="line">  10:b9 01 00 00 00       mov    <span class="variable">$0x1</span>,%ecx</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ objdump -t sort.o</span><br><span class="line"><span class="comment"># Print the symbol table entries of the file</span></span><br><span class="line"></span><br><span class="line">sort.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line">0000000000000000 l    df *ABS*0000000000000000 sort.c</span><br><span class="line">0000000000000000 l    d  .text0000000000000000 .text</span><br><span class="line">0000000000000000 l    d  .data0000000000000000 .data</span><br><span class="line">0000000000000000 l    d  .bss0000000000000000 .bss</span><br><span class="line">0000000000000000 l    d  .rodata.str1.10000000000000000 .rodata.str1.1</span><br><span class="line">0000000000000000 l    d  .text.startup0000000000000000 .text.startup</span><br><span class="line">0000000000000000 l    d  .debug_info0000000000000000 .debug_info</span><br><span class="line">0000000000000000 l    d  .debug_abbrev0000000000000000 .debug_abbrev</span><br><span class="line">0000000000000000 l    d  .debug_loc0000000000000000 .debug_loc</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="nm"><a href="#nm" class="headerlink" title="nm"></a>nm</h4><p>list symbols from object files</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ nm ./walk</span><br><span class="line">                 U <span class="symbol">atoi@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a4 B __bss_start</span><br><span class="line">                 U <span class="symbol">closedir@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a8 b completed<span class="number">.6355</span></span><br><span class="line"><span class="number">00000000006020</span>a0 D __data_start</span><br><span class="line"><span class="number">00000000006020</span>a0 W data_start</span><br><span class="line"><span class="number">0000000000400880</span> t deregister_tm_clones</span><br><span class="line"><span class="number">00000000004008f</span>0 t __do_global_dtors_aux</span><br><span class="line"><span class="number">0000000000601e18</span> t __do_global_dtors_aux_fini_array_entry</span><br><span class="line"><span class="number">0000000000400</span>d18 R __dso_handle</span><br><span class="line"></span><br><span class="line">$ nm -e ./walk</span><br><span class="line">                 U <span class="symbol">atoi@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a4 B __bss_start</span><br><span class="line">                 U <span class="symbol">closedir@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a8 b completed<span class="number">.6355</span></span><br><span class="line"><span class="number">00000000006020</span>a0 D __data_start</span><br><span class="line"><span class="number">00000000006020</span>a0 W data_start</span><br><span class="line"><span class="number">0000000000400880</span> t deregister_tm_clones</span><br><span class="line"><span class="number">00000000004008f</span>0 t __do_global_dtors_aux</span><br><span class="line"><span class="number">0000000000601e18</span> t __do_global_dtors_aux_fini_array_entry</span><br><span class="line"><span class="number">0000000000400</span>d18 R __dso_handle</span><br></pre></td></tr></table></figure><p>kernel symbol table</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$  grep CONFIG_KALLSYMS /boot/config<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1062.18</span><span class="number">.1</span>.el7.x86_64</span><br><span class="line">CONFIG_KALLSYMS=y</span><br><span class="line">CONFIG_KALLSYMS_ALL=y</span><br><span class="line"></span><br><span class="line">$ grep <span class="string">&quot; tcp_v4_do_rcv&quot;</span>  /<span class="keyword">proc</span>/kallsyms</span><br><span class="line">ffffffff936c0c70<span class="title"> T</span> tcp_v4_do_rcv</span><br><span class="line">##<span class="title"> Why</span> addr<span class="title"> is</span> change ?</span><br><span class="line"></span><br><span class="line">$<span class="title"> grep</span> CONFIG_RANDOMIZE_BASE /boot/config-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">CONFIG_RANDOMIZE_BASE=y</span><br><span class="line"></span><br><span class="line">##<span class="title"> ALL</span> info,<span class="title"> the</span> compiler<span class="title"> optimize</span> cause<span class="title"> some</span> symbols<span class="title"> missing</span> in<span class="title"> kallsyms</span></span><br><span class="line"><span class="title">$</span> grep &quot;<span class="title"> tcp_v4_do_rcv&quot;</span>  /boot/System.map-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">ffffffff816c0c70<span class="title"> T</span> tcp_v4_do_rcv</span><br></pre></td></tr></table></figure><p>uppercase: global(external) symbol<br>lowercase: local symbol<br>T The symbol is in the text(code) section<br>D The symbol is in the initialized data section<br>R The sysbol is in a read only data section<br>t static<br>d static<br>R const<br>r static const</p><h4 id="size"><a href="#size" class="headerlink" title="size"></a>size</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">size add_lock</span><br><span class="line">   text   data    bss    dec    hexfilename</span><br><span class="line">   5008    660      4   5672   1628add_lock</span><br></pre></td></tr></table></figure><p>代码段： 只读，可共享; 代码段（code segment/text segment ）通常是指用来存放程序执行代码的一块内存区域。这部分区域的大小在程序运行前就已经确定，并且内存区域通常属于只读, 某些架构也允许代码段为可写，即允许修改程序。在代码段中，也有可能包含一些只读的常数变量，例如字符串常量等。<br>数据段： 储存已被初始化了的静态数据。数据段（data segment ）通常是指用来存放程序中已初始化的全局变量的一块内存区域。数据段属于静态内存分配。<br>BSS 段：未初始化的数据段. BSS 段（bss segment ）通常是指用来存放程序中未初始化的全局变量的一块内存区域。BSS 是英文Block Started by Symbol 的简称。BSS 段属于静态内存分配。<br>堆（heap ）：low to high, 堆是用于存放进程运行中被动态分配的内存段，它的大小并不固定，可动态扩张或缩减。当进程调用malloc 等函数分配内存时，新分配的内存就被动态添加到堆上（堆被扩张）；当利用free 等函数释放内存时，被释放的内存从堆中被剔除（堆被缩减）<br>栈(stack) ： high to low, 栈又称堆栈，是用户存放程序临时创建的局部变量，也就是说我们函数括弧“{} ”中定义的变量（但不包括static 声明的变量，static 意味着在数据段中存放变量）。除此以外，在函数被调用时，其参数也会被压入发起调用的进程栈中，并且待到调用结束后，函数的返回值也会被存放回栈中。由于栈的先进先出特点，所以栈特别方便用来保存/ 恢复调用现场。从这个意义上讲，我们可以把堆栈看成一个寄存、交换临时数据的内存区。<br>另外, 在高地址还储存了命令行参数及环境变量.</p><p>The heap is, generally speaking, one specific memory region created by the C runtime, and managed by malloc (which in turn uses the brk and sbrk system calls to grow and shrink).<br>mmap is a way of creating new memory regions, independently of malloc (and so independently of the heap). munmap is simply its inverse, it releases these regions.<br>Some picture show mmap high addr to low addr, same direction with stack</p><h3 id="process-schduler"><a href="#process-schduler" class="headerlink" title="process schduler"></a>process schduler</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ chrt -p <span class="variable">$pid</span></span><br><span class="line">$ chrt -m</span><br><span class="line">$ chrt [-b/-f/-o/-r/-i/-d] -p <span class="variable">$priority</span> <span class="variable">$pid</span></span><br><span class="line">-b SCHED_BATCH</span><br><span class="line">-f SCHED_FIFO</span><br><span class="line">-o SCHED_OTHER</span><br><span class="line">-r SCHED_RR</span><br><span class="line">-i SCHED_IDLE</span><br><span class="line">-d SCHED_DEADLINE</span><br></pre></td></tr></table></figure><h3 id="vim-jump-cursor"><a href="#vim-jump-cursor" class="headerlink" title="vim jump cursor"></a>vim jump cursor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:cal cursor(30, 5)</span><br></pre></td></tr></table></figure><h3 id="gpart-recovery-partition-table"><a href="#gpart-recovery-partition-table" class="headerlink" title="gpart recovery partition table"></a>gpart recovery partition table</h3><p>boot by freebsd livecd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gpart disk list</span><br><span class="line">$ gpart recover /dev/sda</span><br></pre></td></tr></table></figure><h3 id="ffmpeg"><a href="#ffmpeg" class="headerlink" title="ffmpeg"></a>ffmpeg</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ffmpeg -i twiz-1080p.mkv -s 1280x720 -vcodec libx264 -crf 24 twiz-720p.mkv</span><br></pre></td></tr></table></figure><h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><p><a href="https://serverfault.com/questions/763582/how-to-configure-iptables-so-an-unwanted-port-is-not-reported-as-filtered">let namp show filter, you could pretend 22 is the ssh port :) </a><br>change the ssh default port and set </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j drop</span><br><span class="line"></span><br><span class="line"><span class="comment"># Don&#x27;t use DROP, that&#x27;s easily identified as &quot;filtered&quot; if you know the box is up. Instead, you may use the following to send a RST. (as if there is a service listening, but it doesn&#x27;t accept connections from you)</span></span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j REJECT --reject-with tcp-reset</span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j REJECT</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run &#x27;chmod +x /etc/rc.d/rc.local&#x27; to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reset to a sane state, even if just temporarily</span></span><br><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># Erase all the rules</span></span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables --delete-chain</span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables -t nat -X</span><br><span class="line"></span><br><span class="line">nic=ems3</span><br><span class="line"><span class="comment"># disable icmp</span></span><br><span class="line"><span class="comment">#iptables -A INPUT  -p icmp --icmp-type echo-request -j DROP</span></span><br><span class="line"><span class="comment">#iptables -A OUTPUT -p icmp --icmp-type echo-reply -j DROP</span></span><br><span class="line">iptables -A INPUT -p icmp --icmp-type any -j DROP</span><br><span class="line">iptables -A OUTPUT -p icmp -j DROP</span><br><span class="line"></span><br><span class="line">iptables -A INPUT -m state --state INVALID -j LOG --log-prefix <span class="string">&quot;DROP INVALID &quot;</span> --log-ip-options --log-tcp-options</span><br><span class="line">iptables -A INPUT -m state --state INVALID -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">## same with iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP</span></span><br><span class="line"><span class="comment"># Log attack</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; Null scan &quot;</span></span><br><span class="line"><span class="comment"># Drop and blacklist for 60 seconds IP of attacker</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL NONE  -m recent --name blacklist_60 --<span class="built_in">set</span> -m comment --comment <span class="string">&quot;Drop/Blacklist Null scan&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">## nmap -sX 192.168.0.2</span></span><br><span class="line"><span class="comment"># Log attacks</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; XMAS scan &quot;</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; XMAS-PSH scan &quot;</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; XMAS-ALL scan &quot;</span></span><br><span class="line"><span class="comment"># Drop and blacklist for 60 seconds IP of attacker</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist Xmas/PSH scan&quot;</span> -j DROP <span class="comment"># Xmas-PSH scan</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN,PSH,URG -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist Xmas scan&quot;</span> -j DROP <span class="comment"># Against nmap -sX (Xmas tree scan)</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL ALL -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist Xmas/All scan&quot;</span> -j DROP <span class="comment"># Xmas All scan</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### fin scan nmap -sF 192.168.0.2</span></span><br><span class="line"><span class="comment">#Log attack</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt; FIN scan &quot;</span></span><br><span class="line"><span class="comment"># Drop and blacklist for 60 seconds IP of attacker</span></span><br><span class="line">iptables -A INPUT -p tcp --tcp-flags ALL FIN -m recent --name blacklist_60 --<span class="built_in">set</span>  -m comment --comment <span class="string">&quot;Drop/Blacklist FIN scan&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">###ACK scan nmap -sA 192.168.0.2</span></span><br><span class="line">iptables   -A INPUT -p tcp ! --syn -m state --state NEW  -m comment --comment <span class="string">&quot;Drop TCP connection not starting by SYN&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">### SYN scan and TCP connect scan, nmap -sS 192.168.0.2, nmap -sT 192.168.0.2</span></span><br><span class="line"><span class="comment"># log  probable sS and full connect tcp scan</span></span><br><span class="line">iptables -A INPUT -p tcp  -m multiport --dports 23,79 --tcp-flags ALL SYN -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 3/m --limit-burst 5 -j LOG --log-prefix <span class="string">&quot;Firewall&gt;SYN scan trap:&quot;</span></span><br><span class="line"><span class="comment"># blacklist for three minuts</span></span><br><span class="line">iptables -A  INPUT -p tcp  -m multiport --dports 23,79 --tcp-flags ALL SYN -m recent --name blacklist_180 --<span class="built_in">set</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">### UDP scan</span></span><br><span class="line">iptables -A INPUT -p udp  -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 6/h --limit-burst 1 -m length --length 0:28 -j LOG --log-prefix <span class="string">&quot;Firewall&gt;0 length udp &quot;</span></span><br><span class="line">iptables -A INPUT -p udp -m length --length 0:28 -m comment --comment <span class="string">&quot;Drop UDP packet with no content&quot;</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># Simple NAT rule for outgoing traffic</span></span><br><span class="line"><span class="comment">#iptables -t nat -A POSTROUTING -o $nic -j MASQUERADE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># allow established connections</span></span><br><span class="line"><span class="comment"># iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow loopback</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow the return half of established connections</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># Allow incoming and outgoing ssh</span></span><br><span class="line"><span class="comment">####  from Foreign ssh to this, eg: ssh port is 10000</span></span><br><span class="line">iptables -A INPUT -p tcp  --sport 30000:65535 --dport 10000 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">####  from this node ssh to the others</span></span><br><span class="line">iptables -A OUTPUT -p tcp --sport 30000:65535 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#### vnc for 5901</span></span><br><span class="line">iptables -A INPUT -p tcp  --sport 30000:65535 --dport 5901 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#### ipmi web</span></span><br><span class="line">iptables -A OUTPUT -p tcp  --sport 30000:65535 --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p tcp  --sport 30000:65535 --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p tcp  --sport 30000:65535 --dport 5900 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># You probably want other stuff permitted here such as DNS on 53/udp and 53/tcp</span></span><br><span class="line"><span class="comment"># and maybe NTP on 123/udp</span></span><br><span class="line"><span class="comment"># iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT</span></span><br><span class="line"><span class="comment"># iptables -A OUTPUT -p udp --dport 123 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default policy is to discard all traffic</span></span><br><span class="line">iptables -P INPUT  DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">systemctl start fail2ban.service</span><br><span class="line"></span><br><span class="line">--------------------------------------------</span><br><span class="line"><span class="comment">### block-scan </span></span><br><span class="line">iptables -N block-scan</span><br><span class="line">iptables -A block-scan -p tcp —tcp-flags SYN,ACK,FIN,RST RST -m <span class="built_in">limit</span> —<span class="built_in">limit</span> 1/s -j RETURN</span><br><span class="line">iptables -A block-scan -j DROP</span><br><span class="line"><span class="comment">### reset tcp</span></span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 2049 -j REJECT --reject-with tcp-reset</span><br></pre></td></tr></table></figure><p>[defeating Nmap OS-Fingerprinting]<a href="https://nmap.org/misc/defeat-nmap-osdetect.html">https://nmap.org/misc/defeat-nmap-osdetect.html</a>)<br><a href="https://linuxhint.com/traceroute_nmap/">nmap traceroute</a><br><a href="http://blog.sevagas.com/?Iptables-firewall-versus-nmap-and,31">iptabls vs namp</a></p><h4 id="fail2ban"><a href="#fail2ban" class="headerlink" title="fail2ban"></a>fail2ban</h4><p>Default firewalld policy maybe will conflicte with my iptables policy, disable firewalld and reset the policy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y fail2ban</span><br><span class="line">$ cat /etc/fail2ban/jail.local</span><br><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># Ban hosts for one hour:</span></span><br><span class="line">bantime = 900</span><br><span class="line">ignoreip = 127.0.0.1/8</span><br><span class="line">maxretry = 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Override /etc/fail2ban/jail.d/00-firewalld.conf:</span></span><br><span class="line"><span class="comment"># banaction = iptables-multiport</span></span><br><span class="line">banaction = iptables</span><br><span class="line"></span><br><span class="line">[sshd]</span><br><span class="line">port    = 10000</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">logpath = /var/<span class="built_in">log</span>/fail2ban.log</span><br><span class="line">filter    = sshd</span><br><span class="line"></span><br><span class="line">$ sudo fail2ban-client status sshd</span><br><span class="line">Status <span class="keyword">for</span> the jail: sshd</span><br><span class="line">|- Filter</span><br><span class="line">|  |- Currently failed:0</span><br><span class="line">|  |- Total failed:7</span><br><span class="line">|  `- Journal matches:_SYSTEMD_UNIT=sshd.service + _COMM=sshd</span><br><span class="line">`- Actions</span><br><span class="line">   |- Currently banned:1</span><br><span class="line">   |- Total banned:1</span><br><span class="line">   `- Banned IP list:192.168.1.10</span><br><span class="line"></span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/fail2ban.log</span><br><span class="line">2021-01-22 10:42:38,088 fail2ban.actions        [1191]: INFO      banTime: 600</span><br><span class="line">2021-01-22 10:42:38,091 fail2ban.jail           [1191]: INFO    Jail <span class="string">&#x27;sshd&#x27;</span> started</span><br><span class="line">2021-01-22 10:43:27,767 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:57</span><br><span class="line">2021-01-22 10:43:27,768 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:58</span><br><span class="line">2021-01-22 10:43:27,768 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:58</span><br><span class="line">2021-01-22 10:43:27,769 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:42:59</span><br><span class="line">2021-01-22 10:43:27,769 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:43:00</span><br><span class="line">2021-01-22 10:43:27,770 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:43:02</span><br><span class="line">2021-01-22 10:43:27,770 fail2ban.filter         [1191]: INFO    [sshd] Found 192.168.1.10 - 2021-01-22 10:43:02</span><br><span class="line">2021-01-22 10:43:28,158 fail2ban.actions        [1191]: NOTICE  [sshd] Ban 192.168.1.10</span><br></pre></td></tr></table></figure><h4 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ lsof </span><br><span class="line">COMMAND    PID   USER   FD   TYPE        DEVICE SIZE/OFF      NODE NAME</span><br><span class="line"><span class="built_in">sched</span>        0   root  cwd   VDIR         136,8     1024         2 /</span><br><span class="line">init         1   root  cwd   VDIR         136,8     1024         2 /</span><br><span class="line">init         1   root  txt   VREG         136,8    49016      1655 /sbin/init</span><br><span class="line">init         1   root  txt   VREG         136,8    51084      3185 /lib/libuutil.so.1</span><br><span class="line">vi        2013   root    3u  VREG         136,8        0      8501 /var/tmp/ExXDaO7d</span><br><span class="line"></span><br><span class="line"><span class="comment"># show the unix socket info</span></span><br><span class="line">$ lsof -aUc sshd</span><br><span class="line">COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF   NODE NAME</span><br><span class="line">sshd     3199 root    1u  unix 0xffff8a8b39f96a40      0t0  43211 socket</span><br><span class="line">sshd     3199 root    2u  unix 0xffff8a8b39f96a40      0t0  43211 socket</span><br><span class="line">sshd    33510 root    4u  unix 0xffff8a7be8dac400      0t0 283548 socket</span><br><span class="line">sshd    78493 root    4u  unix 0xffff8a8b3a24d940      0t0 443790 socket</span><br><span class="line"></span><br><span class="line">$ ss -xp</span><br><span class="line"> ss -xp | grep sshd</span><br><span class="line">u_str  ESTAB      0      0       * 43211                 * 18675                 users:((<span class="string">&quot;sshd&quot;</span>,pid=3199,fd=2),(<span class="string">&quot;sshd&quot;</span>,pid=3199,fd=1))</span><br></pre></td></tr></table></figure><p><a href="https://unix.stackexchange.com/questions/16300/whos-got-the-other-end-of-this-unix-socketpair">example to debug</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lsof | grep whatever</span></span><br><span class="line">mysqld 14450 (...) unix 0xffff8801011e9600 (...) /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb /usr/lib/debug/boot/vmlinux-3.2.0-4-amd64 /proc/kcore</span></span><br><span class="line">(gdb) <span class="built_in">print</span> ((struct unix_sock*)0xffff8801011e9600)-&gt;peer</span><br><span class="line"><span class="variable">$1</span> = (struct sock *) 0xffff880171f078c0</span><br><span class="line"></span><br><span class="line"><span class="comment"># lsof | grep 0xffff880171f078c0</span></span><br><span class="line">mysql 14815 (...) unix 0xffff880171f078c0 (...) socket</span><br></pre></td></tr></table></figure><h3 id="Process-accounting-on-Linux"><a href="#Process-accounting-on-Linux" class="headerlink" title="Process accounting on Linux"></a><a href="https://www.networkworld.com/article/3571465/managing-process-accounting-on-linux.html">Process accounting on Linux</a></h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/accton <span class="keyword">on</span></span><br><span class="line">Turning <span class="keyword">on</span> process accounting, <span class="keyword">file</span> <span class="keyword">set</span> to the default &#x27;/<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct&#x27;.</span><br><span class="line">dump-acct /<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct | tail</span><br><span class="line">echo <span class="string">&quot;Command         vers  runtime   systime   elapsed    UID    GID   mem_use     chars      PID     PPID  ?    retcode  term     date/time&quot;</span> &quot;</span><br><span class="line">sudo dump-acct /<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct | tail -5</span><br><span class="line">dump-acct /<span class="keyword">var</span>/<span class="keyword">log</span>/account/pacct | awk -F&#x27;|&#x27; &#x27;<span class="variable">$6</span> ~ / 1000$/&#x27;</span><br><span class="line"><span class="keyword">ls</span> -ltr /<span class="keyword">var</span>/<span class="keyword">log</span>/account | tail -6</span><br><span class="line">/usr/sbin/accton off</span><br></pre></td></tr></table></figure><p><a href="https://developer.ibm.com/articles/au-lsof/">The Device, SIZE/OFF, Node, and Name columns refer to the file itself, specifying the name of the disk, size of the file, inode (the file’s identification on the disk)</a></p><h3 id="Partition-table-loss"><a href="#Partition-table-loss" class="headerlink" title="Partition table loss"></a>Partition table loss</h3><p>First xfs file system no partition table, it ‘s direct use by /dev/vdx<br>Some guy add the partition by ?? parted ?? after the machine reboot, the parted only show xfs and no parttion<br>but gdisk show the gpt partition, the udev show the vdb1</p><h4 id="By-mount-offset"><a href="#By-mount-offset" class="headerlink" title="By mount offset"></a>By mount offset</h4><p>When the partition table not show, the partition message not damaged, because some XFS metadata ahead of the GPT partition info cause the partition not be probed, I use offset avoid the partition identify failed</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ parted /dev/sdg <span class="string">&quot;unit s print&quot;</span></span><br><span class="line">Model: QEMU QEMU HARDDISK (scsi)</span><br><span class="line">Disk /dev/sdg: 31251759104s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start  End          Size         File system  Name  Flags</span><br><span class="line"> 1      2048s  7812499455s  7812497408s  ext4</span><br><span class="line"></span><br><span class="line">$ mkfs.ext4 /dev/sdg1</span><br><span class="line">mke2fs 1.45.2.wc1 (27-May-2019)</span><br><span class="line">/dev/sdg1 contains a ext4 file system</span><br><span class="line">created on Fri Feb  5 20:59:59 2021</span><br><span class="line">Proceed anyway? (y,N) y</span><br><span class="line">Suggestion: Use Linux kernel &gt;= 3.18 <span class="keyword">for</span> improved stability of the metadata and journal checksum features.</span><br><span class="line">Discarding device blocks: <span class="keyword">done</span></span><br><span class="line">Creating filesystem with 976562176 4k blocks and 244146176 inodes</span><br><span class="line">Filesystem UUID: a7a95474-5c9c-4f2d-8c57-fe95e7c20d17</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span><br><span class="line">4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968,</span><br><span class="line">102400000, 214990848, 512000000, 550731776, 644972544</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span></span><br><span class="line">Writing inode tables: <span class="keyword">done</span></span><br><span class="line">Creating journal (262144 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ mount /dev/sdg1 /mnt</span><br><span class="line">$ df -h /mnt</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdg1       3.6T   89M  3.4T   1% /mnt</span><br><span class="line"></span><br><span class="line">$ umount /mnt</span><br><span class="line">$ parted /dev/sdg rm 1</span><br><span class="line">Information: You may need to update /etc/fstab.</span><br><span class="line"></span><br><span class="line">$ parted /dev/sdg p</span><br><span class="line">Model: QEMU QEMU HARDDISK (scsi)</span><br><span class="line">Disk /dev/sdg: 16.0TB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start  End  Size  File system  Name  Flags</span><br><span class="line"><span class="comment">## the partition is gone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x38  __le16  s_magic  Magic signature, 0xEF53</span></span><br><span class="line"></span><br><span class="line">$ hexdump -C /dev/sdg  | head -n 4000 | grep <span class="string">&quot;53 ef&quot;</span></span><br><span class="line">00100430  bd 78 1d 60 01 00 ff ff  53 ef 01 00 01 00 00 00  |.x.`....S.......|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 0x100000 = 1048576 bytes = 2048s</span></span><br><span class="line"><span class="comment">### 0x430 + 8 bytes (hexdump) = 0x438 = 0x400 (1024 bytes ext4 pading) + 0x38 (ext4 superblock offset Magic signature, 0xEF53)</span></span><br><span class="line">$ <span class="built_in">echo</span> $(($((<span class="number">16#100438</span>))-$((<span class="number">16#438</span>))))</span><br><span class="line"></span><br><span class="line">$ mount /dev/sdg /mnt -o offset=1048576</span><br><span class="line">$ df -hT /mnt</span><br><span class="line">Filesystem     Type  Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/loop0     ext4  3.6T   89M  3.4T   1% /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment">## check the align</span></span><br><span class="line">$ (parted) align-check optimal 1 </span><br></pre></td></tr></table></figure><h4 id="Recovery-the-partition-table-by-gdisk"><a href="#Recovery-the-partition-table-by-gdisk" class="headerlink" title="Recovery the partition table by gdisk"></a>Recovery the partition table by gdisk</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ $ parted /dev/vdb &#x27;unit s print&#x27;</span><br><span class="line">Model: Virtio Block Device (virtblk)</span><br><span class="line">Disk /dev/vdb: 8388874240s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: loop</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  <span class="keyword">Start</span>  <span class="keyword">End</span>          <span class="keyword">Size</span>         <span class="keyword">File</span> <span class="keyword">system</span>  Flags</span><br><span class="line"> <span class="number">1</span>      <span class="number">0</span>s     <span class="number">8388874239</span>s  <span class="number">8388874240</span>s  xfs</span><br><span class="line"></span><br><span class="line">$ ls -l /dev/sdg</span><br><span class="line">brw-rw<span class="comment">---- 1 root disk 8, 96 Feb  7 12:24 /dev/sdg</span></span><br><span class="line">$ ls -l /dev/sdg1</span><br><span class="line">ls: cannot <span class="keyword">access</span> /dev/sdg1: <span class="keyword">No</span> such <span class="keyword">file</span> <span class="keyword">or</span> <span class="keyword">directory</span></span><br><span class="line"></span><br><span class="line">Command (? <span class="keyword">for</span> <span class="keyword">help</span>): p</span><br><span class="line">Disk /dev/sdg: <span class="number">31251759104</span> sectors, <span class="number">14.6</span> TiB</span><br><span class="line"><span class="keyword">Logical</span> sector <span class="keyword">size</span>: <span class="number">512</span> <span class="keyword">bytes</span></span><br><span class="line">Disk identifier (GUID): F372D874-C734<span class="number">-49</span>A1-A634<span class="number">-87</span>DD80602FD9</span><br><span class="line"><span class="keyword">Partition</span> <span class="keyword">table</span> holds up <span class="keyword">to</span> <span class="number">128</span> entries</span><br><span class="line"><span class="keyword">First</span> <span class="keyword">usable</span> sector <span class="keyword">is</span> <span class="number">34</span>, <span class="keyword">last</span> <span class="keyword">usable</span> sector <span class="keyword">is</span> <span class="number">8388874206</span></span><br><span class="line"><span class="keyword">Partitions</span> will be aligned <span class="keyword">on</span> <span class="number">8</span>-sector boundaries</span><br><span class="line">Total free <span class="keyword">space</span> <span class="keyword">is</span> <span class="number">1919</span> sectors (<span class="number">959.5</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Number</span>  <span class="keyword">Start</span> (sector)    <span class="keyword">End</span> (sector)  <span class="keyword">Size</span>       Code  <span class="keyword">Name</span></span><br><span class="line">   <span class="number">1</span>              <span class="number">34</span>      <span class="number">8388872287</span>   <span class="number">3.9</span> TiB     <span class="number">0700</span>  primary</span><br><span class="line"></span><br><span class="line">Command (? <span class="keyword">for</span> <span class="keyword">help</span>): w</span><br><span class="line"><span class="keyword">Warning</span>! Secondary header <span class="keyword">is</span> placed too early <span class="keyword">on</span> the disk! <span class="keyword">Do</span> you want <span class="keyword">to</span></span><br><span class="line">correct this problem? (Y/N): Y</span><br><span class="line">Have moved <span class="keyword">second</span> header <span class="keyword">and</span> <span class="keyword">partition</span> <span class="keyword">table</span> <span class="keyword">to</span> correct location.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Final</span> checks complete. About <span class="keyword">to</span> write GPT data. THIS WILL OVERWRITE EXISTING</span><br><span class="line"><span class="keyword">PARTITIONS</span>!!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Do</span> you want <span class="keyword">to</span> proceed? (Y/N): Y</span><br><span class="line">OK; writing new GUID partition table (GPT) to /dev/sdg.</span><br><span class="line">The operation has completed successfully.</span><br><span class="line">$ ls -l /dev/sdg</span><br><span class="line">sdg   sdg1</span><br><span class="line">$ ls -l /dev/sdg1</span><br><span class="line">brw-rw<span class="comment">---- 1 root disk 8, 97 Feb  7 12:24 /dev/sdg1</span></span><br></pre></td></tr></table></figure><h4 id="backup-partition-table-by-sgdisk"><a href="#backup-partition-table-by-sgdisk" class="headerlink" title="backup partition table by sgdisk"></a>backup partition table by sgdisk</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sgdisk --backup=vdb_part_1 /dev/vdb</span><br><span class="line">$ sgdisk --load-backup=vdb_part_1 /dev/vdb</span><br></pre></td></tr></table></figure><h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modify pass</span></span><br><span class="line">$ git config --global --<span class="built_in">unset</span> user.password</span><br></pre></td></tr></table></figure><p><a href="https://stackoverflow.com/questions/35942754/how-to-save-username-and-password-in-git/51164322#51164322">Use token replace password</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ git add README.md</span><br><span class="line">$ git commit -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line">$ git remote add origin https://github.com/xxxx/xxxx.git</span><br><span class="line">$ git pull</span><br><span class="line">$ git push -u origin master </span><br><span class="line"></span><br><span class="line"><span class="comment">## got the token from the web</span></span><br><span class="line">$ git remote add tools https://<span class="variable">$&#123;username&#125;</span>:<span class="variable">$&#123;token_key&#125;</span>@github.com/xxxx/xxxx</span><br><span class="line">$ vi README.md</span><br><span class="line">$ git add --all</span><br><span class="line">$ git commit -m <span class="string">&quot;update readme&quot;</span></span><br><span class="line">$ git push tools master</span><br><span class="line"></span><br><span class="line"><span class="comment">## show repo</span></span><br><span class="line">$ git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment">## delete</span></span><br><span class="line">$ git remote rm tools</span><br></pre></td></tr></table></figure><h3 id="Jemalloc-TCMalloc"><a href="#Jemalloc-TCMalloc" class="headerlink" title="Jemalloc TCMalloc"></a>Jemalloc TCMalloc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ yum install gperftools-libs</span><br><span class="line">$ exprot TCMALLOC_RELEASE_RATE = 0~10 (10 means the fastest reclaim)</span><br><span class="line">$ LD_PRELOAD=/usr/lib64/libtcmalloc.so.4 sh ./test.sh</span><br><span class="line"></span><br><span class="line">$ LD_PRELOAD=/usr/<span class="built_in">local</span>/lib/libjemalloc.so.2 sh ./test.sh</span><br><span class="line">$ LD_PRELOAD=mimalloc-2.0.0-src/out/release/libmimalloc.so.2.0 sh ./test.sh</span><br></pre></td></tr></table></figure><h3 id="tuned-adm"><a href="#tuned-adm" class="headerlink" title="tuned-adm"></a>tuned-adm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default config files</span></span><br><span class="line">$ ls /usr/lib/tuned</span><br><span class="line">balanced  desktop  <span class="built_in">functions</span>  latency-performance  network-latency  network-throughput  powersave  recommend.d  throughput-performance  virtual-guest  virtual-host</span><br><span class="line"></span><br><span class="line">$ tuned-adm list</span><br><span class="line">$ tuned-adm profile network-throughput</span><br><span class="line">$ tuned-adm active</span><br><span class="line"></span><br><span class="line">$ /etc/tuned/my-variables.conf</span><br><span class="line"></span><br><span class="line">[variables]</span><br><span class="line">include=/etc/tuned/my-variables.conf</span><br><span class="line"></span><br><span class="line">[bootloader]</span><br><span class="line">cmdline=isolcpus=0,1,2,3</span><br></pre></td></tr></table></figure><h3 id="Tick"><a href="#Tick" class="headerlink" title="Tick"></a>Tick</h3><p>Disable Tick to save power in some embedded device</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NO_HZ</span><br><span class="line">CONFIG_NO_HZ_IDLE</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">cat</span> /boot/config-<span class="number">3.10</span>.<span class="number">0</span>-<span class="number">1127</span>.el7.x86_64 | <span class="keyword">grep</span> -Ei <span class="string">&quot;CONFIG_NO_HZ | CONFIG_NO_HZ_IDLE&quot;</span></span><br><span class="line"># CONFIG_NO_HZ_IDLE <span class="keyword">is</span> not <span class="keyword">set</span></span><br></pre></td></tr></table></figure><h3 id="Two’s-Complement-and-the-negative-number"><a href="#Two’s-Complement-and-the-negative-number" class="headerlink" title="Two’s Complement and the negative number"></a><a href="https://www.ruanyifeng.com/blog/2009/08/twos_complement.html">Two’s Complement and the negative number</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">0000 1000 = 8</span><br><span class="line"></span><br><span class="line">inverted</span><br><span class="line">1111 0111</span><br><span class="line"></span><br><span class="line">Add 1</span><br><span class="line">1111 1000 = -8</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">-8=0-8</span><br><span class="line"> 0000 0000</span><br><span class="line">-0000 1000</span><br><span class="line"></span><br><span class="line">borrow</span><br><span class="line">10000 0000</span><br><span class="line">-0000 1000</span><br><span class="line">----------</span><br><span class="line"> 1111 1000 = -8</span><br><span class="line"></span><br><span class="line">10000 0000 - 0000 1000 could be split</span><br><span class="line"></span><br><span class="line">first step: inverted</span><br><span class="line"> 1111 1111</span><br><span class="line">-0000 1000</span><br><span class="line">----------</span><br><span class="line"> 1111 0111</span><br><span class="line"></span><br><span class="line">Second step: Add 1</span><br><span class="line"> 1111 0111</span><br><span class="line">+0000 0001</span><br><span class="line">----------</span><br><span class="line"> 1111 1000 = -8</span><br></pre></td></tr></table></figure><h3 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a><a href="https://bean-li.github.io/dive-into-iostat/">iostat</a></h3><p>io_ticks: the IO service wall-clock time in this device<br>in_flight: The number of I/Os incomplete in the queue, entry the queue +1, when the IO fininshed -1.<br>time_in_queue = in_flight * wall-clock time</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">time</span>=<span class="number">100</span>ms, nothing, in_flight=<span class="number">0</span>, stamp=<span class="number">100</span>, stamp_delta=nothing, io_tickes=<span class="number">0</span>, time_in_queue=<span class="number">0</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">100</span>.<span class="number">1</span>ms, the request in the queue, in_flight=<span class="number">1</span>, stamp=<span class="number">100</span>, stamp_delta=<span class="number">100</span>.<span class="number">1</span>-<span class="number">100</span>=<span class="number">0</span>.<span class="number">1</span>, io_tickes=<span class="number">0</span>.<span class="number">1</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>=<span class="number">0</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">101</span>.<span class="number">2</span>ms, the request in the queue, in_flight=<span class="number">2</span>, stamp=<span class="number">100</span>.<span class="number">1</span>, stamp_delta=<span class="number">101</span>.<span class="number">2</span>-<span class="number">100</span>.<span class="number">1</span>=<span class="number">1</span>.<span class="number">1</span>, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>=<span class="number">1</span>.<span class="number">2</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>=<span class="number">2</span>.<span class="number">3</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">103</span>.<span class="number">6</span>ms, <span class="number">1</span>x request finish, in_flight=<span class="number">1</span>, stamp=<span class="number">101</span>.<span class="number">2</span>, stamp_delta=<span class="number">103</span>.<span class="number">6</span>-<span class="number">101</span>.<span class="number">2</span>=<span class="number">2</span>.<span class="number">4</span>, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>+<span class="number">2</span>.<span class="number">4</span>=<span class="number">3</span>.<span class="number">6</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>+<span class="number">2</span>.<span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>.<span class="number">7</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">153</span>.<span class="number">6</span>ms, <span class="number">1</span>x request finish, in_flight=<span class="number">0</span>, stamp=<span class="number">103</span>.<span class="number">6</span>, stamp_delta=nothing, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>+<span class="number">2</span>.<span class="number">4</span>=<span class="number">3</span>.<span class="number">6</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>+<span class="number">2</span>.<span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>.<span class="number">7</span></span><br><span class="line"><span class="attribute">time</span>=<span class="number">153</span>.<span class="number">9</span>ms, <span class="number">1</span>x request in, in_flight=<span class="number">1</span>, stamp=<span class="number">153</span>.<span class="number">6</span>, stamp_delta=<span class="number">153</span>.<span class="number">9</span>-<span class="number">153</span>.<span class="number">6</span>=<span class="number">0</span>.<span class="number">3</span>, io_tickes=<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>+<span class="number">2</span>.<span class="number">4</span>+<span class="number">0</span>.<span class="number">3</span>=<span class="number">3</span>.<span class="number">9</span>, time_in_queue=<span class="number">0</span>.<span class="number">1</span>*<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span>+<span class="number">2</span>.<span class="number">4</span>*<span class="number">1</span>+<span class="number">0</span>.<span class="number">3</span>*<span class="number">1</span>=<span class="number">5</span></span><br></pre></td></tr></table></figure><p>In this case, the time_in_queue = sum(in_flight)<br>The_wall-clock_total_time means the interval time for this calculate<br>The iostat utils = io_tickes/The_wall-clock_total_time = utils xx %</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux-3.10.0-1127.el7/include/linux/genhd.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">disk_stats</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> sectors[<span class="number">2</span>];       <span class="comment">/* READs and WRITEs */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ios[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> merges[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ticks[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> io_ticks;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> time_in_queue;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">diskstats_show</span><span class="params">(struct seq_file *seqf, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *<span class="title">gp</span> = <span class="title">v</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">disk_part_iter</span> <span class="title">piter</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hd_struct</span> *<span class="title">hd</span>;</span></span><br><span class="line">        <span class="keyword">char</span> buf[BDEVNAME_SIZE];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> inflight[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> cpu;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if (&amp;disk_to_dev(gp)-&gt;kobj.entry == block_class.devices.next)</span></span><br><span class="line"><span class="comment">                seq_puts(seqf,  &quot;major minor name&quot;</span></span><br><span class="line"><span class="comment">                                &quot;     rio rmerge rsect ruse wio wmerge &quot;</span></span><br><span class="line"><span class="comment">                                &quot;wsect wuse running use aveq&quot;</span></span><br><span class="line"><span class="comment">                                &quot;\n\n&quot;);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        disk_part_iter_init(&amp;piter, gp, DISK_PITER_INCL_EMPTY_PART0);</span><br><span class="line">        <span class="keyword">while</span> ((hd = disk_part_iter_next(&amp;piter))) &#123;</span><br><span class="line">                cpu = part_stat_lock();</span><br><span class="line">                part_round_stats(gp-&gt;<span class="built_in">queue</span>, cpu, hd);</span><br><span class="line">                part_stat_unlock();</span><br><span class="line">                part_in_flight(gp-&gt;<span class="built_in">queue</span>, hd, inflight);</span><br><span class="line">                seq_printf(seqf, <span class="string">&quot;%4d %7d %s %lu %lu %lu &quot;</span></span><br><span class="line">                           <span class="string">&quot;%u %lu %lu %lu %u %u %u %u\n&quot;</span>,</span><br><span class="line">                           MAJOR(part_devt(hd)), MINOR(part_devt(hd)),</span><br><span class="line">                           disk_name(gp, hd-&gt;partno, buf),</span><br><span class="line">                           part_stat_read(hd, ios[READ]),</span><br><span class="line">                           part_stat_read(hd, merges[READ]),</span><br><span class="line">                           part_stat_read(hd, sectors[READ]),</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, ticks[READ])),</span><br><span class="line">                           part_stat_read(hd, ios[WRITE]),</span><br><span class="line">                           part_stat_read(hd, merges[WRITE]),</span><br><span class="line">                           part_stat_read(hd, sectors[WRITE]),</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, ticks[WRITE])),</span><br><span class="line">                           inflight[<span class="number">0</span>],</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, io_ticks)),</span><br><span class="line">                           jiffies_to_msecs(part_stat_read(hd, time_in_queue))</span><br><span class="line">                        );</span><br><span class="line">        &#125;</span><br><span class="line">        disk_part_iter_exit(&amp;piter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="proc-pid-smaps-vmflags"><a href="#proc-pid-smaps-vmflags" class="headerlink" title="/proc/pid/smaps vmflags"></a>/proc/pid/smaps vmflags</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rdreadable</span><br><span class="line">wrwriteable</span><br><span class="line">exexecutable</span><br><span class="line">shshared</span><br><span class="line">mrmay read</span><br><span class="line">mwmay write</span><br><span class="line">memay execute</span><br><span class="line">msmay share</span><br><span class="line">gdstack segment growns down</span><br><span class="line">pfpure PFN range</span><br><span class="line">dwdisabled write <span class="keyword">to</span> the mapped file</span><br><span class="line">lopages are locked <span class="keyword">in</span> memory</span><br><span class="line">iomemory mapped I/O area</span><br><span class="line">srsequential read advise provided</span><br><span class="line">rrrandom read advise provided</span><br><span class="line">dc<span class="keyword">do</span> <span class="keyword">not</span> copy<span class="built_in"> area </span>on fork</span><br><span class="line">de<span class="keyword">do</span> <span class="keyword">not</span> expand<span class="built_in"> area </span>on remapping</span><br><span class="line">ac<span class="built_in">area </span>is accountable</span><br><span class="line">nrswap space is <span class="keyword">not</span> reserved <span class="keyword">for</span> the area</span><br><span class="line">ht<span class="built_in">area </span>uses huge tlb pages</span><br><span class="line">nlnon-linear mapping</span><br><span class="line">ararchitecture specific flag</span><br><span class="line">dd<span class="keyword">do</span> <span class="keyword">not</span> include<span class="built_in"> area </span>into core dump</span><br><span class="line">mmmixed map area</span><br><span class="line">hghuge<span class="built_in"> page </span>advise flag</span><br><span class="line">nhno-huge<span class="built_in"> page </span>advise flag</span><br><span class="line">mgmergable advise flag</span><br></pre></td></tr></table></figure><h3 id="not-loading-kernel-module"><a href="#not-loading-kernel-module" class="headerlink" title="not loading kernel module"></a><a href="https://access.redhat.com/solutions/41278">not loading kernel module</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## kernel boot blacklist</span></span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;modprobe.blacklist=mpt2sas&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># modprobe -r module_name                                                      #step1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;blacklist module_name&quot;</span> &gt;&gt; /etc/modprobe.d/local-dontload.conf            <span class="comment">#step2</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;install module_name /bin/false&quot;</span> &gt;&gt; /etc/modprobe.d/local-dontload.conf   <span class="comment">#step3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak                       #step4</span></span><br><span class="line"><span class="comment"># dracut --omit-drivers module_name -f                                                                               #step5</span></span><br><span class="line"><span class="comment"># grub2-editenv - list | grep kernelopts                                                                             #step6</span></span><br><span class="line"><span class="comment"># grub2-editenv - set kernelopts=&quot;&lt;&gt; module_name.blacklist=1 rd.driver.blacklist=module_name&quot;                        #step7</span></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r)kdump.img /boot/initramfs-$(uname -r)kdump.img.$(date +%m-%d-%H%M%S).bak             #step8</span></span><br><span class="line"><span class="comment"># sed -i &#x27;/^KDUMP_COMMANDLINE_APPEND=/s/&quot;$/ rd.driver.blacklist=module_name&quot;/&#x27; /etc/sysconfig/kdump                  #step9</span></span><br><span class="line"><span class="comment"># kdumpctl restart                                                                                                   #step10</span></span><br><span class="line"><span class="comment"># mkdumprd -f /boot/initramfs-$(uname -r)kdump.img                                                                   #step11</span></span><br><span class="line"><span class="comment"># reboot                                                                                                             #step12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak                       #step4</span></span><br><span class="line"><span class="comment"># dracut --omit-drivers module_name -f                                                                               #step5</span></span><br><span class="line"><span class="comment"># sed -i &#x27;/^GRUB_CMDLINE_LINUX=/s/&quot;$/ module_name.blacklist=1 rd.driver.blacklist=module_name&quot;/&#x27; /etc/default/grub   #step6</span></span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg                                                                             #step7</span></span><br><span class="line"><span class="comment"># cp /boot/initramfs-$(uname -r)kdump.img /boot/initramfs-$(uname -r)kdump.img.$(date +%m-%d-%H%M%S).bak             #step8</span></span><br><span class="line"><span class="comment"># sed -i &#x27;/^KDUMP_COMMANDLINE_APPEND=/s/&quot;$/ rd.driver.blacklist=module_name&quot;/&#x27; /etc/sysconfig/kdump                  #step9</span></span><br><span class="line"><span class="comment"># kdumpctl restart                                                                                                   #step10</span></span><br><span class="line"><span class="comment"># mkdumprd -f /boot/initramfs-$(uname -r)kdump.img                                                                   #step11</span></span><br><span class="line"><span class="comment"># reboot                                                                                                             #step12</span></span><br></pre></td></tr></table></figure><h3 id="Process-signal"><a href="#Process-signal" class="headerlink" title="Process signal"></a>Process signal</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> 1) SIGHUP 2) SIGINT 3) SIGQUIT 4) SIGILL</span><br><span class="line"> 5) SIGTRAP 6) SIGABRT 7) SIGBUS 8) SIGFPE</span><br><span class="line"> 9) SIGKILL10) SIGUSR111) SIGSEGV12) SIGUSR2</span><br><span class="line">13) SIGPIPE14) SIGALRM15) SIGTERM16) SIGSTKFLT</span><br><span class="line">17) SIGCHLD18) SIGCONT19) SIGSTOP20) SIGTSTP</span><br><span class="line">21) SIGTTIN22) SIGTTOU23) SIGURG24) SIGXCPU</span><br><span class="line">25) SIGXFSZ26) SIGVTALRM27) SIGPROF28) SIGWINCH</span><br><span class="line">29) SIGIO30) SIGPWR31) SIGSYS34) SIGRTMIN</span><br><span class="line">35) SIGRTMIN+136) SIGRTMIN+237) SIGRTMIN+338) SIGRTMIN+4</span><br><span class="line">39) SIGRTMIN+540) SIGRTMIN+641) SIGRTMIN+742) SIGRTMIN+8</span><br><span class="line">43) SIGRTMIN+944) SIGRTMIN+1045) SIGRTMIN+1146) SIGRTMIN+12</span><br><span class="line">47) SIGRTMIN+1348) SIGRTMIN+1449) SIGRTMIN+1550) SIGRTMAX-14</span><br><span class="line">51) SIGRTMAX-1352) SIGRTMAX-1253) SIGRTMAX-1154) SIGRTMAX-10</span><br><span class="line">55) SIGRTMAX-956) SIGRTMAX-857) SIGRTMAX-758) SIGRTMAX-6</span><br><span class="line">59) SIGRTMAX-560) SIGRTMAX-461) SIGRTMAX-362) SIGRTMAX-2</span><br><span class="line">63) SIGRTMAX-164) SIGRTMAX</span><br><span class="line"></span><br><span class="line"><span class="comment">## send STOP signal for this user</span></span><br><span class="line">$ pkill --signal 19 -U testuser</span><br><span class="line"></span><br><span class="line"><span class="comment">## send CONT signal for this user</span></span><br><span class="line">$ pkill --signal 18 -U testuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bypass the lfs read deadlock !!!, good job</span></span><br></pre></td></tr></table></figure><h3 id="iftop"><a href="#iftop" class="headerlink" title="iftop"></a>iftop</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ timeout 5 iftop  -F 192.168.* -i bond0 -t  -B -n</span><br><span class="line">Got the top10</span><br><span class="line">$ awk <span class="string">&#x27;&#123;if($1~/10.[0-9]+/) &#123;a[$1]++&#125;; if($2~/10.[0-9]+/) &#123;a[$2]++&#125;&#125; END&#123;for(i in a) &#123;if(a[i]!=20) &#123;print i&#125;&#125;&#125;&#x27;</span> /tmp/tmp1</span><br></pre></td></tr></table></figure><h3 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h3><h4 id="shadowsocks"><a href="#shadowsocks" class="headerlink" title="shadowsocks"></a>shadowsocks</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&#x27;s/cleanup/cleanup/g&#x27;</span> /usr/<span class="built_in">local</span>/lib/pythonX.X/dist-packages/shadowsocks/crypto/openssl.py</span><br></pre></td></tr></table></figure><h4 id="use-proxychains"><a href="#use-proxychains" class="headerlink" title="use proxychains"></a>use proxychains</h4><p>Disable the system Integrity Protection</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">⌘ + R go to recovery mode</span><br><span class="line">Utilities -&gt; Terminal -&gt; $ csrutil <span class="built_in">enable</span> --without debug</span><br><span class="line">or</span><br><span class="line">Utilities -&gt; Terminal -&gt; $ csrutil <span class="built_in">disable</span> </span><br><span class="line">reboot </span><br><span class="line">$ csrutil status</span><br><span class="line">System Integrity Protection status: disabled</span><br><span class="line"></span><br><span class="line"><span class="comment">#not comment this line in proxychains-ng</span></span><br><span class="line">quiet_mode <span class="comment">#</span></span><br><span class="line">[ProxyList]</span><br><span class="line">socks5 127.0.0.1 1080</span><br><span class="line"></span><br><span class="line">$ proxychains /bin/bash</span><br><span class="line">$ wget https://www.google.com</span><br></pre></td></tr></table></figure><h3 id="NMI"><a href="#NMI" class="headerlink" title="NMI"></a>NMI</h3><p>Non-Maskable Interrupt(NMI) is the highest priority interrupt that can not be masked by any software<br>The NMI watchdog base the APIC(Advanced Programmable Interrupt Controller) protocol  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kernel.nmi_watchdog=1 →(I/O APIC)</span><br><span class="line">kernel.nmi_watchdog=2 → (Locall APIC)</span><br><span class="line"></span><br><span class="line"><span class="comment">## or add the parameter to grub</span></span><br><span class="line">nmi_watchdog=0</span><br></pre></td></tr></table></figure><h3 id="dmidecode-number"><a href="#dmidecode-number" class="headerlink" title="dmidecode number"></a>dmidecode number</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">TypeInformation</span><br><span class="line">0BIOS</span><br><span class="line">1System</span><br><span class="line">2Baseboard</span><br><span class="line">3Chassis</span><br><span class="line">4Processor</span><br><span class="line">5Memory Controller</span><br><span class="line">6Memory Module</span><br><span class="line">7Cache</span><br><span class="line">8Port Connector</span><br><span class="line">9System Slots</span><br><span class="line">10On Board Devices</span><br><span class="line">11OEM Strings</span><br><span class="line">12System Configuration Options</span><br><span class="line">13BIOS Language</span><br><span class="line">14Group Associations</span><br><span class="line">15System Event Log</span><br><span class="line">16Physical Memory Array</span><br><span class="line">17Memory Device</span><br><span class="line">1832-bit Memory Error</span><br><span class="line">19Memory Array Mapped Address</span><br><span class="line">20Memory Device Mapped Address</span><br><span class="line">21Built-in Pointing Device</span><br><span class="line">22Portable Battery</span><br><span class="line">23System Reset</span><br><span class="line">24Hardware Security</span><br><span class="line">25System Power Controls</span><br><span class="line">26Voltage Probe</span><br><span class="line">27Cooling Device</span><br><span class="line">28Temperature Probe</span><br><span class="line">29Electrical Current Probe</span><br><span class="line">30Out-of-band Remote Access</span><br><span class="line">31Boot Integrity Services</span><br><span class="line">32System Boot</span><br><span class="line">3364-bit Memory Error</span><br><span class="line">34Management Device</span><br><span class="line">35Management Device Component</span><br><span class="line">36Management Device Threshold Data</span><br><span class="line">37Memory Channel</span><br><span class="line">38IPMI Device</span><br><span class="line">39Power Supply</span><br><span class="line">40Additional Information</span><br><span class="line">41Onboard Devices Extended Information</span><br><span class="line">42Management Controller Host Interface</span><br></pre></td></tr></table></figure><h3 id="How-to-got-the-info-from-the-pipe-fd-and-socke-fd"><a href="#How-to-got-the-info-from-the-pipe-fd-and-socke-fd" class="headerlink" title="How to got the info from the pipe fd and socke fd"></a>How to got the info from the pipe fd and socke fd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ strace ls -l /proc/pid/fd</span><br><span class="line">readlink(<span class="string">&quot;6&quot;</span>, <span class="string">&quot;socket:[4248017]&quot;</span>, 65)   = 16</span><br><span class="line">lrwx------ 1 nobody nobody 64 Apr 25 11:04 6 -&gt; socket:[4248017]</span><br><span class="line"></span><br><span class="line">$ netstat -alep | grep 4248017</span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode      PID/Program name</span><br><span class="line">unix  3      [ ]         STREAM                                   CONNECTED               4248017     31233/<span class="built_in">test</span></span><br><span class="line"><span class="comment">## it &#x27;s means unix domain socket connectted with another local inter-process</span></span><br><span class="line"><span class="comment">## if it &#x27;s the remote socket connection you could see the ip adddr, grep xxx /proc/net/tcp /proc/net/udp</span></span><br><span class="line">```bash</span><br><span class="line">$ netstat -alep | grep 5522546</span><br><span class="line">tcp        0      0 0.0.0.0:chimera-hwm     0.0.0.0:*               LISTEN      root       5522546    160890/qperf</span><br><span class="line">$ grep 5522546 /proc/net/tcp</span><br><span class="line">   0: 00000000:0FA9 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 5522546 1 ffff952fb5be07c0 100 0 0 10 0</span><br><span class="line"><span class="comment">## local </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## remote</span></span><br><span class="line">$ netstat -alep | grep 5866595</span><br><span class="line">tcp        0      0 test-2643-2:ssh         10.0.0.73:47702         ESTABLISHED root       5866595    147135/sshd: root@p</span><br><span class="line">$ grep 5866595 /proc/net/tcp</span><br><span class="line">  31: 0x0100a8c1:0016 0200a8c1:BA56 01 00000000:00000000 02:000AC753 00000000     0        0 5866595 4 ffff95283ca10f80 20 4 25 10 22</span><br><span class="line"></span><br><span class="line">cat dec2ip</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">dec2ip ()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">local</span> v=<span class="variable">$1</span></span><br><span class="line">   <span class="built_in">local</span> i1=$((v&gt;&gt;<span class="number">24</span>&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">local</span> i2=$((v&gt;&gt;<span class="number">16</span>&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">local</span> i3=$((v&gt;&gt;<span class="number">8</span>&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">local</span> i4=$((v&amp;<span class="number">255</span>))</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">&#x27;%d.%d.%d.%d\n&#x27;</span> <span class="variable">$i4</span> <span class="variable">$i3</span> <span class="variable">$i2</span> <span class="variable">$i1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dec2ip <span class="variable">$1</span></span><br><span class="line"><span class="comment">#### </span></span><br><span class="line"></span><br><span class="line">$ sh dec2ip $(<span class="built_in">printf</span> <span class="string">&quot;%d \n&quot;</span> 0x0200a8c1)</span><br><span class="line">193.168.0.2</span><br><span class="line"></span><br><span class="line">// https://gist.github.com/jkstill/5095725</span><br><span class="line">31: 0x0100a8c1:0016 0200a8c1:BA56 01 00000000:00000000 02:000AC753 00000000     0        0 5866595 4 ffff95283ca10f80 20 4 25 10 22</span><br><span class="line">31:0x0100a8c1:0016 0200a8c1:BA56 01</span><br><span class="line"> |   |         |   |        |    |--&gt; connection state</span><br><span class="line"> |   |         |   |        |------&gt; remote TCP port number</span><br><span class="line"> |   |         |   |-------------&gt; remote IPv4 address</span><br><span class="line"> |   |         |--------------------&gt; <span class="built_in">local</span> TCP port number</span><br><span class="line"> |   |---------------------------&gt; <span class="built_in">local</span> IPv4 address</span><br><span class="line"> |----------------------------------&gt; number of entry</span><br><span class="line"></span><br><span class="line">00000000:00000000 02:000AC753 00000000</span><br><span class="line"> |        |        |  |        |--&gt; number of unrecovered RTO timeouts</span><br><span class="line"> |        |        |  |----------&gt; number of jiffies until timer expires</span><br><span class="line"> |        |        |----------------&gt; timer_active (see below)</span><br><span class="line"> |        |----------------------&gt; receive-queue</span><br><span class="line"> |-------------------------------&gt; transmit-queue</span><br><span class="line"></span><br><span class="line">0        0 5866595 4 ffff95283ca10f80 20 4 25 10 22</span><br><span class="line">|        | |                | |        |  | |  |  |--&gt; slow start size threshold, </span><br><span class="line">|        | |                | |        |  | |  |       or -1 <span class="keyword">if</span> the treshold</span><br><span class="line">|        | |                | |        |  | |  |       is &gt;= 0xFFFF</span><br><span class="line">|        | |                | |        |  | |  |----&gt; sending congestion window</span><br><span class="line">|        | |                | |        |  | |-------&gt; (ack.quick&lt;&lt;1)|ack.pingpong</span><br><span class="line">|        | |                | |        |  |---------&gt; Predicted tick of soft clock</span><br><span class="line">|        | |                | |        |               (delayed ACK control data)</span><br><span class="line">|        | |                | |        |------------&gt; retransmit timeout</span><br><span class="line">|        | |                | |------------------&gt; location of socket <span class="keyword">in</span> memory</span><br><span class="line">|        | |                |-----------------------&gt; socket reference count</span><br><span class="line">|        | |-----------------------------&gt; inode</span><br><span class="line">|        |----------------------------------&gt; unanswered 0-window probes</span><br><span class="line">|---------------------------------------------&gt; uid</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net/socket.c </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sockfs_dname() is called from d_path().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">sockfs_dname</span><span class="params">(struct dentry *dentry, <span class="keyword">char</span> *buffer, <span class="keyword">int</span> buflen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> dynamic_dname(dentry, buffer, buflen, <span class="string">&quot;socket:[%lu]&quot;</span>,</span><br><span class="line">dentry-&gt;d_inode-&gt;i_ino);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>                                      ----&gt; you get the inode number from pipe or socketfs, you could these processes list                                      |</code></pre><p>$ strace ls -lR /proc 2&gt;&amp;1 | grep -Ei ‘4301922|4248015’</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">### process schdule</span></span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">$ awk &#x27;NF &gt; <span class="number">7</span> &#123; <span class="keyword">if</span> ($<span class="number">1</span> == <span class="string">&quot;task&quot;</span>) &#123; <span class="keyword">if</span> (h == <span class="number">0</span>) &#123; <span class="keyword">print</span>; h=<span class="number">1</span> &#125; &#125; <span class="keyword">else</span> &#123; <span class="keyword">print</span> &#125; &#125;&#x27; /<span class="function"><span class="keyword">proc</span>/<span class="title">sched_debug</span></span></span><br></pre></td></tr></table></figure><h4 id="process-schdule"><a href="#process-schdule" class="headerlink" title="process schdule"></a><a href="http://abcdxyzk.github.io/blog/2014/05/22/kernel-sched-tick/">process schdule</a></h4><p><a href="https://access.redhat.com/solutions/2988101">sched: RT throttling activated</a><br>Enable RT_RUNTIME_GREED with the following command:<br>Raw</p><pre><code>/proc/sys/kernel/sched_rt_period_usDefines the period in μs (microseconds) to be considered as 100% of CPU bandwidth. The default value is 1,000,000 μs (1 second). Changes to the value of the period must be very well thought out as a period too long or too small are equally dangerous. /proc/sys/kernel/sched_rt_runtime_usThe total bandwidth available to all real-time tasks. The default values is 950,000 μs (0.95 s) or, in other words, 95% of the CPU bandwidth. Setting the value to -1 means that real-time tasks may use up to 100% of CPU times. This is only adequate when the real-time tasks are well engineered and have no obvious caveats such as unbounded polling loops. $ echo RT_RUNTIME_GREED &gt; /sys/kernel/debug/sched_featuresTo keep all CPUs with the same rt_runtime, disable the NO_RT_RUNTIME_SHARE logic:$ echo NO_RT_RUNTIME_SHARE &gt; /sys/kernel/debug/sched_features### it could cause some issue in pin the linux process to cpu core<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">That means some guy enable the linux process real-<span class="built_in">time</span> schdule</span><br><span class="line">```bash</span><br><span class="line">## interval </span><br><span class="line"></span><br><span class="line">|<span class="type">----&gt;do_timer</span>()   更新jiffies_64</span><br><span class="line">|<span class="type">----&gt;update_process_times</span>()</span><br><span class="line">|<span class="type">----&gt;scheduler_tick</span>()</span><br><span class="line">|<span class="type">----&gt;update_rq_clock</span>()  更新当前调度队列rq的clock</span><br><span class="line">|<span class="type">----&gt;curr</span>-&gt;sched_class-&gt;task_tick() </span><br><span class="line">|         <span class="type">对于普通进程，即task_tick_fair</span>()</span><br><span class="line">|         <span class="type">task_struct</span>: struct sched_class *sched_class</span><br><span class="line"></span><br><span class="line">update_rq_clock()----delta = sched_clock_cpu(cpu_of(rq)) - rq-&gt;clock</span><br><span class="line">|<span class="type">-----两次相邻两次周期性调度器运行的时间差</span></span><br><span class="line"><span class="type">|----rq</span>-&gt;clock += delta; 更新运行队列上的时钟</span><br><span class="line">|<span class="type">----&gt;update_rq_clock_task</span>(rq, delta)</span><br><span class="line">|     <span class="type">即rq</span>-&gt;clock_task += delta</span><br><span class="line"></span><br><span class="line">## normal</span><br><span class="line">task_tick_fair()----&gt;entity_tick()   没有考虑组调度</span><br><span class="line">  |<span class="type">----&gt;update_curr</span>() 更新相关统计量</span><br><span class="line">  |<span class="type">----&gt;check_preempt_tick</span>()   </span><br><span class="line">  |        <span class="type">检查进程本次获得CPU</span>使用权的执行时间是否超过了</span><br><span class="line">  |        <span class="type">它对应的ideal_runtime</span>值，如果超过了，则将当前进</span><br><span class="line">  |        <span class="type">程的TIF_NEED_RESCHED</span>标志位置位</span><br><span class="line"></span><br><span class="line">update_curr()</span><br><span class="line">  |<span class="type">----delta_exec</span> = (unsigned long)(now - curr-&gt;exec_start);  </span><br><span class="line">  |            <span class="type">exec_start</span>当前进程开始获得</span><br><span class="line">  |            <span class="type">cpu</span>使用权时的时间戳;</span><br><span class="line">  |            <span class="type">进程本次所获得的CPU</span>执行权的时间;</span><br><span class="line">  |<span class="type">----&gt;__update_curr</span>(cfs_rq, curr, delta_exec);</span><br><span class="line">      |<span class="type">----&gt;curr</span>-&gt;sum_exec_runtime += delta_exec; </span><br><span class="line">      |     <span class="type">更新该进程获得CPU</span>执行权总时间</span><br><span class="line">      |<span class="type"></span></span><br><span class="line"><span class="type">      |----&gt;curr</span>-&gt;vruntime += delta_exec_weighted;</span><br><span class="line">      |     <span class="type">更新该进程获得CPU</span>执行权的虚拟时间</span><br><span class="line">      |<span class="type"></span></span><br><span class="line"><span class="type">      |----&gt;update_min_vruntime</span>()</span><br><span class="line">      |     <span class="type">更新cfs_rq</span>-&gt;min_vruntime</span><br><span class="line">      |<span class="type"></span></span><br><span class="line"><span class="type">  |----&gt;curr</span>-&gt;exec_start = now    </span><br><span class="line">  |        <span class="type">更新进程下次运行起始时间</span></span><br><span class="line"><span class="type">  |        (如果被抢占，下次被调度时将会更新)</span></span><br><span class="line"><span class="type"></span></span><br><span class="line"><span class="type">check_preempt_tick</span>()</span><br><span class="line">  |<span class="type">----ideal_runtime</span> = sched_slice(cfs_rq, curr);</span><br><span class="line">  |<span class="type">----delta_exec</span> = curr-&gt;sum_exec_runtime </span><br><span class="line">  |                 <span class="type">- curr</span>-&gt;prev_sum_exec_runtime;</span><br><span class="line">  |<span class="type">----if</span>(delta_exec &gt; ideal_runtime)  </span><br><span class="line">  |          <span class="type">resched_task</span>(rq_of(cfs_rq)-&gt;curr);</span><br><span class="line">  |          <span class="type">把当前进程的TIF_NEED_RESCHED</span>标志位置位</span><br><span class="line">  |<span class="type">----else</span></span><br><span class="line">  |    <span class="type">delta</span> = curr-&gt;vruntime - se-&gt;vruntime;  //这是什么？</span><br><span class="line">  |    <span class="type">if</span> (delta &gt; ideal_runtime)  </span><br><span class="line">  |        <span class="type">resched_task</span>(rq_of(cfs_rq)-&gt;curr);</span><br><span class="line">  |        <span class="type">把当前进程的TIF_NEED_RESCHED</span>标志位置位</span><br><span class="line"></span><br><span class="line">## real <span class="built_in">time</span></span><br><span class="line">task_tick_rt()</span><br><span class="line">  |<span class="type">----&gt;update_curr_rt</span>();</span><br><span class="line">  |<span class="type">----&gt;if</span> (p-&gt;policy != SCHED_RR) <span class="keyword">return</span>;  SCHED_FIFO只有主动放弃CPU使用权</span><br><span class="line">  |<span class="type">----&gt;rt</span>.timeslice值减一，若没有运行完时间则直接返回，</span><br><span class="line">  |     <span class="type">否则再次分配时间片，加入队列尾部，设置TIF_NEED_RESCHED</span></span><br><span class="line"></span><br><span class="line">update_curr_rt()</span><br><span class="line">  |<span class="type">----delta_exec</span> = rq-&gt;clock - curr-&gt;se.exec_start; //本次运行时间</span><br><span class="line">  |<span class="type">----curr</span>-&gt;se.sum_exec_runtime += delta_exec; //更新总得运行时间</span><br><span class="line">  |<span class="type">----curr</span>-&gt;se.exec_start = rq-&gt;clock; //更新下次进程运行的起始时间</span><br><span class="line">  |<span class="type">----if</span> (sched_rt_runtime(rt_rq) != RUNTIME_INF)</span><br><span class="line">  |<span class="type">-------&#123;</span></span><br><span class="line"><span class="type">  |           rt_rq</span>-&gt;rt_time += delta_exec;</span><br><span class="line">  |                <span class="type">if</span> (sched_rt_runtime_exceeded(rt_rq))</span><br><span class="line">  |                   <span class="type">resched_task</span>(curr);</span><br><span class="line">  |       <span class="type">&#125;</span></span><br></pre></td></tr></table></figure>[in non real time linux kernel, dmesg show the &quot;sched: RT throttling activated&quot;](http://abcdxyzk.github.io/blog/2014/05/22/kernel-sched-tick/)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">##<span class="meta"># looks like someone set the real-time process group by cgroup</span></span><br><span class="line">##<span class="meta"># linux-3.10.0-1127.el7/kernel/sched/rt.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sched_rt_runtime_exceeded</span><span class="params">(struct rt_rq *rt_rq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u64 runtime = sched_rt_runtime(rt_rq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rt_rq-&gt;rt_throttled)</span><br><span class="line">                <span class="keyword">return</span> rt_rq_throttled(rt_rq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runtime &gt;= sched_rt_period(rt_rq))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        balance_runtime(rt_rq);</span><br><span class="line">        runtime = sched_rt_runtime(rt_rq);</span><br><span class="line">        <span class="keyword">if</span> (runtime == RUNTIME_INF)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rt_rq-&gt;rt_time &gt; runtime) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">rt_bandwidth</span> *<span class="title">rt_b</span> = <span class="title">sched_rt_bandwidth</span>(<span class="title">rt_rq</span>);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Don&#x27;t actually throttle groups that have no runtime assigned</span></span><br><span class="line"><span class="comment">                 * but accrue some time due to boosting.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (likely(rt_b-&gt;rt_runtime)) &#123;</span><br><span class="line">                        rt_rq-&gt;rt_throttled = <span class="number">1</span>;</span><br><span class="line">                        printk_deferred_once(<span class="string">&quot;sched: RT throttling activated\n&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         * In case we did anyway, make it go away,</span></span><br><span class="line"><span class="comment">                         * replenishment is a joke, since it will replenish us</span></span><br><span class="line"><span class="comment">                         * with exactly 0 ns.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        rt_rq-&gt;rt_time = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##<span class="meta"># linux-3.10.0-1127.el7/kernel/sched/sched.h</span></span><br><span class="line"><span class="comment">/* task group related information */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> <span class="title">css</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FAIR_GROUP_SCHED</span></span><br><span class="line"><span class="comment">/* schedulable entities of this group on each cpu */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> **<span class="title">se</span>;</span></span><br><span class="line"><span class="comment">/* runqueue &quot;owned&quot; by this group on each cpu */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cfs_rq</span> **<span class="title">cfs_rq</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> shares;</span><br><span class="line"></span><br><span class="line"><span class="keyword">atomic_t</span> load_weight;</span><br><span class="line">RH_KABI_DEPRECATE(<span class="keyword">atomic64_t</span>, load_avg)</span><br><span class="line">RH_KABI_DEPRECATE(<span class="keyword">atomic_t</span>, runnable_avg)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RT_GROUP_SCHED</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> **<span class="title">rt_se</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span> **<span class="title">rt_rq</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_bandwidth</span> <span class="title">rt_bandwidth</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_group</span> *<span class="title">parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">siblings</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SCHED_AUTOGROUP</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">autogroup</span> *<span class="title">autogroup</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cfs_bandwidth</span> <span class="title">cfs_bandwidth</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FAIR_GROUP_SCHED)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Put load_avg/runnable_avg in its own cacheline to avoid</span></span><br><span class="line"><span class="comment"> * interfering with the other fields in this structure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RH_KABI_EXTEND(<span class="keyword">atomic64_t</span> load_avg ____cacheline_aligned_in_smp)</span><br><span class="line">RH_KABI_EXTEND(<span class="keyword">atomic_t</span> runnable_avg)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FAIR_GROUP_SCHED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROOT_TASK_GROUP_LOADNICE_0_LOAD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A weight of 0 or 1 can cause arithmetics problems.</span></span><br><span class="line"><span class="comment"> * A weight of a cfs_rq is the sum of weights of which entities</span></span><br><span class="line"><span class="comment"> * are queued on this cfs_rq, so a weight of a entity should not be</span></span><br><span class="line"><span class="comment"> * too large, so as the shares value of a task group.</span></span><br><span class="line"><span class="comment"> * (The default weight is 1024 - so there&#x27;s no practical</span></span><br><span class="line"><span class="comment"> *  limitation from this.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_SHARES(1UL &lt;&lt;  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SHARES(1UL &lt;&lt; 18)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>### About loading avg<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/loadavg</span><br><span class="line">47.36 46.22 43.95 53/1682 249686</span><br><span class="line">                     |      |</span><br><span class="line">                     |      -------- the PID of the process that was most recently created on the system. </span><br><span class="line">                     --------------- it consists of two numbers separated by a slash (/)</span><br><span class="line">                                     The first of these is the number of currently runnable(active) kernel scheduling entities </span><br><span class="line">                                     (active task = nr_running + nr_uninterruptible, processes, threads) </span><br><span class="line">                                     The value after the slash is the number of kernel scheduling entities that currently exist on the system </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">/proc/loadavg</span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/fs/proc/loadavg.c</span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadavg_proc_show</span><span class="params">(struct seq_file *m, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">linux-3.10.0-1127.el7/include/linux/sched.h</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These are the constant used to fake the fixed-point load-average</span></span><br><span class="line"><span class="comment"> * counting. Some notes:</span></span><br><span class="line"><span class="comment"> *  - 11 bit fractions expand to 22 bits by the multiplies: this gives</span></span><br><span class="line"><span class="comment"> *    a load-average precision of 10 bits integer + 11 bits fractional</span></span><br><span class="line"><span class="comment"> *  - if you want to count load-averages more often, you need more</span></span><br><span class="line"><span class="comment"> *    precision, or rounding will get you. With 2-second counting freq,</span></span><br><span class="line"><span class="comment"> *    the EXP_n values would be 1981, 2034 and 2043 if still using only</span></span><br><span class="line"><span class="comment"> *    11 bit fractions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> avenrun[];         <span class="comment">/* Load averages */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">get_avenrun</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> *loads, <span class="keyword">unsigned</span> <span class="keyword">long</span> offset, <span class="keyword">int</span> shift)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FSHIFT          11              <span class="comment">/* nr of bits of precision */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIXED_1         (1&lt;&lt;FSHIFT)     <span class="comment">/* 1.0 as fixed-point */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOAD_FREQ       (5*HZ+1)        <span class="comment">/* 5 sec intervals */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_1           1884            <span class="comment">/* 1/exp(5sec/1min) as fixed-point */</span>  1mins weights</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_5           2014            <span class="comment">/* 1/exp(5sec/5min) */</span>    5 mins weights</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_15          2037            <span class="comment">/* 1/exp(5sec/15min) */</span>  15 mins weights</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CALC_LOAD(load,exp,n) \</span></span><br><span class="line">        load *= <span class="built_in">exp</span>; \</span><br><span class="line">        load += n*(FIXED_1-<span class="built_in">exp</span>); \</span><br><span class="line">        load &gt;&gt;= FSHIFT;</span><br><span class="line"></span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/kernel/sched/core.c</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * get_avenrun - get the load average array</span></span><br><span class="line"><span class="comment"> * @loads:      pointer to dest load array</span></span><br><span class="line"><span class="comment"> * @offset:     offset to add</span></span><br><span class="line"><span class="comment"> * @shift:      shift count to shift the result left</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These values are estimates at best, so no need for locking.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_avenrun</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> *loads, <span class="keyword">unsigned</span> <span class="keyword">long</span> offset, <span class="keyword">int</span> shift)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        loads[<span class="number">0</span>] = (avenrun[<span class="number">0</span>] + offset) &lt;&lt; shift;</span><br><span class="line">...</span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/kernel/sched/core.c</span><br><span class="line">  calc_global_load</span><br><span class="line">    calc_load - update the avenrun load estimates <span class="number">10</span> ticks after the CPUs have updated calc_load_tasks</span><br><span class="line">``` </span><br><span class="line">avenrun[<span class="number">0</span>]_&#123;t&#125; = frac&#123;load_&#123;t&#125; + load_&#123;t+<span class="number">5</span>&#125; + load_&#123;t+<span class="number">10</span>&#125; + <span class="string">&#x27;.&#x27;</span> + load_&#123;t+<span class="number">55</span>&#125;&#125;&#123;<span class="number">60</span> / <span class="number">5</span>&#125;</span><br><span class="line">avenrun[<span class="number">0</span>]_&#123;t+<span class="number">5</span>&#125; = avenrun[<span class="number">0</span>]_&#123;t&#125; - frac&#123;<span class="number">1</span>&#125;&#123;<span class="number">60</span> / <span class="number">5</span>&#125; times load_&#123;t&#125; + frac&#123;<span class="number">1</span>&#125;&#123;<span class="number">60</span> / <span class="number">5</span>&#125;times load_&#123;t+<span class="number">60</span>&#125;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">for</span> more loading avg1](https:<span class="comment">//blog.csdn.net/xiaoqiaoq0/article/details/106932338)</span></span><br><span class="line">[<span class="keyword">for</span> more loading avg2](http:<span class="comment">//brytonlee.github.io/blog/2014/05/07/linux-kernel-load-average-calc/)</span></span><br><span class="line">[<span class="keyword">for</span> more loading avg3](https:<span class="comment">//www.ffutop.com/posts/2019-09-16-load-average/)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### [Linux watchdog](https:<span class="comment">//blog.csdn.net/ericstarmars/article/details/81750919)</span></span><br><span class="line">The kernel code <span class="keyword">and</span> the SCHED_FIFO(pro=<span class="number">99</span>) process cause the lockup, <span class="keyword">and</span> the kernel preemption disabled</span><br><span class="line">- softlockup</span><br><span class="line">  - The kernel code <span class="keyword">not</span> release the CPU resource in the time interval</span><br><span class="line">  - [watchdog/<span class="number">0</span>] [watchdog/<span class="number">1</span>], it depends hrtimer interrupts could be responded</span><br><span class="line">- hardlockup</span><br><span class="line">  - It depends the NMI perf event of x86 PMU, CPU lockup <span class="keyword">and</span> <span class="keyword">not</span> respond the hrtimer interrupt</span><br><span class="line">  - NMI interrupt Watchdog</span><br><span class="line">- hardware watchdog</span><br><span class="line">  - systemctl start ipmidog</span><br><span class="line">  - You could custom the timeout action</span><br><span class="line">  - ipmitool mc watchdog get; /dev/watchdog</span><br><span class="line">- Intel TCO WatchDog Timer Driver</span><br><span class="line">  - lsmod | grep wdt</span><br><span class="line">- userspace watchdog</span><br><span class="line">  - /usr/sbin/watchdog</span><br><span class="line"></span><br><span class="line">### [lockdep](http:<span class="comment">//www.lenky.info/archives/2013/04/2253)</span></span><br><span class="line">CONFIG_LOCKDEP_SUPPORT=y</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> hardirq-safe lock is discovered, we check whether it took any hardirq-unsafe lock in the past.</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> softirq-safe lock is discovered, we check whether it took any softirq-unsafe lock in the past.</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> hardirq-unsafe lock is discovered, we check whether any hardirq-safe lock took it in the past.</span><br><span class="line">– <span class="keyword">if</span> a <span class="keyword">new</span> softirq-unsafe lock is discovered, we check whether any softirq-safe lock took it in the past. </span><br><span class="line"></span><br><span class="line">### [IO type](https:<span class="comment">//lzz5235.github.io/2015/08/25/block.html)</span></span><br><span class="line">- Synchronous blocking (normal)</span><br><span class="line">```c</span><br><span class="line"><span class="keyword">char</span> buf;</span><br><span class="line">fd = open(<span class="string">&quot;/dev/ttyS1&quot;</span>,O_RDWR);</span><br><span class="line">...</span><br><span class="line">res = read(fd,&amp;buf,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;%c\n&quot;</span>,buf);</span><br></pre></td></tr></table></figure>- Synchronous non-blocking (intel loved)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf;</span><br><span class="line">fd = open(<span class="string">&quot;/dev/ttyS1&quot;</span>,O_RDWR | O_NONBLOCK);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">while</span>(read(fd,&amp;buf,<span class="number">1</span>)!= <span class="number">1</span>)</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;%c\n&quot;</span>,buf);</span><br></pre></td></tr></table></figure>- Asynchronous blocking- Asynchronous non-blocking (AIO)   - 异步通知的全程是“信号驱动的异步I/O”，也就是说一旦设备准备就绪，主动通知应用程序，这样应用程序根本就不需要查询设备状态。   - O_ASYNC<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; sys/types.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; sys/stat.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; stdio.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; fcntl.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; signal.h &gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; unistd.h &gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LEN 100</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">input_handler</span><span class="params">(<span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> data[MAX_LEN];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line"> </span><br><span class="line">        len = read(STDIN_FILENO,&amp;data,MAX_LEN);</span><br><span class="line">        data[len] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;input:%s\n&quot;</span>,data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> oflags;</span><br><span class="line">        signal(SIGIO,input_handler);</span><br><span class="line">        fcntl(STDIN_FILENO,F_SETOWN,getpid());</span><br><span class="line">        oflags = fcntl(STDIN_FILENO,F_GETFL);</span><br><span class="line">        fcntl(STDIN_FILENO,F_SETFL,oflags | O_ASYNC);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>### [DynTicks](http://www.lenky.info/archives/2013/07/2317)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NO_HZ_COMMON=y</span><br><span class="line"><span class="comment"># CONFIG_HZ_PERIODIC is not set</span></span><br><span class="line"><span class="comment"># CONFIG_NO_HZ_IDLE is not set</span></span><br><span class="line">CONFIG_NO_HZ_FULL=y</span><br><span class="line"><span class="comment"># CONFIG_NO_HZ_FULL_ALL is not set</span></span><br><span class="line">CONFIG_NO_HZ=y</span><br><span class="line"><span class="comment"># CONFIG_RCU_FAST_NO_HZ is not set</span></span><br><span class="line"><span class="comment"># CONFIG_HZ_100 is not set</span></span><br><span class="line"><span class="comment"># CONFIG_HZ_250 is not set</span></span><br><span class="line"><span class="comment"># CONFIG_HZ_300 is not set</span></span><br><span class="line">CONFIG_HZ_1000=y</span><br><span class="line">CONFIG_HZ=1000</span><br></pre></td></tr></table></figure>- DynTicks, NOHZ, tickless  - reduce overhead, better performancehttp://www.wowotech.net/timer_subsystem/tick-device-layer.html### [rpm spec](https://www.golinuxhub.com/2018/05/how-to-execute-script-at-pre-post-preun-postun-spec-file-rpm/)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">$ rpm --<span class="built_in">eval</span> <span class="string">&quot;%&#123;_usr&#125;&quot;</span></span><br><span class="line">/usr</span><br><span class="line"></span><br><span class="line">$ rpm --<span class="built_in">eval</span> <span class="string">&quot;%&#123;_libdir&#125;&quot;</span></span><br><span class="line">/usr/lib64</span><br><span class="line"></span><br><span class="line"><span class="comment">#modify /usr/lib/rpm/macros from lib64 to lib</span></span><br><span class="line"><span class="comment">#%_lib                   lib64</span></span><br><span class="line">%_lib                   lib</span><br><span class="line">%_libdir                %&#123;_exec_prefix&#125;/%&#123;_lib&#125;</span><br><span class="line"></span><br><span class="line">$ rpm --<span class="built_in">eval</span> <span class="string">&quot;%&#123;_libdir&#125;&quot;</span></span><br><span class="line">/usr/lib</span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is pre&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line">%post</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is post&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"></span><br><span class="line">%preun</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is preun&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"></span><br><span class="line">%postun</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is postun&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Install Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Upgrade Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uninstall Value: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -ivh /tmp/rpmbuild/RPMS/x86_64/deepak-1.0.0-1.x86_64.rpm</span></span><br><span class="line">Preparing...                          <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is pre</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:deepak-1.0.0-1                   <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is post</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -Uvh /tmp/rpmbuild/RPMS/x86_64/deepak-2.0.0-1.x86_64.rpm</span></span><br><span class="line">Preparing...                          <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is pre</span><br><span class="line">Install Value: 2</span><br><span class="line">Upgrade Value: 2</span><br><span class="line">Uninstall Value: 2</span><br><span class="line">-------------</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:deepak-2.0.0-1                   <span class="comment">################################# [ 50%]</span></span><br><span class="line">-------------</span><br><span class="line">This is post</span><br><span class="line">Install Value: 2</span><br><span class="line">Upgrade Value: 2</span><br><span class="line">Uninstall Value: 2</span><br><span class="line">-------------</span><br><span class="line">-------------</span><br><span class="line">This is preun</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line">Cleaning up / removing...</span><br><span class="line">   2:deepak-1.0.0-1                   <span class="comment">################################# [100%]</span></span><br><span class="line">-------------</span><br><span class="line">This is postun</span><br><span class="line">Install Value: 1</span><br><span class="line">Upgrade Value: 1</span><br><span class="line">Uninstall Value: 1</span><br><span class="line">-------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -e deepak</span></span><br><span class="line">-------------</span><br><span class="line">This is preun</span><br><span class="line">Install Value: 0</span><br><span class="line">Upgrade Value: 0</span><br><span class="line">Uninstall Value: 0</span><br><span class="line">-------------</span><br><span class="line">-------------</span><br><span class="line">This is postun</span><br><span class="line">Install Value: 0</span><br><span class="line">Upgrade Value: 0</span><br><span class="line">Uninstall Value: 0</span><br><span class="line">-------------</span><br></pre></td></tr></table></figure>### Patch kernel[patch](http://bbs.chinaunix.net/thread-2230170-1-1.html)  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-p[n] 的 n 值, 只要取消多少條 / 及其左邊的路逕</span><br><span class="line">以 <span class="regexp">/usr/</span>src/linux 為例,</span><br><span class="line">若 -p0 就是不取消任何路經</span><br><span class="line">-p1 則將 <span class="regexp">/ 取消, 得 usr/</span>src/linux</span><br><span class="line">-p2 則是將 <span class="regexp">/usr/</span> 取消, 得 src/linux</span><br><span class="line">再以 src/linux 為例:</span><br><span class="line">-p0 依然為 src/linux</span><br><span class="line">-p1 則為 linux</span><br></pre></td></tr></table></figure>#### patch the kernel<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.10.tar.xz</span><br><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/patch-5.10.22.xz    <span class="comment">## size: 718K</span></span><br><span class="line"><span class="comment">## it &#x27;s the full patch from 5.10, not incr</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> linux-5.10</span><br><span class="line">$ patch -p1 --dry-run &lt; ../patch-5.10.22</span><br><span class="line"><span class="comment">### from 5.10 direct to 5.10.22</span></span><br><span class="line">$ patch -p1 &lt; ../path-5.10.22</span><br><span class="line">$ patch -p1 -R &lt; ../path-5.10.22</span><br><span class="line"></span><br><span class="line"><span class="comment">### from 5.10.21 to 5.10.22</span></span><br><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.10.21.tar.xz</span><br><span class="line">$ wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/incr/patch-5.10.21-22.xz <span class="comment">## incr size: 15K</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> linux-5.10.21</span><br><span class="line">$ patch -p1 --dry-run &lt; ../patch-5.10.21-22</span><br><span class="line">...</span><br><span class="line">checking file security/tomoyo/network.c</span><br><span class="line">checking file sound/hda/intel-nhlt.c</span><br><span class="line">checking file sound/pci/ctxfi/cthw20k2.c</span><br><span class="line">checking file sound/pci/hda/patch_realtek.c</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 6406 (offset -2 lines).</span></span><br><span class="line">Hunk <span class="comment">#2 succeeded at 7854 (offset -11 lines).</span></span><br><span class="line">Hunk <span class="comment">#3 succeeded at 7890 (offset -11 lines).</span></span><br><span class="line">checking file sound/usb/mixer.c</span><br><span class="line">checking file sound/usb/mixer_maps.c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ tail -n 100 ../patch-5.10.21-22</span><br><span class="line">.....</span><br><span class="line">diff --git a/sound/usb/mixer_maps.c b/sound/usb/mixer_maps.c</span><br><span class="line">index a7212f16660ec..646deb6244b15 100644</span><br><span class="line">--- a/sound/usb/mixer_maps.c</span><br><span class="line">+++ b/sound/usb/mixer_maps.c</span><br><span class="line">@@ -536,6 +536,16 @@ static const struct usbmix_ctl_map usbmix_ctl_maps[] = &#123;</span><br><span class="line">                .id = USB_ID(0x05a7, 0x1020),</span><br><span class="line">                .map = bose_companion5_map,</span><br><span class="line">        &#125;,</span><br><span class="line">+       &#123;</span><br><span class="line">+               /* Corsair Virtuoso SE (wired mode) */</span><br><span class="line">+               .id = USB_ID(0x1b1c, 0x0a3d),</span><br><span class="line">+               .map = corsair_virtuoso_map,</span><br><span class="line">+       &#125;,</span><br><span class="line">+       &#123;</span><br><span class="line">+               /* Corsair Virtuoso SE (wireless mode) */</span><br><span class="line">+               .id = USB_ID(0x1b1c, 0x0a3e),</span><br><span class="line">+               .map = corsair_virtuoso_map,</span><br><span class="line">+       &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                /* Corsair Virtuoso (wired mode) */</span><br><span class="line">                .id = USB_ID(0x1b1c, 0x0a41),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$  grep -A 6 <span class="string">&quot;USB_ID(0x05a7, 0x1020)&quot;</span> sound/usb/mixer_maps.c</span><br><span class="line">.id = USB_ID(0x05a7, 0x1020),</span><br><span class="line">.map = bose_companion5_map,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">/* Corsair Virtuoso (wired mode) */  </span><br><span class="line">.id = USB_ID(0x1b1c, 0x0a41),</span><br><span class="line">.map = corsair_virtuoso_map,</span><br><span class="line"></span><br><span class="line">$  patch -p1 &lt; ../patch-5.10.21-22</span><br><span class="line"></span><br><span class="line">$  grep -A 6 <span class="string">&quot;USB_ID(0x05a7, 0x1020)&quot;</span> sound/usb/mixer_maps.c</span><br><span class="line">.id = USB_ID(0x05a7, 0x1020),</span><br><span class="line">.map = bose_companion5_map,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">/* Corsair Virtuoso SE (wired mode) */  <span class="comment">### Add Virtuoso SE </span></span><br><span class="line">.id = USB_ID(0x1b1c, 0x0a3d),</span><br><span class="line">.map = corsair_virtuoso_map,</span><br></pre></td></tr></table></figure>#### [gen the patch, if you modify the kernel source](https://lzz5235.github.io/2015/09/01/kernelpatch.html)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ diff -urN arch/x86/include/ ../linux-5.10.21/arch/x86/include/ &gt; patch-5.10.21-update</span><br><span class="line">or </span><br><span class="line">$ <span class="built_in">echo</span> patch1 &gt;&gt; patch2</span><br></pre></td></tr></table></figure>### compile linux kernelFor debugYou could disable randomize the address of the kernel image (KASLR)<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_RANDOMIZE_BASE</span>=n</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">$ dnf install nss nss-devel nspr nspr-devel file file-devel popt popt-devel libdb-devel libdb lua lua-devel libdb-devel libdb-cxx-devel libarchive-devel lua-devel redhat-rpm-config  rpmdevtools dwarves perl-ExtUtils-Embed asciidoc newt-devel xmlto audit-libs-devel libcap-devel numactl-devel slang-devel  pciutils-devel binutils-devel kernel-rpm-macros ncurses-devel elfutils-libelf-devel openssl-devel libgcrypt-devel  popt-devel lzo-devel lz4-devel</span><br><span class="line">$ cp /boot/config-4.18.0-240.el8.x86_64 .config</span><br><span class="line">$ vi scripts/package/mkspec  </span><br><span class="line"><span class="comment">## replace the line  %define debug_package %&#123;nil&#125; to %define with_debuginfo</span></span><br><span class="line">        %define __spec_install_post /usr/lib/rpm/brp-compress || :</span><br><span class="line">        %define with_debug 0</span><br><span class="line">        %define _enable_debug_packages 0</span><br><span class="line">        %define debuginfodir /usr/lib/debug <span class="comment">## not working</span></span><br><span class="line"></span><br><span class="line">try to</span><br><span class="line">        MAKE=<span class="string">&quot;<span class="variable">$MAKE</span> -j 8 -f <span class="variable">$srctree</span>/Makefile&quot;</span></span><br><span class="line">%build</span><br><span class="line">MAKE=<span class="string">&quot;<span class="variable">$MAKE</span> -j 8 -f <span class="variable">$srctree</span>/Makefile&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### update dwarves-1.20</span></span><br><span class="line">$ dnf install cmake elfutils-devel elfutils-libs libbpf libdwarf</span><br><span class="line">$ </span><br><span class="line"></span><br><span class="line">$ vi .config</span><br><span class="line"><span class="comment">#CONFIG_MODULE_SIG_KEY=&quot;certs/signing_key.pem&quot;</span></span><br><span class="line"><span class="comment">#CONFIG_SYSTEM_TRUSTED_KEYRING=n</span></span><br><span class="line"><span class="comment">#CONFIG_SYSTEM_TRUSTED_KEYS=&quot;certs/rhel.pem&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## at the last</span></span><br><span class="line">$ make menuconfig <span class="comment"># just save once, no many question</span></span><br><span class="line">Add <span class="built_in">enable</span> the compressed cache <span class="keyword">for</span> swap page by default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## rebuild rpm</span></span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure --prefix=/opt/rpm-4.16.1.3</span><br><span class="line">$ make -j 8</span><br><span class="line"></span><br><span class="line">$ make <span class="built_in">help</span></span><br><span class="line">$ make vmlinux -j 8</span><br><span class="line">$ make bzImage</span><br><span class="line">$ make modules -j 8</span><br><span class="line">$ make modules_install -j 8</span><br><span class="line">$ make install -j 8</span><br><span class="line">$ dracut -f /boot/initramfs-5.10.41.el8.x86_64.img 5.10.41 <span class="comment">#default path is /lib/modules</span></span><br><span class="line">$ make install</span><br><span class="line">$ grubby --set-default /boot/vmlinuz-5.10.41</span><br><span class="line">$ grubby --info=ALL</span><br><span class="line">or</span><br><span class="line">$ grub2-set-default 0  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="comment"># mrproper clean all</span></span><br><span class="line">$ sudo make mrproper</span><br><span class="line">$ sudo make clean</span><br><span class="line"></span><br><span class="line"><span class="comment">## contine complie kernel</span></span><br><span class="line">Add env to bashrc</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/opt/rpm-4.16.1.3/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=/opt/rpm-4.16.1.3/bin:<span class="variable">$PATH</span></span><br><span class="line">$ make rpm-pkg</span><br><span class="line"><span class="comment">## make kernel tools</span></span><br><span class="line">$ make -C tools/testing/selftests TARGETS=dma run_tests</span><br><span class="line">$ ls tools/testing/selftests | grep dma_map_benchmark</span><br><span class="line"><span class="comment">## bind driver or you could not bind too</span></span><br><span class="line">$ <span class="built_in">echo</span> dma_map_benchmark &gt; /sys/bus/pci/devices/0000:00:01.0/driver_override</span><br><span class="line">$ <span class="built_in">echo</span> 0000:00:01.0 &gt; /sys/bus/pci/drivers/xxx/unbind</span><br><span class="line">$ <span class="built_in">echo</span> 0000:00:01.0 &gt; /sys/bus/pci/drivers/dma_map_benchmark/<span class="built_in">bind</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">$ dma_map_benchmark -s 120 -t 16</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --remove-args=<span class="string">&quot;crashkernel=256M@16M&quot;</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;crashkernel=384M-2G:64M,2G-:128M&quot;</span></span><br></pre></td></tr></table></figure>install crash-7.3.0  copy the gdb-7.6.0.tar.gz to the source code dir  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make lzo</span><br></pre></td></tr></table></figure>### setcap - set file capabilities<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wireshark work for non-root user</span></span><br><span class="line">$ <span class="built_in">setcap</span> <span class="string">&#x27;CAP_NET_RAW+eip CAP_NET_ADMIN+eip&#x27;</span> /usr/sbin/dumpcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># set uid</span></span><br><span class="line">$ chmod u+s /path/to/application </span><br><span class="line"></span><br><span class="line"><span class="comment"># use ping</span></span><br><span class="line">$ <span class="built_in">setcap</span> <span class="string">&#x27;cap_net_admin,cap_net_raw+ep&#x27;</span> /bin/ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear</span></span><br><span class="line">$ <span class="built_in">setcap</span> -r /bin/ping</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">setcap</span> cap_net_bind_service=+eip /opt/openport_under1024.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## found all setcap files</span></span><br><span class="line">$ <span class="built_in">getcap</span> -r  /  </span><br><span class="line"></span><br><span class="line">$ chmod u+s /bin/vi</span><br><span class="line">$ find /bin -perm -u=s -<span class="built_in">type</span> f </span><br><span class="line"></span><br><span class="line"><span class="comment">### if you set CAP_SETUID cause python switch to root shell</span></span><br><span class="line"><span class="comment"># ALL the capabilites permitted (p) and effective (e) </span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">setcap</span> CAP_SETUID+ep /usr/bin/python</span><br><span class="line">$ python -c <span class="string">&#x27;import os;os.setuid(0);os.system(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>### windows#### terminalchange the colorScheme in json config<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">                <span class="attr">&quot;guid&quot;</span>: <span class="string">&quot;&#123;58ad8b0c-3ef8-5f4d-bc6f-13e4c00f2530&#125;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;hidden&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Debian&quot;</span>,</span><br><span class="line">                &quot;colorScheme&quot;: &quot;One Half Dark&quot;,  &lt;-------- add this line</span><br><span class="line">                &quot;source&quot;: &quot;Windows.Terminal.Wsl&quot;          </span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>### aws command<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.0.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.1.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.2.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.3.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.4.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.5.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.6.0</span><br><span class="line">aws --no-verify-ssl --endpoint http://xx.xx.xx.xx:9100 --profile default s3api head-object --bucket huada-test4 --key copy7/rw.7.0</span><br></pre></td></tr></table></figure>### [rclone](https://bruxy.regnet.cz/web/linux/EN/rsync-rclone/)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat ~/.config/rclone/rclone.conf</span><br><span class="line">[remote_server]</span><br><span class="line"><span class="built_in">type</span> = sftp</span><br><span class="line">host = 172.102.0.123</span><br><span class="line">user = bruxy</span><br><span class="line">key_file = /home/bruxy/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line">$ rclone -v sync <span class="built_in">source</span>/directory/ remote_server:/destination/directory/</span><br></pre></td></tr></table></figure>### interrput the tcp link<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tcpkill -i eth0 host 192.168.0.1</span><br><span class="line">$ ss -K dst 192.168.0.1 dport = 2049</span><br><span class="line">$ iptables -A INPUT -p tcp -m tcp --dport 2049 -j REJECT --reject-with tcp-reset</span><br></pre></td></tr></table></figure>### bash history<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HISTSIZE=10000</span><br><span class="line"><span class="built_in">export</span> HISTFILESIZE=100000</span><br></pre></td></tr></table></figure>### delete file by inode<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . -inum [inode-number] -<span class="built_in">exec</span> rm -i &#123;&#125; \;</span><br></pre></td></tr></table></figure>### got the node ip addr<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip r g 1.1.1.1 | awk <span class="string">&#x27;/src/&#123;print $NF&#125;&#x27;</span></span><br><span class="line">$ ip r g 1.1.1.1 | awk <span class="string">&#x27;/src/&#123;print $(NF-2)&quot;_&quot;$NF&#125;&#x27;</span></span><br></pre></td></tr></table></figure>### route info<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl net.ipv&#123;4,6&#125;.route.max_size</span><br><span class="line">$ ip route show table all</span><br><span class="line">$ ip route show cache</span><br><span class="line">$ ip -6 route show cache</span><br></pre></td></tr></table></figure>### C LANG[C symbol](https://www.runoob.com/cprogramming/c-operators.html)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TMOD |= <span class="number">0x20</span>; (<span class="number">0x20</span>= <span class="number">32</span>=<span class="number">100000</span>, 按位或 C |= <span class="number">2</span> 等同于 C = C | <span class="number">2</span>)</span><br></pre></td></tr></table></figure>C if<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(x) = <span class="keyword">if</span>(x != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>(x != <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="number">1</span>) = <span class="keyword">if</span>(<span class="number">1</span> != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span> != <span class="number">0</span>)</span><br></pre></td></tr></table></figure>### java parameters<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ jmap -J-d64 -dump:format=b,file=dump.bin PID</span><br><span class="line">$ jstat -gcold</span><br><span class="line">$ jstat -gcnew [pid]</span><br><span class="line">$ jstat -gc [pid]</span><br><span class="line">$ jmap -histo [pid]</span><br><span class="line">-XX:+HeapDumpOnOutOfMemeryError</span><br><span class="line">-XX:HeapDumpPath=/home/logs -Xloggc:/home/<span class="built_in">log</span>/gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps</span><br><span class="line">-server -Xms4000m -Xmx4000m -Xmn1500m -Xss256k -XX:PermSize=340m -XX:MaxPermSize=340m -XX:+UseConcMarkSweepGC</span><br><span class="line">XX:+DisableAttachMechanism</span><br><span class="line"></span><br><span class="line"><span class="comment">## java temp file</span></span><br><span class="line">/tmp/.java_pid217893</span><br><span class="line">/tmp/hsperfdata_yourname</span><br></pre></td></tr></table></figure>### ISO<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### this function</span></span><br><span class="line">$ mkisofs -J -l -R -V <span class="string">&quot;Label CD&quot;</span> -iso-level 4 -o output.iso input_directory</span><br></pre></td></tr></table></figure>### linux services<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sadc - System activity data collector.</span><br></pre></td></tr></table></figure>### [intel boot agent message](https://www.supermicro.com/wdl/ISO_Extracted/CDR-APLUS2_2.02_for_A+_AMD_SP5100_platform/Intel/LAN/v18.0.1/APPS/BOOTAGNT/DOCS/ba_msgs.htm)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## uefi set bootutil64e</span></span><br><span class="line">FS0:\&gt;bootutil64e -up=efi -all</span><br></pre></td></tr></table></figure></code></pre>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;audit&quot;&gt;&lt;a href=&quot;#audit&quot; class=&quot;headerlink&quot; title=&quot;audit&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/security_guide/sec-understanding_audit_log_files&quot;&gt;audit&lt;/a&gt;&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -e0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## /etc/audit/auditd.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ systemctl start auditd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -b 8192 &lt;span class=&quot;comment&quot;&gt;#buff&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -f 2 &lt;span class=&quot;comment&quot;&gt;# Set  failure  mode  0=silent 1=printk 2=panic. This option lets you determine how you want the kernel to handle critical errors&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -r 0 &lt;span class=&quot;comment&quot;&gt;# not limit speed&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -e 2 &lt;span class=&quot;comment&quot;&gt;# Set enabled flag. When 0 is passed, this can be used to temporarily disable auditing. When 1 is passed as an argument, it will enable auditing.  To  lock the  audit  configuration  so  that  it  can&amp;#x27;t  be  changed,  pass  a  2 as the argument&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -s &lt;span class=&quot;comment&quot;&gt;# Report  the  kernel&amp;#x27;s  audit  subsystem status&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -l &lt;span class=&quot;comment&quot;&gt;# list rule&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -D &lt;span class=&quot;comment&quot;&gt;# del all policy&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -w path_to_file -p permissions -k key_name&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#&amp;quot;a&amp;quot; means change the dir/file attribute, the others same with r w x&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -w /etc/passwd -p wa -k passwd_changes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -w /etc/selinux/ -p wa -k selinux_changes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -w /sbin/insmod -p x -k module_insertion&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -a always,&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt; -F arch=b64 -S adjtimex -S settimeofday -k time_change&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -a always,&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt; -S unlink -S unlinkat -S rename -S renameat -F auid&amp;gt;=500 -F auid!=4294967295 -k delete&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -a always,&lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt; -F path=/etc/shadow -F perm=wa&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -R /usr/share/doc/audit-version/stig.rules &lt;span class=&quot;comment&quot;&gt;# Read rules from a file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ auditctl -w /etc/ssh/sshd_config -p warx -k sshd_config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ tail audit.log &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;=SYSCALL msg=audit(1364481363.243:24287): arch=c000003e syscall=2 success=no &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;=-13 a0=7fffd19c5592 a1=0 a2=7fffd19c4b50 a3=a items=1 ppid=2686 pid=3538 auid=500 uid=500 gid=500 euid=500 suid=500 fsuid=500 egid=500 sgid=500 fsgid=500 tty=pts0 ses=1 comm=&lt;span class=&quot;string&quot;&gt;&amp;quot;cat&amp;quot;&lt;/span&gt; exe=&lt;span class=&quot;string&quot;&gt;&amp;quot;/bin/cat&amp;quot;&lt;/span&gt; subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key=&lt;span class=&quot;string&quot;&gt;&amp;quot;sshd_config&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;=CWD msg=audit(1364481363.243:24287):  cwd=&lt;span class=&quot;string&quot;&gt;&amp;quot;/home/shadowman&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;=PATH msg=audit(1364481363.243:24287): item=0 name=&lt;span class=&quot;string&quot;&gt;&amp;quot;/etc/ssh/sshd_config&amp;quot;&lt;/span&gt; inode=409248 dev=fd:00 mode=0100600 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:etc_t:s0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#may be the ausearch is not a good choice&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;rsync-debug&quot;&gt;&lt;a href=&quot;#rsync-debug&quot; class=&quot;headerlink&quot; title=&quot;rsync debug&quot;&gt;&lt;/a&gt;rsync debug&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ rsync -h --debug=&lt;span class=&quot;built_in&quot;&gt;help&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Use OPT or OPT1 &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; level 1 output, OPT2 &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; level 2, etc.; OPT0 silences.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ACL        Debug extra ACL info&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BACKUP     Debug backup actions (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BIND       Debug socket &lt;span class=&quot;built_in&quot;&gt;bind&lt;/span&gt; actions&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CHDIR      Debug when the current directory changes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CONNECT    Debug connection events (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CMD        Debug commands+options that are issued (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DEL        Debug delete actions (levels 1-3)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DELTASUM   Debug delta-transfer checksumming (levels 1-4)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DUP        Debug weeding of duplicate names&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EXIT       Debug &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt; events (levels 1-3)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FILTER     Debug filter actions (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FLIST      Debug file-list operations (levels 1-4)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FUZZY      Debug fuzzy scoring (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GENR       Debug generator &lt;span class=&quot;built_in&quot;&gt;functions&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HASH       Debug hashtable code&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HLINK      Debug hard-link actions (levels 1-3)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ICONV      Debug iconv character conversions (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;IO         Debug I/O routines (levels 1-4)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;OWN        Debug ownership changes &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; users &amp;amp; groups (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PROTO      Debug protocol information&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RECV       Debug receiver &lt;span class=&quot;built_in&quot;&gt;functions&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SEND       Debug sender &lt;span class=&quot;built_in&quot;&gt;functions&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TIME       Debug setting of modified &lt;span class=&quot;built_in&quot;&gt;times&lt;/span&gt; (levels 1-2)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ALL        Set all --debug options (e.g. all4)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NONE       Silence all --debug options (same as all0)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HELP       Output this &lt;span class=&quot;built_in&quot;&gt;help&lt;/span&gt; message&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Options added &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; each increase &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; verbose level:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2) BIND,CONNECT,CMD,DEL,DELTASUM,DUP,FILTER,FLIST,ICONV&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3) ACL,BACKUP,CONNECT2,DEL2,DELTASUM2,EXIT,FILTER2,FLIST2,FUZZY,GENR,OWN,RECV,SEND,TIME&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4) CMD2,DEL3,DELTASUM3,EXIT2,FLIST3,ICONV2,OWN2,PROTO,TIME2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5) CHDIR,DELTASUM4,FLIST4,FUZZY2,HASH,HLINK&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;chrome-enable-dns-over-https&quot;&gt;&lt;a href=&quot;#chrome-enable-dns-over-https&quot; class=&quot;headerlink&quot; title=&quot;chrome enable dns over https&quot;&gt;&lt;/a&gt;chrome enable dns over https&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;chrome://flags/&lt;span class=&quot;comment&quot;&gt;#dns-over-https&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;call&quot;&gt;&lt;a href=&quot;#call&quot; class=&quot;headerlink&quot; title=&quot;call&quot;&gt;&lt;/a&gt;call&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### kernel read/write lock&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rwsem_down_failed_common&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;traceroute&quot;&gt;&lt;a href=&quot;#traceroute&quot; class=&quot;headerlink&quot; title=&quot;traceroute&quot;&gt;&lt;/a&gt;traceroute&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ traceroute -q 1 -m 16 12.34.56.78 &lt;span class=&quot;comment&quot;&gt;# avoid linux kernel peer limit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mtr -c 50 -i 0.2 -rw 12.34.56.78&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;mapping-file-to-loop-dev&quot;&gt;&lt;a href=&quot;#mapping-file-to-loop-dev&quot; class=&quot;headerlink&quot; title=&quot;mapping file to loop dev&quot;&gt;&lt;/a&gt;mapping file to loop dev&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ losetup /dev/loop0 /opt/test_file&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ losetup -D &lt;span class=&quot;comment&quot;&gt;## remove all loop dev&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### export tcmalloc&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;```bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ yum install gperftools-libs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; LD_PRELOAD=/usr/lib64/libtcmalloc.so.4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;vi-paste-not-auto-inherit-the-file-type&quot;&gt;&lt;a href=&quot;#vi-paste-not-auto-inherit-the-file-type&quot; class=&quot;headerlink&quot; title=&quot;vi paste not auto inherit the file type&quot;&gt;&lt;/a&gt;vi paste not auto inherit the file type&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;:&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; paste&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;:&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; nopaste&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; TERM=xterm-256color&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; TERM=screen-256color&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;ubuntu-20-04&quot;&gt;&lt;a href=&quot;#ubuntu-20-04&quot; class=&quot;headerlink&quot; title=&quot;ubuntu 20.04&quot;&gt;&lt;/a&gt;ubuntu 20.04&lt;/h3&gt;&lt;p&gt;take screenshot of selected Area in Ubuntu 20.04&lt;br&gt;shortcut key, shift + Print screen&lt;/p&gt;
&lt;p&gt;disable fstrim service&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;rm /var/lib/systemd/timers/stamp-fstrim.timer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl stop fstrim.service fstrim.timer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;built_in&quot;&gt;disable&lt;/span&gt; fstrim.service fstrim.timer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl mask fstrim.service fstrim.timer&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;Delete the conection&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /etc/NetworkManager/system-connections&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;delete the wifi connection &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;``` &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;system program problem detected&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;```bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo rm /var/crash/*&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;installation&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ apt update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt install gcc make automake autoconf perl ethtool bpfcc-tools fio gdb crash python3-bpfcc smartmontools sg3-utils nfs-kernel-server tcpdump screen sysstat iotop iftop openssh-server linux-tools-5.4.0-58-generic atop collectl net-tools axel remmina tightvncserver ffmpeg gimp gimp-resynthesizer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ vi /etc/ssh/sshd_config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#PermitRootLogin prohibit-password&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PermitRootLogin yes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ systemctl restart sshd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ passwd root &lt;span class=&quot;comment&quot;&gt;# set root passwd&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt remove libreoffice-core&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt upgrade&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;##bridge network config example&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vi /etc/network/interfaces &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;iface lo inet loopback&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;auto br0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;iface br0 inet static&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        address 192.168.0.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        network 192.168.0.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        netmask 255.255.255.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        broadcast 192.168.0.255&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        gateway 192.168.0.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        dns-nameservers 192.168.0.5 8.8.8.8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        dns-search example.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        bridge_ports eth0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        bridge_stp off&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        bridge_fd 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        bridge_maxwait 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### debug-info&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;deb http://ddebs.ubuntu.com &lt;span class=&quot;subst&quot;&gt;$(lsb_release -cs)&lt;/span&gt; main restricted universe multiverse&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;      deb http://ddebs.ubuntu.com &lt;span class=&quot;subst&quot;&gt;$(lsb_release -cs)&lt;/span&gt;-updates main restricted universe multiverse&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;      deb http://ddebs.ubuntu.com &lt;span class=&quot;subst&quot;&gt;$(lsb_release -cs)&lt;/span&gt;-proposed main restricted universe multiverse&amp;quot;&lt;/span&gt; | \&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      sudo tee -a /etc/apt/sources.list.d/ddebs.list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt install ubuntu-dbgsym-keyring&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt install debian-goodies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### kernel source&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt-get install linux-source linux-crashdump&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kdump-config show&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ dmesg | grep -i crash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat /proc/sys/kernel/sysrq&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sysctl -w kernel.sysrq=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; c &amp;gt; /proc/sysrq-trigger&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/default/grub.d/kdump-tools.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ update-grub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kdump-config load&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ kdump-config unload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;find-dbgsym-packages [core_path|running_pid|binary_path]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ find-dbgsym-packages /bin/ls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;coreutils-dbgsym libpcre2-8-0-dbgsym libselinux1-dbgsym&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt-get install coreutils-dbgsym &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ crash  /usr/lib/debug/boot/vmlinux-5.4.0-58-generic&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt install linux-image-5.4.0-58-generic-dbgsym&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ vi /etc/apt/sources.list &lt;span class=&quot;comment&quot;&gt;# Enable src &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt-get &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; linux-image-unsigned-$(uname -r)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### ubuntu &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;http://ddebs.ubuntu.com/ubuntu/pool/main/l/linux/linux-image-unsigned-5.4.0-58-generic-dbgsym_5.4.0-58.64_amd64.ddeb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### debain&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;http://mirrors.ustc.edu.cn/debian/pool/main/l/linux/linux-image-4.19.0-13-amd64-dbg_4.19.160-2_amd64.deb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### cat /etc/apt/sources.list&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deb https://mirrors.ustc.edu.cn/debian/ buster main contrib non-free&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deb https://mirrors.ustc.edu.cn/debian/ buster-updates main contrib non-free&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deb https://mirrors.ustc.edu.cn/debian/ buster-backports main contrib non-free&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deb https://mirrors.ustc.edu.cn/debian-security buster/updates main contrib non-free&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#### add dbgsym&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#deb http://deb.debian.org/debian-debug/ buster-debug main&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deb http://debug.mirrors.debian.org/debian-debug/ buster-debug main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# for security updates&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#deb http://deb.debian.org/debian-debug/ buster-proposed-updates-debug main&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;deb http://debug.mirrors.debian.org/debian-debug/ buster-proposed-updates-debug main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt install linux-image-4.19.0-13-amd64-dbg&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;Install wechat&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;https://deepin-wine.i-m.dev/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ wget -O- https://deepin-wine.i-m.dev/setup.sh | sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt install com.qq.weixin.deepin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt-get install -y libjpeg62:i386&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;install-newer-glibc-deb-packages-and-apt-source-not-update-cause-the-deps-issue&quot;&gt;&lt;a href=&quot;#install-newer-glibc-deb-packages-and-apt-source-not-update-cause-the-deps-issue&quot; class=&quot;headerlink&quot; title=&quot;install newer glibc deb packages and apt source not update cause the deps issue&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://askubuntu.com/questions/1315906/unmet-dependencies-libc6-the-package-system-is-broken&quot;&gt;install newer glibc deb packages and apt source not update cause the deps issue&lt;/a&gt;&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## apt install specify version&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt install libc6=2.31-0ubuntu9.2 libc-bin=2.31-0ubuntu9.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## snap remove &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo snap remove chromium&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;setup-vnc&quot;&gt;&lt;a href=&quot;#setup-vnc&quot; class=&quot;headerlink&quot; title=&quot;setup vnc&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-20-04&quot;&gt;setup vnc&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# change the vnc default port&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ grep &lt;span class=&quot;string&quot;&gt;&amp;quot;59&amp;quot;&lt;/span&gt; /usr/bin/vncserver -n &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#modify 5900 to xxxx&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt install xfce4 xfce4-goodies tightvncserver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ vncpasswd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Password:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Verify:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ vncserver&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ vncserver -&lt;span class=&quot;built_in&quot;&gt;kill&lt;/span&gt; :1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#or delete the vnc lock&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ rm -f /tmp/.X11-unix/X1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mv ~/.vnc/xstartup ~/.vnc/xstartup.bak&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat ~/.vnc/xstartup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;xrdb &lt;span class=&quot;variable&quot;&gt;$HOME&lt;/span&gt;/.Xresources&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;startxfce4 &amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ chmod +x ~/.vnc/xstartup&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ssh -L 59000:localhost:5901 -C -N -l &lt;span class=&quot;variable&quot;&gt;$username&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;$your_server_ip&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-L 59000:localhost:5901: The -L switch specifies that the given port on the &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; computer (59000) is to be forwarded to the given host and port on the destination server (localhost:5901, meaning port 5901 on the destination server, defined as your_server_ip). Note that the &lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; port you specify is somewhat arbitrary; as long as the port isn’t already bound to another service, you can use it as the forwarding port &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; your tunnel.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;centos&quot;&gt;&lt;a href=&quot;#centos&quot; class=&quot;headerlink&quot; title=&quot;centos&quot;&gt;&lt;/a&gt;centos&lt;/h3&gt;&lt;h4 id=&quot;printk-messages&quot;&gt;&lt;a href=&quot;#printk-messages&quot; class=&quot;headerlink&quot; title=&quot;printk messages&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://unix.stackexchange.com/questions/13019/description-of-kernel-printk-values&quot;&gt;printk messages&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;#&lt;span class=&quot;meta&quot;&gt;# linux/kernel.h&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_EMERG &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;0&amp;gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_ALERT &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;1&amp;gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_CRIT &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;2&amp;gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_ERR &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;3&amp;gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_WARNING &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;4&amp;gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//default level&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_NOTICE &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;5&amp;gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_INFO &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;6&amp;gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_DEBUG &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;7&amp;gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#&lt;span class=&quot;meta&quot;&gt;# &lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; in kernel/printk.c&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; KERN_DEFAULT &lt;span class=&quot;meta-string&quot;&gt;&amp;quot;&amp;lt;d&amp;gt;&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;DEFAULT_MESSAGE_LOGLEVEL &lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cat /proc/sys/kernel/printk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4(console level) 4(default) 1 7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kernel.printk = 4 4 1 7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#modify the console log level&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; 5 &amp;gt; /proc/sys/kernel/printk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;or&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; 8 &amp;gt; /proc/sys/kernel/printk&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## Some warning messages are rate limited. printk_ratelimit specifies the minimum length of time between these messages (in jiffies), by default we allow one every 5 seconds&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat /proc/sys/kernel/printk_ratelimit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## While long term we enforce one message per printk_ratelimit seconds, we do allow a burst of messages to pass through&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat /proc/sys/kernel/printk_ratelimit_burst&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#set the log level&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ dmesg -n 5 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ dmesg --follow&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;The four values &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; printk denote: console_loglevel, default_message_loglevel, minimum_console_loglevel and default_console_loglevel respectively.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;console_loglevel: messages with a higher priority than this will be printed to the console&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;default_message_loglevel: messages without an explicit priority will be printed with this priority&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;minimum_console_loglevel: minimum (highest) value to &lt;span class=&quot;built_in&quot;&gt;which&lt;/span&gt; console_loglevel can be &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;default_console_loglevel: default value &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; console_loglevel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt; → Emergency messages, system is about to crash or is unstable pr_emerg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;1&amp;quot;&lt;/span&gt; → Something bad happened and action must be taken immediately pr_alert&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;2&amp;quot;&lt;/span&gt; → A critical condition occurred like a serious hardware/software failure pr_crit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;3&amp;quot;&lt;/span&gt; → An error condition, often used by drivers to indicate difficulties with the hardware pr_err&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;4&amp;quot;&lt;/span&gt; → A warning, meaning nothing serious by itself but might indicate problems pr_warning&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;5&amp;quot;&lt;/span&gt; → Nothing serious, but notably nevertheless. Often used to report security events. pr_notice&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;6&amp;quot;&lt;/span&gt; → Informational message e.g. startup information at driver initialization pr_info&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;quot;7&amp;quot;&lt;/span&gt; → Debug messages pr_debug, pr_devel &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; DEBUG is defined&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KERN_DEFAULT &lt;span class=&quot;string&quot;&gt;&amp;quot;d&amp;quot;&lt;/span&gt; The default kernel loglevel&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KERN_CONT &lt;span class=&quot;string&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;continued&amp;quot;&lt;/span&gt; line of &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; printout (only &lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt; after a line that had no enclosing)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;



&lt;h4 id=&quot;centos-7-7-not-report-kenrel-symbols&quot;&gt;&lt;a href=&quot;#centos-7-7-not-report-kenrel-symbols&quot; class=&quot;headerlink&quot; title=&quot;centos 7.7 not report kenrel symbols&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://access.redhat.com/solutions/4797281&quot;&gt;centos 7.7 not report kenrel symbols&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; 0 &amp;gt; /proc/sys/kernel/kptr_restrict&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;kill-sockets&quot;&gt;&lt;a href=&quot;#kill-sockets&quot; class=&quot;headerlink&quot; title=&quot;kill sockets&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://unix.stackexchange.com/questions/71940/killing-tcp-connection-in-linux&quot;&gt;kill sockets&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&quot;highlight routeros&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ss -K dst 192.168.1.214 dport = 49029&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       -K, --kill&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              Attempts &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; forcibly close sockets. This option displays sockets that are successfully closed &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; silently skips sockets that the kernel does &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; support closing. It sup‐&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              ports IPv4 &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt; IPv6 &lt;/span&gt;sockets only. &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;compress-by-xz&quot;&gt;&lt;a href=&quot;#compress-by-xz&quot; class=&quot;headerlink&quot; title=&quot;compress by xz&quot;&gt;&lt;/a&gt;compress by xz&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ tar cf - &lt;span class=&quot;variable&quot;&gt;$dir&lt;/span&gt; | xz -T 8 &amp;gt; &lt;span class=&quot;variable&quot;&gt;$&amp;#123;dir&amp;#125;&lt;/span&gt;.tar.xz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;systemd-rc-local&quot;&gt;&lt;a href=&quot;#systemd-rc-local&quot; class=&quot;headerlink&quot; title=&quot;systemd rc.local&quot;&gt;&lt;/a&gt;systemd rc.local&lt;/h4&gt;&lt;p&gt;set ubuntu shutdown slow&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo vi /etc/systemd/system.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DefaultTimeoutStartSec=10s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DefaultTimeoutStopSec=5s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo systemctl daemon-reload&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo vi /etc/systemd/system/rc-local.service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[Unit]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Description=/etc/rc.local Compatibility&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ConditionPathExists=/etc/rc.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[Service]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;User=root&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Group=root&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Type=forking&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ExecStart=/etc/rc.local start&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TimeoutSec=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;StandardOutput=tty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RemainAfterExit=yes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SysVStartPriority=99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[Install]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;WantedBy=multi-user.target&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;exit 0&amp;quot;&lt;/span&gt; &amp;gt; /etc/rc.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo chmod +x /etc/rc.local&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo systemctl &lt;span class=&quot;built_in&quot;&gt;enable&lt;/span&gt; rc-local&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;date&quot;&gt;&lt;a href=&quot;#date&quot; class=&quot;headerlink&quot; title=&quot;date&quot;&gt;&lt;/a&gt;date&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## a week ago&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;today=$(date -d &lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;span class=&quot;subst&quot;&gt;$(date +%Y%m%d)&lt;/span&gt; 00:00:00&amp;quot;&lt;/span&gt; +%s)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;aweekago=$(date -d &lt;span class=&quot;string&quot;&gt;&amp;quot;@&lt;span class=&quot;subst&quot;&gt;$((today-3600*24*7)&lt;/span&gt;)&amp;quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;+%Y%m%d&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ date -s &lt;span class=&quot;string&quot;&gt;&amp;quot;2 OCT 2018 18:18:18&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ date -d &lt;span class=&quot;string&quot;&gt;&amp;quot;@1595260885&amp;quot;&lt;/span&gt; +&lt;span class=&quot;string&quot;&gt;&amp;quot;%m/%d/%Y %H:%M:%S&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;07/21/2020 00:01:25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ date -d &lt;span class=&quot;string&quot;&gt;&amp;quot;07/21/2020 00:01:25&amp;quot;&lt;/span&gt; +%s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;159526088&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ date -d @12345 -u +%H:%M:%S&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;03:25:45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ date -d &lt;span class=&quot;string&quot;&gt;&amp;quot;09/04/2020 03:25:45&amp;quot;&lt;/span&gt; +%s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1599186345&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ date -d &lt;span class=&quot;string&quot;&gt;&amp;quot;09/04/2020 00:00:00&amp;quot;&lt;/span&gt; +%s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1599174000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; $((&lt;span class=&quot;number&quot;&gt;1599186345&lt;/span&gt;-&lt;span class=&quot;number&quot;&gt;1599174000&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12345&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;dd&quot;&gt;&lt;a href=&quot;#dd&quot; class=&quot;headerlink&quot; title=&quot;dd&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://stackoverflow.com/questions/8554568/add-a-big-buffer-to-a-pipe-between-two-commands&quot;&gt;dd&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;dd modify pipe buffer block size&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ commandA | dd status=none iflag=fullblock bs=1M | commandB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ process1 | mbuffer -m 1024M | process2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;selinux&quot;&gt;&lt;a href=&quot;#selinux&quot; class=&quot;headerlink&quot; title=&quot;selinux&quot;&gt;&lt;/a&gt;selinux&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ setenforce 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ getenforce&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Permissive&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;Software-Collections-SCL-Repository&quot;&gt;&lt;a href=&quot;#Software-Collections-SCL-Repository&quot; class=&quot;headerlink&quot; title=&quot;Software Collections ( SCL ) Repository&quot;&gt;&lt;/a&gt;Software Collections ( SCL ) Repository&lt;/h4&gt;&lt;p&gt;$ yum install centos-release-scl-rh&lt;br&gt;$ yum install devtoolset-9-toolchain&lt;/p&gt;
&lt;h1 id=&quot;centos-8&quot;&gt;&lt;a href=&quot;#centos-8&quot; class=&quot;headerlink&quot; title=&quot;centos 8&quot;&gt;&lt;/a&gt;centos 8&lt;/h1&gt;&lt;p&gt;$ dnf install gcc-toolset-9&lt;/p&gt;
&lt;p&gt;$ gfortran –version | head -2&lt;br&gt;GNU Fortran (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36)&lt;br&gt;Copyright (C) 2015 Free Software Foundation, Inc.&lt;/p&gt;
&lt;p&gt;$ scl enable devtoolset-9 bash&lt;/p&gt;
&lt;p&gt;$  gfortran –version | head -2&lt;br&gt;GNU Fortran (GCC) 8.2.1 20180905 (Red Hat 8.2.1-3)&lt;br&gt;Copyright (C) 2018 Free Software Foundation, Inc.&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="http://yoursite.com/categories/OS/"/>
    
    
    <category term="centos" scheme="http://yoursite.com/tags/centos/"/>
    
  </entry>
  
  <entry>
    <title>ubuntu</title>
    <link href="http://yoursite.com/2019/07/18/ubuntu/"/>
    <id>http://yoursite.com/2019/07/18/ubuntu/</id>
    <published>2019-07-18T07:37:02.000Z</published>
    <updated>2021-04-11T14:25:56.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="install-debug-kernel-info"><a href="#install-debug-kernel-info" class="headerlink" title="install debug kernel info"></a>install debug kernel info</h3><p>Download from <a href="http://ddebs.ubuntu.com/pool/main/l/linux/">http://ddebs.ubuntu.com/pool/main/l/linux/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">$ U=http://ddebs.ubuntu.com</span><br><span class="line">$ D=$(lsb_release -cs)</span><br><span class="line">$ cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/ddebs.list</span><br><span class="line">deb <span class="variable">$&#123;U&#125;</span> <span class="variable">$&#123;D&#125;</span> main restricted universe multiverse</span><br><span class="line"><span class="comment">#deb $&#123;U&#125; $&#123;D&#125;-security main restricted universe multiverse</span></span><br><span class="line">deb <span class="variable">$&#123;U&#125;</span> <span class="variable">$&#123;D&#125;</span>-updates main restricted universe multiverse</span><br><span class="line">deb <span class="variable">$&#123;U&#125;</span> <span class="variable">$&#123;D&#125;</span>-proposed main restricted universe multiverse</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ wget -O - http://ddebs.ubuntu.com/dbgsym-release-key.asc | apt-key add -</span><br><span class="line"></span><br><span class="line">$ apt install linux-image-`uname -r`-dbgsym build-essential build-essential</span><br><span class="line"></span><br><span class="line"><span class="comment">### or custom install kernel</span></span><br><span class="line">CONFIG_DEBUG_INFO</span><br><span class="line">CONFIG_KPROBES</span><br><span class="line">CONFIG_RELAY</span><br><span class="line">CONFIG_DEBUG_FS</span><br><span class="line">CONFIG_MODULES</span><br><span class="line">CONFIG_MODULE_UNLOAD</span><br><span class="line">CONFIG_UTRACE</span><br><span class="line"></span><br><span class="line">Kernel hacking  ---&gt;</span><br><span class="line">    [*] Kernel debugging</span><br><span class="line">        [*]   Compile the kernel with debug info</span><br><span class="line"></span><br><span class="line">Instrumentation Support  ---&gt;</span><br><span class="line">    [*] Kprobes (EXPERIMENTAL)</span><br><span class="line"></span><br><span class="line">General setup  ---&gt;</span><br><span class="line">    [*] Kernel-&gt;user space relay support (formerly relayfs)</span><br><span class="line"></span><br><span class="line">https://github.com/gatieme/LDD-LinuxDeviceDrivers/tree/master/study/debug/tools/systemtap/01-install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://www.hiroom2.com/2018/04/27/ubuntu-1804-dbgsym-en/</span><br><span class="line"></span><br><span class="line">$ gdb &lt;<span class="built_in">command</span>&gt; --directory /path/to/<span class="built_in">source</span></span><br><span class="line">&lt;snip&gt;</span><br><span class="line">(gdb)</span><br><span class="line">In <span class="keyword">case</span> of bash is as below.</span><br><span class="line"></span><br><span class="line">$ gdb bash --directory ~/bash/bash-4.4.18/</span><br><span class="line">&lt;snip&gt;</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x2fdb0: file .././shell.c, line 368.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /bin/bash</span><br><span class="line">Breakpoint 1, main (argc=1, argv=0x7fffffffe418, env=0x7fffffffe428) at</span><br><span class="line">.././shell.c:368</span><br><span class="line">368     &#123;</span><br><span class="line">(gdb) l</span><br><span class="line">363     int</span><br><span class="line">364     main (argc, argv, env)</span><br><span class="line">365          int argc;</span><br><span class="line">366          char **argv, **env;</span><br><span class="line">367     <span class="comment">#endif /* !NO_MAIN_ENV_ARG */</span></span><br><span class="line">368     &#123;</span><br><span class="line">369       register int i;</span><br><span class="line">370       int code, old_errexit_flag;</span><br><span class="line">371     <span class="comment">#if defined (RESTRICTED_SHELL)</span></span><br><span class="line">372       int saverst;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stress-ng完全兼容stress, 并且在此基础上通过几百个参数，可以产生各种复杂的压力, 比如：</span><br><span class="line"></span><br><span class="line">产生2个worker做圆周率算法压力：</span><br><span class="line"></span><br><span class="line">stress-ng -c 2 --cpu-method pi</span><br><span class="line">产生2个worker从迭代使用30多种不同的压力算法，包括pi, crc16, fft等等。</span><br><span class="line"></span><br><span class="line">stress-ng -c 2 --cpu-method all</span><br><span class="line">产生2个worker调用socket相关函数产生压力</span><br><span class="line"></span><br><span class="line">stress-ng --sock 2</span><br><span class="line">产生2个worker读取tsc产生压力</span><br><span class="line"></span><br><span class="line">stress-ng --tsc 2</span><br><span class="line">除了能够产生不同类型的压力，strss-ng还可以将压力指定到特定的cpu上，比如下面的命令将压力指定到cpu 0,2,3,6：</span><br><span class="line"></span><br><span class="line">stress-ng --sock 4 --taskset 0,2-3,6 </span><br></pre></td></tr></table></figure><h3 id="ubuntu-init"><a href="#ubuntu-init" class="headerlink" title="ubuntu init"></a>ubuntu init</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove libreoffice-common</span><br><span class="line">apt install openssh-server vim screen mdadm lsscsi sdparm sg3-utils smartmontools sdparm git sysstat</span><br><span class="line">systemctl <span class="built_in">disable</span> ssh</span><br><span class="line">apt install python3-pip</span><br><span class="line">vim /usr/<span class="built_in">local</span>/lib/python3.8/dist-packages/shadowsocks/crypto/openssl.py</span><br><span class="line">:%s/cleanup/reset/</span><br><span class="line">cp /usr/<span class="built_in">local</span>/lib/python3.8/dist-packages/shadowsocks/crypto/openssl.py /usr/<span class="built_in">local</span>/lib/python3.8/dist-packages/shadowsocks/crypto/openssl.py_bak</span><br><span class="line"></span><br><span class="line">apt install proxychains4 </span><br><span class="line">vi /etc/proxychains4.conf</span><br><span class="line">[ProxyList]</span><br><span class="line"><span class="comment"># add proxy here ...</span></span><br><span class="line"><span class="comment"># meanwile</span></span><br><span class="line"><span class="comment"># defaults set to &quot;tor&quot;</span></span><br><span class="line">socks4         127.0.0.1 9050</span><br><span class="line"></span><br><span class="line">proxychains4 ping www.google.com</span><br><span class="line"></span><br><span class="line">mdadm --assemble --scan</span><br><span class="line">/opt/google/chrome/chrome --proxy-server=<span class="string">&quot;socks5://myproxy:8080&quot;</span></span><br><span class="line"></span><br><span class="line">Language instlal chinese support, after <span class="built_in">logout</span> and <span class="built_in">set</span> the default input method to fcitx </span><br><span class="line">sudo apt install fcitx-bin  fcitx-googlepinyin</span><br><span class="line"></span><br><span class="line"><span class="comment">### install hexo</span></span><br><span class="line"> sudo apt install npm</span><br><span class="line"> sudo npm install --save -g hexo-cli </span><br><span class="line"> npm update hexo --save -g  <span class="comment"># update</span></span><br><span class="line"> npm install hexo-renderer-pug hexo-renderer-stylus --save</span><br><span class="line"> npm uninstall hexo-generator-index --save</span><br><span class="line"> npm install hexo-generator-index-pin-top --save</span><br><span class="line"> npm install hexo-wordcount --save</span><br><span class="line"> npm install hexo-renderer-pug hexo-renderer-stylus --save</span><br><span class="line"> npm install hexo-generator-search --save</span><br><span class="line"> npm install hexo-deployer-git --save</span><br><span class="line"> npm install hexo-generator-feed --save</span><br><span class="line"></span><br><span class="line"><span class="comment"># download deb package for dropbox</span></span><br><span class="line">$ proxychains dropbox start -i</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;install-debug-kernel-info&quot;&gt;&lt;a href=&quot;#install-debug-kernel-info&quot; class=&quot;headerlink&quot; title=&quot;install debug kernel info&quot;&gt;&lt;/a&gt;install deb</summary>
      
    
    
    
    <category term="OS" scheme="http://yoursite.com/categories/OS/"/>
    
    
    <category term="ubuntu" scheme="http://yoursite.com/tags/ubuntu/"/>
    
    <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Replace megaraid by strocli</title>
    <link href="http://yoursite.com/2019/05/24/megaraid/"/>
    <id>http://yoursite.com/2019/05/24/megaraid/</id>
    <published>2019-05-24T01:26:24.000Z</published>
    <updated>2021-02-27T15:12:44.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Name-Decoder"><a href="#Name-Decoder" class="headerlink" title="Name Decoder"></a>Name Decoder</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">              --------Generation <span class="number">1</span>=<span class="number">3</span>Gb/s SAS / SATA, <span class="number">2</span>=<span class="number">6</span> Gb/s SAS / SATA, <span class="number">3</span>=<span class="number">12</span> Gb/s SAS / SATA</span><br><span class="line">              -------<span class="number">-4</span>=<span class="number">12</span> Gb/s SAS/ SATA/ PCIe3, <span class="number">5</span>=<span class="number">12</span> Gb/s SAS/ SATA/ PCIe4, <span class="number">6</span>=<span class="number">24</span> Gb/s SAS/ SATA/ PCIe4 (Tri-mode)</span><br><span class="line">              | - Starts at <span class="string">&quot;0&quot;</span>; This digit <span class="keyword">is</span> used <span class="keyword">for</span> changes that are meant show succession <span class="keyword">from</span> an older version to a newer version.</span><br><span class="line">              | | </span><br><span class="line">MegaRAID SAS <span class="number">9460</span> - <span class="number">16</span>i</span><br><span class="line">             | |     | </span><br><span class="line">             | |     -----------<span class="number">-16</span>x <span class="built_in">int</span>ernal ports, the <span class="number">4</span>i4e= <span class="number">4</span> of Internal <span class="keyword">and</span> <span class="number">4</span> of External ports</span><br><span class="line">             | ------Subcategory <span class="number">0</span> = HBA Initiator / Target,<span class="number">1</span> = HBA Integrated RAID, <span class="number">4</span> = MegaRAIDEntry (iMR)</span><br><span class="line">             | -----<span class="number">-6</span> = MegaRAID Value,<span class="number">8</span> = MegaRAID Feature</span><br><span class="line">             ---Technology <span class="number">9</span> = SATA+SAS+PCIe</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Got-megaraid-log"><a href="#Got-megaraid-log" class="headerlink" title="Got megaraid log"></a>Got megaraid log</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">perccli64 /call show all logfile=megaraid.cfg</span><br><span class="line">perccli64 /call show events file=events.log</span><br><span class="line">perccli64 /call show termlog <span class="built_in">type</span>=config logfile=termlog.config</span><br><span class="line">perccli64 /call show termlog <span class="built_in">type</span>=contents logfile=termlog.contents</span><br><span class="line">perccli64 /call show eventloginfo</span><br><span class="line">perccli64 /call show dequeuelog file=dequeue.log</span><br><span class="line">perccli64 /call show alilog logfile=ali.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear the log</span></span><br><span class="line"><span class="comment">#perccli64 /c x set debug reset all</span></span><br><span class="line"><span class="comment">#perccli64 /call delete events</span></span><br><span class="line"><span class="comment">#perccli64 /call delete termlog</span></span><br></pre></td></tr></table></figure><h3 id="Set-time"><a href="#Set-time" class="headerlink" title="Set time"></a>Set time</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /call show time</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> time=yyyymmdd hh:mm:ss|systemtime</span><br><span class="line">$ timedatectl set-timezone Asia/XXXXXX</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> time=systemtime</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Set-cache-policy"><a href="#Set-cache-policy" class="headerlink" title="Set cache policy"></a>Set cache policy</h3><p>Disable write back cache</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0/v0 <span class="builtin-name">set</span> <span class="attribute">wrcache</span>=wb/wt/awb <span class="attribute">rdcache</span>=ra <span class="attribute">iopolicy</span>=cached <span class="attribute">pdcache</span>=on</span><br></pre></td></tr></table></figure><h3 id="Create-raid10"><a href="#Create-raid10" class="headerlink" title="Create raid10"></a>Create raid10</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 add vd <span class="built_in">type</span>=raid10 drives=252:0-7 pdperarray=2 WT strip=64</span><br><span class="line">$ storcli64 /c0 add vd <span class="built_in">type</span>=raid5 drives=252:0,2,4,6 WT strip=64</span><br><span class="line">$ storcli64 /c0/vXX del force</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0/e54/s43,44 add hotsparedrive <span class="comment">#global hs</span></span><br><span class="line">$ storcli64 /c0/e54/s43 add hotsparedrive dgs=0,1 <span class="comment">#as Dedicated Hot spare for disk groups 0,1</span></span><br><span class="line">$ storcli64 /c0/e54/s43 delete hotsparedrive <span class="comment">#deletes a hot spare drive</span></span><br></pre></td></tr></table></figure><p><a href="https://support.huawei.com/enterprise/en/doc/EDOC1000111853?section=j005">reference</a><br><img src="/img/lsi-3108-example-20191010.png"><br>Read Policy</p><ul><li>No Read Ahead: disables the Read Ahead function.</li><li>Read Ahead: enables the Read Ahead function. The controller pre-reads sequential data or the data predicted to be used and saves it in the cache.</li></ul><p>Write Policy</p><ul><li>Write Back: After the controller cache receives all data, the controller sends the host a message indicating that data transmission is complete.</li><li>Write Through: After the drive subsystem receives all data, the controller sends the host a message indicating that data transmission is complete.</li><li>Always Write Back: Virtual drive remains in Write Back mode if the capacitor fails or no capacitor exists.</li></ul><p>I/O Policy</p><ul><li>Direct: Data is read directly and is not cached. This is the recommended mode for common configuration.</li><li>Cached: All data is read from cache. This is the recommended mode for CacheCade.</li></ul><p>Access Policy</p><ul><li>Read/Write: Read and write operations are allowed.</li><li>Read Only: The virtual drive is read-only.</li><li>Blocked: The virtual drive is locked from access.</li></ul><p>Drive Cache</p><ul><li>Unchanged: uses the current cache policy.</li><li>Enable: writes data to the cache before writing data to the hard drive. This option improves data write performance. However, data may be lost if there is no protection mechanism against power failures.</li><li>Disable: writes data to a hard drive without caching the data. Data is not lost if power failures occur.</li></ul><p>Emulation Type<br>Set the sector size reported to the OS.<br>50</p><ul><li><p>If the member drive is 512B/512B:</p><ul><li>Default: The logical drive sector is 512B/512B.</li><li>None: The logical drive sector is 512B/512B.</li><li>Force: The logical drive sector is 512B/4KB.</li></ul></li><li><p>If the member drive is 512B/4KB:</p><ul><li>Default: The logical drive sector is 512B/4KB.</li><li>None: The logical drive sector is 512B/512B.</li><li>Force: The logical drive sector is 512B/4KB.</li></ul></li></ul><h3 id="Megaraid-FastPATH-for-SAS-SATA-SSD"><a href="#Megaraid-FastPATH-for-SAS-SATA-SSD" class="headerlink" title="Megaraid FastPATH for SAS/SATA SSD"></a>Megaraid FastPATH for SAS/SATA SSD</h3><h4 id="case-1"><a href="#case-1" class="headerlink" title="case 1"></a><a href="https://lenovopress.com/lp0592.pdf">case 1</a></h4><p>Suggest RAID5<br>To benefit from FastPath, an array must be defined using these specific parameters:</p><ul><li>Write Through</li><li>Direct IO</li><li>No Read Ahead</li><li>64KB stripe size (for most workloads)</li><li>RAID 5(fastpath support all raid level)</li><li>Disk Cache Policy: This controls the write cache policy for the drives in the arrays (as opposed to the write cache policy of the RAID adapter). Enabling disk write caching can put data at risk.<ul><li>full initialization</li></ul></li></ul><p>With FastPath enabled, and when certain conditions are met, the MegaRAID software stack running on the RAID controller can bypass portions of the software stack, resulting in a highly efficient, streamlined code path that the RAID controller can execute very quickly. This means that the RAID controller can handle more trips though its code in a given amount of time, which equates to higher possible IOPS.</p><p>FastPath is not designed to speed up slow storage. It will not have an effect on storage performance unless the RAID controller is the bottleneck. If the controller itself is limiting storage performance, then enabling FastPath will allow the controller to run faster, raising performance. FastPath is not meant for use with HDD storage nor is it meant for sequential workloads.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show aso</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Premium Feature Key :</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Adv S/W Opt                 Time Remaining  Mode</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">MegaRAID FastPath           Unlimited       Secured</span><br><span class="line">MegaRAID CacheCade Pro 2.0  Unlimited       Secured</span><br><span class="line">MegaRAID RAID6              Unlimited       Factory Installed</span><br><span class="line">MegaRAID RAID5              Unlimited       Factory Installed</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Re-host Information :</span><br><span class="line">===================</span><br><span class="line">Needs Re-hosting = NO</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line"><span class="comment">#### [Case 2: Aerospike Certification Tool](https://www.aerospike.com/docs/operations/plan/ssd/lsi_megacli.html)</span></span><br><span class="line">RAID Level0</span><br><span class="line">Write PolicyWrite Through</span><br><span class="line">Read PolicyNo Read Ahead</span><br><span class="line">IO PolicyDirect IO</span><br><span class="line">Other        No write to cache <span class="keyword">if</span> bad BBU</span><br><span class="line"></span><br><span class="line">Dell R720xd</span><br><span class="line">PERC H710p RAID controller</span><br><span class="line">8 x 200 GB Intel s3700 SSDs</span><br><span class="line"></span><br><span class="line">Latency measures during torture tests (96,000 reads/sec and 48,000 concurrent writes/second).</span><br><span class="line">RAID setting% &gt;1 ms% &gt;2 ms% &gt;4 ms% &gt;8 ms% &gt;16 ms</span><br><span class="line">Default        22.2013.964.290.220.00</span><br><span class="line">FastPath™4.310.850.170.000.00</span><br><span class="line"></span><br><span class="line">The latencies <span class="keyword">for</span> the FastPath™ are much better. In general better latency results mean much higher threshold <span class="keyword">for</span> throughput.</span><br><span class="line"></span><br><span class="line"><span class="comment">### Storcli replace Megacli</span></span><br><span class="line"><span class="comment">#### BBU info</span></span><br><span class="line">```bash</span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -getBbuProperties -aALL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU Properties <span class="keyword">for</span> Adapter: 0</span><br><span class="line"></span><br><span class="line">  Auto Learn Period: 30 Days</span><br><span class="line">  Next Learn time: Mon Jun  3 12:02:38 2019</span><br><span class="line"></span><br><span class="line">  Learn Delay Interval:0 Hours</span><br><span class="line">  Auto-Learn Mode: Enabled</span><br><span class="line">  BBU Mode = 4</span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show properties</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU_Properties :</span><br><span class="line">==============</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Property             Value</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Auto Learn Period    30d (2592000 seconds)</span><br><span class="line">Next Learn time      2019/06/03  12:02:38 (612878558 seconds)</span><br><span class="line">Learn Delay Interval 0 hour(s)</span><br><span class="line">Auto-Learn Mode      Enabled</span><br><span class="line">BBU Mode             4</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show status</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU_Info :</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">Property      Value</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">BatteryType   iBBU08</span><br><span class="line">Voltage       4056 mV</span><br><span class="line">Current       0 mA</span><br><span class="line">Temperature   31 C</span><br><span class="line">Battery State Optimal</span><br><span class="line">Design Mode   1: 12+ Hrs retention with a transparent learn cycle</span><br><span class="line">                 and best service life.</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU_Firmware_Status :</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br><span class="line">Property                                   Value</span><br><span class="line">-------------------------------------------------</span><br><span class="line">Charging Status                            None</span><br><span class="line">Voltage                                    OK</span><br><span class="line">Temperature                                OK</span><br><span class="line">Learn Cycle Requested                      No</span><br><span class="line">Learn Cycle Active                         No</span><br><span class="line">Learn Cycle Status                         OK</span><br><span class="line">Learn Cycle Timeout                        No</span><br><span class="line">I2C Errors Detected                        No</span><br><span class="line">Battery Pack Missing                       No</span><br><span class="line">Battery Replacement required               No</span><br><span class="line">Remaining Capacity Low                     No</span><br><span class="line">Periodic Learn Required                    No</span><br><span class="line">Transparent Learn                          No</span><br><span class="line">No space to cache offload                  No</span><br><span class="line">Pack is about to fail &amp; should be replaced No</span><br><span class="line">Cache Offload premium feature required     No</span><br><span class="line">Module microcode update required           No</span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line">GasGaugeStatus :</span><br><span class="line">==============</span><br><span class="line"></span><br><span class="line">--------------------------------------</span><br><span class="line">Property                   Value</span><br><span class="line">--------------------------------------</span><br><span class="line">Fully Discharged           No</span><br><span class="line">Fully Charged              No</span><br><span class="line">Discharging                No</span><br><span class="line">Initialized                Yes</span><br><span class="line">Remaining Time Alarm       No</span><br><span class="line">Terminate Discharge Alarm  No</span><br><span class="line">Over Temperature           No</span><br><span class="line">Charging Terminated        No</span><br><span class="line">Over Charged               No</span><br><span class="line">Relative State of Charge   97%</span><br><span class="line">Charger System State       1</span><br><span class="line">Charger System Ctrl        0</span><br><span class="line">Charging current           0 mA</span><br><span class="line">Absolute state of charge   78%</span><br><span class="line">Max Error                  0%</span><br><span class="line">Battery backup charge time 48 hours +</span><br><span class="line">--------------------------------------</span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show status | grep -i <span class="built_in">type</span></span><br><span class="line">BatteryType   iBBU08</span><br><span class="line"></span><br><span class="line"><span class="comment">#important value</span></span><br><span class="line">Remaining Capacity Low                  : No</span><br><span class="line"></span><br><span class="line"><span class="comment">#design capacity: 1500, max</span></span><br><span class="line">Relative State of Charge ＝ 1055 ／ 1198 ～ 89%</span><br><span class="line">Absolute State of charge ＝ 1055 ／ 1500 ～ 70%</span><br></pre></td></tr></table></figure><h4 id="Setting-BBU"><a href="#Setting-BBU" class="headerlink" title="Setting BBU"></a>Setting BBU</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ storcli /cx/bbu <span class="built_in">set</span> learnDelayInterval=168 <span class="comment">#hours</span></span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show modes</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = Get BBU Modes Succeeded.</span><br><span class="line"></span><br><span class="line">Available BBU Modes :</span><br><span class="line">===================</span><br><span class="line">Mode-1 = 12+ Hrs retention with a transparent learn cycle and best service life.</span><br><span class="line">Mode-3 = 24+ Hrs retention with a transparent learn cycle and balanced service life.</span><br><span class="line">Mode-4 = 48+ Hrs retention with a non-transparent learn cycle and balanced service life</span><br><span class="line"></span><br><span class="line">$ storcli /cx/bbu <span class="built_in">set</span> bbuMode=&lt;value&gt;</span><br><span class="line">0 48 hours of retentiona at 60 °C, 1-year Service Life.</span><br><span class="line">a. Indicates how long the battery can hold data <span class="keyword">in</span> the controller<span class="string">&#x27;s memory in case of accidental system shutdown.</span></span><br><span class="line"><span class="string">1 12 hours of retention at 45 °C, 5-year Service Life, transparent learn.b</span></span><br><span class="line"><span class="string">b. The controller&#x27;</span>s performance is not affected during the battery<span class="string">&#x27;s learn cycle.</span></span><br><span class="line"><span class="string">2 12 hours of retention at 55 °C, 3-year Service Life, transparent learn.</span></span><br><span class="line"><span class="string">3 24 hours of retention at 45 °C, 3-year Service Life, transparent learn.</span></span><br><span class="line"><span class="string">4 48 hours of retention at 45 °C, 3-year Service Life.</span></span><br><span class="line"><span class="string">5 48 hours of retention at 55 °C, 1-year Service Life.</span></span><br><span class="line"><span class="string">6 Same as the description for BBU mode 5. The BBU mode 6 enables you to receive events when the battery capacity reaches suboptimal and critical thresholds.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ storcli /cx bbu set autolearnmode=&lt;value&gt;</span></span><br><span class="line"><span class="string">where x= 0 – Enabled, 1 – Disabled, 2 – Warn though event.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Manual learn battery</span></span><br><span class="line"><span class="string">$ storcli /c0/bbu start learn</span></span><br></pre></td></tr></table></figure><h4 id="Cachevault"><a href="#Cachevault" class="headerlink" title="Cachevault"></a><a href="https://www.thomas-krenn.com/en/wiki/CacheVault_Flash_Cache">Cachevault</a></h4><p>Here is not install cachevalut, all FLASH devices don’t need it, because fastpath need writethrough mode</p><p>No battery is used with CacheVault technology. The cache content is protected by the following systems:</p><ul><li>A double-layer capacitor is connected to the RAID controller.</li><li>This will be fully loaded automatically during server startup.</li><li>In case of power failure the RAID controller uses the power of the capacitor to write the Flash-Memory to maintain all contents of the cache non-volatile (almost like a USB stick).</li><li>The next time the server is started the RAID controller writes the data from the Flash-Memory to the RAID Array.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0/cv show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Failure</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line">Detailed Status :</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">----------------------------------------------------</span><br><span class="line">Ctrl Status Property ErrMsg                   ErrCd</span><br><span class="line">----------------------------------------------------</span><br><span class="line">   0 Failed -        Cachevault doesn<span class="string">&#x27;t exist   255</span></span><br><span class="line"><span class="string">----------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv show all</span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv show learn</span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv show status</span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv start learn</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h4 id="Get-all-megaraid-log-not-filter"><a href="#Get-all-megaraid-log-not-filter" class="headerlink" title="Get all megaraid log, not filter"></a>Get all megaraid log, not filter</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shows the history of log files generated</span></span><br><span class="line">$ storcli64  /call show eventloginfo file=logfile</span><br><span class="line">$ MegaCli64 -AdpEventLog -GetEvents -f logfile -aALL</span><br><span class="line"></span><br><span class="line"><span class="comment">#prints the system log</span></span><br><span class="line">$ storcli64 /c0 show events file=megaraid_events.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># shows the firmware logs</span></span><br><span class="line">$ storcli64 /c0 show termlog </span><br><span class="line">$ storcli64 /c0 show termlog <span class="built_in">type</span>=config</span><br><span class="line">$ storcli64 /c0 show termlog <span class="built_in">type</span>=contents</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Show-raid-logic-info"><a href="#Show-raid-logic-info" class="headerlink" title="Show raid logic info"></a>Show raid logic info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /cx/dall show [all]</span><br><span class="line">$ MegaCli64 -cfgdsply -aALL</span><br></pre></td></tr></table></figure><h4 id="Import-license"><a href="#Import-license" class="headerlink" title="Import license"></a>Import license</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli /c0 <span class="built_in">set</span> aso key=xxxxxxxxx</span><br></pre></td></tr></table></figure><h4 id="Backup-config"><a href="#Backup-config" class="headerlink" title="Backup config"></a>Backup config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli -CfgSave -f filename -aN   </span><br><span class="line">$ MegaCli -CfgRestore -f filename -aN  </span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 <span class="built_in">set</span> config file=raid_adapter0.config</span><br><span class="line">$ storcli64 /c0 get config file=raid_adapter0.config</span><br></pre></td></tr></table></figure><h4 id="Interrupt-BGI"><a href="#Interrupt-BGI" class="headerlink" title="Interrupt BGI"></a>Interrupt BGI</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64 -LDBI -Abort -LALL -aALL</span><br><span class="line">$ storcli64 /call/vall <span class="built_in">set</span> autobgi=On|Off</span><br><span class="line">$ storcli64 /call/vall show autobgi</span><br><span class="line">$ storcli64 /call/vall stop bgi</span><br><span class="line">$ storcli64 /call/vall pause bgi</span><br><span class="line">$ storcli64 /call/vall resume bgi</span><br><span class="line">$ storcli64 /call/vall show bgi</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> bgirate=90</span><br></pre></td></tr></table></figure><h4 id="Rebuild-Migrate-init"><a href="#Rebuild-Migrate-init" class="headerlink" title="Rebuild/Migrate/init"></a>Rebuild/Migrate/init</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64  -AdpSetProp RebuildRate 50 -a0</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> rebuildrate=50</span><br><span class="line"></span><br><span class="line">$ MegaCli64  -AdpSetProp ReconRate 50 -a0</span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -LDRecon ShowProg L1  -a0</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> migraterate=50</span><br><span class="line">$ storcli /c0/v1 show migrate</span><br><span class="line">$ storcli /c0/v1 start migrate <span class="built_in">type</span>=raidx</span><br><span class="line"></span><br><span class="line"><span class="comment">#  automatic background initialization</span></span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -LDBI -ShowProg -LALL -aALL</span><br><span class="line">$ storcli /call/vall <span class="built_in">set</span> autobgi=on</span><br><span class="line">$ storcli /call/vall show autobgi</span><br><span class="line">$ storcli /call/vall stop bgi</span><br><span class="line">$ storcli /call/vall pause bgi</span><br><span class="line">$ storcli /call/vall resume bgi</span><br><span class="line">$ storcli /call/vall show bgi</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtual drive initialization</span></span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -LDInit ShowProg Lall a0</span><br><span class="line">$ storcli /c0/vall start init</span><br><span class="line">$ storcli /c0/vall stop init</span><br><span class="line">$ storcli /c0/vall show init</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Make-device-good"><a href="#Make-device-good" class="headerlink" title="Make device good"></a>Make device good</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64 -PDMakeGood -PhysDrv[20:12] -a0</span><br><span class="line">$ storcli64 /c0/e20/s12 <span class="built_in">set</span> good force</span><br></pre></td></tr></table></figure><h4 id="Make-JBOD"><a href="#Make-JBOD" class="headerlink" title="Make JBOD"></a>Make JBOD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64 -PDMakeJBOD -PhysDrv[E0:S0,E1:S1,...] -aN|-a0,1,2|-aALL</span><br><span class="line">$ storcli64 /c0/e20/s12 <span class="built_in">set</span> jbod (default on)</span><br><span class="line">$ storcli64 /c0 <span class="built_in">set</span> jbod = on/off</span><br><span class="line"></span><br><span class="line">$ MegaCli -AdpSetProp -EnableJBOD -val -aN|-a0,1,2|-aALL</span><br><span class="line">      val - 0=Disable JBOD mode.</span><br><span class="line">            1=Enable JBOD mode.</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 <span class="built_in">set</span> jbod=on</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Foreign-devices"><a href="#Foreign-devices" class="headerlink" title="Foreign devices"></a>Foreign devices</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64  -CfgForeign -Clear -aALL</span><br><span class="line">$ storcli64 /c0/fall del|delete</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0/fall show</span><br><span class="line">$ storcli64 /c0/fall import</span><br></pre></td></tr></table></figure><h3 id="About-Consistency-and-patrol-read"><a href="#About-Consistency-and-patrol-read" class="headerlink" title="About Consistency and patrol read"></a><a href="https://www.digiliant.com/docs/MegaRAID-SAS-Software-User-Guide-12Gbs.pdf">About Consistency and patrol read</a></h3><h4 id="Patrol-read"><a href="#Patrol-read" class="headerlink" title="Patrol read"></a>Patrol read</h4><p>Patrol read involves the review of your system for possible drive errors that could lead to drive failure and then action to correct errors. The goal is to protect data integrity by detecting drive failure before the failure can damage data. The corrective actions depend on the drive group configuration and the type of errors.<br>Patrol read starts only when the controller is idle for a defined period of time and no other background tasks are active, though it can continue to run during heavy I/O processes.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show patrolRead</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">---------------------------------------------</span><br><span class="line">Ctrl_Prop               Value</span><br><span class="line">---------------------------------------------</span><br><span class="line">PR Mode                 Auto</span><br><span class="line">PR Execution Delay      168 hours</span><br><span class="line">PR iterations completed 0</span><br><span class="line">PR Next Start time      08/24/2019, 03:00:00</span><br><span class="line">PR on SSD               Disabled</span><br><span class="line">PR on EPD               Disabled</span><br><span class="line">PR Current State        Stopped</span><br><span class="line">---------------------------------------------</span><br><span class="line"><span class="comment"># mode=auto/manual</span></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> patrolread=on mode=auto includessds=on maxconcurrentpd=255 delay=360 <span class="comment">#255 phy devs ,360 housr(15days)</span></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> patrolread=on mode=auto starttime=2019/08/24 03</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> patrolread=off</span><br><span class="line"></span><br><span class="line"><span class="comment">##show/stop/start/resume/pause</span></span><br><span class="line">$ storcli64 /call start patrolRead </span><br><span class="line">$ storcli64 /call show patrolRead</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">----------------------------------</span><br><span class="line">Ctrl_Prop               Value</span><br><span class="line">----------------------------------</span><br><span class="line">PR Mode                 Auto</span><br><span class="line">PR Execution Delay      360 hours</span><br><span class="line">PR iterations completed 352</span><br><span class="line">PR on SSD               Enabled</span><br><span class="line">PR Current State        Stopped</span><br><span class="line">----------------------------------</span><br><span class="line"></span><br><span class="line">$ storcli64 /call show prrate</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> prrate=40</span><br></pre></td></tr></table></figure><h4 id="Consistency-Check"><a href="#Consistency-Check" class="headerlink" title="Consistency Check"></a>Consistency Check</h4><p>checking consistency means calculating the data on one drive and comparing the results to the contents of the parity drive<br>It is recommended that you perform a consistency check at least once a month.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show cc</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">-----------------------------------------------</span><br><span class="line">Ctrl_Prop                 Value</span><br><span class="line">-----------------------------------------------</span><br><span class="line">CC Operation Mode         Concurrent</span><br><span class="line">CC Execution Delay        168</span><br><span class="line">CC Next Starttime         08/24/2019, 02:00:00</span><br><span class="line">CC Current State          Stopped</span><br><span class="line">CC Number of iterations   311</span><br><span class="line">CC Number of VD completed 2</span><br><span class="line">CC Excluded VDs           None</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line">$ storcli64 /call show ccrate</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> ccrate=50</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#schedule</span></span><br><span class="line">$ storcli64 /call/vall <span class="built_in">set</span> cc=seq </span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> cc=seq starttime=2019/08/31 02 delay=1440  <span class="comment">## check interval 1440 hours ,60 days</span></span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">Ctrl_Prop    Value</span><br><span class="line">---------------------------------</span><br><span class="line">CC Mode      SEQ</span><br><span class="line">CC Starttime 2019/08/31 02:00:00</span><br><span class="line">CC delay     1440</span><br><span class="line">---------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">### if I &#x27;m not set start time</span></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> cc=seq delay=1440</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">Ctrl_Prop Value</span><br><span class="line">----------------</span><br><span class="line">CC Mode   SEQ</span><br><span class="line">CC delay  1440</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 show cc</span><br><span class="line">CC Operation Mode         Sequential</span><br><span class="line">CC Execution Delay        1440</span><br><span class="line">CC Next Starttime         08/24/2019, 03:00:00 <span class="comment">## first start after about 12 hours</span></span><br><span class="line">CC Current State          Stopped</span><br><span class="line">CC Number of iterations   120</span><br><span class="line">CC Number of VD completed 1</span><br><span class="line">CC Excluded VDs           None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### show again</span></span><br><span class="line">$ storcli64 /c0 show cc</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">-----------------------------------------------</span><br><span class="line">Ctrl_Prop                 Value</span><br><span class="line">-----------------------------------------------</span><br><span class="line">CC Operation Mode         Sequential</span><br><span class="line">CC Execution Delay        1440</span><br><span class="line">CC Next Starttime         08/31/2019, 02:00:00</span><br><span class="line">CC Current State          Stopped</span><br><span class="line">CC Number of iterations   311</span><br><span class="line">CC Number of VD completed 2</span><br><span class="line">CC Excluded VDs           None</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#manual start and show status</span></span><br><span class="line"><span class="comment">#show/stop/start/resume/pause</span></span><br><span class="line">$ storcli64 /call/vall start cc [force]</span><br><span class="line">$ storcli64 /call/vall show cc</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VD Operation Status :</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line">VD Operation Progress% Status</span><br><span class="line">-----------------------------------</span><br><span class="line"> 0 CC                0 In progress</span><br><span class="line"> 1 CC                1 In progress</span><br><span class="line">-----------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ storcli64 /call/vall stop cc</span><br></pre></td></tr></table></figure><h3 id="Montor-cache-ECC-count"><a href="#Montor-cache-ECC-count" class="headerlink" title="Montor cache ECC count"></a>Montor cache ECC count</h3><p>eccbucketleakrate 0 to 65535 Sets the leak rate of the single-bit bucket in minutes (one entry removed per leak-rate).<br>eccbucketsize 0 to 255 Sets the size of ECC single-bit-error bucket (logs event when full).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show all | grep Bucket</span><br><span class="line">ECC Bucket Count = 0</span><br><span class="line">ECC Bucket Size = 255</span><br><span class="line">ECC Bucket Leak Rate (hrs) = 4</span><br></pre></td></tr></table></figure><h3 id="About-device-write-cache-in-megaraid"><a href="#About-device-write-cache-in-megaraid" class="headerlink" title="About device write cache in megaraid"></a><a href="https://utcc.utoronto.ca/~cks/space/blog/tech/ModernDiskWriteCaches">About device write cache in megaraid</a></h3><p>drives can also support a write option called ‘Force Unit Access’ (FUA) that bypasses the write cache in order to force what you’re writing to be forced to disk. In general FUA is bundled with another feature called ‘Disable Page Out’ (DPO), which tells the drive that putting the data into cache is not useful.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">$ Virtual Drives = 2</span><br><span class="line"></span><br><span class="line">VD LIST :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">DG/VD TYPE  State Access Consist Cache Cac sCC     Size Name</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">0/0   RAID1 Optl  RW     Yes     NRWTD -   OFF 223.0 GB R1OS</span><br><span class="line">1/1   RAID5 Optl  RW     Yes     RWTD  -   OFF 1.307 TB</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Cac=CacheCade|Rec=Recovery|OfLn=OffLine|Pdgd=Partially Degraded|dgrd=Degraded</span><br><span class="line">Optl=Optimal|RO=Read Only|RW=Read Write|HD=Hidden|B=Blocked|Consist=Consistent|</span><br><span class="line">R=Read Ahead Always|NR=No Read Ahead|WB=WriteBack|</span><br><span class="line">AWB=Always WriteBack|WT=WriteThrough|C=Cached IO|D=Direct IO|sCC=Scheduled</span><br><span class="line">Check Consistency</span><br><span class="line"></span><br><span class="line">Physical Drives = 6</span><br><span class="line"></span><br><span class="line">PD LIST :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">EID:Slt DID State DG       Size Intf Med SED PI SeSz Model         Sp</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">32:0      0 Onln   0   223.0 GB SATA SSD N   N  512B THNSF8240CCSE U</span><br><span class="line">32:1      1 Onln   0   223.0 GB SATA SSD N   N  512B THNSF8240CCSE U</span><br><span class="line">32:2      2 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">32:3      3 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">32:4      4 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">32:5      5 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ dmesg -T | grep DPO</span><br><span class="line">[Tue Nov  5 23:21:47 2019] sd 0:2:1:0: [sdb] Write cache: disabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">[Tue Nov  5 23:21:47 2019] sd 0:2:0:0: [sda] Write cache: disabled, <span class="built_in">read</span> cache: disabled, supports DPO and FUA</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0/vall <span class="built_in">set</span> wrcache=WT rdcache=nora iopolicy=direct</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line">Detailed Status :</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">VD Property Value  Status  ErrCd ErrMsg</span><br><span class="line">----------------------------------------</span><br><span class="line"> 0 wrCache  WT     Success     0 -</span><br><span class="line"> 0 rdCache  NoRA   Success     0 -</span><br><span class="line"> 0 IoPolicy Direct Success     0 -</span><br><span class="line"> 1 wrCache  WT     Success     0 -</span><br><span class="line"> 1 rdCache  NoRA   Success     0 -</span><br><span class="line"> 1 IoPolicy Direct Success     0 -</span><br><span class="line">----------------------------------------</span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$ dmesg -T | grep DPO</span><br><span class="line">[Thu Nov  7 02:37:51 2019] sd 0:2:0:0: [sda] Write cache: disabled, <span class="built_in">read</span> cache: disabled, supports DPO and FUA</span><br><span class="line">[Thu Nov  7 02:37:51 2019] sd 0:2:1:0: [sdb] Write cache: disabled, <span class="built_in">read</span> cache: disabled, supports DPO and FUA</span><br><span class="line"></span><br><span class="line">Supported VD Operations :</span><br><span class="line">=======================</span><br><span class="line">Read Policy = Yes</span><br><span class="line">Write Policy = Yes</span><br><span class="line">IO Policy = Yes</span><br><span class="line">Access Policy = Yes</span><br><span class="line">Disk Cache Policy = Yes</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0/v0 <span class="built_in">set</span> wrcache=WB</span><br><span class="line">VD Property Value Status  ErrCd ErrMsg</span><br><span class="line">---------------------------------------</span><br><span class="line"> 0 wrCache  WB    Success     0 -</span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$  dmesg -T | grep DPO</span><br><span class="line">[Thu Nov  7 02:53:00 2019] sd 0:2:0:0: [sda] Write cache: disabled, <span class="built_in">read</span> cache: disabled, doesn<span class="string">&#x27;t support DPO or FUA</span></span><br><span class="line"><span class="string">[Thu Nov  7 02:53:00 2019] sd 0:2:1:0: [sdb] Write cache: disabled, read cache: disabled, supports DPO and FUA</span></span><br></pre></td></tr></table></figure><p>You could change megaraid cache policy, let the device support DPO and FUA</p><h3 id="Backup-and-restore-config-file"><a href="#Backup-and-restore-config-file" class="headerlink" title="Backup and restore config file"></a>Backup and restore config file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#backup controller config to file;</span></span><br><span class="line">./storcli64 /c0 get config file=megaraid.cfg</span><br><span class="line">./storcli64 /c0 <span class="built_in">set</span> config file=megaraid.cfg</span><br><span class="line"><span class="comment">#Clear a Configuration; dangerous</span></span><br><span class="line"><span class="comment">###./storcli64 /c0 delete config[force]</span></span><br></pre></td></tr></table></figure><h3 id="Flush-RAID-write-cache"><a href="#Flush-RAID-write-cache" class="headerlink" title="Flush RAID write cache"></a>Flush RAID write cache</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Cache Flush on Selected Controller</span></span><br><span class="line">$ MegaCli64 –AdpCacheFlush -aN|-a0,1,2|-aALL</span><br><span class="line">$ storcli64 /c0 <span class="keyword">set</span> flushwriteverify=<span class="keyword">on</span></span><br><span class="line">$ storcli64 /c0 <span class="keyword">show</span> flushwriteverify </span><br><span class="line">$ storcli64 /c0 flushcache</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0 flushcache</span><br><span class="line">Controller = <span class="number">0</span></span><br><span class="line"><span class="keyword">Status</span> = <span class="keyword">Success</span></span><br><span class="line">Description = Adapter <span class="keyword">and</span>/<span class="keyword">or</span> disk caches flushed successfully.</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete the preserved cache for a particular virtual driver on the controller in missing state</span></span><br><span class="line">$ perccli64 /c0/v1 <span class="keyword">delete</span> preservedCache </span><br><span class="line">$ storcli64 /c0/v1 <span class="keyword">delete</span> preservedCache <span class="keyword">force</span></span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 <span class="keyword">show</span> preservedCache</span><br><span class="line">Controller = <span class="number">0</span></span><br><span class="line"><span class="keyword">Status</span> = <span class="keyword">Success</span></span><br><span class="line">Description = <span class="keyword">No</span> <span class="keyword">Virtual</span> Drive has Preserved <span class="keyword">Cache</span> Data.</span><br></pre></td></tr></table></figure><h3 id="show-PHY"><a href="#show-PHY" class="headerlink" title="show PHY"></a>show PHY</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ storcli /cx/px|pall <span class="built_in">set</span> linkspeed=0(auto)|1.5|3|6|12</span><br><span class="line">$ perccli64 /c0/pall show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PhyInfo :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">PhyNo SAS_Addr           Phy_Identifier Link_Speed Device_Type   Description</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">    0 0x500056B3BECB2FFF             17 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    1 0x500056B3BECB2FFF             20 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    2 0x500056B3BECB2FFF             18 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    3 0x500056B3BECB2FFF             23 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    4 0x500056B3BECB2FFF             19 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    5 0x500056B3BECB2FFF             21 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    6 0x500056B3BECB2FFF             16 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    7 0x500056B3BECB2FFF             22 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ perccli64 /call/eall show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Properties :</span><br><span class="line">==========</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line">EID State Slots PD PS Fans TSs Alms SIM Port<span class="comment"># ProdID VendorSpecific</span></span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line"> 32 OK        8  6  0    0   0    0   0 00 x1 BP14G+  !   ?</span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">EID-Enclosure Device ID |PD-Physical drive count |PS-Power Supply count|</span><br><span class="line">TSs-Temperature sensor count |Alms-Alarm count |SIM-SIM Count</span><br><span class="line"></span><br><span class="line">$ perccli64 /call/eall show status</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"><span class="comment"># upgrade the enclosure</span></span><br><span class="line">$ storcli64 /c0/e32 download src=enclosure_fw.bin</span><br></pre></td></tr></table></figure><h3 id="Foreign-configurations"><a href="#Foreign-configurations" class="headerlink" title="Foreign configurations"></a>Foreign configurations</h3><p>NOTE Provide the security key when importing a locked foreign configuration created in a different machine that is encrypted with a security key.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0/fall show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = Couldn<span class="string">&#x27;t find any foreign Configuration</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ storcli64 /c0/fall import</span></span><br><span class="line"><span class="string">$ storcli64 /cx/fx|fall show [all][ securitykey=sssssssssss ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#This command deletes the foreign configuration of a controller.</span></span><br><span class="line"><span class="string">$ ### storcli64 /c0/fall delete</span></span><br></pre></td></tr></table></figure><h3 id="Dimmer-switch"><a href="#Dimmer-switch" class="headerlink" title="Dimmer switch"></a>Dimmer switch</h3><p>The Dimmer Switch is the power-saving policy for the virtual drive</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0 show ds</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">-------------------------------</span><br><span class="line">Ctrl_Prop         Value</span><br><span class="line">-------------------------------</span><br><span class="line">SpnDwnUncDrv      Disabled</span><br><span class="line">SpnDwnHS          Disabled</span><br><span class="line">SpnDwnTm          30 minute(s)</span><br><span class="line">SpnDwnCfgDrv      Disabled</span><br><span class="line">DefaultLdPSPolicy None</span><br><span class="line">DsblLdPsInterval  0 hours</span><br><span class="line">DsblLdPsTime      0 minutes</span><br><span class="line">SpnUpEncDly       8 second(s)</span><br><span class="line">spinUpEncDrvCnt   6</span><br><span class="line">-------------------------------</span><br><span class="line"></span><br><span class="line">$ storcli /cx/vx <span class="built_in">set</span> ds=default | auto | none | max | maxnocache</span><br><span class="line">auto: Logical device power savings are managed by the firmware.</span><br><span class="line">none: No power saving policy.</span><br><span class="line">max: Logical device uses maximum power savings.</span><br><span class="line">maxnocache: Logical device does not cache write to maximise power savings.</span><br><span class="line"></span><br><span class="line">$ storcli64  /c0 <span class="built_in">set</span> ds=on <span class="built_in">type</span>=1|2</span><br><span class="line">1: Unconfigured</span><br><span class="line">2: Hot spare</span><br><span class="line">3: Virtual drive</span><br><span class="line">4: All</span><br><span class="line"></span><br><span class="line">$ storcli /cx <span class="built_in">set</span> ds=on [properties]</span><br><span class="line">disableldps: Interval <span class="keyword">in</span> hours or time <span class="keyword">in</span> hh:mm format</span><br><span class="line">spinupdrivecount: Valid enclosure number (0 to 255)</span><br><span class="line">SpinUpEncDelay: Valid time <span class="keyword">in</span> seconds</span><br></pre></td></tr></table></figure><h3 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /cx[/ex]/sx spindown</span><br><span class="line">$ storcli64 /cx[/ex]/sx spinup</span><br><span class="line"></span><br><span class="line">$ storcli64 /cx[/ex]/sx secureerase [force]</span><br><span class="line">$ storcli64 /cx[/ex]/sx start erase [simple|normal|thorough] [erasepatternA=&lt;value1&gt;] [erasepatternB=&lt;value2&gt;]</span><br><span class="line">$ storcli64 /cx[/ex]/sx stop erase</span><br></pre></td></tr></table></figure><h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><h4 id="log"><a href="#log" class="headerlink" title="log"></a>log</h4><p>— 0 – NA<br>— 1– SET<br>— 2 – CLEAR<br>— 3 – CLEAR ALL<br>— 4 – DEBUG DUMP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /call show all logfile=megaraid.cfg</span><br><span class="line">$ storcli64 /c x <span class="built_in">set</span> debug reset all </span><br><span class="line">$ storcli64 /call x <span class="built_in">set</span> debug <span class="built_in">type</span> = &lt;value&gt; option = &lt;value&gt; level = [&lt;value <span class="keyword">in</span> hex&gt;]</span><br><span class="line"><span class="comment">#type – takes the value from 0 – 128, mapping each number to a particular debug variable in the firmware.</span></span><br><span class="line">$ <span class="comment">#storcli64 /call delete events</span></span><br><span class="line">$ <span class="comment">#storcli64 /call delete termlog</span></span><br><span class="line"></span><br><span class="line">$ storcli64 /call show events file=events.log</span><br><span class="line">$ storcli64 /call show termlog <span class="built_in">type</span>=config logfile=termlog.config</span><br><span class="line">$ storcli64 /call show termlog <span class="built_in">type</span>=contents logfile=termlog.contents</span><br><span class="line">$ storcli64 /call show eventloginfo logfile=event.info</span><br><span class="line">$ storcli64 /call show dequeuelog file=dequeue.log</span><br><span class="line">$ storcli64 /call show alilog logfile=ali.log</span><br></pre></td></tr></table></figure><h4 id="Encolsure"><a href="#Encolsure" class="headerlink" title="Encolsure"></a>Encolsure</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /call/eall download src=encolsure.bin</span><br><span class="line">$ perccli64 /call/eall show all</span><br><span class="line">$ perccli64 /call/eall show status </span><br></pre></td></tr></table></figure><h4 id="phy-err"><a href="#phy-err" class="headerlink" title="phy err"></a>phy err</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">storcli /cx/px|pall show</span><br><span class="line">storcli /cx/px|pall show all</span><br><span class="line">storcli /cx/ex show phyerrorcounters</span><br><span class="line">storcli /cx[/ex]/sx show phyerrorcounters</span><br><span class="line">storcli /cx[/ex]/sx reset phyerrorcounters</span><br><span class="line">storcli /cx/px|pall <span class="built_in">set</span> linkspeed=0(auto)|1.5|3|6|12</span><br></pre></td></tr></table></figure><h4 id="diag-adapter"><a href="#diag-adapter" class="headerlink" title="diag adapter"></a>diag adapter</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0 start diag duration=10 logfile=diag.log</span><br></pre></td></tr></table></figure><h4 id="Enable-SEP-for-Dell-PERC"><a href="#Enable-SEP-for-Dell-PERC" class="headerlink" title="Enable SEP for Dell PERC"></a>Enable SEP for Dell PERC</h4><p>Configures enclosure detection on a non-SES/expander backplane.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /call <span class="built_in">set</span> backplane mode=0 expose=on</span><br><span class="line">0: Use autodetect logic of backplanes, such as SGPIO and I2C SEP using GPIO pins.</span><br><span class="line">1: Disable autodetect SGPIO.</span><br><span class="line">2: Disable I2C SEP autodetect.</span><br><span class="line">3: Disable both the autodetects.</span><br><span class="line"></span><br><span class="line">backplane expose: Enables or disables device drivers to expose enclosure devices; <span class="keyword">for</span> example, expanders, SEPs.</span><br><span class="line"></span><br><span class="line">$ perccli64 /call <span class="built_in">set</span> sesmonitoring=on</span><br></pre></td></tr></table></figure><h3 id="Enable-JBOD"><a href="#Enable-JBOD" class="headerlink" title="Enable JBOD"></a>Enable JBOD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /call <span class="built_in">set</span> jbod=on</span><br></pre></td></tr></table></figure><h3 id="SAS-loading-balance"><a href="#SAS-loading-balance" class="headerlink" title="SAS loading balance"></a>SAS loading balance</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /cx <span class="built_in">set</span> loadbalancemode=on</span><br></pre></td></tr></table></figure><h3 id="Driver-performance"><a href="#Driver-performance" class="headerlink" title="Driver performance"></a>Driver performance</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /call <span class="built_in">set</span> DPM=on</span><br><span class="line"><span class="comment">#Enables or disables drive performance monitoring</span></span><br><span class="line"></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> ncq=on</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> perfmode=1 <span class="comment">#default was 0</span></span><br><span class="line">0: Tuned to provide best IOPS, currently applicable to non-FastPath</span><br><span class="line">1: Tuned to provide least latency, currently applicable to non-FastPath</span><br></pre></td></tr></table></figure><h4 id="Get-smart-info-from-LSI-megaraid"><a href="#Get-smart-info-from-LSI-megaraid" class="headerlink" title="Get smart info from LSI megaraid"></a>Get smart info from LSI megaraid</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl -s on -a -d megaraid,1 /dev/sda -T permissive</span><br><span class="line">$ smartctl -s on -a -d megaraid,0 /dev/sda -T permissive</span><br><span class="line">smartctl 6.5 2016-05-07 r4318 [x86_64-linux-3.10.0-957.1.3.el7.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">=== START OF INFORMATION SECTION ===</span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUSMM1616ASS204</span><br><span class="line">Revision:             L380</span><br><span class="line">Compliance:           SPC-4</span><br><span class="line">User Capacity:        1,600,321,314,816 bytes [1.60 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br><span class="line">LU is resource provisioned, LBPRZ=1</span><br><span class="line">Rotation Rate:        Solid State Device</span><br><span class="line">Form Factor:          2.5 inches</span><br><span class="line">Logical Unit id:      0x0000000000000000</span><br><span class="line">Serial number:        0000000</span><br><span class="line">Device <span class="built_in">type</span>:          disk</span><br><span class="line">Transport protocol:   SAS (SPL-3)</span><br><span class="line">Local Time is:        Thu Dec 27 15:44:50 2018 CST</span><br><span class="line">SMART support is:     Available - device has SMART capability.</span><br><span class="line">SMART support is:     Enabled</span><br><span class="line">Temperature Warning:  Disabled or Not Supported</span><br><span class="line"></span><br><span class="line">=== START OF ENABLE/DISABLE COMMANDS SECTION ===</span><br><span class="line">Informational Exceptions (SMART) enabled</span><br><span class="line">Temperature warning enabled</span><br><span class="line"></span><br><span class="line">=== START OF READ SMART DATA SECTION ===</span><br><span class="line">SMART Health Status: OK</span><br><span class="line"></span><br><span class="line">Percentage used endurance indicator: 0%</span><br><span class="line">Current Drive Temperature:     32 C</span><br><span class="line">Drive Trip Temperature:        60 C</span><br><span class="line"></span><br><span class="line">Manufactured <span class="keyword">in</span> week 53 of year 2016</span><br><span class="line">Specified cycle count over device lifetime:  0</span><br><span class="line">Accumulated start-stop cycles:  0</span><br><span class="line">Specified load-unload count over device lifetime:  0</span><br><span class="line">Accumulated load-unload cycles:  0</span><br><span class="line">Vendor (Seagate) cache information</span><br><span class="line">  Blocks sent to initiator = 6325615015755776</span><br><span class="line"></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0        0         0         0          0       6874.841           0</span><br><span class="line">write:         0        0         0         0          0      10898.936           0</span><br><span class="line">verify:        0        0         0         0          0         32.879           0</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br></pre></td></tr></table></figure><h3 id="performance-monitor"><a href="#performance-monitor" class="headerlink" title="performance monitor"></a>performance monitor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0 show dpm</span><br><span class="line">$ perccli64 /c0 <span class="built_in">set</span> dpm=on</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0 delete dpmstat <span class="built_in">type</span> = Hist | LCT | RA |EXT [logfile=filename]</span><br><span class="line">$ perccli64 /c0 show dpmstat <span class="built_in">type</span> = Hist | LCT | RA |EXT [logfile=filename]</span><br><span class="line">$ storcli64 /c0 start dpm</span><br><span class="line">$ storcli64 /c0 stop dpm</span><br><span class="line"></span><br><span class="line">MR 7.14 storcli64 version</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = HIST logfile=9460-16i_dpmstat_HIST.txt</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = LCT logfile=9460-16i_dpmstat_LCT.txt</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = RA logfile=9460-16i_dpmstat_RA.txt</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = EXT logfile=9460-16i_dpmstat_EXT.txt</span><br><span class="line"></span><br><span class="line">MR 9361-8i use MR 6.14, storcli 1.2.xx</span><br><span class="line">$ storcli64 -DpmStat -Dsply lct -physdrv [10:0] -a0</span><br><span class="line"></span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Enclosure Device ID: 32</span><br><span class="line">Slot Number: 0</span><br><span class="line">Device Id: 0</span><br><span class="line">                    Resp</span><br><span class="line">Date    |   Time  | Time(ms) | CDB/ATA Task File(hex)</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line"></span><br><span class="line">$ storcli64 -DpmStat -Dsply ra -physdrv [10:0] -a0</span><br><span class="line"></span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Requested data: Running Average Drive Statistics</span><br><span class="line"></span><br><span class="line">Enclosure   Slot                           Queue      Xfer       Resp</span><br><span class="line">Device ID | Number | Device Id |  IOPs  |  Depth  |   Rate    |  Time</span><br><span class="line">          |        |           |        |         |   (MB/s)  |  (ms)</span><br><span class="line"></span><br><span class="line">32          3        3          0        0         0.0000       0.0000</span><br><span class="line"></span><br><span class="line">$ storcli64 -DpmStat -Dsply hist -physdrv [10:0] -a0</span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Enclosure Device ID: 32</span><br><span class="line">Slot Number: 3</span><br><span class="line">Device Id: 3</span><br><span class="line"></span><br><span class="line">------------------------------------------</span><br><span class="line">Bin       Respose Time (ms)   IO Count</span><br><span class="line">------------------------------------------</span><br><span class="line">1         1                   0</span><br><span class="line">2         2                   0</span><br><span class="line">3         3                   0</span><br><span class="line">4         4                   0</span><br><span class="line">5         5                   0</span><br><span class="line">6         6                   0</span><br><span class="line">7         7                   0</span><br><span class="line">8         8                   0</span><br><span class="line">9         9                   0</span><br><span class="line">10        10                  0</span><br><span class="line">11        20                  0</span><br><span class="line">12        30                  0</span><br><span class="line">13        40                  0</span><br><span class="line">14        50                  0</span><br><span class="line">15        60                  0</span><br><span class="line">16        70                  0</span><br><span class="line">17        80                  0</span><br><span class="line">18        90                  0</span><br><span class="line">19        100                 0</span><br><span class="line">20        200                 0</span><br><span class="line">21        300                 0</span><br><span class="line">22        400                 0</span><br><span class="line">23        500                 0</span><br><span class="line">24        600                 0</span><br><span class="line">25        700                 0</span><br><span class="line">26        800                 0</span><br><span class="line">27        900                 0</span><br><span class="line">28        1000                0</span><br><span class="line">29        2000                0</span><br><span class="line">30        3000                0</span><br><span class="line">31        4000                0</span><br><span class="line">32        5000                0</span><br><span class="line">33        6000                0</span><br><span class="line">34        7000                0</span><br><span class="line">35        8000                0</span><br><span class="line">36        9000                0</span><br><span class="line">37        10000               0</span><br><span class="line">38        10000+              0</span><br><span class="line">------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ storcli64 -DpmStat -Dsply ext -physdrv [10:0] -a0</span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Enclosure Device ID: 32</span><br><span class="line">Slot Number: 3</span><br><span class="line">Device Id: 3</span><br><span class="line">  Sectors                                      Commands</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Read        Write       Write-FUA      Read        Write       Write-FUA  Flush</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">0           0           0              0           0           0           0</span><br></pre></td></tr></table></figure><h3 id="T10-PI-for-megaraid"><a href="#T10-PI-for-megaraid" class="headerlink" title="T10 PI for megaraid"></a>T10 PI for megaraid</h3><p><img src="/img/MegaRAID-setting-1.png"><br><a href="https://www.broadcom.com/support/knowledgebase/1211161502244/the-data-protection-feature---megaraid">Megaraid T10 PI</a><br>The Data Protection feature is an additional method of preventing data corruption by delivering end-to-end data integrity through the full I/O path from the application to the disk drive. This feature is officially called T-10 Protection Information (T-10 PI) and requires special hard drives with 520-byte sectors. The feature is essentially Parity which is done internally on the drives that support T-10 PI.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /cx <span class="built_in">set</span> pi state = off </span><br></pre></td></tr></table></figure><h3 id="About-T10-rebuild-assist-for-megaraid"><a href="#About-T10-rebuild-assist-for-megaraid" class="headerlink" title="About T10 rebuild assist for megaraid"></a><a href="https://www.dell.com/support/article/us/en/04/qna44044/perc9-under-certain-conditions-there-is-a-possible-data-integrity-issue-with-the-rapid-rebuild?lang=en">About T10 rebuild assist for megaraid</a></h3><p><code>Unstable</code></p><p>Dell PERC 9 controllers (H330, H730, H730P, and H830) introduced a feature called Rapid Rebuild that speeds up the time to rebuild failed drives in certain conditions. This feature is based on T10 Rebuild Assist. Dell has determined that there is a possibility for data integrity issues when this feature is used under certain conditions.</p><p><code>When the PERC is rebuilding the data for the &quot;bad&quot; sectors, it incorrectly writes data from cache to the failed drive instead of the hot spare. This results in data and associated parity not being written to the hot spare. In write through mode, parity errors will occur. In write back mode, errors will occur in both data and associated parity.</code></p><p>From the PERC Controller log if you see the below highlighted text you have encountered the issue.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C0:EVT<span class="comment">#395950-08/17/16 13:54:59: 114=State change on PD 0b(e0x20/s11) from OFFLINE(XX) to REBUILDASSIST(12)</span></span><br></pre></td></tr></table></figure><p>If you have not encountered this issue then to protect against this scenario please update your PERC H730, H730p, H830 controller firmware to 25.5.0.0018 and PERC H330 controller firmware to 25.5.0.0019 or later firmware which disables the Rapid Rebuild feature.</p><h4 id="Enable-T10-data-protection-in-LSI-9380-8e"><a href="#Enable-T10-data-protection-in-LSI-9380-8e" class="headerlink" title="Enable T10-data-protection in LSI 9380-8e"></a>Enable T10-data-protection in LSI 9380-8e</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make sure the sas device support the feature</span></span><br><span class="line">$ sg_vpd -p ei -l -v /dev/sdc</span><br><span class="line">    inquiry cdb: 12 01 86 00 <span class="built_in">fc</span> 00</span><br><span class="line">    inquiry: pass-through requested 252 bytes but got 64 bytes</span><br><span class="line">    inquiry cdb: 12 00 00 00 24 00</span><br><span class="line">extended INQUIRY data VPD page:</span><br><span class="line">   [PQual=0  Peripheral device <span class="built_in">type</span>: disk]</span><br><span class="line">  ACTIVATE_MICROCODE=1 [before final WRITE BUFFER]</span><br><span class="line"></span><br><span class="line">  SPT=1 [protection types 1 and 2 supported]</span><br><span class="line">...</span><br><span class="line">$ sg_format -v --long --format --size=512 --fmtpinfo=3 --pfu=0 /dev/sdX</span><br><span class="line"><span class="comment"># or you could set to 4K</span></span><br><span class="line">$ sg_format -v --long --format --size=4096 --fmtpinfo=3 --pfu=0 /dev/sdX</span><br><span class="line"></span><br><span class="line"><span class="comment"># first format, show an error</span></span><br><span class="line">    inquiry cdb: 12 00 00 00 24 00</span><br><span class="line">    HGST      HUS724030ALS640   A280   peripheral_type: disk [0x0]</span><br><span class="line">      PROTECT=1</span><br><span class="line">      &lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">    mode sense (10) cdb: 5a 10 01 00 00 00 00 00 <span class="built_in">fc</span> 00</span><br><span class="line">mode sense (10):  Fixed format, current;  Sense key: Unit Attention</span><br><span class="line"> Additional sense: Mode parameters changed</span><br><span class="line">MODE SENSE (10) <span class="built_in">command</span>, unit attention</span><br><span class="line"></span><br><span class="line"><span class="comment"># try second format, it &#x27;s worked</span></span><br><span class="line">    inquiry cdb: 12 00 00 00 24 00</span><br><span class="line">    HGST      HUS724030ALS640   A280   peripheral_type: disk [0x0]</span><br><span class="line">      PROTECT=1</span><br><span class="line">      &lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">    mode sense (10) cdb: 5a 10 01 00 00 00 00 00 <span class="built_in">fc</span> 00</span><br><span class="line">    mode sense (10): pass-through requested 252 bytes but got 36 bytes</span><br><span class="line">Mode Sense (block descriptor) data, prior to changes:</span><br><span class="line">  &lt;&lt;&lt; longlba flag <span class="built_in">set</span> (64 bit lba) &gt;&gt;&gt;</span><br><span class="line">  Number of blocks=5860533168 [0x15d50a3b0]</span><br><span class="line">  Block size=512 [0x200]</span><br><span class="line"></span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 10 seconds</span><br><span class="line">    ALL data on /dev/sds will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 5 seconds</span><br><span class="line">    ALL data on /dev/sds will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">    format cdb: 04 d8 00 00 00 00</span><br><span class="line"></span><br><span class="line"><span class="comment">## After format and switch the device to the LSI-9380-8e</span></span><br><span class="line"></span><br><span class="line">Basics :</span><br><span class="line">======</span><br><span class="line">Controller = 0</span><br><span class="line">Model = AVAGO MegaRAID SAS 9380-8e</span><br><span class="line">Serial Number = SV43821663</span><br><span class="line">Current Controller Date/Time = 04/30/2020, 03:38:35</span><br><span class="line">Current System Date/time = 04/30/2020, 11:38:36</span><br><span class="line">SAS Address = 500605b00992b480</span><br><span class="line">PCI Address = 00:65:00:00</span><br><span class="line">Mfg Date = 09/19/14</span><br><span class="line">Rework Date = 00/00/00</span><br><span class="line">Revision No = 01C</span><br><span class="line"></span><br><span class="line">Version :</span><br><span class="line">=======</span><br><span class="line">Firmware Package Build = 24.21.0-0119</span><br><span class="line">Firmware Version = 4.680.00-8505</span><br><span class="line">CPLD Version = 26611-00A</span><br><span class="line">Bios Version = 6.36.00.3_4.19.08.00_0x06180203</span><br><span class="line">HII Version = 03.25.05.12</span><br><span class="line">Ctrl-R Version = 5.19-0603</span><br><span class="line">Preboot CLI Version = 01.07-05:<span class="comment">#%0000</span></span><br><span class="line">NVDATA Version = 3.1705.00-0020</span><br><span class="line">Boot Block Version = 3.07.00.00-0003</span><br><span class="line">Driver Name = megaraid_sas</span><br><span class="line">Driver Version = 07.707.50.00-rh1</span><br></pre></td></tr></table></figure><h4 id="Create-raid-and-enable-T10-pi-data-protection"><a href="#Create-raid-and-enable-T10-pi-data-protection" class="headerlink" title="Create raid and enable T10-pi data protection"></a>Create raid and enable T10-pi data protection</h4><p>you can see PI = Y , it ‘s worked.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add &quot;pi&quot; key word</span></span><br><span class="line">$ storcli64 /c0 add vd <span class="built_in">type</span>=raid5 drives=94:13,15,17 WB pi strip=64</span><br><span class="line">$ storcli64 /c0/v1 show all</span><br><span class="line"></span><br><span class="line">CLI Version = 007.1211.0000.0000 Nov 07, 2019</span><br><span class="line">Operating system = Linux 3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/c0/v1 :</span><br><span class="line">======</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">DG/VD TYPE  State Access Consist Cache Cac sCC     Size Name</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">1/1   RAID5 Optl  RW     No      RWBD  -   ON  5.457 TB</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">EID=Enclosure Device ID| VD=Virtual Drive| DG=Drive Group|Rec=Recovery</span><br><span class="line">Cac=CacheCade|OfLn=OffLine|Pdgd=Partially Degraded|Dgrd=Degraded</span><br><span class="line">Optl=Optimal|RO=Read Only|RW=Read Write|HD=Hidden|TRANS=TransportReady|B=Blocked|</span><br><span class="line">Consist=Consistent|R=Read Ahead Always|NR=No Read Ahead|WB=WriteBack|</span><br><span class="line">AWB=Always WriteBack|WT=WriteThrough|C=Cached IO|D=Direct IO|sCC=Scheduled</span><br><span class="line">Check Consistency</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PDs <span class="keyword">for</span> VD 1 :</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">EID:Slt DID State DG     Size Intf Med SED PI SeSz Model            Sp Type</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">94:13   104 Onln   1 2.728 TB SAS  HDD N   Y  512B HUS724030ALS640  U  -</span><br><span class="line">94:15   107 Onln   1 2.728 TB SAS  HDD N   Y  512B HUS724030ALS640  U  -</span><br><span class="line">94:17   102 Onln   1 2.728 TB SAS  HDD N   Y  512B HUS724030ALS640  U  -</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">EID=Enclosure Device ID|Slt=Slot No.|DID=Device ID|DG=DriveGroup</span><br><span class="line">DHS=Dedicated Hot Spare|UGood=Unconfigured Good|GHS=Global Hotspare</span><br><span class="line">UBad=Unconfigured Bad|Onln=Online|Offln=Offline|Intf=Interface</span><br><span class="line">Med=Media Type|SED=Self Encryptive Drive|PI=Protection Info</span><br><span class="line">SeSz=Sector Size|Sp=Spun|U=Up|D=Down|T=Transition|F=Foreign</span><br><span class="line">UGUnsp=UGood Unsupported|UGShld=UnConfigured shielded|HSPShld=Hotspare shielded</span><br><span class="line">CFShld=Configured shielded|Cpybck=CopyBack|CBShld=Copyback Shielded</span><br><span class="line">UBUnsp=UBad Unsupported|Rbld=Rebuild</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>GUI set<br>[/img/adapter_support_pi.png]<br>[/img/create_r1.png]<br>[/img/create_vd_pi.png]<br>[/img/4K-pi.png]<br>[/img/512B-pi.png]<br>[/img/vd_support_pi.png]</p><h4 id="Redhat-support"><a href="#Redhat-support" class="headerlink" title="Redhat support"></a><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/ch-install-config">Redhat support</a></h4><p>Block Devices with DIF/DIX Enabled<br>DIF/DIX is a hardware checksum feature provided by certain SCSI host bus adapters and block devices. When DIF/DIX is enabled, error occurs if the block device is used as a general-purpose block device. Buffered I/O or mmap(2)-based I/O will not work reliably, as there are no interlocks in the buffered write path to prevent buffered data from being overwritten after the DIF/DIX checksum has been calculated.<br>This causes the I/O to later fail with a checksum error. This problem is common to all block device (or file system-based) buffered I/O or mmap(2) I/O, so it is not possible to work around these errors caused by overwrites.<br>As such, block devices with DIF/DIX enabled should only be used with applications that use O_DIRECT. Such applications should use the raw block device. Alternatively, it is also safe to use the XFS file system on a DIF/DIX enabled block device, as long as only O_DIRECT I/O is issued through the file system. XFS is the only file system that does not fall back to buffered I/O when doing certain allocation operations.<br>The responsibility for ensuring that the I/O data does not change after the DIF/DIX checksum has been computed always lies with the application, so only applications designed for use with O_DIRECT I/O and DIF/DIX hardware should use DIF/DIX.</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Name-Decoder&quot;&gt;&lt;a href=&quot;#Name-Decoder&quot; class=&quot;headerlink&quot; title=&quot;Name Decoder&quot;&gt;&lt;/a&gt;Name Decoder&lt;/h3&gt;&lt;figure class=&quot;highlight angelscript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;              --------Generation &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;=&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;Gb/s SAS / SATA, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;=&lt;span class=&quot;number&quot;&gt;6&lt;/span&gt; Gb/s SAS / SATA, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;=&lt;span class=&quot;number&quot;&gt;12&lt;/span&gt; Gb/s SAS / SATA&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              -------&lt;span class=&quot;number&quot;&gt;-4&lt;/span&gt;=&lt;span class=&quot;number&quot;&gt;12&lt;/span&gt; Gb/s SAS/ SATA/ PCIe3, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;=&lt;span class=&quot;number&quot;&gt;12&lt;/span&gt; Gb/s SAS/ SATA/ PCIe4, &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;=&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt; Gb/s SAS/ SATA/ PCIe4 (Tri-mode)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              | - Starts at &lt;span class=&quot;string&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt;; This digit &lt;span class=&quot;keyword&quot;&gt;is&lt;/span&gt; used &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; changes that are meant show succession &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; an older version to a newer version.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              | | &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MegaRAID SAS &lt;span class=&quot;number&quot;&gt;9460&lt;/span&gt; - &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             | |     | &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             | |     -----------&lt;span class=&quot;number&quot;&gt;-16&lt;/span&gt;x &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;ernal ports, the &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;i4e= &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; of Internal &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; of External ports&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             | ------Subcategory &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; = HBA Initiator / Target,&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; = HBA Integrated RAID, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; = MegaRAIDEntry (iMR)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             | -----&lt;span class=&quot;number&quot;&gt;-6&lt;/span&gt; = MegaRAID Value,&lt;span class=&quot;number&quot;&gt;8&lt;/span&gt; = MegaRAID Feature&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             ---Technology &lt;span class=&quot;number&quot;&gt;9&lt;/span&gt; = SATA+SAS+PCIe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;Got-megaraid-log&quot;&gt;&lt;a href=&quot;#Got-megaraid-log&quot; class=&quot;headerlink&quot; title=&quot;Got megaraid log&quot;&gt;&lt;/a&gt;Got megaraid log&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;perccli64 /call show all logfile=megaraid.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;perccli64 /call show events file=events.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;perccli64 /call show termlog &lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;=config logfile=termlog.config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;perccli64 /call show termlog &lt;span class=&quot;built_in&quot;&gt;type&lt;/span&gt;=contents logfile=termlog.contents&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;perccli64 /call show eventloginfo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;perccli64 /call show dequeuelog file=dequeue.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;perccli64 /call show alilog logfile=ali.log&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# clear the log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#perccli64 /c x set debug reset all&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#perccli64 /call delete events&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#perccli64 /call delete termlog&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;Set-time&quot;&gt;&lt;a href=&quot;#Set-time&quot; class=&quot;headerlink&quot; title=&quot;Set time&quot;&gt;&lt;/a&gt;Set time&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ perccli64 /call show time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ storcli64 /call &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; time=yyyymmdd hh:mm:ss|systemtime&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ timedatectl set-timezone Asia/XXXXXX&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ storcli64 /call &lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; time=systemtime&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Storage" scheme="http://yoursite.com/categories/Storage/"/>
    
    
    <category term="raid" scheme="http://yoursite.com/tags/raid/"/>
    
    <category term="megaraid" scheme="http://yoursite.com/tags/megaraid/"/>
    
  </entry>
  
  <entry>
    <title>Test hardware and filesystem data consistency</title>
    <link href="http://yoursite.com/2019/04/28/consistency-test/"/>
    <id>http://yoursite.com/2019/04/28/consistency-test/</id>
    <published>2019-04-28T09:43:07.000Z</published>
    <updated>2020-10-11T10:31:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>Because there are some Enterprise hardware firmware issue cause some function not work/data loss.<br><a href="https://engineering.nordeus.com/power-failure-testing-with-ssds/">make sure the supercapacitor is work in Enterprise SSD</a><br>In Some case, if the device partition is not aligned, the logic 512 Byte across the two physical block(512B), it will cause atomic transaction failed (enable the dev write buffer,the buffer no battery or supercapacitor)</p><h3 id="About-filesystem-settting"><a href="#About-filesystem-settting" class="headerlink" title="About filesystem settting"></a>About filesystem settting</h3><p>Disable barrier and set data is writeback </p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ext4/xfs </span>-o <span class="keyword">barrier=0,data=writeback</span></span><br><span class="line"><span class="keyword">zfs </span><span class="keyword">disable </span><span class="keyword">sync </span>write</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="PostgreSQL-Installation"><a href="#PostgreSQL-Installation" class="headerlink" title="PostgreSQL Installation"></a><a href="https://tecadmin.net/install-postgresql-11-on-centos/">PostgreSQL Installation</a></h3><p>Here is my first time to use postgresql, good luck</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.ext4 /dev/sdXX1</span><br><span class="line">$ rpm -Uvh https://yum.postgresql.org/11/redhat/rhel-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">$ yum install postgresql11-server</span><br><span class="line">$ mount /dev/sdXX1 /var/lib/pgsql -o barrier=0,data=writeback</span><br><span class="line">$ chown -R postgres.postgres /var/lib/pgsql</span><br><span class="line">$ /usr/pgsql-11/bin/postgresql-11-setup initdb</span><br><span class="line"><span class="comment"># data is in /var/lib/pgsql/11/data</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> postgresql-11</span><br><span class="line">$ systemctl start postgresql-11</span><br></pre></td></tr></table></figure><h4 id="Disable-PostgreSQL-WAL-Write-Ahead-Log"><a href="#Disable-PostgreSQL-WAL-Write-Ahead-Log" class="headerlink" title="Disable PostgreSQL WAL(Write-Ahead Log)"></a>Disable PostgreSQL WAL(Write-Ahead Log)</h4><p><a href="https://blog.nukomeet.com/faster-inserts-how-to-increase-postgresql-write-performance-24d76bd56f75">The WAL guarantees that the table data is persisted in the event of an unclean shutdown. In other words, unlogged tables are automatically cleared if the server crashes.</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE UNLOGGED TABLE user_clicks (</span><br><span class="line">  id uuid PRIMARY KEY,</span><br><span class="line">  time timestamptz,</span><br><span class="line">  user_id int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE UNLOGGED TABLE name (</span><br><span class="line">…</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">ALTER TABLE user_clicks SET LOGGED </span><br><span class="line">ALTER TABLE user_clicks SET UNLOGGED </span><br><span class="line"></span><br><span class="line"><span class="comment"># List all unlogged tables within the current database.</span></span><br><span class="line">SELECT relname FROM pg_class WHERE relpersistence = <span class="string">&#x27;u&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="pgbench"><a href="#pgbench" class="headerlink" title="pgbench"></a>pgbench</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql -U postgres -c <span class="string">&quot;CREATE DATABASE pgbench1;&quot;</span></span><br><span class="line">$ mkdir /var/lib/pgsql/11/index</span><br><span class="line">$ chown postgres.postgres /var/lib/pgsql/11/index</span><br><span class="line">$ sudo -u postgres psql -U postgres -c <span class="string">&quot;CREATE TABLESPACE index LOCATION &#x27;/var/lib/pgsql/11/index&#x27;;&quot;</span></span><br><span class="line"><span class="comment"># init table in pgbench1</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -U postgres -i pgbench1</span><br><span class="line"></span><br><span class="line"><span class="comment"># go to postgresql terminal</span></span><br><span class="line">$ sudo -u postgres psql </span><br><span class="line"></span><br><span class="line">postgres <span class="comment"># postgres=# \l</span></span><br><span class="line"><span class="comment"># list databases;</span></span><br><span class="line">                             List of databases</span><br><span class="line">   Name    |  Owner   | Encoding  | Collate | Ctype |   Access privileges</span><br><span class="line">-----------+----------+-----------+---------+-------+-----------------------</span><br><span class="line"> pgbench1  | postgres | SQL_ASCII | C       | C     |</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># \c pgbench1</span></span><br><span class="line">You are now connected to database <span class="string">&quot;pgbench1&quot;</span> as user <span class="string">&quot;postgres&quot;</span>.</span><br><span class="line"></span><br><span class="line">pgbench1=<span class="comment"># \dt;</span></span><br><span class="line">              List of relations</span><br><span class="line"> Schema |       Name       | Type  |  Owner</span><br><span class="line">--------+------------------+-------+----------</span><br><span class="line"> public | pgbench_accounts | table | postgres</span><br><span class="line"> public | pgbench_branches | table | postgres</span><br><span class="line"> public | pgbench_history  | table | postgres</span><br><span class="line"> public | pgbench_tellers  | table | postgres</span><br><span class="line">(4 rows)</span><br><span class="line"></span><br><span class="line"><span class="comment">## it &#x27;s the pgbench create table</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -U postgres -i pgbench1 --index-tablespace=index</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_accounts(abalance,aid) TABLESPACE index;&quot;</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_history(mtime) TABLESPACE index;&quot;</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_history(aid,delta) TABLESPACE index;&quot;</span></span><br><span class="line">CREATE INDEX</span><br><span class="line"></span><br><span class="line"><span class="comment">## Disable test table WAL log</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_accounts SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_branches SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_history SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_tellers SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line"></span><br><span class="line"><span class="comment">## bengin to test</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended --random-seed=rand pgbench1</span><br><span class="line">...</span><br><span class="line">progress: 1160.0 s, 50.0 tps, lat 1184.948 ms stddev 1421.433</span><br><span class="line">progress: 1168.0 s, 50.1 tps, lat 1205.856 ms stddev 1672.771</span><br><span class="line">progress: 1176.0 s, 49.0 tps, lat 1359.426 ms stddev 1864.131</span><br><span class="line">progress: 1184.0 s, 47.5 tps, lat 1365.739 ms stddev 1912.132</span><br><span class="line">progress: 1192.0 s, 49.5 tps, lat 1341.149 ms stddev 1631.751</span><br><span class="line">progress: 1200.0 s, 48.9 tps, lat 1308.528 ms stddev 1643.086</span><br><span class="line">transaction <span class="built_in">type</span>: &lt;<span class="built_in">builtin</span>: TPC-B (sort of)&gt;</span><br><span class="line">scaling factor: 1</span><br><span class="line">query mode: extended</span><br><span class="line">number of clients: 64</span><br><span class="line">number of threads: 64</span><br><span class="line">duration: 1200 s</span><br><span class="line">number of transactions actually processed: 2750119</span><br><span class="line">latency average = 27.940 ms</span><br><span class="line">latency stddev = 181.635 ms</span><br><span class="line">tps = 2289.444326 (including connections establishing)</span><br><span class="line">tps = 2289.485134 (excluding connections establishing)</span><br></pre></td></tr></table></figure><p>In the test process, hot plugin the SSD mount at /var/lib/pgsql.<br>Don’t use “echo 1 &gt; /sys/block/sdXX/device/delete, the operate will sync write cache to the device</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_dumpall &gt; /dev/null</span><br></pre></td></tr></table></figure><p>Check the command has any error.</p><h3 id="Enable-WAL-test-to-test-file-system"><a href="#Enable-WAL-test-to-test-file-system" class="headerlink" title="Enable WAL test to test file system"></a><a href="http://mysql.taobao.org/monthly/2016/10/07/">Enable WAL test to test file system</a></h3><p>If you are enable WAL log, force stop the database, and the database will go to recovery</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_accounts SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_branches SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_history SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_tellers SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line"></span><br><span class="line"><span class="comment">### After enable WAL in my zfs test env, no zil</span></span><br><span class="line">progress: 792.0 s, 3699.0 tps, lat 17.227 ms stddev 20.965</span><br><span class="line">progress: 800.0 s, 3592.0 tps, lat 17.867 ms stddev 23.278</span><br><span class="line">progress: 808.0 s, 3502.7 tps, lat 18.292 ms stddev 25.962</span><br><span class="line">progress: 816.0 s, 3560.8 tps, lat 17.972 ms stddev 24.924</span><br><span class="line">progress: 824.0 s, 3628.1 tps, lat 17.656 ms stddev 23.070</span><br><span class="line">progress: 832.0 s, 3617.6 tps, lat 17.655 ms stddev 22.472</span><br><span class="line">progress: 840.0 s, 2590.1 tps, lat 21.832 ms stddev 30.337</span><br><span class="line">progress: 848.0 s, 46.5 tps, lat 1283.200 ms stddev 1202.214</span><br><span class="line">progress: 856.0 s, 5.7 tps, lat 1130.780 ms stddev 1334.794</span><br><span class="line">progress: 864.0 s, 21.3 tps, lat 5008.063 ms stddev 6756.387</span><br><span class="line">progress: 872.0 s, 48.1 tps, lat 1666.621 ms stddev 2890.584</span><br><span class="line">progress: 880.0 s, 49.1 tps, lat 1269.726 ms stddev 1383.484</span><br><span class="line">progress: 888.0 s, 50.4 tps, lat 1277.642 ms stddev 1514.558</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended <span class="attribute">--random-seed</span>=rand pgbench1</span><br><span class="line">setting random seed <span class="keyword">to</span> 4859633172491879446</span><br><span class="line">starting vacuum<span class="built_in">..</span>.end.</span><br><span class="line">progress: 8.0 s, 46.1 tps, lat 1104.991 ms stddev 997.076</span><br><span class="line">progress: 16.0 s, 48.0 tps, lat 1344.463 ms stddev 1467.943</span><br><span class="line">progress: 24.0 s, 49.9 tps, lat 1285.797 ms stddev 1509.956</span><br><span class="line">progress: 32.0 s, 47.4 tps, lat 1277.344 ms stddev 1487.591</span><br><span class="line">progress: 40.0 s, 48.8 tps, lat 1406.851 ms stddev 1789.872</span><br><span class="line">progress: 48.0 s, 38.1 tps, lat 1477.057 ms stddev 1411.267</span><br><span class="line">progress: 56.0 s, 39.0 tps, lat 1695.951 ms stddev 2172.428</span><br><span class="line">progress: 64.0 s, 51.5 tps, lat 1270.484 ms stddev 2008.514</span><br><span class="line">progress: 72.0 s, 48.1 tps, lat 1260.300 ms stddev 1831.611</span><br><span class="line">progress: 80.0 s, 42.6 tps, lat 1605.049 ms stddev 2572.170</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable it immediate</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_ctl stop  -D /var/lib/pgsql/11/data -m immediate</span><br><span class="line"></span><br><span class="line">waiting <span class="keyword">for</span><span class="built_in"> server </span><span class="keyword">to</span> shut down<span class="built_in">..</span><span class="built_in">..</span> done</span><br><span class="line">server stopped</span><br><span class="line"></span><br><span class="line">progress: 768.0 s, 41.1 tps, lat 1562.948 ms stddev 1996.733</span><br><span class="line">progress: 776.0 s, 48.3 tps, lat 1258.457 ms stddev 1728.933</span><br><span class="line">WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line"></span><br><span class="line"><span class="comment">### postgresql log</span></span><br><span class="line">$ tail -f /var/lib/pgsql/11/data/log/postgresql-Mon.log</span><br><span class="line"></span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] CONTEXT:  <span class="keyword">while</span> rechecking updated tuple (3,17) <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span></span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] CONTEXT:  <span class="keyword">while</span> updating tuple (17,116) <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span></span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">2019-04-29 07:43:53.667 UTC [450] LOG:  database<span class="built_in"> system </span>is shut down</span><br><span class="line"></span><br><span class="line">$ cd /var/lib/pgsql/11/data/pg_wal</span><br><span class="line"><span class="comment">#let &#x27;s test 14834480</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_waldump -b 00000001000000010000008D | grep Transaction | tail | head -n 1</span><br><span class="line">pg_waldump: FATAL:  <span class="builtin-name">error</span> <span class="keyword">in</span> WAL record at 1/8DEFE4B0: invalid record length at 1/8DEFE4D8: wanted 24, got 0</span><br><span class="line">rmgr: Transaction len (rec/tot):     34/    34, tx:   14834480, lsn: 1/8DEFCAF8, prev 1/8DEFCAB8, desc: COMMIT 2019-04-29 07:43:53.168178 UTC</span><br><span class="line"></span><br><span class="line">$ <span class="attribute">pgbench1</span>=# select xmin,* <span class="keyword">from</span> pgbench_history where xmin <span class="keyword">in</span> (14834480);</span><br><span class="line">   xmin   | tid | bid |  aid  | delta |           mtime            | filler</span><br><span class="line">----------+-----+-----+-------+-------+----------------------------+--------</span><br><span class="line"> 14834480 |  10 |   1 | 57633 |  1859 | 2019-04-29 08:41:26.458402 |</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">$ dd <span class="attribute">if</span>=/dev/zero <span class="attribute">of</span>=./00000001000000010000008D <span class="attribute">bs</span>=1 <span class="attribute">count</span>=10000 <span class="attribute">skip</span>=100</span><br><span class="line"></span><br><span class="line">$ tail -f /var/lib/pgsql/11/data/log/postgresql-Mon.log </span><br><span class="line">2019-04-29 07:57:03.979 UTC [11634] LOG:  database<span class="built_in"> system </span>was interrupted; last known up at 2019-04-29 07:41:55 UTC</span><br><span class="line">2019-04-29 07:57:04.050 UTC [11634] LOG:  invalid primary checkpoint record</span><br><span class="line">2019-04-29 07:57:04.051 UTC [11634] PANIC:  could <span class="keyword">not</span> locate a valid checkpoint record</span><br><span class="line">2019-04-29 07:57:04.171 UTC [11632] LOG:  startup process (PID 11634) was terminated by signal 6: Aborted</span><br><span class="line">2019-04-29 07:57:04.171 UTC [11632] LOG:  aborting startup due <span class="keyword">to</span> startup process failure</span><br><span class="line">2019-04-29 07:57:04.173 UTC [11632] LOG:  database<span class="built_in"> system </span>is shut down</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_resetwal -f /var/lib/pgsql/11/data</span><br><span class="line">Write-ahead log reset</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_ctl start  -D /var/lib/pgsql/11/data</span><br><span class="line">waiting <span class="keyword">for</span><span class="built_in"> server </span><span class="keyword">to</span> start<span class="built_in">..</span><span class="built_in">..</span>2019-04-29 08:17:18.990 UTC [11662] LOG:  listening on<span class="built_in"> IPv6 address </span><span class="string">&quot;::1&quot;</span>,<span class="built_in"> port </span>5432</span><br><span class="line">2019-04-29 08:17:18.990 UTC [11662] LOG:  listening on IPv4<span class="built_in"> address </span><span class="string">&quot;127.0.0.1&quot;</span>,<span class="built_in"> port </span>5432</span><br><span class="line">2019-04-29 08:17:19.000 UTC [11662] LOG:  listening on Unix socket <span class="string">&quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span><br><span class="line">2019-04-29 08:17:19.026 UTC [11662] LOG:  listening on Unix socket <span class="string">&quot;/tmp/.s.PGSQL.5432&quot;</span></span><br><span class="line">2019-04-29 08:17:19.050 UTC [11662] LOG:  redirecting log output <span class="keyword">to</span><span class="built_in"> logging </span>collector process</span><br><span class="line">2019-04-29 08:17:19.050 UTC [11662] HINT:  Future log output will appear <span class="keyword">in</span> directory <span class="string">&quot;log&quot;</span>.</span><br><span class="line"> done</span><br><span class="line">server started</span><br><span class="line"></span><br><span class="line">$ tail -f /var/lib/pgsql/11/data/log/postgresql-Mon.log</span><br><span class="line">2019-04-29 08:17:19.064 UTC [11664] LOG:  database<span class="built_in"> system </span>was shut down at 2019-04-29 08:17:11 UTC</span><br><span class="line">2019-04-29 08:17:19.104 UTC [11662] LOG:  database<span class="built_in"> system </span>is ready <span class="keyword">to</span> accept connections</span><br><span class="line">2019-04-29 08:17:31.640 UTC [11671] WARNING: <span class="built_in"> page </span>is <span class="keyword">not</span> marked all-visible but visibility map bit is <span class="builtin-name">set</span> <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span><span class="built_in"> page </span>0</span><br><span class="line">2019-04-29 08:17:31.640 UTC [11671] WARNING: <span class="built_in"> page </span>is <span class="keyword">not</span> marked all-visible but visibility map bit is <span class="builtin-name">set</span> <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span><span class="built_in"> page </span>3</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can&#x27;t found it</span></span><br><span class="line">$ <span class="attribute">pgbench1</span>=# select xmin,* <span class="keyword">from</span> pgbench_history where xmin <span class="keyword">in</span> (14834480);</span><br><span class="line"> xmin | tid | bid | aid | delta | mtime | filler</span><br><span class="line">------+-----+-----+-----+-------+-------+--------</span><br><span class="line">(0 rows)</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended <span class="attribute">--random-seed</span>=rand pgbench1</span><br><span class="line">setting random seed <span class="keyword">to</span> 4384533976954680126</span><br><span class="line">starting vacuum<span class="built_in">..</span>.end.</span><br><span class="line">empty range given <span class="keyword">to</span> random</span><br><span class="line">client 1 aborted <span class="keyword">in</span> command 0 (set) of<span class="built_in"> script </span>0; evaluation of meta-command failed</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">empty range given <span class="keyword">to</span> random</span><br><span class="line">client 40 aborted <span class="keyword">in</span> command 0 (set) of<span class="built_in"> script </span>0; evaluation of meta-command failed</span><br><span class="line">transaction type: &lt;builtin: TPC-B (sort of)&gt;</span><br><span class="line">scaling factor: 0</span><br><span class="line">query mode: extended</span><br><span class="line">number of clients: 64</span><br><span class="line">number of threads: 64</span><br><span class="line">duration: 1200 s</span><br><span class="line">number of transactions actually processed: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">## re-init</span></span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -i pgbench1</span><br><span class="line">dropping old tables<span class="built_in">..</span>.</span><br><span class="line">creating tables<span class="built_in">..</span>.</span><br><span class="line">generating data<span class="built_in">..</span>.</span><br><span class="line">100000 of 100000 tuples (100%) done (elapsed 0.12 s, remaining 0.00 s)</span><br><span class="line">vacuuming<span class="built_in">..</span>.</span><br><span class="line">creating primary keys<span class="built_in">..</span>.</span><br><span class="line">done.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Oh shit,it looks like meta data loss cause tables incomplelte….</p><p><a href="https://github.com/winlibs/postgresql/blob/master/src/backend/commands/vacuumlazy.c">source code</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * As of PostgreSQL 9.2, the visibility map bit should never be set if</span></span><br><span class="line"><span class="comment"> * the page-level bit is clear.  However, it&#x27;s possible that the bit</span></span><br><span class="line"><span class="comment"> * got cleared after we checked it and before we took the buffer</span></span><br><span class="line"><span class="comment"> * content lock, so we must recheck before jumping to the conclusion</span></span><br><span class="line"><span class="comment"> * that something bad has happened.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (all_visible_according_to_vm &amp;&amp; !PageIsAllVisible(page)</span><br><span class="line"> &amp;&amp; VM_ALL_VISIBLE(onerel, blkno, &amp;vmbuffer))</span><br><span class="line">&#123;</span><br><span class="line">elog(WARNING, <span class="string">&quot;page is not marked all-visible but visibility map bit is set in relation \&quot;%s\&quot; page %u&quot;</span>,</span><br><span class="line"> relname, blkno);</span><br><span class="line">visibilitymap_clear(onerel, blkno, vmbuffer,</span><br><span class="line">VISIBILITYMAP_VALID_BITS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FIO-verify"><a href="#FIO-verify" class="headerlink" title="FIO verify"></a><a href="https://github.com/axboe/fio/issues/713">FIO verify</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=512 --iodepth=1 --readwrite=randwrite --size=1G --numjobs=1 --verify=crc64 --do_verify=1 --verify_state_save=1 --group_reporting --verify_backlog=8192</span><br><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=512 --iodepth=1 --readwrite=randread  --size=1G --numjobs=1 --verify=crc64 --group_reporting --verify_only --verify_dump=1 --verify_state_load=1 --do_verify=1 --verify_backlog=8192</span><br><span class="line"></span><br><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=4K --iodepth=1 --readwrite=randwrite --size=4G --numjobs=1 --verify=crc64 --do_verify=1 --verify_state_save=1 --group_reporting --verify_backlog=8192</span><br><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=4K --iodepth=1 --readwrite=randread  --size=4G --numjobs=1 --verify=crc64 --group_reporting --verify_only --verify_dump=1 --verify_state_load=1 --do_verify=1 --verify_backlog=8192</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Because there are some Enterprise hardware firmware issue cause some function not work/data loss.&lt;br&gt;&lt;a href=&quot;https://engineering.nordeus.com/power-failure-testing-with-ssds/&quot;&gt;make sure the supercapacitor is work in Enterprise SSD&lt;/a&gt;&lt;br&gt;In Some case, if the device partition is not aligned, the logic 512 Byte across the two physical block(512B), it will cause atomic transaction failed (enable the dev write buffer,the buffer no battery or supercapacitor)&lt;/p&gt;
&lt;h3 id=&quot;About-filesystem-settting&quot;&gt;&lt;a href=&quot;#About-filesystem-settting&quot; class=&quot;headerlink&quot; title=&quot;About filesystem settting&quot;&gt;&lt;/a&gt;About filesystem settting&lt;/h3&gt;&lt;p&gt;Disable barrier and set data is writeback &lt;/p&gt;
&lt;figure class=&quot;highlight mipsasm&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;ext4/xfs &lt;/span&gt;-o &lt;span class=&quot;keyword&quot;&gt;barrier=0,data=writeback&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;zfs &lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;disable &lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;sync &lt;/span&gt;write&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Benchmark" scheme="http://yoursite.com/categories/Benchmark/"/>
    
    
    <category term="postgresql" scheme="http://yoursite.com/tags/postgresql/"/>
    
    <category term="test" scheme="http://yoursite.com/tags/test/"/>
    
    <category term="fio" scheme="http://yoursite.com/tags/fio/"/>
    
  </entry>
  
  <entry>
    <title>linux container with zfs</title>
    <link href="http://yoursite.com/2019/04/02/lxc_with_zfs/"/>
    <id>http://yoursite.com/2019/04/02/lxc_with_zfs/</id>
    <published>2019-04-02T03:17:51.000Z</published>
    <updated>2020-10-11T03:54:20.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Create-bridge"><a href="#Create-bridge" class="headerlink" title="Create bridge"></a>Create bridge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">br08000.ba02751fd447noeno2</span><br><span class="line"></span><br><span class="line">$ cat /etc/netplan/50-cloud-init.yaml</span><br><span class="line"><span class="comment"># This file is generated from information provided by</span></span><br><span class="line"><span class="comment"># the datasource.  Changes to it will not persist across an instance.</span></span><br><span class="line"><span class="comment"># To disable cloud-init&#x27;s network configuration capabilities, write a file</span></span><br><span class="line"><span class="comment"># /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:</span></span><br><span class="line"><span class="comment"># network: &#123;config: disabled&#125;</span></span><br><span class="line">network:</span><br><span class="line">    version: 2</span><br><span class="line">    ethernets:</span><br><span class="line">        eno1:</span><br><span class="line">            addresses: []</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            dhcp6: <span class="literal">false</span></span><br><span class="line">        eno2:</span><br><span class="line">            addresses: []</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            dhcp6: <span class="literal">false</span></span><br><span class="line">        eno3:</span><br><span class="line">            addresses: [AA.AA.AA.AA/BB]</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            dhcp6: <span class="literal">false</span></span><br><span class="line">        eno4:</span><br><span class="line">            addresses: [BB.BB.BB.BB/CC]</span><br><span class="line">            <span class="comment">#gateway4: your.gatway</span></span><br><span class="line">            <span class="comment">#nameservers:</span></span><br><span class="line">            <span class="comment">#    addresses:</span></span><br><span class="line">            <span class="comment">#    - your.dns.addr</span></span><br><span class="line">            <span class="comment">#    search: []</span></span><br><span class="line">    bridges:</span><br><span class="line">      br0:</span><br><span class="line">        interfaces: [eno2]</span><br><span class="line">        dhcp4: <span class="literal">true</span></span><br><span class="line">        dhcp6: <span class="literal">false</span></span><br><span class="line">        addresses: [CC.CC.CC.CC/DD]</span><br><span class="line">        gateway4: your.gatway</span><br><span class="line">        nameservers:</span><br><span class="line">          addresses: [your.dns.addr]</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Add-bridge"><a href="#Add-bridge" class="headerlink" title="Add bridge"></a>Add bridge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ lxc init</span><br><span class="line">$ cat &lt;&lt;EOF | lxc profile edit default</span><br><span class="line">description: Bridged networking LXD profile</span><br><span class="line">devices:</span><br><span class="line">  eth0:</span><br><span class="line">    name: eth0</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: br0</span><br><span class="line">    <span class="built_in">type</span>: nic</span><br><span class="line">EOF</span><br><span class="line">$ lxc profile list</span><br><span class="line">$ lxc profile show default</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you are not default</span></span><br><span class="line">$ lxc profile delete your_custom_config</span><br></pre></td></tr></table></figure><h3 id="Add-zfs-zpool"><a href="#Add-zfs-zpool" class="headerlink" title="Add zfs zpool"></a>Add zfs zpool</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ zfs create tank/lxd</span><br><span class="line">$ lxc storage create zfs-pool zfs <span class="attribute">source</span>=tank/lxd</span><br><span class="line"></span><br><span class="line">$ lxc<span class="built_in"> profile </span>show default</span><br><span class="line">config: &#123;&#125;</span><br><span class="line">description:<span class="built_in"> Default </span>LXD profile</span><br><span class="line">devices:</span><br><span class="line">  eth0:</span><br><span class="line">    name: eth0</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: br0</span><br><span class="line">    type: nic</span><br><span class="line">  root:</span><br><span class="line">    path: /</span><br><span class="line">    pool: zfs-pool</span><br><span class="line">    size: <span class="string">&quot;0&quot;</span></span><br><span class="line">    type: disk</span><br><span class="line">name: default</span><br><span class="line">used_by:</span><br><span class="line">- /1.0/containers/centos7-01</span><br></pre></td></tr></table></figure><h3 id="Custom-centos-7-image"><a href="#Custom-centos-7-image" class="headerlink" title="Custom centos 7 image"></a>Custom centos 7 image</h3><p>Found a centos 7 server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ mount CentOS-7-x86_64-Everything-1804.iso /mnt -o loop</span><br><span class="line">$ cat /tank/vms/lxc-images/centos7/etc/yum.repos.d/base.repo</span><br><span class="line">[base]</span><br><span class="line">gpgcheck=0</span><br><span class="line">baseurl=file:/mnt</span><br><span class="line">name=CentOS-7</span><br><span class="line"></span><br><span class="line">$ yum -y --installroot=/tank/vms/lxc-images/centos7 install systemd passwd yum redhat-release vim-minimal openssh-server screen qperf sysstat lsof nfs-utils rsync libselinux-python openssh-clients net-tools strace attr yum-utils coreutils pciutils</span><br><span class="line">$ rm -f /tank/vms/lxc-images/centos7/etc/yum.repos.d/CentOS-*</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /tank/vms/lxc-images/centos7/</span><br><span class="line">$ tar cjvf  centos-7-x86_64.tar.gz *</span><br><span class="line"></span><br><span class="line">$ cat metadata.yaml</span><br><span class="line">architecture: <span class="string">&quot;x86_64&quot;</span></span><br><span class="line">creation_date: 1554097535 <span class="comment"># To get current date in Unix time, use `date +%s` command</span></span><br><span class="line">properties:</span><br><span class="line">architecture: <span class="string">&quot;x86_64&quot;</span></span><br><span class="line">description: <span class="string">&quot;CentOS 7.6 add openssh&quot;</span></span><br><span class="line">os: <span class="string">&quot;centos&quot;</span></span><br><span class="line">release: <span class="string">&quot;sid&quot;</span></span><br><span class="line"></span><br><span class="line">$ tar czvf metadata.tar.gz metadata.yaml</span><br><span class="line">$ lxc image import metadata.tar.gz centos-7-x86_64.tar.gz --<span class="built_in">alias</span> custom-for-centos7</span><br><span class="line"></span><br><span class="line">$ lxc image list</span><br><span class="line">+--------------------+--------------+--------+-------------+--------+----------+-----------------------------+</span><br><span class="line">|       ALIAS        | FINGERPRINT  | PUBLIC | DESCRIPTION |  ARCH  |   SIZE   |         UPLOAD DATE         |</span><br><span class="line">+--------------------+--------------+--------+-------------+--------+----------+-----------------------------+</span><br><span class="line">| custom-for-centos7 | 662e0004303e | no     |             | x86_64 | 174.80MB | Apr 1, 2019 at 5:46am (UTC) |</span><br><span class="line">+--------------------+--------------+--------+-------------+--------+----------+-----------------------------+</span><br><span class="line"></span><br><span class="line">$ lxc launch custom-for-centos7 centos-7-0</span><br><span class="line"></span><br><span class="line"><span class="comment">### You need set it to 0 before you launch the custom image</span></span><br><span class="line">$ lxc profile device <span class="built_in">set</span> default root size 0</span><br><span class="line">$ lxc launch custom-for-centos7 centos-7-0</span><br><span class="line">Creating centos-7-71</span><br><span class="line">Starting centos-7-71</span><br></pre></td></tr></table></figure><h3 id="Connect-bash-tty"><a href="#Connect-bash-tty" class="headerlink" title="Connect bash tty"></a>Connect bash tty</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lxc <span class="built_in">exec</span> centos-7-0 /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install openssh-server</span></span><br></pre></td></tr></table></figure><h3 id="Limit-the-container-resources"><a href="#Limit-the-container-resources" class="headerlink" title="Limit the container resources"></a>Limit the container resources</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu 4</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu 0,3,7-9</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu.allowance 20%</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu.allowance 100ms/200ms</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu.priority 5</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.memory 8GB</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.memory.swap <span class="literal">true</span></span><br><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">set</span> centos-7-0 root limits.read 125MB</span><br><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">set</span> centos-7-0 root limits.write 125MB</span><br></pre></td></tr></table></figure><h4 id="Show-the-expanded-config"><a href="#Show-the-expanded-config" class="headerlink" title="Show the expanded config"></a>Show the expanded config</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lxc<span class="built_in"> config </span>show --expanded centos-7-0</span><br></pre></td></tr></table></figure><h4 id="Limit-root-partition"><a href="#Limit-root-partition" class="headerlink" title="Limit root partition"></a>Limit root partition</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">add</span> centos-7-0 root disk <span class="attribute">path</span>=/ <span class="attribute">pool</span>=zfs-pool <span class="attribute">size</span>=200GB</span><br><span class="line"><span class="comment">## for all root partition</span></span><br><span class="line">$ lxc<span class="built_in"> profile </span>device <span class="builtin-name">set</span><span class="built_in"> default </span>root size 200GB</span><br></pre></td></tr></table></figure><h4 id="List-contanier-device"><a href="#List-contanier-device" class="headerlink" title="List contanier device"></a>List contanier device</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lxc<span class="built_in"> profile </span>device list default</span><br><span class="line">eth0</span><br><span class="line">root</span><br></pre></td></tr></table></figure><h4 id="Clone-container-to-image"><a href="#Clone-container-to-image" class="headerlink" title="Clone container to image"></a>Clone container to image</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ lxc stop centos-7-0</span><br><span class="line">$ lxc-stop -n centos-7-0 -k <span class="comment">## force</span></span><br><span class="line">$ lxc publish centos-7-0 --<span class="built_in">alias</span>=centos-7.6-1 description=<span class="string">&quot;Test base image update1&quot;</span></span><br><span class="line">$ lxc image list</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line">|       ALIAS        | FINGERPRINT  | PUBLIC |       DESCRIPTION       |  ARCH  |   SIZE   |         UPLOAD DATE         |</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line">| centos7.6-1        | 1741cafe0ae2 | no     | Test base image update1 | x86_64 | 213.75MB | Apr 1, 2019 at 7:09am (UTC) |</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line">| custom-for-centos7 | 662e0004303e | no     |                         | x86_64 | 174.80MB | Apr 1, 2019 at 5:46am (UTC) |</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line"></span><br><span class="line">$ lxc launch centos7.6-1 centos-7-2</span><br><span class="line">$ lxc delete centos-7-0</span><br><span class="line">$ lxc info centos-7-2</span><br><span class="line"></span><br><span class="line"><span class="comment">#Show internet image</span></span><br><span class="line">lxc image list images:</span><br></pre></td></tr></table></figure><h4 id="Show-container-info"><a href="#Show-container-info" class="headerlink" title="Show container info"></a>Show container info</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxc <span class="built_in">list</span></span><br></pre></td></tr></table></figure><h3 id="Container-config-file"><a href="#Container-config-file" class="headerlink" title="Container config file"></a>Container config file</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">lxd</span>/<span class="title">storage</span>-<span class="title">pools</span>/<span class="title">zfs</span>-<span class="title">pool</span>/<span class="title">containers</span>/<span class="title">centos</span>-7-0</span></span><br></pre></td></tr></table></figure><h3 id="Enable-the-container-support-NFS"><a href="#Enable-the-container-support-NFS" class="headerlink" title="Enable the container support NFS"></a>Enable the container support NFS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lxc config <span class="built_in">set</span> centos-7-71 security.privileged <span class="literal">true</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;mount fstype=nfs,\nmount fstype=nfs4,&quot;</span> | lxc config <span class="built_in">set</span> centos-7-71 raw.apparmor -</span><br></pre></td></tr></table></figure><h3 id="Create-a-new-profile-and-assign-the-config-to-the-container"><a href="#Create-a-new-profile-and-assign-the-config-to-the-container" class="headerlink" title="Create a new profile and assign the config to the container"></a>Create a new profile and assign the config to the container</h3><p>``<br>$ lxc profile show ipmi-manager<br>config: {}<br>description: ipmitool manager node<br>devices:<br>  eth0:<br>    name: eth0<br>    nictype: bridged<br>    parent: br1<br>    type: nic<br>  eth1:<br>    name: eth1<br>    nictype: bridged<br>    parent: br2<br>    type: nic<br>  root:<br>    path: /<br>    pool: zfs-pool<br>    size: “0”<br>    type: disk<br>name: ipmi-manager</p><p>$ lxc profile remove c1 default<br>$ lxc profile assign c1 ipmi-manager<br>$ lxc exec c1 /bin/bash<br>$ ls /sys/class/net<br>eth0  eth1  lo</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### Auto start</span><br></pre></td></tr></table></figure><p>lxc config set $container boot.autostart true<br>lxc config set $container boot.autostart.delay 10</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">### mount iso</span></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># in physical server</span></span><br><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">add</span> centos7-samba-105 loop0 unix-block <span class="attribute">path</span>=/dev/loop0</span><br><span class="line"></span><br><span class="line"><span class="comment"># in container</span></span><br><span class="line">$ mknod /dev/loop0 b 7 0</span><br></pre></td></tr></table></figure><h3 id="Mount-host-lustre"><a href="#Mount-host-lustre" class="headerlink" title="Mount host lustre"></a><a href="https://www.cyberciti.biz/faq/how-to-add-or-mount-directory-in-lxd-linux-container/?nsukey=eiv2/uile9LfG55dOvcg55UtqOWQ19bxIsDY+cQHH0EMOu865QP86rrt/4aONbgQSMEg8ZarwNEM4Co5kKScLxO3eE3FlG3d9V9iWG2UTcog+3x2ZWXy5itNokLMg8/1KVsyd05MctDSgYCklGPMNeT+muNtI5ICfGvH+nheN7AIRFdmDWdo6CI0/00wWjDhsgsSVRZx2qEfz1UKB1kkOA==">Mount host lustre</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ mount.lustre xx.xx.xx.xx@tcp:/lustre /mnt -o localflock,user_xattr</span><br><span class="line">$ df -h <span class="comment"># make sure has mountted</span></span><br><span class="line">$ lxc list</span><br><span class="line">$ lxc config device add c1 mytestdir disk <span class="built_in">source</span>=/mnt path=/dest/</span><br><span class="line">$ lxc config device show c1</span><br><span class="line">$ lxc <span class="built_in">exec</span> c1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># in container</span></span><br><span class="line">$ df -h</span><br><span class="line">xx.xx.xx.xx@tcp:/lustre              lustre    10T  491M  10T   1% /dest</span><br><span class="line">$ umount /dest</span><br><span class="line"></span><br><span class="line"><span class="comment"># in host</span></span><br><span class="line">xx.xx.xx.xx@tcp:/lustre                        10T  491M  10T   1% /var/lib/lxd/devices/c1/disk.mytestdir.dest-</span><br><span class="line"></span><br><span class="line">$ lxc config device remove c1 mytestdir</span><br><span class="line"></span><br><span class="line">$ cat /etc/subgid /etc/subuid</span><br><span class="line"><span class="comment">#login name or UID</span></span><br><span class="line"><span class="comment">#numerical subordinate group ID</span></span><br><span class="line"><span class="comment">#numerical subordinate group ID count</span></span><br><span class="line"><span class="comment">#modify root to nobody(65534)</span></span><br><span class="line">root:100000:65534</span><br><span class="line">root:100000:65534</span><br><span class="line"></span><br><span class="line"><span class="comment">## The container root and ubuntu physical root has the same permission</span></span><br><span class="line"><span class="comment">## Lustre has the same setting with the permission</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ubuntu lustre client version</span></span><br><span class="line">$ cat /sys/fs/lustre/version</span><br><span class="line">2.12.55_dirty</span><br></pre></td></tr></table></figure><p><a href="https://gist.github.com/jeanlouisferey/15be1f421eb9f9a66f1c74d410de2675">https://gist.github.com/jeanlouisferey/15be1f421eb9f9a66f1c74d410de2675</a><br><a href="https://angristan.xyz/lxc-zfs-pool-lxd/">https://angristan.xyz/lxc-zfs-pool-lxd/</a><br><a href="https://blog.simos.info/how-to-make-your-lxd-containers-get-ip-addresses-from-your-lan-using-a-bridge/">https://blog.simos.info/how-to-make-your-lxd-containers-get-ip-addresses-from-your-lan-using-a-bridge/</a><br><a href="https://www.tomvanbrienen.nl/installing-and-configuring-lxd-3-on-ubuntu-18-04/">https://www.tomvanbrienen.nl/installing-and-configuring-lxd-3-on-ubuntu-18-04/</a><br><a href="https://tutorials.ubuntu.com/tutorial/create-custom-lxd-images#4">https://tutorials.ubuntu.com/tutorial/create-custom-lxd-images#4</a><br><a href="https://github.com/lxc/lxd/issues/3096">https://github.com/lxc/lxd/issues/3096</a><br><a href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/LXC+Template+creation#LXCTemplatecreation-StepstocreateminimalCentOS6containertemplate">https://cwiki.apache.org/confluence/display/CLOUDSTACK/LXC+Template+creation#LXCTemplatecreation-StepstocreateminimalCentOS6containertemplate</a>:<br><a href="https://blog.simos.info/using-distrobuilder-to-create-container-images-for-lxc-and-lxd/">https://blog.simos.info/using-distrobuilder-to-create-container-images-for-lxc-and-lxd/</a></p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;Create-bridge&quot;&gt;&lt;a href=&quot;#Create-bridge&quot; class=&quot;headerlink&quot; title=&quot;Create bridge&quot;&gt;&lt;/a&gt;Create bridge&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ brctl show&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bridge name	bridge id		STP enabled	interfaces&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;br0		8000.ba02751fd447	no		eno2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/netplan/50-cloud-init.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# This file is generated from information provided by&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# the datasource.  Changes to it will not persist across an instance.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# To disable cloud-init&amp;#x27;s network configuration capabilities, write a file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# network: &amp;#123;config: disabled&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;network:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    version: 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ethernets:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        eno1:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            addresses: []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            dhcp4: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            dhcp6: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        eno2:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            addresses: []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            dhcp4: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            dhcp6: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        eno3:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            addresses: [AA.AA.AA.AA/BB]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            dhcp4: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            dhcp6: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        eno4:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            addresses: [BB.BB.BB.BB/CC]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;#gateway4: your.gatway&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;#nameservers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;#    addresses:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;#    - your.dns.addr&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;#    search: []&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    bridges:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      br0:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        interfaces: [eno2]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        dhcp4: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        dhcp6: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        addresses: [CC.CC.CC.CC/DD]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        gateway4: your.gatway&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        nameservers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          addresses: [your.dns.addr]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Virtualization" scheme="http://yoursite.com/categories/Virtualization/"/>
    
    
    <category term="lxc" scheme="http://yoursite.com/tags/lxc/"/>
    
    <category term="zfs" scheme="http://yoursite.com/tags/zfs/"/>
    
    <category term="ubuntu" scheme="http://yoursite.com/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>the HDD power mode</title>
    <link href="http://yoursite.com/2019/01/03/hdd-power-mode/"/>
    <id>http://yoursite.com/2019/01/03/hdd-power-mode/</id>
    <published>2019-01-03T13:12:46.000Z</published>
    <updated>2020-10-11T07:23:58.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="About-HDD-power-save-mode"><a href="#About-HDD-power-save-mode" class="headerlink" title="About HDD power save mode"></a><a href="https://www.seagate.com/files/docs/pdf/whitepaper/tp608-powerchoice-tech-provides-us.pdf">About HDD power save mode</a></h3><p>Idle_0</p><ul><li>Drive Ready, but not performing IO, drive may power down selected electronics to reduce power without increasing response time</li></ul><p>Idle_A</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Disks rotating at full speed (7200 RPM)</li></ul><p>Idle_B</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Heads are unloaded to drive ramp.</li><li>Disks rotating at full speed (7200 RPM)</li></ul><p>Idle_C/Standby_Y (SAS Only)</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Heads are unloaded to drive ramp.</li><li>Drive speed reduced to a lower RPM (reduced RPM)</li></ul><p>Standby_Z</p><ul><li>Heads are unloaded to drive ramp.</li><li>Drive motor is spun down.</li><li>Drive still responds to non-media access host commands.</li></ul><a id="more"></a><p>SAS</p><ul><li>Host-definable timers via mode pages</li><li>Immediate host-commanded power transitions via Start/Stop Unit (SSU) command</li></ul><table><thead><tr><th align="center">From</th><th align="center">To</th><th align="center">RPM</th><th align="center">Typical(sec)</th><th align="center">Max(sec)</th></tr></thead><tbody><tr><td align="center">idle_b</td><td align="center">Active</td><td align="center">7200</td><td align="center">1</td><td align="center">30</td></tr><tr><td align="center">idle_c</td><td align="center">Active</td><td align="center">6300 -&gt;7200</td><td align="center">4</td><td align="center">30</td></tr><tr><td align="center">standby_y</td><td align="center">Active</td><td align="center">6300 -&gt;7200</td><td align="center">4</td><td align="center">30</td></tr><tr><td align="center">standby_z</td><td align="center">Active</td><td align="center">0 -&gt; 7200</td><td align="center">15</td><td align="center">30</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">$ sg_logs -p 0x1a /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Power condition transitions page  [0x1a]</span><br><span class="line">  Accumulated transitions to active = 700283</span><br><span class="line">  Accumulated transitions to idle_a = 698441</span><br><span class="line">  Accumulated transitions to idle_b = 1855</span><br><span class="line">  Accumulated transitions to idle_c = 0</span><br><span class="line">  Accumulated transitions to standby_z = 0</span><br><span class="line">  Accumulated transitions to standby_y = 0</span><br><span class="line"></span><br><span class="line">$ sg_logs -p 0x1a /dev/sdj</span><br><span class="line">    SEAGATE   ST10000NM0256     TT54</span><br><span class="line">Power condition transitions page  (spc-4) [0x1a]</span><br><span class="line">  Accumulated transitions to idle_a = 13934971</span><br><span class="line">  Accumulated transitions to idle_b = 13934971</span><br><span class="line">  Accumulated transitions to idle_c = 99</span><br><span class="line">  Reserved [0x4] = 0</span><br><span class="line">  Accumulated transitions to standby_z = 0</span><br><span class="line">  Accumulated transitions to standby_y = 0</span><br><span class="line"></span><br><span class="line">$ sdparm -p po -l  /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    Direct access device specific parameters: WP=0  DPOFUA=1</span><br><span class="line">Power condition [po] mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]  Power management, background <span class="built_in">functions</span>, precedence</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]  Standby_y timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]  Idle_c timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]  Idle_b timer <span class="built_in">enable</span></span><br><span class="line">  IDLE          1  [cha: y, def:  1, sav:  1]  Idle_a timer <span class="built_in">enable</span></span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]  Standby_z timer <span class="built_in">enable</span></span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]  Idle_a condition timer (100 ms)</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]  Standby_z condition timer (100 ms)</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]  Idle_b condition timer (100 ms)</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]  Idle_c condition timer (100 ms)</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]  Standby_y condition timer (100 ms)</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]  check condition on transition from idle</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]  check condition on transition from standby</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]  check condition on transition from stopped</span><br><span class="line"></span><br><span class="line"><span class="comment"># looks like cha: n means could not be modified</span></span><br><span class="line"></span><br><span class="line">$ sdparm -p po -l  /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    Direct access device specific parameters: WP=0  DPOFUA=1</span><br><span class="line">Power condition [po] mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]  Power management, background <span class="built_in">functions</span>, precedence</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]  Standby_y timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]  Idle_c timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]  Idle_b timer <span class="built_in">enable</span></span><br><span class="line">  IDLE          0  [cha: y, def:  1, sav:  0]  Idle_a timer <span class="built_in">enable</span></span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]  Standby_z timer <span class="built_in">enable</span></span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]  Idle_a condition timer (100 ms)</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]  Standby_z condition timer (100 ms)</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]  Idle_b condition timer (100 ms)</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]  Idle_c condition timer (100 ms)</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]  Standby_y condition timer (100 ms)</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]  check condition on transition from idle</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]  check condition on transition from standby</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]  check condition on transition from stopped</span><br><span class="line"></span><br><span class="line">$ sdparm -v -S -p po --<span class="built_in">set</span>=IDLE=1 /dev/sdj</span><br><span class="line">mp_settings: page,subpage=0x1a,0x0  num=1</span><br><span class="line">  pdt=-1 start_byte=0x3 start_bit=1 num_bits=1  val=1  acronym: IDLE</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    mode sense (10) cdb: 5a 00 1a 00 00 00 00 00 04 00</span><br><span class="line">    mode sense (10) cdb: 5a 00 1a 00 00 00 00 00 38 00</span><br><span class="line">    mode select (10) cdb: 55 11 00 00 00 00 00 00 38 00</span><br><span class="line"></span><br><span class="line">$ sdparm -p po -l  /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    Direct access device specific parameters: WP=0  DPOFUA=1</span><br><span class="line">Power condition [po] mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]  Power management, background <span class="built_in">functions</span>, precedence</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]  Standby_y timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]  Idle_c timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]  Idle_b timer <span class="built_in">enable</span></span><br><span class="line">  IDLE          1  [cha: y, def:  1, sav:  1]  Idle_a timer <span class="built_in">enable</span></span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]  Standby_z timer <span class="built_in">enable</span></span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]  Idle_a condition timer (100 ms)</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]  Standby_z condition timer (100 ms)</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]  Idle_b condition timer (100 ms)</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]  Idle_c condition timer (100 ms)</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]  Standby_y condition timer (100 ms)</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]  check condition on transition from idle</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]  check condition on transition from standby</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]  check condition on transition from stopped</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable IDLE_C</span></span><br><span class="line">$ sdparm --flexible -6  -v -p po --<span class="built_in">set</span>=IDLE_C=0 /dev/sdj</span><br><span class="line"></span><br><span class="line"><span class="comment"># Got all page name </span></span><br><span class="line">$ sdparm -e /dev/sdj</span><br></pre></td></tr></table></figure><p><a href="https://wiki.archlinux.org/index.php/hdparm#Power_management_configuration">SATA HDD</a></p><ul><li>Host-definable timers via Set Features commands</li><li>Immediate host-commanded power transitions via Set Features commands </li></ul><p>-B Set the Advanced Power Management feature. Possible values are between 1 and 255, low values mean more aggressive power management and higher values mean better performance. Values from 1 to 127 permit spin-down, whereas values from 128 to 254 do not. A value of 255 completely disables the feature</p><p>-S Set the standby (spindown) timeout for the drive. The timeout specifies how long to wait in idle (with no disk activity) before turning off the motor to save power. The value of 0 disables spindown, the values from 1 to 240 specify multiples of 5 seconds and values from 241 to 251 specify multiples of 30 minutes. </p><p>-M Set the Automatic Acoustic Management feature. Most modern hard disk drives have the ability to speed down the head movements to reduce their noise output. The possible value depends on the disk, some disks may not support this feature. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ hdparm -B 127 /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> setting Advanced Power Management level to 0x7f (127)</span><br><span class="line"> APM_level= 127</span><br><span class="line"></span><br><span class="line">$ hdparm -B 255 /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> setting Advanced Power Management level to disabled</span><br><span class="line"> APM_level= off</span><br><span class="line"></span><br><span class="line">$ hdparm -S 0 /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> setting standby to 0 (off)</span><br><span class="line"></span><br><span class="line">$ hdparm -M /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> acoustic      = not supported</span><br></pre></td></tr></table></figure><h3 id="smart"><a href="#smart" class="headerlink" title="smart"></a>smart</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">smartctl -i -n standby /dev/sdc</span><br><span class="line"></span><br><span class="line"><span class="comment">#never - check the device always, but print the power mode if ´-i´ is specified</span></span><br><span class="line"><span class="comment">#sleep - check the device unless it is in SLEEP mode</span></span><br><span class="line"><span class="comment">#standby - check the device unless it is in SLEEP or STANDBY mode.  In these modes most disks are not spinning, so if you want to prevent a disk from spinning up, this is probably what you want</span></span><br><span class="line"><span class="comment">#idle - check the device unless it is in SLEEP, STANDBY or IDLE mode.  In the IDLE state,  most disks are still spinning, so this is probably not what you want</span></span><br></pre></td></tr></table></figure><h3 id="udev"><a href="#udev" class="headerlink" title="udev"></a>udev</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/udev/rules.d/69-hdparm.rules</span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, SUBSYSTEM==<span class="string">&quot;block&quot;</span>, KERNEL==<span class="string">&quot;sda&quot;</span>, RUN+=<span class="string">&quot;/usr/bin/hdparm -B 254 -S 0 /dev/sda&quot;</span></span><br></pre></td></tr></table></figure><h3 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/systemd/system/hdparm.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=hdparm sleep</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/usr/bin/hdparm -q -S 120 -y /dev/sdb</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;About-HDD-power-save-mode&quot;&gt;&lt;a href=&quot;#About-HDD-power-save-mode&quot; class=&quot;headerlink&quot; title=&quot;About HDD power save mode&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.seagate.com/files/docs/pdf/whitepaper/tp608-powerchoice-tech-provides-us.pdf&quot;&gt;About HDD power save mode&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Idle_0&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Drive Ready, but not performing IO, drive may power down selected electronics to reduce power without increasing response time&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Idle_A&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Disables most of the servo system, reduces processor and channel power consumption&lt;/li&gt;
&lt;li&gt;Disks rotating at full speed (7200 RPM)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Idle_B&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Disables most of the servo system, reduces processor and channel power consumption&lt;/li&gt;
&lt;li&gt;Heads are unloaded to drive ramp.&lt;/li&gt;
&lt;li&gt;Disks rotating at full speed (7200 RPM)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Idle_C/Standby_Y (SAS Only)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Disables most of the servo system, reduces processor and channel power consumption&lt;/li&gt;
&lt;li&gt;Heads are unloaded to drive ramp.&lt;/li&gt;
&lt;li&gt;Drive speed reduced to a lower RPM (reduced RPM)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Standby_Z&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Heads are unloaded to drive ramp.&lt;/li&gt;
&lt;li&gt;Drive motor is spun down.&lt;/li&gt;
&lt;li&gt;Drive still responds to non-media access host commands.&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Storage" scheme="http://yoursite.com/categories/Storage/"/>
    
    
    <category term="block" scheme="http://yoursite.com/tags/block/"/>
    
  </entry>
  
</feed>
