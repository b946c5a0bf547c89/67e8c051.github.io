<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Hello World</title>
      <link href="2020/10/11/hello-world/"/>
      <url>2020/10/11/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><a id="more"></a><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p><h3 id="Add-type"><a href="#Add-type" class="headerlink" title="Add type"></a>Add type</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">source/tags/index.md</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2020-09-28 00:15:41</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">tags</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">source/categories/index.md</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2020-09-28 00:16:03</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">categories</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><p><img src="/img/the_last_word_fs.jpg"><br><img src="/img/hard-disk_223cf.jpg"><br><img src="/img/PROPELLER-2-1-1024x1024.png"><br><img src="/img/operting_system_a32c6f.svg"><br><img src="/img/network-interface-card-2081371-1751392.png"><br><img src="/img/32_connection_nodes_communication_network_seo_social_community_relation-512.png"><br><img src="/img/kisspng-computer-icons-benchmarking-computer-software-clip-5ad795b068f297.2882681215240780004299.jpg"><br><img src="/img/machine-learning-3-robot-developer-working-programming-coding-ai-machine-learning-hello-world-512.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>bpftrace</title>
      <link href="2020/07/24/bpftrace/"/>
      <url>2020/07/24/bpftrace/</url>
      
        <content type="html"><![CDATA[<h3 id="bcc-tools"><a href="#bcc-tools" class="headerlink" title="bcc tools"></a>bcc tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ./vfsstat 5 10</span><br><span class="line">TIME         READ/s  WRITE/s CREATE/s   OPEN/s  FSYNC/s</span><br><span class="line">14:34:53:       575        7        0      537        0</span><br><span class="line">14:34:58:       850        9        0      792        0</span><br><span class="line">14:35:03:       842        8        0      791        0</span><br><span class="line">14:35:08:       580        8        0      535        0</span><br><span class="line">14:35:13:       839        8        0      789        0</span><br><span class="line"></span><br><span class="line">$  bpftrace -e <span class="string">&#x27;kprobe:vfs_* &#123; @[probe] = count() &#125;&#x27;</span></span><br><span class="line">Attaching 53 probes...</span><br><span class="line">^C</span><br><span class="line">@[kprobe:vfs_llseek]: 1</span><br><span class="line">@[kprobe:vfs_fsync_range]: 33</span><br><span class="line">@[kprobe:vfs_iter_write]: 61</span><br><span class="line">@[kprobe:vfs_statfs]: 93</span><br><span class="line">@[kprobe:vfs_statx_fd]: 469</span><br><span class="line">@[kprobe:vfs_statx]: 2299</span><br><span class="line">@[kprobe:vfs_getattr_nosec]: 2872</span><br><span class="line">@[kprobe:vfs_getattr]: 2873</span><br><span class="line">@[kprobe:vfs_write]: 3754</span><br><span class="line">@[kprobe:vfs_open]: 4965</span><br><span class="line">@[kprobe:vfs_read]: 8020</span><br></pre></td></tr></table></figure><h3 id="list-all-events"><a href="#list-all-events" class="headerlink" title="list all events"></a>list all events</h3><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -l </span><br><span class="line">$ bpftrace -l <span class="string">&#x27;*sleep*&#x27;</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;tracepoint:syscalls:sys_enter_*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># args is a pointer to a struct containing all the tracepoint arguments. This struct is automatically generated by bpftrace based tracepoint information. The members of this struct can be found with </span></span><br><span class="line">$ bpftrace -lv tracepoint:syscalls:sys_enter_open </span><br><span class="line">tracepoint:syscalls:sys_enter_open</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    const char * filename;</span><br><span class="line">    int flags;</span><br><span class="line">    umode_t mode;</span><br><span class="line"></span><br><span class="line"><span class="comment"># If BTF is available, it is also possible to list struct/union/emum definitions. For example:</span></span><br><span class="line">$ bpftrace -lv <span class="string">&quot;struct path&quot;</span></span><br><span class="line">BTF: using data from /sys/kernel/btf/vmlinux</span><br><span class="line">struct path &#123;</span><br><span class="line">        struct vfsmount *mnt;</span><br><span class="line">        struct dentry *dentry;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><p>@name    global<br>@name[key]    hash<br>@name[tid]    thread-local<br>$name    scratch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Timing Reads by Process</span></span><br><span class="line">                  ------Probe Types, Kernel dynamic <span class="keyword">function</span> instrumentation</span><br><span class="line">                  |                 ---------thread-local Variable, custom</span><br><span class="line">                  |                 |       -------------Builtin Variable</span><br><span class="line">                  |                 |       |      ---Builtin Variable                                ---Builtin Variable                    ---Builtin Function</span><br><span class="line">                  |                 |       |      |                                                  |            |                         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;kprobe:vfs_read &#123; @tttstart[tid] = nsecs; &#125; kretprobe:vfs_read /@tttstart[tid]/ &#123; @ns[comm] = hist(nsecs - @tttstart[tid]); delete(@tttstart[tid]); &#125;&#x27;</span></span><br><span class="line">                                                            |                                                 |</span><br><span class="line">                                                            |                                                 ---Builtin Function</span><br><span class="line">                                                            ---Probe Types, Kernel dynamic <span class="keyword">function</span> <span class="built_in">return</span> instrumentation</span><br><span class="line"></span><br><span class="line">$ cat path.bt</span><br><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;open path: %s\n&quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Show-file-name"><a href="#Show-file-name" class="headerlink" title="Show file name"></a>Show file name</h4><p>filename</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e &#x27;tracepoint:syscalls:sys_enter_openat &#123; printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); &#125;&#x27;</span><br><span class="line">$ bpftrace --include linux/path.h --include linux/dcache.h     -e &#x27;kprobe:vfs_open &#123; printf(&quot;open path: %s\n&quot;, str(((path *)arg0)-&gt;dentry-&gt;d_name.name)); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/path.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/dcache.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* wait fd2path/path to the new version https://github.com/iovisor/bpftrace/issues/29 */</span></span><br><span class="line"><span class="comment">/* only print parent dir name and file name */</span></span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open path:%s/%s,uid: %d,cmd %s, &quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_name.name), str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name), uid, comm);</span><br><span class="line">    @start = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;take ns: %d\n&quot;</span>, (nsecs - @start));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##<span class="meta"># fs/open.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_open - open the file at the given path</span></span><br><span class="line"><span class="comment"> * @path: path to open</span></span><br><span class="line"><span class="comment"> * @file: newly allocated file with f_flag initialized</span></span><br><span class="line"><span class="comment"> * @cred: credentials to use</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_open</span><span class="params">(<span class="keyword">const</span> struct path *path, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">file-&gt;f_path = *path;</span><br><span class="line"><span class="keyword">return</span> do_dentry_open(file, d_backing_inode(path-&gt;dentry), <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/path.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/dcache.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line"><span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> d_flags;<span class="comment">/* protected by d_lock */</span></span><br><span class="line"><span class="keyword">seqcount_t</span> d_seq;<span class="comment">/* per dentry seqlock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span><span class="comment">/* lookup hash list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span><span class="comment">/* parent directory */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span><span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment"> * negative */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> d_iname[DNAME_INLINE_LEN];<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span><span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span><span class="comment">/* The root of the dentry tree */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_time;<span class="comment">/* used by d_revalidate */</span></span><br><span class="line"><span class="keyword">void</span> *d_fsdata;<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span><span class="comment">/* LRU list */</span></span><br><span class="line"><span class="keyword">wait_queue_head_t</span> *d_wait;<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span><span class="comment">/* child of parent list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span><span class="comment">/* our children */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span><span class="comment">/* inode alias list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span><span class="comment">/* only for in-lookup ones */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">&#125; d_u;</span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>path</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open path: %s\n&quot;</span>, str(((path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="trace-user-space-application"><a href="#trace-user-space-application" class="headerlink" title="trace user space application"></a><a href="https://www.percona.com/sites/default/files/presentations/Scale18x-2020-bpfTrace-finally-dTrace-replacement.pdf">trace user space application</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   binaray file ------------         -----------the <span class="keyword">function</span> from hello_world</span><br><span class="line">                           |         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:~/hello_world:hello &#123;printf(&quot;%s\n&quot;, ustack());&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p><a href="http://blog.jcix.top/2019-12-04/bpftrace-profiling/">example</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;time.h&gt;</span></span><br><span class="line"> </span><br><span class="line">void sleep_func(int sleep_time_us)</span><br><span class="line">&#123;</span><br><span class="line">    usleep(sleep_time_us);</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int lower = 0, upper = 100;</span><br><span class="line">    srand(time(0));</span><br><span class="line">    <span class="keyword">for</span> (int k = 1000; k &gt; 0; k--) &#123;</span><br><span class="line">        int sleep_time_us = 0;</span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            sleep_time_us += rand() % (upper - lower) + lower;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;us: %d\n&quot;</span>, sleep_time_us);</span><br><span class="line">        sleep_func(sleep_time_us);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">------------------------------------ </span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line">uprobe:~/sleep_prog:sleep_func</span><br><span class="line">&#123;</span><br><span class="line">    @t_start=nsecs;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">uretprobe:~/sleep_prog:sleep_func</span><br><span class="line">/@t_start/</span><br><span class="line">&#123;</span><br><span class="line">    @my_hist = lhist(nsecs - @t_start, 0, 10000000, 50000);</span><br><span class="line">    clear(@t_start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@my_hist:</span><br><span class="line">[250000, 300000)       1 |                                                    |</span><br><span class="line">[300000, 350000)       6 |@@                                                  |</span><br><span class="line">[350000, 400000)      14 |@@@@@@                                              |</span><br><span class="line">[400000, 450000)      39 |@@@@@@@@@@@@@@@@                                    |</span><br><span class="line">[450000, 500000)      63 |@@@@@@@@@@@@@@@@@@@@@@@@@@@                         |</span><br><span class="line">[500000, 550000)     120 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[550000, 600000)      82 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 |</span><br><span class="line">[600000, 650000)      96 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           |</span><br><span class="line">[650000, 700000)      53 |@@@@@@@@@@@@@@@@@@@@@@                              |</span><br><span class="line">[700000, 750000)      18 |@@@@@@@                                             |</span><br><span class="line">[750000, 800000)       7 |@@@                                                 |</span><br><span class="line">[800000, 850000)       0 |                                                    |</span><br><span class="line">[850000, 900000)       0 |                                                    |</span><br><span class="line">[900000, 950000)       0 |                                                    |</span><br><span class="line">[950000, 1000000)       0 |                                                    |</span><br><span class="line">[1000000, 1050000)       0 |                                                    |</span><br><span class="line">[1050000, 1100000)       0 |                                                    |</span><br><span class="line">[1100000, 1150000)       0 |                                                    |</span><br><span class="line">[1150000, 1200000)       1 |                                                    |</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>uprobe:/bin/bash:readline (the function begining)<br>uretprobe:/bin/bash:readline (the function end)</p><p>/sys/kernel/debug/tracing/uprobe_events</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">root@mysql1:~<span class="comment"># bpftrace -e &#x27;uprobe:/usr/sbin/</span></span><br><span class="line">mysqld:dispatch_command &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">Could not resolve symbol: /usr/sbin/mysqld:dispatch_command</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@mysql1:~# nm -D /usr/sbin/mysqld | grep dispatch_command</span></span><br><span class="line"><span class="string">00000000005af770 T</span></span><br><span class="line"><span class="string">_Z16dispatch_command19enum_server_commandP3THDPcjbb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>uprobe:/usr/sbin/mysqld:_Z16dispatch_command19enum_server_commandP3THDPcjbb &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">select @@version_comment limit 1</span></span><br><span class="line"><span class="string">select 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;join(args-&gt;filename)&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,str(args-&gt;filename))&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[pid,comm]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[2423, in:imjournal]: 10</span></span><br><span class="line"><span class="string">@[338226, worker]: 12</span></span><br><span class="line"><span class="string">@[338161, qemu-kvm]: 19</span></span><br><span class="line"><span class="string">@[338161, CPU 0/KVM]: 20</span></span><br><span class="line"><span class="string">@[1898, NetworkManager]: 22</span></span><br><span class="line"><span class="string">@[338226, CPU 0/KVM]: 23</span></span><br><span class="line"><span class="string">@[2517288, sshd]: 24</span></span><br><span class="line"><span class="string">@[338513, CPU 1/KVM]: 24</span></span><br><span class="line"><span class="string">@[338226, qemu-kvm]: 29</span></span><br><span class="line"><span class="string">@[338161, CPU 3/KVM]: 42</span></span><br><span class="line"><span class="string">@[2801247, bpftrace]: 48</span></span><br><span class="line"><span class="string">@[338098, CPU 1/KVM]: 66</span></span><br><span class="line"><span class="string">@[338161, SPICE Worker]: 169</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_* &#123;@[probe,comm]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 320 probes...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_madvise, qemu-kvm]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_select, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_getpid, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_waitid, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, irqbalance]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_inotify_add_watch, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_ioctl, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_rt_sigreturn, bpftrace]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_pwrite64, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_fdatasync, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_read, sshd]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_write, sshd]: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[ksym(*(kaddr(<span class="string">&quot;sys_call_table&quot;</span>) + args-&gt;id * 8))]=count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[__x64_sys_inotify_add_watch]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_exit]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigreturn]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_getpid]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_madvise]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_pwrite64]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_fdatasync]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_recvmmsg]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_select]: 6</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigprocmask]: 8</span></span><br><span class="line"><span class="string">@[__x64_sys_clock_gettime]: 12</span></span><br><span class="line"><span class="string">@[__x64_sys_newfstat]: 34</span></span><br><span class="line"><span class="string">@[__x64_sys_close]: 36</span></span><br><span class="line"><span class="string">@[__x64_sys_openat]: 50</span></span><br><span class="line"><span class="string">@[__x64_sys_epoll_wait]: 70</span></span><br><span class="line"><span class="string">@[__x64_sys_futex]: 81</span></span><br><span class="line"><span class="string">@[__x64_sys_ppoll]: 108</span></span><br><span class="line"><span class="string">@[__x64_sys_read]: 297</span></span><br><span class="line"><span class="string">@[__x64_sys_write]: 327</span></span><br><span class="line"><span class="string">@[__x64_sys_ioctl]: 334</span></span><br><span class="line"><span class="string">@[__x64_sys_poll]: 430</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:99 /pid == 189/ &#123;@[ustack] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:49 &#123;@[ustack, kstack, comm] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[,</span></span><br><span class="line"><span class="string">    poll_idle+45</span></span><br><span class="line"><span class="string">    cpuidle_enter_state+115</span></span><br><span class="line"><span class="string">    cpuidle_enter+44</span></span><br><span class="line"><span class="string">    do_idle+566</span></span><br><span class="line"><span class="string">    cpu_startup_entry+111</span></span><br><span class="line"><span class="string">    start_secondary+423</span></span><br><span class="line"><span class="string">    secondary_startup_64+183</span></span><br><span class="line"><span class="string">, swapper/5]: 1</span></span><br><span class="line"><span class="string">@[</span></span><br><span class="line"><span class="string">    0x7f9e88814ab4</span></span><br><span class="line"><span class="string">    0x696765725f6b6c63</span></span><br><span class="line"><span class="string">,</span></span><br><span class="line"><span class="string">    pointer+521</span></span><br><span class="line"><span class="string">    vsnprintf+892</span></span><br><span class="line"><span class="string">    seq_vprintf+48</span></span><br><span class="line"><span class="string">    seq_printf+83</span></span><br><span class="line"><span class="string">    s_show+123</span></span><br><span class="line"><span class="string">    seq_read+745</span></span><br><span class="line"><span class="string">    proc_reg_read+60</span></span><br><span class="line"><span class="string">    vfs_read+145</span></span><br><span class="line"><span class="string">    ksys_read+79</span></span><br><span class="line"><span class="string">    do_syscall_64+91</span></span><br><span class="line"><span class="string">    entry_SYSCALL_64_after_hwframe+101</span></span><br><span class="line"><span class="string">, bpftrace]: 1</span></span><br></pre></td></tr></table></figure><p>uprobe example</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:/bin/bash:readline &#123; @ = count() &#125;&#x27;</span></span><br><span class="line">$ ./gethostlatency <span class="comment"># host resoltion calls latency (DNS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Get all _IO function from the system library</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;uprobe:/lib64/libc.so.6:_IO*&#x27;</span> | head</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fclose.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fgetpos.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_fgets.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_read</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_write</span><br></pre></td></tr></table></figure><p>Tracepoint</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ls <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing/events</span><br><span class="line">$ cat <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>sched<span class="regexp">/sched_process_exec/</span>format</span><br><span class="line"><span class="attr">name:</span> sched_process_exec</span><br><span class="line"><span class="attr">ID:</span> <span class="number">305</span></span><br><span class="line"><span class="attr">format:</span></span><br><span class="line"><span class="symbol">field:</span>unsigned <span class="keyword">short</span> common_type;<span class="attr">offset:</span><span class="number">0</span>;<span class="attr">size:</span><span class="number">2</span>;<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line"><span class="symbol">field:</span>unsigned <span class="keyword">char</span> common_flags;<span class="attr">offset:</span><span class="number">2</span>;<span class="attr">size:</span><span class="number">1</span>;<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line"><span class="symbol">field:</span>unsigned <span class="keyword">char</span> common_preempt_count;<span class="attr">offset:</span><span class="number">3</span>;<span class="attr">size:</span><span class="number">1</span>;<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line"><span class="symbol">field:</span><span class="keyword">int</span> common_pid;<span class="attr">offset:</span><span class="number">4</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="symbol">field:</span>__data_loc <span class="keyword">char</span>[] filename;<span class="attr">offset:</span><span class="number">8</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"><span class="symbol">field:</span>pid_t pid;<span class="attr">offset:</span><span class="number">12</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"><span class="symbol">field:</span>pid_t old_pid;<span class="attr">offset:</span><span class="number">16</span>;<span class="attr">size:</span><span class="number">4</span>;<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">print <span class="attr">fmt:</span> <span class="string">&quot;filename=%s pid=%d old_pid=%d&quot;</span>, __get_str(filename), REC-&gt;pid, REC-&gt;old_pid</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;tracepoint:sched:sched_process_exec &#123;printf(&quot;exec by %s\n&quot;, comm); &#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Add USDT instrumentation</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="string">&quot;folly/tracing/StaticTracepoint.h&quot;</span></span></span><br><span class="line">readref -n usdt_sample_lib1/libusdt_sample_lib1.so</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;usdt:/tmp/tick:loop &#123;printf (&quot;got: %d\n&quot;, arg0); &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="bcc-tools-1"><a href="#bcc-tools-1" class="headerlink" title="bcc tools"></a>bcc tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">runqslower is BCC tools that lists instance of run queue latency exceeding a configurable threshold and show the process that suffered the latency and its duration</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./runqslower         <span class="comment"># trace run queue latency higher than 10000 us (default)</span></span><br><span class="line">    ./runqslower 1000    <span class="comment"># trace run queue latency higher than 1000 us</span></span><br><span class="line">    ./runqslower -p 123  <span class="comment"># trace pid 123 only</span></span><br><span class="line">[root@test-2643a /usr/share/bcc/tools]<span class="comment"># ./runqslower</span></span><br><span class="line">Tracing run queue latency higher than 10000 us</span><br><span class="line">TIME     COMM             PID           LAT(us)</span><br><span class="line">00:20:20 bwa              5836            22182</span><br><span class="line">00:20:22 sh               5844            12056</span><br><span class="line">00:20:22 bwa              5838            12061</span><br><span class="line">00:20:22 bwa              5835            13001</span><br><span class="line">00:20:22 bwa              5835            12109</span><br><span class="line"></span><br><span class="line">show the distribution of on-cpu time <span class="keyword">for</span> each thread wakeup</span><br><span class="line">tracing schduler contect switch events</span><br><span class="line">$ ./cpudist</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 209      |                                        |</span><br><span class="line">         2 -&gt; 3          : 16066    |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 125262   |****************************************|</span><br><span class="line">         8 -&gt; 15         : 59764    |*******************                     |</span><br><span class="line">        16 -&gt; 31         : 13689    |****                                    |</span><br><span class="line">        32 -&gt; 63         : 2320     |                                        |</span><br><span class="line"></span><br><span class="line"><span class="comment">#trace dd write</span></span><br><span class="line">$ ./cpudist -m -p 3826757</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     msecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 190      |****************************************|</span><br><span class="line">$ ./cpudist -p 3826757</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 11       |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 35       |***************                         |</span><br><span class="line">         8 -&gt; 15         : 41       |******************                      |</span><br><span class="line">        16 -&gt; 31         : 36       |****************                        |</span><br><span class="line">        32 -&gt; 63         : 88       |****************************************|</span><br><span class="line">        64 -&gt; 127        : 32       |**************                          |</span><br><span class="line">       128 -&gt; 255        : 25       |***********                             |</span><br><span class="line">       256 -&gt; 511        : 13       |*****                                   |</span><br><span class="line">       512 -&gt; 1023       : 6        |**                                      |</span><br><span class="line">      1024 -&gt; 2047       : 2        |                                        |</span><br><span class="line"></span><br><span class="line"><span class="comment"># stack tracing as a list of function</span></span><br><span class="line">$ ./profile -p 3826757</span><br><span class="line">Sampling at 49 Hertz of PID 3826757 by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    b<span class="string">&#x27;_raw_spin_lock&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;_raw_spin_lock&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;dmu_buf_will_dirty_impl&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_attr_op&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_bulk_update_impl&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_bulk_update&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b<span class="string">&#x27;__slab_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;__slab_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;kmem_cache_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;spl_kmem_cache_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_hdr_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_alloc_buf&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_loan_buf&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b<span class="string">&#x27;dmu_tx_hold_sa&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;dmu_tx_hold_sa&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">show the <span class="built_in">read</span> requested size since entry to the syscall was <span class="keyword">in</span> instrumented</span><br><span class="line"></span><br><span class="line">$ ./argdist -H <span class="string">&#x27;t:syscalls:sys_exit_read():int:args-&gt;ret&#x27;</span></span><br><span class="line">[00:36:40]</span><br><span class="line">     args-&gt;ret           : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 1        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 0        |                                        |</span><br><span class="line">       256 -&gt; 511        : 0        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 0        |                                        |</span><br><span class="line">      1024 -&gt; 2047       : 0        |                                        |</span><br><span class="line">      2048 -&gt; 4095       : 0        |                                        |</span><br><span class="line">      4096 -&gt; 8191       : 0        |                                        |</span><br><span class="line">      8192 -&gt; 16383      : 3584     |****************************************|</span><br><span class="line"></span><br><span class="line">$  bpftrace -lv <span class="string">&#x27;tracepoint:syscalls:sys_exit_write&#x27;</span></span><br><span class="line">tracepoint:syscalls:sys_exit_write</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    long ret;</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_exit_write &#123; @ = hist(args-&gt;ret) &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">c^C</span><br><span class="line"></span><br><span class="line">@:</span><br><span class="line">[1]                    2 |                                                    |</span><br><span class="line">[2, 4)                 0 |                                                    |</span><br><span class="line">[4, 8)                 0 |                                                    |</span><br><span class="line">[8, 16)               45 |@                                                   |</span><br><span class="line">[16, 32)              18 |                                                    |</span><br><span class="line">[32, 64)               1 |                                                    |</span><br><span class="line">[64, 128)              0 |                                                    |</span><br><span class="line">[128, 256)             0 |                                                    |</span><br><span class="line">[256, 512)             0 |                                                    |</span><br><span class="line">[512, 1K)              0 |                                                    |</span><br><span class="line">[1K, 2K)               0 |                                                    |</span><br><span class="line">[2K, 4K)               0 |                                                    |</span><br><span class="line">[4K, 8K)               0 |                                                    |</span><br><span class="line">[8K, 16K)              0 |                                                    |</span><br><span class="line">[16K, 32K)             0 |                                                    |</span><br><span class="line">[32K, 64K)             0 |                                                    |</span><br><span class="line">[64K, 128K)            0 |                                                    |</span><br><span class="line">[128K, 256K)           0 |                                                    |</span><br><span class="line">[256K, 512K)           0 |                                                    |</span><br><span class="line">[512K, 1M)             0 |                                                    |</span><br><span class="line">[1M, 2M)            1558 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">$ ./funccount -i 1  <span class="string">&#x27;tcp_*&#x27;</span></span><br><span class="line">Tracing 282 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;tcp_*&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">tcp_drop                                    1</span><br><span class="line">tcp_validate_incoming                       1</span><br><span class="line">tcp_send_dupack                             1</span><br><span class="line">tcp_oow_rate_limited                        1</span><br><span class="line">tcp_write_wakeup                            3</span><br><span class="line">tcp_xmit_probe_skb                          3</span><br><span class="line">tcp_delack_timer                            4</span><br><span class="line">tcp_delack_timer_handler                    6</span><br><span class="line">tcp_write_timer                             6</span><br><span class="line">tcp_poll                                    6</span><br><span class="line">tcp_keepalive_timer                         7</span><br><span class="line">tcp_write_timer_handler                     7</span><br><span class="line">tcp_try_rmem_schedule                       7</span><br><span class="line">tcp_init_cwnd                               8</span><br><span class="line">tcp_urg                                    12</span><br><span class="line">tcp_data_queue                             15</span><br><span class="line">tcp_check_space                            30</span><br><span class="line">tcp_set_skb_tso_segs                       38</span><br><span class="line">tcp_nagle_check                            38</span><br><span class="line">tcp_ack                                    42</span><br><span class="line">tcp_stream_memory_free                     44</span><br><span class="line">tcp_send_mss                               54</span><br><span class="line">tcp_init_tso_segs                          54</span><br><span class="line">tcp_wfree                                  57</span><br><span class="line">tcp_event_new_data_sent                    72</span><br><span class="line"></span><br><span class="line">$ ./funccount -i 1  <span class="string">&#x27;get_page_from_freelist&#x27;</span></span><br><span class="line">Tracing 1 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;get_page_from_freelist&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">get_page_from_freelist                  14785</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">get_page_from_freelist                   7397</span><br><span class="line"></span><br><span class="line">$ ./execsnoop</span><br><span class="line">PCOMM            PID    PPID   RET ARGS</span><br><span class="line">ps               205430 205429   0 /usr/bin/ps aux</span><br><span class="line">grep             205431 205429   0 /usr/bin/grep nobody</span><br><span class="line">awk              205432 205429   0 /usr/bin/awk <span class="variable">$3</span>&gt;0 &#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;</span><br><span class="line">tail             205434 205429   0 /usr/bin/tail -n 1</span><br><span class="line">ls               205436 205435   0 /usr/bin/ls /proc/204067/fd</span><br><span class="line">grep             205437 205435   0 /usr/bin/grep -v dev</span><br><span class="line">grep             205438 205435   0 /usr/bin/grep -v socket</span><br><span class="line">wc               205439 205435   0 /usr/bin/wc -l</span><br><span class="line">sleep            205440 210303   0 /usr/bin/sleep 5</span><br><span class="line"></span><br><span class="line">$ ./syscount -p 204067</span><br><span class="line">Tracing syscalls, printing top 10... Ctrl+C to quit.</span><br><span class="line">^C[12:26:18]</span><br><span class="line">SYSCALL                   COUNT</span><br><span class="line">sched_yield              187351</span><br><span class="line"><span class="built_in">read</span>                      26216</span><br><span class="line">mprotect                   7533</span><br><span class="line">futex                      1863</span><br><span class="line">write                        24</span><br><span class="line"></span><br><span class="line">$ ./profile -F 49 -U -p 204067</span><br><span class="line">Sampling at 49 Hertz of PID 204067 by user stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    ParCompactionManager::follow_marking_stacks()</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    ParallelTaskTerminator::offer_termination(TerminatorTerminator*)</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">$ ./trace <span class="string">&#x27;c:malloc &quot;size = %d&quot;, arg1&#x27;</span></span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 100</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 22</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 32</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 22</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 100</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 22</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 32</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 22</span><br><span class="line">338098  338124  CPU 1/KVM       malloc           size = 32</span><br><span class="line"></span><br><span class="line">$ ./trace /lib64/libpthread-2.28.so:pthread_create</span><br><span class="line">PID     TID     COMM            FUNC</span><br><span class="line">338161  338161  qemu-kvm        pthread_create</span><br></pre></td></tr></table></figure><h3 id="Memroy-allocators"><a href="#Memroy-allocators" class="headerlink" title="Memroy allocators"></a>Memroy allocators</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Process                         kernel          Slab allocator    page allocator</span><br><span class="line">  |                               |                   |                |</span><br><span class="line">Segments    libc allocator     ext4/scsi module-----caches-----------free lists-------DRAM(physical)</span><br><span class="line">  |             |                                                      |</span><br><span class="line">Heap----------memory----------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Application                    virtual mem                              </span><br><span class="line">   |                               |   ----------------------------------------physical mem</span><br><span class="line">   |&lt;-----------------------------||   |                                            ^</span><br><span class="line">Allocator (libc)                  ||   V                                            |</span><br><span class="line">1.malloc()--------2a blk---------&gt;heap(from high to low)----&gt;3.lookup--mmu--&gt;4.page fault</span><br><span class="line">  free()       |                   |  |</span><br><span class="line">  realloc()    |                   V  |</span><br><span class="line">  calloc()     |                      ------------------5.page out------------&gt;swap device</span><br><span class="line">               |</span><br><span class="line">               -2b mmap/munmap---&gt;mappings                          </span><br><span class="line">                             (processs address space)</span><br></pre></td></tr></table></figure><p>tcmalloc and jemalloc provide their own allocator along with garbage collection</p><p>trace PMCs for memory I/O events</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$  perf <span class="built_in">stat</span> -e LLC-loads,LLC-load-misses -a -I 1000</span><br><span class="line"><span class="comment">#           time             counts unit events</span></span><br><span class="line">     1.005137445        559,247,421      LLC-loads</span><br><span class="line">     1.005137445        269,259,408      LLC-load-misses           <span class="comment">#   48.15% of all LL-cache hits</span></span><br><span class="line">     2.007241604        551,600,432      LLC-loads</span><br><span class="line">     2.007241604        267,976,111      LLC-load-misses           <span class="comment">#   48.25% of all LL-cache hits</span></span><br><span class="line">     3.009090791        552,723,650      LLC-loads</span><br><span class="line">     3.009090791        268,186,466      LLC-load-misses           <span class="comment">#   48.36% of all LL-cache hits</span></span><br><span class="line">     4.011116721        560,135,096      LLC-loads</span><br><span class="line">     4.011116721        268,988,337      LLC-load-misses           <span class="comment">#   48.39% of all LL-cache hits</span></span><br><span class="line">$ perf record -e L1-dcache-load-misses -c 100000 -a</span><br><span class="line">$ perf report -n --stdio</span><br></pre></td></tr></table></figure><h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">page cache &lt;--&gt; filesystem              RAW block device</span><br><span class="line">                   |                        |</span><br><span class="line">                   |                        |</span><br><span class="line">                   --------------------------</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     block device interface</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     Volume manager (<span class="keyword">if</span> used)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     Device Mapper (<span class="keyword">if</span> used)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                         Block layer </span><br><span class="line">            classic scheduler  or  Multi queue scheduler</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                    Host Bus adaptor Driver(scsi)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                        Disk devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># blk_fill_rwbs</span></span><br><span class="line">R: <span class="built_in">read</span>    </span><br><span class="line">W: Write    </span><br><span class="line">M: Metadata    </span><br><span class="line">S: Synchronous</span><br><span class="line">A: Readahead</span><br><span class="line">F: Flush or force unit access</span><br><span class="line">D: Discard</span><br><span class="line">E: Erase</span><br><span class="line">N: None</span><br><span class="line"></span><br><span class="line">IO scduler</span><br><span class="line">Noop/Dealine/CFQ</span><br><span class="line">blk-mq (linux 3.13)</span><br></pre></td></tr></table></figure><p>In the event of a system failure while there are active writes, the parity of a stripe may become inconsistent with the data. If this is not detected and repaired before a disk or block fails, data loss may ensue as incorrect parity will be used to reconstruct the missing block in that stripe. This potential vulnerability is sometimes known as the write hole. Battery-backed cache and similar techniques are commonly used to reduce the window of opportunity for this to occur. The same issue occurs for RAID-6.</p><h4 id="storage-example"><a href="#storage-example" class="headerlink" title="storage example"></a><a href="https://www.informit.com/articles/article.aspx?p=2995360&seqNum=3#">storage example</a></h4><p>This tool needs to store a timestamp at the start of each I/O to record its duration (latency)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">################</span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @start[args-&gt;dev, args-&gt;sector] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/@start[args-&gt;dev, args-&gt;sector]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[args-&gt;dev, args-&gt;sector]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[args-&gt;dev, args-&gt;sector]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###############</span><br><span class="line"></span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                  |</span><br><span class="line">[<span class="number">128</span>, <span class="number">256</span>)             <span class="number">1</span> |@@@@@@@@@@@@@@@@@                                   |</span><br><span class="line">[<span class="number">256</span>, <span class="number">512</span>)             <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">512</span>, <span class="number">1</span>K)              <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">1</span>K, <span class="number">2</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">4</span>K, <span class="number">8</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">8</span>K, <span class="number">16</span>K)              <span class="number">3</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>Traces the full duration of the I/O</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12s %-16s %-6s %7s\n&quot;</span>, <span class="string">&quot;TIME(ms)&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;LAT(ms)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">        @iopid[arg0] = pid;</span><br><span class="line">        @iocomm[arg0] = comm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0] != <span class="number">0</span> &amp;&amp; @iopid[arg0] != <span class="number">0</span> &amp;&amp; @iocomm[arg0] != <span class="string">&quot;&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        $now = nsecs;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12u %-16s %-6d %7d\n&quot;</span>,</span><br><span class="line">            elapsed / <span class="number">1000000</span>, @iocomm[arg0], @iopid[arg0],</span><br><span class="line">            ($now - @start[arg0]) / <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span>(@start[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@iopid[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@iocomm[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">        clear(@iopid);</span><br><span class="line">        clear(@iocomm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME(ms)     <span class="function">COMM             PID    <span class="title">LAT</span><span class="params">(ms)</span></span></span><br><span class="line"><span class="function">4763         vim              55675        0</span></span><br><span class="line"><span class="function">4763         vim              55675        0</span></span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br></pre></td></tr></table></figure><p>biosize</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @[args-&gt;comm] = hist(args-&gt;bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nI/O size (bytes) histograms by process name:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">3</span> probes...</span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">I/<span class="function">O <span class="title">size</span> <span class="params">(bytes)</span> histograms by process name:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line">@[kworker/u434:1]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[vim]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[kworker/<span class="number">21</span>:<span class="number">2</span>]:</span><br><span class="line">[<span class="number">8</span>, <span class="number">16</span>)                <span class="number">3</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>seeksize<br>show how many sectors that processes are requesting the disks to seek</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        printf(<span class="string">&quot;Tracing block I/O requested seeks... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (@last[args-&gt;dev]) &#123;</span><br><span class="line">                <span class="comment">// calculate requested seek distance</span></span><br><span class="line">                $last = @last[args-&gt;dev];</span><br><span class="line">                $dist = (args-&gt;sector - $last) &gt; <span class="number">0</span> ?</span><br><span class="line">                    args-&gt;sector - $last : $last - args-&gt;sector;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// store details</span></span><br><span class="line">                @sectors[args-&gt;comm] = hist($dist);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// save last requested position of disk head</span></span><br><span class="line">        @last[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">clear</span>(@last);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">3</span> probes...</span><br><span class="line">Tracing block I/O requested seeks... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@sectors[bash]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/<span class="number">15</span>:<span class="number">1</span>]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/u433:<span class="number">0</span>]:</span><br><span class="line">[<span class="number">256</span>M, <span class="number">512</span>M)           <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[vim]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[xfsaild/sda3]:</span><br><span class="line">[<span class="number">128</span>M, <span class="number">256</span>M)           <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[sync]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>biopattern<br>identify the pattern of I/O: random or sequential</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %5s %5s %8s %10s\n&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;%RND&quot;</span>, <span class="string">&quot;%SEQ&quot;</span>, <span class="string">&quot;COUNT&quot;</span>,</span><br><span class="line">            <span class="string">&quot;KBYTES&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (@lastsector[args-&gt;dev] == args-&gt;sector) &#123;</span><br><span class="line">                @sequential++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @random++;</span><br><span class="line">        &#125;</span><br><span class="line">        @bytes = @bytes + args-&gt;nr_sector * <span class="number">512</span>;</span><br><span class="line">        @lastsector[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interval:s:<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">        $count = @random + @sequential;</span><br><span class="line">        $div = $count;</span><br><span class="line">        <span class="keyword">if</span> ($div == <span class="number">0</span>) &#123;</span><br><span class="line">                $div = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%5d %5d %8d %10d\n&quot;</span>, @random * <span class="number">100</span> / $div,</span><br><span class="line">            @sequential * <span class="number">100</span> / $div, $count, @bytes / <span class="number">1024</span>);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@lastsector);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME      %RND  %SEQ    COUNT     KBYTES</span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">58</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">59</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>         <span class="number">16</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">00</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">01</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">03</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">04</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">05</span>    <span class="number">75</span>    <span class="number">25</span>        <span class="number">8</span>         <span class="number">48</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">06</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">07</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">08</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure><p>biostacks</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O with init stacks. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @reqstack[arg0] = kstack;</span><br><span class="line">        @reqts[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@reqts[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs[@reqstack[arg0]] = hist(nsecs - @reqts[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@reqstack[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@reqts[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@reqstack); clear(@reqts);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">5</span> probes...</span><br><span class="line">Tracing block I/O with init stacks. Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs[</span><br><span class="line">    blk_account_io_start+<span class="number">1</span></span><br><span class="line">    generic_make_request+<span class="number">327</span></span><br><span class="line">    submit_bio+<span class="number">112</span></span><br><span class="line">    xfs_submit_ioend.isra<span class="number">.12</span>+<span class="number">97</span></span><br><span class="line">    xfs_vm_writepages+<span class="number">127</span></span><br><span class="line">    do_writepages+<span class="number">33</span></span><br><span class="line">    __filemap_fdatawrite_range+<span class="number">101</span></span><br><span class="line">    filemap_write_and_wait_range+<span class="number">65</span></span><br><span class="line">    xfs_file_fsync+<span class="number">102</span></span><br><span class="line">    do_fsync+<span class="number">103</span></span><br><span class="line">    sys_fsync+<span class="number">16</span></span><br><span class="line">    system_call_fastpath+<span class="number">37</span></span><br><span class="line">]:</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>bioerr</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">perf record -e block:block_rq_complete --filter &#x27;error != 0&#x27;</span><br><span class="line">cat /sys/kernel/debug/tracing/events/block/block_rq_complete/format</span><br><span class="line">bpftrace -e &#x27;kprobe:blk_status_to_errno /arg0/ &#123; @[arg0]++ &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue /args-&gt;dev == 0/ &#123; @[kstack]++ &#125;&#x27;</span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O errors. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/args-&gt;error != <span class="number">0</span>/</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;device: %d,%d, sector: %d, bytes: %d, flags: %s, error: %d\n&quot;</span>,</span><br><span class="line">            args-&gt;dev &gt;&gt; <span class="number">20</span>, args-&gt;dev &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">20</span>) - <span class="number">1</span>), args-&gt;sector,</span><br><span class="line">            args-&gt;nr_sector * <span class="number">512</span>, args-&gt;rwbs, args-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_OK 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NOTSUPP         ((__force blk_status_t)1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TIMEOUT         ((__force blk_status_t)2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NOSPC           ((__force blk_status_t)3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TRANSPORT       ((__force blk_status_t)4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TARGET          ((__force blk_status_t)5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NEXUS           ((__force blk_status_t)6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_MEDIUM          ((__force blk_status_t)7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_PROTECTION      ((__force blk_status_t)8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_RESOURCE        ((__force blk_status_t)9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_IOERR           ((__force blk_status_t)10)</span></span><br></pre></td></tr></table></figure><p>mdflush<br>for tracing flush events from md</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/genhd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing md flush events... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %-6s %-16s %s&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;DEVICE&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:md_flush_request</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-6d %-16s %s\n&quot;</span>, pid, comm,</span><br><span class="line">            ((struct bio *)arg1)-&gt;bi_disk-&gt;disk_name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>iosched<br>traces the time that requests were queued in the I/O scheduler</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;linux/blkdev.h&gt;</span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O schedulers. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:__elv_add_request</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg1] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="variable">$r</span> = (struct request *)arg0;</span><br><span class="line">        @usecs[<span class="variable">$r</span>-&gt;q-&gt;elevator-&gt;<span class="built_in">type</span>-&gt;elevator_name] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / 1000);</span><br><span class="line">        delete(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching 5 probes...</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Warning: could not attach probe kprobe:blk_start_request, skipping.</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Error attaching probe: <span class="string">&#x27;kprobe:__elv_add_request&#x27;</span></span><br></pre></td></tr></table></figure><p>scsilatency<br> to trace SCSI commands with latency distributions</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;scsi/scsi_cmnd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing scsi latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// SCSI opcodes from scsi/scsi_proto.h; add more mappings if desired:</span></span><br><span class="line">        @opcode[<span class="number">0x00</span>] = <span class="string">&quot;TEST_UNIT_READY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x03</span>] = <span class="string">&quot;REQUEST_SENSE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x08</span>] = <span class="string">&quot;READ_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0a</span>] = <span class="string">&quot;WRITE_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0b</span>] = <span class="string">&quot;SEEK_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x12</span>] = <span class="string">&quot;INQUIRY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x18</span>] = <span class="string">&quot;ERASE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x28</span>] = <span class="string">&quot;READ_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2a</span>] = <span class="string">&quot;WRITE_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2b</span>] = <span class="string">&quot;SEEK_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x35</span>] = <span class="string">&quot;SYNCHRONIZE_CACHE&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_init_io</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_done,</span><br><span class="line">kprobe:scsi_mq_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $cmnd = (struct scsi_cmnd *)arg0;</span><br><span class="line">        $opcode = *$cmnd-&gt;req.cmd &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$opcode, @opcode[$opcode]] = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start); clear(@opcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@usecs[<span class="number">74</span>, ]:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">9</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure><p>scsiresult</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_OK          0x00    <span class="comment">/* NO error                                */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_NO_CONNECT  0x01    <span class="comment">/* Couldn&#x27;t connect before timeout period  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_BUS_BUSY    0x02    <span class="comment">/* BUS stayed busy through time out period */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_TIME_OUT    0x03    <span class="comment">/* TIMED OUT for other reason              */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_BAD_TARGET  0x04    <span class="comment">/* BAD target.    </span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">#!/usr/bin/bpftrace</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">BEGIN</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        printf(&quot;Tracing scsi command results. Hit Ctrl-C to end.\n&quot;);</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">        // host byte codes, from include/scsi/scsi.h:</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x00] = &quot;DID_OK&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x01] = &quot;DID_NO_CONNECT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x02] = &quot;DID_BUS_BUSY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x03] = &quot;DID_TIME_OUT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x04] = &quot;DID_BAD_TARGET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x05] = &quot;DID_ABORT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x06] = &quot;DID_PARITY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x07] = &quot;DID_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x08] = &quot;DID_RESET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x09] = &quot;DID_BAD_INTR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0a] = &quot;DID_PASSTHROUGH&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0b] = &quot;DID_SOFT_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0c] = &quot;DID_IMM_RETRY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0d] = &quot;DID_REQUEUE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0e] = &quot;DID_TRANSPORT_DISRUPTED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0f] = &quot;DID_TRANSPORT_FAILFAST&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x10] = &quot;DID_TARGET_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x11] = &quot;DID_NEXUS_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x12] = &quot;DID_ALLOC_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x13] = &quot;DID_MEDIUM_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">        // status byte codes, from include/scsi/scsi_proto.h:</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x00] = &quot;SAM_STAT_GOOD&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x02] = &quot;SAM_STAT_CHECK_CONDITION&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x04] = &quot;SAM_STAT_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x08] = &quot;SAM_STAT_BUSY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x10] = &quot;SAM_STAT_INTERMEDIATE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x14] = &quot;SAM_STAT_INTERMEDIATE_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x18] = &quot;SAM_STAT_RESERVATION_CONFLICT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x22] = &quot;SAM_STAT_COMMAND_TERMINATED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x28] = &quot;SAM_STAT_TASK_SET_FULL&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x30] = &quot;SAM_STAT_ACA_ACTIVE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x40] = &quot;SAM_STAT_TASK_ABORTED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @[@host[(args-&gt;result &gt;&gt; 16) &amp; 0xff], @status[args-&gt;result &amp; 0xff]] =</span></span></span><br><span class="line"><span class="meta"><span class="comment">            count();</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">END</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        clear(@status);</span></span></span><br><span class="line"><span class="meta"><span class="comment">        clear(@host);</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">Attaching 3 probes...</span></span></span><br><span class="line"><span class="meta"><span class="comment">Tracing scsi command results. Hit Ctrl-C to end.</span></span></span><br><span class="line"><span class="meta"><span class="comment">^C</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">@[DID_OK, SAM_STAT_CHECK_CONDITION]: 1</span></span></span><br><span class="line"><span class="meta"><span class="comment">@[DID_OK, SAM_STAT_GOOD]: 1596</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">driver_byte &lt;&lt; 24 | host_byte &lt;&lt; 16 | msg_byte &lt;&lt; 8 | status_byte</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">bpftrace -lv t:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int host_no;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int channel;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int id;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int lun;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    int result;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int opcode;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int cmd_len;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int data_sglen;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int prot_sglen;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned char prot_op;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    __data_loc unsigned char[] cmnd;</span></span></span><br></pre></td></tr></table></figure><p>nvmelatency<br>traces the nvme storage driver and shows command latencies by disk and nvme command opcode</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> bpftrace -e &#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/blkdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/nvme.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing nvme command latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// from linux/nvme.h:</span></span><br><span class="line">        @ioopcode[<span class="number">0x00</span>] = <span class="string">&quot;nvme_cmd_flush&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x01</span>] = <span class="string">&quot;nvme_cmd_write&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x02</span>] = <span class="string">&quot;nvme_cmd_read&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x04</span>] = <span class="string">&quot;nvme_cmd_write_uncor&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x05</span>] = <span class="string">&quot;nvme_cmd_compare&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x08</span>] = <span class="string">&quot;nvme_cmd_write_zeroes&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x09</span>] = <span class="string">&quot;nvme_cmd_dsm&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0d</span>] = <span class="string">&quot;nvme_cmd_resv_register&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0e</span>] = <span class="string">&quot;nvme_cmd_resv_report&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x11</span>] = <span class="string">&quot;nvme_cmd_resv_acquire&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x15</span>] = <span class="string">&quot;nvme_cmd_resv_release&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_setup_cmd</span><br><span class="line">&#123;</span><br><span class="line">        $req = (struct request *)arg1;</span><br><span class="line">        <span class="keyword">if</span> ($req-&gt;rq_disk) &#123;</span><br><span class="line">                @start[arg1] = nsecs;</span><br><span class="line">                @cmd[arg1] = arg2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @admin_commands = count();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_complete_rq</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $req = (struct request *)arg0;</span><br><span class="line">        $cmd = (struct nvme_command *)@cmd[arg0];</span><br><span class="line">        $disk = $req-&gt;rq_disk;</span><br><span class="line">        $opcode = $cmd-&gt;common.opcode &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$disk-&gt;disk_name, @ioopcode[$opcode]] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[tid]); <span class="keyword">delete</span>(@cmd[tid]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@ioopcode); clear(@start); clear(@cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e &#x27;tracepoint:block:* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;kprobe:scsi* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @bytes = hist(args-&gt;bytes); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = sum(args-&gt;bytes); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_complete /args-&gt;error/ &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dev %d type %s error %d\n&quot;</span>, args-&gt;dev, args-&gt;rwbs, args-&gt;error); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;k:blk_start_plug &#123; @ts[arg0] = nsecs; &#125;</span><br><span class="line">    k:blk_flush_plug_list /@ts[arg0]/ &#123; @plug_ns = hist(nsecs - @ts[arg0]);</span><br><span class="line">    <span class="keyword">delete</span>(@ts[arg0]); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;k:blk_mq_start_request &#123; @swqueues = lhist(cpu, 0, 100, 1); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="comment">//IO type</span></span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = count(); &#125;&#x27;</span><br></pre></td></tr></table></figure><p>not work in centos kernel</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/dcache.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_unlink,tracepoint:syscalls:sys_enter_unlinkat &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s deleted by command &#x27;%s&#x27; with pid %d\n&quot;</span>,</span><br><span class="line">            str(args-&gt;pathname), comm, pid);</span><br><span class="line">    $p = curtask-&gt;real_parent;</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        $i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; ... whose parent is &#x27;%s&#x27; command with pid %d\n&quot;</span>,</span><br><span class="line">               $p-&gt;comm,</span><br><span class="line">               $p-&gt;tgid);</span><br><span class="line">        $p = $p-&gt;parent;</span><br><span class="line">        <span class="keyword">if</span> ($p == <span class="number">0</span> || $p-&gt;tgid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WARNING: Kernel does <span class="keyword">not</span> support bounded loops. Depending on LLVMs loop unroll to generate loadable code.</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    ~~~~~</span><br><span class="line">Attaching <span class="number">2</span> probes...</span><br><span class="line"></span><br><span class="line">Error <span class="built_in">log</span>:</span><br><span class="line">back-edge from insn <span class="number">162</span> to <span class="number">78</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
            <tag> trace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Network bencharmk results</title>
      <link href="2020/07/22/network-benchmark-result/"/>
      <url>2020/07/22/network-benchmark-result/</url>
      
        <content type="html"><![CDATA[<p>Hardware info</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">01:00.0 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line">01:00.1 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line">01:00.2 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line">01:00.3 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line"></span><br><span class="line">$ ethtool -i em2</span><br><span class="line">driver: bnx2x</span><br><span class="line">version: 1.713.36-0 storm 7.13.1.0</span><br><span class="line">firmware-version: FFV15.05.12 bc 7.14.16</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:01:00.1</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br><span class="line"></span><br><span class="line">$ ethtool -k em2</span><br><span class="line">Features <span class="keyword">for</span> em2:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">tx-checksum-ipv4: on</span><br><span class="line">tx-checksum-ip-generic: off [fixed]</span><br><span class="line">tx-checksum-ipv6: on</span><br><span class="line">tx-checksum-fcoe-crc: off [fixed]</span><br><span class="line">tx-checksum-sctp: off [fixed]</span><br><span class="line">scatter-gather: on</span><br><span class="line">tx-scatter-gather: on</span><br><span class="line">tx-scatter-gather-fraglist: off [fixed]</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">tx-tcp-segmentation: on</span><br><span class="line">tx-tcp-ecn-segmentation: on</span><br><span class="line">tx-tcp6-segmentation: on</span><br><span class="line">tx-tcp-mangleid-segmentation: off</span><br><span class="line">udp-fragmentation-offload: off [fixed]</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">large-receive-offload: on</span><br><span class="line">rx-vlan-offload: on [fixed]</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: off [fixed]</span><br><span class="line">receive-hashing: on</span><br><span class="line">highdma: on [fixed]</span><br><span class="line">rx-vlan-filter: on</span><br><span class="line">vlan-challenged: off [fixed]</span><br><span class="line">tx-lockless: off [fixed]</span><br><span class="line">netns-local: off [fixed]</span><br><span class="line">tx-gso-robust: off [fixed]</span><br><span class="line">tx-fcoe-segmentation: off [fixed]</span><br><span class="line">tx-gre-segmentation: on</span><br><span class="line">tx-ipip-segmentation: on</span><br><span class="line">tx-sit-segmentation: on</span><br><span class="line">tx-udp_tnl-segmentation: on</span><br><span class="line">fcoe-mtu: off [fixed]</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off</span><br><span class="line">rx-fcs: off [fixed]</span><br><span class="line">rx-all: off [fixed]</span><br><span class="line">tx-vlan-stag-hw-insert: off [fixed]</span><br><span class="line">rx-vlan-stag-hw-parse: off [fixed]</span><br><span class="line">rx-vlan-stag-filter: off [fixed]</span><br><span class="line">busy-poll: off [fixed]</span><br><span class="line">tx-gre-csum-segmentation: on</span><br><span class="line">tx-udp_tnl-csum-segmentation: on</span><br><span class="line">tx-gso-partial: on</span><br><span class="line">tx-sctp-segmentation: off [fixed]</span><br><span class="line">rx-gro-hw: off</span><br><span class="line">l2-fwd-offload: off [fixed]</span><br><span class="line">hw-tc-offload: off [fixed]</span><br><span class="line">rx-udp_tunnel-port-offload: on</span><br><span class="line"></span><br><span class="line">cat /proc/net/bonding/bond0</span><br><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line"></span><br><span class="line">Bonding Mode: IEEE 802.3ad Dynamic link aggregation</span><br><span class="line">Transmit Hash Policy: layer3+4 (1)</span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line"></span><br><span class="line">802.3ad info</span><br><span class="line">LACP rate: fast</span><br><span class="line">Min links: 0</span><br><span class="line">Aggregator selection policy (ad_select): stable</span><br><span class="line">System priority: 65535</span><br><span class="line">System MAC address: 18:66:da:91:a1:c2</span><br><span class="line">Active Aggregator Info:</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Number of ports: 2</span><br><span class="line">Actor Key: 15</span><br><span class="line">Partner Key: 5697</span><br><span class="line">Partner Mac Address: a0:a3:3b:a8:47:f1</span><br><span class="line"></span><br><span class="line">Slave Interface: em1</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 10000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 18:66:da:91:a1:c2</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Actor Churn State: none</span><br><span class="line">Partner Churn State: none</span><br><span class="line">Actor Churned Count: 0</span><br><span class="line">Partner Churned Count: 0</span><br><span class="line">details actor lacp pdu:</span><br><span class="line">    system priority: 65535</span><br><span class="line">    system mac address: 18:66:da:91:a1:c2</span><br><span class="line">    port key: 15</span><br><span class="line">    port priority: 255</span><br><span class="line">    port number: 1</span><br><span class="line">    port state: 63</span><br><span class="line">details partner lacp pdu:</span><br><span class="line">    system priority: 32768</span><br><span class="line">    system mac address: a0:a3:3b:a8:47:f1</span><br><span class="line">    oper key: 5697</span><br><span class="line">    port priority: 32768</span><br><span class="line">    port number: 72</span><br><span class="line">    port state: 61</span><br><span class="line"></span><br><span class="line">Slave Interface: em2</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 10000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 18:66:da:91:a1:c4</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Actor Churn State: none</span><br><span class="line">Partner Churn State: none</span><br><span class="line">Actor Churned Count: 0</span><br><span class="line">Partner Churned Count: 0</span><br><span class="line">details actor lacp pdu:</span><br><span class="line">    system priority: 65535</span><br><span class="line">    system mac address: 18:66:da:91:a1:c2</span><br><span class="line">    port key: 15</span><br><span class="line">    port priority: 255</span><br><span class="line">    port number: 2</span><br><span class="line">    port state: 63</span><br><span class="line">details partner lacp pdu:</span><br><span class="line">    system priority: 32768</span><br><span class="line">    system mac address: a0:a3:3b:a8:47:f1</span><br><span class="line">    oper key: 5697</span><br><span class="line">    port priority: 32768</span><br><span class="line">    port number: 24</span><br><span class="line">    port state: 61</span><br><span class="line"></span><br><span class="line">$ uname -r</span><br><span class="line">3.10.0-1062.18.1.el7.x86_64</span><br></pre></td></tr></table></figure><h3 id="Network-syscall-performance"><a href="#Network-syscall-performance" class="headerlink" title="Network syscall performance"></a>Network syscall performance</h3><h4 id="net-rx-action"><a href="#net-rx-action" class="headerlink" title="net_rx_action"></a>net_rx_action</h4><h5 id="default-config"><a href="#default-config" class="headerlink" title="default config"></a>default config</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   nsecs               : count     distribution</span><br><span class="line">     0 -&gt; 1          : 0        |                                        |</span><br><span class="line">     2 -&gt; 3          : 0        |                                        |</span><br><span class="line">     4 -&gt; 7          : 0        |                                        |</span><br><span class="line">     8 -&gt; 15         : 0        |                                        |</span><br><span class="line">    16 -&gt; 31         : 0        |                                        |</span><br><span class="line">    32 -&gt; 63         : 0        |                                        |</span><br><span class="line">    64 -&gt; 127        : 0        |                                        |</span><br><span class="line">   128 -&gt; 255        : 194      |                                        |</span><br><span class="line">   256 -&gt; 511        : 69595    |**                                      |</span><br><span class="line">   512 -&gt; 1023       : 166594   |******                                  |</span><br><span class="line">  1024 -&gt; 2047       : 1073825  |****************************************|</span><br><span class="line">  2048 -&gt; 4095       : 1060807  |*************************************** |</span><br><span class="line">  4096 -&gt; 8191       : 365389   |*************                           |</span><br><span class="line">  8192 -&gt; 16383      : 35479    |*                                       |</span><br><span class="line"> 16384 -&gt; 32767      : 3227     |                                        |</span><br><span class="line"> 32768 -&gt; 65535      : 64       |                                        |</span><br><span class="line"> 65536 -&gt; 131071     : 1        |                                        |</span><br><span class="line">131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">524288 -&gt; 1048575    : 208      |                                        |</span><br></pre></td></tr></table></figure><h5 id="default-config-and-set-the-maxinum-ring-buffer"><a href="#default-config-and-set-the-maxinum-ring-buffer" class="headerlink" title="default config and set the maxinum ring buffer"></a>default config and set the maxinum ring buffer</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 981      |                                        |</span><br><span class="line">       256 -&gt; 511        : 360423   |**                                      |</span><br><span class="line">       512 -&gt; 1023       : 826344   |******                                  |</span><br><span class="line">      1024 -&gt; 2047       : 5415487  |****************************************|</span><br><span class="line">      2048 -&gt; 4095       : 5400175  |*************************************** |</span><br><span class="line">      4096 -&gt; 8191       : 1886042  |*************                           |</span><br><span class="line">      8192 -&gt; 16383      : 228200   |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 17444    |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 685      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 0        |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 1132     |                                        |</span><br></pre></td></tr></table></figure><h5 id="modify-sysctl-conf-and-the-default-ring-buffer"><a href="#modify-sysctl-conf-and-the-default-ring-buffer" class="headerlink" title="modify sysctl.conf and the default ring buffer"></a>modify sysctl.conf and the default ring buffer</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">     nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 277      |                                        |</span><br><span class="line">       256 -&gt; 511        : 359712   |****                                    |</span><br><span class="line">       512 -&gt; 1023       : 2159666  |*****************************           |</span><br><span class="line">      1024 -&gt; 2047       : 1922971  |**************************              |</span><br><span class="line">      2048 -&gt; 4095       : 2900044  |****************************************|</span><br><span class="line">      4096 -&gt; 8191       : 867530   |***********                             |</span><br><span class="line">      8192 -&gt; 16383      : 98313    |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 4252     |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 126      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 9        |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 1476     |                                        |</span><br><span class="line">   1048576 -&gt; 2097151    : 1        |                                        |</span><br><span class="line">Detaching...</span><br><span class="line"></span><br><span class="line">Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</span><br><span class="line">Average:        bond0 375553.38 374625.60 2487152.11 2487119.93      0.00      0.00      2.04</span><br><span class="line">Average:           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em3      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em1 194263.43 193304.15 1286454.93 1286414.18      0.00      0.00      1.05</span><br><span class="line">Average:          em4      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em2 181289.94 181321.45 1200697.18 1200705.74      0.00      0.00      0.98</span><br><span class="line"></span><br><span class="line">Average:     atmptf/s  estres/s retrans/s isegerr/s   orsts/s</span><br><span class="line">Average:         0.00      0.00      1.27      0.00      0.00</span><br></pre></td></tr></table></figure><h5 id="modify-sysctl-conf-and-the-maxinum-ring-buffer"><a href="#modify-sysctl-conf-and-the-maxinum-ring-buffer" class="headerlink" title="modify sysctl.conf and the maxinum ring buffer"></a>modify sysctl.conf and the maxinum ring buffer</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">./funclatency net_rx_action</span><br><span class="line">Tracing 1 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;net_rx_action&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 359      |                                        |</span><br><span class="line">       256 -&gt; 511        : 629512   |********                                |</span><br><span class="line">       512 -&gt; 1023       : 2571487  |********************************        |</span><br><span class="line">      1024 -&gt; 2047       : 2720136  |**********************************      |</span><br><span class="line">      2048 -&gt; 4095       : 3120474  |****************************************|</span><br><span class="line">      4096 -&gt; 8191       : 657204   |********                                |</span><br><span class="line">      8192 -&gt; 16383      : 114649   |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 7222     |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 177      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 12       |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 0        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 0        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 2070     |                                        |</span><br><span class="line">   1048576 -&gt; 2097151    : 3        |                                        |</span><br><span class="line">Detaching...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</span><br><span class="line">Average:        bond0 363638.62 362216.28 2404216.56 2404239.59      0.00      0.00      2.00</span><br><span class="line">Average:           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em3      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em1 182095.82 181514.64 1202063.97 1202059.47      0.00      0.00      1.02</span><br><span class="line">Average:          em4      0.00      0.00      0.00      0.00      0.00      0.00      0.00</span><br><span class="line">Average:          em2 181542.80 180701.64 1202152.59 1202180.12      0.00      0.00      0.99</span><br><span class="line"></span><br><span class="line">Average:     atmptf/s  estres/s retrans/s isegerr/s   orsts/s</span><br><span class="line">Average:         0.00      0.00      1.02      0.00      0.00</span><br><span class="line"></span><br><span class="line">again</span><br><span class="line">./funclatency net_rx_action</span><br><span class="line">Tracing 1 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;net_rx_action&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     nsecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 0        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 1251     |                                        |</span><br><span class="line">       256 -&gt; 511        : 1054301  |*********                               |</span><br><span class="line">       512 -&gt; 1023       : 4311900  |*************************************   |</span><br><span class="line">      1024 -&gt; 2047       : 4468684  |**************************************  |</span><br><span class="line">      2048 -&gt; 4095       : 4609367  |****************************************|</span><br><span class="line">      4096 -&gt; 8191       : 902735   |*******                                 |</span><br><span class="line">      8192 -&gt; 16383      : 156803   |*                                       |</span><br><span class="line">     16384 -&gt; 32767      : 14726    |                                        |</span><br><span class="line">     32768 -&gt; 65535      : 313      |                                        |</span><br><span class="line">     65536 -&gt; 131071     : 23       |                                        |</span><br><span class="line">    131072 -&gt; 262143     : 1        |                                        |</span><br><span class="line">    262144 -&gt; 524287     : 1        |                                        |</span><br><span class="line">    524288 -&gt; 1048575    : 3230     |                                        |</span><br><span class="line">   1048576 -&gt; 2097151    : 2        |                                        |</span><br><span class="line">Detaching...</span><br></pre></td></tr></table></figure><h5 id="the-sysctl-conf"><a href="#the-sysctl-conf" class="headerlink" title="the sysctl.conf"></a>the sysctl.conf</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_fastopen=3</span><br><span class="line">vm.min_free_kbytes=270336</span><br><span class="line">kernel.numa_balancing=0</span><br><span class="line">fs.pipe-max-size=104857600</span><br><span class="line">net.core.busy_poll = 50</span><br><span class="line">net.core.busy_read = 50</span><br><span class="line">kernel.sched_migration_cost_ns=5000000</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Benchmark </category>
          
      </categories>
      
      
        <tags>
            
            <tag> test </tag>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The mdraid info</title>
      <link href="2020/06/01/mdadm/"/>
      <url>2020/06/01/mdadm/</url>
      
        <content type="html"><![CDATA[<h3 id="How-to-backup-mdraid-info-by-dd"><a href="#How-to-backup-mdraid-info-by-dd" class="headerlink" title="How to backup mdraid info by dd"></a><a href="https://raid.wiki.kernel.org/index.php/RAID_superblock_formats">How to backup mdraid info by dd</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">md8 : active raid1 sde1[1] sda1[0]</span><br><span class="line">      468717568 blocks super 1.2 [2/2] [UU]</span><br><span class="line">      bitmap: 0/4 pages [0KB], 65536KB chunk</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sda1 of=./sda1 bs=1M count=1</span><br><span class="line"></span><br><span class="line">$ hexdump -C sda1 | head -n 20</span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">Per-Array Identification &amp; Configuration area:16 Bytes</span><br><span class="line">                                                  0xc~0xf: padding block 0 </span><br><span class="line">00001000  <span class="built_in">fc</span> 4e 2b a9 01 00 00 00      01 00 00 00 00 00 00 00  |.N+.............|</span><br><span class="line">Magic num: a92b4efc Major version:1    0x8~0xb bit fearure_map:value 1 offset 0  raid map is used</span><br><span class="line">                                                   value 2 offset 1  raid recovery is progress</span><br><span class="line">                                                   value 4 offset 2 raid reshape is <span class="keyword">in</span> progress</span><br><span class="line">                                                   the others: undefined/reserved</span><br><span class="line"></span><br><span class="line">section: Per-Array Identification &amp; Configuration area 84 Bytes  </span><br><span class="line">          &lt;----------------------uuid--------------------&gt; 0x10-0x1f 16</span><br><span class="line">00001010  cb df 6a 02 54 1a 01 76  9b 9c 29 fe ab 08 8c a0  |..j.T..v..).....|</span><br><span class="line">/dev/sda1: UUID=<span class="string">&quot;cbdf6a02-541a-0176-9b9c-29feab088ca0&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;--------------------------name <span class="keyword">for</span> the array------------&gt; 0x20-0x3f 32</span><br><span class="line">00001020  74 65 73 74 2d 74 65 73  74 2d 61 31 31 2d 32 2e  |test-test-a11-2.|</span><br><span class="line">00001030  74 65 73 74 2e 73 7a 2e  68 70 63 3a 38 00 00 00  |test.sz.hpc:8...|</span><br><span class="line"></span><br><span class="line">ctime(lower 40bit are secs,high 24 bits are microsecs)</span><br><span class="line">                    |               raid1       0 means left asymmetric</span><br><span class="line">                    |                 |            |</span><br><span class="line">00001040  10 77 cc 5e 00 00 00 00  01 00 00 00 00 00 00 00  |.w.^............|a</span><br><span class="line"></span><br><span class="line">         size of component devices(<span class="keyword">in</span> <span class="comment"># of 512-byte sectors),echo $((16#37e02000))=937435136</span></span><br><span class="line">                     |             chucksize not used <span class="keyword">in</span> raid1,linear,multipath</span><br><span class="line">                     |                  |        raid disk(02 means low bit, only 2 x devs to mirror)</span><br><span class="line">00001050  00 20 e0 37 00 00 00 00  00 00 00 00 02 00 00 00  |. .7............|</span><br><span class="line"></span><br><span class="line">          of sectors after superblock that bitmap starts</span><br><span class="line">               |     </span><br><span class="line">00001060  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">Section: RAID-Reshape In-Process Metadata Storage/Recovery area 28 Bytes</span><br><span class="line">         he new RAID level being reshaped-to</span><br><span class="line">                           |       Next address of the array to reshape</span><br><span class="line">                                              |</span><br><span class="line">00001060              00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">     change <span class="keyword">in</span> <span class="comment"># of raid disks</span></span><br><span class="line">               |   new layout <span class="keyword">for</span> array</span><br><span class="line">               |           |      New chunk size; padding block</span><br><span class="line">               |           |            |           |</span><br><span class="line">00001070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Section: This-Component-Device Information area 64Bytes</span><br><span class="line"> the sector <span class="comment"># upon which data starts, sectors in the device that are used for data</span></span><br><span class="line">                     |                        |</span><br><span class="line">00001080  00 08 04 00 00 00 00 00  00 20 e0 37 00 00 00 00  |......... .7....|</span><br><span class="line">of the sector upon <span class="built_in">which</span> this superblock starts</span><br><span class="line">                     |              sectors before this offset (from data_offset) have been recovered</span><br><span class="line">00001090  08 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">           dev_number</span><br><span class="line">               |      Number of read-errors that were corrected by re-writing</span><br><span class="line">               |           |                uuid</span><br><span class="line">000010a0  00 00 00 00 00 00 00 00  07 a8 e4 bf b5 6f c7 d6  |.............o..|</span><br><span class="line">                   uuid           devflags  Padding block 2(1 bit)</span><br><span class="line">                    |              |  Padding block 2 (7 bit)</span><br><span class="line">000010b0  90 d1 9b 62 bf 89 <span class="built_in">cd</span> e7  00 00 08 00 10 00 00 00  |...b............|</span><br><span class="line"></span><br><span class="line">Section: Array-State Information area 64Btes</span><br><span class="line">Time of last superblock update    Event Count <span class="keyword">for</span> the Array</span><br><span class="line">                     |                        |</span><br><span class="line">000010c0  5a 73 d4 5e 00 00 00 00  e6 05 00 00 00 00 00 00  |Zs.^............|</span><br><span class="line"></span><br><span class="line">      Event Count <span class="keyword">for</span> the Array    sb_csum        max_dev 0x80=128</span><br><span class="line">                     |                  |           |</span><br><span class="line">000010d0  ff ff ff ff ff ff ff ff  cf 29 76 cf 80 00 00 00  |.........)v.....|</span><br><span class="line"></span><br><span class="line">&lt;----32Bytes------------zero---------padding-------------&gt;</span><br><span class="line">000010e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">000010f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line"></span><br><span class="line">Section: Device-Roles (Positions-in-Array) area</span><br><span class="line">Length: Variable number of bytes (but at least 768 bytes?)</span><br><span class="line">2 Bytes per device <span class="keyword">in</span> the array, including both spare-devices and faulty-devices</span><br><span class="line">*</span><br><span class="line">00001100  00 00 01 00 ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">00001110  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">          of sectors after superblock that bitmap starts</span><br><span class="line">               |</span><br><span class="line"><span class="number">00001060</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br></pre></td></tr></table></figure><p>In mdraid superblock, you could see bitmap starts at 8 x 512B=4096<br>You could see bitm magic num start at 0x1000=4096</p><p>You could see the data update from 0x1200, so you could backup first 4608 Bytes in raid1<br>dd if=/dev/sdb1 of=sdb1_superblock bs=1 count=4608</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line">*</span><br><span class="line"><span class="number">00001000</span>  fc <span class="number">4</span>e <span class="number">2</span>b a9 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.N+.............|</span><br><span class="line"><span class="number">00001010</span>  a3 <span class="number">00</span> <span class="number">8f</span> <span class="number">75</span> <span class="number">49</span> <span class="number">1</span>d ee e6  <span class="number">38</span> e6 cb d0 e5 <span class="number">3</span>b <span class="number">8</span>b d2  |...uI..<span class="number">.8</span>....;..|</span><br><span class="line"><span class="number">00001020</span>  <span class="number">74</span> <span class="number">65</span> <span class="number">73</span> <span class="number">74</span> <span class="number">2</span>d <span class="number">74</span> <span class="number">65</span> <span class="number">73</span>  <span class="number">74</span> <span class="number">2</span>d <span class="number">61</span> <span class="number">31</span> <span class="number">31</span> <span class="number">2</span>d <span class="number">32</span> <span class="number">2</span>e  |test-test-a11<span class="number">-2.</span>|</span><br><span class="line"><span class="number">00001030</span>  <span class="number">74</span> <span class="number">65</span> <span class="number">73</span> <span class="number">74</span> <span class="number">2</span>e <span class="number">73</span> <span class="number">7</span>a <span class="number">2</span>e  <span class="number">68</span> <span class="number">70</span> <span class="number">63</span> <span class="number">3</span>a <span class="number">30</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |test.sz.hpc:<span class="number">0.</span>..|</span><br><span class="line"><span class="number">00001040</span>  <span class="number">16</span> <span class="number">71</span> cc <span class="number">5</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.q.^............|</span><br><span class="line"><span class="number">00001050</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">49</span> ba <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |..I.............|</span><br><span class="line"><span class="number">00001060</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00001070</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">00001080</span>  <span class="number">00</span> <span class="number">08</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">49</span> ba <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |..........I.....|</span><br><span class="line"><span class="number">00001090</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line"><span class="number">000010</span>a0  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  d5 <span class="number">31</span> <span class="number">5f</span> <span class="number">6</span>a c9 <span class="number">58</span> c2 a0  |........<span class="number">.1</span>_j.X..|</span><br><span class="line"><span class="number">000010</span>b0  <span class="number">55</span> <span class="number">50</span> <span class="number">81</span> dc <span class="number">35</span> <span class="number">4</span>b d1 e3  <span class="number">00</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |UP.<span class="number">.5</span>K..........|</span><br><span class="line"><span class="number">000010</span>c0  <span class="number">5</span>a <span class="number">99</span> d4 <span class="number">5</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>b <span class="number">0</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |Z..^............|</span><br><span class="line"><span class="number">000010</span>d0  ff ff ff ff ff ff ff ff  b5 <span class="number">64</span> <span class="number">59</span> a7 <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.........dY.....|</span><br><span class="line"><span class="number">000010e0</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |................|</span><br><span class="line">*</span><br><span class="line"><span class="number">00001100</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line"><span class="number">00001110</span>  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line"><span class="number">00001200</span>  e8 <span class="number">0f</span> a4 c4 ee <span class="number">8</span>d <span class="number">1</span>a <span class="number">13</span>  fd <span class="number">81</span> a0 d0 <span class="number">6</span>b ef c3 <span class="number">10</span>  |............k...|</span><br><span class="line"><span class="number">00001210</span>  <span class="number">3f</span> <span class="number">90</span> <span class="number">15</span> <span class="number">39</span> <span class="number">9</span>d <span class="number">95</span> <span class="number">0</span>d <span class="number">1</span>d  <span class="number">07</span> <span class="number">32</span> <span class="number">03</span> df <span class="number">28</span> <span class="number">16</span> cc <span class="number">06</span>  |?.<span class="number">.9</span>....<span class="number">.2</span>..(...|</span><br><span class="line"><span class="number">00001220</span>  <span class="number">40</span> e6 dc <span class="number">82</span> <span class="number">43</span> <span class="number">13</span> <span class="number">36</span> <span class="number">1</span>e  c8 <span class="number">9</span>c <span class="number">3</span>b fd f9 <span class="number">00</span> e5 <span class="number">15</span>  |@...C<span class="number">.6</span>...;.....|</span><br><span class="line"><span class="number">00001230</span>  <span class="number">99</span> <span class="number">73</span> <span class="number">43</span> <span class="number">71</span> <span class="number">81</span> a1 b7 <span class="number">19</span>  <span class="number">73</span> ee <span class="number">5</span>b <span class="number">74</span> <span class="number">8</span>e <span class="number">3</span>b <span class="number">65</span> <span class="number">09</span>  |.sCq....s.[t.;e.|</span><br><span class="line"><span class="number">00001240</span>  ce fd <span class="number">51</span> d7 <span class="number">43</span> <span class="number">6</span>d ca <span class="number">07</span>  b9 <span class="number">3f</span> <span class="number">03</span> <span class="number">7</span>c ff <span class="number">61</span> <span class="number">79</span> <span class="number">1f</span>  |..Q.Cm...?.|.ay.|</span><br><span class="line"><span class="number">00001250</span>  f7 e7 a3 <span class="number">4f</span> <span class="number">3</span>e <span class="number">6</span>e be <span class="number">16</span>  fe fc f8 d5              |...O&gt;n......|</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> md </tag>
            
            <tag> raid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C lang</title>
      <link href="2020/03/24/c/"/>
      <url>2020/03/24/c/</url>
      
        <content type="html"><![CDATA[<h3 id="FIO-write"><a href="#FIO-write" class="headerlink" title="FIO write"></a>FIO write</h3><p>if not support fallocate, fio will switch to fadvise64 to write file<br>looks like fadvise64 cause a lot of file system fragment.</p><h3 id="10-billion-or-more-files-in-the-posix-filesystem-directory"><a href="#10-billion-or-more-files-in-the-posix-filesystem-directory" class="headerlink" title="10 billion or more files in the posix filesystem directory"></a>10 billion or more files in the posix filesystem directory</h3><p>ls take a long time, maybe three days or more<br>I moidfy form some C demo files just list some files, the program will exit , not full list</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ time ./walk /tank/<span class="built_in">test</span>/dir1 1000 | wc -l</span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line">real    0m0.016s</span><br><span class="line">user    0m0.000s</span><br><span class="line">sys     0m0.016s</span><br><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ time ls /tank/<span class="built_in">test</span>/dir1/ | wc -l</span><br><span class="line">858601</span><br><span class="line"></span><br><span class="line">real    0m3.320s</span><br><span class="line">user    0m2.841s</span><br><span class="line">sys     0m0.476s</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *fullpath;</span><br><span class="line"><span class="keyword">int</span> global_count=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readfile</span><span class="params">(<span class="keyword">char</span> *k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//printf (&quot;print global_count value: %d\n&quot;,global_count);</span></span><br><span class="line">    DIR * dp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">dirrp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    p = fullpath + <span class="built_in">strlen</span>(fullpath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == lstat(fullpath,&amp;buf))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s[lstat]%s\n&quot;</span>,fullpath,strerror(errno));</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(S_ISDIR(buf.st_mode)==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;file: %s \n&quot;</span>,k); <span class="comment">// output file name</span></span><br><span class="line">        global_count--;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;/&#x27;</span> != *(p<span class="number">-1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">*p++ = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">*p = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dir %s:\n&quot;</span>,fullpath); <span class="comment">//output dir name</span></span><br><span class="line">    global_count--;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == (dp=opendir(fullpath)))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s[opendir]%s\n&quot;</span>,fullpath,strerror(errno));</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">NULL</span> != (dirrp=readdir(dp)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((global_count &lt;= <span class="number">1</span> ))</span><br><span class="line">           <span class="keyword">goto</span> goout;</span><br><span class="line"><span class="keyword">if</span>((<span class="built_in">strcmp</span>(dirrp-&gt;d_name,<span class="string">&quot;.&quot;</span>)==<span class="number">0</span>) || (<span class="built_in">strcmp</span>(dirrp-&gt;d_name,<span class="string">&quot;..&quot;</span>)==<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"><span class="built_in">strcpy</span>(p,dirrp-&gt;d_name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span> == readfile(p))</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    p[<span class="number">-1</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( <span class="number">-1</span> == closedir(dp))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s[closedir]%s\n&quot;</span>,fullpath,strerror(errno));</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">goout:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Usage:%s &lt;Dir name&gt; &lt;List number&gt;\n&quot;</span>,argv[<span class="number">0</span>]+<span class="number">2</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fullpath = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*PATH_MAX);</span><br><span class="line">    <span class="built_in">memset</span>(fullpath,<span class="number">0</span>,PATH_MAX);</span><br><span class="line">    global_count=atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">strcpy</span>(fullpath,argv[<span class="number">1</span>]);</span><br><span class="line">    readfile(fullpath);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="C-convert-string-to-number"><a href="#C-convert-string-to-number" class="headerlink" title="C convert string to number"></a>C convert string to number</h5><p>int atoi(const char *nptr);<br>global_count=atoi(argv[2]);</p><h5 id="memset"><a href="#memset" class="headerlink" title="memset"></a><a href="https://www.geeksforgeeks.org/memset-c-example/">memset</a></h5><p>void *memset(void *ptr, int x, size_t n);<br>// ptr ==&gt; Starting address of memory to be filled<br>// x   ==&gt; Value to be filled<br>// n   ==&gt; Number of bytes to be filled starting<br>//         from ptr to be filled</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C program to demonstrate working of memset() </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; </span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printArray</span><span class="params">(<span class="keyword">int</span> arr[], <span class="keyword">int</span> n)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) </span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]); </span><br><span class="line">&#125; </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">10</span>; </span><br><span class="line">    <span class="keyword">int</span> arr[n]; </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Fill whole array with 0. </span></span><br><span class="line">    <span class="built_in">memset</span>(arr, <span class="number">0</span>, n*<span class="keyword">sizeof</span>(arr[<span class="number">0</span>])); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Array after memset()\n&quot;</span>); </span><br><span class="line">    printArray(arr, n); </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; </span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">50</span>] = <span class="string">&quot;GeeksForGeeks is for programming geeks.&quot;</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nBefore memset(): %s\n&quot;</span>, str); </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Fill 8 characters starting from str[13] with &#x27;.&#x27; </span></span><br><span class="line">    <span class="built_in">memset</span>(str + <span class="number">13</span>, <span class="string">&#x27;.&#x27;</span>, <span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>)); </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After memset():  %s&quot;</span>, str); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h5 id="Some-struct"><a href="#Some-struct" class="headerlink" title="Some struct"></a>Some struct</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/include/dirent.h</span></span><br><span class="line"></span><br><span class="line">/* This is the data <span class="built_in">type</span> of directory stream objects.</span><br><span class="line">   The actual structure is opaque to users.  */</span><br><span class="line">typedef struct __dirstream DIR;</span><br><span class="line"></span><br><span class="line">struct __dirstream   </span><br><span class="line">   &#123;   </span><br><span class="line">    void *__fd;    </span><br><span class="line">    char *__data;    </span><br><span class="line">    int __entry_data;    </span><br><span class="line">    char *__ptr;    </span><br><span class="line">    int __entry_ptr;    </span><br><span class="line">    size_t __allocation;    </span><br><span class="line">    size_t __size;    </span><br><span class="line">    __libc_lock_define (, __lock)    </span><br><span class="line">   &#125;; </span><br><span class="line"></span><br><span class="line">struct dirent   </span><br><span class="line">&#123;   </span><br><span class="line"> long d_ino; /* inode number */</span><br><span class="line"> off_t d_off; /* offset to this dirent */</span><br><span class="line"> unsigned short d_reclen; /* length of this d_name */</span><br><span class="line"> unsigned char d_type; /* the <span class="built_in">type</span> of d_name */</span><br><span class="line">long d_ino; / char d_name [NAME_MAX+1]; /* file name (null-terminated) */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /usr/include/asm/stat.h</span></span><br><span class="line"><span class="comment">#define STAT64_HAS_BROKEN_ST_INO        1</span></span><br><span class="line"></span><br><span class="line">/* This matches struct stat64 <span class="keyword">in</span> glibc2.1, hence the absolutely</span><br><span class="line"> * insane amounts of padding around dev_t<span class="string">&#x27;s.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">struct stat64 &#123;</span></span><br><span class="line"><span class="string">        unsigned long long      st_dev;</span></span><br><span class="line"><span class="string">        unsigned char   __pad0[4];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   __st_ino;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned int    st_mode;</span></span><br><span class="line"><span class="string">        unsigned int    st_nlink;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_uid;</span></span><br><span class="line"><span class="string">        unsigned long   st_gid;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long long      st_rdev;</span></span><br><span class="line"><span class="string">        unsigned char   __pad3[4];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        long long       st_size;</span></span><br><span class="line"><span class="string">        unsigned long   st_blksize;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* Number 512-byte blocks allocated. */</span></span><br><span class="line"><span class="string">        unsigned long long      st_blocks;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_atime;</span></span><br><span class="line"><span class="string">        unsigned long   st_atime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_mtime;</span></span><br><span class="line"><span class="string">        unsigned int    st_mtime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long   st_ctime;</span></span><br><span class="line"><span class="string">        unsigned long   st_ctime_nsec;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        unsigned long long      st_ino;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* We don&#x27;</span>t need to memset the whole thing just to initialize the padding */</span><br><span class="line"><span class="comment">#define INIT_STRUCT_STAT64_PADDING(st) do &#123;             \</span></span><br><span class="line">        memset(&amp;st.__pad0, 0, sizeof(st.__pad0));       \</span><br><span class="line">        memset(&amp;st.__pad3, 0, sizeof(st.__pad3));       \</span><br><span class="line">&#125; <span class="keyword">while</span> (0)</span><br><span class="line"></span><br><span class="line"><span class="comment">#else /* __i386__ */</span></span><br><span class="line"></span><br><span class="line">struct <span class="built_in">stat</span> &#123;</span><br><span class="line">        unsigned long   st_dev;</span><br><span class="line">        unsigned long   st_ino;</span><br><span class="line">        unsigned long   st_nlink;</span><br><span class="line"></span><br><span class="line">        unsigned int    st_mode;</span><br><span class="line">        unsigned int    st_uid;</span><br><span class="line">        unsigned int    st_gid;</span><br><span class="line">        unsigned int    __pad0;</span><br><span class="line">        unsigned long   st_rdev;</span><br><span class="line">        long            st_size;</span><br><span class="line">        long            st_blksize;</span><br><span class="line">        long            st_blocks;      /* Number 512-byte blocks allocated. */</span><br><span class="line"></span><br><span class="line">        unsigned long   st_atime;</span><br><span class="line">        unsigned long   st_atime_nsec;</span><br><span class="line">        unsigned long   st_mtime;</span><br><span class="line">        unsigned long   st_mtime_nsec;</span><br><span class="line">        unsigned long   st_ctime;</span><br><span class="line">        unsigned long   st_ctime_nsec;</span><br><span class="line">        long            __unused[3];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="lstat"><a href="#lstat" class="headerlink" title="lstat"></a><a href="http://codewiki.wikidot.com/c:system-calls:lstat">lstat</a></h5><p>int lstat(const char *path, struct stat *buf);<br>lstat is a system call that is used to determine information about a file based on its filename.<br>lstat is exactly the same as the stat system call. The only difference between the two is when the filename refers to a link. When this is the case, lstat returns information about the link itself, whereas stat returns information about the actual file.    </p><p>const char *path    The file path of the file that is being inquired. This can be both relative and absolute.<br>struct stat *buf    A structure where data about the file will be stored. A detailed look at all of the fields in this structure can be found in the struct stat page.<br>return value    Returns a negative value on failure.</p><h5 id="File-type"><a href="#File-type" class="headerlink" title="File type"></a>File type</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/usr/include/linux/stat.h</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFMT  00170000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFSOCK 0140000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFLNK  0120000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFREG  0100000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFBLK  0060000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFDIR  0040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFCHR  0020000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFIFO  0010000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISUID  0004000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISGID  0002000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISVTX  0001000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISLNK(m)      (((m) &amp; S_IFMT) == S_IFLNK) # is link ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISREG(m)      (((m) &amp; S_IFMT) == S_IFREG) # is file ? </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISDIR(m)      (((m) &amp; S_IFMT) == S_IFDIR) # is dir ? # S_ISDIR(buf.st_mode)==1 means is dir,  ==0 means not dir</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISCHR(m)      (((m) &amp; S_IFMT) == S_IFCHR) # is char ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISBLK(m)      (((m) &amp; S_IFMT) == S_IFBLK) # is blk ?</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISFIFO(m)     (((m) &amp; S_IFMT) == S_IFIFO) # is fifo ? </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISSOCK(m)     (((m) &amp; S_IFMT) == S_IFSOCK) # is socket ?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Here is the permission bit</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXU 00700</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRUSR 00400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWUSR 00200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXUSR 00100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXG 00070</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRGRP 00040</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWGRP 00020</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXGRP 00010</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IRWXO 00007</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IROTH 00004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IWOTH 00002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IXOTH 00001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> abc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">    stat(<span class="string">&quot;/home&quot;</span>, &amp;buf);</span><br><span class="line">    abc = buf.st_mode &amp; S_IFDIR;</span><br><span class="line">    <span class="keyword">if</span>(abc == S_IFDIR) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;It&#x27;s a directory.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span> you could </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(S_ISDIR(buf.st_mode)==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;file: %s \n&quot;</span>,k); <span class="comment">// output file name</span></span><br><span class="line">    global_count--;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bencharmk tools</title>
      <link href="2020/03/17/benchmark-tools/"/>
      <url>2020/03/17/benchmark-tools/</url>
      
        <content type="html"><![CDATA[<h3 id="stress-ng"><a href="#stress-ng" class="headerlink" title="stress-ng"></a>stress-ng</h3><h4 id="filesystem"><a href="#filesystem" class="headerlink" title="filesystem"></a>filesystem</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bogo ops/s (real time) is the value of system performance</span></span><br><span class="line"></span><br><span class="line">$ stress-ng  --hdd 16 --hdd-opts rd-rnd --hdd-opts wr-rnd --hdd-opts fadv-rnd --hdd-write-size 128k --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line">stress-ng: info:  [67477] dispatching hogs: 16 hdd</span><br><span class="line">stress-ng: info:  [67477] successful run completed <span class="keyword">in</span> 60.17s (1 min, 0.17 secs)</span><br><span class="line">stress-ng: info:  [67477] stressor       bogo ops real time  usr time  sys time   bogo ops/s   bogo ops/s</span><br><span class="line">stress-ng: info:  [67477]                           (secs)    (secs)    (secs)   (real time) (usr+sys time)</span><br><span class="line">stress-ng: info:  [67477] hdd            19033866     60.12    381.16    575.50    316618.18     19896.17</span><br><span class="line">stress-ng: info:  [67477] <span class="keyword">for</span> a 60.17s run time:</span><br><span class="line">stress-ng: info:  [67477]     962.79s available CPU time</span><br><span class="line">stress-ng: info:  [67477]     381.24s user time   ( 39.60%)</span><br><span class="line">stress-ng: info:  [67477]     575.57s system time ( 59.78%)</span><br><span class="line">stress-ng: info:  [67477]     956.81s total time  ( 99.38%)</span><br><span class="line">stress-ng: info:  [67477] load average: 11.29 4.72 1.86</span><br><span class="line"></span><br><span class="line"><span class="comment"># meta</span></span><br><span class="line">$ stress-ng --sequential 16 --class filesystem --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line">stress-ng: info:  [27612] apparmor stressor will be skipped, AppArmor is not available</span><br><span class="line">stress-ng: info:  [27612] dispatching hogs: 16 <span class="built_in">chdir</span>, 16 chmod, 16 chown, 16 copy-file, 16 dentry, 16 dir, 16 dirdeep, 16 dnotify, 16 dup, 16 eventfd, 16 fallocate, 16 fanotify, 16 fcntl, 16 fiemap, 16 filename, 16 flock, 16 fstat, 16 getdent, 16 handle, 16 inotify, 16 io, 16 iomix, 16 ioprio, 16 lease, 16 link, 16 locka, 16 lockf, 16 lockofd, 16 mknod, 16 open, 16 procfs, 16 rename, 16 symlink, 16 sync-file, 16 utime, 16 xattr</span><br><span class="line"></span><br><span class="line"><span class="comment">#syscall test, no real IO</span></span><br><span class="line">$ stress-ng --<span class="built_in">chdir</span> 8 --chmod 8 --chown 8 --fcntl 8 --filename 8 --flock 8 --fstat 8 --getdent 8 --handle 8 --io 8 -- lockf 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># parallel running</span></span><br><span class="line"><span class="comment"># if you want test IO performance, got the high IO loading from these.</span></span><br><span class="line">$ stress-ng --fallocate 8 --xattr 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># a lot of NFS not support xattr</span></span><br><span class="line">$ stress-ng --fallocate 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># the high IO loading test could got the high IOPS in ext4 with SATA SSD</span></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdb               0.00 100284.00    0.00 15955.50     0.00   452.52    58.08    97.34    6.05    0.00    6.05   0.06  95.05</span><br></pre></td></tr></table></figure><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --cpu <span class="variable">$cores_num</span> --timeout 900</span><br></pre></td></tr></table></figure><h4 id="MEM"><a href="#MEM" class="headerlink" title="MEM"></a>MEM</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --vm 4 --timeout 900s</span><br><span class="line">$ stress-ng --vm-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.9;&#125;&#x27;</span> &lt; /proc/meminfo)k --vm-keep -m 1 -t 30s --metrics-brief</span><br><span class="line">$ stress-ng --mincore 5 --mincore-random --malloc 2 --malloc-bytes 10g --mremap 2 --mremap-bytes 10g --memfd 2 --memfd-bytes 10g --vm-bytes 10g -m 2  -t 600s --metrics-brief</span><br></pre></td></tr></table></figure><h4 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --mq 0 -t 30s --<span class="built_in">times</span>  --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># The matrix stressor is a good way to exercise the CPU floating point operations as well as memory and processor data cache. Of all the tests, this one generally heats x86 CPUs the best.</span></span><br><span class="line">$ stress-ng --matrix 0 -t 1m --<span class="built_in">times</span> --metrics-brief</span><br></pre></td></tr></table></figure><h4 id="mix"><a href="#mix" class="headerlink" title="mix"></a>mix</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --cpu 2 --matrix 1 --mq 3</span><br><span class="line">$ stress-ng --all 2</span><br><span class="line"></span><br><span class="line">$ stress-ng --seq 1 -x numa,matrix,hdd</span><br><span class="line"><span class="comment">#        --sequential N</span></span><br><span class="line">sequentially run all the stressors one by one <span class="keyword">for</span> a default of 60 seconds. The number of instances of each of the individual stressors to be started is N.  If N  is  less than  zero, <span class="keyword">then</span> the number of CPUs online is used <span class="keyword">for</span> the number of instances.  If N is zero, <span class="keyword">then</span> the number of CPUs <span class="keyword">in</span> the system is used.  Use the --timeout option to specify the duration to run each stressor.</span><br></pre></td></tr></table></figure><h4 id="the-others-test"><a href="#the-others-test" class="headerlink" title="the others test"></a>the others test</h4><p>$ stress-ng seq 1 -x nuam, sched fifo  -t 30s times metrics-brief<br>$ stress-ng vm 16 vm-bytes 90% -t 1h metrics-brief<br>$ stress-ng cpu 8 cpu-ops 800000<br>$ stress-ng cpu 4 cpu-method fft cpu-ops 10000 metrics-brief<br>$ stress-ng cpu 0 cpu-method all -t 1h<br>$ stress-ng random 64<br>#run 64 stressors that are randomly chosen from all the available stressors.</p><p>$ stress-ng cpu 64 cpu-method all verify -t 10m metrics-brief<br>#run 64 instances of all the different cpu stressors and verify that the computations are correct for 10 minutes with a bogo operations summary at the end.</p><p>$ stress-ng sequential 8 class io -t 5m times</p><h1 id="run-all-the-stressors-in-the-io-class-one-by-one-for-5-minutes-each-with-8-instances-of-each-stressor-running-concurrently-and-show-overall-time-utilisation-statistics-at-the-end-of-the-run"><a href="#run-all-the-stressors-in-the-io-class-one-by-one-for-5-minutes-each-with-8-instances-of-each-stressor-running-concurrently-and-show-overall-time-utilisation-statistics-at-the-end-of-the-run" class="headerlink" title="run  all  the stressors in the io class one by one for 5 minutes each, with 8 instances of each stressor running concurrently and show overall time utilisation statistics at the end of the run."></a>run  all  the stressors in the io class one by one for 5 minutes each, with 8 instances of each stressor running concurrently and show overall time utilisation statistics at the end of the run.</h1><p>$ stress-ng all 0 maximize aggressive<br>#run all the stressors (1 instance of each per CPU) simultaneously, maximize the settings (memory sizes, file allocations, etc.) and select the  most  demanding/aggressive options.</p><p>$        stress-ng sequential 4 class vm exclude bigheap,brk,stack<br>#run 4 instances of the VM stressors one after each other, excluding the bigheap, brk and stack stressors</p><p>$ stress-ng taskset 0,2-3 cpu 3<br>#run 3 instances of the CPU stressor and pin them to CPUs 0, 2 and 3.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">##### cpu-cache</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--sequential</span> <span class="number">8</span> <span class="string">--class</span> <span class="string">cpu-cache</span> <span class="string">-t</span> <span class="string">5m</span></span><br><span class="line"><span class="attr">stress-ng: info:</span>  [<span class="number">13341</span>] <span class="string">apparmor</span> <span class="string">stressor</span> <span class="string">will</span> <span class="string">be</span> <span class="string">skipped,</span> <span class="string">AppArmor</span> <span class="string">is</span> <span class="string">not</span> <span class="string">available</span></span><br><span class="line"><span class="attr">stress-ng: info:</span>  [<span class="number">13341</span>] <span class="attr">dispatching hogs:</span> <span class="number">8</span> <span class="string">bsearch,</span> <span class="number">8</span> <span class="string">cache,</span> <span class="number">8</span> <span class="string">heapsort,</span> <span class="number">8</span> <span class="string">hsearch,</span> <span class="number">8</span> <span class="string">icache,</span> <span class="number">8</span> <span class="string">lockbus,</span> <span class="number">8</span> <span class="string">lsearch,</span> <span class="number">8</span> <span class="string">malloc,</span> <span class="number">8</span> <span class="string">matrix,</span> <span class="number">8</span> <span class="string">membarrier,</span> <span class="number">8</span> <span class="string">memcpy,</span> <span class="number">8</span> <span class="string">mergesort,</span> <span class="number">8</span> <span class="string">qsort,</span> <span class="number">8</span> <span class="string">str,</span> <span class="number">8</span> <span class="string">stream,</span> <span class="number">8</span> <span class="string">tsearch,</span> <span class="number">8</span> <span class="string">vecmath,</span> <span class="number">8</span> <span class="string">wcs,</span> <span class="number">8</span> <span class="string">zlib</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--cpu</span> <span class="number">4</span> <span class="string">--cache-level</span> <span class="number">2</span> <span class="string">--cache-ways</span> <span class="number">4</span> <span class="string">-t</span> <span class="string">30s</span> <span class="string">--metrics-brief</span></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--cpu</span> <span class="number">4</span> <span class="string">--cache-level</span> <span class="number">3</span> <span class="string">--cache-ways</span> <span class="number">4</span> <span class="string">-t</span> <span class="string">30s</span> <span class="string">--metrics-brief</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">stress-ng</span> <span class="string">--all</span> <span class="number">0</span> <span class="string">--class</span> <span class="string">cpu-cache</span> <span class="string">-t</span> <span class="string">5m</span> <span class="string">--metrics-brief</span></span><br></pre></td></tr></table></figure><h5 id="cpu-method"><a href="#cpu-method" class="headerlink" title="cpu-method"></a>cpu-method</h5><p>$ stress-ng cpu 1 cpu-method matrixprod -t 1m metrics-brief<br>$ for m in double longdouble matrixprod nsqrt cfloat clongdouble decimal32 decimal128 explog bitops ln2 int64 int128 ackermann int128decimal128 gray euler fibonacci; do stress-ng cpu 0 cpu-method $m -t 10s metrics-brief; done</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># float</span></span><br><span class="line">double           <span class="number">1000</span> iterations of a mix of double precision floating point operations</span><br><span class="line">longdouble       <span class="number">1000</span> iterations of a mix of long double precision floating point operations</span><br><span class="line">matrixprod       matrix  product  of  two  <span class="number">128</span>  <span class="number">128</span> matrices of double floats. Testing on <span class="number">64</span> <span class="keyword">bit </span>x86 hardware <span class="keyword">shows </span>that this is provides a good mix of memory, <span class="keyword">cache </span><span class="keyword">and </span>floating point operations <span class="keyword">and </span>is probably the <span class="keyword">best </span>CPU method to use to make a CPU run hot.</span><br><span class="line">nsqrt            compute sqrt() of long doubles using Newton-Raphson</span><br><span class="line">cfloat           <span class="number">1000</span> iterations of a mix of floating point complex operations</span><br><span class="line"><span class="keyword">clongdouble </span>     <span class="number">1000</span> iterations of a mix of long double floating point complex operations</span><br><span class="line">decimal32        <span class="number">1000</span> iterations of a mix of <span class="number">32</span> <span class="keyword">bit </span>decimal floating point operations (GCC only)</span><br><span class="line">decimal128       <span class="number">1000</span> iterations of a mix of <span class="number">128</span> <span class="keyword">bit </span>decimal floating point operations (GCC only)</span><br><span class="line">explog           iterate on n = exp(log(n)  <span class="number">1</span>.<span class="number">00002</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#int</span></span><br><span class="line">int64            <span class="number">1000</span> iterations of a mix of <span class="number">64</span> <span class="keyword">bit </span>integer operations</span><br><span class="line">int128           <span class="number">1000</span> iterations of a mix of <span class="number">128</span> <span class="keyword">bit </span>integer operations (GCC only)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------------performance test--------------------------</span><br><span class="line"><span class="comment">#logic</span></span><br><span class="line"><span class="keyword">jmp </span>             Simple unoptimised <span class="built_in">compare</span> &gt;, &lt;, == <span class="keyword">and </span><span class="keyword">jmp </span><span class="keyword">branching</span></span><br><span class="line"><span class="keyword">ackermann </span>       Ackermann function: compute A(<span class="number">3</span>, <span class="number">10</span>), where:</span><br><span class="line">                 A(m, n) = n + <span class="number">1</span> if m = <span class="number">0</span>;</span><br><span class="line">                 A(m - <span class="number">1</span>, <span class="number">1</span>) if m &gt; <span class="number">0</span> <span class="keyword">and </span>n = <span class="number">0</span>;</span><br><span class="line">                 A(m - <span class="number">1</span>, A(m, n - <span class="number">1</span>)) if m &gt; <span class="number">0</span> <span class="keyword">and </span>n &gt; <span class="number">0</span></span><br><span class="line"><span class="comment"># bit</span></span><br><span class="line"><span class="keyword">bitops </span>          various <span class="keyword">bit </span>operations from <span class="keyword">bithack, </span>namely: reverse <span class="keyword">bits, </span>parity check, <span class="keyword">bit </span><span class="built_in">count</span>, round to nearest power of <span class="number">2</span></span><br><span class="line"><span class="comment"># int</span></span><br><span class="line">gray             calculate <span class="keyword">binary </span>to gray code <span class="keyword">and </span>gray code <span class="keyword">back </span>to <span class="keyword">binary </span>for integers from <span class="number">0</span> to <span class="number">65535</span> </span><br><span class="line">fibonacci        compute Fibonacci sequence of <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">8</span>...</span><br><span class="line"></span><br><span class="line"><span class="comment">#float</span></span><br><span class="line">euler            compute e using n = (<span class="number">1</span> + (<span class="number">1</span>  n))  n </span><br><span class="line">ln2              compute ln(<span class="number">2</span>) <span class="keyword">based </span>on series:</span><br><span class="line"><span class="comment">#mix</span></span><br><span class="line">int128decimal32 <span class="number">1000</span> iterations of a mix of <span class="number">128</span> <span class="keyword">bit </span>integer <span class="keyword">and </span><span class="number">128</span> <span class="keyword">bit </span>decimal floating point operations (GCC only)</span><br><span class="line"><span class="comment">#rand hash</span></span><br><span class="line">djb2a            <span class="number">128</span> rounds of hash DJB2a (Dan <span class="keyword">Bernstein </span>hash using the <span class="keyword">xor </span>variant) on <span class="number">128</span> to <span class="number">1</span> <span class="keyword">bytes </span>of <span class="built_in">random</span> strings</span><br><span class="line"><span class="keyword">dither </span>          FloydSteinberg <span class="keyword">dithering </span>of a <span class="number">1024</span>  <span class="number">768</span> <span class="built_in">random</span> image from <span class="number">8</span> <span class="keyword">bits </span>down to <span class="number">1</span> <span class="keyword">bit </span>of depth.</span><br><span class="line">crc16            compute <span class="number">1024</span> rounds of CCITT CRC16 on <span class="built_in">random</span> data</span><br><span class="line"></span><br><span class="line">-----------------------------------END--------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#C</span></span><br><span class="line">callfunc         recursively call <span class="number">8</span> argument C function to a depth of <span class="number">1024</span> calls <span class="keyword">and </span>unwind</span><br><span class="line"></span><br><span class="line"><span class="comment">#random, hash</span></span><br><span class="line"><span class="keyword">jenkin </span>       <span class="keyword">Jenkin&#x27;s </span>integer hash on <span class="number">128</span> rounds of <span class="number">128</span>..<span class="number">1</span> <span class="keyword">bytes </span>of <span class="built_in">random</span> data</span><br><span class="line">hanoi         solve a <span class="number">21</span> <span class="keyword">disc </span>Towers of Hanoi stack using the recursive solution</span><br><span class="line">              hamming          compute Hamming H(<span class="number">8</span>,<span class="number">4</span>) codes on <span class="number">262144</span> lots of <span class="number">4</span> <span class="keyword">bit </span>data. This turns <span class="number">4</span> <span class="keyword">bit </span>data into <span class="number">8</span> <span class="keyword">bit </span>Hamming code containing <span class="number">4</span> parity <span class="keyword">bits. </span>For data <span class="keyword">bits </span> d1..d4,</span><br><span class="line">                               parity <span class="keyword">bits </span>are computed as:</span><br><span class="line">                                 p1 = d2 + d3 + d4</span><br><span class="line">                                 p2 = d1 + d3 + d4</span><br><span class="line">                                 p3 = d1 + d2 + d4</span><br><span class="line">                                 p4 = d1 + d2 + d3</span><br><span class="line">correlate        perform a <span class="number">16384</span>  <span class="number">1024</span> correlation of <span class="built_in">random</span> doubles</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--memthrash-method method</span><br><span class="line">              specify a memthrash stress method. Available memthrash stress methods are described</span><br><span class="line">              as follows:</span><br><span class="line"></span><br><span class="line">              Method           Description</span><br><span class="line">              all              iterate over all the <span class="keyword">below </span>memthrash methods</span><br><span class="line">              chunk1           memset <span class="number">1</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunk8           memset <span class="number">8</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunk64          memset <span class="number">64</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunk256         memset <span class="number">256</span> <span class="keyword">byte </span><span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              chunkpage        memset page size <span class="keyword">chunks </span>of <span class="built_in">random</span> data into <span class="built_in">random</span> locations</span><br><span class="line">              flip             flip (invert) all <span class="keyword">bits </span>in ramdom locations</span><br><span class="line">              flush            flush <span class="keyword">cache </span>line in <span class="built_in">random</span> locations</span><br><span class="line">              lock             lock randomly choosing locations (Intel x86 CPUs only)</span><br><span class="line">              matrix           treat memory as a <span class="number">2</span>  <span class="number">2</span> matrix <span class="keyword">and </span><span class="keyword">swap </span><span class="built_in">random</span> elements</span><br><span class="line">              memset           memset the memory with <span class="built_in">random</span> data</span><br><span class="line">              mfence           stores with write serialization (Intel x86 CPUs only)</span><br><span class="line">              <span class="keyword">prefetch </span>        <span class="keyword">prefetch </span>data <span class="built_in">at</span> <span class="built_in">random</span> memory locations</span><br><span class="line">              <span class="built_in">random</span>           randomly  run any of the memthrash methods except for <span class="string">&#x27;random&#x27;</span> <span class="keyword">and</span></span><br><span class="line"><span class="keyword"> </span>                              <span class="string">&#x27;all&#x27;</span></span><br><span class="line">              spinread         spin loop read the same <span class="built_in">random</span> location <span class="number">2</span>^<span class="number">19</span> times</span><br><span class="line">              spinwrite        spin loop write the same <span class="built_in">random</span> location <span class="number">2</span>^<span class="number">19</span> times</span><br></pre></td></tr></table></figure><h5 id="class"><a href="#class" class="headerlink" title="class"></a>class</h5><p>The stress-ng stressors are grouped together in different classes:</p><p>cpu - CPU intensive<br>cpu-cache - stress CPU instruction and/or data caches<br>device - raw device driver stressors<br>io - generic input/output<br>interrupt - high interrupt load generators<br>filesystem - file system activity<br>memory - stack, heap, memory mapping, shared memory stressors<br>network - TCP/IP, UDP and UNIX domain socket stressors<br>os - core kernel stressors<br>pipe - pipe and UNIX socket stressors<br>scheduler - force high levels of context switching<br>security - AppArmor stressor<br>vm - Virtual Memory stressor (paging and memory)</p><p>matrix-method method<br>       specify a matrix stress method. Available matrix stress methods are described as follows:</p><pre><code>   Method           Description   all              iterate over all the below matrix stress methods   add              add two N  N matrices   copy             copy one N  N matrix to another   div              divide an N  N matrix by a scalar   hadamard         Hadamard product of two N  N matrices   frobenius        Frobenius product of two N  N matrices   mean             arithmetic mean of two N  N matrices   mult             multiply an N  N matrix by a scalar   prod             product of two N  N matrices   sub              subtract one N  N matrix from another N  N matrix   trans            transpose an N  N matrix</code></pre><h4 id="performance-info"><a href="#performance-info" class="headerlink" title="performance info"></a>performance info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --mq 0 -t 30s --<span class="built_in">times</span> --perf</span><br><span class="line">stress-ng: info:  [68895] dispatching hogs: 16 mq</span><br><span class="line">^Cstress-ng: info:  [68895] unsuccessful run completed <span class="keyword">in</span> 15.95s</span><br><span class="line">stress-ng: info:  [68895] mq:</span><br><span class="line">stress-ng: info:  [68895]            667,942,869,088 CPU Cycles                    41.88 B/sec</span><br><span class="line">stress-ng: info:  [68895]            343,598,563,312 Instructions                  21.54 B/sec (0.514 instr. per cycle)</span><br><span class="line">stress-ng: info:  [68895]              4,273,568,592 Cache References               0.27 B/sec</span><br><span class="line">stress-ng: info:  [68895]                108,195,424 Cache Misses                   6.78 M/sec ( 2.53%)</span><br><span class="line">stress-ng: info:  [68895]             62,069,485,136 Branch Instructions            3.89 B/sec</span><br><span class="line">stress-ng: info:  [68895]              1,391,055,360 Branch Misses                 87.21 M/sec ( 2.24%)</span><br><span class="line">stress-ng: info:  [68895]              4,911,414,496 Bus Cycles                     0.31 B/sec</span><br><span class="line">stress-ng: info:  [68895]            510,787,333,888 Total Cycles                  32.02 B/sec</span><br><span class="line">stress-ng: info:  [68895]                      3,184 Page Faults Minor            199.61 /sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Page Faults Major              0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                  3,924,080 Context Switches               0.25 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    718,208 CPU Migrations                45.03 K/sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Alignment Faults               0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                      3,088 Page Faults User             193.60 /sec</span><br><span class="line">stress-ng: info:  [68895]                         96 Page Faults Kernel             6.02 /sec</span><br><span class="line">stress-ng: info:  [68895]                 92,731,952 System Call Enter              5.81 M/sec</span><br><span class="line">stress-ng: info:  [68895]                 92,731,952 System Call Exit               5.81 M/sec</span><br><span class="line">stress-ng: info:  [68895]                 54,434,816 Kmalloc                        3.41 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    399,904 Kmalloc Node                  25.07 K/sec</span><br><span class="line">stress-ng: info:  [68895]                231,994,672 Kfree                         14.54 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    139,904 Kmem Cache Alloc               8.77 K/sec</span><br><span class="line">stress-ng: info:  [68895]                     88,848 Kmem Cache Alloc Node          5.57 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    181,568 Kmem Cache Free               11.38 K/sec</span><br><span class="line">stress-ng: info:  [68895]                     59,856 MM Page Alloc                  3.75 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    158,720 MM Page Free                   9.95 K/sec</span><br><span class="line">stress-ng: info:  [68895]                  8,842,656 RCU Utilization                0.55 M/sec</span><br><span class="line">stress-ng: info:  [68895]                    764,352 Sched Migrate Task            47.92 K/sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Sched Move NUMA                0.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                  6,617,648 Sched Wakeup                   0.41 M/sec</span><br><span class="line">stress-ng: info:  [68895]                         16 Signal Generate                1.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                         80 Signal Deliver                 5.02 /sec</span><br><span class="line">stress-ng: info:  [68895]                        672 IRQ Entry                     42.13 /sec</span><br><span class="line">stress-ng: info:  [68895]                        672 IRQ Exit                      42.13 /sec</span><br><span class="line">stress-ng: info:  [68895]                    664,704 Soft IRQ Entry                41.67 K/sec</span><br><span class="line">stress-ng: info:  [68895]                    664,704 Soft IRQ Exit                 41.67 K/sec</span><br><span class="line">stress-ng: info:  [68895]                         16 Writeback Dirty Inode          1.00 /sec</span><br><span class="line">stress-ng: info:  [68895]                          0 Writeback Dirty Page           0.00 /sec</span><br><span class="line">stress-ng: info:  [68895] <span class="keyword">for</span> a 15.95s run time:</span><br><span class="line">stress-ng: info:  [68895]     255.21s available CPU time</span><br><span class="line">stress-ng: info:  [68895]      25.73s user time   ( 10.08%)</span><br><span class="line">stress-ng: info:  [68895]     181.50s system time ( 71.12%)</span><br><span class="line">stress-ng: info:  [68895]     207.23s total time  ( 81.20%)</span><br><span class="line">stress-ng: info:  [68895] load average: 5.35 1.73 1.08</span><br></pre></td></tr></table></figure><h4 id="Verify-mode"><a href="#Verify-mode" class="headerlink" title="Verify mode"></a>Verify mode</h4><p>Some stressors have a verification mode. A stress test is run and the results are checked, if the results are incorrect then stress-ng will flag up a warning error message. Suppose we want to run some exhaustive memory checks on a blob of virtually mapped memory via the vm stressor, enable the verify mode and this will sanity check that the read/write results on the memory:</p><p>$ stress-ng vm 1 vm-bytes 2G verify -v<br>Note that not all stressors have a verify mode, and enabling it will reduce the bogo op stats as there is an extra verification step being invoked.</p><h4 id="Generating-major-page-faults"><a href="#Generating-major-page-faults" class="headerlink" title="Generating major page faults"></a>Generating major page faults</h4><p>You can generate major page faults (by accessing a page is not loaded in memory at the time of the fault) and see the page fault rate using:<br>$ stress-ng fault 0 perf -t 1m</p><p>or with newer kernels use the userfaultfd stressor to force even more major faults:<br>$ stress-ng userfaultfd 0 perf -t 1m</p><p>Running timers at high frequency can generate a large interrupt load. The timer stressor with an appropriately selected timer frequency can be used to force many hundreds of thousands of interrupts per second, for example, 32 instances at 1MHz:<br>$ stress-ng timer 32 timer-freq 1000000</p><h3 id="test-case"><a href="#test-case" class="headerlink" title="test case"></a>test case</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -------all cores CPU case1:------</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> jmp bitops fibonacci euler ln2 int128decimal32 djb2a crc16; <span class="keyword">do</span> stress-ng --cpu 0 --cpu-method <span class="variable">$m</span> -t 240s --metrics-brief; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -------4 cores CPU case1:------</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> jmp bitops fibonacci euler ln2 int128decimal32 djb2a crc16; <span class="keyword">do</span> stress-ng --cpu 4 --cpu-method <span class="variable">$m</span> -t 240s --metrics-brief; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -------mem test1:---------</span><br><span class="line">stress-ng --malloc 1 --malloc-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k  --vm-keep -m 1 --vm-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k --mremap 2 --mremap-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k --memfd 2 --memfd-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.1;&#125;&#x27;</span> /proc/meminfo)k -t 600s --metrics-brief</span><br><span class="line"><span class="built_in">echo</span> -------mem test2:---------</span><br><span class="line">stress-ng --mincore 0 --mincore-random -t 600s --metrics-brief</span><br><span class="line"><span class="built_in">echo</span> -------mem test3:---------</span><br><span class="line">stress-ng --vm-bytes $(awk <span class="string">&#x27;/MemFree/&#123;printf &quot;%d\n&quot;, $2 * 0.9;&#125;&#x27;</span> /proc/meminfo)k --vm-keep -m 1 -t 600s --metrics-brief</span><br></pre></td></tr></table></figure><h3 id="Emulate-some-error-to-test-the-block-device"><a href="#Emulate-some-error-to-test-the-block-device" class="headerlink" title="Emulate some error to test the block device"></a>Emulate some error to test the block device</h3><h4 id="dm-delay"><a href="#dm-delay" class="headerlink" title="dm-delay"></a><a href="https://enodev.fr/posts/emulate-a-slow-block-device-with-dm-delay.html#">dm-delay</a></h4><p>Device-Mappers delay target delays reads and/or writes and maps them to different devices.</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ sudo modprobe brd rd_nr=<span class="number">1</span> rd_size=<span class="number">1048576</span></span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">readwrite=randread</span><br><span class="line">blocksize=<span class="number">4</span>k</span><br><span class="line">ioengine=sync</span><br><span class="line">filename=/dev/ram0</span><br><span class="line">time_based=<span class="number">1</span></span><br><span class="line">runtime=<span class="number">10</span></span><br><span class="line"></span><br><span class="line">DDR <span class="number">1333</span></span><br><span class="line">Jobs: <span class="number">1</span> (f=<span class="number">1</span>): [r(<span class="number">1</span>)][<span class="number">100.0</span>%][r=<span class="number">1471</span>MiB/s,w=<span class="number">0</span>KiB/s][r=<span class="number">377</span>k,w=<span class="number">0</span> IOPS][eta <span class="number">00</span>m:<span class="number">00</span>s]</span><br><span class="line">rw: (groupid=<span class="number">0</span>, jobs=<span class="number">1</span>): err= <span class="number">0</span>: pid=<span class="number">13487</span>: Thu Jun  <span class="number">4</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">25</span> <span class="number">2020</span></span><br><span class="line">   read: IOPS=<span class="number">361</span>k, BW=<span class="number">1411</span>MiB/s (<span class="number">1480</span>MB/s)(<span class="number">13.8</span>GiB/<span class="number">10001</span>msec)</span><br><span class="line">    clat (nsec): min=<span class="number">790</span>, max=<span class="number">124854</span>, avg=<span class="number">1563.39</span>, stdev=<span class="number">935.07</span></span><br><span class="line">     lat (nsec): min=<span class="number">984</span>, max=<span class="number">125042</span>, avg=<span class="number">1757.85</span>, stdev=<span class="number">978.84</span></span><br><span class="line">    clat percentiles (nsec):</span><br><span class="line">     |  <span class="number">1.00</span>th=[ <span class="number">1240</span>],  <span class="number">5.00</span>th=[ <span class="number">1304</span>], <span class="number">10.00</span>th=[ <span class="number">1336</span>], <span class="number">20.00</span>th=[ <span class="number">1368</span>],</span><br><span class="line">     | <span class="number">30.00</span>th=[ <span class="number">1384</span>], <span class="number">40.00</span>th=[ <span class="number">1400</span>], <span class="number">50.00</span>th=[ <span class="number">1432</span>], <span class="number">60.00</span>th=[ <span class="number">1464</span>],</span><br><span class="line">     | <span class="number">70.00</span>th=[ <span class="number">1496</span>], <span class="number">80.00</span>th=[ <span class="number">1560</span>], <span class="number">90.00</span>th=[ <span class="number">1752</span>], <span class="number">95.00</span>th=[ <span class="number">2352</span>],</span><br><span class="line">     | <span class="number">99.00</span>th=[ <span class="number">3376</span>], <span class="number">99.50</span>th=[ <span class="number">4080</span>], <span class="number">99.90</span>th=[<span class="number">14784</span>], <span class="number">99.95</span>th=[<span class="number">24960</span>],</span><br><span class="line">     | <span class="number">99.99</span>th=[<span class="number">31360</span>]</span><br><span class="line">   bw (  MiB/s): min= <span class="number">1004</span>, max= <span class="number">1476</span>, per=<span class="number">99.79</span>%, avg=<span class="number">1408.26</span>, stdev=<span class="number">144.72</span>, samples=<span class="number">19</span></span><br><span class="line">   iops        : min=<span class="number">257224</span>, max=<span class="number">377934</span>, avg=<span class="number">360514.11</span>, stdev=<span class="number">37048.52</span>, samples=<span class="number">19</span></span><br><span class="line">  lat (nsec)   : <span class="number">1000</span>=<span class="number">0.01</span>%</span><br><span class="line">  lat (usec)   : <span class="number">2</span>=<span class="number">91.75</span>%, <span class="number">4</span>=<span class="number">7.64</span>%, <span class="number">10</span>=<span class="number">0.49</span>%, <span class="number">20</span>=<span class="number">0.03</span>%, <span class="number">50</span>=<span class="number">0.09</span>%</span><br><span class="line">  lat (usec)   : <span class="number">100</span>=<span class="number">0.01</span>%, <span class="number">250</span>=<span class="number">0.01</span>%</span><br><span class="line">  cpu          : usr=<span class="number">27.40</span>%, sys=<span class="number">72.48</span>%, ctx=<span class="number">954</span>, majf=<span class="number">0</span>, minf=<span class="number">9</span></span><br><span class="line">  IO depths    : <span class="number">1</span>=<span class="number">100.0</span>%, <span class="number">2</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">0.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     submit    : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     complete  : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     issued rwt: total=<span class="number">3613043</span>,<span class="number">0</span>,<span class="number">0</span>, short=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, dropped=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">     latency   : target=<span class="number">0</span>, window=<span class="number">0</span>, percentile=<span class="number">100.00</span>%, depth=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Run status group <span class="number">0</span> (all jobs):</span><br><span class="line">   READ: bw=<span class="number">1411</span>MiB/s (<span class="number">1480</span>MB/s), <span class="number">1411</span>MiB/s<span class="number">-1411</span>MiB/s (<span class="number">1480</span>MB/s<span class="number">-1480</span>MB/s), io=<span class="number">13.8</span>GiB (<span class="number">14.8</span>GB), run=<span class="number">10001</span><span class="number">-10001</span>msec</span><br><span class="line"></span><br><span class="line"># Create device delaying rw operation <span class="keyword">for</span> <span class="number">500</span>ms</span><br><span class="line">$ echo <span class="string">&quot;0 $(blockdev --getsz /dev/ram0) delay /dev/ram0 0 500&quot;</span> | dmsetup create delayed</span><br><span class="line">$ ls -l /dev/mapper/delayed </span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">7</span> <span class="number">6</span>   <span class="number">4</span> <span class="number">22</span>:<span class="number">47</span> /dev/mapper/delayed -&gt; ../dm<span class="number">-0</span></span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">filename=/dev/dm<span class="number">-0</span></span><br><span class="line">readwrite=randread</span><br><span class="line">blocksize=<span class="number">4</span>k</span><br><span class="line">ioengine=sync</span><br><span class="line">time_based=<span class="number">1</span></span><br><span class="line">runtime=<span class="number">10</span></span><br><span class="line"></span><br><span class="line">Starting <span class="number">1</span> process</span><br><span class="line">Jobs: <span class="number">1</span> (f=<span class="number">1</span>): [r(<span class="number">1</span>)][<span class="number">100.0</span>%][r=<span class="number">8</span>KiB/s,w=<span class="number">0</span>KiB/s][r=<span class="number">2</span>,w=<span class="number">0</span> IOPS][eta <span class="number">00</span>m:<span class="number">00</span>s]</span><br><span class="line">random: (groupid=<span class="number">0</span>, jobs=<span class="number">1</span>): err= <span class="number">0</span>: pid=<span class="number">13873</span>: Thu Jun  <span class="number">4</span> <span class="number">22</span>:<span class="number">56</span>:<span class="number">44</span> <span class="number">2020</span></span><br><span class="line">   read: IOPS=<span class="number">1</span>, BW=<span class="number">8007</span>B/s (<span class="number">8007</span>B/s)(<span class="number">80.0</span>KiB/<span class="number">10231</span>msec)</span><br><span class="line">    clat (msec): min=<span class="number">503</span>, max=<span class="number">516</span>, avg=<span class="number">511.50</span>, stdev= <span class="number">2.97</span></span><br><span class="line">     lat (msec): min=<span class="number">503</span>, max=<span class="number">516</span>, avg=<span class="number">511.50</span>, stdev= <span class="number">2.97</span></span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  <span class="number">1.00</span>th=[  <span class="number">506</span>],  <span class="number">5.00</span>th=[  <span class="number">506</span>], <span class="number">10.00</span>th=[  <span class="number">510</span>], <span class="number">20.00</span>th=[  <span class="number">510</span>],</span><br><span class="line">     | <span class="number">30.00</span>th=[  <span class="number">514</span>], <span class="number">40.00</span>th=[  <span class="number">514</span>], <span class="number">50.00</span>th=[  <span class="number">514</span>], <span class="number">60.00</span>th=[  <span class="number">514</span>],</span><br><span class="line">     | <span class="number">70.00</span>th=[  <span class="number">514</span>], <span class="number">80.00</span>th=[  <span class="number">514</span>], <span class="number">90.00</span>th=[  <span class="number">514</span>], <span class="number">95.00</span>th=[  <span class="number">518</span>],</span><br><span class="line">     | <span class="number">99.00</span>th=[  <span class="number">518</span>], <span class="number">99.50</span>th=[  <span class="number">518</span>], <span class="number">99.90</span>th=[  <span class="number">518</span>], <span class="number">99.95</span>th=[  <span class="number">518</span>],</span><br><span class="line">     | <span class="number">99.99</span>th=[  <span class="number">518</span>]</span><br><span class="line">   bw (  KiB/s): min=    <span class="number">8</span>, max=    <span class="number">8</span>, per=<span class="number">100.00</span>%, avg= <span class="number">8.00</span>, stdev= <span class="number">0.00</span>, samples=<span class="number">19</span></span><br><span class="line">   iops        : min=    <span class="number">2</span>, max=    <span class="number">2</span>, avg= <span class="number">2.00</span>, stdev= <span class="number">0.00</span>, samples=<span class="number">19</span></span><br><span class="line">  lat (msec)   : <span class="number">750</span>=<span class="number">100.00</span>%</span><br><span class="line">  cpu          : usr=<span class="number">0.00</span>%, sys=<span class="number">0.02</span>%, ctx=<span class="number">20</span>, majf=<span class="number">0</span>, minf=<span class="number">6</span></span><br><span class="line">  IO depths    : <span class="number">1</span>=<span class="number">100.0</span>%, <span class="number">2</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">0.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     submit    : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     complete  : <span class="number">0</span>=<span class="number">0.0</span>%, <span class="number">4</span>=<span class="number">100.0</span>%, <span class="number">8</span>=<span class="number">0.0</span>%, <span class="number">16</span>=<span class="number">0.0</span>%, <span class="number">32</span>=<span class="number">0.0</span>%, <span class="number">64</span>=<span class="number">0.0</span>%, &gt;=<span class="number">64</span>=<span class="number">0.0</span>%</span><br><span class="line">     issued rwt: total=<span class="number">20</span>,<span class="number">0</span>,<span class="number">0</span>, short=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, dropped=<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">     latency   : target=<span class="number">0</span>, window=<span class="number">0</span>, percentile=<span class="number">100.00</span>%, depth=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Run status group <span class="number">0</span> (all jobs):</span><br><span class="line">   READ: bw=<span class="number">8007</span>B/s (<span class="number">8007</span>B/s), <span class="number">8007</span>B/s<span class="number">-8007</span>B/s (<span class="number">8007</span>B/s<span class="number">-8007</span>B/s), io=<span class="number">80.0</span>KiB (<span class="number">81.9</span>kB), run=<span class="number">10231</span><span class="number">-10231</span>msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">    dm<span class="number">-0</span>: ios=<span class="number">20</span>/<span class="number">0</span>, merge=<span class="number">0</span>/<span class="number">0</span>, ticks=<span class="number">9720</span>/<span class="number">0</span>, in_queue=<span class="number">10140</span>, util=<span class="number">99.14</span>%, aggrios=<span class="number">0</span>/<span class="number">0</span>, aggrmerge=<span class="number">0</span>/<span class="number">0</span>, aggrticks=<span class="number">0</span>/<span class="number">0</span>, aggrin_queue=<span class="number">0</span>, aggrutil=<span class="number">0.00</span>%</span><br><span class="line">  ram0: ios=<span class="number">0</span>/<span class="number">0</span>, merge=<span class="number">0</span>/<span class="number">0</span>, ticks=<span class="number">0</span>/<span class="number">0</span>, in_queue=<span class="number">0</span>, util=<span class="number">0.00</span>%</span><br><span class="line"></span><br><span class="line"># Create a block device that delays reads <span class="keyword">for</span> <span class="number">500</span> ms <span class="keyword">and</span> writes <span class="keyword">for</span> <span class="number">300</span> ms</span><br><span class="line">size=$(blockdev --getsize /dev/ram0) # Size <span class="keyword">in</span> <span class="number">512</span>-bytes sectors</span><br><span class="line">$ echo <span class="string">&quot;0 $(blockdev --getsize /dev/ram0) delay /dev/ram0 0 500 /dev/ram0 0 300&quot;</span> | dmsetup create delayed</span><br><span class="line"></span><br><span class="line">$ dmsetup remove /dev/mapper/delayed</span><br></pre></td></tr></table></figure><h4 id="dm-linear"><a href="#dm-linear" class="headerlink" title="dm-linear"></a>dm-linear</h4><p>The dm-linear target maps a linear range of blocks of the device-mapper device onto a linear range of a backend device. dm-linear is the basic building block of logical volume managers such as LVM.</p><h4 id="dm-flakey"><a href="#dm-flakey" class="headerlink" title="dm-flakey"></a>dm-flakey</h4><p>This target is the same as the linear target except that it exhibits unreliable behaviour periodically.  Its been found useful in simulating failing devices for testing purposes.</p><ul><li>drop_writes All write I/Os are silently ignored and dropped. Read I/Os are handled correctly.</li><li>error_writes All write I/Os are failed with an error signaled. Read I/Os are handled correctly.</li><li>corrupt_bio_byte During the down time, replace the Nth byte of the data of each read or write block I/O with a specified value.<br>The default error mode is to fail all I/O requests during the down time of the simulation cycle.</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">tabled parameters:</span><br><span class="line">&lt;dev path&gt; &lt;offset&gt; &lt;up interval&gt; &lt;down interval&gt;  [&lt;num_features&gt; [&lt;feature arguments&gt;]]</span><br><span class="line">$ dmsetup create test --table <span class="string">&#x27;0 123 flakey /dev/sda1 0 4 8&#x27;</span></span><br><span class="line">$  file /dev/mapper/dm_test0 </span><br><span class="line">/dev/mapper/dm_test0: symbolic link <span class="keyword">to</span> <span class="built_in">..</span>/dm-0</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line"><span class="attribute">filename</span>=/dev/dm-0</span><br><span class="line"><span class="comment">#readwrite=randrw</span></span><br><span class="line"><span class="attribute">readwrite</span>=randread</span><br><span class="line"><span class="attribute">blocksize</span>=4k</span><br><span class="line"><span class="attribute">ioengine</span>=sync</span><br><span class="line"><span class="attribute">time_based</span>=1</span><br><span class="line"><span class="attribute">runtime</span>=130</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fio-3.1</span><br><span class="line">Starting 1 process</span><br><span class="line">fio: io_u <span class="builtin-name">error</span> on file /dev/dm-0: Input/output error: read <span class="attribute">offset</span>=0, <span class="attribute">buflen</span>=4096</span><br><span class="line">random: <span class="literal">No</span> I/O performed by sync, perhaps try <span class="attribute">--debug</span>=io option <span class="keyword">for</span> details?</span><br><span class="line">fio: <span class="attribute">pid</span>=16261, <span class="attribute">err</span>=5/file:io_u.c:1756, <span class="attribute">func</span>=io_u error, <span class="attribute">error</span>=Input/output error</span><br><span class="line"></span><br><span class="line">random: (<span class="attribute">groupid</span>=0, <span class="attribute">jobs</span>=1): err= 5 (file:io_u.c:1756, <span class="attribute">func</span>=io_u error, <span class="attribute">error</span>=Input/output error): <span class="attribute">pid</span>=16261: Fri Jun  5 00:29:08 2020</span><br><span class="line">  cpu          : <span class="attribute">usr</span>=0.00%, <span class="attribute">sys</span>=0.00%, <span class="attribute">ctx</span>=0, <span class="attribute">majf</span>=0, <span class="attribute">minf</span>=17</span><br><span class="line">  IO depths    : <span class="attribute">1</span>=100.0%, <span class="attribute">2</span>=0.0%, <span class="attribute">4</span>=0.0%, <span class="attribute">8</span>=0.0%, <span class="attribute">16</span>=0.0%, <span class="attribute">32</span>=0.0%, &gt;=<span class="attribute">64</span>=0.0%</span><br><span class="line">     submit    : <span class="attribute">0</span>=0.0%, <span class="attribute">4</span>=100.0%, <span class="attribute">8</span>=0.0%, <span class="attribute">16</span>=0.0%, <span class="attribute">32</span>=0.0%, <span class="attribute">64</span>=0.0%, &gt;=<span class="attribute">64</span>=0.0%</span><br><span class="line">     complete  : <span class="attribute">0</span>=50.0%, <span class="attribute">4</span>=50.0%, <span class="attribute">8</span>=0.0%, <span class="attribute">16</span>=0.0%, <span class="attribute">32</span>=0.0%, <span class="attribute">64</span>=0.0%, &gt;=<span class="attribute">64</span>=0.0%</span><br><span class="line">     issued rwt: <span class="attribute">total</span>=1,0,0, <span class="attribute">short</span>=0,0,0, <span class="attribute">dropped</span>=0,0,0</span><br><span class="line">     latency   : <span class="attribute">target</span>=0, <span class="attribute">window</span>=0, <span class="attribute">percentile</span>=100.00%, <span class="attribute">depth</span>=1</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">Run</span> status<span class="built_in"> group </span>0 (all jobs):</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">    dm-0: <span class="attribute">ios</span>=0/0, <span class="attribute">merge</span>=0/0, <span class="attribute">ticks</span>=0/0, <span class="attribute">in_queue</span>=0, <span class="attribute">util</span>=0.00%, <span class="attribute">aggrios</span>=0/0, <span class="attribute">aggrmerge</span>=0/0, <span class="attribute">aggrticks</span>=0/0, <span class="attribute">aggrin_queue</span>=0, <span class="attribute">aggrutil</span>=0.00%</span><br><span class="line">  sda: <span class="attribute">ios</span>=0/0, <span class="attribute">merge</span>=0/0, <span class="attribute">ticks</span>=0/0, <span class="attribute">in_queue</span>=0, <span class="attribute">util</span>=0.00%</span><br><span class="line"></span><br><span class="line">[18800.528564] buffer_io_error: 110 callbacks suppressed</span><br><span class="line">[18800.528569] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 0, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528582] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 1, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528587] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 2, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528591] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 3, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528596] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 4, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528600] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 5, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528604] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 6, async<span class="built_in"> page </span>read</span><br><span class="line">[18800.528608] Buffer I/O <span class="builtin-name">error</span> on dev dm-0, logical block 7, async<span class="built_in"> page </span>read</span><br></pre></td></tr></table></figure><p>$ dmsetup suspend /dev/dm-0<br>$ dmsetup resume /dev/dm-0</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">dm-linear</span><br><span class="line">dm-zoned</span><br><span class="line"><span class="section">(dm-dust)[https://www.kernel.org/doc/Documentation/device-mapper/dm-dust.txt]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">the fio demo</span><br><span class="line">```bash</span><br><span class="line">[global]</span><br><span class="line">directory=./</span><br><span class="line">iodepth=8</span><br><span class="line">rwmixread=50</span><br><span class="line">numjobs=32</span><br><span class="line">size=100M</span><br><span class="line">norandommap=1</span><br><span class="line">group_reporting</span><br><span class="line">refill_buffers</span><br><span class="line">end_fsync=1</span><br><span class="line">disable_slat=1</span><br><span class="line">exitall</span><br><span class="line">timeout=36000</span><br><span class="line">direct=0</span><br><span class="line">nrfiles=8</span><br><span class="line">bssplit=4k/10:32k/20:64k/20:128k/20:256k/20:1024k/10</span><br><span class="line">[job1]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job2]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job3]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job4]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job5]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job6]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job7]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job8]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job9]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job10]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=posixaio</span><br><span class="line">[job11]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=sync</span><br><span class="line">[job12]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=sync</span><br><span class="line">[job13]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=sync</span><br><span class="line">[job14]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=sync</span><br><span class="line">[job15]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=sync</span><br><span class="line">[job16]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=psync</span><br><span class="line">[job17]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=psync</span><br><span class="line">[job18]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=psync</span><br><span class="line">[job19]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=psync</span><br><span class="line">[job20]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=psync</span><br><span class="line">[job21]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job22]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job23]</span><br><span class="line">rw=randread</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job24]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=vsync</span><br><span class="line">[job25]</span><br><span class="line">rw=randrw</span><br><span class="line">ioengine=vsync</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Benchmark </category>
          
      </categories>
      
      
        <tags>
            
            <tag> test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>network topology</title>
      <link href="2020/03/16/network_topology/"/>
      <url>2020/03/16/network_topology/</url>
      
        <content type="html"><![CDATA[<h3 id="Deep-buffers-matter"><a href="#Deep-buffers-matter" class="headerlink" title="Deep buffers matter"></a>Deep buffers matter</h3><ul><li>lossless networks</li><li>how to they deal with incast problems ?<ul><li>Answer: tell everyone to stop<ul><li>In theory, allows small buffers</li><li>In practice, this leads to tree saturation</li><li>Causes blocking all the way to all sources<br><img src="/img/deep_buffer_matt-1.png"><table><thead><tr><th>Customer</th><th align="center">Real Buffer Utilization</th><th align="right">Cool</th></tr></thead><tbody><tr><td>HPC</td><td align="center">Storage Clustre -medium</td><td align="right">33MB</td></tr><tr><td>Animation</td><td align="center">Storage filer(NFS)</td><td align="right">6.2MB</td></tr><tr><td>Software vendor</td><td align="center">Engineering Build servers</td><td align="right">14.9MB</td></tr><tr><td>Online shopping</td><td align="center">Hadoop 2K servers -big data</td><td align="right">52.3MB</td></tr><tr><td>Educational</td><td align="center">Virtualization</td><td align="right">52.4MB</td></tr></tbody></table></li></ul></li></ul></li></ul><h4 id="Deep-Buffers-Matter"><a href="#Deep-Buffers-Matter" class="headerlink" title="Deep Buffers Matter!"></a>Deep Buffers Matter!</h4><p>cause packets dropped per teragen<br>Improving uplink contention in mixed speed networks<br>High Density in core/spine (many-to-one, in-cast, fan-in)<br><img src="/img/deep_buffer_matt-2.png"></p><h4 id="Buffer-utilisation-per-port"><a href="#Buffer-utilisation-per-port" class="headerlink" title="Buffer utilisation per port"></a>Buffer utilisation per port</h4><p>some switch get the lower buffer utilisation<br>it could cause a lot of tcp retransmit</p><p>The question is our issues.<br>How much buffer are you using ? Any visibility ?<br>What cause your retransmits ?<br><img src="/img/deep_buffer_matt-3.png"></p>]]></content>
      
      
      <categories>
          
          <category> Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> architecture </tag>
            
            <tag> topology </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GDB tips</title>
      <link href="2020/03/03/gdb/"/>
      <url>2020/03/03/gdb/</url>
      
        <content type="html"><![CDATA[<h3 id="OS-settting"><a href="#OS-settting" class="headerlink" title="OS settting"></a>OS settting</h3><h4 id="Core-pattern"><a href="#Core-pattern" class="headerlink" title="Core pattern"></a>Core pattern</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/sys/kernel/core_pattern</span><br><span class="line">/usr/share/apport/apport %p %s %c %d %P %E</span><br><span class="line"><span class="comment">## kernel variable</span></span><br><span class="line">kernel.core_pattern = |/usr/share/apport/apport %p %s %c %d %P %E</span><br><span class="line"><span class="comment">#If the first character of the pattern is a &#x27;|&#x27;, the kernel will treat the rest of the pattern as a command to run.  The core dump will be written to the standard input of that program instead of to a file.</span></span><br><span class="line"></span><br><span class="line">kernel.core_pipe_limit = 0</span><br><span class="line"><span class="comment"># This sysctl is only applicable when core_pattern is configured to pipe core files to a user space helper (when the first character of core_pattern is a &#x27;|&#x27;, see above).  When collecting cores via a pipe to an application, it is occasionally useful for the collecting application to gather data about the crashing process from its /proc/pid directory.  In order to do this safely, the kernel must wait for the collecting process to exit, so as not to remove the crashing processes proc files prematurely.  This in turn creates the possibility that a misbehaving userspace collecting process can block the reaping of a crashed process simply by never exiting.  This sysctl defends against that. It defines how many concurrent crashing processes may be piped to user space applications in parallel.  If this value is exceeded, then those crashing processes above that value are noted via the kernel log and their cores are skipped.  0 is a special value, indicating that unlimited processes may be captured in parallel, but that no waiting will take place (i.e. the collecting process is not guaranteed access to `/proc/&lt;crashing pid&gt;/`).</span></span><br><span class="line"></span><br><span class="line">kernel.core_uses_pid = 0</span><br><span class="line">kernel.core_patternfs.suid_dumpable = 2</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ulimit</span> -S -c unlimited</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable genarate the core file</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -c n</span><br></pre></td></tr></table></figure><h4 id="Core-single"><a href="#Core-single" class="headerlink" title="Core single"></a>Core single</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Standard signals</span><br><span class="line">     Linux supports the standard signals listed below.  Several signal  numbers  are  architecture-dependent,  as</span><br><span class="line">     indicated  <span class="keyword">in</span>  the  <span class="string">&quot;Value&quot;</span> column.  (Where three values are given, the first one is usually valid <span class="keyword">for</span> alpha</span><br><span class="line">     and sparc, the middle one <span class="keyword">for</span> x86, arm, and most other architectures, and the last one  <span class="keyword">for</span>  mips.   (Values</span><br><span class="line">     <span class="keyword">for</span>  parisc  are  not shown; see the Linux kernel <span class="built_in">source</span> <span class="keyword">for</span> signal numbering on that architecture.)  A dash</span><br><span class="line">     (-) denotes that a signal is absent on the corresponding architecture.</span><br><span class="line"></span><br><span class="line">     First the signals described <span class="keyword">in</span> the original POSIX.1-1990 standard.</span><br><span class="line"></span><br><span class="line">     Signal     Value     Action   Comment</span><br><span class="line">     </span><br><span class="line">     SIGQUIT       3       Core    Quit from keyboard</span><br><span class="line">     SIGILL        4       Core    Illegal Instruction</span><br><span class="line">     SIGABRT       6       Core    Abort signal from abort(3)</span><br><span class="line">     SIGFPE        8       Core    Floating-point exception</span><br><span class="line">     SIGSEGV      11       Core    Invalid memory reference</span><br><span class="line"></span><br><span class="line">     The signals SIGKILL and SIGSTOP cannot be caught, blocked, or ignored.</span><br><span class="line"></span><br><span class="line">     Next the signals not <span class="keyword">in</span> the POSIX.1-1990 standard but described <span class="keyword">in</span> SUSv2 and POSIX.1-2001.</span><br><span class="line"></span><br><span class="line">     Signal       Value     Action   Comment</span><br><span class="line">     </span><br><span class="line">     SIGBUS      10,7,10     Core    Bus error (bad memory access)</span><br><span class="line">     SIGSYS      12,31,12    Core    Bad system call (SVr4);</span><br><span class="line">                                     see also seccomp(2)</span><br><span class="line">     SIGTRAP        5        Core    Trace/breakpoint <span class="built_in">trap</span></span><br><span class="line">     SIGXCPU     24,24,30    Core    CPU time <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">                                     see setrlimit(2)</span><br><span class="line">     SIGXFSZ     25,25,31    Core    File size <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">                                     see setrlimit(2)</span><br><span class="line">     Up to and including Linux 2.2, the default behavior <span class="keyword">for</span> SIGSYS,  SIGXCPU,  SIGXFSZ,  and  (on  architectures</span><br><span class="line">     other  than  SPARC and MIPS) SIGBUS was to terminate the process (without a core dump).  (On some other UNIX</span><br><span class="line">     systems the default action <span class="keyword">for</span> SIGXCPU and SIGXFSZ is to terminate the process without a core dump.)   Linux</span><br><span class="line">     2.4 conforms to the POSIX.1-2001 requirements <span class="keyword">for</span> these signals, terminating the process with a core dump.</span><br><span class="line"></span><br><span class="line">     Next various other signals.</span><br><span class="line"></span><br><span class="line">     Signal       Value     Action   Comment</span><br><span class="line">     </span><br><span class="line">     SIGIOT         6        Core    IOT <span class="built_in">trap</span>. A synonym <span class="keyword">for</span> SIGABRT</span><br><span class="line">     SIGUNUSED    -,31,-     Core    Synonymous with SIGSYS</span><br><span class="line"></span><br><span class="line">     (Signal 29 is SIGINFO / SIGPWR on an alpha but SIGLOST on a sparc.)</span><br><span class="line"></span><br><span class="line">     SIGEMT  is  not  specified  <span class="keyword">in</span>  POSIX.1-2001, but nevertheless appears on most other UNIX systems, <span class="built_in">where</span> its</span><br><span class="line">     default action is typically to terminate the process with a core dump.</span><br><span class="line"></span><br><span class="line">     SIGPWR (<span class="built_in">which</span> is not specified <span class="keyword">in</span> POSIX.1-2001) is typically ignored by default on those other UNIX  systems</span><br><span class="line">     <span class="built_in">where</span> it appears.</span><br><span class="line"></span><br><span class="line">     SIGIO (<span class="built_in">which</span> is not specified <span class="keyword">in</span> POSIX.1-2001) is ignored by default on several other UNIX systems.</span><br><span class="line"></span><br><span class="line">     Where defined, SIGUNUSED is synonymous with SIGSYS on most architectures.  Since glibc 2.26, SIGUNUSED is no</span><br><span class="line">     longer defined on any architecture.</span><br></pre></td></tr></table></figure><h4 id="Enable-ptrace-permissions"><a href="#Enable-ptrace-permissions" class="headerlink" title="Enable ptrace permissions"></a>Enable ptrace permissions</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysctl.d/10-ptrace.conf</span><br><span class="line">kernel.yama.ptrace_scope = 0</span><br><span class="line"></span><br><span class="line">0 - classic ptrace permissions: a process can PTRACE_ATTACH to any other</span><br><span class="line">    process running under the same uid, as long as it is dumpable (i.e.</span><br><span class="line">    did not transition uids, start privileged, or have called</span><br><span class="line">    prctl(PR_SET_DUMPABLE...) already). Similarly, PTRACE_TRACEME is</span><br><span class="line">    unchanged.</span><br><span class="line"></span><br><span class="line">1 - restricted ptrace: a process must have a predefined relationship</span><br><span class="line">    with the inferior it wants to call PTRACE_ATTACH on. By default,</span><br><span class="line">    this relationship is that of only its descendants when the above</span><br><span class="line">    classic criteria is also met. To change the relationship, an</span><br><span class="line">    inferior can call prctl(PR_SET_PTRACER, debugger, ...) to <span class="built_in">declare</span></span><br><span class="line">    an allowed debugger PID to call PTRACE_ATTACH on the inferior.</span><br><span class="line">    Using PTRACE_TRACEME is unchanged.</span><br><span class="line"></span><br><span class="line">2 - admin-only attach: only processes with CAP_SYS_PTRACE may use ptrace</span><br><span class="line">    with PTRACE_ATTACH, or through children calling PTRACE_TRACEME.</span><br><span class="line"></span><br><span class="line">3 - no attach: no processes may use ptrace with PTRACE_ATTACH nor via</span><br><span class="line">    PTRACE_TRACEME. Once <span class="built_in">set</span>, this sysctl value cannot be changed.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Genarate-the-debug-info"><a href="#Genarate-the-debug-info" class="headerlink" title="Genarate the debug info"></a>Genarate the debug info</h3><ul><li>-g produces debugging information in theOS native format</li><li>-ggdb produces debugging information specifically intennded for gdb</li><li>-ggdb3 produces extra debugging information, for example: including macro definitions</li><li>wall means enable warnning</li><li>-O0  turn off all optimization</li><li>-O1 ,-O2, -O3  optimization<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./configure CFLAGS=<span class="string">&quot;-Wall -O2 -ggdb3&quot;</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### Genarate the core file</span></span><br><span class="line">usage:  gcore [-a] [-o filename] pid</span><br><span class="line">```bash</span><br><span class="line">$ gcore -o /tmp/core -p <span class="variable">$pid</span></span><br></pre></td></tr></table></figure></li></ul><p>for the kernel</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br></pre></td></tr></table></figure><h3 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install ubuntu-dbgsym-keyring</span><br></pre></td></tr></table></figure><h3 id="Open-the-core-file"><a href="#Open-the-core-file" class="headerlink" title="Open the core file"></a>Open the core file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ gdb ./a.out ./bubble_sort_core</span><br><span class="line"></span><br><span class="line">GNU gdb (Ubuntu 8.1-0ubuntu3.2) 8.1.0.20180409-git</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">Reading symbols from ./a.out...done.</span><br><span class="line">[New LWP 20410]</span><br><span class="line">Core was generated by `./a.out<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGABRT, Aborted.</span></span><br><span class="line"><span class="string">#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51</span></span><br><span class="line"><span class="string">51../sysdeps/unix/sysv/linux/raise.c: No such file or directory.</span></span><br></pre></td></tr></table></figure><h3 id="attach-the-process"><a href="#attach-the-process" class="headerlink" title="attach the process"></a>attach the process</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gdb attach <span class="variable">$PID</span></span><br><span class="line">$ gdb ./the_programA_binray <span class="variable">$pid_of_the_programA</span></span><br></pre></td></tr></table></figure><h3 id="gdb-basic-cmd"><a href="#gdb-basic-cmd" class="headerlink" title="gdb basic cmd"></a>gdb basic cmd</h3><p>break<br>break +offset<br>break -offset<br>break linenum<br>break filename:linenum<br>break func_name<br>break filename:func_name<br>break *address<br>break  if <condition></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#<span class="meta"># not work</span></span><br><span class="line"><span class="keyword">break</span> foo <span class="keyword">if</span> i&gt;<span class="number">0</span></span><br><span class="line">commands</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;i is %d\n&quot;</span>, i</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="built_in">end</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b func_name <span class="keyword">if</span> var_name == 5</span><br></pre></td></tr></table></figure><p>info break (i b)<br>i b n</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x564b218ff830: file ./bubble_sort_bug.c, line 29.</span><br><span class="line">(gdb) b <span class="built_in">exit</span></span><br><span class="line">Breakpoint 2 at 0x7f258be23120: file exit.c, line 139.</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x0000564b218ff830 <span class="keyword">in</span> main at ./bubble_sort_bug.c:29</span><br><span class="line">2       breakpoint     keep y   0x00007f258be23120 <span class="keyword">in</span> __GI_exit at exit.c:139</span><br><span class="line">(gdb) i b 2</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">2       breakpoint     keep y   0x00007f258be23120 <span class="keyword">in</span> __GI_exit at exit.c:139</span><br><span class="line">(gdb) b main <span class="keyword">if</span> i==1</span><br><span class="line">Breakpoint 4 at 0x555555554830: file ./bubble_sort_bug.c, line 29.</span><br></pre></td></tr></table></figure><p>watch var   It is stopped by the gdb after the write has occurred<br>rwatch var  It is stopped by the gdb after the read has occurred<br>awatch var  It is stopped by the gdb after the read and write have occurred</p><p>step  (in function0<br>next  (not go to function)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info b</span><br><span class="line">No breakpoints or watchpoints.</span><br><span class="line">(gdb) watch a <span class="keyword">if</span> a==5 </span><br><span class="line">Hardware watchpoint 3: a</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">3       hw watchpoint  keep y                      a</span><br><span class="line">stop only <span class="keyword">if</span> a==5</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 2 <span class="string">&quot;a.out&quot;</span> hit Hardware watchpoint 3: a</span><br><span class="line"></span><br><span class="line">Old value = 4</span><br><span class="line">New value = 5</span><br><span class="line">thread1_func (p_arg=0x555555554844) at thread1.c:10</span><br><span class="line">10                sleep(10);</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">(gdb) info watchpoints</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">3       hw watchpoint  keep y                      a</span><br><span class="line">stop only <span class="keyword">if</span> a==5</span><br><span class="line">breakpoint already hit 1 time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(gdb) watch 0x600850</span><br><span class="line">Cannot watch constant value 0x600850.</span><br><span class="line">(gdb) watch *(int *) 0x600850</span><br><span class="line">Watchpoint 1: *(int *) 6293584 </span><br></pre></td></tr></table></figure><p>catch <event><br>tcatch <event>  (temp catch)<br>event: throw,catch,exec,fork,load,unload,exception,exception unhandled,assert,syscall [name | number ],</p><p>(gdb) catch syscall open<br>Catchpoint 7 (syscall open [2])<br>(gdb) catch syscall 5<br>Catchpoint 8 (syscall fstat [5])<br>(gdb) help catch syscall<br>Catch system calls by their names, groups and/or numbers.<br>Arguments say which system calls to catch.  If no arguments are given,<br>every system call will be caught.  Arguments, if given, should be one<br>or more system call names (if your system supports that), system call<br>groups or system call numbers.</p><p>for more syscall<br>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</p><p>clear #clear all<br>clear function<br>clear linenum</p><p>delete beakpoints [range,eg: 1-5]</p><p>enable/disable breakpoints [range]<br>enable breakpoints once range<br>enable breakpoints delete range</p><p>set logging file the_log_filename<br>set logging on/off<br>set env PATH=/tmp/bin<br>set listsize 25</p><h1 id="set-print-variable-length"><a href="#set-print-variable-length" class="headerlink" title="set print variable length"></a>set print variable length</h1><p>set print elements 250<br>set print elements 0 #no limit</p><p>set step-mode on<br>This is useful in cases where you may be interested in inspecting the machine instructions of a function which has no symbolic info and do not want GDB to automatically skip over this function.</p><p>save br .gdb_20200601<br>-x .gdb_20200601</p><p>finish<br>Continue running until just after function in the selected stack frame returns. Print the returned value (if any). This command can be abbreviated as fin.</p><p>return</p><p>print expr<br>Evaluate the expression expr and display the resulting value. The expression may include calls to functions in the program being debugged.</p><p>call expr<br>Evaluate the expression expr without displaying void returned values.<br>You can use this variant of the print command if you want to execute a function from your program that does not return anything (a.k.a. a void function), but without cluttering the output with void returned values that GDB will otherwise print. If the result is not void, it is printed and saved in the value history.<br>It is possible for the function you call via the print or call command to generate a signal (e.g., if theres a bug in the function, or if you passed it incorrect arguments). What happens in that case is controlled by the set unwindonsignal command.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51</span></span><br><span class="line"><span class="comment">#1  0x00007f258be20801 in __GI_abort () at abort.c:79</span></span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort, </span></span><br><span class="line">    fmt=fmt@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line"><span class="comment">#3  0x00007f258bf14cd1 in __GI___fortify_fail_abort (need_backtrace=need_backtrace@entry=false, </span></span><br><span class="line">    msg=msg@entry=0x7f258bf96966 <span class="string">&quot;stack smashing detected&quot;</span>) at fortify_fail.c:33</span><br><span class="line"><span class="comment">#4  0x00007f258bf14c92 in __stack_chk_fail () at stack_chk_fail.c:29</span></span><br><span class="line"><span class="comment">#5  0x0000564b218ff8e9 in main () at ./bubble_sort_bug.c:43</span></span><br><span class="line"></span><br><span class="line">(gdb) f 2</span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort, </span></span><br><span class="line">    fmt=fmt@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line">181../sysdeps/posix/libc_fatal.c: No such file or directory.</span><br><span class="line">(gdb) up</span><br><span class="line"><span class="comment">#3  0x00007f258bf14cd1 in __GI___fortify_fail_abort (need_backtrace=need_backtrace@entry=false, </span></span><br><span class="line">    msg=msg@entry=0x7f258bf96966 <span class="string">&quot;stack smashing detected&quot;</span>) at fortify_fail.c:33</span><br><span class="line">33fortify_fail.c: No such file or directory.</span><br><span class="line">(gdb) down</span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort, </span></span><br><span class="line">    fmt=fmt@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line">181../sysdeps/posix/libc_fatal.c: No such file or directory.</span><br><span class="line"></span><br><span class="line">(gdb) f 5</span><br><span class="line"><span class="comment">#5  0x0000564b218ff8e9 in main () at ./bubble_sort_bug.c:43</span></span><br><span class="line">43&#125;</span><br><span class="line">(gdb) info f</span><br><span class="line">Stack level 5, frame at 0x7ffd58ea9f80:</span><br><span class="line"> rip = 0x564b218ff8e9 <span class="keyword">in</span> main (./bubble_sort_bug.c:43); saved rip = 0x7f258be01b97</span><br><span class="line"> <span class="built_in">caller</span> of frame at 0x7ffd58ea9e40</span><br><span class="line"> <span class="built_in">source</span> language c.</span><br><span class="line"> Arglist at 0x7ffd58ea9f70, args: </span><br><span class="line"> Locals at 0x7ffd58ea9f70, Previous frame<span class="string">&#x27;s sp is 0x7ffd58ea9f80</span></span><br><span class="line"><span class="string"> Saved registers:</span></span><br><span class="line"><span class="string">  rbx at 0x7ffd58ea9f68, rbp at 0x7ffd58ea9f70, rip at 0x7ffd58ea9f78</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) info args</span></span><br><span class="line"><span class="string">No arguments.</span></span><br><span class="line"><span class="string">(gdb) info locals</span></span><br><span class="line"><span class="string">array = &#123;20424913, 207764369, 232957269, 286304630, 340051919, 418929367, 428095442, 560929304, 622631137, </span></span><br><span class="line"><span class="string">  681405812, 702646332, 717507172, 771731937, 844764348, 871741416, 893622553, 939367001, 953569863, 983680782, </span></span><br><span class="line"><span class="string">  1133421906, 1150235085, 1170267861, 1267699692, 1278859841, 1351132359, 1478380837, 1618765791, 1747714870, </span></span><br><span class="line"><span class="string">  2015283722, 2027462427, 2046956728, 2080576919&#125;</span></span><br><span class="line"><span class="string">i = 36</span></span><br></pre></td></tr></table></figure><p>info</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info <span class="built_in">functions</span> thread1_func </span><br><span class="line">All <span class="built_in">functions</span> matching regular expression <span class="string">&quot;thread1_func&quot;</span>:</span><br><span class="line"></span><br><span class="line">File thread1.c:</span><br><span class="line">void *thread1_func(void *);</span><br></pre></td></tr></table></figure><p>print</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">(gdb) list</span><br><span class="line">1<span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line">2<span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line">3</span><br><span class="line">4void printArray(int arr[], int n)</span><br><span class="line">5&#123;</span><br><span class="line">6   <span class="keyword">for</span> (int i=0; i&lt;n; i++) &#123;</span><br><span class="line">7     arr[i]=arr[i]+i;</span><br><span class="line">8     <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line">9   &#125;</span><br><span class="line">10&#125;</span><br><span class="line">11</span><br><span class="line">12int main()</span><br><span class="line">13&#123;</span><br><span class="line">14    int n = 10;</span><br><span class="line">15    int arr[n];</span><br><span class="line">16</span><br><span class="line">17    // Fill whole array with 100.</span><br><span class="line">18    memset(arr, 10, n*sizeof(arr[0]));</span><br><span class="line">19    <span class="built_in">printf</span>(<span class="string">&quot;Array after memset()\n&quot;</span>);</span><br><span class="line">20    printArray(arr, n);</span><br><span class="line">21</span><br><span class="line">22    <span class="built_in">return</span> 0;</span><br><span class="line">23&#125;</span><br><span class="line"></span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x00000000004005d5 <span class="keyword">in</span> printArray at test2.c:7</span><br><span class="line">breakpoint already hit 10 <span class="built_in">times</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span><br><span class="line">7     arr[i]=arr[i]+i;</span><br><span class="line">(gdb) <span class="built_in">print</span> arr</span><br><span class="line"><span class="variable">$13</span> = (int *) 0x7fffffffe0d0</span><br><span class="line">(gdb) <span class="built_in">print</span> *arr</span><br><span class="line"><span class="variable">$14</span> = 168430090</span><br><span class="line">(gdb) <span class="built_in">print</span> *arr@</span><br><span class="line">A syntax error <span class="keyword">in</span> expression, near `<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 3</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430090, 168430090, 168430090, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">$15 = 4</span></span><br><span class="line"><span class="string">(gdb) p arr[i]</span></span><br><span class="line"><span class="string">$16 = 168430090</span></span><br><span class="line"><span class="string">(gdb) p arr[20]</span></span><br><span class="line"><span class="string">$17 = -7664</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">Continuing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">7     arr[i]=arr[i]+i;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">$20 = 5</span></span><br><span class="line"><span class="string">(gdb) set arr[4]=125</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 5</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430093, 125, 168430090, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">Continuing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">7     arr[i]=arr[i]+i;</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 6</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430093, 168430094, 168430095, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">No symbol &quot;i&quot; in current context.</span></span><br><span class="line"><span class="string">(gdb) p $i</span></span><br><span class="line"><span class="string">$24 = 5</span></span><br><span class="line"><span class="string">(gdb) set arr[$i]=10</span></span><br><span class="line"><span class="string">(gdb) set arr[$i++]=11</span></span><br><span class="line"><span class="string">(gdb) p arr[5]</span></span><br><span class="line"><span class="string">$26 = 10</span></span><br><span class="line"><span class="string">(gdb) p arr[6]</span></span><br><span class="line"><span class="string">$27 = 11</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) p/t arr[6]</span></span><br><span class="line"><span class="string">$28 = 1011</span></span><br><span class="line"><span class="string">(gdb) p/x arr[6]</span></span><br><span class="line"><span class="string">$29 = 0xb</span></span><br><span class="line"><span class="string">(gdb) p/f arr[6]</span></span><br><span class="line"><span class="string">$30 = 1.54142831e-44</span></span><br><span class="line"><span class="string">(gdb) p/c arr[6]</span></span><br><span class="line"><span class="string">$31 = 11 &#x27;</span>\v<span class="string">&#x27;</span></span><br><span class="line"><span class="string">(gdb) p/d arr[6]</span></span><br><span class="line"><span class="string">$32 = 11</span></span><br><span class="line"><span class="string">(gdb) p/o arr[6]</span></span><br><span class="line"><span class="string">$33 = 013</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">examine (x command)</span></span><br><span class="line"><span class="string">(gdb) p arr</span></span><br><span class="line"><span class="string">$37 = &#123;168430090, 168430091, 168430092, 168430093, 168430094, 10, 11, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">      __________ same with print format</span></span><br><span class="line"><span class="string">      |</span></span><br><span class="line"><span class="string">x/[n][f][u]</span></span><br><span class="line"><span class="string">   |     |</span></span><br><span class="line"><span class="string"> number  -------------- b. Bytes. h. Halfwords (two bytes). w. Words (four bytes) This is the initial default.  g. Giant words (eight bytes)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) x/10d arr</span></span><br><span class="line"><span class="string">0x7fffffffe0d0:168430090168430091168430092168430093</span></span><br><span class="line"><span class="string">0x7fffffffe0e0:1684300941011168430090</span></span><br><span class="line"><span class="string">0x7fffffffe0f0:168430090168430090</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) info reg</span></span><br><span class="line"><span class="string">rax            0x400aaae297396d094614688658370948361</span></span><br><span class="line"><span class="string">rbx            0x7fffffffe100140737488347392</span></span><br><span class="line"><span class="string">rcx            0x7fffdfafe9b0140736946235824</span></span><br><span class="line"><span class="string">rdx            0xa10</span></span><br><span class="line"><span class="string">rsi            0xa10</span></span><br><span class="line"><span class="string">rdi            0x7fffffffe0d0140737488347344</span></span><br><span class="line"><span class="string">rbp            0x7fffffffe0c00x7fffffffe0c0</span></span><br><span class="line"><span class="string">rsp            0x7fffffffe0900x7fffffffe090</span></span><br><span class="line"><span class="string">r8             0xffffffffffffffff-1</span></span><br><span class="line"><span class="string">r9             0x00</span></span><br><span class="line"><span class="string">r10            0x2234</span></span><br><span class="line"><span class="string">r11            0x246582</span></span><br><span class="line"><span class="string">r12            0x4004d04195536</span></span><br><span class="line"><span class="string">r13            0x7fffffffe210140737488347664</span></span><br><span class="line"><span class="string">r14            0x00</span></span><br><span class="line"><span class="string">r15            0x00</span></span><br><span class="line"><span class="string">rip            0x4005da0x4005da &lt;printArray+29&gt;</span></span><br><span class="line"><span class="string">eflags         0x206[ PF IF ]</span></span><br><span class="line"><span class="string">cs             0x3351</span></span><br><span class="line"><span class="string">ss             0x2b43</span></span><br><span class="line"><span class="string">ds             0x00</span></span><br><span class="line"><span class="string">es             0x00</span></span><br><span class="line"><span class="string">fs             0x00</span></span><br><span class="line"><span class="string">gs             0x00</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) list</span></span><br><span class="line"><span class="string">1#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">2int main()</span></span><br><span class="line"><span class="string">3&#123;</span></span><br><span class="line"><span class="string">4        float x = 456.876;</span></span><br><span class="line"><span class="string">5        printf (&quot;\nx = %f\n&quot;, x);</span></span><br><span class="line"><span class="string">6        return 0;</span></span><br><span class="line"><span class="string">7&#125;</span></span><br><span class="line"><span class="string">(gdb) b 4</span></span><br><span class="line"><span class="string">Breakpoint 1 at 0x400535: file float.c, line 4.</span></span><br><span class="line"><span class="string">(gdb) b 5</span></span><br><span class="line"><span class="string">Breakpoint 2 at 0x40053e: file float.c, line 5.</span></span><br><span class="line"><span class="string">(gdb) b 6</span></span><br><span class="line"><span class="string">Breakpoint 3 at 0x400555: file float.c, line 6.</span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">The program is not being run.</span></span><br><span class="line"><span class="string">(gdb) start</span></span><br><span class="line"><span class="string">Temporary breakpoint 4 at 0x400535: file float.c, line 4.</span></span><br><span class="line"><span class="string">Starting program: /root/./a.out</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, main () at float.c:4</span></span><br><span class="line"><span class="string">4        float x = 456.876;</span></span><br><span class="line"><span class="string">(gdb) n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 2, main () at float.c:5</span></span><br><span class="line"><span class="string">5        printf (&quot;\nx = %f\n&quot;, x);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) p x</span></span><br><span class="line"><span class="string">$5 = 456.876007</span></span><br><span class="line"><span class="string">(gdb) x/fw &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe12c:456.876007</span></span><br><span class="line"><span class="string">(gdb) x/tw &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe12c:01000011111001000111000000100001</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### modify the float to double</span></span><br><span class="line"><span class="string">(gdb) list</span></span><br><span class="line"><span class="string">1#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">2int main()</span></span><br><span class="line"><span class="string">3&#123;</span></span><br><span class="line"><span class="string">4        //float x = 456.876;</span></span><br><span class="line"><span class="string">5        double x = 456.876;</span></span><br><span class="line"><span class="string">6        printf (&quot;\nx = %lf\n&quot;, x);</span></span><br><span class="line"><span class="string">7        return 0;</span></span><br><span class="line"><span class="string">8&#125;</span></span><br><span class="line"><span class="string">(gdb) x/1fg &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe128:456.87599999999998</span></span><br><span class="line"><span class="string">(gdb) x/1tg &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe128:0100000001111100100011100000010000011000100100110111010010111100</span></span><br><span class="line"><span class="string">(gdb) p x</span></span><br><span class="line"><span class="string">$6 = 456.87599999999998</span></span><br></pre></td></tr></table></figure><h3 id="print-argv"><a href="#print-argv" class="headerlink" title="print argv"></a><a href="https://wizardforcel.gitbooks.io/100-gdb-tips/set-program-args.html">print argv</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -g3 walk1.c -o walk</span><br><span class="line">$ gdb ./walk <span class="comment"># or you could $ gdb -args ./walk /tmp 10</span></span><br><span class="line">Reading symbols from /root/walk...done.</span><br><span class="line"></span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x400bb8: file walk1.c, line 73.</span><br><span class="line">(gdb) r /tmp 10 <span class="comment">#  or you could (gdb) set args /tmp 10</span></span><br><span class="line">Starting program: /root/./walk /tmp 10</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main (argc=3, argv=0x7fffffffe138) at walk1.c:73</span><br><span class="line">73    <span class="keyword">if</span>(argc != 3)</span><br><span class="line">(gdb) p argc</span><br><span class="line"><span class="variable">$1</span> = 3</span><br><span class="line">(gdb) p argv</span><br><span class="line"><span class="variable">$2</span> = (char **) 0x7fffffffe138</span><br><span class="line">(gdb) p argv[0]</span><br><span class="line"><span class="variable">$3</span> = 0x7fffffffe414 <span class="string">&quot;/root/./walk&quot;</span></span><br><span class="line">(gdb) p argv[1]</span><br><span class="line"><span class="variable">$4</span> = 0x7fffffffe421 <span class="string">&quot;/tmp&quot;</span></span><br><span class="line">(gdb) p argv[2]</span><br><span class="line"><span class="variable">$5</span> = 0x7fffffffe426 <span class="string">&quot;10&quot;</span></span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"><span class="comment"># attach args</span></span><br><span class="line">$ gdb --args /bin/bash -c <span class="string">&#x27;ls -l&#x27;</span></span><br><span class="line">$ <span class="built_in">set</span> listsize 40</span><br><span class="line">$ p *args@4 </span><br><span class="line"></span><br><span class="line"><span class="comment"># if the software was install by source, you could add --directory for import debug symbol</span></span><br><span class="line"><span class="comment"># re-complie bash</span></span><br><span class="line"></span><br><span class="line">$ gdb --args /usr/<span class="built_in">local</span>/bin/bash -c <span class="string">&#x27;echo [1g]&#x27;</span> --directory ~/tools/bash-4.4</span><br><span class="line">(gdb) la src</span><br><span class="line"></span><br><span class="line"><span class="comment">## if you want disable optimze</span></span><br><span class="line">$ CFLAGS=<span class="string">&quot;-g -O0&quot;</span> CXXFLAGS=<span class="string">&quot;-g -O0&quot;</span> LDFLAGS=<span class="string">&quot;-g&quot;</span>  ./configure --enable-debugger</span><br><span class="line">$ CFLAGS=<span class="string">&quot;-g -O0&quot;</span> CXXFLAGS=<span class="string">&quot;-g -O0&quot;</span> LDFLAGS=<span class="string">&quot;-g&quot;</span>  ./make -j 2</span><br><span class="line"></span><br><span class="line"><span class="comment">## set debug directory</span></span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory &lt;directory&gt;</span><br><span class="line">(gdb) show debug-file-directory</span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory /usr/lib/debug</span><br><span class="line">add-symbol-file filename address</span><br><span class="line">add-symbol-file filename address [ -readnow ] [ -mapped ]</span><br><span class="line">add-symbol-file filename -ssection address ...</span><br></pre></td></tr></table></figure><h3 id="golang"><a href="#golang" class="headerlink" title="golang"></a>golang</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build -gcflags <span class="string">&quot;-N -l&quot;</span> gdbsandbox.go</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -p <span class="variable">$pid</span></span><br><span class="line">(gdb) disas readline</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
            <tag> trace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>lfs command</title>
      <link href="2019/12/29/lfs_command/"/>
      <url>2019/12/29/lfs_command/</url>
      
        <content type="html"><![CDATA[<h3 id="check-lfs-log"><a href="#check-lfs-log" class="headerlink" title="check lfs log"></a>check lfs log</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ strings dk</span><br><span class="line">$ lctl df &lt;input file&gt; &lt;output file&gt;</span><br></pre></td></tr></table></figure><h3 id="llog"><a href="#llog" class="headerlink" title="llog"></a>llog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lctl --device MGS llog_print <span class="variable">$&#123;fsname&#125;</span>-MDT0000</span><br></pre></td></tr></table></figure><h3 id="format"><a href="#format" class="headerlink" title="format"></a>format</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mdt</span></span><br><span class="line">FSNAME=lustre</span><br><span class="line">MDS1NID=0.0.0.0@tcp</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> mkfs.lustre --reformat --mgs --backfstype=zfs --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;MDS1NID&#125;</span> mdt_0/mgt_0</span><br><span class="line"><span class="built_in">echo</span> mkfs.lustre --reformat --mdt --backfstype=zfs --mgsnode=<span class="variable">$&#123;MDS1NID&#125;</span> --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;MDS1NID&#125;</span> --index=0 mdt_0/mdt_0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ost</span></span><br><span class="line">FSNAME=lustre</span><br><span class="line">MDS1NID=1.1.1.1@tcp</span><br><span class="line">MDS2NID=2.2.2.2@tcp</span><br><span class="line">OSS1NID=3.3.3.3@tcp </span><br><span class="line">OSS2NID=4.4.4.4@tcp </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..6&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> mkfs.lustre --reformat --backfstype=zfs --ost  --index=<span class="variable">$i</span>  --fsname=<span class="variable">$&#123;FSNAME&#125;</span> --servicenode=<span class="variable">$&#123;OSS1NID&#125;</span> --servicenode=<span class="variable">$&#123;OSS2NID&#125;</span> --mgsnode=<span class="variable">$&#123;MDS1NID&#125;</span>  ost_<span class="variable">$i</span>/ost_<span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="Enable-large-dir-feature"><a href="#Enable-large-dir-feature" class="headerlink" title="Enable large_dir feature"></a>Enable large_dir feature</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tune2fs -O large_dir /dev/nvme0n1p1</span><br><span class="line">$ dumpe2fs -h /dev/nvme0n1p1 | grep feat</span><br><span class="line">$ dumpe2fs 1.45.2.wc1 (27-May-2019)</span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery mmp flex_bg ea_inode dirdata large_dir sparse_super large_file huge_file uninit_bg dir_nlink quota</span><br><span class="line">Journal features:         journal_incompat_revoke</span><br></pre></td></tr></table></figure><h3 id="set-stripe-size-for-tiny-files"><a href="#set-stripe-size-for-tiny-files" class="headerlink" title="set stripe size for tiny files"></a>set stripe size for tiny files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lfs setstripe -S 65536 /tfs10</span><br></pre></td></tr></table></figure><h3 id="change-ipaddr"><a href="#change-ipaddr" class="headerlink" title="change ipaddr"></a>change ipaddr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tunefs.lfs --erase-params --mgsnode=<span class="variable">$new_mgs_ip</span>@tcp --servicenode=<span class="variable">$new_service_ip</span>@tcp0 --writeconf /dev/md4</span><br></pre></td></tr></table></figure><h3 id="Public"><a href="#Public" class="headerlink" title="Public"></a>Public</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">options lnet networks=tcp(bond0)</span><br><span class="line">options ptlrpc ldlm_num_threads=16</span><br><span class="line">options ptlrpc at_max=300</span><br><span class="line">options ptlrpc at_min=50</span><br><span class="line">options ptlrpc ldlm_enqueue_min=250</span><br><span class="line"></span><br><span class="line"><span class="comment">## just test for tcp</span></span><br><span class="line"><span class="built_in">cd</span> /sys/module/lnet/parameters</span><br><span class="line"><span class="built_in">echo</span> 1000 &gt; accept_backlog</span><br><span class="line"><span class="built_in">echo</span> 5 &gt; lnet_retry_count</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; use_tcp_bonding</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /sys/module/ksocklnd/parameters</span><br><span class="line"><span class="built_in">echo</span> 1024 &gt; credits</span><br><span class="line"></span><br><span class="line"><span class="comment"># ldlm_enqueue_min = max(2*net_latency, net_latency + quiescent_time) +\\ 2*service_time</span></span><br><span class="line"><span class="comment"># ldlm_enqueue_min = max(2*50, 50 + 140) + 2*50 = 50+140 + 100 = 290</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#at_max The largest potential RPC timeout that a client can set is 2*at_max. By lowering at_max from 600 to 400 seconds we reduce the worst case I/O delay from 1200 seconds, or 20 minutes, to 800 seconds or just over 13 minutes.</span></span><br><span class="line"><span class="comment">#at_min The 40 second value factors into our calculation for an appropriate LDLM timeout as discussed in section LDLM Timeouts. Our recommendation for Lustre servers is also 40 seconds</span></span><br><span class="line"><span class="comment">#Adaptive Timeouts: In a Lustre file system servers keep track of the time it takes for RPCs to be completed</span></span><br><span class="line"><span class="comment">#The quiescent_time in this formula is to account for the time it takes all Lustre clients to reestablish connections with all Lustre targets following an HSN quiesce. We&#x27;ve experimentally determined an average time to be approximately 140 seconds, but it is possible that this value may vary based on different factors such as the number of Lustre clients, the number of Lustre targets, the number of Lustre file systems mounted on each client, etc. Thus, given an at_min of 40 seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">options ptlrpc ldlm_enqueue_min=250</span><br><span class="line"></span><br><span class="line"><span class="comment"># readonly mount</span></span><br><span class="line">$ mount.lfs <span class="variable">$zpool</span> /ost0 -o rdonly_dev</span><br></pre></td></tr></table></figure><p><a href="http://wiki.lfs.org/Lustre_Resiliency:_Understanding_Lustre_Message_Loss_and_Tuning_for_Resiliency#Tuning_Lustre_for_Resiliency">Understanding Lustre Message Loss and Tuning for Resiliency</a></p><a id="more"></a><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#reports the amount of space this client has reserved for writeback cache with each OST</span></span><br><span class="line">$ lctl get_param osc.*.cur_grant_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment">#limit ldlm threads, ldlm threads will exhaust all CPUs resources like LU-7330</span></span><br><span class="line">options ptlrpc <span class="attribute">ldlm_num_threads</span>=16</span><br><span class="line"></span><br><span class="line"><span class="comment"># Flush all of the metadata client (mdc) locks on this node</span></span><br><span class="line">$ lctl set_param ldlm.namespaces.*mdc*.<span class="attribute">lru_size</span>=clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># setstripe</span></span><br><span class="line">$ lfs setstripe -S 4000M -c 50 /mnt/striped</span><br><span class="line"></span><br><span class="line"><span class="comment">#Monitor</span></span><br><span class="line">$ lctl get_param  obdfilter.*OST0000*.stats</span><br><span class="line"></span><br><span class="line"><span class="comment"># re-compile the lfs 2.13.0 client, you must import openmpi PATH</span></span><br><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">PATH</span>=/usr/lib64/openmpi/bin/:$PATH</span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span> you can delele all openmpi <span class="builtin-name">info</span> <span class="keyword">from</span> lustre.spec, <span class="keyword">and</span> you could got these rpms</span><br><span class="line"></span><br><span class="line">$ rpmbuild --rebuild --without servers  lfs-2.10.3-1.src.rpm</span><br><span class="line">$ rpmbuild  --rebuild --without servers --with lnet-dlc  lfs-2.10.3-1.src.rpm</span><br><span class="line">$ rpmbuild --rebuild --without lfs-tests lfs-2.10.3-1.src.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># centos 7.7</span></span><br><span class="line"><span class="comment"># /root/rpmbuild/BUILD/lustre-2.10.8/lnet/klnds/o2iblnd/o2iblnd.h:69:27: fatal error: linux/pci-dma.h: No such file or directory</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy the file from the old kernel</span></span><br><span class="line">copy /usr/src/kernels/<span class="variable">$&#123;the old version kernel&#125;</span>/include/linux/pci-dma.h /usr/src/kernels/<span class="variable">$&#123;the centos 7.7 kernel&#125;</span>/include/linux/pci-dma.h</span><br><span class="line"></span><br><span class="line"><span class="comment"># New stupid bug when you compile lfs 2.10.3-1, if you are not export $PATH with openmpi, the compile will failed.</span></span><br><span class="line"><span class="keyword">If</span> you want it pass, I was clear /tmp/tmp.* rpmbuild <span class="keyword">not</span> help I guess maybe the old<span class="built_in"> config </span><span class="keyword">in</span> some tmpfs path.</span><br><span class="line">after you reboot <span class="keyword">and</span> re-<span class="builtin-name">export</span> the env, the compile will be successful.</span><br><span class="line"><span class="comment">#Is real the realease production ? `too stupid` bug. just waste my time to type these words.</span></span><br><span class="line">There is <span class="literal">no</span> test team <span class="keyword">in</span> lfs develop team, All<span class="built_in"> users </span>was the test team except you are going <span class="keyword">to</span> buy DDN.</span><br><span class="line"></span><br><span class="line"><span class="comment"># from source</span></span><br><span class="line">$ ./configure --enable-client --disable-server <span class="attribute">--with-linux</span>=/usr/src/kernels/$(uname -r);make rpms/deps</span><br><span class="line"><span class="comment">## install in ubuntu 18.04</span></span><br><span class="line">$ apt install uuid-dev libblkid-dev dietlibc-dev</span><br><span class="line">$ apt install build-essential debhelper devscripts fakeroot kernel-wedge libudev-dev pciutils-dev</span><br><span class="line">$ apt install module-assistant libreadline-dev dpatch libsnmp-dev quilt</span><br><span class="line">$ apt install linux-headers-$(uname -r)</span><br><span class="line">$ cd <span class="variable">$&#123;BUILDPATH&#125;</span>/lfs-release</span><br><span class="line">$ git reset --hard &amp;&amp; git clean -dfx</span><br><span class="line">$ sh autogen.sh</span><br><span class="line">$ ./configure --disable-server <span class="attribute">--with-linux</span>=/usr/src/linux-headers-4.15.0-64-generic</span><br><span class="line">$ make install</span><br><span class="line">$ rm -rf  /lib/modules/4.15.0-64-generic/kernel/drivers/staging/lfs/</span><br><span class="line">$ depmod -a</span><br><span class="line"></span><br><span class="line"><span class="comment">### set lfs client for a lot metadata ops</span></span><br><span class="line"><span class="comment">#restricting the number of locks kept on the client (10000 locks, 10 minutes age)</span></span><br><span class="line">$ lctl set_param ldlm.namespaces.*.<span class="attribute">lru_size</span>=10000 ldlm.namespaces.*.<span class="attribute">lru_max_age</span>=600000</span><br><span class="line"></span><br><span class="line"><span class="comment"># check object server status</span></span><br><span class="line">client $ lfs osts</span><br><span class="line">client $ cat /proc/fs/lfs/lov/<span class="variable">$fsname</span>-clilov-fffff882037467800/target_obd</span><br><span class="line">mds    $ cat /proc/fs/lfs/lov/<span class="variable">$fsname</span>-MDT0000-mdtlov/target_obd</span><br><span class="line">client $ lctl get_param osc.*-OST*.active</span><br><span class="line"></span><br><span class="line"><span class="comment"># check object server status in my production env</span></span><br><span class="line">$ (lfs osts | awk -F <span class="string">&#x27;[ :_]+&#x27;</span> <span class="string">&#x27;$0~/OST/&#123;print $2&#125;&#x27;</span> | <span class="keyword">while</span> read line; <span class="keyword">do</span> grep <span class="string">&quot;FULL&quot;</span> /proc/fs/lfs/osc/<span class="variable">$&#123;line&#125;</span>-*/state &gt;/dev/<span class="literal">null</span> 2&gt;&amp;1 || echo -e <span class="string">&quot;Got these bad OSTs:&quot;</span> <span class="variable">$&#123;RED&#125;</span><span class="variable">$line</span><span class="variable">$&#123;NC&#125;</span> ; done) &amp;&amp; exit 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># show ost ip  addr</span></span><br><span class="line">$ lctl dl -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># list nids</span></span><br><span class="line">$ lctl lst_nids</span><br><span class="line">$ lctl which_nid <span class="variable">$your_ipaddr</span>@tcp</span><br><span class="line">$ lctl<span class="built_in"> ping </span><span class="variable">$your_ipaddr</span>@tcp </span><br><span class="line"></span><br><span class="line"><span class="comment"># mount namespace &quot;D&quot; and clear mds info from client</span></span><br><span class="line">client $ echo 0 &gt; cat /sys/fs/lfs/mdc/<span class="variable">$FNAME</span>-*/active</span><br><span class="line">client $ lctl set_param mdc.<span class="variable">$FNAME</span>-*.<span class="attribute">active</span>=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># lustre rpc</span></span><br><span class="line">$ lctl get_param mdc.*.max_rpcs_in_flight</span><br><span class="line">mdc.test0-MDT0000-mdc-ffff95067b45a000.<span class="attribute">max_rpcs_in_flight</span>=8</span><br><span class="line">$ lctl set_param mdc.*.<span class="attribute">max_rpcs_in_flight</span>=16</span><br><span class="line">mdc.test0-MDT0000-mdc-ffff95067b45a000.<span class="attribute">max_rpcs_in_flight</span>=16</span><br><span class="line">$ cat /sys/module/mdt/parameters/max_mod_rpcs_per_client</span><br><span class="line"></span><br><span class="line"><span class="comment">#In lfs 2.13</span></span><br><span class="line"><span class="comment">#direct IO could reach high 120k, but the buffered IO only 4k. there are read </span></span><br><span class="line"><span class="comment">#When I disable</span></span><br><span class="line">echo 0 &gt; /sys/fs/lustre/llite/lfs-ffff9455c0a4b800/read_ahead_async_file_threshold_mb</span><br><span class="line"><span class="comment">#I could got the high IOPS too.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># client max read ahead size</span></span><br><span class="line">cat /sys/kernel/debug/lustre/llite/lfs-ffff91b225941800/max_read_ahead_mb</span><br><span class="line">64</span><br><span class="line"></span><br><span class="line"><span class="comment"># mds</span></span><br><span class="line">$ cat /sys/module/mdt/parameters/max_mod_rpcs_per_client</span><br><span class="line">8</span><br><span class="line">$ echo 16 &gt; /sys/module/mdt/parameters/max_mod_rpcs_per_client</span><br><span class="line"></span><br><span class="line"><span class="comment"># oss, lfs is extended to support RPCs up to 16MB in size</span></span><br><span class="line">$ lctl get_param obdfilter.test0-OST*.brw_size</span><br><span class="line">obdfilter.test0-OST0000.<span class="attribute">brw_size</span>=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># The parameter brw_size is used on the OST to tell the client the maximum (preferred) IO size. All clients that talk to this target should never send an RPC greater than this size. Clients can individually set a smaller RPC size limit via the osc.*.max_pages_per_rpc tunable.</span></span><br><span class="line"><span class="comment"># The smallest brw_size that can be set for ZFS OSTs is the recordsize of that dataset. This ensures that the client can always write a full ZFS file block if it has enough dirty data, and does not otherwise force it to do read- modify-write operations for every RPC. </span></span><br><span class="line">$ lctl set_param obdfilter.fsname-OST*.<span class="attribute">brw_size</span>=16</span><br></pre></td></tr></table></figure><h3 id="metadata-server"><a href="#metadata-server" class="headerlink" title="metadata server"></a>metadata server</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># Get <span class="keyword">all</span> client info from mds</span><br><span class="line"><span class="symbol">$</span> cat /proc/fs/lfs/nodemap/default/exports</span><br><span class="line"></span><br><span class="line"># <span class="keyword">No</span> root squash</span><br><span class="line">mds <span class="symbol">$</span> lctl set_param <span class="symbol">$</span>fsname.mdt.root_squash=<span class="number">108</span>:<span class="number">108</span></span><br><span class="line">error: set_param: param_path <span class="string">&#x27;$fsname/mdt/root_squash&#x27;</span>: <span class="keyword">No</span> such <span class="keyword">file</span> <span class="keyword">or</span> directory</span><br><span class="line">mds <span class="symbol">$</span> lctl conf_param <span class="symbol">$</span>fsname.mdt.root_squash=<span class="number">108</span>:<span class="number">108</span></span><br><span class="line">mds <span class="symbol">$</span> lctl conf_param <span class="symbol">$</span>fsname.mdt.nosquash_nids=<span class="string">&quot;ip.ip.ip.ip@tcp ip1.ip1.ip1.ip@tcp&quot;</span></span><br><span class="line">mds <span class="symbol">$</span> cat /proc/fs/lf/mdt/<span class="symbol">$</span>FNAME-MDT0000/nosquash_nids</span><br><span class="line">ip.ip.ip.ip@tcp ip1.ip1.ip1.ip@tcp</span><br><span class="line"></span><br><span class="line">client <span class="symbol">$</span> lctl set_param llite.<span class="symbol">$</span>FNAME-*.nosquash_nids=<span class="string">&quot;ip.ip.ip.ip@tcp ip1.ip1.ip1.ip@tcp&quot;</span></span><br><span class="line"></span><br><span class="line"># MDS to totally avoid new object creation on that OST</span><br><span class="line"><span class="symbol">$</span> lctl set_param osp.<span class="symbol">$</span>FNAME-OST00XX.max_create_count=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">#degrade will only prefer to skip the OST</span><br><span class="line"><span class="symbol">$</span> lctl set_param obdfilter.<span class="symbol">$</span>FNAME-OST00XX.degraded=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">$</span> lctl set_param -P timeout=<span class="number">300</span></span><br><span class="line"><span class="symbol">$</span> lctl set_param timeout=<span class="number">300</span> </span><br><span class="line"># <span class="keyword">if</span> you want it work ,you have <span class="keyword">set</span> it <span class="comment">twice...</span></span><br><span class="line"></span><br><span class="line"># Monitor <span class="comment">status</span></span><br><span class="line">$ cat /proc/<span class="comment">fs</span>/lfs/<span class="comment">mdc</span>/$&#123;fname&#125;-MDT0000-mdc-ffff88091eff0800/<span class="comment">state</span> </span><br><span class="line">$ lctl <span class="comment">get_param mdc.$fname-MDT*.state</span></span><br><span class="line">$ lctl <span class="comment">get_param mdc.$fname-MDT0000-mdc-*.rpc_stats</span></span><br><span class="line"></span><br><span class="line">$ watch <span class="comment">-d lctl get_param mdt.*.md_stats</span></span><br><span class="line">snapshot_time             <span class="comment">1556726087.189561170 secs.nsecs</span></span><br><span class="line">open                      <span class="comment">3412130101 samples [reqs]</span></span><br><span class="line">close                     <span class="comment">2926922120 samples [reqs]</span></span><br><span class="line">mknod                     <span class="comment">293730475 samples [reqs]</span></span><br><span class="line">link                      <span class="comment">20713305 samples [reqs]</span></span><br><span class="line">unlink                    <span class="comment">316042257 samples [reqs]</span></span><br><span class="line">mkdir                     <span class="comment">3275032 samples [reqs]</span></span><br><span class="line">rmdir                     <span class="comment">2731821 samples [reqs]</span></span><br><span class="line">rename                    <span class="comment">7687699 samples [reqs]</span></span><br><span class="line">getattr                   <span class="comment">2060900881 samples [reqs]</span></span><br><span class="line">setattr                   <span class="comment">320658776 samples [reqs]</span></span><br><span class="line">getxattr                  <span class="comment">1080139037 samples [reqs]</span></span><br><span class="line">setxattr                  <span class="comment">222105 samples [reqs]</span></span><br><span class="line">statfs                    <span class="comment">11587278 samples [reqs]</span></span><br><span class="line">sync                      <span class="comment">20670980 samples [reqs]</span></span><br><span class="line">samedir_rename            <span class="comment">7199107 samples [reqs]</span></span><br><span class="line">crossdir_rename           <span class="comment">488592 samples [reqs]</span></span><br></pre></td></tr></table></figure><h3 id="object-server"><a href="#object-server" class="headerlink" title="object server"></a>object server</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># osd_sync_destroy_max_size &quot;Maximum object size to use synchronous destroy</span></span><br><span class="line"><span class="string">options</span> <span class="string">osd_zfs</span> <span class="string">osd_sync_destroy_max_size=1048576</span></span><br><span class="line"></span><br><span class="line"><span class="string">options</span> <span class="string">ost</span> <span class="string">oss_num_threads=0</span></span><br><span class="line"><span class="comment"># you can limit the server performance by num_threads </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#limit ost io threads</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">set_param</span> <span class="string">ost.OSS.ost_io.threads_max=128</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">set_param</span> <span class="string">-P</span> <span class="string">ost.OSS.ost_io.threads_max=128</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpc info</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/proc/fs/lfs/osc/lfs-OST0000-osc-ffff88103a993000/import</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get status</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">osc.*OST0000*.&#123;state,timeouts&#125;</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">at_*</span> <span class="string">timeout</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">llite.*$FNAME*.stats</span></span><br><span class="line"><span class="comment">### clear stats, lctl set_param llite.*.stats=c</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">obdfilter.*OST005e*.brw_stats</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Read and print the last_rcvd file from a device</span></span><br><span class="line"><span class="comment">#display client information</span></span><br><span class="line"><span class="string">$</span> <span class="string">lr_reader</span> <span class="string">-c</span> <span class="string">/dev/sdh</span></span><br><span class="line"><span class="attr">last_rcvd:</span></span><br><span class="line"><span class="attr">uuid:</span> <span class="string">fsms-MDT0000_UUID</span></span><br><span class="line"> <span class="attr">feature_compat:</span> <span class="number">0x8</span></span><br><span class="line"> <span class="attr">feature_incompat:</span> <span class="number">0x61c</span></span><br><span class="line"> <span class="attr">feature_rocompat:</span> <span class="number">0x1</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">4294967298</span></span><br><span class="line"> <span class="attr">target_index:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">mount_count:</span> <span class="number">1</span></span><br><span class="line"> <span class="attr">client_area_start:</span> <span class="number">8192</span></span><br><span class="line"> <span class="attr">client_area_size:</span> <span class="number">128</span></span><br><span class="line"> <span class="attr">79136f3b-7d85-e265-37aa-dbb40ec5a30c:</span></span><br><span class="line"> <span class="attr">generation:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_xid:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_result:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_data:</span> <span class="number">0</span></span><br><span class="line"><span class="comment">#display reply data information</span></span><br><span class="line"><span class="string">$</span> <span class="string">lr_reader</span> <span class="string">-r</span> <span class="string">/dev/sdh</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">reply_data:</span></span><br><span class="line"> <span class="attr">0:</span></span><br><span class="line"> <span class="attr">client_generation:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">4426736549</span></span><br><span class="line"> <span class="attr">last_xid:</span> <span class="number">1511845291497772</span></span><br><span class="line"> <span class="attr">last_result:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_data:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">1:</span></span><br><span class="line"> <span class="attr">client_generation:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">last_transaction:</span> <span class="number">4426736566</span></span><br><span class="line"> <span class="attr">last_xid:</span> <span class="number">1511845291498048</span></span><br><span class="line"> <span class="attr">last_result:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">last_data:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># disable ost cache</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">osd-ldiskfs.*.read_cache_enable</span></span><br><span class="line"><span class="string">$</span> <span class="string">lctl</span> <span class="string">get_param</span> <span class="string">ldlm.namespaces.*.lru_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make sure ost mount parameters and flag</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/proc/fs/ldiskfs/dm-xx/options</span></span><br><span class="line"><span class="string">rw</span></span><br><span class="line"><span class="string">barrier</span></span><br><span class="line"><span class="string">no_mbcache</span></span><br><span class="line"><span class="string">user_xattr</span></span><br><span class="line"><span class="string">acl</span></span><br><span class="line"><span class="string">resuid=0</span></span><br><span class="line"><span class="string">resgid=0</span></span><br><span class="line"><span class="string">errors=remount-ro</span></span><br><span class="line"><span class="string">commit=5</span></span><br><span class="line"><span class="string">min_batch_time=0</span></span><br><span class="line"><span class="string">max_batch_time=15000</span></span><br><span class="line"><span class="string">stripe=0</span></span><br><span class="line"><span class="string">data=ordered</span></span><br><span class="line"><span class="string">inode_readahead_blks=32</span></span><br><span class="line"><span class="string">init_itable=10</span></span><br><span class="line"><span class="string">max_dir_size_kb=0</span></span><br></pre></td></tr></table></figure><h3 id="net"><a href="#net" class="headerlink" title="net"></a>net</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">options lnet <span class="attribute">networks</span>=<span class="string">&quot;tcp0(myri10ge),tcp1(eth0)&quot;</span></span><br><span class="line">lctl</span><br><span class="line">lctl &gt;<span class="built_in"> network </span>tcp1</span><br><span class="line">lctl &gt; peer_list</span><br><span class="line">12345-xx.xx.xx.xx@tcp [0]0.0.0.0-&gt;0.0.0.0:0 #0</span><br></pre></td></tr></table></figure><p>I think in some the bad network quality env, you must improve them</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Peer Credits</span></span><br><span class="line"><span class="comment">#Governs the number of concurrent sends to a single peer, End-to-end flow control accomplished at higher layer. e.g. max_rpcs_in_flight</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/sys/lnet/peers </span><br><span class="line">nid                      refs state  last   max   rtr   min    tx   min queue </span><br><span class="line">xx.xx.xx.xx@o2ib            3    up    -1   126   126   126   126   110 0</span><br><span class="line">tx is the number of peer credits currently available <span class="keyword">for</span> this peer</span><br><span class="line">min is the smallest number of peer credits seen </span><br><span class="line">Negative credit count indicates the number of messages awaiting a credit</span><br><span class="line"></span><br><span class="line"><span class="comment">#Network Interface Credits</span></span><br><span class="line">$ cat /proc/sys/lnet/nis</span><br><span class="line">nid                      status alive refs peer  rtr   max    tx   min </span><br><span class="line">xx.xx.xx.xx@o2ib              up    -1    9  126    0  2048  2048  1796 </span><br><span class="line">max is total available (i.e. value of ko2iblnd credits) </span><br><span class="line">tx is the number currently available, Negative number indicates number of messages awaiting a credit</span><br><span class="line">min is the low water mark</span><br><span class="line"></span><br><span class="line"><span class="comment">#Lctl conn_listList active TCP connections, type (bulk/control), tx_buffer_size, rx_buffer_size</span></span><br><span class="line">$ lctl --net tcp conn_list</span><br><span class="line"></span><br><span class="line">chmod a+w /sys/module/ksocklnd/parameters/peer_timeout /sys/module/ksocklnd/parameters/peer_credits /sys/module/ksocklnd/parameters/credits</span><br><span class="line"><span class="built_in">echo</span> 1024 &gt; /sys/module/ksocklnd/parameters/credits</span><br><span class="line"><span class="comment"># the number of concurrent sends (to all peers), defaults:64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 128 &gt; /sys/module/ksocklnd/parameters/peer_timeout</span><br><span class="line">peer_buffer_credits=256</span><br><span class="line">concurrent_sends=256 - send work-queue sizing</span><br><span class="line"><span class="comment"># not test</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 128 &gt; /sys/module/ksocklnd/parameters/peer_credits</span><br><span class="line">the number of concurrent sends to a single peer, <span class="comment">#default:8</span></span><br><span class="line"></span><br><span class="line">chmod a+w /sys/module/lnet/parameters/accept_backlog  /sys/module/lnet/parameters/accept_timeout</span><br><span class="line"><span class="built_in">echo</span> 128 &gt; /sys/module/lnet/parameters/accept_timeout</span><br><span class="line"><span class="built_in">echo</span> 2000 &gt; /sys/module/lnet/parameters/accept_backlog</span><br><span class="line"></span><br><span class="line">options lnet accept_backlog=2000</span><br><span class="line"><span class="comment">## Acceptor&#x27;s listen backlog, the number of the connections the server instance can buffer in the wait queue.</span></span><br><span class="line">options lnet accept_timeout=128</span><br><span class="line"><span class="comment">## Specifies the number of seconds the server waits for data to arrive from the client. If data does not arrive before the timeout expires then the connection is closed. By setting it to less than the default 30 seconds, you can free up threads sooner. However, you may also disconnect users with slower connections.</span></span><br><span class="line">k</span><br><span class="line"></span><br><span class="line">$ lctl get_param osc.*.max_pages_per_rpc</span><br><span class="line">$ lctl set_param osc.*.max_pages_per_rpc=1024 <span class="comment"># 1024 = 1024*4KB =4MB per RPC</span></span><br><span class="line"><span class="comment">#Max RPCS in flight between OSC and OST</span></span><br><span class="line">$ lctl set_param -P <span class="variable">$FNAME</span>.osc.max_pages_per_rpc=1024</span><br><span class="line"></span><br><span class="line">$ lctl set_param osc.*.max_rpcs_in_flight=64;</span><br><span class="line"><span class="comment"># Max number of 4K pages per RPC</span></span><br><span class="line"><span class="comment"># Increase for small IO or long fast network paths (high BDP), May want to decrease to preempt TCP congestion</span></span><br><span class="line"></span><br><span class="line">256 = 1MB per RPC</span><br><span class="line"><span class="comment"># max_pages_per_rpc*4*max_rpcs_in_flight*2=max_dirty_mb</span></span><br><span class="line">1024*4KB/1024(KB to MB)*64*2=512</span><br><span class="line">lctl set_param osc.*.max_dirty_mb=512</span><br><span class="line"><span class="comment"># Maximum MBs of dirty data that can be written and queued on a client</span></span><br><span class="line"></span><br><span class="line">Set per OST or each clients</span><br><span class="line">256*4/1024*64*2=128</span><br><span class="line">lctl set_param osc.*.max_pages_per_rpc=256; lctl set_param osc.*.max_rpcs_in_flight=64;lctl set_param osc.*.max_dirty_mb=128</span><br><span class="line"></span><br><span class="line">$ modinfo mdt | grep max_mod_rpcs_per_client</span><br><span class="line">parm:           max_mod_rpcs_per_client:maximum number of modify RPCs <span class="keyword">in</span> flight allowed per client (uint)</span><br><span class="line"></span><br><span class="line">mds $ <span class="built_in">echo</span> 16 &gt; /sys/module/mdt/parameters/max_mod_rpcs_per_client</span><br><span class="line"></span><br><span class="line"><span class="comment"># config</span></span><br><span class="line">lctl network up/down</span><br><span class="line">lctl list_nids</span><br><span class="line">lctl ping xxxxx@tcp</span><br><span class="line">lctl network unconfigure</span><br><span class="line"><span class="comment">### from lfs 2.7</span></span><br><span class="line">lnetctl lnet configure/unconfigure</span><br><span class="line">lnetctl net show -v</span><br><span class="line">lnetctl peer show -v</span><br><span class="line">lnetctl net add --net LNET --<span class="keyword">if</span> eth0</span><br><span class="line">lnetctl net del --net LNET</span><br><span class="line">// To <span class="built_in">export</span> the current configuration to a YAML file</span><br><span class="line">lnetctl <span class="built_in">export</span> FILE.yaml</span><br><span class="line">lnetctl <span class="built_in">export</span> &gt; FILE.yaml</span><br><span class="line">// To import the configuration from a YAML file</span><br><span class="line">lnetctl import FILE.yaml</span><br><span class="line">lnetctl import &lt; FILE.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment">### Lnet multiple-plane</span></span><br><span class="line">options lnet networks=<span class="string">&quot;tcp1(eth1),tcp2(eth2),o2ib0(ib0)&quot;</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">options lnet ip2nets=<span class="string">&quot;tcp1(eth0) 192.168.0.[2,4] \</span></span><br><span class="line"><span class="string"> tcp1 192.168.0.*; o2ib1 132.6.[1-3],[2-8/2]&quot;</span></span><br><span class="line"><span class="comment">### [2-8/2] means 2,4,6,8</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Trace-log"><a href="#Trace-log" class="headerlink" title="Trace log"></a>Trace log</h3><h4 id="lfs-log"><a href="#lfs-log" class="headerlink" title="lfs log"></a>lfs log</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># F_SETPIPE_SZ F_GETPIPE_SZ</span></span><br><span class="line"><span class="comment"># echo 104857600 &gt; /proc/sys/fs/pipe-max-size</span></span><br><span class="line"><span class="comment"># fs.pipe-max-size=104857600</span></span><br><span class="line"><span class="comment"># ulimit pipe size            (512 bytes, -p) 8 = 4096 bytes, it &#x27;s pipe buffer size in the ulimit, not pipe size</span></span><br><span class="line"><span class="comment">## POSIX.1-2001 says that write(2)s of less than PIPE_BUF  bytes  must  be atomic:  the  output  data  is  written  to  the  pipe  as a contiguous sequence.  Writes of more than PIPE_BUF bytes may  be  non-atomic:  the kernel  may  interleave the data with data written by other processes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here 2 tools for pipe</span></span><br><span class="line"><span class="comment"># pv - Pipe Viewer - is a terminal-based tool for monitoring the progress of data through a pipeline.</span></span><br><span class="line"><span class="comment"># process1 | pv -pterbTCB 1G | process2</span></span><br><span class="line"></span><br><span class="line">$ pv -cN sources linux-image-unsigned-4.15.0-65-generic-dbgsym_4.15.0-65.74_amd64.ddeb | dd of=/tmp/tmp bs=512 | pv -cN cat</span><br><span class="line">      cat: 0.00 B 0:00:00 [0.00 B/s] [&lt;=&gt;                                                                                                                                                                                                    ]</span><br><span class="line">  sources:  751MiB 0:00:03 [ 191MiB/s] [===================================================================================================================================================================================&gt;] 100%            </span><br><span class="line">1538323+1 records <span class="keyword">in</span></span><br><span class="line">1538323+1 records out</span><br><span class="line">787621648 bytes (788 MB, 751 MiB) copied, 3.92424 s, 201 MB/s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ mkfifo -m 777 /tmp/lfs.log</span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ trace-cmd record -p <span class="keyword">function</span> mount <span class="variable">$ipaddr</span>@tcp:/lfs /mnt</span><br><span class="line"><span class="comment"># it &#x27;ll create trace.dat</span></span><br><span class="line">$ trace-cmd report</span><br></pre></td></tr></table></figure><h4 id="kdump"><a href="#kdump" class="headerlink" title="kdump"></a>kdump</h4><p>yum -y install kexec-tools<br>cat /etc/kdump.conf<br>nfs my.nfsserver.example.org:/path/to/expor<br>core_collector makedumpfile -d 16 -c<br>#-c Compress dump data by each page<br>#core_collector makedumpfile -d 16 -c message_level 16</p><h1 id="1-Zero-Pages-2-Cache-Pages-4-Cache-Private-8-User-Pages-16-Free-Pages"><a href="#1-Zero-Pages-2-Cache-Pages-4-Cache-Private-8-User-Pages-16-Free-Pages" class="headerlink" title="1 Zero Pages 2 Cache Pages 4 Cache Private 8 User Pages 16 Free Pages"></a>1 Zero Pages 2 Cache Pages 4 Cache Private 8 User Pages 16 Free Pages</h1><h1 id="1-Progress-Indicators-2-Common-Messages-4-Error-Messages-8-Debug-Messages-16-Report-Messages"><a href="#1-Progress-Indicators-2-Common-Messages-4-Error-Messages-8-Debug-Messages-16-Report-Messages" class="headerlink" title="1 Progress Indicators 2 Common Messages 4 Error Messages 8 Debug Messages 16 Report Messages"></a>1 Progress Indicators 2 Common Messages 4 Error Messages 8 Debug Messages 16 Report Messages</h1><p>#ssh <a href="mailto:&#x75;&#115;&#x65;&#114;&#64;&#x6d;&#121;&#46;&#x73;&#101;&#114;&#x76;&#101;&#114;&#x2e;&#101;&#120;&#97;&#x6d;&#112;&#x6c;&#x65;&#46;&#111;&#114;&#x67;">&#x75;&#115;&#x65;&#114;&#64;&#x6d;&#121;&#46;&#x73;&#101;&#114;&#x76;&#101;&#114;&#x2e;&#101;&#120;&#97;&#x6d;&#112;&#x6c;&#x65;&#46;&#111;&#114;&#x67;</a>:/dest/path<br>#By default, uses ssh key at /root/.ssh/kdump_id_rsa<br>#core_collector makedumpfile <options></p><h3 id="changelog"><a href="#changelog" class="headerlink" title="changelog"></a>changelog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* MARK  Internal record keeping</span><br><span class="line">* CREAT  Regular file creation</span><br><span class="line">* MKDIR  Directory creation</span><br><span class="line">* HLINK  Hard link</span><br><span class="line">* SLINK  Soft link</span><br><span class="line">* OPEN  open file</span><br><span class="line">* CLOSE  close file</span><br><span class="line">* MKNOD  Other file creation</span><br><span class="line">* UNLNK  Regular file removal</span><br><span class="line">* RMDIR  Directory removal</span><br><span class="line">* RNMFM  Rename, original</span><br><span class="line">* RNMTO  Rename, final</span><br><span class="line">* IOCTL  ioctl on file or directory</span><br><span class="line">* TRUNC  Regular file truncated</span><br><span class="line">* SATTR  Attribute change</span><br><span class="line">* XATTR  Extended Attribute change</span><br><span class="line">* HSM  HSM action</span><br><span class="line">* UNKNW  Unkown operation</span><br></pre></td></tr></table></figure><h4 id="Enable"><a href="#Enable" class="headerlink" title="Enable"></a>Enable</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ lctl set_param mdt.$FNAME-MDT000<span class="number">0</span>.hsm_control=enabled</span><br><span class="line">$ lctl set_param -P  mdt.$FNAME-MDT000<span class="number">0</span>.hsm_control=enabled</span><br><span class="line">$ lctl set_param mdt.$FNAME-MDT000<span class="number">0</span>.hsm.max_requests=<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create user</span></span><br><span class="line">$ lctl --device $FNAME-MDT000<span class="number">0</span> changelog_register</span><br><span class="line"><span class="comment"># del user</span></span><br><span class="line">$ lctl --device fsname-MDT000<span class="number">0</span> changelog_deregister cl1</span><br><span class="line"><span class="comment"># Get the size</span></span><br><span class="line">$ lctl get_param mdd.$FNAME-MDT000<span class="number">0</span>.changelog_users mdd.$FNAME-MDT000<span class="number">0</span>.changelog_size</span><br><span class="line"></span><br><span class="line"><span class="comment"># changelog mask</span></span><br><span class="line">$ lctl set_param mdd.$FNAME-MDT*.changelog_mask=MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RNMFM RNMTO OPEN LYOUT TRUNC CLOSE IOCTL TRUNC SATTR XATTR HSM MTIME CTIME</span><br><span class="line">$ lctl get_param mdd.$FNAME-MDT*.changelog_mask</span><br><span class="line">MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the changelog</span></span><br><span class="line">$ lfs changelog $FNAME-MDT000<span class="number">0</span> &gt; lfs-changelog</span><br><span class="line">$ fs changelog $fsname-MDT000<span class="number">0</span> [startrec [endrec]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear all</span></span><br><span class="line">$ lctl changelog_clear mdt_name userid endrec</span><br><span class="line"><span class="string">``</span><span class="string">``</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Disable </span></span><br></pre></td></tr></table></figure><p>#Notify a device that user cl1 no longer needs records (up toand including 3)<br>$ lfs changelog_clear $FNAME-MDT0000 cl1 3</p><p>#To stop changelogs, changelog_mask should be set to MARK only<br>$ lctl set_param mdd.$FNAME-MDT0000.changelog_mask=MARK<br>mdd.lfs-MDT0000.changelog_mask=MARK</p><p>#or youcan set it -all<br>$ lctl set_param mdd.$FNAME-MDT0000.changelog_mask=-all</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### FSCK</span><br><span class="line">```bash</span><br><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: LDISKFS-fs error (device sdz): ldiskfs_lookup: unlinked inode <span class="number">5384166</span> <span class="keyword">in</span> dir #<span class="number">145170469</span></span><br><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: Remounting filesystem read-only</span><br></pre></td></tr></table></figure><h4 id="Flush-the-journal"><a href="#Flush-the-journal" class="headerlink" title="Flush the journal"></a>Flush the journal</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ umount /lfs</span><br><span class="line">$ mount -t ldiskfs /dev/sdx /lfs</span><br><span class="line">$ umount /lfs</span><br></pre></td></tr></table></figure><ul><li><p>Ensure e2fsprogs version ,it s not default linux version ,it s lfs version</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep e2fsprogs</span><br><span class="line">e2fsprogs-1.42.12.wc1-7.el6.x86_64</span><br><span class="line">e2fsprogs-libs-1.42.12.wc1-7.el6.x86_64</span><br></pre></td></tr></table></figure></li><li><p>Before fsckmake sure the mount point has been <font color=red>umount</font></p></li><li><p>Can check multiple MDT/OSTs in parallel</p></li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check only mode</span></span><br><span class="line">$ e2fsck -fn <span class="regexp">/dev/</span>sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prudent mode</span></span><br><span class="line">$ e2fsck -fp <span class="regexp">/dev/</span>sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Answer yes</span></span><br><span class="line">$ e2fsck -fy <span class="regexp">/dev/</span>sdx</span><br></pre></td></tr></table></figure><h4 id="re-writeconf"><a href="#re-writeconf" class="headerlink" title="re-writeconf"></a>re-writeconf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mds$ tunefs.lfs --writeconf /dev/sdx</span><br><span class="line">oss$ tunefs.lfs --writeconf /dev/ost0</span><br></pre></td></tr></table></figure><p>If MGS and MDT in single block device, you can add -o nosvc to avoid mount MDT</p><h3 id="User-group-quota"><a href="#User-group-quota" class="headerlink" title="User group quota"></a>User group quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## you can &#x27;t use lctl set_param, it &#x27;s not work</span></span><br><span class="line"></span><br><span class="line">mds $ lctl conf_param <span class="variable">$FNAME</span>.quota.mdt=ug</span><br><span class="line">mds $ cat /proc/fs/lfs/osd-ldiskfs/<span class="variable">$FNAME</span>-MDT0000/quota_slave/info</span><br><span class="line">mds $ lctl get_param osd-*.*.quota_slave.info</span><br><span class="line">quota enabled:  <span class="string">&quot;ug&quot;</span></span><br><span class="line">mds $ lctl conf_param <span class="variable">$FNAME</span>.quota.ost=ug</span><br><span class="line"></span><br><span class="line"><span class="comment">### lctl set_param -P must reboot, no -P not work, if you don&#x27; t reboot ,you have too use conf_param</span></span><br><span class="line"></span><br><span class="line">client $ lfs setquota -u user1 -b 307200 -B 309200 -i 10000 -I 11000 /mnt/lfs</span><br><span class="line">client $ lfs setquota -g group1 -b 5120000 -B 5150000 -i 100000 -I 101000 /mnt/lfs</span><br><span class="line"></span><br><span class="line">client $ lfs quota u user1 -v /mnt/lfs</span><br><span class="line">client $ lfs quota -t -p /mnt/lfs</span><br><span class="line">Block grace time: 1w; Inode grace time: 1w</span><br></pre></td></tr></table></figure><h3 id="Disable-the-ost"><a href="#Disable-the-ost" class="headerlink" title="Disable the ost"></a>Disable the ost</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mds $ mds lctl dl | grep osc</span><br><span class="line">8 UP osp lfs-OST0000-osc-MDT0000 lfs-MDT0000-mdtlov_UUID 5</span><br><span class="line"></span><br><span class="line">mds $ lctl --device 8 deactivate</span><br><span class="line">mds $ lctl --device 8 activate</span><br></pre></td></tr></table></figure><h3 id="Skip-recovery"><a href="#Skip-recovery" class="headerlink" title="Skip recovery"></a>Skip recovery</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mds</span> $ mds lctl dl | grep osc</span><br><span class="line"><span class="attribute">8</span> UP osp lfs-OST<span class="number">0000</span>-osc-MDT<span class="number">0000</span> lfs-MDT<span class="number">0000</span>-mdtlov_UUID <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">mds</span> $ lctl --device <span class="number">8</span> abort_recovery</span><br><span class="line"></span><br><span class="line"><span class="attribute">or</span> </span><br><span class="line"></span><br><span class="line"><span class="attribute">mount</span>.lfs xxx xxx -o abort_recov</span><br></pre></td></tr></table></figure><h3 id="lfs-migarate"><a href="#lfs-migarate" class="headerlink" title="lfs migarate"></a>lfs migarate</h3><p>Strong not recommand this command, because the command will cause loss the data, I suggest you copy data by index and checksum the copy file</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ lfs setstripe -c 1  -i 4 /lfs/dir1</span><br><span class="line">$ copy /lfs/old_dir1/file1 /lfs/dir1</span><br><span class="line">$ md5sum /lfs/old_dir1/file1 /lfs/dir1/file1</span><br><span class="line"></span><br><span class="line"><span class="comment"># dont &#x27;t use lfs migrate, it &#x27;s too dangerous, it will cause data loss</span></span><br><span class="line"><span class="comment">## lfs find /opt/lfswh -obd lfswh-OST000c_UUID -size +4G | lfs_migrate -y</span></span><br><span class="line"><span class="comment">## lfs migrate -c 1  -i 4 filepath</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### Job status</span></span><br><span class="line">```bash</span><br><span class="line">client $  lctl get_param jobid_var</span><br><span class="line">client $  jobid_var=<span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line">SLURM: jobid_var=SLURM_JOB_ID</span><br><span class="line">SGE: jobid_var=JOB_ID</span><br><span class="line">LSF: jobid_var=LSB_JOBID</span><br><span class="line">Loadleveler: jobid_var=LOADL_STEP_ID</span><br><span class="line">PBS: jobid_var=PBS_JOBID</span><br><span class="line">Maui/MOAB: jobid_var=PBS_JOBID</span><br><span class="line"><span class="comment"># Enable for sge</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=JOB_ID</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=<span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If there isn&#x27;t any job scheduler is running over the system, or user just want to collect the stats for process &amp; uid:</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=procname_uid</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check Job status</span></span><br><span class="line">oss $ lctl get_param obdfilter.testfs5-OST0004.job_stats</span><br><span class="line">job_stats:</span><br><span class="line">- job_id:          9158530</span><br><span class="line">  snapshot_time:   1503038800</span><br><span class="line">  read_bytes:      &#123; samples:           0, unit: bytes, min:       0, max:       0, sum:               0 &#125;</span><br><span class="line">  write_bytes:     &#123; samples:       32452, unit: bytes, min:  262144, max: 1048576, sum:     34009513984 &#125;</span><br><span class="line">  getattr:         &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  setattr:         &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># get mdt ops</span></span><br><span class="line">mds $ lctl get_param mdt.*.job_stats</span><br><span class="line">mds $ lctl get_param  mdt.testfs5-MDT0000.job_stats</span><br><span class="line">mdt.testfs5-MDT0000.job_stats=</span><br><span class="line">job_stats:</span><br><span class="line">- job_id:          278685</span><br><span class="line">  snapshot_time:   1503068243</span><br><span class="line">  open:            &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  close:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  mknod:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  link:            &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  unlink:          &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  mkdir:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># clear stats for all job on testfs-OST0001</span></span><br><span class="line">oss $ lctl set_param obdfilter.testfs-OST0001.job_stats=clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clear stats for job &quot;dd.0&quot; on lfs-MDT0000</span></span><br><span class="line">mds $ lctl set_param mdt.lfs-MDT0000.job_stats=dd.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># cleanup interval (seconds)</span></span><br><span class="line">lctl set_param -P testfs5.mdt.job_cleanup_interval=604800</span><br><span class="line">lctl set_param  testfs5.mdt.job_cleanup_interval=604800</span><br><span class="line">mds $  cat /proc/fs/lfs/mdt/testfs5-MDT0000/job_cleanup_interval</span><br></pre></td></tr></table></figure><h3 id="lfs-fid-and-path"><a href="#lfs-fid-and-path" class="headerlink" title="lfs fid and path"></a>lfs fid and path</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[client]<span class="comment"># lfs fid2path /mnt      [0x200000400:0x1:0x0]</span></span><br><span class="line">                                       |<span class="string">         </span>|<span class="string">   </span>|</span><br><span class="line">                                       |<span class="string">         </span>|<span class="string">   -- version</span></span><br><span class="line"><span class="string">                                       </span>|<span class="string">         ---- object id</span></span><br><span class="line"><span class="string">                                       ----------Sequence</span></span><br><span class="line"><span class="string">[client]# lfs path2fid /mnt</span></span><br><span class="line"><span class="string">[0x200000007:0x1:0x0]</span></span><br></pre></td></tr></table></figure><h3 id="increase-openzfs-sync-performance-in-test-env"><a href="#increase-openzfs-sync-performance-in-test-env" class="headerlink" title="increase openzfs sync performance in test env"></a>increase openzfs sync performance in test env</h3><p><code>this setting will cause data loss, if client roll back log failed</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lctl set_param osd-zfs.*.osd_obj_sync_delay_us=0</span><br><span class="line"></span><br><span class="line">osd_object_sync_delay_us</span><br><span class="line">To improve fsync() performance until ZIL device,it is possible <span class="built_in">disable</span> the code <span class="built_in">which</span> causes Lustre to block waiting on a TXG to sync</span><br></pre></td></tr></table></figure><h3 id="Lustre-issues"><a href="#Lustre-issues" class="headerlink" title="Lustre issues"></a>Lustre issues</h3><h4 id="Don-t-use-openzfs-with-lfs-file-system"><a href="#Don-t-use-openzfs-with-lfs-file-system" class="headerlink" title="Don t use openzfs with lfs file system"></a>Don t use openzfs with lfs file system</h4><ul><li>No bility to support openzfs</li><li>If your zpool brain split, they will not show you any help</li><li>If you enable openzfs MMP, if single HDD will broken, your zpool have to suspend once<ul><li><a href="https://github.com/zfsonlinux/zfs/issues/7045">https://github.com/zfsonlinux/zfs/issues/7045</a><ul><li><a href="https://github.com/zfsonlinux/zfs/issues/7118">https://github.com/zfsonlinux/zfs/issues/7118</a></li><li>this issue impact from zfs 0.7 to 0.7.9, I m not sure 0.8 has the same issue, the best way is disable MMP and use single link for your SAS devices</li></ul></li></ul></li></ul><h4 id="Multipath-failed-cause"><a href="#Multipath-failed-cause" class="headerlink" title="Multipath failed cause"></a>Multipath failed cause</h4><ul><li>Found error log; <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi 14:0:5:31: attempting task abort! scmd(ffff97ac51784a80)</span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi 14:0:5:31: [sg64] tag<span class="comment">#76 CDB: Read(6) 08 00 02 61 01 00</span></span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi target14:0:5: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c66c014), phy(4)</span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi target14:0:5: enclosurelogical id(0x51866da0a8a62200), slot(4)</span><br><span class="line">Sep 22 03:16:00 lfs-node21 kernel: scsi target14:0:5: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:16:01 lfs-node21 systemd: Started Session 361698 of user root.</span><br><span class="line">Sep 22 03:16:01 lfs-node21 systemd: Starting Session 361698 of user root.</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: sd 14:0:5:6: attempting task abort! scmd(ffff97b2ae507b80)</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: sd 14:0:5:6: [sdp] tag<span class="comment">#8 CDB: Write(16) 8a 00 00 00 00 07 c6 2a 89 e8 00 00 08 00 00 00</span></span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: scsi target14:0:5: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c66c014), phy(4)</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: scsi target14:0:5: enclosurelogical id(0x51866da0a8a62200), slot(4)</span><br><span class="line">Sep 22 03:16:09 lfs-node21 kernel: scsi target14:0:5: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:16:30 lfs-node21 kernel: mpt3sas_cm3: Command Timeout</span><br><span class="line">Sep 22 03:16:30 lfs-node21 kernel: mf:<span class="comment">#012#0110100000a 00000100 00000000 00001f00 00000000 00000000 00000000 00000000 #012#01100000000 00000000 00000000 00000000 0000004d</span></span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi 13:0:0:31: attempting task abort! scmd(ffff97bc6aad1c00)</span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi 13:0:0:31: [sg45] tag<span class="comment">#197 CDB: Read(6) 08 00 02 00 01 00</span></span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi target13:0:0: _scsih_tm_display_info: handle(0x0009), sas_address(0x500a098b4c6c3014), phy(0)</span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi target13:0:0: enclosurelogical id(0x51866da0a8a62100), slot(0)</span><br><span class="line">Sep 22 03:16:32 lfs-node21 kernel: scsi target13:0:0: enclosure level(0x0000), connector name( 0   )</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: sd 13:0:1:6: attempting task abort! scmd(ffff97b2ae506680)</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: sd 13:0:1:6: [sdap] tag<span class="comment">#4 CDB: Write(16) 8a 00 00 00 00 07 c5 fd 27 10 00 00 08 00 00 00</span></span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: scsi target13:0:1: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c5d9014), phy(4)</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: scsi target13:0:1: enclosurelogical id(0x51866da0a8a62100), slot(4)</span><br><span class="line">Sep 22 03:16:39 lfs-node21 kernel: scsi target13:0:1: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:16:40 lfs-node21 kernel: mpt3sas_cm3: sending diag reset !!</span><br><span class="line">Sep 22 03:16:41 lfs-node21 kernel: mpt3sas_cm3: diag reset: SUCCESS</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: IOC Number : 0</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: CurrentHostPageSize is 0: Setting default host page size to 4k</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: FW Package Version(16.17.00.03)</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: LSISAS3008: FWVersion(16.00.04.00), ChipRevision(0x02), BiosVersion(18.00.00.00)</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: Dell 12Gbps SAS HBA</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: Protocol=(Initiator,Target), Capabilities=(TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)</span><br><span class="line">Sep 22 03:16:42 lfs-node21 kernel: mpt3sas_cm3: sending port <span class="built_in">enable</span> !!</span><br><span class="line"></span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: sdbb - rdac checker reports path is down: inquiry failed</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: checker failed path 67:80 <span class="keyword">in</span> map 3600a098000b4c3060000024359244375</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: remaining active paths: 1</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 8:240: reinstated</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: sdbg: mark as failed</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c66c0000020d59243745: remaining active paths: 1</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: sdbi: mark as failed</span><br><span class="line">Sep 22 03:32:04 lfs-node21 multipathd: 3600a098000b4c66c00000213592437d2: remaining active paths: 1</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdu, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdv, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdw, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdx, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdy, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdar, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdas, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdat, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdau, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdav, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdaw, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdax, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sday, open() failed: No such device</span><br><span class="line">Sep 22 03:32:06 lfs-node21 smartd[5112]: Device: /dev/sdaz, open() failed: No such device</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: sdbb - rdac checker reports path is upa</span><br><span class="line"></span><br><span class="line"><span class="comment">### All devices single link offline at the same time, I have 4 x 9300-8E, impossible offline at the same time</span></span><br><span class="line"><span class="comment">### Filter all error devices and make sure just single HBA status not correct, and you can found mpt3sas_cm0 in the system message</span></span><br><span class="line"></span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: sdbb - rdac checker reports path is up</span><br><span class="line">Sep 22 03:32:14 lfs-node21 kernel: device-mapper: multipath: Reinstating path 67:80.</span><br><span class="line">Sep 22 03:32:14 lfs-node21 kernel: device-mapper: multipath: Reinstating path 67:160.</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 67:80: reinstated</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c3060000024359244375: remaining active paths: 2</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c0000020d59243745: sdbg - rdac checker reports path is up</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 67:160: reinstated</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c0000020d59243745: remaining active paths: 2</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c00000213592437d2: sdbi - rdac checker reports path is up</span><br><span class="line">Sep 22 03:32:14 lfs-node21 kernel: device-mapper: multipath: Reinstating path 67:192.</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 67:192: reinstated</span><br><span class="line">Sep 22 03:32:14 lfs-node21 multipathd: 3600a098000b4c66c00000213592437d2: remaining active paths: 2</span><br><span class="line"></span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi 1:0:0:31: attempting task abort! scmd(ffff97b265c7b2c0)</span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi 1:0:0:31: [sg9] tag<span class="comment">#17 CDB: Read(6) 08 00 02 00 01 00</span></span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi target1:0:0: _scsih_tm_display_info: handle(0x0009), sas_address(0x500a098b4c834014), phy(0)</span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi target1:0:0: enclosurelogical id(0x51866da09fad6700), slot(0)</span><br><span class="line">Sep 22 03:34:16 lfs-node21 kernel: scsi target1:0:0: enclosure level(0x0000), connector name( 0   )</span><br><span class="line">Sep 22 03:34:46 lfs-node21 kernel: mpt3sas_cm0: Command Timeout</span><br><span class="line">Sep 22 03:34:46 lfs-node21 kernel: mf:<span class="comment">#012#01101000009 00000100 00000000 00001f00 00000000 00000000 00000000 00000000 #012#01100000000 00000000 00000000 00000000 00000012</span></span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: sd 1:0:1:24: attempting task abort! scmd(ffff97a35d8c9500)</span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: sd 1:0:1:24: [sdk] tag<span class="comment">#42 CDB: Read(16) 88 00 00 00 00 09 1f 1d 30 00 00 00 00 08 00 00</span></span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: scsi target1:0:1: _scsih_tm_display_info: handle(0x000a), sas_address(0x500a098b4c810014), phy(4)</span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: scsi target1:0:1: enclosurelogical id(0x51866da09fad6700), slot(4)</span><br><span class="line">Sep 22 03:34:55 lfs-node21 kernel: scsi target1:0:1: enclosure level(0x0000), connector name( 1   )</span><br><span class="line">Sep 22 03:34:56 lfs-node21 kernel: mpt3sas_cm0: sending diag reset !!</span><br><span class="line">Sep 22 03:34:57 lfs-node21 kernel: mpt3sas_cm0: diag reset: SUCCESS</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: IOC Number : 0</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: CurrentHostPageSize is 0: Setting default host page size to 4k</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: FW Package Version(16.17.00.03)</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: LSISAS3008: FWVersion(16.00.04.00), ChipRevision(0x02), BiosVersion(18.00.00.00)</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: Dell 12Gbps SAS HBA</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: Protocol=(Initiator,Target), Capabilities=(TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)</span><br><span class="line">Sep 22 03:34:58 lfs-node21 kernel: mpt3sas_cm0: sending port <span class="built_in">enable</span> !!</span><br><span class="line"></span><br><span class="line"><span class="comment"># del the others</span></span><br><span class="line"></span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: port <span class="built_in">enable</span>: SUCCESS</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: handle(0x0009), sas_address(0x500a098b4c834014), port: 255</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: enclosure logical id(0x51866da09fad6700), slot(0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:1: handle(0x000a), sas_address(0x500a098b4c810014), port: 255</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:1: enclosure logical id(0x51866da09fad6700), slot(4)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: <span class="comment">#011break from _scsih_search_responding_sas_devices: ioc_status(0x0022), loginfo(0x310f0400)</span></span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> end-devices: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> PCIe end-devices: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> expanders: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: search <span class="keyword">for</span> expanders: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi 1:0:0:31: task abort: SUCCESS scmd(ffff97b265c7b2c0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: sas end-devices</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: pcie end-devices</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: expanders</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: removing unresponding devices: complete</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: mpt3sas_cm0: scan devices: start</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: sd 1:0:0:13: attempting task abort! scmd(ffff97b37ad6a4c0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: sd 1:0:0:13: [sdg] tag<span class="comment">#89 CDB: Inquiry 12 01 c9 00 30 00</span></span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: _scsih_tm_display_info: handle(0x0009), sas_address(0x500a098b4c834014), phy(0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: enclosurelogical id(0x51866da09fad6700), slot(0)</span><br><span class="line">Sep 22 03:35:05 lfs-node21 kernel: scsi target1:0:0: enclosure level(0x0000), connector name( 0   )</span><br></pre></td></tr></table></figure>Single link offline, after reset the link attch back, and try to recovery the connnection</li></ul><p>But lfs has a <a href="https://jira.whamcloud.com/browse/LU-10510">bug, LU-10510</a>, lfs will modify the value when it mount, but the designer not consider link/HBA/IO expander offline or some reason cause the value back to default value. what a pity, the operate (modify to 16383) only trigger on mount.lfs operation, the link back to recovery the connection ? no way.</p><p>It s a simple logic. Why the desiger not consider the link offline ? I can t understand. it must be an intern.<br>When the link recovery, the max_sectors_kb recovery to default value (512)<br>You have to use echo 16383 to improve it, why 16383, sorry , I don t know.<br>Does the lfs system rigorous enough ? hahahahaahaha.<br>Does is it for Enterprise file system ? hahahahahahaha.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ grep . /sys/block/*/queue/max_sectors_kb</span><br><span class="line">/sys/block/sdak/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdal/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdal/queue/max_sectors_kb 512</span><br><span class="line">/sys/block/sda/queue/max_hw_sectors_kb 256</span><br><span class="line">/sys/block/sda/queue/max_sectors_kb 256</span><br><span class="line">/sys/block/sdba/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdba/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdbb/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbb/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdbc/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbc/queue/max_sectors_kb 512</span><br><span class="line">/sys/block/sdbd/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbd/queue/max_sectors_kb 16383</span><br><span class="line">/sys/block/sdbe/queue/max_hw_sectors_kb 16383</span><br><span class="line">/sys/block/sdbe/queue/max_sectors_kb 512</span><br><span class="line">/sys/block/sdbf/queue/max_hw_sectors_kb 16383</span><br><span class="line"></span><br><span class="line">it could cause the multipath error too.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:176.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:160.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:240.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:240.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:144.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:144.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:176.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:176.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:240.</span><br><span class="line">blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">device-mapper: multipath: Failing path 65:240.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:144.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:176.</span><br><span class="line">device-mapper: multipath: Reinstating path 65:240.</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    0.02   47.92    0.00   52.06</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00    67.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdc               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdi               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdf               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdd               0.00     0.00    0.00    0.00     0.00     0.00     0.00   104.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdh               0.00     0.00    0.00    0.00     0.00     0.00     0.00    31.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdj               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdk               0.00     0.00    0.00    0.00     0.00     0.00     0.00    63.00    0.00    0.00    0.00   0.00 100.00</span><br><span class="line">sdl               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdm               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdn               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00</span><br><span class="line">sdo               0.00     0.00    0.00    0.00     0.00     0.00     0.00    64.00    0.00    0.00    0.00   0.00 100.00</span><br></pre></td></tr></table></figure><h4 id="disable-OSS-read-cache"><a href="#disable-OSS-read-cache" class="headerlink" title="disable OSS read cache"></a>disable OSS read cache</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#disable read cache on all the OSTs of an OSS</span></span><br><span class="line">$ lctl set_param obdfilter.*.read_cache_enable=0</span><br><span class="line"></span><br><span class="line"><span class="comment">#re-enable read cache </span></span><br><span class="line">$ lctl set_param obdfilter.&#123;OST_name&#125;.read_cache_enable=1</span><br><span class="line">$ lctl get_param obdfilter.*.read_cache_enable</span><br></pre></td></tr></table></figure><p>writethrough_cache_enable - Controls whether data sent to the OSS as a write request is kept in the read cache and available for later reads, or if it is discarded from cache when the write is completed. By default, the writethrough cache is enabled (writethrough_cache_enable=1).</p><p>If the writethrough cache is disabled (writethrough_cache_enabled=0), the OSS discards the data after the write request from the client is completed. For subsequent read requests, or partial-page write requests, the OSS must re-read the data from disk.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#disable writethrough_cache</span></span><br><span class="line">$ lctl set_param obdfilter.*.writethrough_cache_enable=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># re-enable </span></span><br><span class="line">$ lctl set_param obdfilter.&#123;OST_name&#125;.writethrough_cache_enable=1</span><br><span class="line">$ lctl get_param obdfilter.*.writethrough_cache_enable</span><br></pre></td></tr></table></figure><p>readcache_max_filesize - Controls the maximum size of a file that both the read cache and writethrough cache will try to keep in memory. Files larger than readcache_max_filesize will not be kept in cache for either reads or writes.</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ lctl <span class="keyword">set</span>_param obdfilter.*<span class="string">.readcache_max_filesize=32M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#disable the maxinum cached file size on the OST</span></span><br><span class="line">$ lctl <span class="keyword">set</span>_param obdfilter.&#123;OST_name&#125;<span class="string">.readcache_max_filesize=-1</span></span><br><span class="line">$ lctl get_param obdfilter.*<span class="string">.readcache_max_filesize</span></span><br></pre></td></tr></table></figure><h3 id="client-metadata-setting"><a href="#client-metadata-setting" class="headerlink" title="client metadata setting"></a>client metadata setting</h3><p>The MDC max_rpcs_in_flight parameter defines the maximum number of metadata RPCs, both modifying and non-modifying RPCs, that can be sent in parallel by a client to a MDT target. This includes every file system metadata operations, such as file or directory stat, creation, unlink. The default setting is 8, minimum setting is 1 and maximum setting is 256.</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client $ lctl <span class="keyword">set</span>_param mdc.*<span class="string">.max_rpcs_in_flight=16</span></span><br></pre></td></tr></table></figure><p>The MDC max_mod_rpcs_in_flight parameter defines the maximum number of file system modifying RPCs that can be sent in parallel by a client to a MDT target. For example, the Lustre client sends modify RPCs when it performs file or directory creation, unlink, access permission modification or ownership modification. The default setting is 7, minimum setting is 1 and maximum setting is 256.</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clinet $  lctl <span class="keyword">set</span>_param mdc.*<span class="string">.max_mod_rpcs_in_flight=12</span></span><br></pre></td></tr></table></figure><p>The max_mod_rpcs_in_flight value must be strictly less than the max_rpcs_in_flight value. It must also be less or equal to the MDT max_mod_rpcs_per_client value. If one of theses conditions is not enforced, the setting fails and an explicit message is written in the Lustre log.</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mds $ echo <span class="number">12</span> &gt; <span class="regexp">/sys/m</span>odule<span class="regexp">/mdt/</span>parameters/max_mod_rpcs_per_client</span><br></pre></td></tr></table></figure><h3 id="record-several-years-ago-trace-the-file-by-debugfs"><a href="#record-several-years-ago-trace-the-file-by-debugfs" class="headerlink" title="record several years ago trace the file by debugfs"></a>record several years ago trace the file by debugfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=RHEL5.5_x86_64.iso of=rhel5-1 bs=1M count=1 oflag=sync</span><br><span class="line"></span><br><span class="line">$ cat $(blktrace.log)</span><br><span class="line">  8,32   0     2591  1720.406537446 14972  Q   W 19144704 + 2048 [ll_ost_io00_002]</span><br><span class="line">  8,32   0     2592  1720.406539742 14972  G   W 19144704 + 2048 [ll_ost_io00_002]</span><br><span class="line">  8,32   0     2593  1720.406542136 14972  P   N [ll_ost_io00_002]</span><br><span class="line">  8,32   0     2594  1720.406543690 14972  I   W 19144704 + 2048 [ll_ost_io00_002]</span><br><span class="line"></span><br><span class="line">$ line=19144704</span><br><span class="line">$ debugfs -c -R <span class="string">&quot;icheck <span class="subst">$(($line/8)</span>)&quot;</span> /dev/sdc</span><br><span class="line">debugfs 1.42.12.wc1 (15-Sep-2014)</span><br><span class="line">/dev/sdc: catastrophic mode - not reading inode or group bitmaps</span><br><span class="line">BlockInode number</span><br><span class="line">23930882623</span><br><span class="line">$ debugfs -R <span class="string">&quot;ncheck 2623&quot;</span> /dev/sdc</span><br><span class="line">debugfs 1.42.12.wc1 (15-Sep-2014)</span><br><span class="line">InodePathname</span><br><span class="line">2623/O/0/d13/2669</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lfs getstripe rhel5-1</span><br><span class="line">rhel5-1</span><br><span class="line">lmm_stripe_count:   1</span><br><span class="line">lmm_stripe_size:    1048576</span><br><span class="line">lmm_pattern:        1</span><br><span class="line">lmm_layout_gen:     0</span><br><span class="line">lmm_stripe_offset:  3</span><br><span class="line">lmm_pool:           OST0003</span><br><span class="line">obdidx objid objid group</span><br><span class="line">     3          2669        0xa6d             0</span><br><span class="line"></span><br><span class="line">$ debugfs -c -R <span class="string">&quot;stat &lt;2623&gt;&quot;</span> /dev/sdc</span><br><span class="line">debugfs 1.42.12.wc1 (15-Sep-2014)</span><br><span class="line">/dev/sdc: catastrophic mode - not reading inode or group bitmaps</span><br><span class="line">Inode: 2623   Type: regular    Mode:  0666   Flags: 0x80000</span><br><span class="line">Generation: 2790813459    Version: 0x00000005:00002bf8</span><br><span class="line">User:     0   Group:     0   Size: 1048576</span><br><span class="line">File ACL: 0    Directory ACL: 0</span><br><span class="line">Links: 1   Blockcount: 2048</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line"> ctime: 0x5715e344:00000000 -- Tue Apr 19 15:50:28 2016</span><br><span class="line"> atime: 0x00000000:00000000 -- Thu Jan  1 08:00:00 1970</span><br><span class="line"> mtime: 0x5715e344:00000000 -- Tue Apr 19 15:50:28 2016</span><br><span class="line">crtime: 0x57148057:dfa2ff44 -- Mon Apr 18 14:36:07 2016</span><br><span class="line">Size of extra inode fields: 28</span><br><span class="line">Extended attributes stored <span class="keyword">in</span> inode body:</span><br><span class="line">  lma = <span class="string">&quot;08 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 6d 0a 00 00 00 00 00 00 &quot;</span> (24)</span><br><span class="line">  lma: fid=[0x100000000:0xa6d:0x0] compat=8 incompat=0</span><br><span class="line">  fid = <span class="string">&quot;d2 0b 00 00 02 00 00 00 40 00 00 00 00 00 00 00 &quot;</span> (16)</span><br><span class="line">  fid: parent=[0x200000bd2:0x40:0x0] stripe=0</span><br><span class="line">EXTENTS:</span><br><span class="line">(0-255):2393088-2393343</span><br><span class="line"></span><br><span class="line">$ lfs fid2path /opt/ [0x200000bd2:0x40:0x0]</span><br><span class="line">/opt/OST0003/rhel5-1</span><br></pre></td></tr></table></figure><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ lctl get_param osc.testfs-OST0001*.*max*</span><br><span class="line">$ lctl get_param osc.testfs-OST0001*.*grant*</span><br><span class="line"></span><br><span class="line">client</span><br><span class="line">$ lctl get_param llite.*.stats</span><br><span class="line"></span><br><span class="line">#OSS</span><br><span class="line">$ lctl get_param obdfilter.*.brw_stats</span><br><span class="line">obdfilter.testfs-OST0000.brw_stats=</span><br><span class="line">snapshot_time:         <span class="number">1593407004.726097825</span> (secs.nsecs)</span><br><span class="line"></span><br><span class="line">                           read      |     write</span><br><span class="line">pages per bulk r/w     rpcs  % cum % |  rpcs        % cum %</span><br><span class="line"><span class="number">1</span>:   <span class="number">6006159</span>   <span class="number">2</span>   <span class="number">2</span>   | <span class="number">1239974</span>   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">2</span>:  <span class="number">45845506</span>  <span class="number">16</span>  <span class="number">18</span>   | <span class="number">1809852</span>   <span class="number">2</span>   <span class="number">4</span></span><br><span class="line"><span class="number">4</span>:   <span class="number">1952464</span>   <span class="number">0</span>  <span class="number">18</span>   | <span class="number">53814</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">8</span>:  <span class="number">33533746</span>  <span class="number">11</span>  <span class="number">30</span>   | <span class="number">832520</span>   <span class="number">1</span>   <span class="number">5</span></span><br><span class="line"><span class="number">16</span>:  <span class="number">12859649</span>   <span class="number">4</span>  <span class="number">35</span>   | <span class="number">91425</span>   <span class="number">0</span>   <span class="number">5</span></span><br><span class="line"><span class="number">32</span>:    <span class="number">620131</span>   <span class="number">0</span>  <span class="number">35</span>   | <span class="number">81660</span>   <span class="number">0</span>   <span class="number">5</span></span><br><span class="line"><span class="number">64</span>:  <span class="number">38856531</span>  <span class="number">13</span>  <span class="number">49</span>   | <span class="number">307195</span>   <span class="number">0</span>   <span class="number">5</span></span><br><span class="line"><span class="number">128</span>:   <span class="number">1697223</span>   <span class="number">0</span>  <span class="number">49</span>   | <span class="number">223084</span>   <span class="number">0</span>   <span class="number">6</span></span><br><span class="line"><span class="number">256</span>: <span class="number">142793845</span>  <span class="number">50</span> <span class="number">100</span>   | <span class="number">69219436</span>  <span class="number">93</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">                           read      |     write</span><br><span class="line">discontiguous pages    rpcs  % cum % |  rpcs        % cum %</span><br><span class="line"><span class="number">0</span>: <span class="number">284165254</span> <span class="number">100</span> <span class="number">100</span>   | <span class="number">1244480</span>   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">1</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">1810011</span>   <span class="number">2</span>   <span class="number">4</span></span><br><span class="line"><span class="number">2</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">14961</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">3</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">38853</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">4</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">10409</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">5</span>:         <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   | <span class="number">23853</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"></span><br><span class="line">$ lctl get_param ost.OSS.ost_io.req_history</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">### [lfs zfs direct IO support](https:<span class="comment">//lustre-discuss.lustre.narkive.com/S7kbvnG2/lustre-on-zfs-pooer-direct-i-o-performance)</span></span><br><span class="line">```bash</span><br><span class="line">John, with newer Lustre clients it <span class="keyword">is</span> possible <span class="keyword">for</span> multiple threads to submit non-overlapping writes concurrently (also <span class="keyword">not</span> conflicting within a single page), see LU<span class="number">-1669</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Even so, O_DIRECT writes need to be synchronous to disk on the OSS, as Patrick reports, because <span class="keyword">if</span> the OSS fails before the write <span class="keyword">is</span> on disk there <span class="keyword">is</span> no cached copy of the data on the client that can be used to resend the RPC.</span><br><span class="line"></span><br><span class="line">The problem <span class="keyword">is</span> that the ZFS OSD has very long transaction commit times <span class="keyword">for</span> synchronous writes because it does <span class="keyword">not</span> yet have support <span class="keyword">for</span> the ZIL. Using buffered writes, <span class="keyword">or</span> having very large O_DIRECT writes (e.g. <span class="number">40</span>MB <span class="keyword">or</span> larger) <span class="keyword">and</span> large RPCs (<span class="number">4</span>MB, <span class="keyword">or</span> up to <span class="number">16</span>MB <span class="keyword">in</span> <span class="number">2.9</span><span class="number">.0</span>) to amortize the sync overhead may be beneficial <span class="keyword">if</span> you really want to use O_DIRECT.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xfs</title>
      <link href="2019/11/26/xfs/"/>
      <url>2019/11/26/xfs/</url>
      
        <content type="html"><![CDATA[<p><a href="http://fibrevillage.com/storage">reference</a></p><h4 id="format"><a href="#format" class="headerlink" title="format"></a>format</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Raid 60  24 HDD 12HDD/per raid6   12-2 2  Raid stripe size 64KB</span></span><br><span class="line">$ mkfs.xfs -f -d sunit=64,swidth=$((<span class="number">64</span>*<span class="number">20</span>)) /dev/sdxx1</span><br><span class="line"><span class="comment">#su: Stripe unit, which is the RAID chunk size, in bytes</span></span><br><span class="line"><span class="comment">#sw: Multiplier of the stripe unit, i.e. number of data disks</span></span><br><span class="line"></span><br><span class="line">$ mkfs.xfs /dev/device</span><br><span class="line">$ mkfs. xfs -d su= 64k,sw= 4 /dev/device</span><br></pre></td></tr></table></figure><p>su = value<br>    Specifies a stripe unit or RAID chunk size. The value must be specified in bytes, with an optional k, m, or g suffix.<br>sw= value<br>    Specifies the number of data disks in a RAID device, or the number of stripe units in the stripe.</p><a id="more"></a><h4 id="Grow"><a href="#Grow" class="headerlink" title="Grow"></a>Grow</h4><p>While XFS file systems can be grown while mounted</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_growfs /mount/point -D size</span><br></pre></td></tr></table></figure><h4 id="Suspend-file-system"><a href="#Suspend-file-system" class="headerlink" title="Suspend file system"></a>Suspend file system</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_freeze -f /mount/point</span><br><span class="line"></span><br><span class="line"><span class="comment">#unfreeze</span></span><br><span class="line">$ xfs_freeze -u /mount/point</span><br></pre></td></tr></table></figure><p>When taking an LVM snapshot, it is not necessary to use xfs_freeze to suspend the file system first.</p><h4 id="Quota"><a href="#Quota" class="headerlink" title="Quota"></a>Quota</h4><p>uquota User quotas<br>gquota Group quotas<br>pquota Project quota</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mount -o uquota /dev/mapper/LUN13 /lun13</span><br><span class="line">$ xfs_quota  /lun13</span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27;limit isoft=500 ihard=700 trteam&#x27;</span> /lun13</span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27; limit -g bsoft=1000 m bhard=1200m test &#x27;</span> /lun13</span><br><span class="line"></span><br><span class="line"><span class="comment"># report</span></span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27;report -bih&#x27;</span> /lun13</span><br><span class="line"></span><br><span class="line"><span class="comment">#project quota</span></span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27; project -s projectname&#x27;</span> project_path</span><br><span class="line">$ xfs_quota -x -c <span class="string">&#x27; limit -p bsoft=1000m bhard=1200m projectname&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="Backup-and-restore"><a href="#Backup-and-restore" class="headerlink" title="Backup and restore"></a>Backup and restore</h4><p>To perform a full backup, perform a level 0 dump on the file system.<br>A level 1 dump is the first incremental backup after a full backup. The next incremental backup would be level 2, which only backs up files that have changed since the last level 1 dump; and so on, to a maximum of level 9.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ xfsdump -l level [-L label] -f backup-destination path-to-xfs-filesystem</span><br><span class="line">$ xfsdump -l 0 -f /backup-files/data.xfsdump /data</span><br><span class="line">$ xfsdump -l 0 -L <span class="string">&quot;backup_data&quot;</span> -f /dev/st0 /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># restore</span></span><br><span class="line">$ xfsrestore [-r] [-S session-id] [-L session-label] [-i] -f backup-location restoration-path</span><br><span class="line">$ xfsrestore -f /backup-files/data.xfsdump /mnt/data/</span><br><span class="line">$ xfsrestore -f /dev/st0 -L <span class="string">&quot;backup_data&quot;</span> /mnt/data/</span><br><span class="line"></span><br><span class="line">$ xfsrestore -I <span class="comment"># get the session ID</span></span><br><span class="line">$ xfsrestore -f /dev/st0 -S <span class="string">&quot;45e9af35-efd2-4244-87bc-4762e476cbab&quot;</span> /mnt/data/</span><br><span class="line"></span><br><span class="line">$ xfs_metadump /dev/mapper/vg0-data /home/vg0-data.metadump</span><br><span class="line">$ xfs_mdrestore /home/vg0-data.metadump /home/vg0-data.img</span><br></pre></td></tr></table></figure><h4 id="Compare-with-ext4"><a href="#Compare-with-ext4" class="headerlink" title="Compare with ext4"></a>Compare with ext4</h4><table><thead><tr><th>Task</th><th>Ext3/4</th><th>XFS</th></tr></thead><tbody><tr><td>File System check</td><td>e2fsck</td><td>xfs_repair</td></tr><tr><td>REsizing a File System</td><td>resize2fs</td><td>xfs_growfs</td></tr><tr><td>Save an image of a file system</td><td>e2image</td><td>xfs_metadump and xfs_mdrestore</td></tr><tr><td>Label or tune a File System</td><td>tune2fs</td><td>xfs_admin</td></tr><tr><td>Backup a File System</td><td>dump and restore</td><td>xfsdump xfsrestore</td></tr></tbody></table><h4 id="Defragment"><a href="#Defragment" class="headerlink" title="Defragment"></a>Defragment</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_db -r  /dev/sdb</span><br><span class="line">$ xfs_db&gt; frag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Defragment</span></span><br><span class="line">$ xfs_fsr -t 3600  -v /lun10</span><br></pre></td></tr></table></figure><h4 id="xfs-admin"><a href="#xfs-admin" class="headerlink" title="xfs_admin"></a>xfs_admin</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_admin -l /dev/sdb</span><br><span class="line">$ xfs_admin -L <span class="string">&quot;data&quot;</span> /dev/sdb</span><br><span class="line"></span><br><span class="line">$ xfs_admin -u /dev/sdb</span><br><span class="line">$ xfs_admin -U generate-id /dev/sdb</span><br><span class="line">$ xfs_admin -U nil /dev/sdb</span><br><span class="line"></span><br><span class="line">$ xfs_admin -c 0 /dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment">#Enable xfs lazy counters</span></span><br><span class="line">$ xfs_admin -c 1 /dev/sdb</span><br></pre></td></tr></table></figure><h4 id="Repair"><a href="#Repair" class="headerlink" title="Repair"></a>Repair</h4><p>-n     No modify mode. Specifies that xfs_repair should not modify the filesystem  but  should  only  scan the filesystem and indicate what repairs would have been made</p><p>-L The xfs_repair utility cannot repair an XFS file system with a dirty log. To clear the log, mount and unmount the XFS file system. force log zeroing to clean log<br>-v option gives you xfs_repair verbose outpt, inaddition to the regular repair message +extra verbosity, it has a summary for each repair phase.<br>-d Repair  dangerously.  Allow  xfs_repair to repair an XFS filesystem mounted read only. This is typically done on a root filesystem from single user mode, immediately followed by a reboot.<br>-l option, external log<br>-f Specifies  that  the  filesystem  image  to  be processed is stored in a regular file at device (see the mkfs.xfs -d file option). This might happen if an image copy of a filesystem has been copied or written into an ordinary file.  This option implies that any external log or realtime section is also in an ordinary file.<br>-P option, disable prefetching<br>-t interval Modify reporting interval, specified in seconds. During long runs xfs_repair outputs its progress every 15 minutes. Reporting is only activated when ag_stride is enabled.<br>-m Specifies the approximate maximum amount of memory, in megabytes, to use for xfs_repair.  xfs_repair has its own internal block cache which  will  scale  out  up  to  the lesser of the processs virtual address limit or about 75% of the systems physical RAM.  This option overrides these limits. NOTE: These memory limits are only approximate and may use more than the specified limit</p><p>If xfs_repair failed in phase 1, you must restore lost files from backups.<br>If xfs_repair failed in phase 2 or later, you may be able to restore files from the disk by backing up and restoring the files on the file system<br>    * Mount the file system using mount -r (read-only).<br>    * Make a file system backup with xfsdump.<br>    * Use mkfs to a make new file system on the same disk partition or XLV logical volume.<br>    * Restore the files from the backup with xfsrestore.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mount -r /dev/sdb /mnt</span><br><span class="line">$ mount /dev/sdb /mnt -o norecover</span><br></pre></td></tr></table></figure><p>Without any option, xfs_repair will check and repair errors that it encounters.</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_repair -n /dev/device</span><br><span class="line">Phase 1 - find<span class="built_in"> and </span>verify superblock...</span><br><span class="line">Phase 2 - using internal log</span><br><span class="line">        - scan filesystem freespace<span class="built_in"> and </span>inode maps...</span><br><span class="line">        - found root inode chunk</span><br><span class="line">Phase 3 - for each AG...</span><br><span class="line">        - scan (but don&#x27;t clear) agi unlinked lists...</span><br><span class="line">        - process known inodes<span class="built_in"> and </span>perform inode discovery...</span><br><span class="line">        - agno = 0</span><br><span class="line">        - agno = 1</span><br><span class="line">        - agno = 2</span><br><span class="line">        - agno = 3</span><br><span class="line">        - process newly discovered inodes...</span><br><span class="line">Phase 4 -<span class="built_in"> check </span>for duplicate blocks...</span><br><span class="line">        - setting up duplicate extent list...</span><br><span class="line">        -<span class="built_in"> check </span>for inodes claiming duplicate blocks...</span><br><span class="line">        - agno = 0</span><br><span class="line">        - agno = 1</span><br><span class="line">        - agno = 2</span><br><span class="line">        - agno = 3</span><br><span class="line">No modify flag set, skipping phase 5</span><br><span class="line">Phase 6 -<span class="built_in"> check </span>inode connectivity...</span><br><span class="line">        - traversing filesystem ...</span><br><span class="line">        - traversal finished ...</span><br><span class="line">        - moving disconnected inodes to lost+found ...</span><br><span class="line">Phase 7 - verify link counts...</span><br><span class="line">No modify flag set, skipping filesystem flush<span class="built_in"> and </span>exiting.</span><br><span class="line"></span><br><span class="line">$ xfs_repair -L /dev/device</span><br><span class="line">$ xfs_repair -d /</span><br></pre></td></tr></table></figure><ol><li>Inode  and inode blockmap (addressing) checks:bad magic number  in inode, bad magic numbers in inode blockmap  blocks,  extents out  of  order,  incorrect  number of records in inode blockmap blocks, blocks claimed that are not in a legal data area of the filesystem, blocks that are claimed by more than one inode.</li><li>Inode  allocation  map  checks:bad  magic number in inode map blocks, inode state as indicated by map (free or in-use) inconsistent with state indicated by the inode, inodes referenced by the filesystem that do not appear in the inode allocation  map, inode  allocation  map referencing blocks that do not appear to contain inodes.</li><li>Size checks:number of blocks  claimed  by  inode  inconsistent with  inode  size, directory size not block aligned, inode size not consistent with inode format.</li><li>Directory checks:bad magic numbers in directory blocks, incorrect  number  of  entries  in  a directory block, bad freespace information in a directory leaf block,  entry  pointing  to  an unallocated  (free) or out of range inode, overlapping entries, missing or incorrect dot and dotdot  entries,  entries  out  of hashvalue  order, incorrect internal directory pointers, directory type not consistent with inode format and size.</li><li>Pathname checks:files or directories not referenced by a pathname starting from the filesystem root, illegal pathname components.</li><li>Link count checks:link counts that do not agree with the  number of directory references to the inode.</li><li>Freemap  checks: blocks  claimed  free by the freemap but also claimed by an inode, blocks unclaimed  by  any  inode  but  not appearing in the freemap.</li><li>Super  Block  checks: total free block and/or free i-node count incorrect, filesystem geometry inconsistent, secondary and primary superblocks contradictory.</li></ol><h4 id="Recover-file"><a href="#Recover-file" class="headerlink" title="Recover file"></a>Recover file</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ih</span><br><span class="line">70179 -r-xr-xr-x 1 solexa solexa    0 Jan 10  2013 report.htm</span><br><span class="line"></span><br><span class="line">$ xfs_db -r /dev/sdb -c <span class="string">&quot;inode 70179&quot;</span> -c <span class="string">&quot;bmap&quot;</span></span><br><span class="line">data offset 0 startblock 2459337662 (9/43418558) count 1 flag 0a</span><br><span class="line"></span><br><span class="line">$ agblocks=$(xfs_db -r /dev/sdb -c sb -c p | grep ^agblocks | sed <span class="string">&#x27;s/.* = //&#x27;</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$agblocks</span></span><br><span class="line">268435455</span><br><span class="line">$ agcount=9</span><br><span class="line">$ b=43418558</span><br><span class="line">$ c=1</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) </span><br><span class="line">2459337653</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">2459337662</span>-<span class="number">9</span>))</span><br><span class="line">2459337653</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdb bs=4096 skip=$((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) count=<span class="variable">$c</span> of=/tmp/report.htm</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB) copied, 4.6345e-05 s, 88.4 MB/s</span><br><span class="line"></span><br><span class="line">$ cat /tmp/report.htm   <span class="comment"># file come back</span></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=gbk&quot;</span>/&gt;</span><br><span class="line">&lt;style&gt;</span><br></pre></td></tr></table></figure><h3 id="xfs-estimate"><a href="#xfs-estimate" class="headerlink" title="xfs_estimate"></a>xfs_estimate</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xfs_estimate -v /mnt</span><br><span class="line">directory                               bsize   blocks    megabytes    logsize</span><br><span class="line">/mnt                                     <span class="number">4096</span>     <span class="number">1138</span>        <span class="number">4.4</span>MB    <span class="number">4096000</span></span><br><span class="line">$ xfs_estimate -v -b <span class="number">512</span> /mnt</span><br><span class="line">directory                               bsize   blocks    megabytes    logsize</span><br><span class="line">/mnt                                      <span class="number">512</span>     <span class="number">1138</span>        <span class="number">0.6</span>MB     <span class="number">512000</span></span><br><span class="line">$ xfs_estimate -v -b <span class="number">4096</span> /mnt</span><br><span class="line">directory                               bsize   blocks    megabytes    logsize</span><br><span class="line">/mnt                                     <span class="number">4096</span>     <span class="number">1138</span>        <span class="number">4.4</span>MB    <span class="number">4096000</span></span><br></pre></td></tr></table></figure><h3 id="xfs-info"><a href="#xfs-info" class="headerlink" title="xfs_info"></a>xfs_info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_info /mnt</span><br><span class="line">meta-data=/dev/sdb               isize=512    agcount=16, agsize=4799984 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0 spinodes=0</span><br><span class="line">data     =                       bsize=4096   blocks=76799744, imaxpct=25</span><br><span class="line">         =                       sunit=16     swidth=32 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal               bsize=4096   blocks=37504, version=2</span><br><span class="line">         =                       sectsz=512   sunit=16 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure><h3 id="xfs-logprint"><a href="#xfs-logprint" class="headerlink" title="xfs_logprint"></a>xfs_logprint</h3><p>-t print out transactional view of an xfs log</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">xfs_logprint -t  /dev/sdb</span><br><span class="line">xfs_logprint:</span><br><span class="line">xfs_logprint: /dev/sdb contains a mounted and writable filesystem</span><br><span class="line">    data device: 0x810</span><br><span class="line">    <span class="built_in">log</span> device: 0x810 daddr: 307199104 length: 300032</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> tail: 256 head: 512 state: &lt;DIRTY&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOG REC AT LSN cycle 1 block 256 (0x1, 0x100)</span><br><span class="line">============================================================================</span><br><span class="line">TRANS: tid:0xb4cdd37c  <span class="built_in">type</span>:SWAPEXT  <span class="comment">#items:2  trans:0xb4cdd37c  q:0x20bcbe0</span></span><br><span class="line">BUF: cnt:2 total:2 a:0x20bd010 len:24 a:0x20bd060 len:384</span><br><span class="line">BUF:  <span class="comment">#regs:2   start blkno:0x0   len:1   bmap size:1   flags:0x9000</span></span><br><span class="line">SUPER Block Buffer:</span><br><span class="line"></span><br><span class="line">LOG REC AT LSN cycle 1 block 384 (0x1, 0x180)</span><br><span class="line">============================================================================</span><br><span class="line">TRANS: tid:0xb84fc956  <span class="built_in">type</span>:SWAPEXT  <span class="comment">#items:2  trans:0xb84fc956  q:0x20bcbe0</span></span><br><span class="line">BUF: cnt:2 total:2 a:0x20bd010 len:24 a:0x20cd250 len:384</span><br><span class="line">BUF:  <span class="comment">#regs:2   start blkno:0x0   len:1   bmap size:1   flags:0x9000</span></span><br><span class="line">SUPER Block Buffer:</span><br></pre></td></tr></table></figure><p>-i extract and print inode info<br>-q extract and print quota info<br>-e, exit when an error is found in the log<br>-c, Attempt to continue when an error is detected</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xfs_logprint -C xfs.log /dev/sdb</span><br></pre></td></tr></table></figure><h4 id="About-barriers"><a href="#About-barriers" class="headerlink" title="About barriers"></a><a href="https://xfs.org/index.php/XFS_FAQ#Write_barrier_support.">About barriers</a></h4><p>Write barrier support is enabled by default in XFS since kernel version 2.6.17. It is disabled by mounting the filesystem with nobarrier. Barrier support will flush the write back cache at the appropriate times (such as on XFS log writes). </p><h3 id="The-file-block"><a href="#The-file-block" class="headerlink" title="The file block"></a>The file block</h3><p>sdc is the 4K block device, the xfs count by 512 Bytes  </p><p>Here is the 1MB file, it s aligned   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ df -h /mnt</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdc2       948M   36M  913M   4% /mnt</span><br><span class="line"></span><br><span class="line">$ xfs_info /dev/sdc2</span><br><span class="line">meta-data=/dev/sdc2              isize=512    agcount=4, agsize=61056 blks</span><br><span class="line">         =                       sectsz=4096  attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=1 spinodes=0 rmapbt=0</span><br><span class="line">         =                       reflink=0</span><br><span class="line">data     =                       bsize=4096   blocks=244224, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal               bsize=4096   blocks=1605, version=2</span><br><span class="line">         =                       sectsz=4096  sunit=1 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=1M count=1</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.00214354 s, 489 MB/s</span><br><span class="line"></span><br><span class="line">$ ls -shl</span><br><span class="line">total 1.0M</span><br><span class="line">1.0M -rw-r--r-- 1 root root 1.0M April 17 22:16 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ xfs_bmap -v ./<span class="built_in">test</span></span><br><span class="line">./<span class="built_in">test</span>:</span><br><span class="line"> EXT: FILE-OFFSET      BLOCK-RANGE      AG AG-OFFSET        TOTAL</span><br><span class="line">   0: [0..2047]:       160..2207         0 (160..2207)       2048</span><br><span class="line"></span><br><span class="line"><span class="comment">#BLOCK-RANGE start at 160 block and total blocks: 2048; 2048 x 512</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdc2 of=dd-test bs=512 skip=160 count=2048</span><br><span class="line">2048+0 records <span class="keyword">in</span></span><br><span class="line">2048+0 records out</span><br><span class="line">1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.00779449 s, 135 MB/s</span><br><span class="line"></span><br><span class="line">$ du -hs <span class="built_in">test</span> dd-test</span><br><span class="line">1.0M<span class="built_in">test</span></span><br><span class="line">1.0Mdd-test</span><br><span class="line"></span><br><span class="line">$ md5sum ./*</span><br><span class="line">b6d81b360a5672d80c27430f39153e2c  ./<span class="built_in">test</span></span><br><span class="line">b6d81b360a5672d80c27430f39153e2c  ./dd-test</span><br></pre></td></tr></table></figure><p>Not aligned example  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rand -hex 255 &gt; flag1</span><br><span class="line">$ openssl rand -hex 255 &gt; flag2</span><br><span class="line">$ openssl rand -hex 255 &gt; flag3</span><br><span class="line">$ cat flag* &gt; flag</span><br><span class="line"></span><br><span class="line">$ xfs_bmap -v ./flag</span><br><span class="line">./flag:</span><br><span class="line"> EXT: FILE-OFFSET      BLOCK-RANGE      AG AG-OFFSET          TOTAL</span><br><span class="line">   0: [0..7]:          1052728..1052735  0 (1052728..1052735)     8</span><br><span class="line"></span><br><span class="line"><span class="comment">## it &#x27;s 4K file ?</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdc2 of=flag-copy bs=512 skip=1052728 count=8</span><br><span class="line">8+0 records <span class="keyword">in</span></span><br><span class="line">8+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 0.00178995 s, 2.3 MB/s</span><br><span class="line"></span><br><span class="line">$ md5sum flag-copy flag</span><br><span class="line">fd39ee533070b2bbd46f38f81e16c72f  flag-copy</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ hexdump -C flag</span><br><span class="line">...</span><br><span class="line">000005c0  34 33 31 66 63 62 63 30  64 35 66 31 31 32 63 33  |431fcbc0d5f112c3|</span><br><span class="line">000005d0  64 34 34 35 30 30 33 35  65 38 35 37 33 38 36 63  |d4450035e857386c|</span><br><span class="line">000005e0  32 34 32 33 31 34 39 30  36 32 64 62 36 39 61 30  |2423149062db69a0|</span><br><span class="line">000005f0  64 33 31 66 61 64 34 66  38 37 62 30 0a           |d31fad4f87b0.|</span><br><span class="line">000005fd</span><br><span class="line"></span><br><span class="line">$ hexdump -C flag-copy</span><br><span class="line">000005d0  64 34 34 35 30 30 33 35  65 38 35 37 33 38 36 63  |d4450035e857386c|</span><br><span class="line">000005e0  32 34 32 33 31 34 39 30  36 32 64 62 36 39 61 30  |2423149062db69a0|</span><br><span class="line">000005f0  64 33 31 66 61 64 34 66  38 37 62 30 0a 00 00 00  |d31fad4f87b0....|</span><br><span class="line">00000600  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00001000</span><br><span class="line"></span><br><span class="line"><span class="comment"># it &#x27;s just 1533 Bytes, not 4K</span></span><br><span class="line">$  <span class="built_in">stat</span> flag</span><br><span class="line">  File: flag</span><br><span class="line">  Size: 1533      Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 822h/2082dInode: 105         Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2020-04-18 01:00:50.197468163 +0800</span><br><span class="line">Modify: 2020-04-18 01:00:48.173261473 +0800</span><br><span class="line">Change: 2020-04-18 01:00:48.173261473 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line"><span class="comment"># just overwrite the 1533 Bytes in the 4K file...</span></span><br><span class="line">$  dd <span class="keyword">if</span>=/dev/sdc2 of=flag-copy conv=notrunc bs=1 skip=$((<span class="number">1052728</span>*<span class="number">512</span>)) count=1533</span><br><span class="line">1533+0 records <span class="keyword">in</span></span><br><span class="line">1533+0 records out</span><br><span class="line">1533 bytes (1.5 kB, 1.5 KiB) copied, 0.00655476 s, 234 kB/s</span><br><span class="line">root@homerl-To-be-filled-by-O-E-M:/mnt<span class="comment"># md5sum flag-copy flag</span></span><br><span class="line">fd39ee533070b2bbd46f38f81e16c72f  flag-copy</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag</span><br><span class="line"></span><br><span class="line">$ ls -shl</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  1.5K April  18 01:00 flag</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag1</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag2</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag3</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  4.0K April  18 01:07 flag-copy</span><br><span class="line"></span><br><span class="line">$ rm flag-copy</span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdc2 of=flag-copy conv=notrunc bs=1 skip=$((<span class="number">1052728</span>*<span class="number">512</span>)) count=1533</span><br><span class="line">$ ls -shl</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  1.5K April  18 01:00 flag</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag1</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag2</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root   511 April  18 01:00 flag3</span><br><span class="line"> 4.0K -rw-r--r-- 1 root root  1.5K April  18 01:07 flag-copy</span><br><span class="line"></span><br><span class="line">$ md5sum flag-copy flag</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag-copy</span><br><span class="line">a24e60a419445879e2be061ea414e301  flag</span><br></pre></td></tr></table></figure><p>Big file   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=big-file bs=1M count=1000</span><br><span class="line">$ xfs_bmap -v big-file </span><br><span class="line">big-file:</span><br><span class="line"> EXT: FILE-OFFSET         BLOCK-RANGE      AG AG-OFFSET          TOTAL</span><br><span class="line">   0: [0..1048447]:       4280..1052727     0 (4280..1052727)  1048448</span><br><span class="line">   1: [1048448..2047999]: 1953376..2952927  1 (96..999647)      999552</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">stat</span> big-file </span><br><span class="line">  File: big-file</span><br><span class="line">  Size: 1048576000Blocks: 2048000    IO Block: 4096   regular file</span><br><span class="line">Device: 822h/2082dInode: 104         Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2020-04-18 01:00:37.464167969 +0800</span><br><span class="line">Modify: 2020-04-18 01:00:39.196344841 +0800</span><br><span class="line">Change: 2020-04-18 01:38:26.999014414 +0800</span><br><span class="line"> Birth: -</span><br><span class="line"></span><br><span class="line">$ hexdump -C big-file</span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">3e800000</span><br><span class="line"></span><br><span class="line">$ cat flag1 flag2 flag3 </span><br><span class="line">56c80696e82e2f88984e369e5dcee45142b3682020adf733e68f692a70747b99b307b15022ed21f3d843cba8abf52e3432e6203fe2bf5bc2ecd79891dcfc133ae3350c0b8ea8d5c7d9e449938959a411ee96ca9a56653b34f2de236ddd3007b30a9876bcedcfeb73489d17a263b0af5b7a069848280dc55ecfeaccca6af46f0a637d97fcd94dd3c3d75bd871398753da6abe52d3c8d54abc6339acb094a2c33a1b772c8d51a0306ad20920c8a749d334030b5a072049572fc2d7c1183e575bd66aa2020f115b62d05bb15ddd07000e6fde5387d2807ec21605286190bfe3b77e2d3f4991bed0a716c8419ca5d4ddd7815f39e3579090040ff77be5fe730dbc</span><br><span class="line">6baa2fc5a2115063030d7d4a8633974f2fc14cd502ec6df38f575d2d6dcff299b7dcdeca9d4dd513d7d77a6099aa8604108628109f871ac414942f0f5efe58b61f5b160f5bdf34bb30ff6655f958b62731c0097ed92090ec1c2433e7baa0bca9e385f9c7b3dd1188aaedaefdfd6a9e6dadaf6bd08a7096c2219b4c8e9d9cf1daa0bbeb3dd9994666cbbd1c45e5d07afefbe0af42f508b49869f54edd34865423cb0bdd71a99f6c2f0f19f1aa494f0694b6baa3ebe090b3aeb6443b7b5f210b00560aba8bdbfdd15ab8ae909c6d99477dde90a5ad9ac28338dbe2abc663cb8092519b7258fdbba92f62d2c9dd70861274acb5180dbd8371ccf6469d5fc4940c</span><br><span class="line">b621e3e516b0a54defdde7e05b846dc8a91c29f191d2f74305b7d6e5f742c5cb1ce793450b83f2d1e5f692d78994d558ed47e8e3fe58db32aab4dc87d10452db5cf99bab7fa5915b30cc6844e4d1393bd41c56c65a7ed8eb916976d122dbf955035bd2c39ba320838d39b0e1d4cee3db53c35bfa860412f4aeef71f3e3b4d6d1edaff216e385fa667c0e08cbd780e1246adb8ae932a261f0df9c8e4a0e627e6775ddb602308efaa49e0e6413edcb577660b0ea749a3b737a00f9ef56dbb834505f4ce0950a04dce4c159d2c459f382e4d41cf517c4329d3b241e5d8eb8872b0bdd431fcbc0d5f112c3d4450035e857386c2423149062db69a0d31fad4f87b0</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=flag1 of=/dev/sdc2 bs=512 seek=4280</span><br><span class="line">0+1 records <span class="keyword">in</span></span><br><span class="line">0+1 records out</span><br><span class="line">511 bytes copied, 0.000275702 s, 1.9 MB/s</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=flag2 of=/dev/sdc2 bs=512 seek=1953376</span><br><span class="line">0+1 records <span class="keyword">in</span></span><br><span class="line">0+1 records out</span><br><span class="line">511 bytes copied, 0.0125594 s, 40.7 kB/s</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~</span><br><span class="line">$ umount /mnt</span><br><span class="line">$ mount /dev/sdc2 /mnt</span><br><span class="line">$ <span class="built_in">cd</span> /mnt/</span><br><span class="line">$ hexdump -C big-file</span><br><span class="line">00000000  35 36 63 38 30 36 39 36  65 38 32 65 32 66 38 38  |56c80696e82e2f88|</span><br><span class="line">.....</span><br><span class="line">000001f0  66 37 37 62 65 35 66 65  37 33 30 64 62 63 0a 00  |f77be5fe730dbc..|</span><br><span class="line">00000200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">1fff0000  36 62 61 61 32 66 63 35  61 32 31 31 35 30 36 33  |6baa2fc5a2115063|</span><br><span class="line">.....</span><br><span class="line">1fff01f0  66 36 34 36 39 64 35 66  63 34 39 34 30 63 0a 00  |f6469d5fc4940c..|</span><br><span class="line">1fff0200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">3e800000</span><br><span class="line"></span><br><span class="line">$ cp big-file big-file-2</span><br><span class="line">$ xfs_bmap -v big-file-2</span><br><span class="line">big-file-2:</span><br><span class="line"> EXT: FILE-OFFSET         BLOCK-RANGE      AG AG-OFFSET           TOTAL</span><br><span class="line">   0: [0..900551]:        1052728..1953279  0 (1052728..1953279) 900552</span><br><span class="line">   1: [900552..902695]:   160..2303         0 (160..2303)          2144</span><br><span class="line">   2: [902696..1854375]:  2952928..3904607  1 (999648..1951327)  951680</span><br><span class="line">   3: [1854376..2047999]: 4975584..5169207  2 (1069024..1262647) 193624</span><br><span class="line">$ big-file*</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file-2</span><br><span class="line"></span><br><span class="line">$ ls -lhs big-file-2-p* </span><br><span class="line">440M -rw-r--r-- 1 root root 440M April  18 01:54 big-file-2-p1</span><br><span class="line">1.1M -rw-r--r-- 1 root root 1.1M April  18 01:55 big-file-2-p2</span><br><span class="line">465M -rw-r--r-- 1 root root 465M April  18 01:55 big-file-2-p3</span><br><span class="line"> 95M -rw-r--r-- 1 root root  95M April  18 01:56 big-file-2-p4</span><br><span class="line"></span><br><span class="line"><span class="comment"># if the file not out of order</span></span><br><span class="line">$ hexdump -C big-file-2-p1 </span><br><span class="line">00000000  35 36 63 38 30 36 39 36  65 38 32 65 32 66 38 38  |56c80696e82e2f88|</span><br><span class="line">...</span><br><span class="line">000001f0  66 37 37 62 65 35 66 65  37 33 30 64 62 63 0a 00  |f77be5fe730dbc..|</span><br><span class="line">00000200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">1b7b9000</span><br><span class="line"></span><br><span class="line">$ hexdump -C big-file-2-p2 </span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0010c000</span><br><span class="line"></span><br><span class="line">$ hexdump -C big-file-2-p3</span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0472b000  36 62 61 61 32 66 63 35  61 32 31 31 35 30 36 33  |6baa2fc5a2115063|</span><br><span class="line">...</span><br><span class="line">0472b1f0  66 36 34 36 39 64 35 66  63 34 39 34 30 63 0a 00  |f6469d5fc4940c..|</span><br><span class="line">0472b200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">1d0b0000</span><br><span class="line"></span><br><span class="line"><span class="comment"># second flag show at 1fff0000 (536805376)</span></span><br><span class="line"><span class="comment"># p1 end at 1b7b9000 (461082624)</span></span><br><span class="line"><span class="comment"># p2 from 0x0 to 0010c000 (1097728)</span></span><br><span class="line"><span class="comment"># p3 from 0x0 to 0472b000 (74625024)</span></span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">461082624</span>+<span class="number">1097728</span>+<span class="number">74625024</span>))</span><br><span class="line">536805376</span><br><span class="line"></span><br><span class="line"><span class="comment"># it &#x27;s the 1fff0000 (536805376)</span></span><br><span class="line"></span><br><span class="line">$ cat big-file-2-p1 big-file-2-p2 big-file-2-p3 big-file-2-p4 &gt; big-file-3</span><br><span class="line">$ md5sum big-file-2 big-file-3</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file-2</span><br><span class="line">c14a4c7a949d75c9b855aa0ebd8bf67f  big-file-3</span><br></pre></td></tr></table></figure><h3 id="copy-from-this-article"><a href="#copy-from-this-article" class="headerlink" title="copy from this article"></a><a href="https://righteousit.wordpress.com/2018/05/21/xfs-part-1-superblock/">copy from this article</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">00000000  58 46 53 42 00 00 10 00  00 00 00 00 06 <span class="built_in">fc</span> 85 00  |XFSB............|</span><br><span class="line">magicnum = 0x58465342  <span class="comment"># 0-3 bytes mangic num: &quot;58 46 53 42&quot; XFSB</span></span><br><span class="line">blocksize = 4096       <span class="comment"># 4-7  &quot;00 00 10 00&quot;</span></span><br><span class="line">dblocks = 117212416    <span class="comment"># 8-15 &quot;00 00 00 00 06 fc 85 00&quot; Total blocks in file system</span></span><br><span class="line">                       <span class="comment"># echo $((117212416*4096))=480102055936 ;</span></span><br><span class="line">                  <span class="comment"># blockdev --getsz /dev/sdg1 937699328; echo $((937699328*512))=480102055936</span></span><br><span class="line"></span><br><span class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">rblocks = 0 <span class="comment"># 16-23    Num blocks in real-time device</span></span><br><span class="line">rextents = 0 <span class="comment"># 24-31    Num extents in real-time device</span></span><br><span class="line"></span><br><span class="line">00000020  ce 72 48 bd 0f 2e 4b 04  a4 77 bc <span class="built_in">cd</span> a5 91 67 <span class="built_in">cd</span>  |.rH...K..w....g.|</span><br><span class="line">uuid = ce7248bd-0f2e-4b04-a477-bccda59167cd</span><br><span class="line"></span><br><span class="line">00000030  00 00 00 00 04 00 00 07  00 00 00 00 00 00 00 60  |...............`|</span><br><span class="line">logstart = 67108871  <span class="comment">## 48-55 bytes,First block of journal &quot;00 00 00 00 04 00 00 07&quot;</span></span><br><span class="line">rootino = 96  <span class="comment">## 56-63 bytes,Root directory&#x27;s inode &quot;00 00 00 00 00 00 00 60&quot;</span></span><br><span class="line"></span><br><span class="line">00000040  00 00 00 00 00 00 00 61  00 00 00 00 00 00 00 62  |.......a.......b|</span><br><span class="line">rbmino = 97 <span class="comment"># 64-71    Real-time extents bitmap inode</span></span><br><span class="line">rsumino = 98 <span class="comment"># 72-79    Real-time bitmap summary inode</span></span><br><span class="line"></span><br><span class="line">00000050  00 00 00 01 01 bf 21 40  00 00 00 04 00 00 00 00  |......!@........|</span><br><span class="line">rextsize = 1 <span class="comment">#80-83    Real-time extent size (in blocks)</span></span><br><span class="line">agblocks = 29303104 <span class="comment">#84-87 1bf2140=29303104   single AG size (in blocks), there are 4x AGs , awk &#x27;BEGIN&#123;print 29303104*4096*4&#125;&#x27; = 480102055936, same with dblocks echo $((117212416*4096))=480102055936</span></span><br><span class="line">agcount = 4    <span class="comment">#88-91    Number of AGs # 4 x AG</span></span><br><span class="line">rbmblocks = 0  <span class="comment">#92-95    Num of real-time bitmap blocks</span></span><br><span class="line"></span><br><span class="line">00000060  00 00 df 90 bc a5 10 00  02 00 00 08 00 00 00 00  |................|</span><br><span class="line">logblocks = 57232 <span class="comment"># 96-99, 00 00 df 90, Num of journal blocks</span></span><br><span class="line">versionnum = 0xbca5 <span class="comment">#100-101 File system version and flags</span></span><br><span class="line">sectsize = 4096 <span class="comment">#102-103, 10 00 ,Sector size</span></span><br><span class="line">inodesize = 512 <span class="comment">#104-105, 02 00 ,inode size</span></span><br><span class="line">inopblock = 8   <span class="comment">#106-107, indoes/block, 00 08</span></span><br><span class="line"></span><br><span class="line">                                              <span class="comment">#108</span></span><br><span class="line">00000060  00 00 df 90 bc a5 10 00  02 00 00 08 00 00 00 00  |................|</span><br><span class="line">00000070  00 00 00 00 00 00 00 00  0c 0c 09 03 19 00 00 19  |................|</span><br><span class="line">fname = <span class="string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span> <span class="comment">#108-119 file system name, not set</span></span><br><span class="line">                                  <span class="comment">#120</span></span><br><span class="line">00000070  00 00 00 00 00 00 00 00  0c 0c 09 03 19 00 00 19  |................|</span><br><span class="line">blocklog = 12 <span class="comment">#120      log2(block size)           0xc</span></span><br><span class="line">sectlog = 12  <span class="comment">#121      log2(sector size)          0xc</span></span><br><span class="line">inodelog = 9  <span class="comment">#122      log2(inode size)           0x9</span></span><br><span class="line">inopblog = 3  <span class="comment">#123      log2(inode/block)          0x3</span></span><br><span class="line">agblklog = 25 <span class="comment">#124      log2(AG size) rounded up   0x19</span></span><br><span class="line"><span class="comment"># From logstart = 67108871(10) 0x4000007  ## 48-55 bytes First block of journal</span></span><br><span class="line"><span class="comment">#0x4000007 =      10          0 000 000 000 000 000 000 000 111</span></span><br><span class="line"><span class="comment">#AG# in upper 2 bits---/\---22 bits of relative block offset</span></span><br><span class="line"><span class="comment">#10 means beginning of AG 2</span></span><br><span class="line"><span class="comment">#111 means the journal starts at relative block offset 7</span></span><br><span class="line"><span class="comment">#The physical block offset can be calculated as follows</span></span><br><span class="line"><span class="comment">#AG num (2) x  (blocks per ag, #84-87, agblocks = 29303104) + (relative block offset 7)=58606215</span></span><br><span class="line"><span class="comment">#dd if=/dev/sdg1 bs=4096 skip=$((2*29303104 + 4)) count=1 | xxd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#inode addr</span></span><br><span class="line"><span class="comment">#123(3) + #124(25) = 28</span></span><br><span class="line"><span class="comment">#The inode address of the root directory just inode offset 64 from AG 0</span></span><br><span class="line"><span class="comment"># rootino = 96 0x60  ## 56-63 bytes,Root directory&#x27;s inode</span></span><br><span class="line"></span><br><span class="line">rextslog = 0  <span class="comment"># 125      log2(real-time extents)   0</span></span><br><span class="line">inprogress = 0 <span class="comment"># 126      log2(real-time extents)  0</span></span><br><span class="line">imax_pct = 25  <span class="comment"># 127      log2(real-time extents)  0x19</span></span><br><span class="line"></span><br><span class="line">00000080  00 00 00 00 00 00 00 40  00 00 00 00 00 00 00 3b  |.......@.......;|</span><br><span class="line">icount = 128  <span class="comment"># 128-135  Number of allocated inodes , 0x40=64=1000000 2^7=128</span></span><br><span class="line">ifree = 119   <span class="comment"># 136-143  Number of free inodes, 3b=111011, 2^1+2^2+2^0+2^4+2^5+2^6=119</span></span><br><span class="line">??? <span class="comment"># not understand</span></span><br><span class="line"></span><br><span class="line">00000090  00 00 00 00 06 f7 bd 4b  00 00 00 00 00 00 00 00  |.......K........|</span><br><span class="line">fdblocks = 116890690 <span class="comment">#144-151  Number of free blocks</span></span><br><span class="line">frextents = 0        <span class="comment">#152-159  Number of free real-time extents</span></span><br><span class="line"></span><br><span class="line">000000a0  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">uquotino = null <span class="comment"># 160-167  User quota inode</span></span><br><span class="line">gquotino = null <span class="comment"># 168-175  Group quota inode</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">000000b0  00 00 00 00 00 00 00 04  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">qflags = 0 <span class="comment">#176-177  Quota flags</span></span><br><span class="line">flags = 0  <span class="comment">#178      Misc flags</span></span><br><span class="line">shared_vn = 0  <span class="comment">#178      Misc flags</span></span><br><span class="line">inoalignmt = 4 <span class="comment">#180-183  Inode alignment (in blocks)</span></span><br><span class="line">unit = 0       <span class="comment">#184-187  RAID unit (in blocks)</span></span><br><span class="line">width = 0      <span class="comment">#188-191  RAID stripe (in blocks)</span></span><br><span class="line"></span><br><span class="line">000000c0  00 0c 10 00 00 00 10 00  00 00 01 8a 00 00 01 8a  |................|</span><br><span class="line">dirblklog = 0    <span class="comment">#192      log2(dir blk allocation granularity)</span></span><br><span class="line">logsectlog = 12  <span class="comment">#193      log2(sector size of externl journal device)</span></span><br><span class="line">logsectsize = 4096 <span class="comment">#194-195  Sector size of external journal device</span></span><br><span class="line">logsunit = 4096  <span class="comment">#196-199  Stripe/unit size of external journal device</span></span><br><span class="line">features2 = 0x18a <span class="comment">#200-203  Additional flags</span></span><br><span class="line">bad_features2 = 0x18a <span class="comment">#204-207  Repeat additional flags (for alignment)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">000000d0  00 00 00 00 00 00 00 00  00 00 00 01 00 00 00 00  |................|</span><br><span class="line">features_compat = 0   <span class="comment">#204-207  Repeat additional flags (for alignment)</span></span><br><span class="line">features_ro_compat = 0 <span class="comment">#212-215  Read-only feature flags</span></span><br><span class="line">features_incompat = 0x1 <span class="comment">#216-219  Read-write incompatibility flags</span></span><br><span class="line">features_log_incompat = 0 <span class="comment">#220-223  Read-write incompat flags for log (unused)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">000000e0  1f c6 e0 48 00 00 00 00  ff ff ff ff ff ff ff ff  |...H............|</span><br><span class="line">crc = 0x64b05119 (correct)  <span class="comment">#224-227  CRC32 checksum for superblock</span></span><br><span class="line">spino_align = 0  <span class="comment">#228-231  Sparse inode alignment</span></span><br><span class="line">pquotino = null <span class="comment">#232-239  Project quota inode</span></span><br><span class="line"></span><br><span class="line">000000f0  00 00 00 01 00 00 00 90  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">lsn = 0x1000000c8 240-247  Log seq number of last superblock update</span><br><span class="line">meta_uuid = 00000000-0000-0000-0000-000000000000 <span class="comment"># 248-263  UUID used if INCOMPAT_META_UUID feature      zeroed</span></span><br><span class="line"></span><br><span class="line">                                  <span class="comment">#264</span></span><br><span class="line">00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">264-271  If INCOMPAT_META_RMAPBT, inode of RM btree   zeroed</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>smartctl</title>
      <link href="2019/11/26/smartctl/"/>
      <url>2019/11/26/smartctl/</url>
      
        <content type="html"><![CDATA[<h3 id="Enable-sas-sata-write-cache"><a href="#Enable-sas-sata-write-cache" class="headerlink" title="Enable sas/sata write cache"></a>Enable sas/sata write cache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl --get=wcache /dev/sdc</span><br><span class="line">$ smartctl --<span class="built_in">set</span>=wcache,off /dev/sdc</span><br><span class="line">$ smartctl --<span class="built_in">set</span>=wcache,on /dev/sdc</span><br><span class="line">smartctl 6.6 2016-05-31 r4324 [x86_64-linux-4.15.0-118-generic] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">Write cache enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="smart-test"><a href="#smart-test" class="headerlink" title="smart test"></a>smart test</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl -t long /dev/sdx</span><br><span class="line">$ smartctl -t short /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment">#self test result</span></span><br><span class="line">$ smartctl --capabilities /dev/sdxx</span><br><span class="line">$ smartctl --<span class="built_in">log</span>=selftest /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># During selected tests the specified range of LBAs is checked. The LBAs to be scanned are specified in the following formats:</span></span><br><span class="line">$ smartctl -t select,0-10 -t select,5-15 -t select,10-20 /dev/sdxx</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="disable-self-test-and-smart"><a href="#disable-self-test-and-smart" class="headerlink" title="disable self test and smart"></a>disable self test and smart</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#disable smart</span></span><br><span class="line">$ smartctl --smart=off /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#disbale automatic test</span></span><br><span class="line">$ smartctl --offlineauto=off /dev/sdxx</span><br></pre></td></tr></table></figure><h3 id="check-status"><a href="#check-status" class="headerlink" title="check status"></a>check status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">smartctl -x /dev/sdxx</span><br><span class="line">smartctl 6.5 2016-05-07 r4318 [x86_64-linux-3.10.0-693.5.2.el7_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">=== START OF INFORMATION SECTION ===</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0        0         0         0     187056      15672.508           0</span><br><span class="line">write:         0        0         0         0      94787       5143.822           0</span><br><span class="line">verify:        0        0         0         0        478        101.563           0</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br><span class="line"></span><br><span class="line">SMART Self-test <span class="built_in">log</span></span><br><span class="line">Num  Test              Status                 segment  LifeTime  LBA_first_err [SK ASC ASQ]</span><br><span class="line">     Description                              number   (hours)</span><br><span class="line"><span class="comment"># 1  Reserved(7)       Completed                  64       5                 - [-   -    -]</span></span><br><span class="line"></span><br><span class="line">Long (extended) Self Test duration: 65305 seconds [1088.4 minutes]</span><br><span class="line"></span><br><span class="line">Background scan results <span class="built_in">log</span></span><br><span class="line">  Status: scan is active</span><br><span class="line">    Accumulated power on time, hours:minutes 344:48 [20688 minutes]</span><br><span class="line">    Number of background scans performed: 2,  scan progress: 18.40%</span><br><span class="line">    Number of background medium scans performed: 2</span><br><span class="line"></span><br><span class="line">Protocol Specific port <span class="built_in">log</span> page <span class="keyword">for</span> SAS SSP</span><br><span class="line">relative target port id = 1</span><br><span class="line">  generation code = 2</span><br><span class="line">  number of phys = 1</span><br><span class="line">  phy identifier = 0</span><br><span class="line">    attached device <span class="built_in">type</span>: expander device</span><br><span class="line">    attached reason: power on</span><br><span class="line">    reason: unknown</span><br><span class="line">    negotiated logical link rate: phy enabled; 6 Gbps</span><br><span class="line">    attached initiator port: ssp=0 stp=0 smp=1</span><br><span class="line">    attached target port: ssp=0 stp=0 smp=1</span><br><span class="line">    SAS address = 0x5000cca2735b5ba1</span><br><span class="line">    attached SAS address = 0x50050cc11a5481ff</span><br><span class="line">    attached phy identifier = 32</span><br><span class="line">    Invalid DWORD count = 0</span><br><span class="line">    Running disparity error count = 0</span><br><span class="line">    Loss of DWORD synchronization = 0</span><br><span class="line">    Phy reset problem = 0</span><br><span class="line">    Phy event descriptors:</span><br><span class="line">     Invalid word count: 0</span><br><span class="line">     Running disparity error count: 0</span><br><span class="line">     Loss of dword synchronization count: 0</span><br><span class="line">     Phy reset problem count: 0</span><br><span class="line">relative target port id = 2</span><br><span class="line">  generation code = 2</span><br><span class="line">  number of phys = 1</span><br><span class="line">  phy identifier = 1</span><br><span class="line">    attached device <span class="built_in">type</span>: expander device</span><br><span class="line">    attached reason: power on</span><br><span class="line">    reason: unknown</span><br><span class="line">    negotiated logical link rate: phy enabled; 6 Gbps</span><br><span class="line">    attached initiator port: ssp=0 stp=0 smp=1</span><br><span class="line">    attached target port: ssp=0 stp=0 smp=1</span><br><span class="line">    SAS address = 0x5000cca2735b5ba2</span><br><span class="line">    attached SAS address = 0x50050cc11a919cff</span><br><span class="line">    attached phy identifier = 10</span><br><span class="line">    Invalid DWORD count = 0</span><br><span class="line">    Running disparity error count = 0</span><br><span class="line">    Loss of DWORD synchronization = 0</span><br><span class="line">    Phy reset problem = 0</span><br><span class="line">    Phy event descriptors:</span><br><span class="line">     Invalid word count: 0</span><br><span class="line">     Running disparity error count: 0</span><br><span class="line">     Loss of dword synchronization count: 0</span><br><span class="line">     Phy reset problem count: 0</span><br></pre></td></tr></table></figure><h3 id="SSD-write-monitor-for-more-info-go-to-vendor-spec-file"><a href="#SSD-write-monitor-for-more-info-go-to-vendor-spec-file" class="headerlink" title="SSD write monitor, for more info go to vendor spec file"></a>SSD write monitor, for more info go to vendor spec file</h3><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">233 </span>Media_Wearout_Indicator <span class="number">0</span>x0032   <span class="number">097</span>   <span class="number">097</span>   <span class="number">000</span>    Old_age   Always       -       <span class="number">0</span></span><br><span class="line"><span class="symbol">251 </span>NAND_Writes             -O--CK   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    -    <span class="number">7546253904</span></span><br></pre></td></tr></table></figure><p>diff vendor has the diff defines</p>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> scsi </tag>
            
            <tag> smart </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bcc tools</title>
      <link href="2019/10/31/bcc/"/>
      <url>2019/10/31/bcc/</url>
      
        <content type="html"><![CDATA[<h3 id="not-make-sure"><a href="#not-make-sure" class="headerlink" title="not make sure"></a>not make sure</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/bcc/tools/funclatency -T -m -d 3600 dsl_pool_sync</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
            <tag> trace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golang</title>
      <link href="2019/10/10/golang/"/>
      <url>2019/10/10/golang/</url>
      
        <content type="html"><![CDATA[<h3 id="runtime-pprof-example"><a href="#runtime-pprof-example" class="headerlink" title="runtime/pprof example"></a>runtime/pprof example</h3><a id="more"></a><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pprof</span></span><br><span class="line"><span class="string">&quot;runtime/pprof&quot;</span></span><br><span class="line"><span class="comment">//end</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//pprof</span></span><br><span class="line"><span class="keyword">var</span> cpuprofile = flag.String(<span class="string">&quot;cpuprofile&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;write cpu profile to file.&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> memprofile = flag.String(<span class="string">&quot;memprofile&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;write memory profile to `file`&quot;</span>)</span><br><span class="line"><span class="comment">//end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Send the sequence 2, 3, 4, ... to channel &#x27;ch&#x27;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Generate</span><span class="params">(ch <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span>; ;i++ &#123;</span><br><span class="line">          ch &lt;- i <span class="comment">// Send &#x27;i&#x27; to channel &#x27;ch&#x27;.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Copy the values from channel &#x27;in&#x27; to channel &#x27;out&#x27;,</span></span><br><span class="line"><span class="comment">// removing those divisible by &#x27;prime&#x27;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Filter</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, out <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>, prime <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        i := &lt;-in <span class="comment">// Receive value from &#x27;in&#x27;.</span></span><br><span class="line">        <span class="keyword">if</span> i%prime != <span class="number">0</span> &#123;</span><br><span class="line">            out &lt;- i <span class="comment">// Send &#x27;i&#x27; to &#x27;out&#x27;.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The prime sieve: Daisy-chain Filter processes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pprof</span></span><br><span class="line">    flag.Parse()</span><br><span class="line">    <span class="keyword">if</span> *cpuprofile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">         f,err := os.Create(*cpuprofile)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             log.Fatal(err)</span><br><span class="line">         &#125;</span><br><span class="line">         pprof.StartCPUProfile(f)</span><br><span class="line">         <span class="keyword">defer</span> pprof.StopCPUProfile()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *memprofile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">         f,err := os.Create(*memprofile)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             log.Fatal(err)</span><br><span class="line">         &#125;</span><br><span class="line">         runtime.GC()</span><br><span class="line">         <span class="keyword">if</span> err := pprof.WriteHeapProfile(f); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             log.Fatal(err)</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//f.Close()</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ch := make(chan int, runtime.NumCPU()) // Create a new channel.</span></span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">128</span>) <span class="comment">// Create a new channel.</span></span><br><span class="line">    <span class="keyword">go</span> Generate(ch)      <span class="comment">// Launch Generate goroutine.</span></span><br><span class="line">    now := time.Now()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">200000</span>; i++ &#123;</span><br><span class="line">          prime := &lt;-ch</span><br><span class="line">          <span class="keyword">if</span> (i!=<span class="number">0</span> &amp;&amp; i%<span class="number">1000</span>==<span class="number">0</span>) &#123;</span><br><span class="line">            fmt.Println(i)</span><br><span class="line">            fmt.Println(<span class="string">&quot;time consuming:&quot;</span>, time.Since(now))</span><br><span class="line">            now = time.Now()</span><br><span class="line">          &#125;</span><br><span class="line">          ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">128</span>)</span><br><span class="line">          <span class="keyword">go</span> Filter(ch, ch1, prime)</span><br><span class="line">          ch = ch1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">go</span> <span class="string">build</span> <span class="string">prime.go</span></span><br><span class="line"><span class="string">$</span> <span class="string">./prime</span> <span class="string">-cpuprofile</span> <span class="string">cpu.prof</span> <span class="string">-memprofile</span> <span class="string">mem.prof</span></span><br><span class="line"><span class="string">$</span> <span class="string">go</span> <span class="string">tool</span> <span class="string">pprof</span> <span class="string">prime</span> <span class="string">./cpu.prof</span></span><br><span class="line"><span class="attr">File:</span> <span class="string">prime</span></span><br><span class="line"><span class="attr">Type:</span> <span class="string">cpu</span></span><br><span class="line"><span class="attr">Time:</span> <span class="string">Oct</span> <span class="number">10</span><span class="string">,</span> <span class="number">2019 </span><span class="string">at</span> <span class="number">11</span><span class="string">:46pm</span> <span class="string">(HKT)</span></span><br><span class="line"><span class="attr">Duration:</span> <span class="number">5.</span><span class="string">09mins,</span> <span class="string">Total</span> <span class="string">samples</span> <span class="string">=</span> <span class="number">49.</span><span class="string">93mins</span> <span class="string">(980.06%)</span></span><br><span class="line"><span class="string">Entering</span> <span class="string">interactive</span> <span class="string">mode</span> <span class="string">(type</span> <span class="string">&quot;help&quot;</span> <span class="string">for</span> <span class="string">commands,</span> <span class="string">&quot;o&quot;</span> <span class="string">for</span> <span class="string">options)</span></span><br><span class="line"><span class="string">(pprof)</span> <span class="string">top</span></span><br><span class="line"><span class="string">Showing</span> <span class="string">nodes</span> <span class="string">accounting</span> <span class="string">for</span> <span class="number">46.</span><span class="string">37mins,</span> <span class="number">92.87</span><span class="string">%</span> <span class="string">of</span> <span class="number">49.</span><span class="string">93mins</span> <span class="string">total</span></span><br><span class="line"><span class="string">Dropped</span> <span class="number">97</span> <span class="string">nodes</span> <span class="string">(cum</span> <span class="string">&lt;=</span> <span class="number">0.</span><span class="string">25mins)</span></span><br><span class="line"><span class="string">Showing</span> <span class="string">top</span> <span class="number">10</span> <span class="string">nodes</span> <span class="string">out</span> <span class="string">of</span> <span class="number">17</span></span><br><span class="line">      <span class="string">flat</span>  <span class="string">flat%</span>   <span class="string">sum%</span>        <span class="string">cum</span>   <span class="string">cum%</span></span><br><span class="line"> <span class="number">10.</span><span class="string">78mins</span> <span class="number">21.59</span><span class="string">%</span> <span class="number">21.59</span><span class="string">%</span>  <span class="number">10.</span><span class="string">79mins</span> <span class="number">21.61</span><span class="string">%</span>  <span class="string">runtime.lock</span></span><br><span class="line"> <span class="number">10.</span><span class="string">64mins</span> <span class="number">21.31</span><span class="string">%</span> <span class="number">42.90</span><span class="string">%</span>  <span class="number">10.</span><span class="string">64mins</span> <span class="number">21.31</span><span class="string">%</span>  <span class="string">runtime.unlock</span></span><br><span class="line">  <span class="number">5.</span><span class="string">78mins</span> <span class="number">11.58</span><span class="string">%</span> <span class="number">54.48</span><span class="string">%</span>  <span class="number">49.</span><span class="string">41mins</span> <span class="number">98.96</span><span class="string">%</span>  <span class="string">main.Filter</span></span><br><span class="line">  <span class="number">5.</span><span class="string">28mins</span> <span class="number">10.58</span><span class="string">%</span> <span class="number">65.06</span><span class="string">%</span>  <span class="number">22.</span><span class="string">28mins</span> <span class="number">44.63</span><span class="string">%</span>  <span class="string">runtime.chanrecv</span></span><br><span class="line">  <span class="number">4.</span><span class="string">19mins</span>  <span class="number">8.38</span><span class="string">%</span> <span class="number">73.44</span><span class="string">%</span>  <span class="number">19.</span><span class="string">19mins</span> <span class="number">38.43</span><span class="string">%</span>  <span class="string">runtime.chansend</span></span><br><span class="line">  <span class="number">3.</span><span class="string">03mins</span>  <span class="number">6.06</span><span class="string">%</span> <span class="number">79.50</span><span class="string">%</span>   <span class="number">5.</span><span class="string">33mins</span> <span class="number">10.68</span><span class="string">%</span>  <span class="string">runtime.typedmemmove</span></span><br><span class="line">  <span class="number">2.</span><span class="string">31mins</span>  <span class="number">4.62</span><span class="string">%</span> <span class="number">84.12</span><span class="string">%</span>   <span class="number">2.</span><span class="string">31mins</span>  <span class="number">4.62</span><span class="string">%</span>  <span class="string">runtime.memmove</span></span><br><span class="line">  <span class="number">1.</span><span class="string">70mins</span>  <span class="number">3.40</span><span class="string">%</span> <span class="number">87.52</span><span class="string">%</span>   <span class="number">2.</span><span class="string">86mins</span>  <span class="number">5.72</span><span class="string">%</span>  <span class="string">runtime.typedmemclr</span></span><br><span class="line">  <span class="number">1.</span><span class="string">46mins</span>  <span class="number">2.92</span><span class="string">%</span> <span class="number">90.45</span><span class="string">%</span>   <span class="number">1.</span><span class="string">46mins</span>  <span class="number">2.92</span><span class="string">%</span>  <span class="string">runtime.(*waitq).dequeue</span></span><br><span class="line">  <span class="number">1.</span><span class="string">21mins</span>  <span class="number">2.42</span><span class="string">%</span> <span class="number">92.87</span><span class="string">%</span>  <span class="number">20.</span><span class="string">40mins</span> <span class="number">40.85</span><span class="string">%</span>  <span class="string">runtime.chansend1</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">(pprof)</span> <span class="string">web</span></span><br><span class="line"><span class="string">failed</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">dot.</span> <span class="string">Is</span> <span class="string">Graphviz</span> <span class="string">installed?</span> <span class="attr">Error: exec:</span> <span class="attr">&quot;dot&quot;:</span> <span class="string">executable</span> <span class="string">file</span> <span class="string">not</span> <span class="string">found</span> <span class="string">in</span> <span class="string">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">go</span> <span class="string">tool</span> <span class="string">pprof</span> <span class="string">-http=:8080</span> <span class="string">cpu.prof</span></span><br><span class="line"><span class="string">Failed</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">dot.</span> <span class="string">Is</span> <span class="string">Graphviz</span> <span class="string">installed?</span></span><br><span class="line"><span class="attr">exec:</span> <span class="attr">&quot;dot&quot;:</span> <span class="string">executable</span> <span class="string">file</span> <span class="string">not</span> <span class="string">found</span> <span class="string">in</span> <span class="string">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">graphviz</span> <span class="string">graphviz-devel</span></span><br></pre></td></tr></table></figure><h3 id="bitwise-operators-example"><a href="#bitwise-operators-example" class="headerlink" title="bitwise operators example"></a>bitwise operators example</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 2</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 2     = 00000010</span></span><br><span class="line">    <span class="comment">// 1 | 2 = 00000011 = 3</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 5</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 5     = 00000101</span></span><br><span class="line">    <span class="comment">// 1 | 5 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise XOR ^ to get the bits that are in 3 OR 6 BUT NOT BOTH</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 ^ 6 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> ^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise AND &amp; to get the bits that are in 3 AND 6</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 &amp; 6 = 00000010 = 2</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> &amp; <span class="number">6</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bit clear AND NOT &amp;^ to get the bits that are in 3 AND NOT 6 (order matters)</span></span><br><span class="line">    <span class="comment">// 26     = 00011010</span></span><br><span class="line">    <span class="comment">// 6      = 00000110</span></span><br><span class="line">    <span class="comment">// turn          11111001</span></span><br><span class="line">    <span class="comment">// 3 &amp;^ 6 = 00011000 = 1</span></span><br><span class="line">    fmt.Println(<span class="number">26</span> &amp;^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-5  11111010+1=1111011 (two&#x27;s complement of 5, the value was -5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6  00000110</span></span><br><span class="line"><span class="comment">//-6  11111001+1=11111010</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-6  11111010 (one&#x27;s complement of 5, the value was -6)</span></span><br><span class="line"></span><br><span class="line">     fmt.Println(^<span class="number">5</span>) </span><br><span class="line"></span><br><span class="line">     a := <span class="number">1</span></span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">2</span> </span><br><span class="line">     <span class="comment">// 0000100 | 00000001 = 0000101 =5 </span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">6</span> </span><br><span class="line">     <span class="comment">// 0000101 | 0100000 = 0100101 =69</span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     fmt.Println(<span class="number">1</span>&lt;&lt;<span class="number">6</span>) </span><br><span class="line">     <span class="comment">//0000001 &lt;&lt;6 = 1000000 = 64</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="number">-6</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">69</span></span><br><span class="line"><span class="number">64</span></span><br></pre></td></tr></table></figure><p>###Reader to string</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">s := buf.String() <span class="comment">// Does a complete copy of the bytes in the buffer.</span></span><br><span class="line"></span><br><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">b := buf.Bytes()</span><br><span class="line">s := *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b, err := ioutil.ReadAll(rc); err == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">or gzip the buffer</span><br><span class="line">   raw := bytes.NewBuffer(data)</span><br><span class="line">   unz, err := gzip.NewReader(raw)</span><br><span class="line">   buf, err := ioutil.ReadAll(unz)</span><br><span class="line">   <span class="keyword">return</span> json.Unmarshal(buf, &amp;v)</span><br></pre></td></tr></table></figure><h3 id="string-to-reader"><a href="#string-to-reader" class="headerlink" title="string to reader"></a>string to reader</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">r:=strings.NewReader(<span class="string">&quot;(1,2,34,55,666)&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> d [<span class="number">5</span>]<span class="keyword">int</span></span><br><span class="line">fmt.Fscanf(r,<span class="string">&quot;(%d,%d,%d,%d,%d)&quot;</span>,&amp;d[<span class="number">0</span>],&amp;d[<span class="number">1</span>],&amp;d[<span class="number">2</span>],&amp;d[<span class="number">3</span>],&amp;d[<span class="number">4</span>])</span><br><span class="line">fmt.Println(d)</span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">buf := bytes.NewBufferString(<span class="string">&quot;R29waGVycyBydWxlIQ==&quot;</span>)</span><br><span class="line">dec := base64.NewDecoder(base64.StdEncoding, buf)</span><br><span class="line">io.Copy(os.Stdout, dec)</span><br></pre></td></tr></table></figure><h3 id="Ouput-to-stdout"><a href="#Ouput-to-stdout" class="headerlink" title="Ouput to stdout"></a>Ouput to stdout</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reader := bufio.NewReader(os.Stdin)</span><br><span class="line">fmt.Print(<span class="string">&quot;What is your name:&quot;</span>)</span><br><span class="line">data, _, _ := reader.ReadLine()</span><br><span class="line">fmt.Printf(<span class="string">&quot;Your name is %s.\r\n&quot;</span>, data)</span><br></pre></td></tr></table></figure><p><a href="http://stackoverflow.com/questions/9644139/from-io-reader-to-string-in-go">reference1</a><br><a href="https://www.datadoghq.com/blog/crossing-streams-love-letter-gos-io-reader/">reference2</a></p>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos</title>
      <link href="2019/07/18/centos/"/>
      <url>2019/07/18/centos/</url>
      
        <content type="html"><![CDATA[<h3 id="centos"><a href="#centos" class="headerlink" title="centos"></a>centos</h3><h4 id="systemd-rc-local"><a href="#systemd-rc-local" class="headerlink" title="systemd rc.local"></a>systemd rc.local</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/systemd/system/rc-local.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=/etc/rc.local Compatibility</span><br><span class="line">ConditionPathExists=/etc/rc.local</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/etc/rc.local start</span><br><span class="line">TimeoutSec=0</span><br><span class="line">StandardOutput=tty</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line">SysVStartPriority=99</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;exit 0&quot;</span> &gt; /etc/rc.local</span><br><span class="line"></span><br><span class="line">$ sudo chmod +x /etc/rc.local</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> rc-local</span><br></pre></td></tr></table></figure><h4 id="date"><a href="#date" class="headerlink" title="date"></a>date</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ date -d <span class="string">&quot;@1595260885&quot;</span> +<span class="string">&quot;%m/%d/%Y %H:%M:%S&quot;</span></span><br><span class="line">07/21/2020 00:01:25</span><br><span class="line"></span><br><span class="line">$ date -d <span class="string">&quot;07/21/2020 00:01:25&quot;</span> +%s</span><br><span class="line">159526088</span><br><span class="line"></span><br><span class="line">$ date -d @12345 -u +%H:%M:%S</span><br><span class="line">03:25:45</span><br><span class="line"></span><br><span class="line">$ date -d <span class="string">&quot;09/04/2020 03:25:45&quot;</span> +%s</span><br><span class="line">1599186345</span><br><span class="line">$ date -d <span class="string">&quot;09/04/2020 00:00:00&quot;</span> +%s</span><br><span class="line">1599174000</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">1599186345</span>-<span class="number">1599174000</span>))</span><br><span class="line">12345</span><br></pre></td></tr></table></figure><h4 id="dd"><a href="#dd" class="headerlink" title="dd"></a><a href="https://stackoverflow.com/questions/8554568/add-a-big-buffer-to-a-pipe-between-two-commands">dd</a></h4><p>dd modify pipe buffer block size</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ commandA | dd status=none iflag=fullblock bs=1M | commandB</span><br><span class="line">$ process1 | mbuffer -m 1024M | process2</span><br></pre></td></tr></table></figure><h4 id="selinux"><a href="#selinux" class="headerlink" title="selinux"></a>selinux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ setenforce 0</span><br><span class="line">$ getenforce</span><br><span class="line">Permissive</span><br></pre></td></tr></table></figure><h4 id="Software-Collections-SCL-Repository"><a href="#Software-Collections-SCL-Repository" class="headerlink" title="Software Collections ( SCL ) Repository"></a>Software Collections ( SCL ) Repository</h4><p>$ yum install centos-release-scl-rh<br>$ yum install devtoolset-9-toolchain</p><h1 id="centos-8"><a href="#centos-8" class="headerlink" title="centos 8"></a>centos 8</h1><p>$ dnf install gcc-toolset-9</p><p>$ gfortran version | head -2<br>GNU Fortran (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36)<br>Copyright (C) 2015 Free Software Foundation, Inc.</p><p>$ scl enable devtoolset-9 bash</p><p>$  gfortran version | head -2<br>GNU Fortran (GCC) 8.2.1 20180905 (Red Hat 8.2.1-3)<br>Copyright (C) 2018 Free Software Foundation, Inc.</p><a id="more"></a><h3 id="Nofile"><a href="#Nofile" class="headerlink" title="Nofile"></a><a href="https://unix.stackexchange.com/questions/447583/ulimit-vs-file-max">Nofile</a></h3><p>/proc/sys/fs/file-max<br>ulimit -n</p><p>file-max is the maximum File Descriptors (FD) enforced on a kernel level, which cannot be surpassed by all processes without increasing.<br>The ulimit is enforced on a process level, which can be less than the file-max.</p><p>/proc/sys/fs/file-nr<br>This will return three values denote the number of allocated file handles the number of allocated but unused file handles, and the maximum number of file handles. </p><h3 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pidstat -C <span class="string">&#x27;linpack|stream&#x27;</span> -d 2 -rsuw</span><br></pre></td></tr></table></figure><h3 id="nfsstat"><a href="#nfsstat" class="headerlink" title="nfsstat"></a>nfsstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nfsiostat -d /mount 2</span><br></pre></td></tr></table></figure><h3 id="user-space-pipe-size"><a href="#user-space-pipe-size" class="headerlink" title="user space pipe size"></a>user space pipe size</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># F_SETPIPE_SZ F_GETPIPE_SZ</span></span><br><span class="line"><span class="comment"># echo 104857600 &gt; /proc/sys/fs/pipe-max-size</span></span><br><span class="line"><span class="comment"># fs.pipe-max-size=104857600</span></span><br><span class="line"><span class="comment"># ulimit pipe size            (512 bytes, -p) 8 = 4096 bytes, it &#x27;s pipe buffer size in the ulimit, not pipe size</span></span><br><span class="line"><span class="comment">## POSIX.1-2001 says that write(2)s of less than PIPE_BUF  bytes  must  be atomic:  the  output  data  is  written  to  the  pipe  as a contiguous sequence.  Writes of more than PIPE_BUF bytes may  be  non-atomic:  the kernel  may  interleave the data with data written by other processes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here 2 tools for pipe</span></span><br><span class="line"><span class="comment"># pv - Pipe Viewer - is a terminal-based tool for monitoring the progress of data through a pipeline.</span></span><br><span class="line"><span class="comment"># process1 | pv -pterbTCB 1G | process2</span></span><br><span class="line"></span><br><span class="line">$ pv -cN sources linux-image-unsigned-4.15.0-65-generic-dbgsym_4.15.0-65.74_amd64.ddeb | dd of=/tmp/tmp bs=512 | pv -cN cat</span><br><span class="line"></span><br><span class="line">$ mkfifo -m 777 /tmp/lfs.log</span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.log</span><br><span class="line"></span><br><span class="line"><span class="comment">## lfs 40MB log</span></span><br><span class="line">$ lctl debug_daemon start /tmp/lfs.40.bin 40</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="rand-file"><a href="#rand-file" class="headerlink" title="rand file"></a>rand file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -out 1G.file 1073741824</span><br></pre></td></tr></table></figure><h3 id="samba"><a href="#samba" class="headerlink" title="samba"></a>samba</h3><h4 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /bin/<span class="literal">false</span>  <span class="variable">$USER</span></span><br><span class="line">PASSINPUT=`<span class="built_in">echo</span> <span class="variable">$USER</span>|cut -c1-3`123 </span><br><span class="line">(<span class="built_in">echo</span> <span class="variable">$PASSINPUT</span> ; <span class="built_in">echo</span> <span class="variable">$PASSINPUT</span>)  | smbpasswd -s -a <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><h4 id="config"><a href="#config" class="headerlink" title="config"></a>config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">workgroup = MYGROUP</span><br><span class="line">server string = Samba Server Version %v</span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/samba/<span class="built_in">log</span>.%m</span><br><span class="line">max <span class="built_in">log</span> size = 50</span><br><span class="line">security = user</span><br><span class="line">passdb backend = tdbsam</span><br><span class="line">load printers = no</span><br><span class="line">printing = bsd</span><br><span class="line">printcap name = /dev/null</span><br><span class="line"><span class="built_in">disable</span> spoolss = yes</span><br><span class="line"></span><br><span class="line">[SMB_DATA]</span><br><span class="line">path = /samba/data</span><br><span class="line">valid users =  test1,test2,test3,test4</span><br><span class="line">create mask = 0744</span><br><span class="line">force create mode = 0744</span><br><span class="line">security mask = 0744</span><br><span class="line">force security mode = 0744</span><br><span class="line">directory mask = 0755</span><br><span class="line">force directory mode = 0755</span><br><span class="line">directory security mask = 0755</span><br><span class="line">force directory security mode = 0755</span><br><span class="line">writable = yes</span><br><span class="line">fileid:mapping = smb_data</span><br><span class="line">use mmap = no</span><br><span class="line">nt acl support = yes</span><br><span class="line">ea support = yes</span><br></pre></td></tr></table></figure><h4 id="Show-status"><a href="#Show-status" class="headerlink" title="Show status"></a>Show status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient -L localhost <span class="comment">#show share point</span></span><br><span class="line">$ pdbedit -L <span class="comment"># show users</span></span><br><span class="line">$ mount.cifs //<span class="variable">$domain_addr</span>/SMB_DATA -o username=test1,password=<span class="variable">$your_pass</span> /mnt</span><br><span class="line"></span><br><span class="line">$ ls -l /var/lib/samba/private/</span><br><span class="line">total 936</span><br><span class="line">-rw------- 1 root root 528384 Aug 22 10:36 passdb.tdb</span><br><span class="line">-rw------- 1 root root 430080 Dec 29  2013 secrets.tdb</span><br><span class="line"><span class="comment"># backup data</span></span><br><span class="line">$ pdbedit -e smbpasswd:/root/samba-users.backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># import </span></span><br><span class="line">$ pdbedit -i smbpasswd:/root/samba-users.backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># Please backup all users from /etc/passwd too</span></span><br></pre></td></tr></table></figure><h3 id="update-kernel-moduels-in-lib-moduels-uname-r"><a href="#update-kernel-moduels-in-lib-moduels-uname-r" class="headerlink" title="update kernel moduels in /lib/moduels/$(uname -r)"></a>update kernel moduels in /lib/moduels/$(uname -r)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># re-generate modules.alias modules.dep</span></span><br><span class="line">$ depmod -a</span><br></pre></td></tr></table></figure><h3 id="syscalls"><a href="#syscalls" class="headerlink" title="syscalls"></a>syscalls</h3><p>Get these names from <a href="https://github.com/torvalds/linux/blob/master/include/linux/syscalls.h">syscalls.h</a></p><h3 id="filter-syslog"><a href="#filter-syslog" class="headerlink" title="filter syslog"></a><a href="https://access.redhat.com/solutions/1564823">filter syslog</a></h3><p>Created slice user-0.slice.<br>Starting Session 150 of user root.<br>Started Session 150 of user root.<br>Created slice user-0.slice.<br>Starting Session 151 of user root.<br>Started Session 151 of user root.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;if $programname == &quot;l_getidentity.*&quot; then stop&#x27;</span> &gt;/etc/rsyslog.d/ignore-lustre-id-session.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;if $programname == &quot;systemd&quot; and ($msg contains &quot;Starting Session&quot; or $msg contains &quot;Started Session&quot; or $msg contains &quot;Created slice&quot; or $msg contains &quot;Starting user-&quot; or $msg contains &quot;Starting User Slice of&quot; or $msg contains &quot;Removed session&quot; or $msg contains &quot;Removed slice User Slice of&quot; or $msg contains &quot;Stopping User Slice of&quot;) then stop&#x27;</span> &gt;/etc/rsyslog.d/ignore-systemd-session-slice.conf</span><br><span class="line"></span><br><span class="line">$ systemctl restart rsyslog</span><br></pre></td></tr></table></figure><h3 id="xfs"><a href="#xfs" class="headerlink" title="xfs"></a>xfs</h3><h4 id="Check-fragmentation"><a href="#Check-fragmentation" class="headerlink" title="Check fragmentation"></a>Check fragmentation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xfs_db -r -c frag /dev/md127</span><br><span class="line">actual 310296, ideal 306296, fragmentation factor 1.29%</span><br><span class="line">Note, this number is largely meaningless.</span><br><span class="line">Files on this filesystem average 1.01 extents per file</span><br></pre></td></tr></table></figure><h3 id="tmp-permission"><a href="#tmp-permission" class="headerlink" title="tmp permission"></a>tmp permission</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 1777 /tmp</span><br></pre></td></tr></table></figure><h3 id="taskset"><a href="#taskset" class="headerlink" title="taskset"></a>taskset</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ taskset -p a 205344</span><br><span class="line">pid 205344<span class="string">&#x27;s current affinity mask: ffffffffff</span></span><br><span class="line"><span class="string">pid 205344&#x27;</span>s new affinity mask: a</span><br><span class="line"></span><br><span class="line">$ taskset -c -p 205344</span><br><span class="line">pid 205344<span class="string">&#x27;s current affinity list: 1,3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ echo &quot;obase=2; ibase=16; A&quot; | bc</span></span><br><span class="line"><span class="string">1010 # core 1,3</span></span><br></pre></td></tr></table></figure><h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><h4 id="ssh-key-not-work"><a href="#ssh-key-not-work" class="headerlink" title="ssh key not work"></a><a href="https://stackoverflow.com/questions/6377009/adding-public-key-to-ssh-authorized-keys-does-not-log-me-in-automatically">ssh key not work</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 700 ~/.ssh</span><br><span class="line">$ chmod 600 ~/.ssh/authorized_keys</span><br><span class="line">$ chmod go-w ~</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bind $vnc_server_ip:5910 to localhost:7910</span></span><br><span class="line">$ ssh -L 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># to 0.0.0.0:7910</span></span><br><span class="line">$ ssh -L 7910:0.0.0.0:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"><span class="comment"># same with 0.0.0.0</span></span><br><span class="line">$ ssh -g -L 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"><span class="comment"># limit the client ip</span></span><br><span class="line">$ ssh -g -L 7910:<span class="variable">$&#123;ssh_client_ip&#125;</span>:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># bind $vnc_server_ip:5910 to $vnc_server_ip:7910 by $ssh_client</span></span><br><span class="line"><span class="comment"># modify -L to -R</span></span><br><span class="line">$ ssh -R 7910:localhost:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># share all ip addr</span></span><br><span class="line"><span class="comment"># modify /etc/ssh/sshd_config &#x27;GatewayPorts clientspecified&#x27;</span></span><br><span class="line">$ ssh -R 7910:0.0.0.0:5910 username@<span class="variable">$&#123;vnc_server_ip&#125;</span> -o GSSAPIAuthentication=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># vnc_server_ip2 and ip1 in the same LAN, bind vnc_server_ip2 5910 to ssh client 7910 and forward by vnc_server_ip1</span></span><br><span class="line">$ ssh -L 7910:<span class="variable">$&#123;vnc_server_ip2&#125;</span>:5910 user@<span class="variable">$&#123;vnc_server_ip1&#125;</span></span><br><span class="line">vnc_server_ip1 $ vncview localhost:7910</span><br><span class="line"><span class="comment"># Enable all ip access</span></span><br><span class="line">$ ssh -L 7910:0.0.0.0:5910 user@<span class="variable">$&#123;vnc_server_ip1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vnc_server_ip1 access ssh_client_ip2 vnc service</span></span><br><span class="line">$ ssh -R 7910:ssh_client_ip2:5910 user@vnc_server_ip1</span><br><span class="line">vnc_server_ip1 $ vncviewer localhost::7910 </span><br><span class="line"><span class="comment"># Enable all ip access</span></span><br><span class="line">$ ssh -R 7910:0.0.0.0:5910 user@vnc_server_ip1</span><br><span class="line"></span><br><span class="line"><span class="comment">#### [pass through another machine to forward sock5](https://superuser.com/questions/332850/ssh-as-socks-proxy-through-multiple-hosts)</span></span><br><span class="line">A-&gt;B-&gt;C  </span><br><span class="line">C could connecnt internet, A and B could not, A pass through B to forward sock5 port to <span class="variable">$A_local_sock_port</span></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># make these port have not block by firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### In A, you could set sock5 localhost:$A_local_sock_port to connect internnet</span></span><br><span class="line">client $ ssh -C -f -N -D <span class="variable">$local_sock_port</span> -oProxyCommand=<span class="string">&quot;ssh -C -W %h:%p username@<span class="variable">$B_ipaddr</span>&quot;</span> username@<span class="variable">$C_ipaddr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or </span></span><br><span class="line">client $ ssh -L <span class="variable">$local_sock_port</span>:localhost:<span class="variable">$PORT2</span> <span class="variable">$B_IPADDR</span></span><br><span class="line">A $ ssh -f -N -D <span class="variable">$PORT2</span> <span class="variable">$C_IPADDR</span></span><br><span class="line"><span class="comment">#merge dual command to single command</span></span><br><span class="line">client $ ssh -f -L <span class="variable">$local_sock_port</span>:localhost:<span class="variable">$PORT2</span> liyan@192.168.210.3 <span class="string">&quot;ssh -f -N -D <span class="variable">$PORT2</span> liyan@<span class="variable">$C_IPADDR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># forward remote port to local</span></span><br><span class="line">client $ ssh -fNT -R 1025:127.0.0.1:1025 -J user@<span class="variable">$B_IP</span> user@<span class="variable">$C_IP</span></span><br><span class="line">AllowTcpForwarding yes</span><br><span class="line">GatewayPorts yes</span><br></pre></td></tr></table></figure><h4 id="ssh-config-allow-users"><a href="#ssh-config-allow-users" class="headerlink" title="ssh config allow users"></a>ssh config allow users</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AllowUsers *@192.168.1.0/24 *@*.example.com *@1.2.3.4</span><br><span class="line">AllowGroups ssh</span><br></pre></td></tr></table></figure><h3 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h3><p>-ttt If given thrice, the time printed will include the microseconds and the leading portion will be printed as the number of seconds since the epoch</p><p>-s strsize  Specify the maximum string size to print (the default is 32).  Note that filenames are not considered strings and are always printed in full.</p><p>-f Trace child processes as they are created by currently traced processes  as  a  result  of  the  fork(2),  vfork(2)  and clone(2)  system  calls. Note that -p PID -f will attach all threads of process PID if it is multi-threaded, not only thread with thread_id = PID</p><p>-T Show the time spent in system calls.  This records the time difference between the beginning and the end of each  system call</p><p>-c Count time, calls, and errors for each system call and report a summary on program exit, suppressing the regular output. This attempts to show system time (CPU time spent running in the kernel) independent of wall clock time.  If -c is used with -f, only aggregate totals for all traced processes are kept.<br>-C Like -c but also print regular output while processes are running.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ strace -k cmd  <span class="comment">#show backtrace for each syscall</span></span><br><span class="line">$ strace -t cmd  <span class="comment">#prefix each syscall with walllock time</span></span><br><span class="line">$ strace -D cmd  strace process runs as detached grandchild of cmd</span><br><span class="line">$ strace -p 1234 -f <span class="comment">#addatch to all threads in process-group 1234</span></span><br><span class="line"></span><br><span class="line">strace -Tfe trace=open,<span class="built_in">read</span>,write  ./program</span><br><span class="line">$ strace -f -FF -tt -T -s 1024 -p <span class="variable">$pid</span></span><br><span class="line">$ strace -ttt -T -s 1024 -e trace=%memory -C -o ~/memory.log -f -p <span class="variable">$pid</span></span><br><span class="line">$ strace -ttt -T -s 1024 -e trace=%desc -C -o ~/desc.log -f -p <span class="variable">$pid</span></span><br></pre></td></tr></table></figure><h3 id="Calculated-CPU-usage"><a href="#Calculated-CPU-usage" class="headerlink" title="Calculated CPU usage"></a><a href="https://github.com/Leo-G/DevopsWiki/wiki/How-Linux-CPU-Usage-Time-and-Percentage-is-calculated">Calculated CPU usage</a></h3><p>cpu usage=(idle2-idle1)/(cpu2-cpu1)*100 # script example<br>cpu usage=[(user_2 +sys_2+nice_2) - (user_1 + sys_1+nice_1)]/(total_2 - total_1)*100</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> cat /proc/<span class="built_in">stat</span></span><br><span class="line">     user nice system idle iowait  irq  softirq steal guest guest_nice</span><br><span class="line">cpu  4705 356  584    3699   23    23     0       0     0          0</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"> <span class="comment"># by Paul Colby (http://colby.id.au), no rights reserved ;)</span></span><br><span class="line"></span><br><span class="line"> PREV_TOTAL=0</span><br><span class="line"> PREV_IDLE=0</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">   <span class="comment"># Get the total CPU statistics, discarding the &#x27;cpu &#x27; prefix.</span></span><br><span class="line">   CPU=(`sed -n <span class="string">&#x27;s/^cpu\s//p&#x27;</span> /proc/<span class="built_in">stat</span>`)</span><br><span class="line">   IDLE=<span class="variable">$&#123;CPU[3]&#125;</span> <span class="comment"># Just the idle CPU time.</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Calculate the total CPU time.</span></span><br><span class="line">   TOTAL=0</span><br><span class="line">   <span class="keyword">for</span> VALUE <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;CPU[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">     ((TOTAL=<span class="variable">$TOTAL</span>+<span class="variable">$VALUE</span>))</span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Calculate the CPU usage since we last checked.</span></span><br><span class="line">   ((DIFF_IDLE=<span class="variable">$IDLE</span>-<span class="variable">$PREV_IDLE</span>))</span><br><span class="line">   ((DIFF_TOTAL=<span class="variable">$TOTAL</span>-<span class="variable">$PREV_TOTAL</span>))</span><br><span class="line">    </span><br><span class="line">   <span class="comment">## </span></span><br><span class="line">   DIFF_USAGE=$(awk -v diff_idle=<span class="variable">$DIFF_IDLE</span> -v diff_total=<span class="variable">$DIFF_TOTAL</span> <span class="string">&#x27;BEGIN&#123;printf &quot;%.2f&quot;, (diff_total-diff_idle)/diff_total*100&#125;&#x27;</span>)</span><br><span class="line">   <span class="built_in">echo</span> -en <span class="string">&quot;\rCPU: <span class="variable">$DIFF_USAGE</span>%  \b\b&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Remember the total and idle CPU times for the next check.</span></span><br><span class="line">   PREV_TOTAL=<span class="string">&quot;<span class="variable">$TOTAL</span>&quot;</span></span><br><span class="line">   PREV_IDLE=<span class="string">&quot;<span class="variable">$IDLE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># Wait before checking again.</span></span><br><span class="line">   usleep 100000</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## the lib messages</span></span><br><span class="line">$ <span class="built_in">read</span>(3, <span class="string">&quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\273\0\0\0\0\0\0&quot;</span>..., 832) = 832</span><br><span class="line"></span><br><span class="line">$ od -bc /lib/x86_64-linux-gnu/libc.so.6 | head -n4</span><br><span class="line">0000000 177 105 114 106 002 001 001 003 000 000 000 000 000 000 000 000</span><br><span class="line">        177   E   L   F 002 001 001 003  \0  \0  \0  \0  \0  \0  \0  \0</span><br><span class="line">0000020 003 000 076 000 001 000 000 000 260 034 002 000 000 000 000 000</span><br><span class="line">        003  \0   &gt;  \0 001  \0  \0  \0 260 034 002  \0  \0  \0  \0  \0</span><br></pre></td></tr></table></figure><h3 id="tuna"><a href="#tuna" class="headerlink" title="tuna"></a><a href="https://access.redhat.com/solutions/2144921">tuna</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check kernel threads</span></span><br><span class="line">$ tuna -U -P</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  2      OTHER     0    0xfff 386420266      1048922        kthreadd</span><br><span class="line">  4      OTHER     0        0         7            0    kworker/0:0H</span><br><span class="line">  6      OTHER     0        0   4030025         3019     ksoftirqd/0</span><br><span class="line">  7       FIFO    99        0    155252            0     migration/0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Got the voluntary and nonvoluntary ctxt switch</span></span><br><span class="line"><span class="comment"># pid is the io test app</span></span><br><span class="line">grep ctxt_switches /proc/<span class="variable">$&#123;pid&#125;</span>/status</span><br><span class="line">voluntary_ctxt_switches:        2940930 (I/O bound)</span><br><span class="line">nonvoluntary_ctxt_switches:     9042</span><br><span class="line"></span><br><span class="line"><span class="comment"># 147095 is the cpu test app</span></span><br><span class="line">grep ctxt_switches /proc/147095/status</span><br><span class="line">voluntary_ctxt_switches:478</span><br><span class="line">nonvoluntary_ctxt_switches:1565 (CPU bound)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling automatic IRQ balancing</span></span><br><span class="line">$ systemctl stop irqbalance.service</span><br><span class="line">$ systemctl <span class="built_in">disable</span> irqbalance.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#  the kernel will automatically try to balance the load based on its understanding of the hardware&#x27;s NUMA layout</span></span><br><span class="line">$  <span class="built_in">echo</span> kernel.numa_balancing=0 &gt;&gt; /etc/sysctl.conf ; sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># Isolating CPUs from the process scheduler</span></span><br><span class="line">This step involves setting isolcpus on the kernel<span class="string">&#x27;s cmdline. This removes cores from the process scheduler that you would like to dedicate to your application, so other userland processes do not migrate to them. Please see this solutions document for more information: https://access.redhat.com/solutions/480473</span></span><br><span class="line"><span class="string">NOTE: kernel threads are not able to be disabled and will always be visible on all cores. In ps -eLf output, these show up in brackets, like [ksoftirqd/0]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grubby --update-kernel=ALL --add-args=&#x27;</span>isolcpus=1-3,5-31<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Show numa node for dev </span></span><br><span class="line"><span class="string">$ numactl -a -N netdev:em1 grep allowed /proc/self/status</span></span><br><span class="line"><span class="string">Cpus_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000055,55555555</span></span><br><span class="line"><span class="string">Cpus_allowed_list:0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38</span></span><br><span class="line"><span class="string">Mems_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span></span><br><span class="line"><span class="string">Mems_allowed_list:0-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## bind to 0,2,4 cores</span></span><br><span class="line"><span class="string">$ numactl -a -N netdev:em1 -C 0,2,4 grep allowed /proc/self/status</span></span><br><span class="line"><span class="string">Cpus_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000015</span></span><br><span class="line"><span class="string">Cpus_allowed_list:0,2,4</span></span><br><span class="line"><span class="string">Mems_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span></span><br><span class="line"><span class="string">Mems_allowed_list:0-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Here has a question, if you recheck the CPU, The CPUs_allowed_list will go to &quot;0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38&quot; again</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## write the it to systemd service config file</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">...other lines...</span></span><br><span class="line"><span class="string">ExecStart=/bin/numactl -aN netdev:em1 -C 6 /path/to/ptpd</span></span><br><span class="line"><span class="string">...other lines...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## about numactl</span></span><br><span class="line"><span class="string">Instead of a number a node can also be:</span></span><br><span class="line"><span class="string">  netdev:DEV the node connected to network device DEV</span></span><br><span class="line"><span class="string">  file:PATH  the node the block device of path is connected to</span></span><br><span class="line"><span class="string">  ip:HOST    the node of the network device host routes through</span></span><br><span class="line"><span class="string">  block:PATH the node of block device path</span></span><br><span class="line"><span class="string">  pci:[seg:]bus:dev[:func] The node of a PCI device</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Dell H330 IR</span></span><br><span class="line"><span class="string">$ lspci -ttv | grep &quot;MegaRAID SAS-3 3008&quot; -B 1</span></span><br><span class="line"><span class="string"> \-[0000:00]-+-00.0  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D DMI2</span></span><br><span class="line"><span class="string">             +-01.0-[02]----00.0  LSI Logic / Symbios Logic MegaRAID SAS-3 3008 [Fury]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ls -l /sys/class/block</span></span><br><span class="line"><span class="string">sda -&gt; ../../devices/pci0000:00/0000:00:01.0/0000:02:00.0/host0/target0:0:0/0:0:0:0/block/sda</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CPU ID</span></span><br><span class="line"><span class="string">Zero-based CPU ID0123456789101112</span></span><br><span class="line"><span class="string">Decimal Value1248163264128256512102420484096</span></span><br><span class="line"><span class="string">Hexadecimal Value1248102040801002004008001000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">printf &#x27;</span>%x %x\n<span class="string">&#x27; 1024 4096</span></span><br><span class="line"><span class="string">400 1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ awk -F &#x27;</span>[ :]+<span class="string">&#x27; &#x27;</span><span class="variable">$0</span>!~/CPU/ &amp;&amp; <span class="variable">$0</span>~/em1/&#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;<span class="string">&#x27; /proc/interrupts</span></span><br><span class="line"><span class="string">88</span></span><br><span class="line"><span class="string">90</span></span><br><span class="line"><span class="string">91</span></span><br><span class="line"><span class="string">92</span></span><br><span class="line"><span class="string">93</span></span><br><span class="line"><span class="string">94</span></span><br><span class="line"><span class="string">95</span></span><br><span class="line"><span class="string">96</span></span><br><span class="line"><span class="string">97</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ echo 400 &gt; /proc/irq/88/smp_affinitya</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">$ echo 1000 &gt; /proc/irq/97/smp_affinity</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ seq 88 97 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="NFS-client"><a href="#NFS-client" class="headerlink" title="NFS client"></a>NFS client</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options sunrpc tcp_slot_table_entries=128&quot;</span> &gt;&gt; /etc/modprobe.d/sunrpc.conf</span><br><span class="line"><span class="comment"># the value default only 2</span></span><br></pre></td></tr></table></figure><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><h4 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%cpu | head</span><br><span class="line">$ ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head</span><br></pre></td></tr></table></figure><h3 id="selinux-1"><a href="#selinux-1" class="headerlink" title="selinux"></a>selinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setroubleshoot</span><br></pre></td></tr></table></figure><h3 id="handle-overflow-in-jiffies"><a href="#handle-overflow-in-jiffies" class="headerlink" title="handle overflow in jiffies"></a><a href="https://stackoverflow.com/questions/8206762/how-does-linux-handle-overflow-in-jiffies">handle overflow in jiffies</a></h3><p>1ms = millisecond<br>1us = microsecond !=ms, microsecond = us<br>1ns = billisecond = nanosecond<br>1ps = picosecond</p><p>/usr/src/kernels/$(uname -r)/include/linux/jiffies.h</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">These inlines deal with timer wrapping correctly. You are </span><br><span class="line">strongly encouraged to use them</span><br><span class="line">1. Because people otherwise forget</span><br><span class="line">2. Because <span class="keyword">if</span> the timer wrap changes <span class="keyword">in</span> future you won<span class="string">&#x27;t have to</span></span><br><span class="line"><span class="string">   alter your driver code.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">time_after(a,b) returns true if the time a is after time b.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p>time_before(jiffies, timeout)<br>#define time_before(jiffies, timeout) ((long)(jiffies) - (long)(timeout) &lt; 0)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (time_before(jiffies, timeout)</span><br><span class="line">&#123;</span><br><span class="line">    /* we did not time out, good ... */</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    /* we timed out, error ...*</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,time_before(jiffies,timeout));   </span><br></pre></td></tr></table></figure><p>/usr/src/kernels/3.10.0-862.11.6.el7.x86_64/include/generated/autoconf.h</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define CONFIG_HZ 1000</span></span><br></pre></td></tr></table></figure><p>/usr/src/kernels/$(uname -r)/include/asm-generic/param.h<br>1GHz=1000,000,000 Hz<br>1 second/1000000000<br>awk BEGIN{printf %.9f\n,1/1000000000}<br>0.000000001 (1ns/Hz system precision)</p><p>Linux kenrel CONFIG_HZ = 1000</p><p>Tick = 1sec / CONFIG_HZ= 1ms<br>average 1ms with once interrput, 1000 time interrupt in single second</p><p>The timer tick is a timer interrupt that is usually generated HZ times per second<br>jiffies means the unit of time</p><p>the kernel use some macros prevent an overflow, eg: time_before</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#incldue <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> i,j,k</span><br><span class="line">j = jiffies;</span><br><span class="line">i = j + HZ;</span><br><span class="line">k = j + HZ*<span class="number">1000</span>;</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uapi/asm-generic/param.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">undef</span> HZ</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> HZCONFIG_HZ<span class="comment">/* Internal kernel timer frequency */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> USER_HZ100<span class="comment">/* some user interfaces are */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CLOCKS_PER_SEC(USER_HZ)       <span class="comment">/* in &quot;ticks&quot; like times() */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __ASM_GENERIC_PARAM_H */</span></span></span><br></pre></td></tr></table></figure><h3 id="Prevent-the-data-be-deleted"><a href="#Prevent-the-data-be-deleted" class="headerlink" title="Prevent the data be deleted"></a>Prevent the data be deleted</h3><p>If you files system support attr</p><ul><li>: Adds the attribute to the existing attribute of the files.<br> : Removes the attribute to the existing attribute of the files.<br>= : Keep the existing attributes that the files have.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ chattr +i -R demo</span><br><span class="line">$ rm -rf demo/</span><br><span class="line">rm: cannot remove demo/0: Permission denied</span><br><span class="line">rm: cannot remove demo/1: Permission denied</span><br><span class="line">rm: cannot remove demo/2: Permission denied</span><br><span class="line">rm: cannot remove demo/3: Permission denied</span><br><span class="line">rm: cannot remove demo/4: Permission denied</span><br><span class="line">rm: cannot remove demo/5: Permission denied</span><br><span class="line">rm: cannot remove demo/6: Permission denied</span><br><span class="line">rm: cannot remove demo/7: Permission denied</span><br><span class="line">rm: cannot remove demo/8: Permission denied</span><br><span class="line">rm: cannot remove demo/9: Permission denied</span><br><span class="line"></span><br><span class="line">$ lsattr demo/</span><br><span class="line">----i----------- demo/0</span><br><span class="line">----i----------- demo/1</span><br><span class="line">----i----------- demo/2</span><br><span class="line">----i----------- demo/3</span><br><span class="line">----i----------- demo/4</span><br><span class="line">----i----------- demo/5</span><br><span class="line">----i----------- demo/6</span><br><span class="line">----i----------- demo/7</span><br><span class="line">----i----------- demo/8</span><br><span class="line">----i----------- demo/9</span><br><span class="line">$ chattr -i -R demo/</span><br><span class="line">$ rm -f demo/*</span><br><span class="line"></span><br><span class="line"><span class="comment">### could be append</span></span><br><span class="line">$ chattr -R +a demo/</span><br><span class="line">$ <span class="built_in">cd</span> demo/</span><br><span class="line">$ ls</span><br><span class="line">0  1  2  3  4  5  6  7  8  9</span><br><span class="line">$ cat 0</span><br><span class="line">0</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; 0</span><br><span class="line">-bash: 0: Operation not permitted</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt;&gt; 0</span><br><span class="line">$ cat 0</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">$ lsattr 0</span><br><span class="line">-----a---------- 0</span><br><span class="line">$ rm -f 0</span><br><span class="line">rm: cannot remove 0: Operation not permitted</span><br><span class="line"></span><br><span class="line">$ chattr -R -a demo</span><br><span class="line">$ rm -f demo/*</span><br></pre></td></tr></table></figure><h3 id="errno"><a href="#errno" class="headerlink" title="errno"></a>errno</h3><p><a href="https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/errno.h">https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/errno.h</a><br>$ man 3 erron</p><h3 id="tc"><a href="#tc" class="headerlink" title="tc"></a><a href="https://colobu.com/2017/04/21/tc-introduction/">tc</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## fixed delay</span></span><br><span class="line">$ tc qdisc add dev eth0 root netem delay 100ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## fixed delay range 100ms  10ms</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 10ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## This causes the added delay to be 100ms  10ms with the next random element depending 25% on the last one. This isn&#x27;t true statistical correlation, but an approximation.</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 10ms 25%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 0.1% package loss</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem loss 0.1%</span><br><span class="line"></span><br><span class="line">$ tc qdisc change dev eth0 root netem loss 0.3% 25%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 1% duplicate package</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem duplicate 1%</span><br><span class="line"></span><br><span class="line"><span class="comment">## 0.1% randomly modify single bit</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem corrupt 0.1%</span><br><span class="line"></span><br><span class="line"><span class="comment">## out of order, 5,10,15,20,25... package send right now, the others delay 10ms, it &#x27;s fixed, not random</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem gap 5 delay 10ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## out of order randomly, 25% will be transmit, the others will be delay 10ms, next and previos has the 50% relevance ??</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 10ms reorder 25% 50%</span><br><span class="line"></span><br><span class="line"><span class="comment">## delay time range at 100ms  75ms, it could cause the package out of order</span></span><br><span class="line">$ tc qdisc change dev eth0 root netem delay 100ms 75ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## flow control </span></span><br><span class="line">$ tc qdisc add dev eth0 root handle 1:0 netem delay 100ms</span><br><span class="line">$ tc qdisc add dev eth0 parent 1:1 handle 10: tbf rate 256kbit buffer 1600 <span class="built_in">limit</span> 3000</span><br><span class="line">$ tc -s qdisc ls dev eth0</span><br></pre></td></tr></table></figure><h3 id="VNC"><a href="#VNC" class="headerlink" title="VNC"></a>VNC</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall -y <span class="string">&quot;GNOME Desktop&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#if there is no another data in this file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;exec gnome-session&quot;</span> &gt; ~/.xinitrc</span><br><span class="line"></span><br><span class="line">systemctl is-enabled vncserver@.service</span><br><span class="line">systemctl <span class="built_in">enable</span> vncserver@.service</span><br><span class="line"></span><br><span class="line">systemctl get-default</span><br><span class="line">systemctl set-default multi-user.target</span><br><span class="line"></span><br><span class="line">cp /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@:4.service</span><br><span class="line">vi /etc/systemd/system/vncserver@:4.service <span class="comment">## replace root user to normal user</span></span><br><span class="line">ExecStart=/usr/sbin/runuser -l root -c <span class="string">&quot;/usr/bin/vncserver %i&quot;</span></span><br><span class="line">PIDFile=/root/.vnc/%H%i.pid</span><br><span class="line"></span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">ln -s <span class="string">&#x27;/etc/systemd/system/vncserver@:4.service&#x27;</span> <span class="string">&#x27;/etc/systemd/system/multi-user.target.wants/vncserver@:4.service&#x27;</span></span><br><span class="line">systemctl <span class="built_in">enable</span> vncserver@:4.service</span><br><span class="line">systemctl start vncserver@:4.service</span><br></pre></td></tr></table></figure><h3 id="Vncserer-was-runing-but-there-is-no-desktop-in-centos-7"><a href="#Vncserer-was-runing-but-there-is-no-desktop-in-centos-7" class="headerlink" title="Vncserer was runing, but there is no desktop in centos 7"></a>Vncserer was runing, but there is no desktop in centos 7</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ yum groupinstall Xfce</span><br><span class="line">$ yum install xorg-x11-twm xterm xorg-x11-xinit </span><br><span class="line">$ chmod  755 ~/.vnc/xstartup</span><br><span class="line">$ cat ~/.vnc/xstartup</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> SESSION_MANAGER</span><br><span class="line"><span class="built_in">unset</span> DBUS_SESSION_BUS_ADDRESS</span><br><span class="line"><span class="built_in">exec</span> startxfce4</span><br></pre></td></tr></table></figure><h3 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h3><p>copy mode<br>ctrl + A + esc, press space, scroll up and select the text you want<br>ctrl + A + c, create a new session, and use vim open a file, press i go to insert mode, and press ctrl + a + ], it will copy all text to vim.</p><h3 id="VLC"><a href="#VLC" class="headerlink" title="VLC"></a>VLC</h3><h4 id="Not-show-media-title"><a href="#Not-show-media-title" class="headerlink" title="Not show media title"></a>Not show media title</h4><p><a href="https://forum.videolan.org/viewtopic.php?t=50202">Same question</a><br>Tools&gt;Preferences&gt;Subtitles / OSD&gt; Show media title on media start (disable it)<br>Tools&gt;Preferences&gt;Subtitles / OSD&gt; Enable on screen display (disable it)</p><h4 id="Not-resize-interface"><a href="#Not-resize-interface" class="headerlink" title="Not resize interface"></a>Not resize interface</h4><p><img src="/img/vlc-set1.png"></p><h3 id="grub"><a href="#grub" class="headerlink" title="grub"></a>grub</h3><p>CentOS 7 add kernel parameter</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">grubby --remove-args=<span class="string">&quot;argX argY&quot;</span> --args=<span class="string">&quot;argA argB&quot;</span> --update-kernel /boot/kernel</span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## set boot order</span></span><br><span class="line">grubby --default-kernel</span><br><span class="line">grubby --default-index</span><br><span class="line">grubby --set-default /boot/vmlinuz-4.2.0-1.fc23.x86_64</span><br><span class="line">grubby --info=ALL</span><br><span class="line">grubby --info /boot/vmlinuz-4.2.0-1.fc23.x86_64</span><br></pre></td></tr></table></figure><p>set default boot</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">grubby --info=ALL</span><br><span class="line">index=0</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-514.6.1.el7.x86_64</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-514.6.1.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-514.6.1.el7.x86_64) 7 (Core)</span><br><span class="line">index=1</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-327.el7.x86_64</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-327.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)</span><br><span class="line">index=2</span><br><span class="line">kernel=/boot/vmlinuz-0-rescue-f614a3c482eb4b21add5ae750b3871bb</span><br><span class="line">args=<span class="string">&quot;ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet &quot;</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-0-rescue-f614a3c482eb4b21add5ae750b3871bb.img</span><br><span class="line">title=CentOS Linux (0-rescue-f614a3c482eb4b21add5ae750b3871bb) 7 (Core)</span><br><span class="line">index=3</span><br><span class="line">non linux entry</span><br><span class="line"></span><br><span class="line">grubby --set-default /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br><span class="line">grubby --info /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br></pre></td></tr></table></figure><h3 id="set-debug-parameters"><a href="#set-debug-parameters" class="headerlink" title="set debug parameters"></a>set debug parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grubby --update-kernel=ALL --args=<span class="string">&#x27;rd.debug rdudevdebug systemd.log_level=debug systemd.log_target=console console=ttyS1,115200n8&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><h4 id="nolock"><a href="#nolock" class="headerlink" title="nolock"></a><a href="https://linux.die.net/man/5/nfs">nolock</a></h4><p>NLM locking is used for this mount point. When using the nolock option, applications can lock files, but such locks provide exclusion only against other applications running on the same client. Remote applications are not affected by these locks.</p><h4 id="file-lock"><a href="#file-lock" class="headerlink" title="file lock"></a><a href="https://docstore.mik.ua/orelly/networking_2ndEd/nfs/ch11_02.htm">file lock</a></h4><p>The NFS (Versions 2 and 3) protocol does not support file locking, but the NFS environment supports an ancillary protocol called NLM, which originally stood for Network Lock Manager. When an NFS filesystem on an NFS client gets a request to lock a file, instead of an NFS remote procedure call, it generates an NLM remote procedure call.</p><p>The NLM protocol consists of remote procedure calls that pattern fcntl arguments and results. Because blocking locks are supported (a process blocks waiting for a lock that conflicts with another holder), the NLM protocol has the notion of callbacks, from the file server to the NLM client to notify that a lock is available. In this way, the NLM client sometimes acts as an RPC server in order to receive delayed results from lock calls.</p><h3 id="How-could-I-found-which-file-cause-pipe-hang"><a href="#How-could-I-found-which-file-cause-pipe-hang" class="headerlink" title="How could I found which file cause pipe hang"></a>How could I found which file cause pipe hang</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat /dev/zero | tee /tank/the_file</span><br><span class="line">$ ps aux | grep 63488</span><br><span class="line">root      63488  5.2  0.0 107972   676 pts/9    S+   04:32   0:19 cat /dev/zero</span><br><span class="line"></span><br><span class="line">$ strace -p 63488</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536</span><br><span class="line">strace: Process 63488 detached</span><br><span class="line"></span><br><span class="line">$ ls -l /proc/63488/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 0 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 1 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 3 -&gt; /dev/zero</span><br><span class="line">$ lsof | grep 36710085</span><br><span class="line">cat        63488           root    1w     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line">tee        63489           root    0r     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line">$ ls -l /proc/63489/fd</span><br><span class="line">total 0</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 0 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 1 -&gt; /dev/pts/9</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 3 -&gt; /tank/the_file</span><br></pre></td></tr></table></figure><h4 id="If-pipe-change-to-socket"><a href="#If-pipe-change-to-socket" class="headerlink" title="If pipe change to socket"></a>If pipe change to socket</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ll /proc/333709/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 0 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 10 -&gt; socket:[326105]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 11 -&gt; socket:[326106]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 3 -&gt; socket:[304292]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 4 -&gt; socket:[304294]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 5 -&gt; socket:[304295]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 6 -&gt; socket:[304296]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 7 -&gt; socket:[304297]</span><br><span class="line">lr-x------ 1 root root 64 Mar 20 03:24 8 -&gt; /run/rpcbind.lock</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 9 -&gt; socket:[334786]</span><br><span class="line"></span><br><span class="line"><span class="comment">#304294 is inode</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/net/tcp | grep -Ei <span class="string">&#x27;local_address|304294&#x27;</span></span><br><span class="line">sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode</span><br><span class="line">8: 00000000:006F 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 304294 1 ffff9ac0e2f8be00 100 0 0 10 0</span><br></pre></td></tr></table></figure><h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -n -i eth0 -A -x dst port 443 and greater 100</span><br><span class="line">$ tcpdump -i eth0 -nt -s 500 port 53 and udp</span><br></pre></td></tr></table></figure><h3 id="calculate-upload-download-speed-by-ping"><a href="#calculate-upload-download-speed-by-ping" class="headerlink" title="calculate upload/download speed by ping"></a><a href="http://stackoverflow.com/questions/4575537/calculate-upload-download-speed-by-ping">calculate upload/download speed by ping</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ping -f -c 10000 -s 1472 10.100.100.100</span><br></pre></td></tr></table></figure><p>At the end of the result i get: round-trip min/avg/max/stddev = 0.174/0.219/2.078/0.020 ms<br>so in average it takes 0.219 ms to send 1500 bytes and receive 1500 bytes, thats 24 kb. 24 kb / 0.219 ms = 110 Mb/s<br>If you want to use that to a server on the internet, you need to lower the packet size to something like 1464 (for MTU 1492), drop the -f option and lower the count so it wont take too long to finish.</p><p>1500 TX Bytes + 1500 RX Bytes= 3000 Bytes = 3000 * 8 = 24000 bits<br>24000 / 0.219 = 109.589 Mb/s</p><p>It s not represent full throughput. just test single link in your ethernet adapter. not parallel.</p><h3 id="MTU-problem-check"><a href="#MTU-problem-check" class="headerlink" title="MTU problem check"></a>MTU problem check</h3><p>Level 3 network, between 2 nodes pass through gateway<br>Tcpdump show some packets loss, nmap show 10.xx.xx.clent port is open.<br>There are some packages return, some will not. Does it MTU problem ? ping could check it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ traceroute 10.xx.xx.client</span><br><span class="line">traceroute to 10.xx.xx.client (10.xx.xx.client), 30 hops max, 60 byte packets</span><br><span class="line"> 1  10.10.xx.gateway (10.10.xx.gateway)  2.239 ms  1.901 ms  2.080 ms</span><br><span class="line"> 2  10.xx.xx.client (10.xx.xx.client)  0.606 ms  0.584 ms  0.592 ms</span><br><span class="line">$ traceroute 10.xx.xx.client</span><br><span class="line">traceroute to 10.xx.xx.client (10.xx.xx.client), 30 hops max, 60 byte packets</span><br><span class="line"> 1  10.10.xx.gateway (10.10.xx.gateway)  1.881 ms  2.085 ms  2.245 ms</span><br><span class="line"> 2  10.xx.xx.client (10.xx.xx.client)  0.563 ms * *</span><br><span class="line"></span><br><span class="line">$ ping -f -c 20000 -M <span class="keyword">do</span> -s 8972 10.xx.xx.client</span><br><span class="line">PING 10.xx.xx.client (10.xx.xx.client) 8972(9000) bytes of data.</span><br><span class="line">...................................................................^C</span><br><span class="line">--- 10.xx.xx.client ping statistics ---</span><br><span class="line">67 packets transmitted, 0 received, 100% packet loss, time 1076ms</span><br></pre></td></tr></table></figure><p>You can got the issue from tcpdump, all larger than 1500 packets are loss.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">client <span class="comment"># tcpdump -v host 10.53.19.52 and greater 1500</span></span><br><span class="line">tcpdump: listening on bond0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">11:23:58.134708 IP (tos 0x0, ttl 63, id 27071, offset 0, flags [DF], proto TCP (6), length 8532)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [P.], cksum 0x496d (incorrect -&gt; 0x5fe6), seq 2359537411:2359545891, ack 3804990367, win 53, options [nop,nop,TS val 1203816317 ecr 81802289], length 8480</span><br><span class="line">11:23:58.136045 IP (tos 0x0, ttl 63, id 27077, offset 0, flags [DF], proto TCP (6), length 7292)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [.], cksum 0x4495 (incorrect -&gt; 0xe386), seq 8480:15720, ack 1, win 53, options [nop,nop,TS val 1203816318 ecr 81802294], length 7240</span><br><span class="line">11:23:58.148023 IP (tos 0x0, ttl 63, id 27083, offset 0, flags [DF], proto TCP (6), length 8588)</span><br><span class="line">    10.53.19.52.988 &gt; test-57-21.exp2: Flags [P.], cksum 0x49a5 (incorrect -&gt; 0x4006), seq 17016:25552, ack 1, win 53, options [nop,nop,TS val 1203816330 ecr 81802295], length 8536</span><br></pre></td></tr></table></figure><p>If client MTU is 1500, tcpdump(client) will not receive any large packages. they are loss in switch.</p><h3 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h3><h4 id="Exclude-packages"><a href="#Exclude-packages" class="headerlink" title="Exclude packages"></a>Exclude packages</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum update --exclude=kernel*</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">cachedir=/var/cache/yum/<span class="variable">$basearch</span>/<span class="variable">$releasever</span></span><br><span class="line">keepcache=0</span><br><span class="line">debuglevel=2</span><br><span class="line">logfile=/var/<span class="built_in">log</span>/yum.log</span><br><span class="line">exclude=kernel* redhat-release* *.i?86</span><br></pre></td></tr></table></figure><p><a href="https://access.redhat.com/solutions/10185">reference</a></p><h4 id="Switch-version"><a href="#Switch-version" class="headerlink" title="Switch version"></a>Switch version</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ yum --showduplicates list kernel</span><br><span class="line">Installed Packages</span><br><span class="line">Installed Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       @anaconda-CentOS-201508042137.x86_64/6.7</span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   @update                                 </span><br><span class="line">Available Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       base                                    </span><br><span class="line">kernel.x86_64       2.6.32-573.1.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.3.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.7.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.12.1.el6  update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.18.1.el6  update  </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### Yum.conf</span></span><br><span class="line">```apacheconf</span><br><span class="line">keepcache = 1</span><br></pre></td></tr></table></figure><h4 id="Download-to-local"><a href="#Download-to-local" class="headerlink" title="Download to local"></a>Download to local</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">yum-plugin-downloadonly</span></span><br><span class="line"><span class="string">$</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">--downloadonly</span> <span class="string">--downloaddir=&lt;directory&gt;</span> <span class="string">&lt;package&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://access.redhat.com/solutions/10154">reference</a></p><h4 id="Resolve-dependency-resolution-errors"><a href="#Resolve-dependency-resolution-errors" class="headerlink" title="Resolve dependency resolution errors"></a>Resolve dependency resolution errors</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum update</span></span><br><span class="line">** Found 5 pre-existing rpmdb problem(s), <span class="string">&#x27;yum check&#x27;</span> output follows:</span><br><span class="line">MegaCli-8.04.10-1.noarch is a duplicate with MegaCli-8.04.07-1.noarch</span><br><span class="line">kernel-2.6.32-279.5.1.el6_lustre.gb16fe80.x86_64 has missing requires of kernel-firmware &gt;= (<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2.6.32&#x27;</span>, <span class="string">&#x27;279.5.1.el6_lustre.gb16fe80&#x27;</span>)</span><br><span class="line">kernel-firmware-2.6.32-279.5.1.el6.noarch is a duplicate with kernel-firmware-2.6.32-279.el6.noarch</span><br><span class="line">kernel-headers-2.6.32-279.5.1.el6.x86_64 is a duplicate with kernel-headers-2.6.32-279.el6.x86_64</span><br><span class="line">libcom_err-1.42.3.wc3-7.el6.x86_64 is a duplicate with libcom_err-1.41.12-12.el6.i686</span><br><span class="line">......</span><br><span class="line">You could try using --skip-broken to work around the problem</span><br><span class="line">You could try running: rpm -Va --nofiles --nodigest</span><br></pre></td></tr></table></figure><h4 id="Uninstall-rpm-packages-from-rpmdb"><a href="#Uninstall-rpm-packages-from-rpmdb" class="headerlink" title="Uninstall rpm packages from rpmdb"></a>Uninstall rpm packages from rpmdb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -e --justdb --nodeps <span class="string">&quot;bad rpm packages&quot;</span></span><br><span class="line">$ rpm -ivh --force <span class="string">&quot;replace normal rpm packages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rebuild rpmdb</span></span><br><span class="line">$ <span class="built_in">cd</span> /var/lib/rpm</span><br><span class="line">$ rm -f __db*</span><br><span class="line">$ rpm --rebuilddb </span><br><span class="line"></span><br><span class="line">$ yum clean all</span><br><span class="line">$ yum -y update</span><br></pre></td></tr></table></figure><h3 id="upgrade-kernel"><a href="#upgrade-kernel" class="headerlink" title="upgrade kernel"></a>upgrade kernel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://sourceware.org/elfutils/ftp/0.170/elfutils-0.170.tar.bz2</span><br><span class="line">$ tar xjvf elfutils-0.170.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> ./elfutils-0.170</span><br><span class="line">$ ./configire; make -j 8; make install</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=/sources/kernel/elfutils-0.170/libelf:/sources/lib/el7/mpich-3.2.1/include/:<span class="variable">$C_INCLUDE_PATH</span></span><br><span class="line">$ cp -v /boot/config-3.10.0-693.21.1.el7.x86_64 .config</span><br><span class="line">make menuconfig</span><br><span class="line">make rpm-pkg</span><br><span class="line"><span class="comment">### enable what your want</span></span><br></pre></td></tr></table></figure><h4 id="BBR"><a href="#BBR" class="headerlink" title="BBR"></a>BBR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;net.core.default_qdisc=fq&#x27;</span> | sudo tee -a /etc/sysctl.conf</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.tcp_congestion_control=bbr&#x27;</span> | sudo tee -a /etc/sysctl.conf</span><br><span class="line">sudo sysctl -p</span><br><span class="line"></span><br><span class="line">$ sysctl net.ipv4.tcp_available_congestion_control</span><br><span class="line">net.ipv4.tcp_available_congestion_control = cubic bbr reno</span><br><span class="line"></span><br><span class="line">$ sysctl -n net.ipv4.tcp_congestion_control</span><br><span class="line">bbr</span><br></pre></td></tr></table></figure><h3 id="reinstall-grub2-from-boot-livecd"><a href="#reinstall-grub2-from-boot-livecd" class="headerlink" title="reinstall grub2 from boot livecd"></a>reinstall grub2 from boot livecd</h3><p>/dev/sdd2 is my linux root partition, OS is pinguyos(ubuntu)</p><h4 id="LVM-partition"><a href="#LVM-partition" class="headerlink" title="LVM partition"></a>LVM partition</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vgscan</span><br><span class="line">$ lvscan</span><br><span class="line">$ lvchange -a y /dev/centos_vg/lv_root</span><br></pre></td></tr></table></figure><h4 id="Test-in-ubuntu"><a href="#Test-in-ubuntu" class="headerlink" title="Test in ubuntu"></a>Test in ubuntu</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdd2 /opt</span><br><span class="line">mount --<span class="built_in">bind</span> /dev/ /opt/dev</span><br><span class="line">mount --<span class="built_in">bind</span> /sys/ /opt/sys</span><br><span class="line">mount --<span class="built_in">bind</span> /proc /opt/proc</span><br><span class="line">chroot /opt</span><br><span class="line">grub-install /dev/sdd</span><br><span class="line">grub-install --root-directory=/mnt/sysimages/boot/efi /dev/sdd</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure><h4 id="Test-in-CentOS-7-set-boot-menu"><a href="#Test-in-CentOS-7-set-boot-menu" class="headerlink" title="Test in CentOS 7, set boot menu"></a>Test in CentOS 7, set boot menu</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat   /boot/grub2/grub.cfg | grep Windows</span><br><span class="line">menuentry <span class="string">&quot;Windows 7 (loader) (on /dev/sda1)&quot;</span></span><br><span class="line">grub2-set-default  <span class="string">&quot;Windows 7 (loader) (on /dev/sda1)&quot;</span></span><br><span class="line">grub2-editenv list</span><br><span class="line">saved_entry=Windows 7 (loader) (on /dev/sda1)</span><br><span class="line">or </span><br><span class="line">grub2-set-default <span class="string">&quot;windows&quot;</span></span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.conf</span><br></pre></td></tr></table></figure><h4 id="Re-install-EFI"><a href="#Re-install-EFI" class="headerlink" title="Re-install EFI"></a>Re-install EFI</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /opt/boot /opt/root</span><br><span class="line">$ mount /dev/sda1 /opt/root</span><br><span class="line">$ mount /dev/sda2 /opt/root/boot/efi</span><br><span class="line"></span><br><span class="line">$ mount --<span class="built_in">bind</span> /dev/ /opt/dev</span><br><span class="line">$ mount --<span class="built_in">bind</span> /sys/ /opt/sys</span><br><span class="line">$ mount --<span class="built_in">bind</span> /proc /opt/proc</span><br><span class="line"></span><br><span class="line">$ chroot /opt</span><br><span class="line"></span><br><span class="line">$ grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class="line">$ yum install grub2-efi</span><br><span class="line">$ efibootmgr -c --disk /dev/sda --part 2 -l <span class="string">&#x27;\EFI\centos\shimx64.efi&#x27;</span> -L <span class="string">&quot;CentOS Linux&quot;</span>    </span><br><span class="line">// --part 2 point EFI partition number,-l \\EFI\\FEDORA\\GRUBX64.EFI point the GRUB EFI boot loader</span><br></pre></td></tr></table></figure><h3 id="rdesktop-to-win10"><a href="#rdesktop-to-win10" class="headerlink" title="rdesktop to win10"></a>rdesktop to win10</h3><h4 id="Enable-remote-desktop"><a href="#Enable-remote-desktop" class="headerlink" title="Enable remote desktop"></a>Enable remote desktop</h4><p><img src="/img/e_desktop.png"><br><img src="/img/e_firewall.png"></p><h4 id="Modify-registry-from-win10"><a href="#Modify-registry-from-win10" class="headerlink" title="Modify registry from win10"></a>Modify registry from win10</h4><p>\HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\SecurityLayer<br>from DWORD Hex 2 to a value of 1</p><p><a href="http://ubuntuforums.org/showthread.php?t=2287213">reference</a></p><h3 id="record-and-replay-linux-terminal"><a href="#record-and-replay-linux-terminal" class="headerlink" title="record and replay linux terminal"></a>record and replay linux terminal</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ script --timing=time.txt script.log</span><br><span class="line"><span class="comment"># record what you do</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ scriptreplay --timing=time.txt script.log</span><br><span class="line"><span class="comment"># replay</span></span><br></pre></td></tr></table></figure><h3 id="traceroute-error"><a href="#traceroute-error" class="headerlink" title="traceroute error"></a><a href="https://www.ibm.com/support/knowledgecenter/TI0003M/p8hcg/p8hcg_traceroute.htm">traceroute error</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">!H</span><br><span class="line">Host unreachable</span><br><span class="line">!N</span><br><span class="line">Network unreachable</span><br><span class="line">!P</span><br><span class="line">Protocol unreachable</span><br><span class="line">!S</span><br><span class="line">Source route failed</span><br><span class="line">!F</span><br><span class="line">Fragmentation needed</span><br></pre></td></tr></table></figure><h3 id="Getting-Error-su-cannot-set-user-id-Resource-temporarily-unavailable"><a href="#Getting-Error-su-cannot-set-user-id-Resource-temporarily-unavailable" class="headerlink" title="Getting Error su: cannot set user id: Resource temporarily unavailable"></a>Getting Error su: cannot set user id: Resource temporarily unavailable</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -u </span><br><span class="line"><span class="number">1024</span></span><br><span class="line"></span><br><span class="line">$ ulimit -u <span class="number">10240</span></span><br><span class="line"></span><br><span class="line">$ <span class="regexp">/etc/</span>security/limits.conf</span><br><span class="line">testuser         -      nproc          <span class="number">10240</span></span><br><span class="line"></span><br><span class="line">$ cat <span class="regexp">/proc/</span>sys<span class="regexp">/kernel/</span>threads-max</span><br><span class="line"><span class="number">1026188</span></span><br></pre></td></tr></table></figure><h3 id="lshw"><a href="#lshw" class="headerlink" title="lshw"></a>lshw</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lshw -c network -businfo</span><br><span class="line">Bus info          Device      Class          Description</span><br><span class="line">========================================================</span><br><span class="line">pci@0000:04:00.0  em1         network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe</span><br><span class="line">pci@0000:04:00.1  em2         network        NetXtreme BCM5720 2-port Gigabit Ethernet PCIe</span><br><span class="line">pci@0000:65:00.0  p2p1        network        Ethernet 10G 2P X520 Adapter</span><br><span class="line">pci@0000:65:00.1  p2p2        network        Ethernet 10G 2P X520 Adapter</span><br><span class="line">                  bond0       network        Ethernet interface</span><br></pre></td></tr></table></figure><h3 id="CentOS8"><a href="#CentOS8" class="headerlink" title="CentOS8"></a>CentOS8</h3><h4 id="bonding"><a href="#bonding" class="headerlink" title="bonding"></a>bonding</h4><p>Because my ansible was generate the config file in network-scripts, but restart NetworkManger centos 8 not work.<br>I got the compatible mode.</p><p>Load the config same with centos 7, after loading, it will work in centos 8<br>Please dont add NM_CONTROLLED=no</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-bond0</span><br><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-enp1s0f0</span><br><span class="line">$ nmcli connection load /etc/sysconfig/network-scripts/ifcfg-enp1s0f1</span><br><span class="line">$ nmcli connection reload</span><br></pre></td></tr></table></figure><h3 id="fio-test-multiple-nodes"><a href="#fio-test-multiple-nodes" class="headerlink" title="fio test multiple nodes"></a>fio test multiple nodes</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ fio --server</span><br><span class="line"><span class="comment">## start fio process in each test server</span></span><br><span class="line"></span><br><span class="line">$ cat fio-test</span><br><span class="line">Server-A-ip</span><br><span class="line">Server-B-ip</span><br><span class="line">Server-C-ip</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ fio --client=fio_hosts.list /mnt/fio.cfg</span><br><span class="line"></span><br><span class="line">All clients: (groupid=0, <span class="built_in">jobs</span>=8): err= 0: pid=0: Fri Mar  6 17:08:04 2020</span><br><span class="line">   <span class="built_in">read</span>: IOPS=1147, BW=1148Mi (1203M)(1011GiB/902172msec)</span><br><span class="line">    slat (nsec): min=58, max=368519, avg=450.92, stdev=799.19</span><br><span class="line">    clat (usec): min=1355, max=4778.4k, avg=58198.62, stdev=114448.04</span><br><span class="line">     lat (usec): min=1356, max=4778.4k, avg=58199.07, stdev=114448.07</span><br><span class="line">   bw (  KiB/s): min= 2043, max=2654208, per=12.74%, avg=149910.02, stdev=178032.72, samples=14109</span><br><span class="line">   iops        : min=    1, max= 2592, avg=146.33, stdev=173.87, samples=14109</span><br><span class="line">  write: IOPS=1146, BW=1146Mi (1202M)(1010GiB/902172msec)</span><br><span class="line">    slat (nsec): min=162, max=916488, avg=799.05, stdev=783.74</span><br><span class="line">    clat (usec): min=1345, max=3839.9k, avg=52775.15, stdev=105530.38</span><br><span class="line">     lat (usec): min=1346, max=3839.9k, avg=52775.95, stdev=105530.41</span><br></pre></td></tr></table></figure><h3 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SUID (Set owner User ID up on execution)</span><br><span class="line">chmod 4555/u+s /<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">ls -l /usr/bin/passwd  /etc/shadow</span><br><span class="line">----------  1 root root  1005 Feb 14 14:15 /etc/shadow</span><br><span class="line">-rwsr-xr-x. 1 root root 27856 Aug  9  2019 /usr/bin/passwd</span><br><span class="line"></span><br><span class="line">SUID is defined as giving temporary permissions to a user to run a program/file with the permissions of the file owner rather that the user who runs it</span><br><span class="line"></span><br><span class="line">SGID</span><br><span class="line">chmod 2555/g+s /dir </span><br><span class="line">similar with SUID, it <span class="string">&#x27;s the group bit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Sticky Bit</span></span><br><span class="line"><span class="string">chmod 1777/chmod +t /tmp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- T refers to when the execute permissions are off.</span></span><br><span class="line"><span class="string">- t refers to when the execute permissions are on.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The sticky bit is primarily used on shared directories. </span></span><br><span class="line"><span class="string">[For example if user bob creates a file named /tmp/bob, other user tom can not delete this file even when the /tmp directory has permission of 777. If sticky bit is not set then tom can delete /tmp/bob, as the /tmp/bob file inherits the parent directory permissions.](https://www.thegeekdiary.com/what-is-suid-sgid-and-sticky-bit/)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### set time</span></span><br><span class="line"><span class="string">#### back access time</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">$ atime=$(stat -c%X $filename)</span></span><br><span class="line"><span class="string">$ touch -a --date=@$&#123;atime&#125; $newpath</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ mtime=$(stat -c%Z $filename)</span></span><br><span class="line"><span class="string">$ touch -m --date=@$&#123;mtime&#125; $newpath</span></span><br></pre></td></tr></table></figure><h3 id="screen-1"><a href="#screen-1" class="headerlink" title="screen"></a>screen</h3><p>background run command</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;screen -dmS collectl su -s /bin/bash nobody -c &quot;</span>\<span class="string">&#x27;&quot;collectl --export graphite,$ip,d=2 -i60 -s CMDN --netfilt &quot;\&quot;&quot;eth|en|p[0-9]|em&quot;\&quot;&quot; --dskfilt &quot;\&quot;&quot;nvme|sd&quot;\&quot;\&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Add-systemd-service"><a href="#Add-systemd-service" class="headerlink" title="Add systemd service"></a>Add systemd service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/etc/systemd/system/apm.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Local system resume actions</span><br><span class="line">After=suspend.target hybrid-sleep.target hibernate.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/hdparm -B 254 /dev/sda</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sleep.target</span><br></pre></td></tr></table></figure><h3 id="route-config"><a href="#route-config" class="headerlink" title="route config"></a>route config</h3><h4 id="static-route"><a href="#static-route" class="headerlink" title="static route"></a>static route</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">subnet mask could be</span><br><span class="line">01011000  255.255.255.88</span><br><span class="line"></span><br><span class="line">just recommend against using noncontiguous subnet masks.</span><br><span class="line"></span><br><span class="line">cat /etc/sysconfig/network-scripts/route-em1</span><br><span class="line">ADDRESS0=10.64.0.0</span><br><span class="line">NETMASK0=255.240.0.0</span><br><span class="line">GATEWAY0=192.168</span><br><span class="line">ADDRESS1=10.200.0.0</span><br><span class="line">NETMASK1=255.252.0.0</span><br><span class="line">GATEWAY1=10.64.64.247</span><br><span class="line">ADDRESS2=10.236.0.0</span><br><span class="line">NETMASK2=255.255.0.0</span><br><span class="line">GATEWAY2=10.64.64.247</span><br></pre></td></tr></table></figure><h3 id="Check-NIC-driver-err"><a href="#Check-NIC-driver-err" class="headerlink" title="Check NIC driver err"></a>Check NIC driver err</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S enp129s0f0 | grep -Ei <span class="string">&#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="collectl"><a href="#collectl" class="headerlink" title="collectl"></a>collectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ collectl --top iokb</span><br><span class="line">$ collectl --vmstat</span><br><span class="line">$ collectl -sZ</span><br><span class="line">$ collectl -c10 -f /opt</span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT</span><br><span class="line">$ collectl -m -p /var/<span class="built_in">log</span>/collectl/2daygeek-20170105-150152.raw.gz -oT --from 15:02:00 --thru 15:02:05</span><br><span class="line">$ collectl --showoptions</span><br><span class="line">$ collectl --showsubsys</span><br><span class="line">$ collectl --showsubopts</span><br><span class="line">$ collectl --showtopopts</span><br></pre></td></tr></table></figure><h3 id="process-mointor"><a href="#process-mointor" class="headerlink" title="process mointor"></a>process mointor</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ pstree -sg <span class="number">25153</span> # <span class="keyword">get</span> process tree</span><br><span class="line">systemd(<span class="number">1</span>)sshd(<span class="number">3266</span>)sshd(<span class="number">32704</span>)hydra_pmi_proxy(<span class="number">32706</span>)test.sh(<span class="number">32725</span>)</span><br><span class="line"></span><br><span class="line">$ pstree -sga <span class="number">32725</span></span><br><span class="line">systemd,<span class="number">1</span> --switched-root --system --deserialize <span class="number">22</span></span><br><span class="line">  sshd,<span class="number">3266</span> -D</span><br><span class="line">      sshd,<span class="number">32704</span></span><br><span class="line">          hydra_pmi_proxy,<span class="number">32706</span> --control-port centos7-test:<span class="number">38001</span> --rmk user --launcher ssh --demux poll --pgid <span class="number">0</span> --retries <span class="number">10</span>--u</span><br><span class="line">              test.sh,<span class="number">32725</span> /root/test.sh /mnt</span><br><span class="line"></span><br><span class="line">$ pidstat -drsuw</span><br><span class="line">    * CPU utilization</span><br><span class="line">    * IO</span><br><span class="line">    * page faults <span class="keyword">and</span> memory utilization</span><br><span class="line">    * stack utilization</span><br><span class="line">    * task switching</span><br><span class="line">$ collectl -i:<span class="number">1</span> -sZ --procopts wt --procfilt p$pid -oT</span><br><span class="line">$ collectl -i:<span class="number">1</span> -sZ --procopts wt --procfilt u$uid -oT</span><br><span class="line"></span><br><span class="line">$ iotop -b -n1 -o -P</span><br><span class="line"></span><br><span class="line">$ atop -d -c -PPRD <span class="number">1</span> <span class="number">1</span>  | sort -nr -k <span class="number">13</span> -k <span class="number">15</span>  | head</span><br><span class="line">                                                                           reads    read sec     writes write sec(<span class="number">512</span>B)</span><br><span class="line">PRD kvm-manager-a23<span class="number">-1</span> <span class="number">1585239068</span> <span class="number">2020</span>/<span class="number">03</span>/<span class="number">27</span> <span class="number">00</span>:<span class="number">11</span>:<span class="number">08</span> <span class="number">4256</span> <span class="number">4006</span> (bash) S n y <span class="number">1758081744</span> <span class="number">1758081744</span> <span class="number">64</span>      <span class="number">64</span>              <span class="number">48</span> <span class="number">4006</span> n y</span><br><span class="line">last line <span class="string">&#x27;y&#x27;</span> means <span class="keyword">not</span> thread</span><br><span class="line"></span><br><span class="line">$ atop -d -c -PPRD <span class="number">1</span> <span class="number">1</span>  | awk <span class="string">&#x27;NF&gt;10 &#123;if($(NF-6)+$(NF-4)&gt;120000) &#123;if($NF==&quot;y&quot;) print $0&#125;&#125;&#x27;</span> </span><br><span class="line"># show the proc/thread read <span class="keyword">or</span> write &gt; <span class="number">60</span>MB</span><br></pre></td></tr></table></figure><h3 id="time"><a href="#time" class="headerlink" title="time"></a>time</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/time -f <span class="string">&quot;%E real,%U user,%S sys&quot;</span> sleep 2</span><br><span class="line">0:02.00 real,0.00 user,0.00 sys</span><br><span class="line"></span><br><span class="line">$ /usr/bin/time -f <span class="string">&quot;%e real&quot;</span> sleep 70</span><br><span class="line">70.00 real</span><br></pre></td></tr></table></figure><h3 id="youtube-download"><a href="#youtube-download" class="headerlink" title="youtube download"></a>youtube download</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ proxychains4 youtube-dl -F https://www.youtube.com/watch?v=_xxxxxx</span><br><span class="line">[info] Available formats <span class="keyword">for</span> _12OJxATpsA:</span><br><span class="line">format code  extension  resolution note</span><br><span class="line">249          webm       audio only tiny   62k , opus @ 50k (48000Hz), 51.86MiB</span><br><span class="line">250          webm       audio only tiny   81k , opus @ 70k (48000Hz), 68.24MiB</span><br><span class="line">140          m4a        audio only tiny  136k , m4a_dash container, mp4a.40.2@128k (44100Hz), 139.88MiB</span><br><span class="line">251          webm       audio only tiny  158k , opus @160k (48000Hz), 136.13MiB</span><br><span class="line">278          webm       256x144    144p  103k , webm container, vp9, 30fps, video only, 100.43MiB</span><br><span class="line">160          mp4        256x144    144p  115k , avc1.4d400c, 30fps, video only, 83.46MiB</span><br><span class="line">242          webm       426x240    240p  250k , vp9, 30fps, video only, 202.66MiB</span><br><span class="line">133          mp4        426x240    240p  257k , avc1.4d4015, 30fps, video only, 168.64MiB</span><br><span class="line">243          webm       640x360    360p  611k , vp9, 30fps, video only, 377.13MiB</span><br><span class="line">134          mp4        640x360    360p  665k , avc1.4d401e, 30fps, video only, 442.58MiB</span><br><span class="line">244          webm       854x480    480p 1052k , vp9, 30fps, video only, 677.08MiB</span><br><span class="line">135          mp4        854x480    480p 1343k , avc1.4d401f, 30fps, video only, 868.67MiB</span><br><span class="line">247          webm       1280x720   720p 2410k , vp9, 30fps, video only, 1.35GiB</span><br><span class="line">136          mp4        1280x720   720p 2678k , avc1.4d401f, 30fps, video only, 1.66GiB</span><br><span class="line">248          webm       1920x1080  1080p 4356k , vp9, 30fps, video only, 2.42GiB</span><br><span class="line">137          mp4        1920x1080  1080p 4525k , avc1.640028, 30fps, video only, 3.06GiB</span><br><span class="line">271          webm       2560x1440  1440p 9330k , vp9, 30fps, video only, 7.15GiB</span><br><span class="line">18           mp4        640x360    360p  622k , avc1.42001E, mp4a.40.2@ 96k (44100Hz), 685.04MiB</span><br><span class="line">22           mp4        1280x720   720p 1673k , avc1.64001F, mp4a.40.2@192k (44100Hz) (best)</span><br><span class="line"></span><br><span class="line">$ proxychains4 youtube-dl -f 137+bestaudio --merge-output-format mkv https://www.youtube.com/watch?v=_xxxxxx</span><br></pre></td></tr></table></figure><h3 id="uptime-and-vmstat-running"><a href="#uptime-and-vmstat-running" class="headerlink" title="uptime and vmstat running"></a>uptime and vmstat running</h3><ul><li><p>(uptime) number of processes that are either in a runnable or uninterruptable state.</p><ul><li>runnable state is either using the CPU or waiting to use the  CPU. <ul><li>A process in uninterruptable state is waiting for some I/O access.</li></ul></li></ul></li><li><p>(vmstat) Procs r: The number of runnable processes (running or waiting for run time, no contains uninterruptable state)</p></li></ul><h3 id="kernel-do-IRQ-X-Y-No-irq-handler-for-vector-irq-1"><a href="#kernel-do-IRQ-X-Y-No-irq-handler-for-vector-irq-1" class="headerlink" title="kernel: do_IRQ: X.Y No irq handler for vector (irq -1)"></a>kernel: do_IRQ: X.Y No irq handler for vector (irq -1)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * do_IRQ handles all normal device IRQ&#x27;s (the special</span></span><br><span class="line"><span class="comment"> * SMP cross-CPU interrupts have their own specific</span></span><br><span class="line"><span class="comment"> * handlers).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">__visible <span class="keyword">void</span> __irq_entry <span class="title">do_IRQ</span><span class="params">(struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> *<span class="title">old_regs</span> = <span class="title">set_irq_regs</span>(<span class="title">regs</span>);</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> * <span class="title">desc</span>;</span></span><br><span class="line"><span class="comment">/* high bit used in ret_from_ code  */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="built_in">vector</span> = ~regs-&gt;orig_ax;</span><br><span class="line"></span><br><span class="line">entering_irq();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* entering_irq() tells RCU that we&#x27;re not quiescent.  Check it. */</span></span><br><span class="line">RCU_LOCKDEP_WARN(!rcu_is_watching(), <span class="string">&quot;IRQ failed to wake up RCU&quot;</span>);</span><br><span class="line"></span><br><span class="line">desc = __this_cpu_read(vector_irq[<span class="built_in">vector</span>]);</span><br><span class="line"><span class="keyword">if</span> (likely(!IS_ERR_OR_NULL(desc))) &#123;</span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_X86_32))</span><br><span class="line">handle_irq(desc, regs);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">generic_handle_irq_desc(desc);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ack_APIC_irq();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (desc == VECTOR_UNUSED) &#123;</span><br><span class="line">pr_emerg_ratelimited(<span class="string">&quot;%s: %d.%d No irq handler for vector\n&quot;</span>,</span><br><span class="line">     __func__, smp_processor_id(),</span><br><span class="line">     <span class="built_in">vector</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">__this_cpu_write(vector_irq[<span class="built_in">vector</span>], VECTOR_UNUSED);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exiting_irq();</span><br><span class="line"></span><br><span class="line">set_irq_regs(old_regs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>system log</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Tue Apr 28 09:09:19 2020] do_IRQ: 6.95 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:23:21 2020] do_IRQ: 2.163 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:38:13 2020] do_IRQ: 2.151 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:48:55 2020] do_IRQ: 0.155 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:49:25 2020] do_IRQ: 2.205 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:51:51 2020] do_IRQ: 4.123 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 09:53:05 2020] do_IRQ: 2.208 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 10:29:52 2020] do_IRQ: 6.180 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 10:41:23 2020] do_IRQ: 2.133 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:30:06 2020] do_IRQ: 6.191 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:39:22 2020] do_IRQ: 4.234 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:42:23 2020] do_IRQ: 0.137 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:46:53 2020] do_IRQ: 2.38 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 11:57:25 2020] do_IRQ: 6.98 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 12:35:11 2020] do_IRQ: 4.121 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 12:39:12 2020] do_IRQ: 2.163 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 13:05:26 2020] do_IRQ: 0.223 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:00:30 2020] do_IRQ: 6.91 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:08:06 2020] do_IRQ: 0.159 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line">[Tue Apr 28 14:26:09 2020] do_IRQ: 6.110 No irq handler <span class="keyword">for</span> vector (irq -1)</span><br><span class="line"></span><br><span class="line">$ grep -wEi <span class="string">&#x27;95|98|38|91|121|163&#x27;</span> /proc/interrupts</span><br><span class="line">  38:   98081083          0  142920345          0  123688922          0  172399026          0   PCI-MSI-edge      0000:00:11.4</span><br><span class="line">  91:         34          0         11          0         23          0         18          0   PCI-MSI-edge      em4-fp-7</span><br><span class="line"></span><br><span class="line">00:11.4 SATA controller: Intel Corporation C610/X99 series chipset sSATA Controller [AHCI mode] (rev 05)</span><br></pre></td></tr></table></figure><ul><li><p>Hardware issue # ipmi elist is ok</p></li><li><p>The hardware driver register num overflow</p></li><li><p>The hardware driver/firmware bug cause responds hobbledown</p></li><li><p>The bad APIC(programmable interrupt controller) got the wrong IRQ number</p><ul><li>disable APIC,  noapic pci=nomsi,noaer,acpi=off</li></ul></li></ul><h3 id="multipath-issue"><a href="#multipath-issue" class="headerlink" title="multipath issue"></a><a href="https://access.redhat.com/solutions/2437991">multipath issue</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: blk_cloned_rq_check_limits: over max size <span class="built_in">limit</span>.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: device-mapper: multipath: Failing path 70:64.</span><br><span class="line">Jun 14 09:33:38 testhost kernel: device-mapper: multipath: Failing path 71:80.</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: 70:64: mark as failed</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: nsd_crs_04: remaining active paths: 1</span><br><span class="line">Jun 14 09:33:38 testhost multipathd: 71:80: mark as failed</span><br><span class="line"></span><br><span class="line">$ cat /etc/udev/rules.d/99-custom.rules <span class="comment"># lfs must set to 16383</span></span><br><span class="line">ACTION!=<span class="string">&quot;add|change&quot;</span>, GOTO=<span class="string">&quot;rule_end&quot;</span> ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;NETAPP*&quot;</span>,  RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 16383 &gt; /sys%p/queue/max_sectors_kb&#x27;&quot;</span> LABEL=<span class="string">&quot;rule_end&quot;</span></span><br><span class="line"></span><br><span class="line">or you could add <span class="string">&quot; max_sectors_kb          16383 &quot;</span> to multipath.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">### add to initramfs</span></span><br><span class="line">$ cp  -av  /boot/initramfs-$(uname -r).img  /boot/initramfs-$(uname -r).img.bak</span><br><span class="line">dracut -f -v -i /etc/udev/rules.d/99-custom.rules /etc/udev/rules.d/99-custom.rules</span><br><span class="line">or</span><br><span class="line">dracut -f -v -i /etc/udev/rules.d/99-custom.rules /etc/multipath.conf</span><br></pre></td></tr></table></figure><h3 id="sshfs"><a href="#sshfs" class="headerlink" title="sshfs"></a>sshfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sshfs testuser@<span class="variable">$&#123;server_ip&#125;</span>:/sshfs /Users/<span class="built_in">test</span>/Downloads -o noatime</span><br></pre></td></tr></table></figure><h3 id="scan-file-size"><a href="#scan-file-size" class="headerlink" title="scan file size"></a>scan file size</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find /tank -<span class="built_in">printf</span> <span class="string">&#x27;%p\t%Y\t%b\t%s\t%U\t%G\t%A@\n&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="System-err-for-monitor"><a href="#System-err-for-monitor" class="headerlink" title="System err for monitor"></a>System err for monitor</h3><p>scsi:<br>has been suspended<br>attempting host reset<br>mpt.*sas_cm.*Command Timeout<br>Medium.*Error<br>Unrecovered</p><p>kernel:<br>Got BUG: soft lockup<br>NMI watchdog.*BUG</p><p>mem:<br>page allocation failure<br>Err.*bit ECC</p><p>irq:<br>No irq handler for vector</p><p>nvme:<br>nvme nvme.*I/O.*timeout, aborting<br>reset controller<br>Device not ready; aborting reset<br>probe failure status</p><p>kernel:<br>INFO: task xxx:xxx blocked for more than 120 seconds.<br>kernel process or thread hang, could not be wake up at 120s<br>    hungtask<br>        hung_task_panic        0<br>        hung_task_check_count  32768<br>        hung_task_timeout_secs 120s<br>        hung_task_warnings     10x times</p><p>softlockup<br>NMI watchdog: BUG: soft lockup - CPU#0 stuck for 23s! [cat:153]<br>softlockup deadlock, check the kernel schdule is ok, if trigger the softlockup, the kernel could not be schduled.<br>When hrtimer wake up the kernel thread and update watchdog_touch_ts, if time now - watchdog_touch_ts &gt; timeout value, it will show this error, that mean schdule timeout.<br>/proc/sys/kernel/nmi_watchdog      hard lockup<br>/proc/sys/kernel/soft_watchdog     soft lockup<br>/proc/sys/kernel/watchdog          watchdog<br>/proc/sys/kernel/watchdog_cpumask  watchdog cpumaks<br>/proc/sys/kernel/watchdog_thresh   watchdog timeoout</p><p>softlockup : the kernel loop in kernel mode without giving other tasks a chance to run, a kernel task wont be unlock the CPU.<br>             A soft lockup is when a running task is executing kernel code and wont yield the CPU to allow other tasks to run.<br>             The default soft lockup threshold is 60 seconds for RHEL5/6 and 20 seconds on RHEL7.<br>hardlockup : the kernel loop in kernel mode without letting other interrupts have change to run, the interrupts arent being processes.<br>             A hard lockup is when a CPU has interrupts disabled for a long time, which might block important communication between processes or hardware.<br>             The default hard lockup threshold is 30 second on RHEL5/6 and 10 seconds on RHEL7.</p><p>In redhat <a href="https://access.redhat.com/articles/1353303">doc</a><br>Each CPU has registered its own high resolution timer and both hard and soft lockup detection are closely connected with it.<br>This timer is fired approximately every [watchdog_thresh * 2 / 5]-seconds and does mainly three things:</p><ol><li><p>Wakes up a CPU specific watchdog task with the highest possible priority, in order to get scheduled as soon as possible. This tasks main job is to update a PER_CPU timestamp called watchdog_touch_ts.</p></li><li><p>Checks if watchdog_touch_ts + watchdog_thresh is smaller than current actual time. If yes, or in other words, if the watchdog task didnt run for longer than watchdog_thresh, then a soft lockup is reported.</p></li><li><p>Increments a CPU specific interrupt counter called hrtimer_interrupts, denoting that an interrupt happened on the CPU.</p></li></ol><p>Detecting a hard lockup is a bit trickier, since the CPU is stuck and has disabled interrupts. In order to detect it, each CPU has registered a watchdog perf event, which ensures that the CPU hardware issues an NMI (non-maskable interrupt) every [hard lockup threshold]-seconds. Generally approximately 2-3 high resolution timer interrupts are supposed to happen in-between 2 of these NMIs.<br>The handler function of this NMI will check the hrtimer_interrupts counter and copy-save its current value. If it sees the same value as it has saved before, it reports a hard lockup, because it means that no interrupt happened during [hard lockup threshold]-seconds.</p><p>Usually a CPU lockup is caused by a task stuck in a loop. Sometimes its due to a code loop where the termination condition has not yet been met. For example it may be an unbounded list (ie while !list_empty()). In cases like this the code should limit the maximum iterations of the loop before voluntarily yielding the CPU (ie cond_resched()).</p><p>Often CPU lockups are caused by tasks trying to acquire a spinlock that for some reason cannot be acquired in a reasonable time. This could be due to current owner of the lock not relinquishing the lock or it may be a case of starvation where excessive activity on the lock delays some tasks long enough to exceed the watchdog threshold (ie RHEL5 spinlocks on numa).</p><p>Other cases involve a loop where the termination condition is never going to be met. For example the code expects a state change that isnt going to happen.</p><p>Its also possible to get false reports from the watchdog on virtual machines where the host system stalls the guest for longer than the watchdog threshold period. The watchdog will think the guest has been running during that time but the CPUs have not been able to make progress.</p><p>##default is enabled<br>$ sysctl kernel.softlockup_panic kernel.hardlockup_panic<br>kernel.softlockup_panic = 0<br>kernel.hardlockup_panic = 0</p><p>##disable, there is no soft lockup watchdog here<br>echo 1 &gt; /proc/sys/kernel/softlockup_panic</p><p><a href="https://blog.seibert-media.com/2018/01/04/log-book-linux-cpu-lockups/#:~:text=A%20'hard%20lockup'%20is%20defined,the%20good%20old%20DOS%20days.">Provoke lockups with your own kernel module</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hog.c</span></span><br><span class="line"><span class="comment">#include &lt;linux/init.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/module.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/kernel.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/kthread.h&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="string">MODULE_LICENSE(&quot;GPL&quot;);</span></span><br><span class="line"> </span><br><span class="line"><span class="string">static</span> <span class="string">int</span></span><br><span class="line"><span class="string">hog_thread(void</span> <span class="string">*data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">printk(KERN_INFO</span> <span class="string">&quot;Hogging a CPU now\n&quot;</span><span class="string">);</span></span><br><span class="line">    <span class="string">while</span> <span class="string">(1);</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">/*</span> <span class="string">unreached</span> <span class="string">*/</span></span><br><span class="line">    <span class="string">return</span> <span class="number">0</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">static</span> <span class="string">int</span> <span class="string">__init</span></span><br><span class="line"><span class="string">hog_init(void)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">kthread_run(hog_thread</span>, <span class="literal">NULL</span>, <span class="string">&quot;hog&quot;</span><span class="string">);</span></span><br><span class="line">    <span class="string">return</span> <span class="number">0</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">module_init(hog_init);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#makefile</span></span><br><span class="line"><span class="string">obj-m</span> <span class="string">+=</span> <span class="string">hog.o</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">    <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(shell</span> <span class="string">uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(PWD)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">clean:</span></span><br><span class="line">    <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(shell</span> <span class="string">uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(PWD)</span> <span class="string">clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in centos </span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">Makefile</span></span><br><span class="line"><span class="string">obj-m</span> <span class="string">+=</span> <span class="string">hog.o</span></span><br><span class="line"></span><br><span class="line"><span class="attr">all:</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">clean:</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">clean</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">make</span> <span class="string">-C</span> <span class="string">/lib/modules/$(uname</span> <span class="string">-r)/build/</span> <span class="string">M=$(pwd)</span> <span class="string">modules</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">Entering</span> <span class="string">directory</span> <span class="string">`/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span></span><br><span class="line">  <span class="string">CC</span> [<span class="string">M</span>]  <span class="string">/root/hog/hog.o</span></span><br><span class="line">  <span class="string">Building</span> <span class="string">modules,</span> <span class="string">stage</span> <span class="number">2</span><span class="string">.</span></span><br><span class="line">  <span class="string">MODPOST</span> <span class="number">1</span> <span class="string">modules</span></span><br><span class="line">  <span class="string">CC</span>      <span class="string">/root/hog/hog.mod.o</span></span><br><span class="line">  <span class="string">LD</span> [<span class="string">M</span>]  <span class="string">/root/hog/hog.ko</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">Leaving</span> <span class="string">directory</span> <span class="string">`/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ls</span> </span><br><span class="line"><span class="string">hog.c</span>  <span class="string">hog.ko</span>  <span class="string">hog.mod.c</span>  <span class="string">hog.mod.o</span>  <span class="string">hog.o</span>  <span class="string">Makefile</span>  <span class="string">modules.order</span>  <span class="string">Module.symvers</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">insmod</span> <span class="string">hog.ko</span></span><br><span class="line"><span class="string">$</span> <span class="string">lsmod</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">hog</span></span><br><span class="line"><span class="string">hog</span>                    <span class="number">12386</span>  <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">kernel:NMI watchdog: BUG:</span> <span class="string">soft</span> <span class="string">lockup</span> <span class="bullet">-</span> <span class="string">CPU#0</span> <span class="string">stuck</span> <span class="string">for</span> <span class="string">23s!</span> [<span class="string">hog:2308</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">NMI watchdog: BUG:</span> <span class="string">soft</span> <span class="string">lockup</span> <span class="bullet">-</span> <span class="string">CPU#0</span> <span class="string">stuck</span> <span class="string">for</span> <span class="string">23s!</span> [<span class="string">hog:2308</span>]</span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Modules linked in:</span> <span class="string">hog(OE)</span> <span class="string">dell_rbu</span> <span class="string">dcdbas</span> <span class="string">sunrpc</span> <span class="string">nfit</span> <span class="string">libnvdimm</span> <span class="string">zfs(POE)</span> <span class="string">zunicode(POE)</span> <span class="string">zavl(POE)</span> <span class="string">icp(POE)</span> <span class="string">ppdev</span> <span class="string">iosf_mbi</span> <span class="string">crc32_pclmul</span> <span class="string">ghash_clmulni_intel</span> <span class="string">joydev</span> <span class="string">zcommon(POE)</span> <span class="string">znvpair(POE)</span> <span class="string">spl(OE)</span> <span class="string">sg</span> <span class="string">aesni_intel</span> <span class="string">virtio_balloon</span> <span class="string">virtio_rng</span> <span class="string">lrw</span> <span class="string">gf128mul</span> <span class="string">glue_helper</span> <span class="string">ablk_helper</span> <span class="string">cryptd</span> <span class="string">pcspkr</span> <span class="string">i2c_piix4</span> <span class="string">parport_pc</span> <span class="string">parport</span> <span class="string">binfmt_misc</span> <span class="string">ip_tables</span> <span class="string">xfs</span> <span class="string">libcrc32c</span> <span class="string">sr_mod</span> <span class="string">sd_mod</span> <span class="string">cdrom</span> <span class="string">crc_t10dif</span> <span class="string">crct10dif_generic</span> <span class="string">ata_generic</span> <span class="string">pata_acpi</span> <span class="string">virtio_console</span> <span class="string">virtio_net</span> <span class="string">virtio_blk</span> <span class="string">virtio_scsi</span> <span class="string">qxl</span> <span class="string">drm_kms_helper</span> <span class="string">syscopyarea</span> <span class="string">sysfillrect</span> <span class="string">sysimgblt</span> <span class="string">fb_sys_fops</span> <span class="string">ttm</span> <span class="string">drm</span> <span class="string">crct10dif_pclmul</span> <span class="string">crct10dif_common</span> <span class="string">crc32c_intel</span> <span class="string">ata_piix</span> <span class="string">ahci</span> <span class="string">libahci</span> <span class="string">libata</span> <span class="string">serio_raw</span> <span class="string">virtio_pci</span> <span class="string">virtio_ring</span> <span class="string">virtio</span> <span class="string">floppy</span> <span class="string">drm_panel_orientation_quirks</span> <span class="string">dm_mirror</span> <span class="string">dm_region_hash</span> <span class="string">dm_log</span> <span class="string">dm_mod</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CPU: 0 PID: 2308 Comm: hog Kdump: loaded Tainted:</span> <span class="string">P</span>           <span class="string">OE</span>  <span class="string">------------</span>   <span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span><span class="string">.el7.x86_64</span> <span class="comment">#1</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Hardware name:</span> <span class="string">Red</span> <span class="string">Hat</span> <span class="string">KVM,</span> <span class="string">BIOS</span> <span class="number">1.11</span><span class="number">.1</span><span class="number">-4.</span><span class="string">module_el8.0.0+189+f9babebb</span> <span class="number">04</span><span class="string">/01/2014</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">task: ffff9c0335878000 ti: ffff9c03356a4000 task.ti:</span> <span class="string">ffff9c03356a4000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RIP:</span> <span class="number">0010</span><span class="string">:[&lt;ffffffffc0721017&gt;]</span>  [<span class="string">&lt;ffffffffc0721017&gt;</span>] <span class="string">hog_thread+0x17/0x1000</span> [<span class="string">hog</span>]</span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RSP: 0018:ffff9c03356a7ec0  EFLAGS:</span> <span class="number">00000246</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RAX: 0000000000000011 RBX: ffff9c03356a7e50 RCX:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RDX: 0000000000000000 RSI: ffff9c033dc13898 RDI:</span> <span class="string">ffff9c033dc13898</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">RBP: ffff9c03356a7ec0 R08: 0000000000000000 R09:</span> <span class="number">0000000000000040</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">R10: 000000000000029a R11: 0000000000aaaaaa R12:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">R13: ffffffffc0721000 R14: 0000000000000000 R15:</span> <span class="string">ffff9c03352ebc90</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">FS:</span>  <span class="number">0000000000000000</span><span class="string">(0000)</span> <span class="string">GS:ffff9c033dc00000(0000)</span> <span class="string">knlGS:0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CS:  0010 DS: 0000 ES: 0000 CR0:</span> <span class="number">0000000080050033</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">CR2: 0000561560589e20 CR3: 0000000006010000 CR4:</span> <span class="string">00000000003606f0</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">DR0: 0000000000000000 DR1: 0000000000000000 DR2:</span> <span class="number">0000000000000000</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7:</span> <span class="number">0000000000000400</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Call Trace:</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c50d1&gt;</span>] <span class="string">kthread+0xd1/0xe0</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c5000&gt;</span>] <span class="string">?</span> <span class="string">insert_kthread_work+0x40/0x40</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa0f8cd37&gt;</span>] <span class="string">ret_from_fork_nospec_begin+0x21/0x21</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>]  [<span class="string">&lt;ffffffffa08c5000&gt;</span>] <span class="string">?</span> <span class="string">insert_kthread_work+0x40/0x40</span></span><br><span class="line">[<span class="string">Mon</span> <span class="string">Jun</span>  <span class="number">8</span> <span class="number">03</span><span class="string">:32:28</span> <span class="number">2020</span>] <span class="attr">Code:</span> <span class="string">&lt;eb&gt;</span> <span class="string">fe</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p>Enable nmi_watchdog=1 in kernel</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat hard.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"> </span><br><span class="line">static int</span><br><span class="line">hog_thread(void *data)</span><br><span class="line">&#123;</span><br><span class="line">    static DEFINE_SPINLOCK(lock);</span><br><span class="line">    unsigned long flags;</span><br><span class="line"> </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hogging a CPU now\n&quot;</span>);</span><br><span class="line">    spin_lock_irqsave(<span class="variable">&amp;lock</span>, flags);</span><br><span class="line">    while (<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* unreached */</span></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static int __init</span><br><span class="line">hog_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    kthread_run(hog_thread, NULL, <span class="string">&quot;hog&quot;</span>);</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hog_init);</span><br><span class="line"></span><br><span class="line">obj-m += hard.o</span><br><span class="line"></span><br><span class="line"><span class="symbol">all:</span> make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) modules</span><br><span class="line"><span class="symbol">clean:</span> make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) clean</span><br><span class="line"></span><br><span class="line">$  make -C <span class="meta-keyword">/lib/</span>modules/$(uname -r)<span class="meta-keyword">/build/</span> M=$(pwd) modules</span><br><span class="line"><span class="symbol">make:</span> Entering directory `<span class="meta-keyword">/usr/</span>src<span class="meta-keyword">/kernels/</span><span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span>.el7.x86_64&#x27;</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>hardhog/hard.o</span><br><span class="line">  Building modules, stage <span class="number">2.</span></span><br><span class="line">  MODPOST <span class="number">1</span> modules</span><br><span class="line">  CC      <span class="meta-keyword">/root/</span>hardhog/hard.mod.o</span><br><span class="line">  LD [M]  <span class="meta-keyword">/root/</span>hardhog/hard.ko</span><br><span class="line"></span><br><span class="line">$ insmod hard.ko</span><br><span class="line"></span><br><span class="line"><span class="meta"># after insmod, the KVM ssh not respond too.</span></span><br></pre></td></tr></table></figure><p><a href="https://kernelnewbies.org/FAQ/FastpathAndSlowpath">In general</a>, fast path is the commonly run code that should finish very quickly. For example, when it comes to spinlocks the fast path is that nobody is holding the spinlock and the CPU that wants it can just take it.<br>Conversely, the slow path for spinlocks is that the lock is already taken by somebody else and the CPU will have to wait for the lock to be freed.<br>The first case is the common one that should be optimized.<br>The second one is not as important and does not need to be optimized much at all.</p><h3 id="cgroup-limit-resource"><a href="#cgroup-limit-resource" class="headerlink" title="cgroup limit resource"></a>cgroup limit resource</h3><p>limit memory size</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cgcreate -g memory:DBLimitedGroup</span><br><span class="line">$ <span class="built_in">echo</span> 16G &gt; /sys/fs/cgroup/memory/DBLimitedGroup/memory.limit_in_bytes</span><br><span class="line">$ sync; <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ cgclassify -g memory:DBLimitedGroup $(pid)</span><br></pre></td></tr></table></figure><h3 id="About-WB-SYNC-NONE-and-WB-SYNC-ALL"><a href="#About-WB-SYNC-NONE-and-WB-SYNC-ALL" class="headerlink" title="About WB_SYNC_NONE and WB_SYNC_ALL"></a>About WB_SYNC_NONE and WB_SYNC_ALL</h3><p><a href="https://elixir.bootlin.com/linux/v3.10.108/source/fs/fs-writeback.c#L140">https://elixir.bootlin.com/linux/v3.10.108/source/fs/fs-writeback.c#L140</a><br>/**</p><ul><li>bdi_start_writeback - start writeback</li><li>@bdi: the backing device to write from</li><li>@nr_pages: the number of pages to write</li><li>@reason: reason why some writeback work was initiated</li><li></li><li>Description:</li><li>This does WB_SYNC_NONE opportunistic writeback. The IO is only</li><li>started when this function returns, we make no guarantees on</li><li>completion. Caller need not hold sb s_umount semaphore.</li><li></li><li>/</li></ul><p><a href="https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/writeback.h#L34">https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/writeback.h#L34</a></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">writeback_sync_modes</span> &#123;</span></span><br><span class="line">WB_SYNC_NONE,<span class="regexp">/* Don&#x27;t wait on anything */</span></span><br><span class="line">WB_SYNC_ALL,<span class="regexp">/* Wait on every mapping */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><h4 id="ldd"><a href="#ldd" class="headerlink" title="ldd"></a>ldd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ldd /bin/ls</span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007fff59353000)</span><br><span class="line">libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007fa12b999000)</span><br><span class="line">libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007fa12b794000)</span><br><span class="line">libacl.so.1 =&gt; /lib64/libacl.so.1 (0x00007fa12b58b000)</span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fa12b1bd000)</span><br><span class="line">libpcre.so.1 =&gt; /lib64/libpcre.so.1 (0x00007fa12af5b000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007fa12ad57000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007fa12bbc0000)</span><br><span class="line">libattr.so.1 =&gt; /lib64/libattr.so.1 (0x00007fa12ab52000)</span><br><span class="line">libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fa12a936000)</span><br></pre></td></tr></table></figure><h4 id="Read-ELF-Executable-and-Linking-Format"><a href="#Read-ELF-Executable-and-Linking-Format" class="headerlink" title="Read ELF(Executable and Linking Format)"></a>Read ELF(Executable and Linking Format)</h4><p>Relocatable file (eg: xx.o)<br>Executable file<br>Dynamic Linking Library (eg: xx.so)<br>Static Linking Library  (eg: xx.a)</p><p>ELF Header<br>ELF Program Header Table/Program Headers<br>ELF Section Header Table/Section Headers<br>ELF Sections<br>multiple sections merge to a segment</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -h /bin/ls</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              EXEC (Executable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x404324</span></span><br><span class="line"><span class="string">  Start of program headers:          64 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          115688 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           56 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         9</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         30</span></span><br><span class="line"><span class="string">  Section header string table index: 29</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$  readelf -S /bin/ls | grep debug</span></span><br><span class="line"><span class="string">  [27] .gnu_debuglink    PROGBITS         0000000000000000  0001b600</span></span><br><span class="line"><span class="string">  [28] .gnu_debugdata    PROGBITS         0000000000000000  0001b610 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf -all /bin/ls</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure><h4 id="objdump"><a href="#objdump" class="headerlink" title="objdump"></a>objdump</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -i </span><br><span class="line"><span class="comment"># Display a list showing all architectures and object formats available for specification with -b or -m.</span></span><br><span class="line">...</span><br><span class="line">$ gcc -O2 -ggdb3 -c -o sort.o sort.c</span><br><span class="line">$ objdump -d sort.o</span><br><span class="line"><span class="comment">#Display the assembler mnemonics for the machine instructions from objfile</span></span><br><span class="line"></span><br><span class="line">sort.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;sort&gt;:</span><br><span class="line">   0:31 c0                xor    %eax,%eax</span><br><span class="line">   2:b9 01 00 00 00       mov    <span class="variable">$0x1</span>,%ecx</span><br><span class="line">   7:83 f8 1e             cmp    <span class="variable">$0x1e</span>,%eax</span><br><span class="line">   a:7e 0b                jle    17 &lt;sort+0x17&gt;</span><br><span class="line">   c:84 c9                <span class="built_in">test</span>   %cl,%cl</span><br><span class="line">   e:75 36                jne    46 &lt;sort+0x46&gt;</span><br><span class="line">  10:b9 01 00 00 00       mov    <span class="variable">$0x1</span>,%ecx</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ objdump -t sort.o</span><br><span class="line"><span class="comment"># Print the symbol table entries of the file</span></span><br><span class="line"></span><br><span class="line">sort.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line">0000000000000000 l    df *ABS*0000000000000000 sort.c</span><br><span class="line">0000000000000000 l    d  .text0000000000000000 .text</span><br><span class="line">0000000000000000 l    d  .data0000000000000000 .data</span><br><span class="line">0000000000000000 l    d  .bss0000000000000000 .bss</span><br><span class="line">0000000000000000 l    d  .rodata.str1.10000000000000000 .rodata.str1.1</span><br><span class="line">0000000000000000 l    d  .text.startup0000000000000000 .text.startup</span><br><span class="line">0000000000000000 l    d  .debug_info0000000000000000 .debug_info</span><br><span class="line">0000000000000000 l    d  .debug_abbrev0000000000000000 .debug_abbrev</span><br><span class="line">0000000000000000 l    d  .debug_loc0000000000000000 .debug_loc</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="nm"><a href="#nm" class="headerlink" title="nm"></a>nm</h4><p>list symbols from object files</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ nm ./walk</span><br><span class="line">                 U <span class="symbol">atoi@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a4 B __bss_start</span><br><span class="line">                 U <span class="symbol">closedir@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a8 b completed<span class="number">.6355</span></span><br><span class="line"><span class="number">00000000006020</span>a0 D __data_start</span><br><span class="line"><span class="number">00000000006020</span>a0 W data_start</span><br><span class="line"><span class="number">0000000000400880</span> t deregister_tm_clones</span><br><span class="line"><span class="number">00000000004008f</span>0 t __do_global_dtors_aux</span><br><span class="line"><span class="number">0000000000601e18</span> t __do_global_dtors_aux_fini_array_entry</span><br><span class="line"><span class="number">0000000000400</span>d18 R __dso_handle</span><br><span class="line"></span><br><span class="line">$ nm -e ./walk</span><br><span class="line">                 U <span class="symbol">atoi@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a4 B __bss_start</span><br><span class="line">                 U <span class="symbol">closedir@</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">00000000006020</span>a8 b completed<span class="number">.6355</span></span><br><span class="line"><span class="number">00000000006020</span>a0 D __data_start</span><br><span class="line"><span class="number">00000000006020</span>a0 W data_start</span><br><span class="line"><span class="number">0000000000400880</span> t deregister_tm_clones</span><br><span class="line"><span class="number">00000000004008f</span>0 t __do_global_dtors_aux</span><br><span class="line"><span class="number">0000000000601e18</span> t __do_global_dtors_aux_fini_array_entry</span><br><span class="line"><span class="number">0000000000400</span>d18 R __dso_handle</span><br></pre></td></tr></table></figure><p>kernel symbol table</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$  grep CONFIG_KALLSYMS /boot/config<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1062.18</span><span class="number">.1</span>.el7.x86_64</span><br><span class="line">CONFIG_KALLSYMS=y</span><br><span class="line">CONFIG_KALLSYMS_ALL=y</span><br><span class="line"></span><br><span class="line">$ grep <span class="string">&quot; tcp_v4_do_rcv&quot;</span>  /<span class="keyword">proc</span>/kallsyms</span><br><span class="line">ffffffff936c0c70<span class="title"> T</span> tcp_v4_do_rcv</span><br><span class="line">##<span class="title"> Why</span> addr<span class="title"> is</span> change ?</span><br><span class="line"></span><br><span class="line">$<span class="title"> grep</span> CONFIG_RANDOMIZE_BASE /boot/config-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">CONFIG_RANDOMIZE_BASE=y</span><br><span class="line"></span><br><span class="line">##<span class="title"> ALL</span> info,<span class="title"> the</span> compiler<span class="title"> optimize</span> cause<span class="title"> some</span> symbols<span class="title"> missing</span> in<span class="title"> kallsyms</span></span><br><span class="line"><span class="title">$</span> grep &quot;<span class="title"> tcp_v4_do_rcv&quot;</span>  /boot/System.map-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">ffffffff816c0c70<span class="title"> T</span> tcp_v4_do_rcv</span><br></pre></td></tr></table></figure><p>uppercase: global(external) symbol<br>lowercase: local symbol<br>T The symbol is in the text(code) section<br>D The symbol is in the initialized data section<br>R The sysbol is in a read only data section<br>t static<br>d static<br>R const<br>r static const</p><h4 id="size"><a href="#size" class="headerlink" title="size"></a>size</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">size add_lock</span><br><span class="line">   text   data    bss    dec    hexfilename</span><br><span class="line">   5008    660      4   5672   1628add_lock</span><br></pre></td></tr></table></figure><p> ; code segment/text segment , <br> data segment <br>BSS . BSS bss segment BSS Block Started by Symbol BSS <br>heap low to high, malloc free <br>(stack)  high to low, {} static static / <br>, .</p><p>The heap is, generally speaking, one specific memory region created by the C runtime, and managed by malloc (which in turn uses the brk and sbrk system calls to grow and shrink).<br>mmap is a way of creating new memory regions, independently of malloc (and so independently of the heap). munmap is simply its inverse, it releases these regions.<br>Some picture show mmap high addr to low addr, same direction with stack</p><h3 id="process-schduler"><a href="#process-schduler" class="headerlink" title="process schduler"></a>process schduler</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ chrt -p <span class="variable">$pid</span></span><br><span class="line">$ chrt -m</span><br><span class="line">$ chrt [-b/-f/-o/-r/-i/-d] -p <span class="variable">$priority</span> <span class="variable">$pid</span></span><br><span class="line">-b SCHED_BATCH</span><br><span class="line">-f SCHED_FIFO</span><br><span class="line">-o SCHED_OTHER</span><br><span class="line">-r SCHED_RR</span><br><span class="line">-i SCHED_IDLE</span><br><span class="line">-d SCHED_DEADLINE</span><br></pre></td></tr></table></figure><h3 id="vim-jump-cursor"><a href="#vim-jump-cursor" class="headerlink" title="vim jump cursor"></a>vim jump cursor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:cal cursor(30, 5)</span><br></pre></td></tr></table></figure><h3 id="gpart-recovery-partition-table"><a href="#gpart-recovery-partition-table" class="headerlink" title="gpart recovery partition table"></a>gpart recovery partition table</h3><p>boot by freebsd livecd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gpart disk list</span><br><span class="line">$ gpart recover /dev/sda</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu</title>
      <link href="2019/07/18/ubuntu/"/>
      <url>2019/07/18/ubuntu/</url>
      
        <content type="html"><![CDATA[<h3 id="install-debug-kernel-info"><a href="#install-debug-kernel-info" class="headerlink" title="install debug kernel info"></a>install debug kernel info</h3><p>Download from <a href="http://ddebs.ubuntu.com/pool/main/l/linux/">http://ddebs.ubuntu.com/pool/main/l/linux/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">$ U=http://ddebs.ubuntu.com</span><br><span class="line">$ D=$(lsb_release -cs)</span><br><span class="line">$ cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/ddebs.list</span><br><span class="line">deb <span class="variable">$&#123;U&#125;</span> <span class="variable">$&#123;D&#125;</span> main restricted universe multiverse</span><br><span class="line"><span class="comment">#deb $&#123;U&#125; $&#123;D&#125;-security main restricted universe multiverse</span></span><br><span class="line">deb <span class="variable">$&#123;U&#125;</span> <span class="variable">$&#123;D&#125;</span>-updates main restricted universe multiverse</span><br><span class="line">deb <span class="variable">$&#123;U&#125;</span> <span class="variable">$&#123;D&#125;</span>-proposed main restricted universe multiverse</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ wget -O - http://ddebs.ubuntu.com/dbgsym-release-key.asc | apt-key add -</span><br><span class="line"></span><br><span class="line">$ apt install linux-image-`uname -r`-dbgsym build-essential build-essential</span><br><span class="line"></span><br><span class="line"><span class="comment">### or custom install kernel</span></span><br><span class="line">CONFIG_DEBUG_INFO</span><br><span class="line">CONFIG_KPROBES</span><br><span class="line">CONFIG_RELAY</span><br><span class="line">CONFIG_DEBUG_FS</span><br><span class="line">CONFIG_MODULES</span><br><span class="line">CONFIG_MODULE_UNLOAD</span><br><span class="line">CONFIG_UTRACE</span><br><span class="line"></span><br><span class="line">Kernel hacking  ---&gt;</span><br><span class="line">    [*] Kernel debugging</span><br><span class="line">        [*]   Compile the kernel with debug info</span><br><span class="line"></span><br><span class="line">Instrumentation Support  ---&gt;</span><br><span class="line">    [*] Kprobes (EXPERIMENTAL)</span><br><span class="line"></span><br><span class="line">General setup  ---&gt;</span><br><span class="line">    [*] Kernel-&gt;user space relay support (formerly relayfs)</span><br><span class="line"></span><br><span class="line">https://github.com/gatieme/LDD-LinuxDeviceDrivers/tree/master/study/debug/tools/systemtap/01-install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://www.hiroom2.com/2018/04/27/ubuntu-1804-dbgsym-en/</span><br><span class="line"></span><br><span class="line">$ gdb &lt;<span class="built_in">command</span>&gt; --directory /path/to/<span class="built_in">source</span></span><br><span class="line">&lt;snip&gt;</span><br><span class="line">(gdb)</span><br><span class="line">In <span class="keyword">case</span> of bash is as below.</span><br><span class="line"></span><br><span class="line">$ gdb bash --directory ~/bash/bash-4.4.18/</span><br><span class="line">&lt;snip&gt;</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x2fdb0: file .././shell.c, line 368.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /bin/bash</span><br><span class="line">Breakpoint 1, main (argc=1, argv=0x7fffffffe418, env=0x7fffffffe428) at</span><br><span class="line">.././shell.c:368</span><br><span class="line">368     &#123;</span><br><span class="line">(gdb) l</span><br><span class="line">363     int</span><br><span class="line">364     main (argc, argv, env)</span><br><span class="line">365          int argc;</span><br><span class="line">366          char **argv, **env;</span><br><span class="line">367     <span class="comment">#endif /* !NO_MAIN_ENV_ARG */</span></span><br><span class="line">368     &#123;</span><br><span class="line">369       register int i;</span><br><span class="line">370       int code, old_errexit_flag;</span><br><span class="line">371     <span class="comment">#if defined (RESTRICTED_SHELL)</span></span><br><span class="line">372       int saverst;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stress-ngstress, , </span><br><span class="line"></span><br><span class="line">2worker</span><br><span class="line"></span><br><span class="line">stress-ng -c 2 --cpu-method pi</span><br><span class="line">2worker30pi, crc16, fft</span><br><span class="line"></span><br><span class="line">stress-ng -c 2 --cpu-method all</span><br><span class="line">2workersocket</span><br><span class="line"></span><br><span class="line">stress-ng --sock 2</span><br><span class="line">2workertsc</span><br><span class="line"></span><br><span class="line">stress-ng --tsc 2</span><br><span class="line">strss-ngcpucpu 0,2,3,6</span><br><span class="line"></span><br><span class="line">stress-ng --sock 4 --taskset 0,2-3,6 </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Replace megaraid by strocli</title>
      <link href="2019/05/24/megaraid/"/>
      <url>2019/05/24/megaraid/</url>
      
        <content type="html"><![CDATA[<h3 id="Got-megaraid-log"><a href="#Got-megaraid-log" class="headerlink" title="Got megaraid log"></a>Got megaraid log</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">perccli64 /call show all logfile=megaraid.cfg</span><br><span class="line">perccli64 /call show events file=events.log</span><br><span class="line">perccli64 /call show termlog <span class="built_in">type</span>=config logfile=termlog.config</span><br><span class="line">perccli64 /call show termlog <span class="built_in">type</span>=contents logfile=termlog.contents</span><br><span class="line">perccli64 /call show eventloginfo</span><br><span class="line">perccli64 /call show dequeuelog file=dequeue.log</span><br><span class="line">perccli64 /call show alilog logfile=ali.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear the log</span></span><br><span class="line"><span class="comment">#perccli64 /c x set debug reset all</span></span><br><span class="line"><span class="comment">#perccli64 /call delete events</span></span><br><span class="line"><span class="comment">#perccli64 /call delete termlog</span></span><br></pre></td></tr></table></figure><h3 id="Set-time"><a href="#Set-time" class="headerlink" title="Set time"></a>Set time</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /call show time</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> time=yyyymmdd hh:mm:ss|systemtime</span><br><span class="line">$ timedatectl set-timezone Asia/XXXXXX</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> time=systemtime</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Set-cache-policy"><a href="#Set-cache-policy" class="headerlink" title="Set cache policy"></a>Set cache policy</h3><p>Disable write back cache</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0/v0 <span class="builtin-name">set</span> <span class="attribute">wrcache</span>=wb/wt/awb <span class="attribute">rdcache</span>=ra <span class="attribute">iopolicy</span>=cached <span class="attribute">pdcache</span>=on</span><br></pre></td></tr></table></figure><h3 id="Create-raid10"><a href="#Create-raid10" class="headerlink" title="Create raid10"></a>Create raid10</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 add vd <span class="built_in">type</span>=raid10 drives=252:0-7 pdperarray=2 WT strip=64</span><br><span class="line">$ storcli64 /c0 add vd <span class="built_in">type</span>=raid5 drives=252:0,2,4,6 WT strip=64</span><br><span class="line">$ storcli64 /c0/vXX del force</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0/e54/s43,44 add hotsparedrive <span class="comment">#global hs</span></span><br><span class="line">$ storcli64 /c0/e54/s43 add hotsparedrive dgs=0,1 <span class="comment">#as Dedicated Hot spare for disk groups 0,1</span></span><br><span class="line">$ storcli64 /c0/e54/s43 delete hotsparedrive <span class="comment">#deletes a hot spare drive</span></span><br></pre></td></tr></table></figure><p><a href="https://support.huawei.com/enterprise/en/doc/EDOC1000111853?section=j005">reference</a><br><img src="/img/lsi-3108-example-20191010.png"><br>Read Policy</p><ul><li>No Read Ahead: disables the Read Ahead function.</li><li>Read Ahead: enables the Read Ahead function. The controller pre-reads sequential data or the data predicted to be used and saves it in the cache.</li></ul><p>Write Policy</p><ul><li>Write Back: After the controller cache receives all data, the controller sends the host a message indicating that data transmission is complete.</li><li>Write Through: After the drive subsystem receives all data, the controller sends the host a message indicating that data transmission is complete.</li><li>Always Write Back: Virtual drive remains in Write Back mode if the capacitor fails or no capacitor exists.</li></ul><p>I/O Policy</p><ul><li>Direct: Data is read directly and is not cached. This is the recommended mode for common configuration.</li><li>Cached: All data is read from cache. This is the recommended mode for CacheCade.</li></ul><p>Access Policy</p><ul><li>Read/Write: Read and write operations are allowed.</li><li>Read Only: The virtual drive is read-only.</li><li>Blocked: The virtual drive is locked from access.</li></ul><p>Drive Cache</p><ul><li>Unchanged: uses the current cache policy.</li><li>Enable: writes data to the cache before writing data to the hard drive. This option improves data write performance. However, data may be lost if there is no protection mechanism against power failures.</li><li>Disable: writes data to a hard drive without caching the data. Data is not lost if power failures occur.</li></ul><p>Emulation Type<br>Set the sector size reported to the OS.<br>50</p><ul><li><p>If the member drive is 512B/512B:</p><ul><li>Default: The logical drive sector is 512B/512B.</li><li>None: The logical drive sector is 512B/512B.</li><li>Force: The logical drive sector is 512B/4KB.</li></ul></li><li><p>If the member drive is 512B/4KB:</p><ul><li>Default: The logical drive sector is 512B/4KB.</li><li>None: The logical drive sector is 512B/512B.</li><li>Force: The logical drive sector is 512B/4KB.</li></ul></li></ul><h3 id="Megaraid-FastPATH-for-SAS-SATA-SSD"><a href="#Megaraid-FastPATH-for-SAS-SATA-SSD" class="headerlink" title="Megaraid FastPATH for SAS/SATA SSD"></a>Megaraid FastPATH for SAS/SATA SSD</h3><h4 id="case-1"><a href="#case-1" class="headerlink" title="case 1"></a><a href="https://lenovopress.com/lp0592.pdf">case 1</a></h4><p>Suggest RAID5<br>To benefit from FastPath, an array must be defined using these specific parameters:</p><ul><li>Write Through</li><li>Direct IO</li><li>No Read Ahead</li><li>64KB stripe size (for most workloads)</li><li>RAID 5(fastpath support all raid level)</li><li>Disk Cache Policy: This controls the write cache policy for the drives in the arrays (as opposed to the write cache policy of the RAID adapter). Enabling disk write caching can put data at risk.<ul><li>full initialization</li></ul></li></ul><p>With FastPath enabled, and when certain conditions are met, the MegaRAID software stack running on the RAID controller can bypass portions of the software stack, resulting in a highly efficient, streamlined code path that the RAID controller can execute very quickly. This means that the RAID controller can handle more trips though its code in a given amount of time, which equates to higher possible IOPS.</p><p>FastPath is not designed to speed up slow storage. It will not have an effect on storage performance unless the RAID controller is the bottleneck. If the controller itself is limiting storage performance, then enabling FastPath will allow the controller to run faster, raising performance. FastPath is not meant for use with HDD storage nor is it meant for sequential workloads.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show aso</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Premium Feature Key :</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Adv S/W Opt                 Time Remaining  Mode</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">MegaRAID FastPath           Unlimited       Secured</span><br><span class="line">MegaRAID CacheCade Pro 2.0  Unlimited       Secured</span><br><span class="line">MegaRAID RAID6              Unlimited       Factory Installed</span><br><span class="line">MegaRAID RAID5              Unlimited       Factory Installed</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Re-host Information :</span><br><span class="line">===================</span><br><span class="line">Needs Re-hosting = NO</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line"><span class="comment">#### [Case 2: Aerospike Certification Tool](https://www.aerospike.com/docs/operations/plan/ssd/lsi_megacli.html)</span></span><br><span class="line">RAID Level0</span><br><span class="line">Write PolicyWrite Through</span><br><span class="line">Read PolicyNo Read Ahead</span><br><span class="line">IO PolicyDirect IO</span><br><span class="line">Other        No write to cache <span class="keyword">if</span> bad BBU</span><br><span class="line"></span><br><span class="line">Dell R720xd</span><br><span class="line">PERC H710p RAID controller</span><br><span class="line">8 x 200 GB Intel s3700 SSDs</span><br><span class="line"></span><br><span class="line">Latency measures during torture tests (96,000 reads/sec and 48,000 concurrent writes/second).</span><br><span class="line">RAID setting% &gt;1 ms% &gt;2 ms% &gt;4 ms% &gt;8 ms% &gt;16 ms</span><br><span class="line">Default        22.2013.964.290.220.00</span><br><span class="line">FastPath4.310.850.170.000.00</span><br><span class="line"></span><br><span class="line">The latencies <span class="keyword">for</span> the FastPath are much better. In general better latency results mean much higher threshold <span class="keyword">for</span> throughput.</span><br><span class="line"></span><br><span class="line"><span class="comment">### Storcli replace Megacli</span></span><br><span class="line"><span class="comment">#### BBU info</span></span><br><span class="line">```bash</span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -getBbuProperties -aALL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU Properties <span class="keyword">for</span> Adapter: 0</span><br><span class="line"></span><br><span class="line">  Auto Learn Period: 30 Days</span><br><span class="line">  Next Learn time: Mon Jun  3 12:02:38 2019</span><br><span class="line"></span><br><span class="line">  Learn Delay Interval:0 Hours</span><br><span class="line">  Auto-Learn Mode: Enabled</span><br><span class="line">  BBU Mode = 4</span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show properties</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU_Properties :</span><br><span class="line">==============</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Property             Value</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Auto Learn Period    30d (2592000 seconds)</span><br><span class="line">Next Learn time      2019/06/03  12:02:38 (612878558 seconds)</span><br><span class="line">Learn Delay Interval 0 hour(s)</span><br><span class="line">Auto-Learn Mode      Enabled</span><br><span class="line">BBU Mode             4</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show status</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU_Info :</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">Property      Value</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">BatteryType   iBBU08</span><br><span class="line">Voltage       4056 mV</span><br><span class="line">Current       0 mA</span><br><span class="line">Temperature   31 C</span><br><span class="line">Battery State Optimal</span><br><span class="line">Design Mode   1: 12+ Hrs retention with a transparent learn cycle</span><br><span class="line">                 and best service life.</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BBU_Firmware_Status :</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br><span class="line">Property                                   Value</span><br><span class="line">-------------------------------------------------</span><br><span class="line">Charging Status                            None</span><br><span class="line">Voltage                                    OK</span><br><span class="line">Temperature                                OK</span><br><span class="line">Learn Cycle Requested                      No</span><br><span class="line">Learn Cycle Active                         No</span><br><span class="line">Learn Cycle Status                         OK</span><br><span class="line">Learn Cycle Timeout                        No</span><br><span class="line">I2C Errors Detected                        No</span><br><span class="line">Battery Pack Missing                       No</span><br><span class="line">Battery Replacement required               No</span><br><span class="line">Remaining Capacity Low                     No</span><br><span class="line">Periodic Learn Required                    No</span><br><span class="line">Transparent Learn                          No</span><br><span class="line">No space to cache offload                  No</span><br><span class="line">Pack is about to fail &amp; should be replaced No</span><br><span class="line">Cache Offload premium feature required     No</span><br><span class="line">Module microcode update required           No</span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line">GasGaugeStatus :</span><br><span class="line">==============</span><br><span class="line"></span><br><span class="line">--------------------------------------</span><br><span class="line">Property                   Value</span><br><span class="line">--------------------------------------</span><br><span class="line">Fully Discharged           No</span><br><span class="line">Fully Charged              No</span><br><span class="line">Discharging                No</span><br><span class="line">Initialized                Yes</span><br><span class="line">Remaining Time Alarm       No</span><br><span class="line">Terminate Discharge Alarm  No</span><br><span class="line">Over Temperature           No</span><br><span class="line">Charging Terminated        No</span><br><span class="line">Over Charged               No</span><br><span class="line">Relative State of Charge   97%</span><br><span class="line">Charger System State       1</span><br><span class="line">Charger System Ctrl        0</span><br><span class="line">Charging current           0 mA</span><br><span class="line">Absolute state of charge   78%</span><br><span class="line">Max Error                  0%</span><br><span class="line">Battery backup charge time 48 hours +</span><br><span class="line">--------------------------------------</span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show status | grep -i <span class="built_in">type</span></span><br><span class="line">BatteryType   iBBU08</span><br><span class="line"></span><br><span class="line"><span class="comment">#important value</span></span><br><span class="line">Remaining Capacity Low                  : No</span><br><span class="line"></span><br><span class="line"><span class="comment">#design capacity: 1500, max</span></span><br><span class="line">Relative State of Charge  1055  1198  89%</span><br><span class="line">Absolute State of charge  1055  1500  70%</span><br></pre></td></tr></table></figure><h4 id="Setting-BBU"><a href="#Setting-BBU" class="headerlink" title="Setting BBU"></a>Setting BBU</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ storcli /cx/bbu <span class="built_in">set</span> learnDelayInterval=168 <span class="comment">#hours</span></span><br><span class="line"></span><br><span class="line">$ /opt/MegaRAID/storcli/storcli64 /call/bbu show modes</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = Get BBU Modes Succeeded.</span><br><span class="line"></span><br><span class="line">Available BBU Modes :</span><br><span class="line">===================</span><br><span class="line">Mode-1 = 12+ Hrs retention with a transparent learn cycle and best service life.</span><br><span class="line">Mode-3 = 24+ Hrs retention with a transparent learn cycle and balanced service life.</span><br><span class="line">Mode-4 = 48+ Hrs retention with a non-transparent learn cycle and balanced service life</span><br><span class="line"></span><br><span class="line">$ storcli /cx/bbu <span class="built_in">set</span> bbuMode=&lt;value&gt;</span><br><span class="line">0 48 hours of retentiona at 60 C, 1-year Service Life.</span><br><span class="line">a. Indicates how long the battery can hold data <span class="keyword">in</span> the controller<span class="string">&#x27;s memory in case of accidental system shutdown.</span></span><br><span class="line"><span class="string">1 12 hours of retention at 45 C, 5-year Service Life, transparent learn.b</span></span><br><span class="line"><span class="string">b. The controller&#x27;</span>s performance is not affected during the battery<span class="string">&#x27;s learn cycle.</span></span><br><span class="line"><span class="string">2 12 hours of retention at 55 C, 3-year Service Life, transparent learn.</span></span><br><span class="line"><span class="string">3 24 hours of retention at 45 C, 3-year Service Life, transparent learn.</span></span><br><span class="line"><span class="string">4 48 hours of retention at 45 C, 3-year Service Life.</span></span><br><span class="line"><span class="string">5 48 hours of retention at 55 C, 1-year Service Life.</span></span><br><span class="line"><span class="string">6 Same as the description for BBU mode 5. The BBU mode 6 enables you to receive events when the battery capacity reaches suboptimal and critical thresholds.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ storcli /cx bbu set autolearnmode=&lt;value&gt;</span></span><br><span class="line"><span class="string">where x= 0  Enabled, 1  Disabled, 2  Warn though event.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Manual learn battery</span></span><br><span class="line"><span class="string">$ storcli /c0/bbu start learn</span></span><br></pre></td></tr></table></figure><h4 id="Cachevault"><a href="#Cachevault" class="headerlink" title="Cachevault"></a><a href="https://www.thomas-krenn.com/en/wiki/CacheVault_Flash_Cache">Cachevault</a></h4><p>Here is not install cachevalut, all FLASH devices dont need it, because fastpath need writethrough mode</p><p>No battery is used with CacheVault technology. The cache content is protected by the following systems:</p><ul><li>A double-layer capacitor is connected to the RAID controller.</li><li>This will be fully loaded automatically during server startup.</li><li>In case of power failure the RAID controller uses the power of the capacitor to write the Flash-Memory to maintain all contents of the cache non-volatile (almost like a USB stick).</li><li>The next time the server is started the RAID controller writes the data from the Flash-Memory to the RAID Array.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0/cv show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Failure</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line">Detailed Status :</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">----------------------------------------------------</span><br><span class="line">Ctrl Status Property ErrMsg                   ErrCd</span><br><span class="line">----------------------------------------------------</span><br><span class="line">   0 Failed -        Cachevault doesn<span class="string">&#x27;t exist   255</span></span><br><span class="line"><span class="string">----------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv show all</span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv show learn</span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv show status</span></span><br><span class="line"><span class="string">$ storcli64 /c0/cv start learn</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h4 id="Get-all-megaraid-log-not-filter"><a href="#Get-all-megaraid-log-not-filter" class="headerlink" title="Get all megaraid log, not filter"></a>Get all megaraid log, not filter</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shows the history of log files generated</span></span><br><span class="line">$ storcli64  /call show eventloginfo file=logfile</span><br><span class="line">$ MegaCli64 -AdpEventLog -GetEvents -f logfile -aALL</span><br><span class="line"></span><br><span class="line"><span class="comment">#prints the system log</span></span><br><span class="line">$ storcli64 /c0 show events file=megaraid_events.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># shows the firmware logs</span></span><br><span class="line">$ storcli64 /c0 show termlog </span><br><span class="line">$ storcli64 /c0 show termlog <span class="built_in">type</span>=config</span><br><span class="line">$ storcli64 /c0 show termlog <span class="built_in">type</span>=contents</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Show-raid-logic-info"><a href="#Show-raid-logic-info" class="headerlink" title="Show raid logic info"></a>Show raid logic info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /cx/dall show [all]</span><br><span class="line">$ MegaCli64 -cfgdsply -aALL</span><br></pre></td></tr></table></figure><h4 id="Import-license"><a href="#Import-license" class="headerlink" title="Import license"></a>Import license</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli /c0 <span class="built_in">set</span> aso key=xxxxxxxxx</span><br></pre></td></tr></table></figure><h4 id="Backup-config"><a href="#Backup-config" class="headerlink" title="Backup config"></a>Backup config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli -CfgSave -f filename -aN   </span><br><span class="line">$ MegaCli -CfgRestore -f filename -aN  </span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 <span class="built_in">set</span> config file=raid_adapter0.config</span><br><span class="line">$ storcli64 /c0 get config file=raid_adapter0.config</span><br></pre></td></tr></table></figure><h4 id="Interrupt-BGI"><a href="#Interrupt-BGI" class="headerlink" title="Interrupt BGI"></a>Interrupt BGI</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64 -LDBI -Abort -LALL -aALL</span><br><span class="line">$ storcli64 /call/vall <span class="built_in">set</span> autobgi=On|Off</span><br><span class="line">$ storcli64 /call/vall show autobgi</span><br><span class="line">$ storcli64 /call/vall stop bgi</span><br><span class="line">$ storcli64 /call/vall pause bgi</span><br><span class="line">$ storcli64 /call/vall resume bgi</span><br><span class="line">$ storcli64 /call/vall show bgi</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> bgirate=90</span><br></pre></td></tr></table></figure><h4 id="Rebuild-Migrate-init"><a href="#Rebuild-Migrate-init" class="headerlink" title="Rebuild/Migrate/init"></a>Rebuild/Migrate/init</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64  -AdpSetProp RebuildRate 50 -a0</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> rebuildrate=50</span><br><span class="line"></span><br><span class="line">$ MegaCli64  -AdpSetProp ReconRate 50 -a0</span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -LDRecon ShowProg L1  -a0</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> migraterate=50</span><br><span class="line">$ storcli /c0/v1 show migrate</span><br><span class="line">$ storcli /c0/v1 start migrate <span class="built_in">type</span>=raidx</span><br><span class="line"></span><br><span class="line"><span class="comment">#  automatic background initialization</span></span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -LDBI -ShowProg -LALL -aALL</span><br><span class="line">$ storcli /call/vall <span class="built_in">set</span> autobgi=on</span><br><span class="line">$ storcli /call/vall show autobgi</span><br><span class="line">$ storcli /call/vall stop bgi</span><br><span class="line">$ storcli /call/vall pause bgi</span><br><span class="line">$ storcli /call/vall resume bgi</span><br><span class="line">$ storcli /call/vall show bgi</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtual drive initialization</span></span><br><span class="line">$ /opt/MegaRAID/MegaCli/MegaCli64 -LDInit ShowProg Lall a0</span><br><span class="line">$ storcli /c0/vall start init</span><br><span class="line">$ storcli /c0/vall stop init</span><br><span class="line">$ storcli /c0/vall show init</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Make-device-good"><a href="#Make-device-good" class="headerlink" title="Make device good"></a>Make device good</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64 -PDMakeGood -PhysDrv[20:12] -a0</span><br><span class="line">$ storcli64 /c0/e20/s12 <span class="built_in">set</span> good force</span><br></pre></td></tr></table></figure><h4 id="Make-JBOD"><a href="#Make-JBOD" class="headerlink" title="Make JBOD"></a>Make JBOD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64 -PDMakeJBOD -PhysDrv[E0:S0,E1:S1,...] -aN|-a0,1,2|-aALL</span><br><span class="line">$ storcli64 /c0/e20/s12 <span class="built_in">set</span> jbod (default on)</span><br><span class="line">$ storcli64 /c0 <span class="built_in">set</span> jbod = on/off</span><br><span class="line"></span><br><span class="line">$ MegaCli -AdpSetProp -EnableJBOD -val -aN|-a0,1,2|-aALL</span><br><span class="line">      val - 0=Disable JBOD mode.</span><br><span class="line">            1=Enable JBOD mode.</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 <span class="built_in">set</span> jbod=on</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Foreign-devices"><a href="#Foreign-devices" class="headerlink" title="Foreign devices"></a>Foreign devices</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ MegaCli64  -CfgForeign -Clear -aALL</span><br><span class="line">$ storcli64 /c0/fall del|delete</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0/fall show</span><br><span class="line">$ storcli64 /c0/fall import</span><br></pre></td></tr></table></figure><h3 id="About-Consistency-and-patrol-read"><a href="#About-Consistency-and-patrol-read" class="headerlink" title="About Consistency and patrol read"></a><a href="https://www.digiliant.com/docs/MegaRAID-SAS-Software-User-Guide-12Gbs.pdf">About Consistency and patrol read</a></h3><h4 id="Patrol-read"><a href="#Patrol-read" class="headerlink" title="Patrol read"></a>Patrol read</h4><p>Patrol read involves the review of your system for possible drive errors that could lead to drive failure and then action to correct errors. The goal is to protect data integrity by detecting drive failure before the failure can damage data. The corrective actions depend on the drive group configuration and the type of errors.<br>Patrol read starts only when the controller is idle for a defined period of time and no other background tasks are active, though it can continue to run during heavy I/O processes.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show patrolRead</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">---------------------------------------------</span><br><span class="line">Ctrl_Prop               Value</span><br><span class="line">---------------------------------------------</span><br><span class="line">PR Mode                 Auto</span><br><span class="line">PR Execution Delay      168 hours</span><br><span class="line">PR iterations completed 0</span><br><span class="line">PR Next Start time      08/24/2019, 03:00:00</span><br><span class="line">PR on SSD               Disabled</span><br><span class="line">PR on EPD               Disabled</span><br><span class="line">PR Current State        Stopped</span><br><span class="line">---------------------------------------------</span><br><span class="line"><span class="comment"># mode=auto/manual</span></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> patrolread=on mode=auto includessds=on maxconcurrentpd=255 delay=360 <span class="comment">#255 phy devs ,360 housr(15days)</span></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> patrolread=on mode=auto starttime=2019/08/24 03</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> patrolread=off</span><br><span class="line"></span><br><span class="line"><span class="comment">##show/stop/start/resume/pause</span></span><br><span class="line">$ storcli64 /call start patrolRead </span><br><span class="line">$ storcli64 /call show patrolRead</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">----------------------------------</span><br><span class="line">Ctrl_Prop               Value</span><br><span class="line">----------------------------------</span><br><span class="line">PR Mode                 Auto</span><br><span class="line">PR Execution Delay      360 hours</span><br><span class="line">PR iterations completed 352</span><br><span class="line">PR on SSD               Enabled</span><br><span class="line">PR Current State        Stopped</span><br><span class="line">----------------------------------</span><br><span class="line"></span><br><span class="line">$ storcli64 /call show prrate</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> prrate=40</span><br></pre></td></tr></table></figure><h4 id="Consistency-Check"><a href="#Consistency-Check" class="headerlink" title="Consistency Check"></a>Consistency Check</h4><p>checking consistency means calculating the data on one drive and comparing the results to the contents of the parity drive<br>It is recommended that you perform a consistency check at least once a month.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show cc</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">-----------------------------------------------</span><br><span class="line">Ctrl_Prop                 Value</span><br><span class="line">-----------------------------------------------</span><br><span class="line">CC Operation Mode         Concurrent</span><br><span class="line">CC Execution Delay        168</span><br><span class="line">CC Next Starttime         08/24/2019, 02:00:00</span><br><span class="line">CC Current State          Stopped</span><br><span class="line">CC Number of iterations   311</span><br><span class="line">CC Number of VD completed 2</span><br><span class="line">CC Excluded VDs           None</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line">$ storcli64 /call show ccrate</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> ccrate=50</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#schedule</span></span><br><span class="line">$ storcli64 /call/vall <span class="built_in">set</span> cc=seq </span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> cc=seq starttime=2019/08/31 02 delay=1440  <span class="comment">## check interval 1440 hours ,60 days</span></span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">Ctrl_Prop    Value</span><br><span class="line">---------------------------------</span><br><span class="line">CC Mode      SEQ</span><br><span class="line">CC Starttime 2019/08/31 02:00:00</span><br><span class="line">CC delay     1440</span><br><span class="line">---------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">### if I &#x27;m not set start time</span></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> cc=seq delay=1440</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">Ctrl_Prop Value</span><br><span class="line">----------------</span><br><span class="line">CC Mode   SEQ</span><br><span class="line">CC delay  1440</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 show cc</span><br><span class="line">CC Operation Mode         Sequential</span><br><span class="line">CC Execution Delay        1440</span><br><span class="line">CC Next Starttime         08/24/2019, 03:00:00 <span class="comment">## first start after about 12 hours</span></span><br><span class="line">CC Current State          Stopped</span><br><span class="line">CC Number of iterations   120</span><br><span class="line">CC Number of VD completed 1</span><br><span class="line">CC Excluded VDs           None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### show again</span></span><br><span class="line">$ storcli64 /c0 show cc</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">-----------------------------------------------</span><br><span class="line">Ctrl_Prop                 Value</span><br><span class="line">-----------------------------------------------</span><br><span class="line">CC Operation Mode         Sequential</span><br><span class="line">CC Execution Delay        1440</span><br><span class="line">CC Next Starttime         08/31/2019, 02:00:00</span><br><span class="line">CC Current State          Stopped</span><br><span class="line">CC Number of iterations   311</span><br><span class="line">CC Number of VD completed 2</span><br><span class="line">CC Excluded VDs           None</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#manual start and show status</span></span><br><span class="line"><span class="comment">#show/stop/start/resume/pause</span></span><br><span class="line">$ storcli64 /call/vall start cc [force]</span><br><span class="line">$ storcli64 /call/vall show cc</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VD Operation Status :</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line">VD Operation Progress% Status</span><br><span class="line">-----------------------------------</span><br><span class="line"> 0 CC                0 In progress</span><br><span class="line"> 1 CC                1 In progress</span><br><span class="line">-----------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ storcli64 /call/vall stop cc</span><br></pre></td></tr></table></figure><h3 id="Montor-cache-ECC-count"><a href="#Montor-cache-ECC-count" class="headerlink" title="Montor cache ECC count"></a>Montor cache ECC count</h3><p>eccbucketleakrate 0 to 65535 Sets the leak rate of the single-bit bucket in minutes (one entry removed per leak-rate).<br>eccbucketsize 0 to 255 Sets the size of ECC single-bit-error bucket (logs event when full).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /c0 show all | grep Bucket</span><br><span class="line">ECC Bucket Count = 0</span><br><span class="line">ECC Bucket Size = 255</span><br><span class="line">ECC Bucket Leak Rate (hrs) = 4</span><br></pre></td></tr></table></figure><h3 id="About-device-write-cache-in-megaraid"><a href="#About-device-write-cache-in-megaraid" class="headerlink" title="About device write cache in megaraid"></a><a href="https://utcc.utoronto.ca/~cks/space/blog/tech/ModernDiskWriteCaches">About device write cache in megaraid</a></h3><p>drives can also support a write option called Force Unit Access (FUA) that bypasses the write cache in order to force what youre writing to be forced to disk. In general FUA is bundled with another feature called Disable Page Out (DPO), which tells the drive that putting the data into cache is not useful.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">$ Virtual Drives = 2</span><br><span class="line"></span><br><span class="line">VD LIST :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">DG/VD TYPE  State Access Consist Cache Cac sCC     Size Name</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">0/0   RAID1 Optl  RW     Yes     NRWTD -   OFF 223.0 GB R1OS</span><br><span class="line">1/1   RAID5 Optl  RW     Yes     RWTD  -   OFF 1.307 TB</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Cac=CacheCade|Rec=Recovery|OfLn=OffLine|Pdgd=Partially Degraded|dgrd=Degraded</span><br><span class="line">Optl=Optimal|RO=Read Only|RW=Read Write|HD=Hidden|B=Blocked|Consist=Consistent|</span><br><span class="line">R=Read Ahead Always|NR=No Read Ahead|WB=WriteBack|</span><br><span class="line">AWB=Always WriteBack|WT=WriteThrough|C=Cached IO|D=Direct IO|sCC=Scheduled</span><br><span class="line">Check Consistency</span><br><span class="line"></span><br><span class="line">Physical Drives = 6</span><br><span class="line"></span><br><span class="line">PD LIST :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">EID:Slt DID State DG       Size Intf Med SED PI SeSz Model         Sp</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">32:0      0 Onln   0   223.0 GB SATA SSD N   N  512B THNSF8240CCSE U</span><br><span class="line">32:1      1 Onln   0   223.0 GB SATA SSD N   N  512B THNSF8240CCSE U</span><br><span class="line">32:2      2 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">32:3      3 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">32:4      4 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">32:5      5 Onln   1 446.625 GB SATA SSD N   N  512B MTFDDAK480TDC U</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ dmesg -T | grep DPO</span><br><span class="line">[Tue Nov  5 23:21:47 2019] sd 0:2:1:0: [sdb] Write cache: disabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">[Tue Nov  5 23:21:47 2019] sd 0:2:0:0: [sda] Write cache: disabled, <span class="built_in">read</span> cache: disabled, supports DPO and FUA</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0/vall <span class="built_in">set</span> wrcache=WT rdcache=nora iopolicy=direct</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line">Detailed Status :</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">VD Property Value  Status  ErrCd ErrMsg</span><br><span class="line">----------------------------------------</span><br><span class="line"> 0 wrCache  WT     Success     0 -</span><br><span class="line"> 0 rdCache  NoRA   Success     0 -</span><br><span class="line"> 0 IoPolicy Direct Success     0 -</span><br><span class="line"> 1 wrCache  WT     Success     0 -</span><br><span class="line"> 1 rdCache  NoRA   Success     0 -</span><br><span class="line"> 1 IoPolicy Direct Success     0 -</span><br><span class="line">----------------------------------------</span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$ dmesg -T | grep DPO</span><br><span class="line">[Thu Nov  7 02:37:51 2019] sd 0:2:0:0: [sda] Write cache: disabled, <span class="built_in">read</span> cache: disabled, supports DPO and FUA</span><br><span class="line">[Thu Nov  7 02:37:51 2019] sd 0:2:1:0: [sdb] Write cache: disabled, <span class="built_in">read</span> cache: disabled, supports DPO and FUA</span><br><span class="line"></span><br><span class="line">Supported VD Operations :</span><br><span class="line">=======================</span><br><span class="line">Read Policy = Yes</span><br><span class="line">Write Policy = Yes</span><br><span class="line">IO Policy = Yes</span><br><span class="line">Access Policy = Yes</span><br><span class="line">Disk Cache Policy = Yes</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0/v0 <span class="built_in">set</span> wrcache=WB</span><br><span class="line">VD Property Value Status  ErrCd ErrMsg</span><br><span class="line">---------------------------------------</span><br><span class="line"> 0 wrCache  WB    Success     0 -</span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$  dmesg -T | grep DPO</span><br><span class="line">[Thu Nov  7 02:53:00 2019] sd 0:2:0:0: [sda] Write cache: disabled, <span class="built_in">read</span> cache: disabled, doesn<span class="string">&#x27;t support DPO or FUA</span></span><br><span class="line"><span class="string">[Thu Nov  7 02:53:00 2019] sd 0:2:1:0: [sdb] Write cache: disabled, read cache: disabled, supports DPO and FUA</span></span><br></pre></td></tr></table></figure><p>You could change megaraid cache policy, let the device support DPO and FUA</p><h3 id="Backup-and-restore-config-file"><a href="#Backup-and-restore-config-file" class="headerlink" title="Backup and restore config file"></a>Backup and restore config file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#backup controller config to file;</span></span><br><span class="line">./storcli64 /c0 get config file=megaraid.cfg</span><br><span class="line">./storcli64 /c0 <span class="built_in">set</span> config file=megaraid.cfg</span><br><span class="line"><span class="comment">#Clear a Configuration; dangerous</span></span><br><span class="line"><span class="comment">###./storcli64 /c0 delete config[force]</span></span><br></pre></td></tr></table></figure><h3 id="Flush-RAID-write-cache"><a href="#Flush-RAID-write-cache" class="headerlink" title="Flush RAID write cache"></a>Flush RAID write cache</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Cache Flush on Selected Controller</span></span><br><span class="line">$ MegaCli64 AdpCacheFlush -aN|-a0,1,2|-aALL</span><br><span class="line">$ storcli64 /c0 <span class="keyword">set</span> flushwriteverify=<span class="keyword">on</span></span><br><span class="line">$ storcli64 /c0 <span class="keyword">show</span> flushwriteverify </span><br><span class="line">$ storcli64 /c0 flushcache</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0 flushcache</span><br><span class="line">Controller = <span class="number">0</span></span><br><span class="line"><span class="keyword">Status</span> = <span class="keyword">Success</span></span><br><span class="line">Description = Adapter <span class="keyword">and</span>/<span class="keyword">or</span> disk caches flushed successfully.</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete the preserved cache for a particular virtual driver on the controller in missing state</span></span><br><span class="line">$ perccli64 /c0/v1 <span class="keyword">delete</span> preservedCache </span><br><span class="line">$ storcli64 /c0/v1 <span class="keyword">delete</span> preservedCache <span class="keyword">force</span></span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 <span class="keyword">show</span> preservedCache</span><br><span class="line">Controller = <span class="number">0</span></span><br><span class="line"><span class="keyword">Status</span> = <span class="keyword">Success</span></span><br><span class="line">Description = <span class="keyword">No</span> <span class="keyword">Virtual</span> Drive has Preserved <span class="keyword">Cache</span> Data.</span><br></pre></td></tr></table></figure><h3 id="show-PHY"><a href="#show-PHY" class="headerlink" title="show PHY"></a>show PHY</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ storcli /cx/px|pall <span class="built_in">set</span> linkspeed=0(auto)|1.5|3|6|12</span><br><span class="line">$ perccli64 /c0/pall show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PhyInfo :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">PhyNo SAS_Addr           Phy_Identifier Link_Speed Device_Type   Description</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">    0 0x500056B3BECB2FFF             17 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    1 0x500056B3BECB2FFF             20 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    2 0x500056B3BECB2FFF             18 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    3 0x500056B3BECB2FFF             23 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    4 0x500056B3BECB2FFF             19 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    5 0x500056B3BECB2FFF             21 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    6 0x500056B3BECB2FFF             16 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">    7 0x500056B3BECB2FFF             22 No <span class="built_in">limit</span>   Edge Expander -</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ perccli64 /call/eall show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Properties :</span><br><span class="line">==========</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line">EID State Slots PD PS Fans TSs Alms SIM Port<span class="comment"># ProdID VendorSpecific</span></span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line"> 32 OK        8  6  0    0   0    0   0 00 x1 BP14G+  !   ?</span><br><span class="line">--------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">EID-Enclosure Device ID |PD-Physical drive count |PS-Power Supply count|</span><br><span class="line">TSs-Temperature sensor count |Alms-Alarm count |SIM-SIM Count</span><br><span class="line"></span><br><span class="line">$ perccli64 /call/eall show status</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"><span class="comment"># upgrade the enclosure</span></span><br><span class="line">$ storcli64 /c0/e32 download src=enclosure_fw.bin</span><br></pre></td></tr></table></figure><h3 id="Foreign-configurations"><a href="#Foreign-configurations" class="headerlink" title="Foreign configurations"></a>Foreign configurations</h3><p>NOTE Provide the security key when importing a locked foreign configuration created in a different machine that is encrypted with a security key.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0/fall show</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = Couldn<span class="string">&#x27;t find any foreign Configuration</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ storcli64 /c0/fall import</span></span><br><span class="line"><span class="string">$ storcli64 /cx/fx|fall show [all][ securitykey=sssssssssss ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#This command deletes the foreign configuration of a controller.</span></span><br><span class="line"><span class="string">$ ### storcli64 /c0/fall delete</span></span><br></pre></td></tr></table></figure><h3 id="Dimmer-switch"><a href="#Dimmer-switch" class="headerlink" title="Dimmer switch"></a>Dimmer switch</h3><p>The Dimmer Switch is the power-saving policy for the virtual drive</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0 show ds</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Controller Properties :</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">-------------------------------</span><br><span class="line">Ctrl_Prop         Value</span><br><span class="line">-------------------------------</span><br><span class="line">SpnDwnUncDrv      Disabled</span><br><span class="line">SpnDwnHS          Disabled</span><br><span class="line">SpnDwnTm          30 minute(s)</span><br><span class="line">SpnDwnCfgDrv      Disabled</span><br><span class="line">DefaultLdPSPolicy None</span><br><span class="line">DsblLdPsInterval  0 hours</span><br><span class="line">DsblLdPsTime      0 minutes</span><br><span class="line">SpnUpEncDly       8 second(s)</span><br><span class="line">spinUpEncDrvCnt   6</span><br><span class="line">-------------------------------</span><br><span class="line"></span><br><span class="line">$ storcli /cx/vx <span class="built_in">set</span> ds=default | auto | none | max | maxnocache</span><br><span class="line">auto: Logical device power savings are managed by the firmware.</span><br><span class="line">none: No power saving policy.</span><br><span class="line">max: Logical device uses maximum power savings.</span><br><span class="line">maxnocache: Logical device does not cache write to maximise power savings.</span><br><span class="line"></span><br><span class="line">$ storcli64  /c0 <span class="built_in">set</span> ds=on <span class="built_in">type</span>=1|2</span><br><span class="line">1: Unconfigured</span><br><span class="line">2: Hot spare</span><br><span class="line">3: Virtual drive</span><br><span class="line">4: All</span><br><span class="line"></span><br><span class="line">$ storcli /cx <span class="built_in">set</span> ds=on [properties]</span><br><span class="line">disableldps: Interval <span class="keyword">in</span> hours or time <span class="keyword">in</span> hh:mm format</span><br><span class="line">spinupdrivecount: Valid enclosure number (0 to 255)</span><br><span class="line">SpinUpEncDelay: Valid time <span class="keyword">in</span> seconds</span><br></pre></td></tr></table></figure><h3 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /cx[/ex]/sx spindown</span><br><span class="line">$ storcli64 /cx[/ex]/sx spinup</span><br><span class="line"></span><br><span class="line">$ storcli64 /cx[/ex]/sx secureerase [force]</span><br><span class="line">$ storcli64 /cx[/ex]/sx start erase [simple|normal|thorough] [erasepatternA=&lt;value1&gt;] [erasepatternB=&lt;value2&gt;]</span><br><span class="line">$ storcli64 /cx[/ex]/sx stop erase</span><br></pre></td></tr></table></figure><h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><h4 id="log"><a href="#log" class="headerlink" title="log"></a>log</h4><p> 0  NA<br> 1 SET<br> 2  CLEAR<br> 3  CLEAR ALL<br> 4  DEBUG DUMP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /call show all logfile=megaraid.cfg</span><br><span class="line">$ storcli64 /c x <span class="built_in">set</span> debug reset all </span><br><span class="line">$ storcli64 /call x <span class="built_in">set</span> debug <span class="built_in">type</span> = &lt;value&gt; option = &lt;value&gt; level = [&lt;value <span class="keyword">in</span> hex&gt;]</span><br><span class="line"><span class="comment">#type  takes the value from 0  128, mapping each number to a particular debug variable in the firmware.</span></span><br><span class="line">$ <span class="comment">#storcli64 /call delete events</span></span><br><span class="line">$ <span class="comment">#storcli64 /call delete termlog</span></span><br><span class="line"></span><br><span class="line">$ storcli64 /call show events file=events.log</span><br><span class="line">$ storcli64 /call show termlog <span class="built_in">type</span>=config logfile=termlog.config</span><br><span class="line">$ storcli64 /call show termlog <span class="built_in">type</span>=contents logfile=termlog.contents</span><br><span class="line">$ storcli64 /call show eventloginfo logfile=event.info</span><br><span class="line">$ storcli64 /call show dequeuelog file=dequeue.log</span><br><span class="line">$ storcli64 /call show alilog logfile=ali.log</span><br></pre></td></tr></table></figure><h4 id="Encolsure"><a href="#Encolsure" class="headerlink" title="Encolsure"></a>Encolsure</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /call/eall download src=encolsure.bin</span><br><span class="line">$ perccli64 /call/eall show all</span><br><span class="line">$ perccli64 /call/eall show status </span><br></pre></td></tr></table></figure><h4 id="phy-err"><a href="#phy-err" class="headerlink" title="phy err"></a>phy err</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">storcli /cx/px|pall show</span><br><span class="line">storcli /cx/px|pall show all</span><br><span class="line">storcli /cx/ex show phyerrorcounters</span><br><span class="line">storcli /cx[/ex]/sx show phyerrorcounters</span><br><span class="line">storcli /cx[/ex]/sx reset phyerrorcounters</span><br><span class="line">storcli /cx/px|pall <span class="built_in">set</span> linkspeed=0(auto)|1.5|3|6|12</span><br></pre></td></tr></table></figure><h4 id="diag-adapter"><a href="#diag-adapter" class="headerlink" title="diag adapter"></a>diag adapter</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0 start diag duration=10 logfile=diag.log</span><br></pre></td></tr></table></figure><h4 id="Enable-SEP-for-Dell-PERC"><a href="#Enable-SEP-for-Dell-PERC" class="headerlink" title="Enable SEP for Dell PERC"></a>Enable SEP for Dell PERC</h4><p>Configures enclosure detection on a non-SES/expander backplane.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /call <span class="built_in">set</span> backplane mode=0 expose=on</span><br><span class="line">0: Use autodetect logic of backplanes, such as SGPIO and I2C SEP using GPIO pins.</span><br><span class="line">1: Disable autodetect SGPIO.</span><br><span class="line">2: Disable I2C SEP autodetect.</span><br><span class="line">3: Disable both the autodetects.</span><br><span class="line"></span><br><span class="line">backplane expose: Enables or disables device drivers to expose enclosure devices; <span class="keyword">for</span> example, expanders, SEPs.</span><br><span class="line"></span><br><span class="line">$ perccli64 /call <span class="built_in">set</span> sesmonitoring=on</span><br></pre></td></tr></table></figure><h3 id="Enable-JBOD"><a href="#Enable-JBOD" class="headerlink" title="Enable JBOD"></a>Enable JBOD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /call <span class="built_in">set</span> jbod=on</span><br></pre></td></tr></table></figure><h3 id="SAS-loading-balance"><a href="#SAS-loading-balance" class="headerlink" title="SAS loading balance"></a>SAS loading balance</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /cx <span class="built_in">set</span> loadbalancemode=on</span><br></pre></td></tr></table></figure><h3 id="Driver-performance"><a href="#Driver-performance" class="headerlink" title="Driver performance"></a>Driver performance</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /call <span class="built_in">set</span> DPM=on</span><br><span class="line"><span class="comment">#Enables or disables drive performance monitoring</span></span><br><span class="line"></span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> ncq=on</span><br><span class="line">$ storcli64 /call <span class="built_in">set</span> perfmode=1 <span class="comment">#default was 0</span></span><br><span class="line">0: Tuned to provide best IOPS, currently applicable to non-FastPath</span><br><span class="line">1: Tuned to provide least latency, currently applicable to non-FastPath</span><br></pre></td></tr></table></figure><h4 id="Get-smart-info-from-LSI-megaraid"><a href="#Get-smart-info-from-LSI-megaraid" class="headerlink" title="Get smart info from LSI megaraid"></a>Get smart info from LSI megaraid</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl -s on -a -d megaraid,1 /dev/sda -T permissive</span><br><span class="line">$ smartctl -s on -a -d megaraid,0 /dev/sda -T permissive</span><br><span class="line">smartctl 6.5 2016-05-07 r4318 [x86_64-linux-3.10.0-957.1.3.el7.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">=== START OF INFORMATION SECTION ===</span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUSMM1616ASS204</span><br><span class="line">Revision:             L380</span><br><span class="line">Compliance:           SPC-4</span><br><span class="line">User Capacity:        1,600,321,314,816 bytes [1.60 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br><span class="line">LU is resource provisioned, LBPRZ=1</span><br><span class="line">Rotation Rate:        Solid State Device</span><br><span class="line">Form Factor:          2.5 inches</span><br><span class="line">Logical Unit id:      0x0000000000000000</span><br><span class="line">Serial number:        0000000</span><br><span class="line">Device <span class="built_in">type</span>:          disk</span><br><span class="line">Transport protocol:   SAS (SPL-3)</span><br><span class="line">Local Time is:        Thu Dec 27 15:44:50 2018 CST</span><br><span class="line">SMART support is:     Available - device has SMART capability.</span><br><span class="line">SMART support is:     Enabled</span><br><span class="line">Temperature Warning:  Disabled or Not Supported</span><br><span class="line"></span><br><span class="line">=== START OF ENABLE/DISABLE COMMANDS SECTION ===</span><br><span class="line">Informational Exceptions (SMART) enabled</span><br><span class="line">Temperature warning enabled</span><br><span class="line"></span><br><span class="line">=== START OF READ SMART DATA SECTION ===</span><br><span class="line">SMART Health Status: OK</span><br><span class="line"></span><br><span class="line">Percentage used endurance indicator: 0%</span><br><span class="line">Current Drive Temperature:     32 C</span><br><span class="line">Drive Trip Temperature:        60 C</span><br><span class="line"></span><br><span class="line">Manufactured <span class="keyword">in</span> week 53 of year 2016</span><br><span class="line">Specified cycle count over device lifetime:  0</span><br><span class="line">Accumulated start-stop cycles:  0</span><br><span class="line">Specified load-unload count over device lifetime:  0</span><br><span class="line">Accumulated load-unload cycles:  0</span><br><span class="line">Vendor (Seagate) cache information</span><br><span class="line">  Blocks sent to initiator = 6325615015755776</span><br><span class="line"></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0        0         0         0          0       6874.841           0</span><br><span class="line">write:         0        0         0         0          0      10898.936           0</span><br><span class="line">verify:        0        0         0         0          0         32.879           0</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br></pre></td></tr></table></figure><h3 id="performance-monitor"><a href="#performance-monitor" class="headerlink" title="performance monitor"></a>performance monitor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /c0 show dpm</span><br><span class="line">$ perccli64 /c0 <span class="built_in">set</span> dpm=on</span><br><span class="line"></span><br><span class="line">$ perccli64 /c0 delete dpmstat <span class="built_in">type</span> = Hist | LCT | RA |EXT [logfile=filename]</span><br><span class="line">$ perccli64 /c0 show dpmstat <span class="built_in">type</span> = Hist | LCT | RA |EXT [logfile=filename]</span><br><span class="line">$ storcli64 /c0 start dpm</span><br><span class="line">$ storcli64 /c0 stop dpm</span><br><span class="line"></span><br><span class="line">MR 7.14 storcli64 version</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = HIST logfile=9460-16i_dpmstat_HIST.txt</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = LCT logfile=9460-16i_dpmstat_LCT.txt</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = RA logfile=9460-16i_dpmstat_RA.txt</span><br><span class="line">$ storcli64 /c1/e25/sall show dpmstat <span class="built_in">type</span> = EXT logfile=9460-16i_dpmstat_EXT.txt</span><br><span class="line"></span><br><span class="line">MR 9361-8i use MR 6.14, storcli 1.2.xx</span><br><span class="line">$ storcli64 -DpmStat -Dsply lct -physdrv [10:0] -a0</span><br><span class="line"></span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Enclosure Device ID: 32</span><br><span class="line">Slot Number: 0</span><br><span class="line">Device Id: 0</span><br><span class="line">                    Resp</span><br><span class="line">Date    |   Time  | Time(ms) | CDB/ATA Task File(hex)</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0        0         0.0000    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line"></span><br><span class="line">$ storcli64 -DpmStat -Dsply ra -physdrv [10:0] -a0</span><br><span class="line"></span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Requested data: Running Average Drive Statistics</span><br><span class="line"></span><br><span class="line">Enclosure   Slot                           Queue      Xfer       Resp</span><br><span class="line">Device ID | Number | Device Id |  IOPs  |  Depth  |   Rate    |  Time</span><br><span class="line">          |        |           |        |         |   (MB/s)  |  (ms)</span><br><span class="line"></span><br><span class="line">32          3        3          0        0         0.0000       0.0000</span><br><span class="line"></span><br><span class="line">$ storcli64 -DpmStat -Dsply hist -physdrv [10:0] -a0</span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Enclosure Device ID: 32</span><br><span class="line">Slot Number: 3</span><br><span class="line">Device Id: 3</span><br><span class="line"></span><br><span class="line">------------------------------------------</span><br><span class="line">Bin       Respose Time (ms)   IO Count</span><br><span class="line">------------------------------------------</span><br><span class="line">1         1                   0</span><br><span class="line">2         2                   0</span><br><span class="line">3         3                   0</span><br><span class="line">4         4                   0</span><br><span class="line">5         5                   0</span><br><span class="line">6         6                   0</span><br><span class="line">7         7                   0</span><br><span class="line">8         8                   0</span><br><span class="line">9         9                   0</span><br><span class="line">10        10                  0</span><br><span class="line">11        20                  0</span><br><span class="line">12        30                  0</span><br><span class="line">13        40                  0</span><br><span class="line">14        50                  0</span><br><span class="line">15        60                  0</span><br><span class="line">16        70                  0</span><br><span class="line">17        80                  0</span><br><span class="line">18        90                  0</span><br><span class="line">19        100                 0</span><br><span class="line">20        200                 0</span><br><span class="line">21        300                 0</span><br><span class="line">22        400                 0</span><br><span class="line">23        500                 0</span><br><span class="line">24        600                 0</span><br><span class="line">25        700                 0</span><br><span class="line">26        800                 0</span><br><span class="line">27        900                 0</span><br><span class="line">28        1000                0</span><br><span class="line">29        2000                0</span><br><span class="line">30        3000                0</span><br><span class="line">31        4000                0</span><br><span class="line">32        5000                0</span><br><span class="line">33        6000                0</span><br><span class="line">34        7000                0</span><br><span class="line">35        8000                0</span><br><span class="line">36        9000                0</span><br><span class="line">37        10000               0</span><br><span class="line">38        10000+              0</span><br><span class="line">------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ storcli64 -DpmStat -Dsply ext -physdrv [10:0] -a0</span><br><span class="line">Drive Performance Monitor Configuration <span class="keyword">for</span> 0</span><br><span class="line">Performance Monitor: ON</span><br><span class="line">Max commands <span class="keyword">for</span> averaging: 100</span><br><span class="line">Max latency commands to save: 10</span><br><span class="line"></span><br><span class="line">Enclosure Device ID: 32</span><br><span class="line">Slot Number: 3</span><br><span class="line">Device Id: 3</span><br><span class="line">  Sectors                                      Commands</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Read        Write       Write-FUA      Read        Write       Write-FUA  Flush</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">0           0           0              0           0           0           0</span><br></pre></td></tr></table></figure><h3 id="T10-PI-for-megaraid"><a href="#T10-PI-for-megaraid" class="headerlink" title="T10 PI for megaraid"></a>T10 PI for megaraid</h3><p><img src="/img/MegaRAID-setting-1.png"><br><a href="https://www.broadcom.com/support/knowledgebase/1211161502244/the-data-protection-feature---megaraid">Megaraid T10 PI</a><br>The Data Protection feature is an additional method of preventing data corruption by delivering end-to-end data integrity through the full I/O path from the application to the disk drive. This feature is officially called T-10 Protection Information (T-10 PI) and requires special hard drives with 520-byte sectors. The feature is essentially Parity which is done internally on the drives that support T-10 PI.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perccli64 /cx <span class="built_in">set</span> pi state = off </span><br></pre></td></tr></table></figure><h3 id="About-T10-rebuild-assist-for-megaraid"><a href="#About-T10-rebuild-assist-for-megaraid" class="headerlink" title="About T10 rebuild assist for megaraid"></a><a href="https://www.dell.com/support/article/us/en/04/qna44044/perc9-under-certain-conditions-there-is-a-possible-data-integrity-issue-with-the-rapid-rebuild?lang=en">About T10 rebuild assist for megaraid</a></h3><p><code>Unstable</code></p><p>Dell PERC 9 controllers (H330, H730, H730P, and H830) introduced a feature called Rapid Rebuild that speeds up the time to rebuild failed drives in certain conditions. This feature is based on T10 Rebuild Assist. Dell has determined that there is a possibility for data integrity issues when this feature is used under certain conditions.</p><p><code>When the PERC is rebuilding the data for the &quot;bad&quot; sectors, it incorrectly writes data from cache to the failed drive instead of the hot spare. This results in data and associated parity not being written to the hot spare. In write through mode, parity errors will occur. In write back mode, errors will occur in both data and associated parity.</code></p><p>From the PERC Controller log if you see the below highlighted text you have encountered the issue.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C0:EVT<span class="comment">#395950-08/17/16 13:54:59: 114=State change on PD 0b(e0x20/s11) from OFFLINE(XX) to REBUILDASSIST(12)</span></span><br></pre></td></tr></table></figure><p>If you have not encountered this issue then to protect against this scenario please update your PERC H730, H730p, H830 controller firmware to 25.5.0.0018 and PERC H330 controller firmware to 25.5.0.0019 or later firmware which disables the Rapid Rebuild feature.</p><h4 id="Enable-T10-data-protection-in-LSI-9380-8e"><a href="#Enable-T10-data-protection-in-LSI-9380-8e" class="headerlink" title="Enable T10-data-protection in LSI 9380-8e"></a>Enable T10-data-protection in LSI 9380-8e</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make sure the sas device support the feature</span></span><br><span class="line">$ sg_vpd -p ei -l -v /dev/sdc</span><br><span class="line">    inquiry cdb: 12 01 86 00 <span class="built_in">fc</span> 00</span><br><span class="line">    inquiry: pass-through requested 252 bytes but got 64 bytes</span><br><span class="line">    inquiry cdb: 12 00 00 00 24 00</span><br><span class="line">extended INQUIRY data VPD page:</span><br><span class="line">   [PQual=0  Peripheral device <span class="built_in">type</span>: disk]</span><br><span class="line">  ACTIVATE_MICROCODE=1 [before final WRITE BUFFER]</span><br><span class="line"></span><br><span class="line">  SPT=1 [protection types 1 and 2 supported]</span><br><span class="line">...</span><br><span class="line">$ sg_format -v --long --format --size=512 --fmtpinfo=3 --pfu=0 /dev/sdX</span><br><span class="line"><span class="comment"># or you could set to 4K</span></span><br><span class="line">$ sg_format -v --long --format --size=4096 --fmtpinfo=3 --pfu=0 /dev/sdX</span><br><span class="line"></span><br><span class="line"><span class="comment"># first format, show an error</span></span><br><span class="line">    inquiry cdb: 12 00 00 00 24 00</span><br><span class="line">    HGST      HUS724030ALS640   A280   peripheral_type: disk [0x0]</span><br><span class="line">      PROTECT=1</span><br><span class="line">      &lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">    mode sense (10) cdb: 5a 10 01 00 00 00 00 00 <span class="built_in">fc</span> 00</span><br><span class="line">mode sense (10):  Fixed format, current;  Sense key: Unit Attention</span><br><span class="line"> Additional sense: Mode parameters changed</span><br><span class="line">MODE SENSE (10) <span class="built_in">command</span>, unit attention</span><br><span class="line"></span><br><span class="line"><span class="comment"># try second format, it &#x27;s worked</span></span><br><span class="line">    inquiry cdb: 12 00 00 00 24 00</span><br><span class="line">    HGST      HUS724030ALS640   A280   peripheral_type: disk [0x0]</span><br><span class="line">      PROTECT=1</span><br><span class="line">      &lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">    mode sense (10) cdb: 5a 10 01 00 00 00 00 00 <span class="built_in">fc</span> 00</span><br><span class="line">    mode sense (10): pass-through requested 252 bytes but got 36 bytes</span><br><span class="line">Mode Sense (block descriptor) data, prior to changes:</span><br><span class="line">  &lt;&lt;&lt; longlba flag <span class="built_in">set</span> (64 bit lba) &gt;&gt;&gt;</span><br><span class="line">  Number of blocks=5860533168 [0x15d50a3b0]</span><br><span class="line">  Block size=512 [0x200]</span><br><span class="line"></span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 10 seconds</span><br><span class="line">    ALL data on /dev/sds will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 5 seconds</span><br><span class="line">    ALL data on /dev/sds will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">    format cdb: 04 d8 00 00 00 00</span><br><span class="line"></span><br><span class="line"><span class="comment">## After format and switch the device to the LSI-9380-8e</span></span><br><span class="line"></span><br><span class="line">Basics :</span><br><span class="line">======</span><br><span class="line">Controller = 0</span><br><span class="line">Model = AVAGO MegaRAID SAS 9380-8e</span><br><span class="line">Serial Number = SV43821663</span><br><span class="line">Current Controller Date/Time = 04/30/2020, 03:38:35</span><br><span class="line">Current System Date/time = 04/30/2020, 11:38:36</span><br><span class="line">SAS Address = 500605b00992b480</span><br><span class="line">PCI Address = 00:65:00:00</span><br><span class="line">Mfg Date = 09/19/14</span><br><span class="line">Rework Date = 00/00/00</span><br><span class="line">Revision No = 01C</span><br><span class="line"></span><br><span class="line">Version :</span><br><span class="line">=======</span><br><span class="line">Firmware Package Build = 24.21.0-0119</span><br><span class="line">Firmware Version = 4.680.00-8505</span><br><span class="line">CPLD Version = 26611-00A</span><br><span class="line">Bios Version = 6.36.00.3_4.19.08.00_0x06180203</span><br><span class="line">HII Version = 03.25.05.12</span><br><span class="line">Ctrl-R Version = 5.19-0603</span><br><span class="line">Preboot CLI Version = 01.07-05:<span class="comment">#%0000</span></span><br><span class="line">NVDATA Version = 3.1705.00-0020</span><br><span class="line">Boot Block Version = 3.07.00.00-0003</span><br><span class="line">Driver Name = megaraid_sas</span><br><span class="line">Driver Version = 07.707.50.00-rh1</span><br></pre></td></tr></table></figure><h4 id="Create-raid-and-enable-T10-pi-data-protection"><a href="#Create-raid-and-enable-T10-pi-data-protection" class="headerlink" title="Create raid and enable T10-pi data protection"></a>Create raid and enable T10-pi data protection</h4><p>you can see PI = Y , it s worked.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add &quot;pi&quot; key word</span></span><br><span class="line">$ storcli64 /c0 add vd <span class="built_in">type</span>=raid5 drives=94:13,15,17 WB pi strip=64</span><br><span class="line">$ storcli64 /c0/v1 show all</span><br><span class="line"></span><br><span class="line">CLI Version = 007.1211.0000.0000 Nov 07, 2019</span><br><span class="line">Operating system = Linux 3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">Controller = 0</span><br><span class="line">Status = Success</span><br><span class="line">Description = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/c0/v1 :</span><br><span class="line">======</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">DG/VD TYPE  State Access Consist Cache Cac sCC     Size Name</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">1/1   RAID5 Optl  RW     No      RWBD  -   ON  5.457 TB</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">EID=Enclosure Device ID| VD=Virtual Drive| DG=Drive Group|Rec=Recovery</span><br><span class="line">Cac=CacheCade|OfLn=OffLine|Pdgd=Partially Degraded|Dgrd=Degraded</span><br><span class="line">Optl=Optimal|RO=Read Only|RW=Read Write|HD=Hidden|TRANS=TransportReady|B=Blocked|</span><br><span class="line">Consist=Consistent|R=Read Ahead Always|NR=No Read Ahead|WB=WriteBack|</span><br><span class="line">AWB=Always WriteBack|WT=WriteThrough|C=Cached IO|D=Direct IO|sCC=Scheduled</span><br><span class="line">Check Consistency</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PDs <span class="keyword">for</span> VD 1 :</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">EID:Slt DID State DG     Size Intf Med SED PI SeSz Model            Sp Type</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">94:13   104 Onln   1 2.728 TB SAS  HDD N   Y  512B HUS724030ALS640  U  -</span><br><span class="line">94:15   107 Onln   1 2.728 TB SAS  HDD N   Y  512B HUS724030ALS640  U  -</span><br><span class="line">94:17   102 Onln   1 2.728 TB SAS  HDD N   Y  512B HUS724030ALS640  U  -</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">EID=Enclosure Device ID|Slt=Slot No.|DID=Device ID|DG=DriveGroup</span><br><span class="line">DHS=Dedicated Hot Spare|UGood=Unconfigured Good|GHS=Global Hotspare</span><br><span class="line">UBad=Unconfigured Bad|Onln=Online|Offln=Offline|Intf=Interface</span><br><span class="line">Med=Media Type|SED=Self Encryptive Drive|PI=Protection Info</span><br><span class="line">SeSz=Sector Size|Sp=Spun|U=Up|D=Down|T=Transition|F=Foreign</span><br><span class="line">UGUnsp=UGood Unsupported|UGShld=UnConfigured shielded|HSPShld=Hotspare shielded</span><br><span class="line">CFShld=Configured shielded|Cpybck=CopyBack|CBShld=Copyback Shielded</span><br><span class="line">UBUnsp=UBad Unsupported|Rbld=Rebuild</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>GUI set<br>[/img/adapter_support_pi.png]<br>[/img/create_r1.png]<br>[/img/create_vd_pi.png]<br>[/img/4K-pi.png]<br>[/img/512B-pi.png]<br>[/img/vd_support_pi.png]</p><h4 id="Redhat-support"><a href="#Redhat-support" class="headerlink" title="Redhat support"></a><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/ch-install-config">Redhat support</a></h4><p>Block Devices with DIF/DIX Enabled<br>DIF/DIX is a hardware checksum feature provided by certain SCSI host bus adapters and block devices. When DIF/DIX is enabled, error occurs if the block device is used as a general-purpose block device. Buffered I/O or mmap(2)-based I/O will not work reliably, as there are no interlocks in the buffered write path to prevent buffered data from being overwritten after the DIF/DIX checksum has been calculated.<br>This causes the I/O to later fail with a checksum error. This problem is common to all block device (or file system-based) buffered I/O or mmap(2) I/O, so it is not possible to work around these errors caused by overwrites.<br>As such, block devices with DIF/DIX enabled should only be used with applications that use O_DIRECT. Such applications should use the raw block device. Alternatively, it is also safe to use the XFS file system on a DIF/DIX enabled block device, as long as only O_DIRECT I/O is issued through the file system. XFS is the only file system that does not fall back to buffered I/O when doing certain allocation operations.<br>The responsibility for ensuring that the I/O data does not change after the DIF/DIX checksum has been computed always lies with the application, so only applications designed for use with O_DIRECT I/O and DIF/DIX hardware should use DIF/DIX.</p>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> raid </tag>
            
            <tag> megaraid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Test hardware and filesystem data consistency</title>
      <link href="2019/04/28/consistency-test/"/>
      <url>2019/04/28/consistency-test/</url>
      
        <content type="html"><![CDATA[<p>Because there are some Enterprise hardware firmware issue cause some function not work/data loss.<br><a href="https://engineering.nordeus.com/power-failure-testing-with-ssds/">make sure the supercapacitor is work in Enterprise SSD</a><br>In Some case, if the device partition is not aligned, the logic 512 Byte across the two physical block(512B), it will cause atomic transaction failed (enable the dev write buffer,the buffer no battery or supercapacitor)</p><h3 id="About-filesystem-settting"><a href="#About-filesystem-settting" class="headerlink" title="About filesystem settting"></a>About filesystem settting</h3><p>Disable barrier and set data is writeback </p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ext4/xfs </span>-o <span class="keyword">barrier=0,data=writeback</span></span><br><span class="line"><span class="keyword">zfs </span><span class="keyword">disable </span><span class="keyword">sync </span>write</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="PostgreSQL-Installation"><a href="#PostgreSQL-Installation" class="headerlink" title="PostgreSQL Installation"></a><a href="https://tecadmin.net/install-postgresql-11-on-centos/">PostgreSQL Installation</a></h3><p>Here is my first time to use postgresql, good luck</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.ext4 /dev/sdXX1</span><br><span class="line">$ rpm -Uvh https://yum.postgresql.org/11/redhat/rhel-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">$ yum install postgresql11-server</span><br><span class="line">$ mount /dev/sdXX1 /var/lib/pgsql -o barrier=0,data=writeback</span><br><span class="line">$ chown -R postgres.postgres /var/lib/pgsql</span><br><span class="line">$ /usr/pgsql-11/bin/postgresql-11-setup initdb</span><br><span class="line"><span class="comment"># data is in /var/lib/pgsql/11/data</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> postgresql-11</span><br><span class="line">$ systemctl start postgresql-11</span><br></pre></td></tr></table></figure><h4 id="Disable-PostgreSQL-WAL-Write-Ahead-Log"><a href="#Disable-PostgreSQL-WAL-Write-Ahead-Log" class="headerlink" title="Disable PostgreSQL WAL(Write-Ahead Log)"></a>Disable PostgreSQL WAL(Write-Ahead Log)</h4><p><a href="https://blog.nukomeet.com/faster-inserts-how-to-increase-postgresql-write-performance-24d76bd56f75">The WAL guarantees that the table data is persisted in the event of an unclean shutdown. In other words, unlogged tables are automatically cleared if the server crashes.</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE UNLOGGED TABLE user_clicks (</span><br><span class="line">  id uuid PRIMARY KEY,</span><br><span class="line">  time timestamptz,</span><br><span class="line">  user_id int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE UNLOGGED TABLE name (</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">ALTER TABLE user_clicks SET LOGGED </span><br><span class="line">ALTER TABLE user_clicks SET UNLOGGED </span><br><span class="line"></span><br><span class="line"><span class="comment"># List all unlogged tables within the current database.</span></span><br><span class="line">SELECT relname FROM pg_class WHERE relpersistence = <span class="string">&#x27;u&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="pgbench"><a href="#pgbench" class="headerlink" title="pgbench"></a>pgbench</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql -U postgres -c <span class="string">&quot;CREATE DATABASE pgbench1;&quot;</span></span><br><span class="line">$ mkdir /var/lib/pgsql/11/index</span><br><span class="line">$ chown postgres.postgres /var/lib/pgsql/11/index</span><br><span class="line">$ sudo -u postgres psql -U postgres -c <span class="string">&quot;CREATE TABLESPACE index LOCATION &#x27;/var/lib/pgsql/11/index&#x27;;&quot;</span></span><br><span class="line"><span class="comment"># init table in pgbench1</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -U postgres -i pgbench1</span><br><span class="line"></span><br><span class="line"><span class="comment"># go to postgresql terminal</span></span><br><span class="line">$ sudo -u postgres psql </span><br><span class="line"></span><br><span class="line">postgres <span class="comment"># postgres=# \l</span></span><br><span class="line"><span class="comment"># list databases;</span></span><br><span class="line">                             List of databases</span><br><span class="line">   Name    |  Owner   | Encoding  | Collate | Ctype |   Access privileges</span><br><span class="line">-----------+----------+-----------+---------+-------+-----------------------</span><br><span class="line"> pgbench1  | postgres | SQL_ASCII | C       | C     |</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># \c pgbench1</span></span><br><span class="line">You are now connected to database <span class="string">&quot;pgbench1&quot;</span> as user <span class="string">&quot;postgres&quot;</span>.</span><br><span class="line"></span><br><span class="line">pgbench1=<span class="comment"># \dt;</span></span><br><span class="line">              List of relations</span><br><span class="line"> Schema |       Name       | Type  |  Owner</span><br><span class="line">--------+------------------+-------+----------</span><br><span class="line"> public | pgbench_accounts | table | postgres</span><br><span class="line"> public | pgbench_branches | table | postgres</span><br><span class="line"> public | pgbench_history  | table | postgres</span><br><span class="line"> public | pgbench_tellers  | table | postgres</span><br><span class="line">(4 rows)</span><br><span class="line"></span><br><span class="line"><span class="comment">## it &#x27;s the pgbench create table</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -U postgres -i pgbench1 --index-tablespace=index</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_accounts(abalance,aid) TABLESPACE index;&quot;</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_history(mtime) TABLESPACE index;&quot;</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_history(aid,delta) TABLESPACE index;&quot;</span></span><br><span class="line">CREATE INDEX</span><br><span class="line"></span><br><span class="line"><span class="comment">## Disable test table WAL log</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_accounts SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_branches SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_history SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_tellers SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line"></span><br><span class="line"><span class="comment">## bengin to test</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended --random-seed=rand pgbench1</span><br><span class="line">...</span><br><span class="line">progress: 1160.0 s, 50.0 tps, lat 1184.948 ms stddev 1421.433</span><br><span class="line">progress: 1168.0 s, 50.1 tps, lat 1205.856 ms stddev 1672.771</span><br><span class="line">progress: 1176.0 s, 49.0 tps, lat 1359.426 ms stddev 1864.131</span><br><span class="line">progress: 1184.0 s, 47.5 tps, lat 1365.739 ms stddev 1912.132</span><br><span class="line">progress: 1192.0 s, 49.5 tps, lat 1341.149 ms stddev 1631.751</span><br><span class="line">progress: 1200.0 s, 48.9 tps, lat 1308.528 ms stddev 1643.086</span><br><span class="line">transaction <span class="built_in">type</span>: &lt;<span class="built_in">builtin</span>: TPC-B (sort of)&gt;</span><br><span class="line">scaling factor: 1</span><br><span class="line">query mode: extended</span><br><span class="line">number of clients: 64</span><br><span class="line">number of threads: 64</span><br><span class="line">duration: 1200 s</span><br><span class="line">number of transactions actually processed: 2750119</span><br><span class="line">latency average = 27.940 ms</span><br><span class="line">latency stddev = 181.635 ms</span><br><span class="line">tps = 2289.444326 (including connections establishing)</span><br><span class="line">tps = 2289.485134 (excluding connections establishing)</span><br></pre></td></tr></table></figure><p>In the test process, hot plugin the SSD mount at /var/lib/pgsql.<br>Dont use echo 1 &gt; /sys/block/sdXX/device/delete, the operate will sync write cache to the device</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_dumpall &gt; /dev/null</span><br></pre></td></tr></table></figure><p>Check the command has any error.</p><h3 id="Enable-WAL-test-to-test-file-system"><a href="#Enable-WAL-test-to-test-file-system" class="headerlink" title="Enable WAL test to test file system"></a><a href="http://mysql.taobao.org/monthly/2016/10/07/">Enable WAL test to test file system</a></h3><p>If you are enable WAL log, force stop the database, and the database will go to recovery</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_accounts SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_branches SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_history SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_tellers SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line"></span><br><span class="line"><span class="comment">### After enable WAL in my zfs test env, no zil</span></span><br><span class="line">progress: 792.0 s, 3699.0 tps, lat 17.227 ms stddev 20.965</span><br><span class="line">progress: 800.0 s, 3592.0 tps, lat 17.867 ms stddev 23.278</span><br><span class="line">progress: 808.0 s, 3502.7 tps, lat 18.292 ms stddev 25.962</span><br><span class="line">progress: 816.0 s, 3560.8 tps, lat 17.972 ms stddev 24.924</span><br><span class="line">progress: 824.0 s, 3628.1 tps, lat 17.656 ms stddev 23.070</span><br><span class="line">progress: 832.0 s, 3617.6 tps, lat 17.655 ms stddev 22.472</span><br><span class="line">progress: 840.0 s, 2590.1 tps, lat 21.832 ms stddev 30.337</span><br><span class="line">progress: 848.0 s, 46.5 tps, lat 1283.200 ms stddev 1202.214</span><br><span class="line">progress: 856.0 s, 5.7 tps, lat 1130.780 ms stddev 1334.794</span><br><span class="line">progress: 864.0 s, 21.3 tps, lat 5008.063 ms stddev 6756.387</span><br><span class="line">progress: 872.0 s, 48.1 tps, lat 1666.621 ms stddev 2890.584</span><br><span class="line">progress: 880.0 s, 49.1 tps, lat 1269.726 ms stddev 1383.484</span><br><span class="line">progress: 888.0 s, 50.4 tps, lat 1277.642 ms stddev 1514.558</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended <span class="attribute">--random-seed</span>=rand pgbench1</span><br><span class="line">setting random seed <span class="keyword">to</span> 4859633172491879446</span><br><span class="line">starting vacuum<span class="built_in">..</span>.end.</span><br><span class="line">progress: 8.0 s, 46.1 tps, lat 1104.991 ms stddev 997.076</span><br><span class="line">progress: 16.0 s, 48.0 tps, lat 1344.463 ms stddev 1467.943</span><br><span class="line">progress: 24.0 s, 49.9 tps, lat 1285.797 ms stddev 1509.956</span><br><span class="line">progress: 32.0 s, 47.4 tps, lat 1277.344 ms stddev 1487.591</span><br><span class="line">progress: 40.0 s, 48.8 tps, lat 1406.851 ms stddev 1789.872</span><br><span class="line">progress: 48.0 s, 38.1 tps, lat 1477.057 ms stddev 1411.267</span><br><span class="line">progress: 56.0 s, 39.0 tps, lat 1695.951 ms stddev 2172.428</span><br><span class="line">progress: 64.0 s, 51.5 tps, lat 1270.484 ms stddev 2008.514</span><br><span class="line">progress: 72.0 s, 48.1 tps, lat 1260.300 ms stddev 1831.611</span><br><span class="line">progress: 80.0 s, 42.6 tps, lat 1605.049 ms stddev 2572.170</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable it immediate</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_ctl stop  -D /var/lib/pgsql/11/data -m immediate</span><br><span class="line"></span><br><span class="line">waiting <span class="keyword">for</span><span class="built_in"> server </span><span class="keyword">to</span> shut down<span class="built_in">..</span><span class="built_in">..</span> done</span><br><span class="line">server stopped</span><br><span class="line"></span><br><span class="line">progress: 768.0 s, 41.1 tps, lat 1562.948 ms stddev 1996.733</span><br><span class="line">progress: 776.0 s, 48.3 tps, lat 1258.457 ms stddev 1728.933</span><br><span class="line">WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line"></span><br><span class="line"><span class="comment">### postgresql log</span></span><br><span class="line">$ tail -f /var/lib/pgsql/11/data/log/postgresql-Mon.log</span><br><span class="line"></span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] CONTEXT:  <span class="keyword">while</span> rechecking updated tuple (3,17) <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span></span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] CONTEXT:  <span class="keyword">while</span> updating tuple (17,116) <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span></span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] WARNING:  terminating<span class="built_in"> connection </span>because of crash of another<span class="built_in"> server </span>process</span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] DETAIL:  The postmaster has commanded this<span class="built_in"> server </span>process <span class="keyword">to</span> roll back the current transaction <span class="keyword">and</span> exit, because another<span class="built_in"> server </span>process exited abnormally <span class="keyword">and</span> possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] HINT:  <span class="keyword">In</span> a moment you should be able <span class="keyword">to</span> reconnect <span class="keyword">to</span> the database <span class="keyword">and</span> repeat your command.</span><br><span class="line">2019-04-29 07:43:53.667 UTC [450] LOG:  database<span class="built_in"> system </span>is shut down</span><br><span class="line"></span><br><span class="line">$ cd /var/lib/pgsql/11/data/pg_wal</span><br><span class="line"><span class="comment">#let &#x27;s test 14834480</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_waldump -b 00000001000000010000008D | grep Transaction | tail | head -n 1</span><br><span class="line">pg_waldump: FATAL:  <span class="builtin-name">error</span> <span class="keyword">in</span> WAL record at 1/8DEFE4B0: invalid record length at 1/8DEFE4D8: wanted 24, got 0</span><br><span class="line">rmgr: Transaction len (rec/tot):     34/    34, tx:   14834480, lsn: 1/8DEFCAF8, prev 1/8DEFCAB8, desc: COMMIT 2019-04-29 07:43:53.168178 UTC</span><br><span class="line"></span><br><span class="line">$ <span class="attribute">pgbench1</span>=# select xmin,* <span class="keyword">from</span> pgbench_history where xmin <span class="keyword">in</span> (14834480);</span><br><span class="line">   xmin   | tid | bid |  aid  | delta |           mtime            | filler</span><br><span class="line">----------+-----+-----+-------+-------+----------------------------+--------</span><br><span class="line"> 14834480 |  10 |   1 | 57633 |  1859 | 2019-04-29 08:41:26.458402 |</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">$ dd <span class="attribute">if</span>=/dev/zero <span class="attribute">of</span>=./00000001000000010000008D <span class="attribute">bs</span>=1 <span class="attribute">count</span>=10000 <span class="attribute">skip</span>=100</span><br><span class="line"></span><br><span class="line">$ tail -f /var/lib/pgsql/11/data/log/postgresql-Mon.log </span><br><span class="line">2019-04-29 07:57:03.979 UTC [11634] LOG:  database<span class="built_in"> system </span>was interrupted; last known up at 2019-04-29 07:41:55 UTC</span><br><span class="line">2019-04-29 07:57:04.050 UTC [11634] LOG:  invalid primary checkpoint record</span><br><span class="line">2019-04-29 07:57:04.051 UTC [11634] PANIC:  could <span class="keyword">not</span> locate a valid checkpoint record</span><br><span class="line">2019-04-29 07:57:04.171 UTC [11632] LOG:  startup process (PID 11634) was terminated by signal 6: Aborted</span><br><span class="line">2019-04-29 07:57:04.171 UTC [11632] LOG:  aborting startup due <span class="keyword">to</span> startup process failure</span><br><span class="line">2019-04-29 07:57:04.173 UTC [11632] LOG:  database<span class="built_in"> system </span>is shut down</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_resetwal -f /var/lib/pgsql/11/data</span><br><span class="line">Write-ahead log reset</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_ctl start  -D /var/lib/pgsql/11/data</span><br><span class="line">waiting <span class="keyword">for</span><span class="built_in"> server </span><span class="keyword">to</span> start<span class="built_in">..</span><span class="built_in">..</span>2019-04-29 08:17:18.990 UTC [11662] LOG:  listening on<span class="built_in"> IPv6 address </span><span class="string">&quot;::1&quot;</span>,<span class="built_in"> port </span>5432</span><br><span class="line">2019-04-29 08:17:18.990 UTC [11662] LOG:  listening on IPv4<span class="built_in"> address </span><span class="string">&quot;127.0.0.1&quot;</span>,<span class="built_in"> port </span>5432</span><br><span class="line">2019-04-29 08:17:19.000 UTC [11662] LOG:  listening on Unix socket <span class="string">&quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span><br><span class="line">2019-04-29 08:17:19.026 UTC [11662] LOG:  listening on Unix socket <span class="string">&quot;/tmp/.s.PGSQL.5432&quot;</span></span><br><span class="line">2019-04-29 08:17:19.050 UTC [11662] LOG:  redirecting log output <span class="keyword">to</span><span class="built_in"> logging </span>collector process</span><br><span class="line">2019-04-29 08:17:19.050 UTC [11662] HINT:  Future log output will appear <span class="keyword">in</span> directory <span class="string">&quot;log&quot;</span>.</span><br><span class="line"> done</span><br><span class="line">server started</span><br><span class="line"></span><br><span class="line">$ tail -f /var/lib/pgsql/11/data/log/postgresql-Mon.log</span><br><span class="line">2019-04-29 08:17:19.064 UTC [11664] LOG:  database<span class="built_in"> system </span>was shut down at 2019-04-29 08:17:11 UTC</span><br><span class="line">2019-04-29 08:17:19.104 UTC [11662] LOG:  database<span class="built_in"> system </span>is ready <span class="keyword">to</span> accept connections</span><br><span class="line">2019-04-29 08:17:31.640 UTC [11671] WARNING: <span class="built_in"> page </span>is <span class="keyword">not</span> marked all-visible but visibility map bit is <span class="builtin-name">set</span> <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span><span class="built_in"> page </span>0</span><br><span class="line">2019-04-29 08:17:31.640 UTC [11671] WARNING: <span class="built_in"> page </span>is <span class="keyword">not</span> marked all-visible but visibility map bit is <span class="builtin-name">set</span> <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span><span class="built_in"> page </span>3</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can&#x27;t found it</span></span><br><span class="line">$ <span class="attribute">pgbench1</span>=# select xmin,* <span class="keyword">from</span> pgbench_history where xmin <span class="keyword">in</span> (14834480);</span><br><span class="line"> xmin | tid | bid | aid | delta | mtime | filler</span><br><span class="line">------+-----+-----+-----+-------+-------+--------</span><br><span class="line">(0 rows)</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended <span class="attribute">--random-seed</span>=rand pgbench1</span><br><span class="line">setting random seed <span class="keyword">to</span> 4384533976954680126</span><br><span class="line">starting vacuum<span class="built_in">..</span>.end.</span><br><span class="line">empty range given <span class="keyword">to</span> random</span><br><span class="line">client 1 aborted <span class="keyword">in</span> command 0 (set) of<span class="built_in"> script </span>0; evaluation of meta-command failed</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">empty range given <span class="keyword">to</span> random</span><br><span class="line">client 40 aborted <span class="keyword">in</span> command 0 (set) of<span class="built_in"> script </span>0; evaluation of meta-command failed</span><br><span class="line">transaction type: &lt;builtin: TPC-B (sort of)&gt;</span><br><span class="line">scaling factor: 0</span><br><span class="line">query mode: extended</span><br><span class="line">number of clients: 64</span><br><span class="line">number of threads: 64</span><br><span class="line">duration: 1200 s</span><br><span class="line">number of transactions actually processed: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">## re-init</span></span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -i pgbench1</span><br><span class="line">dropping old tables<span class="built_in">..</span>.</span><br><span class="line">creating tables<span class="built_in">..</span>.</span><br><span class="line">generating data<span class="built_in">..</span>.</span><br><span class="line">100000 of 100000 tuples (100%) done (elapsed 0.12 s, remaining 0.00 s)</span><br><span class="line">vacuuming<span class="built_in">..</span>.</span><br><span class="line">creating primary keys<span class="built_in">..</span>.</span><br><span class="line">done.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Oh shit,it looks like meta data loss cause tables incomplelte.</p><p><a href="https://github.com/winlibs/postgresql/blob/master/src/backend/commands/vacuumlazy.c">source code</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * As of PostgreSQL 9.2, the visibility map bit should never be set if</span></span><br><span class="line"><span class="comment"> * the page-level bit is clear.  However, it&#x27;s possible that the bit</span></span><br><span class="line"><span class="comment"> * got cleared after we checked it and before we took the buffer</span></span><br><span class="line"><span class="comment"> * content lock, so we must recheck before jumping to the conclusion</span></span><br><span class="line"><span class="comment"> * that something bad has happened.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (all_visible_according_to_vm &amp;&amp; !PageIsAllVisible(page)</span><br><span class="line"> &amp;&amp; VM_ALL_VISIBLE(onerel, blkno, &amp;vmbuffer))</span><br><span class="line">&#123;</span><br><span class="line">elog(WARNING, <span class="string">&quot;page is not marked all-visible but visibility map bit is set in relation \&quot;%s\&quot; page %u&quot;</span>,</span><br><span class="line"> relname, blkno);</span><br><span class="line">visibilitymap_clear(onerel, blkno, vmbuffer,</span><br><span class="line">VISIBILITYMAP_VALID_BITS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FIO-verify"><a href="#FIO-verify" class="headerlink" title="FIO verify"></a><a href="https://github.com/axboe/fio/issues/713">FIO verify</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=512 --iodepth=1 --readwrite=randwrite --size=1G --numjobs=1 --verify=crc64 --do_verify=1 --verify_state_save=1 --group_reporting --verify_backlog=8192</span><br><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=512 --iodepth=1 --readwrite=randread  --size=1G --numjobs=1 --verify=crc64 --group_reporting --verify_only --verify_dump=1 --verify_state_load=1 --do_verify=1 --verify_backlog=8192</span><br><span class="line"></span><br><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=4K --iodepth=1 --readwrite=randwrite --size=4G --numjobs=1 --verify=crc64 --do_verify=1 --verify_state_save=1 --group_reporting --verify_backlog=8192</span><br><span class="line">$ fio --ioengine=libaio --name=<span class="built_in">test</span> --direct=1 --directory=<span class="variable">$filepath</span> --bs=4K --iodepth=1 --readwrite=randread  --size=4G --numjobs=1 --verify=crc64 --group_reporting --verify_only --verify_dump=1 --verify_state_load=1 --do_verify=1 --verify_backlog=8192</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Benchmark </category>
          
      </categories>
      
      
        <tags>
            
            <tag> postgresql </tag>
            
            <tag> test </tag>
            
            <tag> fio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux container with zfs</title>
      <link href="2019/04/02/lxc_with_zfs/"/>
      <url>2019/04/02/lxc_with_zfs/</url>
      
        <content type="html"><![CDATA[<h3 id="Create-bridge"><a href="#Create-bridge" class="headerlink" title="Create bridge"></a>Create bridge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">br08000.ba02751fd447noeno2</span><br><span class="line"></span><br><span class="line">$ cat /etc/netplan/50-cloud-init.yaml</span><br><span class="line"><span class="comment"># This file is generated from information provided by</span></span><br><span class="line"><span class="comment"># the datasource.  Changes to it will not persist across an instance.</span></span><br><span class="line"><span class="comment"># To disable cloud-init&#x27;s network configuration capabilities, write a file</span></span><br><span class="line"><span class="comment"># /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:</span></span><br><span class="line"><span class="comment"># network: &#123;config: disabled&#125;</span></span><br><span class="line">network:</span><br><span class="line">    version: 2</span><br><span class="line">    ethernets:</span><br><span class="line">        eno1:</span><br><span class="line">            addresses: []</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            dhcp6: <span class="literal">false</span></span><br><span class="line">        eno2:</span><br><span class="line">            addresses: []</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            dhcp6: <span class="literal">false</span></span><br><span class="line">        eno3:</span><br><span class="line">            addresses: [AA.AA.AA.AA/BB]</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            dhcp6: <span class="literal">false</span></span><br><span class="line">        eno4:</span><br><span class="line">            addresses: [BB.BB.BB.BB/CC]</span><br><span class="line">            <span class="comment">#gateway4: your.gatway</span></span><br><span class="line">            <span class="comment">#nameservers:</span></span><br><span class="line">            <span class="comment">#    addresses:</span></span><br><span class="line">            <span class="comment">#    - your.dns.addr</span></span><br><span class="line">            <span class="comment">#    search: []</span></span><br><span class="line">    bridges:</span><br><span class="line">      br0:</span><br><span class="line">        interfaces: [eno2]</span><br><span class="line">        dhcp4: <span class="literal">true</span></span><br><span class="line">        dhcp6: <span class="literal">false</span></span><br><span class="line">        addresses: [CC.CC.CC.CC/DD]</span><br><span class="line">        gateway4: your.gatway</span><br><span class="line">        nameservers:</span><br><span class="line">          addresses: [your.dns.addr]</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Add-bridge"><a href="#Add-bridge" class="headerlink" title="Add bridge"></a>Add bridge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ lxc init</span><br><span class="line">$ cat &lt;&lt;EOF | lxc profile edit default</span><br><span class="line">description: Bridged networking LXD profile</span><br><span class="line">devices:</span><br><span class="line">  eth0:</span><br><span class="line">    name: eth0</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: br0</span><br><span class="line">    <span class="built_in">type</span>: nic</span><br><span class="line">EOF</span><br><span class="line">$ lxc profile list</span><br><span class="line">$ lxc profile show default</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you are not default</span></span><br><span class="line">$ lxc profile delete your_custom_config</span><br></pre></td></tr></table></figure><h3 id="Add-zfs-zpool"><a href="#Add-zfs-zpool" class="headerlink" title="Add zfs zpool"></a>Add zfs zpool</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ zfs create tank/lxd</span><br><span class="line">$ lxc storage create zfs-pool zfs <span class="attribute">source</span>=tank/lxd</span><br><span class="line"></span><br><span class="line">$ lxc<span class="built_in"> profile </span>show default</span><br><span class="line">config: &#123;&#125;</span><br><span class="line">description:<span class="built_in"> Default </span>LXD profile</span><br><span class="line">devices:</span><br><span class="line">  eth0:</span><br><span class="line">    name: eth0</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: br0</span><br><span class="line">    type: nic</span><br><span class="line">  root:</span><br><span class="line">    path: /</span><br><span class="line">    pool: zfs-pool</span><br><span class="line">    size: <span class="string">&quot;0&quot;</span></span><br><span class="line">    type: disk</span><br><span class="line">name: default</span><br><span class="line">used_by:</span><br><span class="line">- /1.0/containers/centos7-01</span><br></pre></td></tr></table></figure><h3 id="Custom-centos-7-image"><a href="#Custom-centos-7-image" class="headerlink" title="Custom centos 7 image"></a>Custom centos 7 image</h3><p>Found a centos 7 server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ mount CentOS-7-x86_64-Everything-1804.iso /mnt -o loop</span><br><span class="line">$ cat /tank/vms/lxc-images/centos7/etc/yum.repos.d/base.repo</span><br><span class="line">[base]</span><br><span class="line">gpgcheck=0</span><br><span class="line">baseurl=file:/mnt</span><br><span class="line">name=CentOS-7</span><br><span class="line"></span><br><span class="line">$ yum -y --installroot=/tank/vms/lxc-images/centos7 install systemd passwd yum redhat-release vim-minimal openssh-server screen qperf sysstat lsof nfs-utils rsync libselinux-python openssh-clients net-tools strace attr yum-utils coreutils pciutils</span><br><span class="line">$ rm -f /tank/vms/lxc-images/centos7/etc/yum.repos.d/CentOS-*</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /tank/vms/lxc-images/centos7/</span><br><span class="line">$ tar cjvf  centos-7-x86_64.tar.gz *</span><br><span class="line"></span><br><span class="line">$ cat metadata.yaml</span><br><span class="line">architecture: <span class="string">&quot;x86_64&quot;</span></span><br><span class="line">creation_date: 1554097535 <span class="comment"># To get current date in Unix time, use `date +%s` command</span></span><br><span class="line">properties:</span><br><span class="line">architecture: <span class="string">&quot;x86_64&quot;</span></span><br><span class="line">description: <span class="string">&quot;CentOS 7.6 add openssh&quot;</span></span><br><span class="line">os: <span class="string">&quot;centos&quot;</span></span><br><span class="line">release: <span class="string">&quot;sid&quot;</span></span><br><span class="line"></span><br><span class="line">$ tar czvf metadata.tar.gz metadata.yaml</span><br><span class="line">$ lxc image import metadata.tar.gz centos-7-x86_64.tar.gz --<span class="built_in">alias</span> custom-for-centos7</span><br><span class="line"></span><br><span class="line">$ lxc image list</span><br><span class="line">+--------------------+--------------+--------+-------------+--------+----------+-----------------------------+</span><br><span class="line">|       ALIAS        | FINGERPRINT  | PUBLIC | DESCRIPTION |  ARCH  |   SIZE   |         UPLOAD DATE         |</span><br><span class="line">+--------------------+--------------+--------+-------------+--------+----------+-----------------------------+</span><br><span class="line">| custom-for-centos7 | 662e0004303e | no     |             | x86_64 | 174.80MB | Apr 1, 2019 at 5:46am (UTC) |</span><br><span class="line">+--------------------+--------------+--------+-------------+--------+----------+-----------------------------+</span><br><span class="line"></span><br><span class="line">$ lxc launch custom-for-centos7 centos-7-0</span><br><span class="line"></span><br><span class="line"><span class="comment">### You need set it to 0 before you launch the custom image</span></span><br><span class="line">$ lxc profile device <span class="built_in">set</span> default root size 0</span><br><span class="line">$ lxc launch custom-for-centos7 centos-7-0</span><br><span class="line">Creating centos-7-71</span><br><span class="line">Starting centos-7-71</span><br></pre></td></tr></table></figure><h3 id="Connect-bash-tty"><a href="#Connect-bash-tty" class="headerlink" title="Connect bash tty"></a>Connect bash tty</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lxc <span class="built_in">exec</span> centos-7-0 /bin/bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install openssh-server</span></span><br></pre></td></tr></table></figure><h3 id="Limit-the-container-resources"><a href="#Limit-the-container-resources" class="headerlink" title="Limit the container resources"></a>Limit the container resources</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu 4</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu 0,3,7-9</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu.allowance 20%</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu.allowance 100ms/200ms</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.cpu.priority 5</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.memory 8GB</span><br><span class="line">$ lxc<span class="built_in"> config </span><span class="builtin-name">set</span> centos-7-0 limits.memory.swap <span class="literal">true</span></span><br><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">set</span> centos-7-0 root limits.read 125MB</span><br><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">set</span> centos-7-0 root limits.write 125MB</span><br></pre></td></tr></table></figure><h4 id="Show-the-expanded-config"><a href="#Show-the-expanded-config" class="headerlink" title="Show the expanded config"></a>Show the expanded config</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lxc<span class="built_in"> config </span>show --expanded centos-7-0</span><br></pre></td></tr></table></figure><h4 id="Limit-root-partition"><a href="#Limit-root-partition" class="headerlink" title="Limit root partition"></a>Limit root partition</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">add</span> centos-7-0 root disk <span class="attribute">path</span>=/ <span class="attribute">pool</span>=zfs-pool <span class="attribute">size</span>=200GB</span><br><span class="line"><span class="comment">## for all root partition</span></span><br><span class="line">$ lxc<span class="built_in"> profile </span>device <span class="builtin-name">set</span><span class="built_in"> default </span>root size 200GB</span><br></pre></td></tr></table></figure><h4 id="List-contanier-device"><a href="#List-contanier-device" class="headerlink" title="List contanier device"></a>List contanier device</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lxc<span class="built_in"> profile </span>device list default</span><br><span class="line">eth0</span><br><span class="line">root</span><br></pre></td></tr></table></figure><h4 id="Clone-container-to-image"><a href="#Clone-container-to-image" class="headerlink" title="Clone container to image"></a>Clone container to image</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ lxc stop centos-7-0</span><br><span class="line">$ lxc-stop -n centos-7-0 -k <span class="comment">## force</span></span><br><span class="line">$ lxc publish centos-7-0 --<span class="built_in">alias</span>=centos-7.6-1 description=<span class="string">&quot;Test base image update1&quot;</span></span><br><span class="line">$ lxc image list</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line">|       ALIAS        | FINGERPRINT  | PUBLIC |       DESCRIPTION       |  ARCH  |   SIZE   |         UPLOAD DATE         |</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line">| centos7.6-1        | 1741cafe0ae2 | no     | Test base image update1 | x86_64 | 213.75MB | Apr 1, 2019 at 7:09am (UTC) |</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line">| custom-for-centos7 | 662e0004303e | no     |                         | x86_64 | 174.80MB | Apr 1, 2019 at 5:46am (UTC) |</span><br><span class="line">+--------------------+--------------+--------+-------------------------+--------+----------+-----------------------------+</span><br><span class="line"></span><br><span class="line">$ lxc launch centos7.6-1 centos-7-2</span><br><span class="line">$ lxc delete centos-7-0</span><br><span class="line">$ lxc info centos-7-2</span><br><span class="line"></span><br><span class="line"><span class="comment">#Show internet image</span></span><br><span class="line">lxc image list images:</span><br></pre></td></tr></table></figure><h4 id="Show-container-info"><a href="#Show-container-info" class="headerlink" title="Show container info"></a>Show container info</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxc <span class="built_in">list</span></span><br></pre></td></tr></table></figure><h3 id="Container-config-file"><a href="#Container-config-file" class="headerlink" title="Container config file"></a>Container config file</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">lxd</span>/<span class="title">storage</span>-<span class="title">pools</span>/<span class="title">zfs</span>-<span class="title">pool</span>/<span class="title">containers</span>/<span class="title">centos</span>-7-0</span></span><br></pre></td></tr></table></figure><h3 id="Enable-the-container-support-NFS"><a href="#Enable-the-container-support-NFS" class="headerlink" title="Enable the container support NFS"></a>Enable the container support NFS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lxc config <span class="built_in">set</span> centos-7-71 security.privileged <span class="literal">true</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;mount fstype=nfs,\nmount fstype=nfs4,&quot;</span> | lxc config <span class="built_in">set</span> centos-7-71 raw.apparmor -</span><br></pre></td></tr></table></figure><h3 id="Create-a-new-profile-and-assign-the-config-to-the-container"><a href="#Create-a-new-profile-and-assign-the-config-to-the-container" class="headerlink" title="Create a new profile and assign the config to the container"></a>Create a new profile and assign the config to the container</h3><p>``<br>$ lxc profile show ipmi-manager<br>config: {}<br>description: ipmitool manager node<br>devices:<br>  eth0:<br>    name: eth0<br>    nictype: bridged<br>    parent: br1<br>    type: nic<br>  eth1:<br>    name: eth1<br>    nictype: bridged<br>    parent: br2<br>    type: nic<br>  root:<br>    path: /<br>    pool: zfs-pool<br>    size: 0<br>    type: disk<br>name: ipmi-manager</p><p>$ lxc profile remove c1 default<br>$ lxc profile assign c1 ipmi-manager<br>$ lxc exec c1 /bin/bash<br>$ ls /sys/class/net<br>eth0  eth1  lo</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### Auto start</span><br></pre></td></tr></table></figure><p>lxc config set $container boot.autostart true<br>lxc config set $container boot.autostart.delay 10</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">### mount iso</span></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># in physical server</span></span><br><span class="line">$ lxc<span class="built_in"> config </span>device <span class="builtin-name">add</span> centos7-samba-105 loop0 unix-block <span class="attribute">path</span>=/dev/loop0</span><br><span class="line"></span><br><span class="line"><span class="comment"># in container</span></span><br><span class="line">$ mknod /dev/loop0 b 7 0</span><br></pre></td></tr></table></figure><h3 id="Mount-host-lustre"><a href="#Mount-host-lustre" class="headerlink" title="Mount host lustre"></a><a href="https://www.cyberciti.biz/faq/how-to-add-or-mount-directory-in-lxd-linux-container/?nsukey=eiv2/uile9LfG55dOvcg55UtqOWQ19bxIsDY+cQHH0EMOu865QP86rrt/4aONbgQSMEg8ZarwNEM4Co5kKScLxO3eE3FlG3d9V9iWG2UTcog+3x2ZWXy5itNokLMg8/1KVsyd05MctDSgYCklGPMNeT+muNtI5ICfGvH+nheN7AIRFdmDWdo6CI0/00wWjDhsgsSVRZx2qEfz1UKB1kkOA==">Mount host lustre</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ mount.lustre xx.xx.xx.xx@tcp:/lustre /mnt -o localflock,user_xattr</span><br><span class="line">$ df -h <span class="comment"># make sure has mountted</span></span><br><span class="line">$ lxc list</span><br><span class="line">$ lxc config device add c1 mytestdir disk <span class="built_in">source</span>=/mnt path=/dest/</span><br><span class="line">$ lxc config device show c1</span><br><span class="line">$ lxc <span class="built_in">exec</span> c1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># in container</span></span><br><span class="line">$ df -h</span><br><span class="line">xx.xx.xx.xx@tcp:/lustre              lustre    10T  491M  10T   1% /dest</span><br><span class="line">$ umount /dest</span><br><span class="line"></span><br><span class="line"><span class="comment"># in host</span></span><br><span class="line">xx.xx.xx.xx@tcp:/lustre                        10T  491M  10T   1% /var/lib/lxd/devices/c1/disk.mytestdir.dest-</span><br><span class="line"></span><br><span class="line">$ lxc config device remove c1 mytestdir</span><br><span class="line"></span><br><span class="line">$ cat /etc/subgid /etc/subuid</span><br><span class="line"><span class="comment">#login name or UID</span></span><br><span class="line"><span class="comment">#numerical subordinate group ID</span></span><br><span class="line"><span class="comment">#numerical subordinate group ID count</span></span><br><span class="line"><span class="comment">#modify root to nobody(65534)</span></span><br><span class="line">root:100000:65534</span><br><span class="line">root:100000:65534</span><br><span class="line"></span><br><span class="line"><span class="comment">## The container root and ubuntu physical root has the same permission</span></span><br><span class="line"><span class="comment">## Lustre has the same setting with the permission</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ubuntu lustre client version</span></span><br><span class="line">$ cat /sys/fs/lustre/version</span><br><span class="line">2.12.55_dirty</span><br></pre></td></tr></table></figure><p><a href="https://gist.github.com/jeanlouisferey/15be1f421eb9f9a66f1c74d410de2675">https://gist.github.com/jeanlouisferey/15be1f421eb9f9a66f1c74d410de2675</a><br><a href="https://angristan.xyz/lxc-zfs-pool-lxd/">https://angristan.xyz/lxc-zfs-pool-lxd/</a><br><a href="https://blog.simos.info/how-to-make-your-lxd-containers-get-ip-addresses-from-your-lan-using-a-bridge/">https://blog.simos.info/how-to-make-your-lxd-containers-get-ip-addresses-from-your-lan-using-a-bridge/</a><br><a href="https://www.tomvanbrienen.nl/installing-and-configuring-lxd-3-on-ubuntu-18-04/">https://www.tomvanbrienen.nl/installing-and-configuring-lxd-3-on-ubuntu-18-04/</a><br><a href="https://tutorials.ubuntu.com/tutorial/create-custom-lxd-images#4">https://tutorials.ubuntu.com/tutorial/create-custom-lxd-images#4</a><br><a href="https://github.com/lxc/lxd/issues/3096">https://github.com/lxc/lxd/issues/3096</a><br><a href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/LXC+Template+creation#LXCTemplatecreation-StepstocreateminimalCentOS6containertemplate">https://cwiki.apache.org/confluence/display/CLOUDSTACK/LXC+Template+creation#LXCTemplatecreation-StepstocreateminimalCentOS6containertemplate</a>:<br><a href="https://blog.simos.info/using-distrobuilder-to-create-container-images-for-lxc-and-lxd/">https://blog.simos.info/using-distrobuilder-to-create-container-images-for-lxc-and-lxd/</a></p>]]></content>
      
      
      <categories>
          
          <category> Virtualization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lxc </tag>
            
            <tag> zfs </tag>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>the HDD power mode</title>
      <link href="2019/01/03/hdd-power-mode/"/>
      <url>2019/01/03/hdd-power-mode/</url>
      
        <content type="html"><![CDATA[<h3 id="About-HDD-power-save-mode"><a href="#About-HDD-power-save-mode" class="headerlink" title="About HDD power save mode"></a><a href="https://www.seagate.com/files/docs/pdf/whitepaper/tp608-powerchoice-tech-provides-us.pdf">About HDD power save mode</a></h3><p>Idle_0</p><ul><li>Drive Ready, but not performing IO, drive may power down selected electronics to reduce power without increasing response time</li></ul><p>Idle_A</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Disks rotating at full speed (7200 RPM)</li></ul><p>Idle_B</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Heads are unloaded to drive ramp.</li><li>Disks rotating at full speed (7200 RPM)</li></ul><p>Idle_C/Standby_Y (SAS Only)</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Heads are unloaded to drive ramp.</li><li>Drive speed reduced to a lower RPM (reduced RPM)</li></ul><p>Standby_Z</p><ul><li>Heads are unloaded to drive ramp.</li><li>Drive motor is spun down.</li><li>Drive still responds to non-media access host commands.</li></ul><a id="more"></a><p>SAS</p><ul><li>Host-definable timers via mode pages</li><li>Immediate host-commanded power transitions via Start/Stop Unit (SSU) command</li></ul><table><thead><tr><th align="center">From</th><th align="center">To</th><th align="center">RPM</th><th align="center">Typical(sec)</th><th align="center">Max(sec)</th></tr></thead><tbody><tr><td align="center">idle_b</td><td align="center">Active</td><td align="center">7200</td><td align="center">1</td><td align="center">30</td></tr><tr><td align="center">idle_c</td><td align="center">Active</td><td align="center">6300 -&gt;7200</td><td align="center">4</td><td align="center">30</td></tr><tr><td align="center">standby_y</td><td align="center">Active</td><td align="center">6300 -&gt;7200</td><td align="center">4</td><td align="center">30</td></tr><tr><td align="center">standby_z</td><td align="center">Active</td><td align="center">0 -&gt; 7200</td><td align="center">15</td><td align="center">30</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">$ sg_logs -p 0x1a /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Power condition transitions page  [0x1a]</span><br><span class="line">  Accumulated transitions to active = 700283</span><br><span class="line">  Accumulated transitions to idle_a = 698441</span><br><span class="line">  Accumulated transitions to idle_b = 1855</span><br><span class="line">  Accumulated transitions to idle_c = 0</span><br><span class="line">  Accumulated transitions to standby_z = 0</span><br><span class="line">  Accumulated transitions to standby_y = 0</span><br><span class="line"></span><br><span class="line">$ sg_logs -p 0x1a /dev/sdj</span><br><span class="line">    SEAGATE   ST10000NM0256     TT54</span><br><span class="line">Power condition transitions page  (spc-4) [0x1a]</span><br><span class="line">  Accumulated transitions to idle_a = 13934971</span><br><span class="line">  Accumulated transitions to idle_b = 13934971</span><br><span class="line">  Accumulated transitions to idle_c = 99</span><br><span class="line">  Reserved [0x4] = 0</span><br><span class="line">  Accumulated transitions to standby_z = 0</span><br><span class="line">  Accumulated transitions to standby_y = 0</span><br><span class="line"></span><br><span class="line">$ sdparm -p po -l  /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    Direct access device specific parameters: WP=0  DPOFUA=1</span><br><span class="line">Power condition [po] mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]  Power management, background <span class="built_in">functions</span>, precedence</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]  Standby_y timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]  Idle_c timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]  Idle_b timer <span class="built_in">enable</span></span><br><span class="line">  IDLE          1  [cha: y, def:  1, sav:  1]  Idle_a timer <span class="built_in">enable</span></span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]  Standby_z timer <span class="built_in">enable</span></span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]  Idle_a condition timer (100 ms)</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]  Standby_z condition timer (100 ms)</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]  Idle_b condition timer (100 ms)</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]  Idle_c condition timer (100 ms)</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]  Standby_y condition timer (100 ms)</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]  check condition on transition from idle</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]  check condition on transition from standby</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]  check condition on transition from stopped</span><br><span class="line"></span><br><span class="line"><span class="comment"># looks like cha: n means could not be modified</span></span><br><span class="line"></span><br><span class="line">$ sdparm -p po -l  /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    Direct access device specific parameters: WP=0  DPOFUA=1</span><br><span class="line">Power condition [po] mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]  Power management, background <span class="built_in">functions</span>, precedence</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]  Standby_y timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]  Idle_c timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]  Idle_b timer <span class="built_in">enable</span></span><br><span class="line">  IDLE          0  [cha: y, def:  1, sav:  0]  Idle_a timer <span class="built_in">enable</span></span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]  Standby_z timer <span class="built_in">enable</span></span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]  Idle_a condition timer (100 ms)</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]  Standby_z condition timer (100 ms)</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]  Idle_b condition timer (100 ms)</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]  Idle_c condition timer (100 ms)</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]  Standby_y condition timer (100 ms)</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]  check condition on transition from idle</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]  check condition on transition from standby</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]  check condition on transition from stopped</span><br><span class="line"></span><br><span class="line">$ sdparm -v -S -p po --<span class="built_in">set</span>=IDLE=1 /dev/sdj</span><br><span class="line">mp_settings: page,subpage=0x1a,0x0  num=1</span><br><span class="line">  pdt=-1 start_byte=0x3 start_bit=1 num_bits=1  val=1  acronym: IDLE</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    mode sense (10) cdb: 5a 00 1a 00 00 00 00 00 04 00</span><br><span class="line">    mode sense (10) cdb: 5a 00 1a 00 00 00 00 00 38 00</span><br><span class="line">    mode select (10) cdb: 55 11 00 00 00 00 00 00 38 00</span><br><span class="line"></span><br><span class="line">$ sdparm -p po -l  /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    Direct access device specific parameters: WP=0  DPOFUA=1</span><br><span class="line">Power condition [po] mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]  Power management, background <span class="built_in">functions</span>, precedence</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]  Standby_y timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]  Idle_c timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]  Idle_b timer <span class="built_in">enable</span></span><br><span class="line">  IDLE          1  [cha: y, def:  1, sav:  1]  Idle_a timer <span class="built_in">enable</span></span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]  Standby_z timer <span class="built_in">enable</span></span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]  Idle_a condition timer (100 ms)</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]  Standby_z condition timer (100 ms)</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]  Idle_b condition timer (100 ms)</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]  Idle_c condition timer (100 ms)</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]  Standby_y condition timer (100 ms)</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]  check condition on transition from idle</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]  check condition on transition from standby</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]  check condition on transition from stopped</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable IDLE_C</span></span><br><span class="line">$ sdparm --flexible -6  -v -p po --<span class="built_in">set</span>=IDLE_C=0 /dev/sdj</span><br><span class="line"></span><br><span class="line"><span class="comment"># Got all page name </span></span><br><span class="line">$ sdparm -e /dev/sdj</span><br></pre></td></tr></table></figure><p><a href="https://wiki.archlinux.org/index.php/hdparm#Power_management_configuration">SATA HDD</a></p><ul><li>Host-definable timers via Set Features commands</li><li>Immediate host-commanded power transitions via Set Features commands </li></ul><p>-B Set the Advanced Power Management feature. Possible values are between 1 and 255, low values mean more aggressive power management and higher values mean better performance. Values from 1 to 127 permit spin-down, whereas values from 128 to 254 do not. A value of 255 completely disables the feature</p><p>-S Set the standby (spindown) timeout for the drive. The timeout specifies how long to wait in idle (with no disk activity) before turning off the motor to save power. The value of 0 disables spindown, the values from 1 to 240 specify multiples of 5 seconds and values from 241 to 251 specify multiples of 30 minutes. </p><p>-M Set the Automatic Acoustic Management feature. Most modern hard disk drives have the ability to speed down the head movements to reduce their noise output. The possible value depends on the disk, some disks may not support this feature. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ hdparm -B 127 /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> setting Advanced Power Management level to 0x7f (127)</span><br><span class="line"> APM_level= 127</span><br><span class="line"></span><br><span class="line">$ hdparm -B 255 /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> setting Advanced Power Management level to disabled</span><br><span class="line"> APM_level= off</span><br><span class="line"></span><br><span class="line">$ hdparm -S 0 /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> setting standby to 0 (off)</span><br><span class="line"></span><br><span class="line">$ hdparm -M /dev/sdb</span><br><span class="line"></span><br><span class="line">/dev/sdb:</span><br><span class="line"> acoustic      = not supported</span><br></pre></td></tr></table></figure><h3 id="smart"><a href="#smart" class="headerlink" title="smart"></a>smart</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">smartctl -i -n standby /dev/sdc</span><br><span class="line"></span><br><span class="line"><span class="comment">#never - check the device always, but print the power mode if -i is specified</span></span><br><span class="line"><span class="comment">#sleep - check the device unless it is in SLEEP mode</span></span><br><span class="line"><span class="comment">#standby - check the device unless it is in SLEEP or STANDBY mode.  In these modes most disks are not spinning, so if you want to prevent a disk from spinning up, this is probably what you want</span></span><br><span class="line"><span class="comment">#idle - check the device unless it is in SLEEP, STANDBY or IDLE mode.  In the IDLE state,  most disks are still spinning, so this is probably not what you want</span></span><br></pre></td></tr></table></figure><h3 id="udev"><a href="#udev" class="headerlink" title="udev"></a>udev</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/udev/rules.d/69-hdparm.rules</span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, SUBSYSTEM==<span class="string">&quot;block&quot;</span>, KERNEL==<span class="string">&quot;sda&quot;</span>, RUN+=<span class="string">&quot;/usr/bin/hdparm -B 254 -S 0 /dev/sda&quot;</span></span><br></pre></td></tr></table></figure><h3 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/systemd/system/hdparm.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=hdparm sleep</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/usr/bin/hdparm -q -S 120 -y /dev/sdb</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> block </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>multipath</title>
      <link href="2018/12/11/multipath/"/>
      <url>2018/12/11/multipath/</url>
      
        <content type="html"><![CDATA[<p><a href="https://access.redhat.com/solutions/137073">multipath is not detecting path failures fast enough which results in application failure and system reboots</a><br>There are multiple parameters that affect error detection and failover times:<br>dev_loss_tmo<br>fast_io_fail_tmo<br>checker_timeout</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#default setting</span></span><br><span class="line"><span class="attr">defaults</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">user_friendly_names</span> <span class="string">yes</span></span><br><span class="line">        <span class="attr">fast_io_fail_tmo</span> <span class="string">5</span></span><br><span class="line">        <span class="attr">dev_loss_tmo</span> <span class="string">10</span></span><br><span class="line">        <span class="attr">no_path_retry</span> <span class="string">fail</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>The dev_loss_tmo (rport) affects extended link timeout, <code>in-flight I/O is held after a link-down event for seconds before the driver gives up waiting for the port to come back. Default is 30-35s, so in-flight I/O can be held seconds before being killed off. After timeout expiration, rport is put in offline (down) state.</code></p><p>The fast_io_fail_tmo (rport) affects how long io is queued and held while rport is in blocked state.</p><p>The checker_timeout specify the timeout to user for path checkers that issue SCSI commands with an explicit timeout, in seconds; default is taken from /sys/block/sd<x>/device/timeout.</p><p>The polling_interval is the interval between path checks in seconds.</p><p>no_path_retry:<br>Specify  the  number of retries until disable queueing, or fail for immediate failure (no queueing),  queue for never stop queueing. Default config entry is fail.</p><p>flush_on_last_del:<br>If set to yes , multipathd will disable queueing when the last path to a device has been deleted. Default is no.</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ modinfo ib_srp</span><br><span class="line">InfiniBand SCSI RDMA Protocol initiator</span><br><span class="line">$ cat <span class="regexp">/sys/m</span>odule<span class="regexp">/ib_srp/</span>parameters/dev_loss_tmo</span><br><span class="line"><span class="number">600</span></span><br><span class="line">$ cat <span class="regexp">/sys/m</span>odule<span class="regexp">/ib_srp/</span>parameters/fast_io_fail_tmo</span><br><span class="line"><span class="number">15</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>dev_loss_tmo:<br>Maximum number of seconds that the SRP transport should insulate transport layer errors. After this time has been exceeded the SCSI host is removed. Should be between 1 and SCSI_DEVICE_BLOCK_MAX_TIMEOUT if fast_io_fail_tmo has not been set. off means that this functionality is disabled.<br>fast_io_fail_tmo:<br>Number of seconds between the observation of a transport layer error and failing all I/O. off means that this functionality is disabled.</p><p>redhat FC example</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for f in /sys/class/fc_remote_ports/rport-*/dev_loss_tmo; do d=$(dirname $f); echo $(basename $d):$(cat $d/node_name):$(cat $f); done</span></span><br><span class="line">rport-8:0-0:0x50014380113622b0:10</span><br><span class="line">rport-8:0-1:0x50014380113622b0:10</span><br><span class="line">rport-8:0-2:0x50014380113622b0:10</span><br><span class="line">rport-8:0-3:0x50014380113622b0:10</span><br></pre></td></tr></table></figure><p>All setting base your hardware and software efficient</p><h3 id="switch-multipath"><a href="#switch-multipath" class="headerlink" title="switch multipath"></a>switch multipath</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ multipathd -k </span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">$ multipathd show map 3600a098000aaaaaa0000012345dc topology</span><br><span class="line">3600a098000aaaaaa0000012345dc dm-2 DELL,MD34xx</span><br><span class="line">size=5.8T features=<span class="string">&#x27;1 queue_if_no_path&#x27;</span> hwhandler=<span class="string">&#x27;0&#x27;</span> wp=rw</span><br><span class="line">|-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=14 status=active</span><br><span class="line">| `- 2:0:0:0 sdc 8:32 active ready  running</span><br><span class="line">`-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=9 status=enabled</span><br><span class="line">  `- 1:0:0:0 sdb 8:16 active ready  running</span><br><span class="line"></span><br><span class="line"><span class="comment"># Here only single mutibus , let &#x27;s look the group_by_prio</span></span><br><span class="line">$ multipath -ll</span><br><span class="line">3600a098000aaaaaa0000012345dc dm-2 DELL,MD34xx</span><br><span class="line">size=5.8T features=<span class="string">&#x27;1 queue_if_no_path&#x27;</span> hwhandler=<span class="string">&#x27;0&#x27;</span> wp=rw</span><br><span class="line">|-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=14 status=active</span><br><span class="line">| `- 2:0:0:0 sdc 8:32 active ready  running</span><br><span class="line">`-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=9 status=enabled</span><br><span class="line">  `- 1:0:0:0 sdb 8:16 active ready  running</span><br><span class="line"></span><br><span class="line">$ multipathd -k </span><br><span class="line"></span><br><span class="line">multipathd&gt; switch map 3600a098000aaaaaa0000012345dc group 2</span><br><span class="line">ok</span><br><span class="line">multipathd&gt; show topology</span><br><span class="line">3600a098000aaaaaa0000012345dc dm-2 DELL,MD34xx</span><br><span class="line">size=5.8T features=<span class="string">&#x27;1 queue_if_no_path&#x27;</span> hwhandler=<span class="string">&#x27;0&#x27;</span> wp=rw</span><br><span class="line">|-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=14 status=enabled</span><br><span class="line">| `- 2:0:0:0 sdc 8:32 active ready running</span><br><span class="line">`-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=9 status=active</span><br><span class="line">  `- 1:0:0:0 sdb 8:16 active ready running</span><br><span class="line">multipathd&gt; switch map 3600a098000aaaaaa0000012345dc group 1</span><br><span class="line">ok</span><br><span class="line">multipathd&gt; show topology</span><br><span class="line">3600a098000aaaaaa0000012345dc dm-2 DELL,MD34xx</span><br><span class="line">size=5.8T features=<span class="string">&#x27;1 queue_if_no_path&#x27;</span> hwhandler=<span class="string">&#x27;0&#x27;</span> wp=rw</span><br><span class="line">|-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=14 status=active</span><br><span class="line">| `- 2:0:0:0 sdc 8:32 active ready running</span><br><span class="line">`-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=9 status=enabled</span><br><span class="line">  `- 1:0:0:0 sdb 8:16 active ready running</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the path fail</span></span><br><span class="line">multipathd&gt; fail path sdc</span><br><span class="line"><span class="comment"># reinstate the path</span></span><br><span class="line">multipathd&gt; reinstate path sdc</span><br></pre></td></tr></table></figure><h3 id="Dell-default"><a href="#Dell-default" class="headerlink" title="Dell default"></a>Dell default</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##Default System Values</span></span><br><span class="line"><span class="attr">defaults</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">user_friendly_names</span><span class="string">yes</span></span><br><span class="line"><span class="attr">find_multipaths</span><span class="string">yes</span></span><br><span class="line"><span class="attr">max_fds</span><span class="string">8192</span></span><br><span class="line"><span class="attr">polling_interval</span><span class="string">5</span></span><br><span class="line"><span class="attr">queue_without_daemon</span><span class="string">no</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Universal Blacklist  (I recommend white-listing)</span></span><br><span class="line"><span class="attr">blacklist</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment">        #devnode &quot;^sd[a-z]&quot;</span></span><br><span class="line"><span class="comment">        #devnode &quot;^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*&quot;</span></span><br><span class="line"><span class="comment">        #wwid 35000cca2xxxxxxxxx</span></span><br><span class="line"><span class="comment">        # </span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment">## Blacklist Exceptions</span></span><br><span class="line"><span class="attr">blacklist_exceptions</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;MD32xxi&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;MD32xx&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;MD34xx&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;MD36xx(i|f)&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;MD38xx(i|f)&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;COMPELNT&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;Compellent Vol&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span><span class="string">&quot;DellEMC&quot;</span></span><br><span class="line"><span class="attr">product</span><span class="string">&quot;ME4&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment">## Dell Device Configuration</span></span><br><span class="line"><span class="attr">devices</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span>                <span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span>               <span class="string">&quot;MD32xxi&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span>  <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">prio</span>                  <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_checker</span>          <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_selector</span>         <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span>      <span class="string">&quot;1 rdac&quot;</span></span><br><span class="line"><span class="attr">failback</span>              <span class="string">immediate</span></span><br><span class="line"><span class="attr">features</span>              <span class="string">&quot;2 pg_init_retries 50&quot;</span></span><br><span class="line"><span class="attr">no_path_retry</span>         <span class="string">30</span></span><br><span class="line"><span class="attr">rr_min_io</span>             <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span>                <span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span>               <span class="string">&quot;MD32xx&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span>  <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">prio</span>                  <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_checker</span>          <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_selector</span>         <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span>      <span class="string">&quot;1 rdac&quot;</span></span><br><span class="line"><span class="attr">failback</span>              <span class="string">immediate</span></span><br><span class="line"><span class="attr">features</span>              <span class="string">&quot;2 pg_init_retries 50&quot;</span></span><br><span class="line"><span class="attr">no_path_retry</span>         <span class="string">30</span></span><br><span class="line"><span class="attr">rr_min_io</span>             <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span>                <span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span>               <span class="string">&quot;MD36xxi&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span>  <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">prio</span>                  <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_checker</span>          <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_selector</span>         <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span>      <span class="string">&quot;1 rdac&quot;</span></span><br><span class="line"><span class="attr">failback</span>              <span class="string">immediate</span></span><br><span class="line"><span class="attr">features</span>              <span class="string">&quot;2 pg_init_retries 50&quot;</span></span><br><span class="line"><span class="attr">no_path_retry</span>         <span class="string">30</span></span><br><span class="line"><span class="attr">rr_min_io</span>             <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span>                <span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span>               <span class="string">&quot;MD36xxf&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span>  <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">prio</span>                  <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_checker</span>          <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_selector</span>         <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span>      <span class="string">&quot;1 rdac&quot;</span></span><br><span class="line"><span class="attr">failback</span>              <span class="string">immediate</span></span><br><span class="line"><span class="attr">features</span>              <span class="string">&quot;2 pg_init_retries 50&quot;</span></span><br><span class="line"><span class="attr">no_path_retry</span>         <span class="string">30</span></span><br><span class="line"><span class="attr">rr_min_io</span>             <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span>                <span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span>               <span class="string">&quot;MD34xx&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span>  <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">prio</span>                  <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_checker</span>          <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_selector</span>         <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span>      <span class="string">&quot;1 rdac&quot;</span></span><br><span class="line"><span class="attr">failback</span>              <span class="string">immediate</span></span><br><span class="line"><span class="attr">features</span>              <span class="string">&quot;2 pg_init_retries 50&quot;</span></span><br><span class="line"><span class="attr">no_path_retry</span>         <span class="string">30</span></span><br><span class="line"><span class="attr">rr_min_io</span>             <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span>                <span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span>               <span class="string">&quot;MD38xxi&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span>  <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">prio</span>                  <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_checker</span>          <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_selector</span>         <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span>      <span class="string">&quot;1 rdac&quot;</span></span><br><span class="line"><span class="attr">failback</span>              <span class="string">immediate</span></span><br><span class="line"><span class="attr">features</span>              <span class="string">&quot;2 pg_init_retries 50&quot;</span></span><br><span class="line"><span class="attr">no_path_retry</span>         <span class="string">30</span></span><br><span class="line"><span class="attr">rr_min_io</span>             <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span>                <span class="string">&quot;DELL&quot;</span></span><br><span class="line"><span class="attr">product</span>               <span class="string">&quot;MD38xxf&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span>  <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">prio</span>                  <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_checker</span>          <span class="string">rdac</span></span><br><span class="line"><span class="attr">path_selector</span>         <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span>      <span class="string">&quot;1 rdac&quot;</span></span><br><span class="line"><span class="attr">failback</span>              <span class="string">immediate</span></span><br><span class="line"><span class="attr">features</span>              <span class="string">&quot;2 pg_init_retries 50&quot;</span></span><br><span class="line"><span class="attr">no_path_retry</span>         <span class="string">30</span></span><br><span class="line"><span class="attr">rr_min_io</span>             <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">device</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">vendor</span> <span class="string">&quot;DellEMC&quot;</span></span><br><span class="line"><span class="attr">product</span> <span class="string">&quot;ME4&quot;</span></span><br><span class="line"><span class="attr">path_grouping_policy</span> <span class="string">group_by_prio</span></span><br><span class="line"><span class="attr">path_checker</span> <span class="string">&quot;tur&quot;</span></span><br><span class="line"><span class="attr">hardware_handler</span> <span class="string">&quot;1 alua&quot;</span></span><br><span class="line"><span class="attr">prio</span> <span class="string">&quot;alua&quot;</span></span><br><span class="line"><span class="attr">failback</span> <span class="string">immediate</span></span><br><span class="line"><span class="attr">rr_weight</span> <span class="string">&quot;uniform&quot;</span></span><br><span class="line"><span class="attr">path_selector</span> <span class="string">&quot;service-time 0&quot;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> multipath </tag>
            
            <tag> dm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash tips</title>
      <link href="2018/12/11/bash/"/>
      <url>2018/12/11/bash/</url>
      
        <content type="html"><![CDATA[<h3 id="Background-exec-script-by-ssh"><a href="#Background-exec-script-by-ssh" class="headerlink" title="Background exec script by ssh"></a><a href="https://stackoverflow.com/questions/29142/getting-ssh-to-execute-a-command-in-the-background-on-target-machine">Background exec script by ssh</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> <span class="built_in">echo</span> -------- <span class="variable">$line</span>  -----------; ssh -n -t <span class="variable">$line</span> <span class="string">&#x27;sh -c &quot;( ( nohup /opt/test.sh &amp;&gt;/dev/null ) &amp; )&quot;&#x27;</span>; <span class="keyword">done</span> &lt; hosts</span><br></pre></td></tr></table></figure><h3 id="bash-set"><a href="#bash-set" class="headerlink" title="[bash set]"></a>[bash set]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-f</span><br><span class="line">Disable filename expansion (globbing).</span><br><span class="line"></span><br><span class="line">-v</span><br><span class="line">Print shell input lines as they are <span class="built_in">read</span>.</span><br></pre></td></tr></table></figure><h3 id="bash-double-quotes-single-quotes"><a href="#bash-double-quotes-single-quotes" class="headerlink" title="bash double-quotes, single-quotes"></a><a href="https://stackoverflow.com/questions/13826149/how-have-both-local-and-remote-variable-inside-an-ssh-command">bash double-quotes, single-quotes</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">A=100;</span><br><span class="line">ssh name@host <span class="string">&quot;A=101;echo \$A&quot;</span></span><br><span class="line">101</span><br><span class="line"></span><br><span class="line">ssh name@host <span class="string">&quot;A=101;echo <span class="variable">$A</span>&quot;</span></span><br><span class="line">100</span><br><span class="line"><span class="comment">#bash expands it to:</span></span><br><span class="line">ssh name@host <span class="string">&quot;A=101; echo 100&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#use single-quotes</span></span><br><span class="line">ssh name@host <span class="string">&#x27;A=101;echo $A&#x27;</span></span><br><span class="line">101</span><br><span class="line"></span><br><span class="line"><span class="comment">#ssh print single quota</span></span><br><span class="line">ssh <span class="variable">$line</span> <span class="string">&#x27; &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;echo $(lctl dl | grep tfs11-OST0005 | tr -s &quot; &quot; | cut -d &quot; &quot; -f 1) deactivate &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27; &#x27;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="bash-replace-expect-script"><a href="#bash-replace-expect-script" class="headerlink" title="bash replace expect script"></a>bash replace expect script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;connect\nshow ld\nexit\n&quot;</span> | ./runCLI.sh</span><br></pre></td></tr></table></figure><h3 id="expect"><a href="#expect" class="headerlink" title="expect"></a>expect</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect -f</span></span><br><span class="line"><span class="keyword">set</span> timeout <span class="number">60</span></span><br><span class="line">spawn <span class="string">&quot;/opt/CLI_ESD/runCLI.sh&quot;</span></span><br><span class="line">expect <span class="string">&quot;RAIDCmd&quot;</span> &#123; send <span class="string">&quot;connect\r&quot;</span> &#125;</span><br><span class="line">expect <span class="string">&quot;Successful&quot;</span> &#123; send <span class="string">&quot;show ld\r&quot;</span> &#125;</span><br><span class="line">expect <span class="string">&quot;logical volume&quot;</span> &#123; send <span class="string">&quot;exit\r&quot;</span> &#125;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure><h3 id="ssh-remote-exec-command"><a href="#ssh-remote-exec-command" class="headerlink" title="ssh remote exec command"></a>ssh remote exec command</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#sometimes ssh remote exec <span class="keyword">command</span> not work</span><br><span class="line">ssh -n name@host  <span class="string">&#x27;your command&#x27;</span></span><br><span class="line"></span><br><span class="line">#-t  Force pseudo-terminal allocation.  This can <span class="keyword">be</span> used <span class="keyword">to</span> <span class="keyword">execute</span> arbitrary screen-based programs <span class="keyword">on</span> <span class="keyword">a</span> remote machine, which can <span class="keyword">be</span> very useful, <span class="keyword">e</span>.g. when implementing <span class="keyword">menu</span> services.  Multiple -t <span class="keyword">options</span> force tty allocation, even <span class="keyword">if</span> ssh <span class="built_in">has</span> <span class="keyword">no</span> local tty.</span><br></pre></td></tr></table></figure><p>There are a big issue cause I can t parallel exec ssh in bash script, randomly connection closed.<br>I try setting sshd_config</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/ssh/sshd_config | grep max -i</span><br><span class="line">MaxSessions 512</span><br><span class="line">ClientAliveCountMax 512</span><br><span class="line">MaxStartups 500:1:500</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -n -t -o <span class="attribute">TCPKeepAlive</span>=<span class="literal">yes</span> -o <span class="attribute">ServerAliveInterval</span>=30 -o <span class="attribute">GSSAPIAuthentication</span>=<span class="literal">no</span> -o <span class="attribute">ControlPersist</span>=600 <span class="variable">$line</span> <span class="string">&#x27;$your command&#x27;</span></span><br></pre></td></tr></table></figure><p>There is no any help</p><p>Fine, I use screen background the command avoid this issue, mpich has the same issue.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">ssh -n -t -o TCPKeepAlive=yes -o GSSAPIAuthentication=no <span class="variable">$line</span> <span class="string">&#x27;screen -dmS fio-read &quot;/root/run-fio-read.sh&quot;&#x27;</span></span><br><span class="line"><span class="keyword">done</span> &lt; test_hosts</span><br></pre></td></tr></table></figure><h4 id="single-command-jump-2-nodes"><a href="#single-command-jump-2-nodes" class="headerlink" title="single command jump 2 nodes"></a>single command jump 2 nodes</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -t user1@<span class="variable">$server1</span> -o GSSAPIAuthentication=no <span class="string">&#x27;sudo scp tmp.sh root@$server_ip:&#x27;</span></span><br><span class="line">ssh -t user1@<span class="variable">$server1</span> -o GSSAPIAuthentication=no <span class="string">&#x27;sudo ssh -n root@$server2_ip sh ./tmp.sh&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="remove-name-begin-with--"><a href="#remove-name-begin-with--" class="headerlink" title="remove name begin with -"></a><a href="https://unix.stackexchange.com/questions/1519/how-do-i-delete-a-file-whose-name-begins-with-hyphen-a-k-a-dash-or-minus">remove name begin with -</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -- --<span class="built_in">help</span></span><br><span class="line">rm ./--<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="IFS"><a href="#IFS" class="headerlink" title="IFS"></a>IFS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default value, &lt;space&gt;&lt;tab&gt;&lt;newline&gt;</span></span><br><span class="line">$ IFS=$<span class="string">&#x27; \t\n&#x27;</span></span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">$ IFS=<span class="string">&#x27;input from keyboard space,tab,newline&#x27;</span></span><br><span class="line"><span class="comment"># read IFS</span></span><br><span class="line">$ cat -etv &lt;&lt;&lt; <span class="variable">$IFS</span></span><br><span class="line"> ^I$</span><br><span class="line">$</span><br><span class="line"></span><br><span class="line">$ IFS=$(<span class="built_in">echo</span> <span class="string">&quot; \n\t&quot;</span>); <span class="built_in">printf</span> <span class="string">&quot;%s&quot;</span> <span class="string">&quot;<span class="variable">$IFS</span>&quot;</span>|xxd</span><br><span class="line">00000000: 205c 6e5c 74</span><br><span class="line"></span><br><span class="line"><span class="comment"># backup the value</span></span><br><span class="line">OLDIFS=<span class="variable">$IFS</span> </span><br></pre></td></tr></table></figure><h3 id="test-match"><a href="#test-match" class="headerlink" title="test match"></a>test match</h3><h4 id="is-a-integer"><a href="#is-a-integer" class="headerlink" title="is a integer"></a>is a integer</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=1</span><br><span class="line">[[ <span class="variable">$a</span> == *[[:digit:]]* ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span> is an integer&quot;</span></span><br><span class="line">[[ <span class="variable">$1</span> == ?(-)+([0-9]) ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span> is an integer&quot;</span></span><br><span class="line"><span class="comment">#match yes</span></span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$response</span>&quot;</span> =~ ^([yY][eE][sS]|[yY])+$ ]]</span><br></pre></td></tr></table></figure><h3 id="String-Ternary-conditional-operator-three"><a href="#String-Ternary-conditional-operator-three" class="headerlink" title="String, Ternary conditional operator (three)"></a>String, Ternary conditional operator (three)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">VAR1=<span class="string">&quot;BASH&quot;</span></span><br><span class="line">VAR1+=<span class="string">&quot; SCRIPT&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$VAR1</span>&quot;</span></span><br><span class="line">BASH SCRIPT</span><br><span class="line"></span><br><span class="line">n=4</span><br><span class="line">result=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq 0 $((<span class="variable">$n</span> &gt; <span class="number">0</span>? <span class="variable">$n</span>-<span class="number">1</span>: <span class="number">0</span>))); <span class="keyword">do</span> </span><br><span class="line">  result+=<span class="string">&quot;rank-<span class="variable">$i</span>&quot;</span></span><br><span class="line">  result+=<span class="string">&quot; &quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$result</span></span><br><span class="line">rank-0 rank-1 rank-2 rank-3</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time_interval=$((<span class="variable">$1</span> &gt; <span class="number">36000</span>? <span class="number">36000</span>: <span class="number">3600</span>))</span><br></pre></td></tr></table></figure><h3 id="Arrary"><a href="#Arrary" class="headerlink" title="Arrary"></a>Arrary</h3><h5 id="Associative-array"><a href="#Associative-array" class="headerlink" title="Associative array"></a>Associative array</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> -A <span class="keyword">array</span></span><br><span class="line"><span class="keyword">array</span>[foo]=bar</span><br><span class="line"><span class="keyword">array</span>[bar]=foo</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in <span class="string">&quot;$&#123;!array[@]&#125;&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">echo</span> -n <span class="string">&quot;key : <span class="subst">$i</span>; &quot;</span></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;value: $&#123;array[<span class="subst">$i</span>]&#125;&quot;</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><a href="https://stackoverflow.com/questions/4069188/how-to-pass-an-associative-array-as-argument-to-a-function-in-bash/46085661#46085661">direct access array in function</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/tmp</span><br><span class="line">AA 11</span><br><span class="line">BB 22</span><br><span class="line">CC 33</span><br><span class="line">DD 44</span><br><span class="line">ZZ 55</span><br><span class="line">YY 66</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">declare</span> -A ARR</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   key=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">   value=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">   ARR[<span class="variable">$key</span>]=<span class="variable">$value</span></span><br><span class="line"><span class="keyword">done</span> &lt; /tmp/tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">fun</span></span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!ARR[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$i</span>&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot; <span class="variable">$&#123;ARR[$i]&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line">fun <span class="string">&quot;hahaha&quot;</span></span><br></pre></td></tr></table></figure><p>If you want copy array    </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> -A ARR</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!ARR[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  ARRAY[<span class="string">&quot;<span class="variable">$key</span>&quot;</span>]=<span class="string">&quot;<span class="variable">$&#123;ARR[&quot;$key&quot;]&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment"># ARRAY+=( [&quot;$key&quot;]=&quot;$&#123;ARR[&quot;$key&quot;]&#125;&quot; )</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>bash 4.4 in ubuntu</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">declare</span> -A ARR</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   key=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">   value=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">   ARR[<span class="variable">$key</span>]=<span class="variable">$value</span></span><br><span class="line"><span class="keyword">done</span> &lt; /tmp/tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_ARR</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> -n array=<span class="variable">$1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!array[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$i</span>&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot; <span class="variable">$&#123;array[$i]&#125;</span>&quot;</span></span><br><span class="line">     <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!ARR[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> -n <span class="string">&quot;key: <span class="variable">$i</span> &quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;value: <span class="variable">$&#123;ARR[$i]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> ---------<span class="keyword">in</span> func ----------</span><br><span class="line">print_ARR <span class="string">&quot;ARR&quot;</span></span><br></pre></td></tr></table></figure><p>or you could </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   key=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">   value=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">   ARR[<span class="variable">$key</span>]=<span class="variable">$value</span></span><br><span class="line"><span class="keyword">done</span> &lt;&lt;&lt; <span class="string">&quot;<span class="subst">$([[ ! -z $var ]] &amp;&amp; awk  &#x27;&#123;print $1,$2&#125;&#x27; your_file)</span>&quot;</span></span><br></pre></td></tr></table></figure><h5 id="array"><a href="#array" class="headerlink" title="array"></a>array</h5><p>split string to array</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ lsscsi_out=$(lsscsi | awk <span class="string">&#x27;$NF!~/-/ &#123;print $NF&#125;&#x27;</span>)</span><br><span class="line">$ read -r -a noroot_dev &lt;&lt;&lt; <span class="variable">$lsscsi_out</span> <span class="comment">## you could change IFS for your need, IFS=&#x27;, &#x27; read -r -a array &lt;&lt;&lt; &quot;$string&quot;</span></span><br><span class="line">$ echo <span class="variable">$&#123;#noroot_dev[@]&#125;</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line">$ echo <span class="variable">$&#123;noroot_dev[@]&#125;</span></span><br><span class="line"><span class="regexp">/dev/</span>sda <span class="regexp">/dev/</span>sdf <span class="regexp">/dev/</span>sde <span class="regexp">/dev/</span>sdd <span class="regexp">/dev/</span>sdc <span class="regexp">/dev/</span>sdb</span><br></pre></td></tr></table></figure><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">var=(<span class="variable">$(</span>./test.sh))</span><br><span class="line"></span><br><span class="line">echo <span class="variable">$&#123;</span>var[0]&#125;</span><br><span class="line">echo <span class="variable">$&#123;</span>var[<span class="number">1</span>]&#125;</span><br><span class="line">echo <span class="variable">$&#123;</span>var[<span class="number">2</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># another example</span></span><br><span class="line">arr=(<span class="variable">$(</span>echo <span class="variable">$m</span> | tr <span class="string">&quot; &quot;</span> <span class="string">&quot;\n&quot;</span>))</span><br><span class="line"></span><br><span class="line">ARRAY=()</span><br><span class="line">ARRAY+=(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">ARRAY+=(<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;$&#123;!ARRAY[@]&#125;&quot;</span>; <span class="keyword">do</span> echo <span class="variable">$i</span>; done</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;$&#123;ARRAY[@]&#125;&quot;</span>; <span class="keyword">do</span> echo <span class="variable">$i</span>; done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">declare -a names</span><br><span class="line"></span><br><span class="line">names[0]=<span class="number">1111</span></span><br><span class="line">names[<span class="number">1</span>]=<span class="number">2222</span></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">names=(<span class="string">&#x27;1111&#x27;</span> <span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">names=([0]=<span class="string">&#x27;1111&#x27;</span> [<span class="number">1</span>]=<span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>cat files.txt</span><br><span class="line"><span class="number">1111111</span></span><br><span class="line"><span class="number">2222222</span></span><br><span class="line"><span class="number">3333333</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get array from file</span></span><br><span class="line">names=(<span class="variable">$(</span>cat files.txt))</span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span>names[<span class="number">1</span>]&#125;</span><br><span class="line"><span class="number">2222222</span></span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span>names[<span class="number">2</span>]&#125;</span><br><span class="line"><span class="number">3333333</span></span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span>names[<span class="number">3</span>]&#125;</span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span><span class="comment">#names[@]&#125;</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span>names[@]<span class="symbol">:</span>0<span class="symbol">:</span><span class="number">1</span>&#125;</span><br><span class="line"><span class="number">1111111</span></span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span>names[@]<span class="symbol">:</span>0<span class="symbol">:</span><span class="number">2</span>&#125;</span><br><span class="line"><span class="number">1111111 2222222</span></span><br><span class="line"></span><br><span class="line">echo <span class="variable">$&#123;</span>names[@]<span class="symbol">:</span><span class="number">1</span>&#125;</span><br><span class="line"><span class="number">2222222 333333</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>names1=([0]=<span class="string">&#x27;1111&#x27;</span> [<span class="number">2</span>]=<span class="string">&#x27;2222&#x27;</span> [<span class="number">4</span>]=<span class="string">&#x27;3333&#x27;</span>)</span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span><span class="comment">#adobe[@]&#125;</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>names=(<span class="string">&#x27;1111&#x27;</span> <span class="string">&#x27;2222&#x27;</span> <span class="string">&#x27;3333&#x27;</span> <span class="string">&#x27;4444&#x27;</span> <span class="string">&#x27;5555&#x27;</span>)</span><br><span class="line"><span class="variable">$ </span>names2=(<span class="string">&#x27;6666&#x27;</span> <span class="string">&#x27;7777&#x27;</span>)</span><br><span class="line"><span class="variable">$ </span>names3=(<span class="variable">$&#123;</span>names[@]&#125; <span class="variable">$&#123;</span>names2[@]&#125;)</span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span><span class="comment">#names3[@]&#125;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### delete array</span></span><br><span class="line"><span class="variable">$ </span>names=(<span class="string">&#x27;1111&#x27;</span> <span class="string">&#x27;2222&#x27;</span> <span class="string">&#x27;3333&#x27;</span> <span class="string">&#x27;4444&#x27;</span>)</span><br><span class="line"><span class="variable">$ </span>echo <span class="variable">$&#123;</span>names[@]/<span class="number">1111/0000</span>&#125;</span><br><span class="line">0000 <span class="number">2222 3333</span> <span class="number">4444</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span><span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable">$&#123;</span>names[@]&#125;;<span class="keyword">do</span> echo <span class="variable">$item</span>; done</span><br><span class="line"><span class="number">1111</span></span><br><span class="line"><span class="number">2222</span></span><br><span class="line"><span class="number">3333</span></span><br><span class="line"><span class="number">4444</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>len=<span class="variable">$&#123;</span><span class="comment">#names[@]&#125;</span></span><br><span class="line"><span class="variable">$ </span><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$len</span>;i++));<span class="keyword">do</span> echo <span class="variable">$&#123;</span>names[<span class="variable">$i</span>]&#125;;done</span><br><span class="line"></span><br><span class="line"><span class="comment">## delete array element</span></span><br><span class="line"><span class="variable">$ </span>noroot_dev=(<span class="variable">$&#123;</span>noroot_dev[@]/<span class="variable">$j</span>/&#125;)</span><br><span class="line"></span><br><span class="line">rclocal=<span class="string">&quot;/etc/rc.d/rc.local&quot;</span></span><br><span class="line">grep -iE <span class="string">&#x27;ethtool&#x27;</span> <span class="variable">$rclocal</span>  || ls /sys/class/net | egrep <span class="string">&#x27;(eth|en|p|em|bond|br)&#x27;</span> | egrep -v <span class="string">&#x27;bonding_masters|vir&#x27;</span> | <span class="keyword">while</span> read nic</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    nicbuff+=(<span class="variable">$(</span>ethtool -g <span class="variable">$nic</span> | grep -A <span class="number">4</span> <span class="string">&quot;Pre-set maximums&quot;</span> | grep -vEi <span class="string">&#x27;maximums|mini|jumbo&#x27;</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>))</span><br><span class="line">    echo ethtool -G <span class="variable">$nic</span> rx <span class="variable">$&#123;</span>nicbuff[0]&#125; tx <span class="variable">$&#123;</span>nicbuff[<span class="number">1</span>]&#125; &gt;&gt; <span class="variable">$rclocal</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="Avoid-multiple-JBOD-devs-across-in-single-raidz"><a href="#Avoid-multiple-JBOD-devs-across-in-single-raidz" class="headerlink" title="Avoid multiple JBOD devs across in single raidz"></a>Avoid multiple JBOD devs across in single raidz</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tempdir=/tmp;</span><br><span class="line">lsscsi -tiv  | sed -z <span class="string">&#x27;s/\n  dir:/ /g&#x27;</span> | awk -v tempdir=<span class="string">&quot;<span class="variable">$tempdir</span>&quot;</span> -F <span class="string">&#x27;[:\\[/ ]+&#x27;</span> <span class="string">&#x27;$10!~/-/ &amp;&amp; $0~/disk/ &amp;&amp; $7~/sas/ &#123;print &quot;/dev/disk/by-id/scsi-&quot;$11,$2 &gt; tempdir&quot;/&quot;$30&quot;_&quot;$31&quot;_&quot;$32&quot;_&quot;$33&quot;_&quot;$34&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Wait-sub-process-finish"><a href="#Wait-sub-process-finish" class="headerlink" title="Wait sub process finish"></a>Wait sub process finish</h3><p>Here is example to paralle running SMcli to collect MD34xxs log. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        SMcli localhost -n <span class="variable">$line</span> -c <span class="string">&quot;save storageArray supportdata file=\&quot;/root/<span class="variable">$&#123;1&#125;</span>/smcli_<span class="variable">$&#123;line&#125;</span>_controller\&quot; force=true;&quot;</span> &amp;</span><br><span class="line">        <span class="built_in">echo</span> $! &gt;&gt; <span class="variable">$dell_pids</span></span><br><span class="line"><span class="keyword">done</span> &lt; <span class="variable">$dell_names</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> Begin to <span class="built_in">wait</span> smcli <span class="variable">$line</span></span><br><span class="line">    <span class="built_in">wait</span> <span class="variable">$line</span></span><br><span class="line"><span class="keyword">done</span> &lt; <span class="variable">$dell_pids</span></span><br></pre></td></tr></table></figure><h3 id="Sed"><a href="#Sed" class="headerlink" title="Sed"></a><a href="https://www.oakton.edu/user/2/rjtaylor/cis218/Handouts/sed.txt">Sed</a></h3><h4 id="print-line-from-16224-to-16482"><a href="#print-line-from-16224-to-16482" class="headerlink" title="print line from 16224 to 16482"></a><a href="https://stackoverflow.com/questions/83329/how-can-i-extract-a-predetermined-range-of-lines-from-a-text-file-on-unix">print line from 16224 to 16482</a></h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;16224,16482p;16483q&#x27;</span> filename &gt; newfile</span><br><span class="line">p - Print <span class="keyword">out</span> the pattern space (<span class="keyword">to</span> the standard output). This command <span class="keyword">is</span> usually <span class="keyword">only</span> used <span class="keyword">in</span> conjunction <span class="keyword">with</span> the -n command-<span class="type">line</span> <span class="keyword">option</span>.</span><br><span class="line"></span><br><span class="line">n - <span class="keyword">If</span> auto-print <span class="keyword">is</span> <span class="keyword">not</span> disabled, print the pattern space, <span class="keyword">then</span>, regardless, replace the pattern space <span class="keyword">with</span> the next <span class="type">line</span> <span class="keyword">of</span> <span class="keyword">input</span>. <span class="keyword">If</span> there <span class="keyword">is</span> <span class="keyword">no</span> more <span class="keyword">input</span> <span class="keyword">then</span> sed exits <span class="keyword">without</span> processing <span class="keyword">any</span> more commands.</span><br><span class="line"></span><br><span class="line">q - <span class="keyword">Exit</span> sed <span class="keyword">without</span> processing <span class="keyword">any</span> more commands <span class="keyword">or</span> <span class="keyword">input</span>. Note that the <span class="keyword">current</span> pattern space <span class="keyword">is</span> printed <span class="keyword">if</span> auto-print <span class="keyword">is</span> <span class="keyword">not</span> disabled <span class="keyword">with</span> the -n <span class="keyword">option</span>.</span><br></pre></td></tr></table></figure><p>modify first display key word</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">1 unix 3 unix unix  8</span><br><span class="line">4 5 unix unix unix 2</span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># match second match colume</span></span><br><span class="line">$ sed <span class="string">&#x27;s/unix/to_linux/2&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 to_linux unix  8</span><br><span class="line">4 5 unix to_linux unix 2</span><br><span class="line">7 unix 9 to_linux 12  unix</span><br><span class="line">unix 11 12 to_linux 14  unix</span><br><span class="line">unix 14 to_linux unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line">$ sed <span class="string">&#x27;0,/unix/ &#123;s/unix/to_linux/&#125;&#x27;</span> /tmp/test.txt</span><br><span class="line">1 to_linux 3 unix unix  8</span><br><span class="line">4 5 unix unix unix 2</span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line">second ~ last match colume</span><br><span class="line">$ sed <span class="string">&#x27;s/unix/to_that/2g&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 to_that to_that  8</span><br><span class="line">4 5 unix to_that to_that 2</span><br><span class="line">7 unix 9 to_that 12  to_that</span><br><span class="line">unix 11 12 to_that 14  to_that</span><br><span class="line">unix 14 to_that to_that 16  19 to_that 228</span><br><span class="line"></span><br><span class="line">$ sed <span class="string">&#x27;s/unix/to_that/3g&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 unix to_that  8</span><br><span class="line">4 5 unix unix to_that 2</span><br><span class="line">7 unix 9 unix 12  to_that</span><br><span class="line">unix 11 12 unix 14  to_that</span><br><span class="line">unix 14 unix to_that 16  19 to_that 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># or you can</span></span><br><span class="line">$ sed <span class="string">&#x27;s_http://_www_&#x27;</span> file.txt</span><br><span class="line">$ sed <span class="string">&#x27;s|http://|www|&#x27;</span> file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># use &amp; as the match string</span></span><br><span class="line">$ sed <span class="string">&#x27;s/unix/&#123;&amp;&#125;/&#x27;</span> /tmp/test.txt</span><br><span class="line">1 &#123;unix&#125; 3 unix unix  8</span><br><span class="line">4 5 &#123;unix&#125; unix unix 2</span><br><span class="line">7 &#123;unix&#125; 9 unix 12  unix</span><br><span class="line">&#123;unix&#125; 11 12 unix 14  unix</span><br><span class="line">&#123;unix&#125; 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line">$ sed -n <span class="string">&#x27;s/unix/linux/p&#x27;</span> /tmp/test.txt <span class="comment"># only print match line</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#multiple command</span></span><br><span class="line">$ sed -e <span class="string">&#x27;s/unix/linux/&#x27;</span> -e <span class="string">&#x27;s/9/system/&#x27;</span>  /tmp/test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># only replace some line </span></span><br><span class="line">$ sed <span class="string">&#x27;3 s/unix/to_linux/g&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 unix unix  8</span><br><span class="line">4 5 unix unix unix 2</span><br><span class="line">7 to_linux 9 to_linux 12  to_linux</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># from 1~3 lines</span></span><br><span class="line">$ sed <span class="string">&#x27;1,3 s/unix/to_linux/g&#x27;</span> /tmp/test.txt</span><br><span class="line">1 to_linux 3 to_linux to_linux  8</span><br><span class="line">4 5 to_linux to_linux to_linux 2</span><br><span class="line">7 to_linux 9 to_linux 12  to_linux</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># only replace match line</span></span><br><span class="line">$ sed <span class="string">&#x27;/4 5/ s/unix/centos/&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 unix unix  8</span><br><span class="line">4 5 centos unix unix 2</span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete line</span></span><br><span class="line">$ sed <span class="string">&#x27;2 d&#x27;</span> /tmp/test.txt</span><br><span class="line">$ sed <span class="string">&#x27;5,$ d&#x27;</span> /tmp/test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#duplicate text</span></span><br><span class="line">$ sed <span class="string">&#x27;p&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 unix unix  8</span><br><span class="line">1 unix 3 unix unix  8</span><br><span class="line">4 5 unix unix unix 2</span><br><span class="line">4 5 unix unix unix 2</span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># grep</span></span><br><span class="line">$ sed -n <span class="string">&#x27;/unix/ p&#x27;</span> test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># grep -v</span></span><br><span class="line">$ sed -n <span class="string">&#x27;/unix/ !p&#x27;</span> test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add line after a match</span></span><br><span class="line">$ sed <span class="string">&#x27;/4 5/ a &quot;Add a new line&quot;&#x27;</span> /tmp/test.txt</span><br><span class="line">sed <span class="string">&#x27;/4 5/ a &quot;Add a new line&quot;&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 unix unix  8</span><br><span class="line">4 5 unix unix unix 2</span><br><span class="line"><span class="string">&quot;Add a new line&quot;</span></span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add a line before a match</span></span><br><span class="line">$ sed <span class="string">&#x27;/4 5/ i &quot;Add a new line&quot;&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 unix unix  8</span><br><span class="line"><span class="string">&quot;Add a new line&quot;</span></span><br><span class="line">4 5 unix unix unix 2</span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the whole line</span></span><br><span class="line">sed <span class="string">&#x27;/4 5/ c &quot;Change line&quot;&#x27;</span> /tmp/test.txt</span><br><span class="line">1 unix 3 unix unix  8</span><br><span class="line"><span class="string">&quot;Change line&quot;</span></span><br><span class="line">7 unix 9 unix 12  unix</span><br><span class="line">unix 11 12 unix 14  unix</span><br><span class="line">unix 14 unix unix 16  19 unix 228</span><br></pre></td></tr></table></figure><h3 id="AWK"><a href="#AWK" class="headerlink" title="AWK"></a>AWK</h3><h4 id="single-character-fields"><a href="#single-character-fields" class="headerlink" title="single character fields"></a><a href="https://www.gnu.org/software/gawk/manual/html_node/Single-Character-Fields.html">single character fields</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> a b | gawk <span class="string">&#x27;BEGIN &#123; FS = &quot;&quot; &#125;</span></span><br><span class="line"><span class="string">&gt;                  &#123;</span></span><br><span class="line"><span class="string">&gt;                      for (i = 1; i &lt;= NF; i = i + 1)</span></span><br><span class="line"><span class="string">&gt;                          print &quot;Field&quot;, i, &quot;is&quot;, $i</span></span><br><span class="line"><span class="string">&gt;                  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><p>If you want use [ and ] become the separator </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">&#x27;[][ :]+&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="awk-match-bash-variable"><a href="#awk-match-bash-variable" class="headerlink" title="awk match bash variable"></a><a href="https://stackoverflow.com/questions/39384283/how-to-match-a-pattern-given-in-a-variable-in-awk">awk match bash variable</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -v pat=<span class="string">&quot;<span class="variable">$pattern</span>&quot;</span> -F <span class="string">&quot;:&quot;</span> <span class="string">&#x27;$0~pat&#123;print $1, $2, $3, $4 &#125;&#x27;</span> file</span><br></pre></td></tr></table></figure><h4 id="awk-sort-key-and-value"><a href="#awk-sort-key-and-value" class="headerlink" title="awk sort key and value"></a><a href="https://www.gnu.org/software/gawk/manual/html_node/Controlling-Scanning.html">awk sort key and value</a></h4><p>out of order the line</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sort -R file_name</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PROCINFO[<span class="string">&quot;sorted_in&quot;</span>] = <span class="string">&quot;@val_num_desc&quot;</span></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> a) <span class="built_in">print</span> i, a[i]</span><br></pre></td></tr></table></figure><p>awk absolute match $0~/ / /<br>sed absolute match sed -i /&lt;${i}&gt;/d</p><h4 id="Got-int-to-variable"><a href="#Got-int-to-variable" class="headerlink" title="Got int to variable"></a>Got int to variable</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[int(<span class="variable">$NF</span>/1000)]++</span><br></pre></td></tr></table></figure><h3 id="bash-strings"><a href="#bash-strings" class="headerlink" title="bash strings"></a>bash strings</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># string length</span></span><br><span class="line">[[ <span class="variable">$&#123;#f_check&#125;</span> -le 8 ]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># variable is a number</span></span><br><span class="line">[[ <span class="variable">$VAR</span> = *[[:digit:]]* ]]</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$b</span></span><br><span class="line"><span class="comment">#50_5000cca26b90c3b1</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$c</span></span><br><span class="line">5000cca26b90c3b1</span><br><span class="line"></span><br><span class="line">$ [[ <span class="variable">$b</span> =~ <span class="variable">$c</span> ]] &amp;&amp; <span class="built_in">echo</span> ok</span><br><span class="line">ok</span><br></pre></td></tr></table></figure><p>awk statement next to immediately continue with processing the next input record.</p><h3 id="Subprocess"><a href="#Subprocess" class="headerlink" title="Subprocess"></a>Subprocess</h3><h4 id="exit-err"><a href="#exit-err" class="headerlink" title="exit err"></a><a href="https://unix.stackexchange.com/questions/48533/exit-shell-script-from-a-subshell">exit err</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -E</span><br><span class="line"><span class="built_in">trap</span> <span class="string">&#x27;[ &quot;$?&quot; -ne 33 ] || exit 33&#x27;</span> ERR</span><br><span class="line">lfs getstripe <span class="variable">$namespace</span> &gt; /dev/null 2&gt;&amp;1 || (<span class="built_in">echo</span> <span class="string">&quot;Not found lustre filesystem&quot;</span> &amp;&amp; <span class="built_in">exit</span> 33)</span><br><span class="line"><span class="built_in">set</span> +E</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -E</span><br><span class="line"><span class="built_in">trap</span> <span class="string">&#x27;[ &quot;$?&quot; -ne 33 ] || exit 33&#x27;</span> ERR</span><br><span class="line"><span class="keyword">for</span> ((i=0;i&lt;=9;i++)); <span class="keyword">do</span> <span class="built_in">echo</span> ----<span class="variable">$i</span> ; <span class="keyword">if</span> [[ <span class="variable">$i</span> -eq 3 ]]; <span class="keyword">then</span> lll || (<span class="built_in">echo</span> <span class="string">&quot;show error&quot;</span> &amp;&amp; <span class="built_in">exit</span> 33); <span class="keyword">else</span> <span class="built_in">echo</span> -----------<span class="variable">$i</span>---------------; <span class="keyword">fi</span> ; <span class="keyword">done</span></span><br><span class="line"><span class="built_in">set</span> +E</span><br><span class="line"><span class="built_in">echo</span> haha out of</span><br></pre></td></tr></table></figure><h3 id="Termination-Signals-https-www-gnu-org-software-libc-manual-html-node-Termination-Signals-html"><a href="#Termination-Signals-https-www-gnu-org-software-libc-manual-html-node-Termination-Signals-html" class="headerlink" title="[Termination Signals] (https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html)"></a>[Termination Signals] (<a href="https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html">https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html</a>)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">* 1 SIGHUP The SIGHUP (<span class="string">&quot;hang-up&quot;</span>) signal is used to report that the user<span class="string">&#x27;s terminal is disconnected, perhaps because a network or telephone connection was broken.</span></span><br><span class="line"><span class="string">* 2 SIGINT The SIGINT (program interrupt) signal is sent when the user types the INTR character (normally C-c).</span></span><br><span class="line"><span class="string">* 3 The SIGQUIT signal is similar to SIGINT, except that its controlled by a different key-the QUIT character, usually C-\-and produces a core dump when it terminates the process, just like a program error signal. You can think of this as a program error condition &quot;detected&quot; by the user</span></span><br><span class="line"><span class="string">* 9 The SIGKILL signal is used to cause immediate program termination. It cannot be handled or ignored, and is therefore always fatal. It is also not possible to block this signal</span></span><br><span class="line"><span class="string">* 15 The SIGTERM signal is a generic signal used to cause program termination. Unlike SIGKILL, this signal can be blocked, handled, and ignored. It is the normal way to politely ask a program to terminate.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Trap</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">mytrap () &#123;</span></span><br><span class="line"><span class="string">  echo hahahahaha</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">trap mytrap SIGHUP SIGINT SIGQUIT SIGTERM ERR EXIT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">myfunc () &#123;</span></span><br><span class="line"><span class="string"> trap  mytrap RETURN</span></span><br><span class="line"><span class="string"> #trap  mytrap EXIT #no output</span></span><br><span class="line"><span class="string"> echo &quot;I&#x27;</span>ve got a bad feeling about this...<span class="string">&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">myfunc | cat</span></span><br><span class="line"><span class="string">sleep 10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">###############################</span></span><br><span class="line"><span class="string">NumberSIGMeaning</span></span><br><span class="line"><span class="string">00On exit from shell</span></span><br><span class="line"><span class="string">1SIGHUPClean tidyup</span></span><br><span class="line"><span class="string">2SIGINTInterrupt</span></span><br><span class="line"><span class="string">3SIGQUITQuit</span></span><br><span class="line"><span class="string">6SIGABRTAbort</span></span><br><span class="line"><span class="string">9SIGKILLDie Now (cannot be trapped)</span></span><br><span class="line"><span class="string">14SIGALRMAlarm Clock</span></span><br><span class="line"><span class="string">15SIGTERMTerminate</span></span><br></pre></td></tr></table></figure><h3 id="Random"><a href="#Random" class="headerlink" title="Random"></a>Random</h3><h4 id="number"><a href="#number" class="headerlink" title="number"></a><a href="https://stackoverflow.com/questions/2556190/random-number-from-a-range-in-a-bash-script">number</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from 2000~65000</span></span><br><span class="line">$ shuf -i 2000-65000 -n 1</span><br></pre></td></tr></table></figure><h3 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h3><h4 id="Get-bash-variable"><a href="#Get-bash-variable" class="headerlink" title="Get bash variable"></a>Get bash variable</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&quot;s/524335808/<span class="variable">$&#123;mem&#125;</span>/&quot;</span></span><br><span class="line">$ sed <span class="string">&quot;/\&lt;<span class="variable">$&#123;a&#125;</span>\&gt;/d&quot;</span> zfs_free_dev <span class="comment"># like grep -w , \&lt;\&gt; force an exact match</span></span><br></pre></td></tr></table></figure><h3 id="Get-scsi-serial-number-by-bash"><a href="#Get-scsi-serial-number-by-bash" class="headerlink" title="Get scsi serial number by bash"></a>Get scsi serial number by bash</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ strings /sys/block/sda/device/vpd_pg80 | tr -d <span class="string">&#x27;\040\011\012\015&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Get-parent-id-info"><a href="#Get-parent-id-info" class="headerlink" title="Get parent id info"></a>Get parent id info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pstree -sg 25153</span><br><span class="line">systemd(1)qemu-kvm(25147)&#123;qemu-kvm&#125;(25147)</span><br><span class="line">                             &#123;qemu-kvm&#125;(25147)</span><br><span class="line">                             &#123;qemu-kvm&#125;(25147)</span><br><span class="line">                             &#123;qemu-kvm&#125;(25147)</span><br><span class="line">                             &#123;qemu-kvm&#125;(25147)</span><br><span class="line">                             &#123;qemu-kvm&#125;(25147)</span><br></pre></td></tr></table></figure><h3 id="rsync-copy-to-change-ssh-cipher"><a href="#rsync-copy-to-change-ssh-cipher" class="headerlink" title="rsync copy to change ssh cipher"></a>rsync copy to change ssh cipher</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## -c arcfour could show support cipher</span></span><br><span class="line">$ rsync -aHAXvP -e <span class="string">&quot;ssh -T -c chacha20-poly1305@openssh.com -o Compression=no -x&quot;</span> <span class="built_in">source</span>:/xxxx <span class="variable">$ipaddr</span>:/xxx</span><br></pre></td></tr></table></figure><h3 id="Parallel-ssh"><a href="#Parallel-ssh" class="headerlink" title="Parallel ssh"></a>Parallel ssh</h3><ul><li>Don t need install anything (pdsh or cluster shell, ansible)</li><li>Compatibility<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   ssh -n <span class="variable">$line</span> <span class="string">&quot;your command &gt; your log 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; hosts</span><br></pre></td></tr></table></figure></li></ul><h3 id="Create-sparse-file"><a href="#Create-sparse-file" class="headerlink" title="Create sparse file"></a>Create sparse file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ fallocate -l 5G -o 5G bar</span><br><span class="line">$ ls -lhs bar</span><br><span class="line">5.0G -rw-r--r-- 1 root root 10G Aug 23 08:58 bar</span><br><span class="line"></span><br><span class="line">$ truncate -s 512M bar</span><br><span class="line">0 -rw-rw-r-- 1 root root 512M 10  4 22:07 bar</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Num-convert"><a href="#Num-convert" class="headerlink" title="Num convert"></a>Num convert</h3><p>hex -&gt; bin num</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ dc -e &#x27;<span class="number">16</span>i2o0x6003p&#x27;</span><br><span class="line"><span class="number">110000000000011</span></span><br><span class="line"><span class="number">110</span>,<span class="number">0000</span>,<span class="number">0000</span>,<span class="number">0011</span></span><br></pre></td></tr></table></figure><p>bin &lt;-&gt; dec</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#bin -&gt; dec</span></span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">2#1010</span>))</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line"><span class="comment">#dec -&gt; bin</span></span><br><span class="line"><span class="comment"># 0-255</span></span><br><span class="line">$ bin=(&#123;0..1&#125;&#123;0..1&#125;&#123;0..1&#125;&#123;0..1&#125;&#123;0..1&#125;&#123;0..1&#125;&#123;0..1&#125;&#123;0..1&#125;)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;a[5]&#125;</span></span><br><span class="line">00000101</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;a[255]&#125;</span></span><br><span class="line">11111111</span><br><span class="line"></span><br><span class="line">$ var=<span class="string">&quot;304&quot;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;obase=2; <span class="variable">$var</span>&quot;</span> | bc</span><br><span class="line">100110000</span><br></pre></td></tr></table></figure><h4 id="Printf-convert-oct-hex-dec"><a href="#Printf-convert-oct-hex-dec" class="headerlink" title="Printf convert oct,hex,dec"></a>Printf convert oct,hex,dec</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">printf</span> <span class="string">&quot;%d %d %x %o\n&quot;</span> 0x10 010 16 0xf</span><br><span class="line">16 8 10 17</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">16#f</span>))</span><br><span class="line">15</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">8#10</span>))</span><br><span class="line">8</span><br></pre></td></tr></table></figure><h4 id="Integer-ASCII-value-to-character"><a href="#Integer-ASCII-value-to-character" class="headerlink" title="Integer ASCII value to character"></a><a href="https://stackoverflow.com/questions/890262/integer-ascii-value-to-character-in-bash-using-printf">Integer ASCII value to character</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">printf</span> <span class="string">&quot;\x<span class="subst">$(printf %x 65)</span>&quot;</span></span><br><span class="line">A</span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;printf &quot;%c&quot;, 65&#125;&#x27;</span></span><br><span class="line">A</span><br></pre></td></tr></table></figure><h3 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h3><p>same with while read line</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ seq 88 97 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span><br></pre></td></tr></table></figure><h3 id="taskset"><a href="#taskset" class="headerlink" title="taskset"></a>taskset</h3><h4 id="zfs-and-nfs"><a href="#zfs-and-nfs" class="headerlink" title="zfs and nfs"></a>zfs and nfs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> i=13</span><br><span class="line">ps -C nfsd | awk <span class="string">&#x27;$0!~/PID/ &#123;print $1&#125;&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        [[ <span class="variable">$i</span> -gt 19 ]] &amp;&amp; <span class="built_in">export</span> i=13</span><br><span class="line">        taskset -p -c <span class="variable">$i</span> <span class="variable">$line</span></span><br><span class="line">        ((i=i+2))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> core=0</span><br><span class="line">[[ $(grep MHz /proc/cpuinfo -c) -gt 3 ]] &amp;&amp; maxcpu=8 &amp;&amp; <span class="keyword">for</span> i <span class="keyword">in</span> $(pgrep <span class="string">&#x27;z_wr_iss$&#x27;</span>);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        [[ <span class="variable">$core</span> -gt <span class="variable">$maxcpu</span> ]] &amp;&amp; core=0;    taskset -p -c <span class="variable">$core</span> <span class="variable">$i</span>;    ((core++)); ((core++));</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="stat"><a href="#stat" class="headerlink" title="stat"></a>stat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get moidfy time from </span></span><br><span class="line">$ <span class="built_in">stat</span> -c%Z file</span><br><span class="line"></span><br><span class="line"><span class="comment"># now</span></span><br><span class="line">$ date +%s</span><br></pre></td></tr></table></figure><h3 id="xargs-1"><a href="#xargs-1" class="headerlink" title="xargs"></a>xargs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -n <span class="variable">$your_server</span> <span class="string">&quot;lsscsi -gis | awk &#x27;\$0~/3500/&#123;print \$6&#125;&#x27; | xargs -I&#123;&#125; sdparm -s RCD=0 &#123;&#125; &quot;</span></span><br></pre></td></tr></table></figure><h3 id="the-old-script"><a href="#the-old-script" class="headerlink" title="the old script"></a>the old script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">head -c 10k test1 | tail -c 1k </span><br><span class="line">$ dd <span class="keyword">if</span>=test1 of=test2 bs=1k skip=9 count=1</span><br></pre></td></tr></table></figure><h3 id="Read-write-by-Byte-by-dd"><a href="#Read-write-by-Byte-by-dd" class="headerlink" title="Read write by Byte by dd"></a>Read write by Byte by dd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">       ibs=BYTES</span><br><span class="line">              <span class="built_in">read</span> up to BYTES bytes at a time (default: 512)</span><br><span class="line">       obs=BYTES</span><br><span class="line">              write BYTES bytes at a time (default: 512)</span><br><span class="line">       bs=BYTES</span><br><span class="line">              <span class="built_in">read</span> and write up to BYTES bytes at a time (default: 512); overrides ibs and obs</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> bs=1 </span><br></pre></td></tr></table></figure><h3 id="parallel"><a href="#parallel" class="headerlink" title="parallel"></a>parallel</h3><h4 id="Pipe-single-big-file"><a href="#Pipe-single-big-file" class="headerlink" title="Pipe single big file"></a>Pipe single big file</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat bigfile.bin | parallel --pipe --recend <span class="string">&#x27;&#x27;</span> -k bzip2 --best &gt; compressedfile.bz2</span><br><span class="line">cat bigfile.txt | parallel --block 10M --pipe grep <span class="string">&#x27;pattern&#x27;</span></span><br><span class="line">cat rands20M.txt | parallel --pipe awk \<span class="string">&#x27;&#123;s+=\$1&#125; END &#123;print s&#125;\&#x27;</span> | awk <span class="string">&#x27;&#123;s+=$1&#125; END &#123;print s&#125;&#x27;</span></span><br><span class="line">cat bigfile.txt | parallel  --pipe wc -l | awk <span class="string">&#x27;&#123;s+=$1&#125; END &#123;print s&#125;&#x27;</span></span><br><span class="line">cat bigfile.txt | parallel --pipe sed s^old^new^g</span><br></pre></td></tr></table></figure><h4 id="For-multiple-files"><a href="#For-multiple-files" class="headerlink" title="For multiple files"></a>For multiple files</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&#x27;*.html&#x27;</span> | parallel gzip --best</span><br></pre></td></tr></table></figure><h4 id="Get-parameter"><a href="#Get-parameter" class="headerlink" title="Get parameter"></a>Get parameter</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ seq 10 | parallel <span class="built_in">echo</span> test_&#123;&#125;</span><br><span class="line">test_1</span><br><span class="line">test_2</span><br><span class="line">test_3</span><br><span class="line">test_4</span><br><span class="line">test_5</span><br><span class="line">test_6</span><br><span class="line">test_7</span><br><span class="line">test_8</span><br><span class="line">test_9</span><br><span class="line">test_10</span><br><span class="line"></span><br><span class="line">$ parallel <span class="built_in">echo</span> ::: <span class="string">&quot;123&quot;</span> <span class="string">&quot;456&quot;</span> <span class="built_in">test</span> zzz</span><br><span class="line">123</span><br><span class="line">456</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">zzz</span><br><span class="line"></span><br><span class="line">$ parallel <span class="built_in">echo</span> ::: A B C ::: D E F</span><br><span class="line">A D</span><br><span class="line">A E</span><br><span class="line">A F</span><br><span class="line">B D</span><br><span class="line">B E</span><br><span class="line">B F</span><br><span class="line">C D</span><br><span class="line">C E</span><br><span class="line">C F</span><br><span class="line"></span><br><span class="line">$ parallel -a abc-file -a def-file <span class="built_in">echo</span></span><br><span class="line">$ cat abc-file | parallel -a - -a def-file <span class="built_in">echo</span></span><br><span class="line"><span class="comment"># replace - by ::::</span></span><br><span class="line">$ cat abc-file | parallel <span class="built_in">echo</span> :::: - def-file</span><br><span class="line"><span class="comment"># &quot;:::&quot; is stand input, :::: is file</span></span><br><span class="line">$ parallel <span class="built_in">echo</span> ::: A B C :::: def-file</span><br><span class="line"></span><br><span class="line">$ parallel --xapply <span class="built_in">echo</span> ::: A B C ::: D E F</span><br><span class="line">A D</span><br><span class="line">B E</span><br><span class="line">C F</span><br><span class="line">$ seq 50 | parallel -n0 -q  curl <span class="string">&#x27;example.com&#x27;</span></span><br><span class="line"><span class="comment">#  -n 0 means read one argument, but insert 0 arguments on the command line.</span></span><br><span class="line"><span class="comment">#  -q       Quote command.  This will quote the command line so special characters are not interpreted by the shell.</span></span><br></pre></td></tr></table></figure><h4 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">doit</span></span>() &#123;</span><br><span class="line">    x=<span class="variable">$1</span></span><br><span class="line">    do_something <span class="variable">$x</span></span><br><span class="line">    [... 100 lines that <span class="keyword">do</span> something with <span class="variable">$x</span> ...]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">export</span> -f doit</span><br><span class="line">  cat list | parallel doit</span><br></pre></td></tr></table></figure><h3 id="man-page-setting"><a href="#man-page-setting" class="headerlink" title="man page setting"></a><a href="https://stackoverflow.com/questions/10535432/tmux-man-page-search-highlighting">man page setting</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Colored man pages: http://linuxtidbits.wordpress.com/2009/03/23/less-colors-for-man-pages/</span></span><br><span class="line"><span class="comment"># Less Colors for Man Pages</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_mb=$<span class="string">&#x27;\E[01;31m&#x27;</span>       <span class="comment"># begin blinking</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_md=$<span class="string">&#x27;\E[01;38;5;74m&#x27;</span>  <span class="comment"># begin bold</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_me=$<span class="string">&#x27;\E[0m&#x27;</span>           <span class="comment"># end mode</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_se=$<span class="string">&#x27;\E[0m&#x27;</span>           <span class="comment"># end standout-mode</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_so=$<span class="string">&#x27;\E[38;5;016m\E[48;5;220m&#x27;</span>    <span class="comment"># begin standout-mode - info box</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_ue=$<span class="string">&#x27;\E[0m&#x27;</span>           <span class="comment"># end underline</span></span><br><span class="line"><span class="built_in">export</span> LESS_TERMCAP_us=$<span class="string">&#x27;\E[04;38;5;146m&#x27;</span> <span class="comment"># begin underline</span></span><br></pre></td></tr></table></figure><h3 id="expect-auto-add-ssh-key"><a href="#expect-auto-add-ssh-key" class="headerlink" title="expect auto add ssh key"></a>expect auto add ssh key</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect -f</span></span><br><span class="line"><span class="built_in">set</span> timeout 10</span><br><span class="line"><span class="built_in">set</span> ipaddr [lindex <span class="variable">$argv</span> 0]</span><br><span class="line"><span class="built_in">set</span> path [lindex <span class="variable">$argv</span> 1]</span><br><span class="line"><span class="built_in">set</span> user [lindex <span class="variable">$argv</span> 2]</span><br><span class="line"><span class="built_in">set</span> user testuser</span><br><span class="line"><span class="built_in">set</span> password 11111111</span><br><span class="line">spawn ssh-copy-id  -i <span class="variable">$path</span>/.ssh/id_rsa.pub <span class="variable">$user</span>@<span class="variable">$ipaddr</span></span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line"><span class="string">&quot;*yes/no*&quot;</span> &#123; send <span class="string">&quot;yes\r&quot;</span>; exp_continue&#125;</span><br><span class="line"><span class="string">&quot;*because they already exist*&quot;</span> &#123; send <span class="string">&quot;\r&quot;</span>; <span class="built_in">exit</span>&#125;</span><br><span class="line"><span class="string">&quot;*password:&quot;</span> &#123; send <span class="string">&quot;<span class="variable">$password</span>\r&quot;</span> &#125;</span><br><span class="line">timeout  &#123; puts <span class="string">&quot;timed out during login&quot;</span>; <span class="built_in">exit</span> 1 &#125;</span><br><span class="line">&#125;</span><br><span class="line">expect eof</span><br><span class="line"></span><br><span class="line">$ ./exp-test 192.168.1.1 /root testuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># expect return var to bash</span></span><br><span class="line">$ x=$(expect -c <span class="string">&#x27;send &quot;hello&quot;; exit 5;&#x27;</span>)</span><br><span class="line"><span class="built_in">echo</span> $?; <span class="built_in">echo</span> <span class="variable">$x</span></span><br><span class="line">5</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><h3 id="print-last-column"><a href="#print-last-column" class="headerlink" title="print last column"></a>print last column</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;Your string here&quot;</span>| tr <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;\n&#x27;</span> | tail -n1</span><br></pre></td></tr></table></figure><h3 id="use-tee-write-the-same-data-to-the-match-files"><a href="#use-tee-write-the-same-data-to-the-match-files" class="headerlink" title="use tee write the same data to the match files"></a>use tee write the same data to the match files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line">1  2  3  4  5  6  7  8  9</span><br><span class="line">$ <span class="built_in">echo</span> -n | tee ./*</span><br><span class="line">$ cat 1</span><br><span class="line">$ <span class="built_in">echo</span> 123 | tee ./*</span><br><span class="line">123</span><br><span class="line">$ cat ./*</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br></pre></td></tr></table></figure><h3 id="another-bash-trap"><a href="#another-bash-trap" class="headerlink" title="another bash trap"></a>another bash trap</h3><p>er<br>&amp;&amp; will change your return value in bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ rcode=$?;[[ ! <span class="variable">$rcode</span> -eq 0 ]] &amp;&amp; <span class="built_in">echo</span> -n <span class="string">&quot;:raidz&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="variable">$rcode</span></span><br><span class="line">~$ rcode=$?;[[ ! <span class="variable">$rcode</span> -eq 0 ]] &amp;&amp; <span class="built_in">echo</span> -n <span class="string">&quot;:raidz&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="variable">$rcode</span></span><br><span class="line">:raidz1</span><br><span class="line">~$ rcode=$?;[[ ! <span class="variable">$rcode</span> -eq 0 ]] &amp;&amp; <span class="built_in">echo</span> -n <span class="string">&quot;:raidz&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="variable">$rcode</span></span><br><span class="line">~$ rcode=$?;[[ ! <span class="variable">$rcode</span> -eq 0 ]] &amp;&amp; <span class="built_in">echo</span> -n <span class="string">&quot;:raidz&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="variable">$rcode</span></span><br><span class="line">:raidz1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>process</title>
      <link href="2018/12/02/process/"/>
      <url>2018/12/02/process/</url>
      
        <content type="html"><![CDATA[<h3 id="Process-status"><a href="#Process-status" class="headerlink" title="Process status"></a><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=06eb61844d841d0032a9950ce7f8e783ee49c0d0">Process status</a></h3><p><a href="https://unix.stackexchange.com/questions/412471/what-does-i-uppercase-i-mean-in-ps-aux">It is used for kernel threads which use the TASK_IDLE state when idling, instead of TASK_INTERRUPTIBLE; in previous versions of the kernel, such threads were reported as TASK_UNINTERRUPTIBLE which was confusing.</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/fs/proc/array.c b/fs/proc/array.c</span><br><span class="line">index 01196d3a..a120a45 100644</span><br><span class="line">--- a/fs/proc/array.c</span><br><span class="line">+++ b/fs/proc/array.c</span><br><span class="line">@@ -119,18 +119,23 @@ static inline void task_name(struct seq_file *m, struct task_struct *p)</span><br><span class="line">  * simple bit tests.</span><br><span class="line">  */</span><br><span class="line"> static const char * const task_state_array[] = &#123;</span><br><span class="line">-<span class="string">&quot;R (running)&quot;</span>,/*   0 */</span><br><span class="line">-<span class="string">&quot;S (sleeping)&quot;</span>,/*   1 */</span><br><span class="line">-<span class="string">&quot;D (disk sleep)&quot;</span>,/*   2 */</span><br><span class="line">-<span class="string">&quot;T (stopped)&quot;</span>,/*   4 */</span><br><span class="line">-<span class="string">&quot;t (tracing stop)&quot;</span>,/*   8 */</span><br><span class="line">-<span class="string">&quot;X (dead)&quot;</span>,/*  16 */</span><br><span class="line">-<span class="string">&quot;Z (zombie)&quot;</span>,/*  32 */</span><br><span class="line">+</span><br><span class="line">+/* states <span class="keyword">in</span> TASK_REPORT: */</span><br><span class="line">+<span class="string">&quot;R (running)&quot;</span>,/* 0x00 */</span><br><span class="line">+<span class="string">&quot;S (sleeping)&quot;</span>,/* 0x01 */</span><br><span class="line">+<span class="string">&quot;D (disk sleep)&quot;</span>,/* 0x02 */</span><br><span class="line">+<span class="string">&quot;T (stopped)&quot;</span>,/* 0x04 */</span><br><span class="line">+<span class="string">&quot;t (tracing stop)&quot;</span>,/* 0x08 */</span><br><span class="line">+<span class="string">&quot;X (dead)&quot;</span>,/* 0x10 */</span><br><span class="line">+<span class="string">&quot;Z (zombie)&quot;</span>,/* 0x20 */</span><br><span class="line">+</span><br><span class="line">+/* states beyond TASK_REPORT: */</span><br><span class="line">+<span class="string">&quot;I (idle)&quot;</span>,/* 0x40 */</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Get-the-process-system-overhead"><a href="#Get-the-process-system-overhead" class="headerlink" title="Get the process system overhead"></a>Get the process system overhead</h3><p>(14) utime  %lu<br>Amount of time that this process has been scheduled in user mode, measured in clock ticks (divide by sysconf(_SC_CLK_TCK)).  This includes guest time, guest_time (time spent running a virtual CPU, see below), so that applications that are not aware of the guest time field do not lose that time from their calculations.</p><p>(15) stime  %lu<br>Amount of time that this process has been scheduled in kernel mode, measured in clock ticks (divide by sysconf(_SC_CLK_TCK)).</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat proc<span class="regexp">/pid/</span>stat</span><br></pre></td></tr></table></figure><h3 id="Trace-D-state"><a href="#Trace-D-state" class="headerlink" title="Trace D state"></a>Trace D state</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">$ ps aux | grep find</span><br><span class="line">root      3326  0.4  0.0 120136  1324 pts/1    D+   08:59   0:00 find /mnt -<span class="built_in">type</span> f</span><br><span class="line">root      3401  0.0  0.0 112712   980 pts/2    R+   09:00   0:00 grep --color=auto find</span><br><span class="line"></span><br><span class="line">$ top -cbp 3326</span><br><span class="line">top - 09:00:14 up 4 days, 18:41,  2 users,  load average: 0.69, 0.23, 0.12</span><br><span class="line">Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 16233076 total, 15212880 free,   611076 used,   409120 buff/cache</span><br><span class="line">KiB Swap:  3145724 total,  3145724 free,        0 used. 15280092 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 3326 root      20   0  120136   1324    976 D   0.0  0.0   0:00.23 find /mnt -<span class="built_in">type</span> f</span><br><span class="line"></span><br><span class="line">$ pstack 3326</span><br><span class="line"><span class="comment">### pstack hang too</span></span><br><span class="line">Killed</span><br><span class="line"></span><br><span class="line">$ ps -flp  3326</span><br><span class="line">F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD</span><br><span class="line">0 D root      3326  3306  0  80   0 - 30034 rpc_wa 08:59 pts/1    00:00:00 find /mnt -<span class="built_in">type</span> f</span><br><span class="line"></span><br><span class="line">$ cat /proc/3326/status</span><br><span class="line">Name:find</span><br><span class="line">Umask:0022</span><br><span class="line">State:D (disk sleep)</span><br><span class="line">Tgid:3326</span><br><span class="line">Ngid:0</span><br><span class="line">Pid:3326</span><br><span class="line">PPid:3306</span><br><span class="line">TracerPid:3656</span><br><span class="line">Uid:0000</span><br><span class="line">Gid:0000</span><br><span class="line">FDSize:256</span><br><span class="line">Groups:0 </span><br><span class="line">VmPeak:  120736 kB</span><br><span class="line">VmSize:  120136 kB</span><br><span class="line">VmLck:       0 kB</span><br><span class="line">VmPin:       0 kB</span><br><span class="line">VmHWM:    1820 kB</span><br><span class="line">VmRSS:    1324 kB</span><br><span class="line">RssAnon:     348 kB</span><br><span class="line">RssFile:     976 kB</span><br><span class="line">RssShmem:       0 kB</span><br><span class="line">VmData:     280 kB</span><br><span class="line">VmStk:     132 kB</span><br><span class="line">VmExe:     184 kB</span><br><span class="line">VmLib:    3592 kB</span><br><span class="line">VmPTE:      68 kB</span><br><span class="line">VmSwap:       0 kB</span><br><span class="line">Threads:1</span><br><span class="line">SigQ:0/63312</span><br><span class="line">SigPnd:0000000000040000</span><br><span class="line">ShdPnd:0000000000000000</span><br><span class="line">SigBlk:0000000000000000</span><br><span class="line">SigIgn:0000000000000000</span><br><span class="line">SigCgt:0000000180000000</span><br><span class="line">CapInh:0000000000000000</span><br><span class="line">CapPrm:0000001fffffffff</span><br><span class="line">CapEff:0000001fffffffff</span><br><span class="line">CapBnd:0000001fffffffff</span><br><span class="line">CapAmb:0000000000000000</span><br><span class="line">Seccomp:0</span><br><span class="line">Speculation_Store_Bypass:vulnerable</span><br><span class="line">Cpus_allowed:ff</span><br><span class="line">Cpus_allowed_list:0-7</span><br><span class="line">Mems_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001</span><br><span class="line">Mems_allowed_list:0</span><br><span class="line">voluntary_ctxt_switches:3680</span><br><span class="line">nonvoluntary_ctxt_switches:44</span><br><span class="line"></span><br><span class="line">-----------<span class="built_in">wait</span> some seconds</span><br><span class="line">cat /proc/3326/status</span><br><span class="line">Name:find</span><br><span class="line">Umask:0022</span><br><span class="line">State:D (disk sleep)</span><br><span class="line">Tgid:3326</span><br><span class="line">Ngid:0</span><br><span class="line">Pid:3326</span><br><span class="line">PPid:3306</span><br><span class="line">TracerPid:3656</span><br><span class="line">Uid:0000</span><br><span class="line">Gid:0000</span><br><span class="line">FDSize:256</span><br><span class="line">Groups:0 </span><br><span class="line">VmPeak:  120736 kB</span><br><span class="line">VmSize:  120136 kB</span><br><span class="line">VmLck:       0 kB</span><br><span class="line">VmPin:       0 kB</span><br><span class="line">VmHWM:    1820 kB</span><br><span class="line">VmRSS:    1324 kB</span><br><span class="line">RssAnon:     348 kB</span><br><span class="line">RssFile:     976 kB</span><br><span class="line">RssShmem:       0 kB</span><br><span class="line">VmData:     280 kB</span><br><span class="line">VmStk:     132 kB</span><br><span class="line">VmExe:     184 kB</span><br><span class="line">VmLib:    3592 kB</span><br><span class="line">VmPTE:      68 kB</span><br><span class="line">VmSwap:       0 kB</span><br><span class="line">Threads:1</span><br><span class="line">SigQ:0/63312</span><br><span class="line">SigPnd:0000000000040000</span><br><span class="line">ShdPnd:0000000000000000</span><br><span class="line">SigBlk:0000000000000000</span><br><span class="line">SigIgn:0000000000000000</span><br><span class="line">SigCgt:0000000180000000</span><br><span class="line">CapInh:0000000000000000</span><br><span class="line">CapPrm:0000001fffffffff</span><br><span class="line">CapEff:0000001fffffffff</span><br><span class="line">CapBnd:0000001fffffffff</span><br><span class="line">CapAmb:0000000000000000</span><br><span class="line">Seccomp:0</span><br><span class="line">Speculation_Store_Bypass:vulnerable</span><br><span class="line">Cpus_allowed:ff</span><br><span class="line">Cpus_allowed_list:0-7</span><br><span class="line">Mems_allowed:00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001</span><br><span class="line">Mems_allowed_list:0</span><br><span class="line">voluntary_ctxt_switches:3735</span><br><span class="line">nonvoluntary_ctxt_switches:44</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### voluntary_ctxt_switches improved</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/3326/schedstat </span><br><span class="line">242008218 11032717 3814</span><br><span class="line">$ cat /proc/3326/schedstat </span><br><span class="line">242053568 11047734 3816</span><br><span class="line"></span><br><span class="line">$ cat /proc/3326/syscall </span><br><span class="line">257 0x6 0xeae7b8 0x30900 0x0 0x0 0x18 0x7fff7b5d4068 0x7fc71e63ae47</span><br><span class="line"></span><br><span class="line"><span class="comment">#### make sure install kernel-header</span></span><br><span class="line">$ grep 257 /usr/include/asm/unistd_64.h </span><br><span class="line"><span class="comment">#define __NR_openat 257</span></span><br></pre></td></tr></table></figure><p>(openat)[<a href="https://manpages.debian.org/testing/manpages-dev/openat.2.en.html">https://manpages.debian.org/testing/manpages-dev/openat.2.en.html</a>)<br>The open() system call opens the file specified by pathname. If the specified file does not exist, it may optionally (if O_CREAT is specified in flags) be created by open(). the return value of open() is a file descriptor</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/<span class="number">3326</span>/stack </span><br><span class="line"><span class="meta">[&lt;ffffffffc05f6f04&gt;]</span> rpc_wait_bit_killable+<span class="number">0x24</span>/<span class="number">0xb0</span> [sunrpc]</span><br><span class="line"><span class="meta">[&lt;ffffffffc05f86f4&gt;]</span> __rpc_execute+<span class="number">0x154</span>/<span class="number">0x420</span> [sunrpc]</span><br><span class="line"><span class="meta">[&lt;ffffffffc05f9f78&gt;]</span> rpc_execute+<span class="number">0x68</span>/<span class="number">0xc0</span> [sunrpc]</span><br><span class="line"><span class="meta">[&lt;ffffffffc05e9786&gt;]</span> rpc_run_task+<span class="number">0xf6</span>/<span class="number">0x150</span> [sunrpc]</span><br><span class="line"><span class="meta">[&lt;ffffffffc141a6d3&gt;]</span> nfs4_call_sync_sequence+<span class="number">0x63</span>/<span class="number">0xa0</span> [nfsv4]</span><br><span class="line"><span class="meta">[&lt;ffffffffc141b6bc&gt;]</span> _nfs4_proc_getattr+<span class="number">0xcc</span>/<span class="number">0xf0</span> [nfsv4]</span><br><span class="line"><span class="meta">[&lt;ffffffffc14279d2&gt;]</span> nfs4_proc_getattr+<span class="number">0x72</span>/<span class="number">0xf0</span> [nfsv4]</span><br><span class="line"><span class="meta">[&lt;ffffffffc13e4695&gt;]</span> __nfs_revalidate_inode+<span class="number">0xc5</span>/<span class="number">0x300</span> [nfs]</span><br><span class="line"><span class="meta">[&lt;ffffffffc13dbbc8&gt;]</span> nfs_lookup_verify_inode+<span class="number">0x38</span>/<span class="number">0x80</span> [nfs]</span><br><span class="line"><span class="meta">[&lt;ffffffffc13dea34&gt;]</span> nfs_lookup_revalidate+<span class="number">0x304</span>/<span class="number">0x640</span> [nfs]</span><br><span class="line"><span class="meta">[&lt;ffffffffc13ded9b&gt;]</span> nfs4_lookup_revalidate+<span class="number">0x2b</span>/<span class="number">0x130</span> [nfs]</span><br><span class="line"><span class="meta">[&lt;ffffffffa764d2ea&gt;]</span> lookup_fast+<span class="number">0x1da</span>/<span class="number">0x230</span></span><br><span class="line"><span class="meta">[&lt;ffffffffa764f72e&gt;]</span> do_last+<span class="number">0x3de</span>/<span class="number">0x12a0</span></span><br><span class="line"><span class="meta">[&lt;ffffffffa76523f7&gt;]</span> path_openat+<span class="number">0xd7</span>/<span class="number">0x640</span></span><br><span class="line"><span class="meta">[&lt;ffffffffa7653dfd&gt;]</span> do_filp_open+<span class="number">0x4d</span>/<span class="number">0xb0</span></span><br><span class="line"><span class="meta">[&lt;ffffffffa763ff27&gt;]</span> do_sys_open+<span class="number">0x137</span>/<span class="number">0x240</span></span><br><span class="line"><span class="meta">[&lt;ffffffffa7640064&gt;]</span> SyS_openat+<span class="number">0x14</span>/<span class="number">0x20</span></span><br><span class="line"><span class="meta">[&lt;ffffffffa7b74ddb&gt;]</span> system_call_fastpath+<span class="number">0x22</span>/<span class="number">0x27</span></span><br><span class="line"><span class="meta">[&lt;ffffffffffffffff&gt;]</span> <span class="number">0xffffffffffffffff</span></span><br></pre></td></tr></table></figure><p>The pid/stack not changed, because the process has hang</p><p>The system_call_fastpath in the bottom is a generic kernel system call handler function which has called the kernel code for that newfstatat syscall we issued (sys_newfstatat). And then, continuing to go upwards through the child functions we end up seeing a bunch of NFS functions in the stack!</p><p>check kworker stack</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="keyword">for</span> i <span class="keyword">in</span> `pgrep worker` ; <span class="keyword">do</span> <span class="built_in">ps</span> <span class="literal">-fp</span> <span class="variable">$i</span> ; <span class="built_in">cat</span> /proc/<span class="variable">$i</span>/stack ; done </span><br></pre></td></tr></table></figure><p>stack profiling<br><a href="https://github.com/tanelpoder/tpt-oracle/blob/5a2fb5e7c6bd548420bcb349266e1b31d7c4e15b/tools/unix/os_explain">os_explain</a></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">root     <span class="number">11683</span>  <span class="number">6.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    Feb09 <span class="number">654</span>:<span class="number">14</span> [nfsd]</span><br><span class="line">pid=<span class="number">11683</span>;export LC_ALL=C ; <span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">1.</span><span class="number">.100</span>&#125; ; <span class="keyword">do</span> cat /proc/$pid/syscall | awk <span class="string">&#x27;&#123; print $1 &#125;&#x27;</span> ; cat /proc/$pid/stack | ./os_explain -k ; usleep <span class="number">100000</span> ; done | sort -r | uniq -c</span><br><span class="line">      <span class="number">2</span> running</span><br><span class="line">      <span class="number">2</span> f9a5e97af7f58</span><br><span class="line">     <span class="number">98</span> <span class="number">-1</span></span><br><span class="line">    <span class="number">100</span>    <span class="number">0xffffffffffffffff</span> </span><br><span class="line">     <span class="number">97</span>     ret_from_fork_nospec_begin </span><br><span class="line">     <span class="number">97</span>      kthread </span><br><span class="line">     <span class="number">97</span>       nfsd </span><br><span class="line">      <span class="number">6</span>        svc_recv </span><br><span class="line">     <span class="number">91</span>        svc_process </span><br><span class="line">     <span class="number">91</span>         svc_process_common </span><br><span class="line">     <span class="number">91</span>          nfsd_dispatch </span><br><span class="line">     <span class="number">91</span>           nfsd4_proc_compound </span><br><span class="line">     <span class="number">91</span>            nfsd4_write </span><br><span class="line">     <span class="number">91</span>             nfsd_vfs_write </span><br><span class="line">     <span class="number">91</span>              vfs_writev </span><br><span class="line">     <span class="number">91</span>               do_readv_writev </span><br><span class="line">     <span class="number">91</span>                do_sync_readv_writev </span><br><span class="line">     <span class="number">91</span>                 ll_file_aio_write </span><br><span class="line">     <span class="number">91</span>                  ll_file_io_generic </span><br><span class="line">     <span class="number">91</span>                   cl_io_loop </span><br><span class="line">     <span class="number">91</span>                    cl_io_start </span><br><span class="line">     <span class="number">91</span>                     vvp_io_write_start </span><br><span class="line">     <span class="number">91</span>                      __generic_file_write_iter </span><br><span class="line">     <span class="number">91</span>                       __generic_file_aio_write </span><br><span class="line">     <span class="number">91</span>                        generic_file_buffered_write </span><br><span class="line">     <span class="number">91</span>                         ll_write_begin </span><br><span class="line">     <span class="number">72</span>                          vvp_io_write_commit </span><br><span class="line">     <span class="number">19</span>                          ll_page_sync_io </span><br><span class="line">     <span class="number">19</span>                           cl_io_submit_sync </span><br><span class="line">     <span class="number">72</span>                           cl_io_commit_async </span><br><span class="line">     <span class="number">72</span>                            lov_io_commit_async </span><br><span class="line">     <span class="number">19</span>                            cl_sync_io_wait </span><br><span class="line">     <span class="number">72</span>                             cl_io_commit_async </span><br><span class="line">     <span class="number">72</span>                              osc_io_commit_async </span><br><span class="line">     <span class="number">72</span>                               osc_page_cache_add </span><br><span class="line">     <span class="number">72</span>                                osc_queue_async_io </span><br><span class="line">     <span class="number">43</span>                                 osc_extent_find </span><br><span class="line">     <span class="number">29</span>                                 osc_enter_cache </span><br><span class="line">     <span class="number">43</span>                                  osc_extent_wait </span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">0xffffffffffffffff</span> <span class="string"></span></span><br><span class="line"> <span class="attr">ret_from_fork_nospec_begin</span> <span class="string"></span></span><br><span class="line">  <span class="attr">kthread</span> <span class="string"></span></span><br><span class="line">   <span class="attr">nfsd</span> <span class="string"></span></span><br><span class="line">    <span class="attr">svc_process</span> <span class="string"></span></span><br><span class="line">     <span class="attr">svc_process_common</span> <span class="string"></span></span><br><span class="line">      <span class="attr">nfsd_dispatch</span> <span class="string"></span></span><br><span class="line">       <span class="attr">nfsd4_proc_compound</span> <span class="string"></span></span><br><span class="line">        <span class="attr">nfsd4_write</span> <span class="string"></span></span><br><span class="line">         <span class="attr">nfsd_vfs_write</span> <span class="string"></span></span><br><span class="line">          <span class="attr">vfs_writev</span> <span class="string"></span></span><br><span class="line">           <span class="attr">do_readv_writev</span> <span class="string"></span></span><br><span class="line">            <span class="attr">do_sync_readv_writev</span> <span class="string"></span></span><br><span class="line">             <span class="attr">ll_file_aio_write</span> <span class="string"></span></span><br><span class="line">              <span class="attr">ll_file_io_generic</span> <span class="string"></span></span><br><span class="line">               <span class="attr">cl_io_loop</span> <span class="string"></span></span><br><span class="line">                <span class="attr">cl_io_start</span> <span class="string"></span></span><br><span class="line">                 <span class="attr">vvp_io_write_start</span> <span class="string"></span></span><br><span class="line">                  <span class="attr">__generic_file_write_iter</span> <span class="string"></span></span><br><span class="line">                   <span class="attr">__generic_file_aio_write</span> <span class="string"></span></span><br><span class="line">                    <span class="attr">generic_file_buffered_write</span> <span class="string"></span></span><br><span class="line">                     <span class="attr">ll_write_begin</span> <span class="string"></span></span><br><span class="line">                      <span class="attr">ll_page_sync_io</span> <span class="string"></span></span><br><span class="line">                       <span class="attr">cl_io_submit_sync</span> <span class="string"></span></span><br><span class="line">                        <span class="attr">cl_sync_io_wait</span> <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">0xffffffffffffffff</span> <span class="string"></span></span><br><span class="line"> <span class="attr">ret_from_fork_nospec_begin</span> <span class="string"></span></span><br><span class="line">  <span class="attr">kthread</span> <span class="string"></span></span><br><span class="line">   <span class="attr">nfsd</span> <span class="string"></span></span><br><span class="line">    <span class="attr">svc_process</span> <span class="string"></span></span><br><span class="line">     <span class="attr">svc_process_common</span> <span class="string"></span></span><br><span class="line">      <span class="attr">nfsd_dispatch</span> <span class="string"></span></span><br><span class="line">       <span class="attr">nfsd4_proc_compound</span> <span class="string"></span></span><br><span class="line">        <span class="attr">nfsd4_setattr</span> <span class="string"></span></span><br><span class="line">         <span class="attr">nfsd_setattr</span> <span class="string"></span></span><br><span class="line">          <span class="attr">notify_change</span> <span class="string"></span></span><br><span class="line">           <span class="attr">ll_setattr</span> <span class="string"></span></span><br><span class="line">            <span class="attr">ll_setattr_raw</span> <span class="string"></span></span><br><span class="line">             <span class="attr">cl_setattr_ost</span> <span class="string"></span></span><br><span class="line">              <span class="attr">cl_io_loop</span> <span class="string"></span></span><br><span class="line">               <span class="attr">cl_io_end</span> <span class="string"></span></span><br><span class="line">                <span class="attr">lov_io_end</span> <span class="string"></span></span><br><span class="line">                 <span class="meta">lov_io_call.isra.4</span> <span class="string"></span></span><br><span class="line">                  <span class="attr">lov_io_end_wrapper</span> <span class="string"></span></span><br><span class="line">                   <span class="attr">cl_io_end</span> <span class="string"></span></span><br><span class="line">                    <span class="attr">osc_io_setattr_end</span> <span class="string"></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>kallsyms</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$grep</span> -i f9a5e97af7f58 <span class="regexp">/proc/</span>kallsyms</span><br></pre></td></tr></table></figure><p>This holds the kernel exported symbol definitions used by the modules(X) tools to dynamically link and bind loadable modules. </p><p>symbol address  type   symbol name<br>ffffffffc034f070 T sas_rphy_free    [scsi_transport_sas]</p>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> process </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>perf</title>
      <link href="2018/11/23/perf/"/>
      <url>2018/11/23/perf/</url>
      
        <content type="html"><![CDATA[<p><a href="http://www.brendangregg.com/perf.html">reference</a></p><h3 id="Kernel-support"><a href="#Kernel-support" class="headerlink" title="Kernel support"></a>Kernel support</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for perf_events:</span></span><br><span class="line">CONFIG_PERF_EVENTS=y</span><br><span class="line"><span class="comment"># for stack traces:</span></span><br><span class="line">CONFIG_FRAME_POINTER=y</span><br><span class="line"><span class="comment"># kernel symbols:</span></span><br><span class="line">CONFIG_KALLSYMS=y</span><br><span class="line"><span class="comment"># tracepoints:</span></span><br><span class="line">CONFIG_TRACEPOINTS=y</span><br><span class="line"><span class="comment"># kernel function trace:</span></span><br><span class="line">CONFIG_FTRACE=y</span><br><span class="line"><span class="comment"># kernel-level dynamic tracing:</span></span><br><span class="line">CONFIG_KPROBES=y</span><br><span class="line">CONFIG_KPROBE_EVENTS=y</span><br><span class="line"><span class="comment"># user-level dynamic tracing:</span></span><br><span class="line">CONFIG_UPROBES=y</span><br><span class="line">CONFIG_UPROBE_EVENTS=y</span><br><span class="line"><span class="comment"># full kernel debug info:</span></span><br><span class="line">CONFIG_DEBUG_INFO=y</span><br><span class="line"><span class="comment"># kernel lock tracing:</span></span><br><span class="line">CONFIG_LOCKDEP=y</span><br><span class="line"><span class="comment"># kernel lock tracing:</span></span><br><span class="line">CONFIG_LOCK_STAT=y</span><br><span class="line"><span class="comment"># kernel dynamic tracepoint variables:</span></span><br><span class="line">CONFIG_DEBUG_INFO=y</span><br><span class="line"></span><br><span class="line">Kernel-level symbols are <span class="keyword">in</span> the kernel debuginfo package, or when the kernel is compiled with CONFIG_KALLSYMS</span><br><span class="line">The kernel stack traces are incomplete. Now a similar profile with CONFIG_FRAME_POINTER=y, it will cause information incomplete</span><br><span class="line">For kernel analysis, using CONFIG_KPROBES=y and CONFIG_KPROBE_EVENTS=y, to <span class="built_in">enable</span> kernel dynamic tracing. and CONFIG_FRAME_POINTER=y, <span class="keyword">for</span> frame pointer-based kernel stacks</span><br><span class="line">For user-level analysis, CONFIG_UPROBES=y and CONFIG_UPROBE_EVENTS=y, <span class="keyword">for</span> user-level dynamic tracing.</span><br><span class="line">If your kernel has debuginfo (CONFIG_DEBUG_INFO=y), you can fish out kernel variables from <span class="built_in">functions</span>. This is a simple example of examining a size_t (<span class="built_in">integer</span>)</span><br><span class="line"></span><br><span class="line">$ cat /boot/config-`uname -r`</span><br><span class="line">or </span><br><span class="line">$ zcat /proc/config.gz</span><br><span class="line"></span><br><span class="line">$ dmesg -T | grep PMU</span><br><span class="line">[Wed Aug  5 17:34:29 2020] Performance Events: PEBS fmt3+, Skylake events, 32-deep LBR, full-width counters, Intel PMU driver.</span><br><span class="line">[Wed Aug  5 17:34:29 2020] NMI watchdog: Enabled. Permanently consumes one hw-PMU counter.</span><br><span class="line">[Wed Aug  5 17:34:35 2020] RAPL PMU: API unit is 2^-32 Joules, 2 fixed counters, 655360 ms ovfl timer</span><br><span class="line">[Wed Aug  5 17:34:35 2020] RAPL PMU: hw unit of domain package 2^-14 Joules</span><br><span class="line">[Wed Aug  5 17:34:35 2020] RAPL PMU: hw unit of domain dram 2^-16 Joules</span><br></pre></td></tr></table></figure><p>Some of linux Desktop version not enable them, I have to re-complie from source code, maybe use Enterprise version is the good choice</p><a id="more"></a><h4 id="perf-source-code"><a href="#perf-source-code" class="headerlink" title="perf source code"></a>perf source code</h4><p><a href="https://cdn.kernel.org/pub/linux/kernel/">https://cdn.kernel.org/pub/linux/kernel/</a><br>linux-xx.xx.xx/tools/perf/</p><p>increase the buffer </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/kernel/perf_event_mlock_kb</span><br></pre></td></tr></table></figure><h3 id="perf-top"><a href="#perf-top" class="headerlink" title="perf top"></a>perf top</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ perf <span class="keyword">list</span></span><br><span class="line">$ perf top</span><br><span class="line">$ perf top -ag</span><br><span class="line"># <span class="built_in">input</span> ? <span class="keyword">for</span> <span class="keyword">help</span> ,<span class="string">&quot;e&quot;</span> <span class="built_in">expand</span> single <span class="string">&quot;E&quot;</span> <span class="keyword">is</span> <span class="keyword">all</span>, <span class="string">&quot;c&quot;</span> take it back, <span class="string">&quot;C&quot;</span> <span class="keyword">is</span> <span class="keyword">all</span></span><br><span class="line"></span><br><span class="line">events could <span class="built_in">get</span> from /sys/kernel/<span class="keyword">debug</span>/tracing/available_events</span><br><span class="line">$ perf top -<span class="keyword">e</span> branch-misses,cycles,sched:sched_switch</span><br><span class="line">$ perf top -<span class="keyword">e</span> <span class="string">&#x27;&#123;branch-misses,cycles&#125;:u&#x27;</span></span><br><span class="line">$ perf top -<span class="keyword">e</span> <span class="string">&#x27;cycles&#x27;</span> -s comm,dso,sym</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>if some of events no in perf list, you could get the code from hardware user manual </p><h3 id="perf-stat"><a href="#perf-stat" class="headerlink" title="perf stat"></a>perf stat</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># CPU counter statistics <span class="keyword">for</span> the specified PID, until Ctrl-C:</span><br><span class="line">perf stat -p PID</span><br><span class="line"></span><br><span class="line"># CPU counter statistics <span class="keyword">for</span> the entire system, <span class="keyword">for</span> <span class="number">5</span> seconds:</span><br><span class="line">perf stat -a sleep <span class="number">5</span></span><br><span class="line"></span><br><span class="line"># Various basic CPU statistics, system wide, <span class="keyword">for</span> <span class="number">10</span> seconds:</span><br><span class="line">perf stat -e cycles,instructions,cache-<span class="built_in">ref</span>erences,cache-misses,bus-cycles -a sleep <span class="number">10</span></span><br><span class="line"></span><br><span class="line"># Various CPU level <span class="number">1</span> data cache statistics <span class="keyword">for</span> the specified command:</span><br><span class="line">perf stat -e L1-dcache-loads,L1-dcache-load-misses,L1-dcache-stores command</span><br><span class="line"></span><br><span class="line"># Various CPU data TLB statistics <span class="keyword">for</span> the specified command:</span><br><span class="line">perf stat -e dTLB-loads,dTLB-load-misses,dTLB-prefetch-misses command</span><br><span class="line"></span><br><span class="line"># Various CPU last level cache statistics <span class="keyword">for</span> the specified command:</span><br><span class="line">perf stat -e LLC-loads,LLC-load-misses,LLC-stores,LLC-prefetches command</span><br><span class="line"></span><br><span class="line"># Using raw PMC counters, eg, counting unhalted core cycles:</span><br><span class="line">perf stat -e r003c -a sleep <span class="number">5</span> </span><br><span class="line"></span><br><span class="line"># PMCs: counting cycles <span class="keyword">and</span> frontend stalls via raw specification:</span><br><span class="line">perf stat -e cycles -e cpu/event=<span class="number">0x0e</span>,umask=<span class="number">0x01</span>,inv,cmask=<span class="number">0x01</span>/ -a sleep <span class="number">5</span></span><br><span class="line"></span><br><span class="line"># Count syscalls per-second system-wide:</span><br><span class="line">perf stat -e raw_syscalls:sys_enter -I <span class="number">1000</span> -a</span><br><span class="line"></span><br><span class="line"># Count system calls by type <span class="keyword">for</span> the specified PID, until Ctrl-C:</span><br><span class="line">perf stat -e <span class="string">&#x27;syscalls:sys_enter_*&#x27;</span> -p PID</span><br><span class="line"></span><br><span class="line">$ perf stat -e <span class="string">&#x27;block:*&#x27;</span> -a sleep <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;system wide&#x27;</span>:</span><br><span class="line"></span><br><span class="line">                 <span class="number">0</span>      block:block_touch_buffer</span><br><span class="line">             <span class="number">6</span>,<span class="number">925</span>      block:block_dirty_buffer</span><br><span class="line">                 <span class="number">0</span>      block:block_rq_abort</span><br><span class="line">                 <span class="number">0</span>      block:block_rq_requeue</span><br><span class="line">             <span class="number">1</span>,<span class="number">585</span>      block:block_rq_complete</span><br><span class="line">             <span class="number">1</span>,<span class="number">539</span>      block:block_rq_insert</span><br><span class="line">             <span class="number">1</span>,<span class="number">541</span>      block:block_rq_issue</span><br><span class="line">                 <span class="number">0</span>      block:block_bio_bounce</span><br><span class="line">                 <span class="number">0</span>      block:block_bio_complete</span><br><span class="line">                 <span class="number">0</span>      block:block_bio_backmerge</span><br><span class="line">                 <span class="number">0</span>      block:block_bio_frontmerge</span><br><span class="line">             <span class="number">1</span>,<span class="number">539</span>      block:block_bio_queue</span><br><span class="line">             <span class="number">1</span>,<span class="number">539</span>      block:block_getrq</span><br><span class="line">                 <span class="number">0</span>      block:block_sleeprq</span><br><span class="line">             <span class="number">1</span>,<span class="number">495</span>      block:block_plug</span><br><span class="line">             <span class="number">1</span>,<span class="number">495</span>      block:block_unplug</span><br><span class="line">                 <span class="number">0</span>      block:block_split</span><br><span class="line">             <span class="number">1</span>,<span class="number">497</span>      block:block_bio_remap</span><br><span class="line">                 <span class="number">0</span>      block:block_rq_remap</span><br><span class="line"></span><br><span class="line">      <span class="number">10.016486367</span> seconds time elapsed</span><br><span class="line"></span><br><span class="line">$ perf stat -e <span class="string">&#x27;syscalls:sys_enter_*&#x27;</span> -p <span class="number">101559</span></span><br><span class="line"></span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_pselect6                                     (<span class="number">99.37</span>%)</span><br><span class="line">                <span class="number">16</span>      syscalls:sys_enter_poll                                       (<span class="number">99.33</span>%)</span><br><span class="line">               <span class="number">100</span>      syscalls:sys_enter_ppoll                                      (<span class="number">99.33</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_getdents                                     (<span class="number">99.33</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_getdents64                                     (<span class="number">99.33</span>%)</span><br><span class="line">                <span class="number">63</span>      syscalls:sys_enter_ioctl                                      (<span class="number">99.33</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_fcntl                                      (<span class="number">99.33</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_mknodat                                     (<span class="number">99.33</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_mknod                                      (<span class="number">99.29</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_mkdirat                                     (<span class="number">99.29</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_mkdir                                      (<span class="number">99.29</span>%)</span><br><span class="line">                 <span class="number">0</span>      syscalls:sys_enter_rmdir                                      (<span class="number">99.29</span>%)</span><br></pre></td></tr></table></figure><p>u - user-space counting<br>k - kernel counting<br>h - hypervisor counting<br>I - non idle counting<br>G - guest counting (in KVM guests)<br>H - host counting (not in KVM guests)<br>p - precise level<br>P - use maximum detected precise level<br>S - read sample value (PERF_SAMPLE_READ)<br>D - pin the event to the PMU<br>W - group is weak and will fallback to non-group if not schedulable</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ perf stat -e instructions:H ls -l</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;ls -l&#x27;</span>:</span><br><span class="line"></span><br><span class="line">         <span class="number">7</span>,<span class="number">361</span>,<span class="number">491</span>      instructions:H</span><br><span class="line"></span><br><span class="line">       <span class="number">0.003494865</span> seconds time elapsed</span><br><span class="line"></span><br><span class="line">$ perf stat ls -l</span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;ls -l&#x27;</span>:</span><br><span class="line"></span><br><span class="line">          <span class="number">3.051715</span>      task-clock (msec)         #    <span class="number">0.892</span> CPUs utilized</span><br><span class="line">                 <span class="number">1</span>      context-switches          #    <span class="number">0.328</span> K/sec</span><br><span class="line">                 <span class="number">0</span>      cpu-migrations            #    <span class="number">0.000</span> K/sec</span><br><span class="line">               <span class="number">412</span>      page-faults               #    <span class="number">0.135</span> M/sec</span><br><span class="line">         <span class="number">7</span>,<span class="number">312</span>,<span class="number">574</span>      cycles                    #    <span class="number">2.396</span> GHz</span><br><span class="line">         <span class="number">7</span>,<span class="number">110</span>,<span class="number">578</span>      instructions              #    <span class="number">0.97</span>  insn per cycle</span><br><span class="line">         <span class="number">1</span>,<span class="number">439</span>,<span class="number">981</span>      branches                  #  <span class="number">471.860</span> M/sec</span><br><span class="line">            <span class="number">35</span>,<span class="number">532</span>      branch-misses             #    <span class="number">2.47</span>% of all branches</span><br><span class="line"></span><br><span class="line">       <span class="number">0.003421608</span> seconds time elapsed</span><br></pre></td></tr></table></figure><h3 id="perf-record"><a href="#perf-record" class="headerlink" title="perf record"></a>perf record</h3><p><a href="http://www.brendangregg.com/perf.html">reference</a></p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ perf <span class="keyword">record</span> -a perf bench sched messaging -g <span class="number">400</span> -p &amp;&amp; perf <span class="keyword">report</span></span><br><span class="line"></span><br><span class="line">## -F <span class="number">888</span> Hertz was chosen instead <span class="keyword">of</span> <span class="number">100</span> <span class="keyword">to</span> avoid lockstep sampling <span class="keyword">with</span> other software routines</span><br><span class="line">$ perf <span class="keyword">record</span> -a -g <span class="comment">--call-graph dwarf,8192 -F 888 sleep 60</span></span><br><span class="line">$ perf <span class="keyword">record</span> -a -g <span class="comment">--call-graph dwarf,8192 -F 888 -o your-perf.data sleep 60</span></span><br><span class="line"># some timer interrput was <span class="number">1000</span>ms, some guy suggest change the <span class="keyword">default</span> frequency</span><br><span class="line"></span><br><span class="line">$ perf <span class="keyword">record</span> -e <span class="keyword">context</span>-switches -ag <span class="comment">-- sleep 10</span></span><br><span class="line">$ perf <span class="keyword">record</span> -e <span class="symbol">&#x27;cycles</span>&#x27; -g <span class="comment">-- collectl -i3 -scdnt</span></span><br><span class="line"></span><br><span class="line">-e, <span class="comment">--event &lt;event&gt;   event selector. use &#x27;perf list&#x27; to list available events</span></span><br><span class="line">-g                    enables call-graph recording</span><br><span class="line"></span><br><span class="line"># Trace <span class="keyword">all</span> <span class="keyword">block</span> device issues <span class="keyword">and</span> completions (has timestamps), <span class="keyword">until</span> Ctrl-C:</span><br><span class="line">perf <span class="keyword">record</span> -e <span class="keyword">block</span>:block_rq_issue -e <span class="keyword">block</span>:block_rq_complete -a</span><br><span class="line"></span><br><span class="line"># Trace <span class="keyword">all</span> <span class="keyword">block</span> completions, <span class="keyword">of</span> size at least <span class="number">100</span> Kbytes, <span class="keyword">until</span> Ctrl-C:</span><br><span class="line">perf <span class="keyword">record</span> -e <span class="keyword">block</span>:block_rq_complete <span class="comment">--filter &#x27;nr_sector &gt; 200&#x27;</span></span><br><span class="line">perf <span class="keyword">record</span> -e <span class="keyword">block</span>:block_rq_complete <span class="comment">--filter &#x27;nr_sector &gt; 200&#x27; -- sleep 10</span></span><br><span class="line"></span><br><span class="line"># Trace <span class="keyword">all</span> <span class="keyword">block</span> completions, synchronous writes only, <span class="keyword">until</span> Ctrl-C:</span><br><span class="line">perf <span class="keyword">record</span> -e <span class="keyword">block</span>:block_rq_complete <span class="comment">--filter &#x27;rwbs == &quot;WS&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"># Trace <span class="keyword">all</span> <span class="keyword">block</span> completions, <span class="keyword">all</span> types <span class="keyword">of</span> writes, <span class="keyword">until</span> Ctrl-C:</span><br><span class="line">perf <span class="keyword">record</span> -e <span class="keyword">block</span>:block_rq_complete <span class="comment">--filter &#x27;rwbs ~ &quot;*W*&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"># Trace <span class="keyword">all</span> ext4 calls, <span class="keyword">and</span> write <span class="keyword">to</span> a non-ext4 location, <span class="keyword">until</span> Ctrl-C:</span><br><span class="line">perf <span class="keyword">record</span> -e <span class="symbol">&#x27;ext4</span>:*&#x27; -o /tmp/perf.data -ag</span><br></pre></td></tr></table></figure><h3 id="perf-report"><a href="#perf-report" class="headerlink" title="perf report"></a>perf report</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">$ perf probe -a <span class="string">&#x27;sk_filter_trim_cap%return return=$retval:s32&#x27;</span></span><br><span class="line">$ perf record -e probe:sk_filter_trim_cap -agR --filter <span class="string">&#x27;return &lt; 0&#x27;</span> sleep 10</span><br><span class="line">$ perf report</span><br><span class="line">     Samples: 692  of event <span class="string">&#x27;probe:sk_filter_trim_cap&#x27;</span>, Event count (approx.): 692</span><br><span class="line">       Children      Self  Trace output</span><br><span class="line">     +  100.00%   100.00%  (ffffffff8a0551c0 &lt;- ffffffff8a0a735c) <span class="attribute">return</span>=-12</span><br><span class="line"></span><br><span class="line">$ perf report -g --tui</span><br><span class="line"></span><br><span class="line">$ perf report</span><br><span class="line"></span><br><span class="line">Annotate trace_graph_entry                                                                                                                    </span><br><span class="line">Zoom into the Kernel DSO                                                                                                                      </span><br><span class="line">Browse mperfap details                                                                                                                            </span><br><span class="line"><span class="builtin-name">Run</span> scripts <span class="keyword">for</span> samples of symbol [trace_graph_entry]                                                                                         </span><br><span class="line"><span class="builtin-name">Run</span> scripts <span class="keyword">for</span> all samples                                                                                                                   </span><br><span class="line">Switch <span class="keyword">to</span> another data file <span class="keyword">in</span> PWD                                                                                                            </span><br><span class="line">Exit</span><br><span class="line"></span><br><span class="line"><span class="comment">#Select Annotate trace_graph_entry</span></span><br><span class="line">  0.77        <span class="builtin-name">add</span>    -0x7aecaba0(,%rax,8),%rbx</span><br><span class="line">  0.49        mov    <span class="variable">$0x1</span>,%eax</span><br><span class="line">              lock   xadd   %eax,0x18(%rbx)</span><br><span class="line"> 19.76        test   %eax,%eax</span><br><span class="line">             jne    1b9</span><br><span class="line">              mov    %gs:0x10e78,%rax</span><br><span class="line">  0.84        mov    -0x3fbc(%rax),%ecx</span><br><span class="line">              mov    %r12,%rdx</span><br><span class="line">              mov    %rdi,%rsi</span><br><span class="line">              mov    %r8,%rdi</span><br><span class="line">  0.63       callq  __trace_graph_entry</span><br><span class="line">              mov    %eax,%edx</span><br><span class="line">  0.70  b4:   lock   decl   0x18(%rbx)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ perf record -e sched:* -a # <span class="keyword">not</span> <span class="builtin-name">add</span> -g</span><br><span class="line">$ perf report -n --stdio -s comm,dso,symbol</span><br><span class="line"><span class="comment"># Overhead       Samples  Command          Shared Object      Symbol</span></span><br><span class="line"><span class="comment"># ........  ............  ...............  .................  ..................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    66.85%         18167  swapper          [kernel.kallsyms]  [k] ttwu_do_wakeup</span><br><span class="line">     8.96%          2434  systemd-journal  [kernel.kallsyms]  [k] ttwu_do_wakeup</span><br><span class="line">     3.84%          1043  vhost-127249     [kernel.kallsyms]  [k] ttwu_do_wakeup</span><br><span class="line">     3.59%           976  vhost-100221     [kernel.kallsyms]  [k] ttwu_do_wakeup</span><br><span class="line">     3.49%           949  vhost-102705     [kernel.kallsyms]  [k] ttwu_do_wakeup</span><br><span class="line">     3.37%           917  vhost-100880     [kernel.kallsyms]  [k] ttwu_do_wakeup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Report, with stacks in folded format: one line per stack (needs 4.4):</span></span><br><span class="line">$ perf report --stdio -n -g folded</span><br><span class="line">$ perf report --stdio  ## record <span class="builtin-name">add</span> -g</span><br><span class="line"><span class="comment"># Children      Self       Samples  Command</span></span><br><span class="line"><span class="comment"># ........  ........  ............  ...............</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    64.39%    64.39%          1013  swapper</span><br><span class="line">            |</span><br><span class="line">             --64.39%--start_cpu</span><br><span class="line">                       |</span><br><span class="line">                        --64.39%--start_secondary</span><br><span class="line">                                  |</span><br><span class="line">                                   --64.39%--cpu_startup_entry</span><br><span class="line">                                             |</span><br><span class="line">                                              --64.39%--arch_cpu_idle</span><br><span class="line">                                                        cpuidle_idle_call</span><br><span class="line">                                                        |</span><br><span class="line">                                                        |--51.81%--cpuidle_enter_state</span><br><span class="line">                                                        |          |</span><br><span class="line">                                                        |          |--29.16%--poll_idle</span><br><span class="line">                                                        |          |</span><br><span class="line">                                                        |           --22.65%--intel_idle</span><br><span class="line">                                                        |</span><br><span class="line">                                                         --12.58%--ret_from_intr</span><br><span class="line">                                                                   __irqentry_text_start</span><br><span class="line">                                                                   |</span><br><span class="line">                                                                    --12.58%--irq_exit</span><br><span class="line">                                                                              do_softirq</span><br><span class="line">                                                                              call_softirq</span><br><span class="line">                                                                              __do_softirq</span><br><span class="line">                                                                              |</span><br><span class="line">                                                                               --12.58%--net_rx_action</span><br><span class="line">                                                                                         bnx2x_poll</span><br><span class="line">                                                                                         bnx2x_rx_int</span><br><span class="line">                                                                                         napi_gro_receive</span><br><span class="line">                                                                                         netif_receive_skb_internal</span><br><span class="line">                                                                                         __netif_receive_skb</span><br><span class="line">                                                                                         __netif_receive_skb_core</span><br><span class="line">                                                                                         br_handle_frame</span><br><span class="line">                                                                                         br_handle_frame_finish</span><br><span class="line">                                                                                         br_flood</span><br><span class="line">                                                                                         deliver_clone</span><br><span class="line">                                                                                         __br_forward</span><br><span class="line">                                                                                         br_forward_finish</span><br><span class="line">                                                                                         br_dev_queue_push_xmit</span><br><span class="line">                                                                                         dev_queue_xmit</span><br><span class="line">                                                                                         __dev_queue_xmit</span><br><span class="line">                                                                                         __qdisc_run</span><br><span class="line">                                                                                         sch_direct_xmit</span><br><span class="line">                                                                                         dev_hard_start_xmit</span><br><span class="line">                                                                                         tun_net_xmit</span><br><span class="line">                                                                                         __wake_up</span><br><span class="line">                                                                                         __wake_up_common</span><br><span class="line">                                                                                         vhost_poll_wakeup</span><br><span class="line">                                                                                         vhost_work_queue</span><br><span class="line">                                                                                         wake_up_process</span><br><span class="line">                                                                                         try_to_wake_up</span><br><span class="line">                                                                                         ttwu_do_activate.constprop.93</span><br><span class="line">                                                                                         activate_task</span><br><span class="line">                                                                                         ftrace_graph_caller</span><br><span class="line">                                                                                         prepare_ftrace_return</span><br><span class="line"></span><br><span class="line">$ perf record -F 990 -a --call-graph lbr</span><br><span class="line">$ perf script</span><br><span class="line"></span><br><span class="line"><span class="comment"># List all perf.data events, with my recommended fields (needs record -a; newer kernels):</span></span><br><span class="line">$ perf<span class="built_in"> script </span>--header -F comm,pid,tid,cpu,time,event,ip,sym,dso </span><br><span class="line"></span><br><span class="line"><span class="comment"># Dump raw contents from perf.data as hex (for debugging):</span></span><br><span class="line">$ perf<span class="built_in"> script </span>-D</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disassemble and annotate instructions with percentages (needs some debuginfo):</span></span><br><span class="line">$ perf annotate --stdio</span><br></pre></td></tr></table></figure><h3 id="perf-diff"><a href="#perf-diff" class="headerlink" title="perf diff"></a>perf diff</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ perf diff perf.data perf.data.old</span><br><span class="line"><span class="comment"># Event &#x27;cycles:ppp&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Baseline  Delta Abs  Shared Object              Symbol</span></span><br><span class="line"><span class="comment"># ........  .........  .........................  .....................................................</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    50.00%    -50.00%  [kernel.kallsyms]          [k] prepare_ftrace_return</span><br><span class="line">    25.00%    +44.80%  [kernel.kallsyms]          [k] intel_idle</span><br><span class="line">    25.00%    -25.00%  [kernel.kallsyms]          [k] vcpu_enter_guest</span><br><span class="line">     0.00%    +23.45%  [kernel.kallsyms]          [k] trace_graph_entry</span><br><span class="line">     0.00%     +4.69%  [kernel.kallsyms]          [k] avl_find</span><br><span class="line">     0.00%     +2.05%  [kernel.kallsyms]          [k] poll_idle</span><br><span class="line">     0.00%     +0.00%  [kernel.kallsyms]          [k] ftrace_graph_caller</span><br><span class="line">     0.00%     +0.00%  systemd-journald           [.] 0x000000000000d1e0</span><br><span class="line">     0.00%     +0.00%  [kernel.kallsyms]          [k] __trace_graph_entry</span><br><span class="line">     0.00%     +0.00%  [kernel.kallsyms]          [k] trace_buffer_lock_reserve</span><br><span class="line">     0.00%     +0.00%  [kernel.kallsyms]          [k] ftrace_caller</span><br><span class="line">     0.00%     +0.00%  libsystemd.so.0.6.0        [.] 0x0000000000005b5f</span><br><span class="line">     0.00%     +0.00%  [kernel.kallsyms]          [k] ring_buffer_lock_reserve</span><br><span class="line">     0.00%     -0.00%  [kernel.kallsyms]          [k] console_unlock</span><br><span class="line">     0.00%     -0.00%  [kernel.kallsyms]          [k] native_queued_spin_lock_slowpath</span><br><span class="line">     0.00%     -0.00%  [kernel.kallsyms]          [k] osq_lock</span><br><span class="line">     0.00%     +0.00%  [kernel.kallsyms]          [k] ftrace_graph_is_dead</span><br><span class="line">     0.00%     +0.00%  [kernel.kallsyms]          [k] ftrace_stub</span><br></pre></td></tr></table></figure><h3 id="Dwarf"><a href="#Dwarf" class="headerlink" title="Dwarf"></a>Dwarf</h3><p>Since about the 3.9 kernel, perf_events has supported a workaround for missing frame pointers in user-level stacks: libunwind, which uses dwarf. This can be enabled using call-graph dwarf (or -g dwarf).</p><h3 id="perf-list"><a href="#perf-list" class="headerlink" title="perf list"></a>perf list</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ perf list subsys block:*</span><br><span class="line">$ perf list | awk -F: <span class="string">&#x27;/Tracepoint event/ &#123; lib[$1]++; PROCINFO[&quot;sorted_in&quot;] = &quot;@val_num_desc&quot; &#125; END &#123;  for (l in lib) &#123; printf &quot;  %-16.16s %d\n&quot;, l, lib[l] &#125; &#125;&#x27;</span> | column</span><br><span class="line">    syscalls       <span class="number">604</span>    kmem           <span class="number">12</span>    context_tracki <span class="number">2</span></span><br><span class="line">    xfs            <span class="number">391</span>    net            <span class="number">9</span>    gpio           <span class="number">2</span></span><br><span class="line">    nfs4           <span class="number">66</span>    i2c            <span class="number">8</span>    migrate        <span class="number">2</span></span><br><span class="line">    kvm            <span class="number">55</span>    dma_fence      <span class="number">8</span>    sock           <span class="number">2</span></span><br><span class="line">    nfs            <span class="number">44</span>    iommu          <span class="number">7</span>    task           <span class="number">2</span></span><br><span class="line">    xen            <span class="number">35</span>    libata         <span class="number">6</span>    raw_syscalls   <span class="number">2</span></span><br><span class="line">    sunrpc         <span class="number">31</span>    filelock       <span class="number">6</span>    pagemap        <span class="number">2</span></span><br><span class="line">    writeback      <span class="number">25</span>    scsi           <span class="number">5</span>    signal         <span class="number">2</span></span><br><span class="line">    sched          <span class="number">23</span>    mpx            <span class="number">5</span>    filemap        <span class="number">2</span></span><br><span class="line">    irq_vectors    <span class="number">22</span>    irq            <span class="number">5</span>    qdisc          <span class="number">1</span></span><br><span class="line">    xhci-hcd       <span class="number">20</span>    module         <span class="number">5</span>    mce            <span class="number">1</span></span><br><span class="line">    power          <span class="number">20</span>    rpm            <span class="number">4</span>    <span class="built_in">int</span>el_ish      <span class="number">1</span></span><br><span class="line">    block          <span class="number">19</span>    mei            <span class="number">4</span>    hyperv         <span class="number">1</span></span><br><span class="line">    nfsd           <span class="number">18</span>    bridge         <span class="number">4</span>    vsyscall       <span class="number">1</span></span><br><span class="line">    regmap         <span class="number">15</span>    workqueue      <span class="number">4</span>    rcu            <span class="number">1</span></span><br><span class="line">    random         <span class="number">15</span>    drm            <span class="number">3</span>    printk         <span class="number">1</span></span><br><span class="line">    vmscan         <span class="number">15</span>    ras            <span class="number">3</span>    udp            <span class="number">1</span></span><br><span class="line">    fs_dax         <span class="number">15</span>    skb            <span class="number">3</span>    napi           <span class="number">1</span></span><br><span class="line">    kvmmmu         <span class="number">14</span>    compaction     <span class="number">3</span>    ftrace         <span class="number">1</span></span><br><span class="line">    timer          <span class="number">13</span>    exceptions     <span class="number">2</span>    oom            <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="Heat-map"><a href="#Heat-map" class="headerlink" title="Heat map"></a>Heat map</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:<span class="comment">//github.com/brendangregg/FlameGraph  # or download it from github</span></span><br><span class="line">$ <span class="keyword">cd</span> FlameGraph</span><br><span class="line">$ perf record -F 99 -ag -- <span class="keyword">sleep</span> 60</span><br><span class="line">$ perf script | ./stackcollapse-perf.<span class="keyword">pl</span> &gt; <span class="keyword">out</span>.perf-folded</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">cat</span> <span class="keyword">out</span>.perf-folded | ./flamegraph.<span class="keyword">pl</span> &gt; perf-kernel.svg</span><br><span class="line">or</span><br><span class="line">$ grep -v cpu_idle <span class="keyword">out</span>.perf-folded | ./flamegraph.<span class="keyword">pl</span> &gt; nonidle.svg</span><br><span class="line">$ grep nfs <span class="keyword">out</span>.perf-folded | ./flamegraph.<span class="keyword">pl</span> &gt; nfsinternals.svg</span><br><span class="line">or</span><br><span class="line">$ grep -v cpu_idle <span class="keyword">out</span>.perf-folded | ./flamegraph.<span class="keyword">pl</span> &gt; nonidle.svg</span><br><span class="line">$ egrep &#x27;system_call.*sys_(<span class="keyword">read</span>|write)&#x27; <span class="keyword">out</span>.perf-folded | ./flamegraph.<span class="keyword">pl</span> &gt; rw.svg</span><br></pre></td></tr></table></figure><h3 id="perf-sched-latency-will-summarize-scheduler-latencies-by-task-including-average-and-maximum-delay"><a href="#perf-sched-latency-will-summarize-scheduler-latencies-by-task-including-average-and-maximum-delay" class="headerlink" title="perf sched latency will summarize scheduler latencies by task, including average and maximum delay:"></a>perf sched latency will summarize scheduler latencies by task, including average and maximum delay:</h3><p>perf sched latency<br>perf sched timehist<br>perf sched timehist -MVw<br>perf sched map</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>perf stat -a -e task-clock,cycles,instructions,branches,branch-misses -e stalled-cycles-frontend,stalled-cycles-backend -e cache-references,cache-misses -e LLC-loads,LLC-load-misses,LLC-stores,LLC-store-misses -e L1-dcache-loads,L1-dcache-load-misses,L1-dcache-stores,L1-dcache-store-misses -p 29734</p><h3 id="perf-probe"><a href="#perf-probe" class="headerlink" title="perf probe"></a>perf probe</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ perf probe -F <span class="comment"># list all probe point</span></span><br><span class="line">$ perf probe -V tcp_sendmsg</span><br><span class="line">Available variables at tcp_sendmsg</span><br><span class="line">        @&lt;tcp_sendmsg+0&gt;</span><br><span class="line">                int     size_goal</span><br><span class="line">                long int        timeo</span><br><span class="line">                size_t  size</span><br><span class="line">                struct kiocb*   iocb</span><br><span class="line">                struct msghdr*  msg</span><br><span class="line">                struct sock*    sk</span><br><span class="line"></span><br><span class="line">$ perf probe --add <span class="string">&#x27;tcp_sendmsg size&#x27;</span></span><br><span class="line">Added new event:</span><br><span class="line">  probe:tcp_sendmsg    (on tcp_sendmsg with size)</span><br><span class="line"></span><br><span class="line">You can now use it <span class="keyword">in</span> all perf tools, such as: </span><br><span class="line">$ perf record -e probe:tcp_sendmsg -aR sleep 10</span><br><span class="line"></span><br><span class="line">$ perf probe -V tcp_sendmsg</span><br><span class="line">Available variables at tcp_sendmsg</span><br><span class="line">        @&lt;tcp_sendmsg+0&gt;</span><br><span class="line">                int     size_goal</span><br><span class="line">                long int        timeo</span><br><span class="line">                size_t  size</span><br><span class="line">                struct kiocb*   iocb</span><br><span class="line">                struct msghdr*  msg</span><br><span class="line">                struct sock*    sk</span><br><span class="line"><span class="comment"># Show available variables for the kernel tcp_sendmsg() function (needs debuginfo):</span></span><br><span class="line"></span><br><span class="line">$  perf probe -V tcp_sendmsg:81</span><br><span class="line">Available variables at tcp_sendmsg:81</span><br><span class="line">        @&lt;tcp_sendmsg+826&gt;</span><br><span class="line">                bool    sg</span><br><span class="line">                int     copied</span><br><span class="line">                int     flags</span><br><span class="line">                int     iovlen</span><br><span class="line">                int     mss_now</span><br><span class="line">                int     offset</span><br><span class="line">                int     size_goal</span><br><span class="line">                long int        timeo</span><br><span class="line">                size_t  seglen</span><br><span class="line">                struct iovec*   iov</span><br><span class="line">                struct sock*    sk</span><br><span class="line">                unsigned char*  from</span><br><span class="line"></span><br><span class="line">$ perf record -e probe:tcp_sendmsg -a</span><br><span class="line">$ perf probe -d tcp_sendmsg</span><br><span class="line"></span><br><span class="line">$ perf probe <span class="string">&#x27;tcp_sendmsg %ax %dx %cx&#x27;</span></span><br><span class="line">$ perf record -e probe:tcp_sendmsg -aR sleep 10</span><br><span class="line">$ perf script</span><br><span class="line">            sshd 226370 [022] 15061.139400: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x15</span><br><span class="line">            sshd 226371 [023] 15061.140399: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa0032731fd78 arg3=0x500</span><br><span class="line">            sshd 226371 [012] 15061.190714: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa0032731fd78 arg3=0x16c</span><br><span class="line">            sshd 226371 [012] 15061.258446: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa0032731fd78 arg3=0x2c</span><br><span class="line">            sshd 226371 [012] 15061.260811: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa0032731fd78 arg3=0x34</span><br><span class="line">            sshd 226371 [012] 15061.263167: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa0032731fd78 arg3=0x14c</span><br><span class="line">            sshd 226371 [012] 15061.273640: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa0032731fd78 arg3=0x1c</span><br><span class="line">            sshd 226370 [022] 15061.277845: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x1f4</span><br><span class="line">            sshd 226370 [022] 15061.277885: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x2c</span><br><span class="line">            sshd 226370 [012] 15061.285352: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [012] 15061.285882: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x6c</span><br><span class="line">            sshd 226370 [012] 15061.289555: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x5c</span><br><span class="line">            sshd 226370 [012] 15061.464101: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x6c</span><br><span class="line">            sshd 226370 [012] 15061.590038: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [012] 15061.678381: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [012] 15061.876852: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [012] 15061.993911: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [014] 15062.199995: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [012] 15062.698951: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [012] 15062.956902: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x24</span><br><span class="line">            sshd 226370 [014] 15062.960704: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x1024</span><br><span class="line">            sshd 226370 [016] 15062.960805: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x1024</span><br><span class="line">            sshd 226370 [016] 15062.960835: probe:tcp_sendmsg: (ffffffffb6a95040) arg1=0xffffffffb6a95040 arg2=0xffffa003ac74fd78 arg3=0x12c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Trace code</span></span><br><span class="line">$ perf probe -L tcp_sendmsg</span><br><span class="line"></span><br><span class="line"><span class="comment"># Trace function</span></span><br><span class="line">$ perf probe -x /lib/libc-2.17.so -a malloc</span><br><span class="line">$ perf report</span><br><span class="line">$ perf probe -x /lib/libc-2.17.so -d malloc</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="http://www.brendangregg.com/perf.html">for more example</a></p><h3 id="perf-script"><a href="#perf-script" class="headerlink" title="perf script"></a>perf script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ perf record -e block:block_bio_complete -e block:block_bio_remap -ag sleep 20</span><br><span class="line">$ perf script</span><br></pre></td></tr></table></figure><h3 id="flamegraph"><a href="#flamegraph" class="headerlink" title="flamegraph"></a><a href="https://billtian.github.io/digoal.blog/2016/11/27/01.html">flamegraph</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ perf record -agv sleep 30</span><br><span class="line">$ mv perf.data FlameGraph/</span><br><span class="line">$ perf script | ./stackcollapse-perf.pl &gt; out.perf-folded</span><br><span class="line">$ cat out.perf-folded | ./flamegraph.pl &gt; perf-kernel.svg</span><br></pre></td></tr></table></figure><p>y-axis process stack, each layer is the function, the higher means the more system stack, top is the function, the parent function under the function.<br>x-axis the calls count, the larger width(plateaus) means more overhead</p><p>The single program exhaust all CPU resource<br><img src="/img/perf_flamegraph.png"></p><h3 id="perf-annotate"><a href="#perf-annotate" class="headerlink" title="perf annotate"></a>perf annotate</h3><p>This command reads the input file and displays an annotated version of the code. If the object file has debug symbols then the source code will be displayed alongside assembly code.<br>If there is no debug info in the object, then annotated assembly is displayed.</p><p>Since about the 3.9 kernel, perf_events has supported a workaround for missing frame pointers in user-level stacks: libunwind, which uses dwarf.<br>This can be enabled using -g dwarf.</p><p>-fno-omit-frame-pointer for software<br>CONFIG_FRAME_POINTER=y</p><h3 id="perf-bench"><a href="#perf-bench" class="headerlink" title="perf bench"></a>perf bench</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ perf bench numa all</span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0 -s 120 <span class="comment"># add number of seconds to run, here is 120s</span></span><br><span class="line"><span class="comment"># 1 x process, 10 x threads ( single numa ), -T means single thread mem overhead MB, -P means process mem overhead MB</span></span><br><span class="line"><span class="comment"># -C bind the first N tasks to these specific cpus (the rest is unbound)</span></span><br><span class="line"><span class="comment"># -M bind the first N tasks to these specific memory nodes (the rest is unbound)</span></span><br></pre></td></tr></table></figure><h4 id="Compare-local-and-remote-numa-node-overhead"><a href="#Compare-local-and-remote-numa-node-overhead" class="headerlink" title="Compare local and remote numa node overhead"></a>Compare local and remote numa node overhead</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">......</span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0 -s 120 <span class="comment"># running 120s</span></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          8.837 secs slowest (max) thread-runtime</span><br><span class="line">          8.000 secs fastest (min) thread-runtime</span><br><span class="line">          8.182 secs average thread-runtime</span><br><span class="line">          4.738 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.702 nsecs/byte/thread runtime</span><br><span class="line">          1.424 GB/sec/thread speed</span><br><span class="line">         14.239 GB/sec total speed</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0 -s 120 <span class="comment"># running 120s</span></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          5.528 secs slowest (max) thread-runtime</span><br><span class="line">          5.000 secs fastest (min) thread-runtime</span><br><span class="line">          5.084 secs average thread-runtime</span><br><span class="line">          4.776 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.439 nsecs/byte/thread runtime</span><br><span class="line">          2.276 GB/sec/thread speed</span><br><span class="line">         22.764 GB/sec total speed</span><br></pre></td></tr></table></figure><p><a href="https://github.com/brendangregg/perf-tools">perf tools</a><br><a href="https://billtian.github.io/digoal.blog/2016/11/27/01.html">reference</a></p><h4 id="perf-trace"><a href="#perf-trace" class="headerlink" title="perf trace"></a>perf trace</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">perf trace -p 1234</span><br><span class="line">perf trace -e <span class="built_in">read</span>*</span><br><span class="line">perf trace -D 500  <span class="comment"># wait 500ms before traing (skip all the stratup gumf)</span></span><br><span class="line">perf trace record</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
            <tag> trace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ftrace</title>
      <link href="2018/11/22/ftrace/"/>
      <url>2018/11/22/ftrace/</url>
      
        <content type="html"><![CDATA[<h3 id="Ftrace"><a href="#Ftrace" class="headerlink" title="Ftrace"></a><a href="https://zhuanlan.zhihu.com/p/22130013">Ftrace</a></h3><p><a href="https://www.kernel.org/doc/Documentation/trace/ftrace.txt">ftrace kernel docs</a><br><a href="https://www.kernel.org/doc/Documentation/trace/events.txt">events kernel docs</a></p><a id="more"></a><h4 id="Instances"><a href="#Instances" class="headerlink" title="Instances"></a>Instances</h4><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mount -t debugfs <span class="literal">none</span> /your-mount-point</span><br><span class="line">CentOS default enabled /sys/kernel/debug/tracing</span><br><span class="line"></span><br><span class="line">function_graph</span><br><span class="line">The function_graph tracer is designed <span class="built_in">to</span> present results <span class="keyword">in</span> <span class="keyword">a</span> more visually appealing <span class="built_in">format</span>. This tracer also traces <span class="keyword">the</span> exit <span class="keyword">of</span> <span class="keyword">the</span> <span class="function"><span class="keyword">function</span>, <span class="title">displaying</span> <span class="title">a</span> <span class="title">flow</span> <span class="title">of</span> <span class="title">function</span> <span class="title">calls</span> <span class="title">in</span> <span class="title">the</span> <span class="title">kernel</span>. <span class="title">Note</span> <span class="title">that</span> <span class="title">this</span> <span class="title">tracer</span> <span class="title">has</span> <span class="title">more</span> <span class="title">overhead</span> <span class="title">than</span> <span class="title">the</span> <span class="title">function</span> <span class="title">tracer</span> <span class="title">when</span> <span class="title">enabled</span>, <span class="title">but</span> <span class="title">the</span> <span class="title">same</span> <span class="title">low</span> <span class="title">overhead</span> <span class="title">when</span> <span class="title">disabled</span>.</span></span><br><span class="line">wakeup</span><br><span class="line">A full CPU tracer that reports <span class="keyword">the</span> activity happening across all CPUs. Records <span class="keyword">the</span> <span class="built_in">time</span> that <span class="keyword">it</span> takes <span class="built_in">to</span> wake up <span class="keyword">the</span> highest priority task <span class="keyword">in</span> <span class="keyword">the</span> <span class="keyword">system</span>, whether that task is <span class="keyword">a</span> real <span class="built_in">time</span> task <span class="keyword">or</span> <span class="keyword">not</span>. Recording <span class="keyword">the</span> <span class="built_in">max</span> <span class="built_in">time</span> <span class="keyword">it</span> takes <span class="built_in">to</span> wake up <span class="keyword">a</span> non real <span class="built_in">time</span> task will hide <span class="keyword">the</span> times <span class="keyword">it</span> takes <span class="built_in">to</span> wake up <span class="keyword">a</span> real <span class="built_in">time</span> task.</span><br><span class="line">wakeup_rt</span><br><span class="line">A full CPU tracer that reports <span class="keyword">the</span> activity happening across all CPUs. Records <span class="keyword">the</span> <span class="built_in">time</span> that <span class="keyword">it</span> takes <span class="built_in">from</span> <span class="keyword">the</span> current highests priority task <span class="built_in">to</span> wake up <span class="built_in">to</span> <span class="keyword">the</span> <span class="built_in">time</span> <span class="keyword">it</span> is scheduled. Only records <span class="keyword">the</span> <span class="built_in">time</span> <span class="keyword">for</span> real <span class="built_in">time</span> tasks.</span><br><span class="line">preemptirqsoff</span><br><span class="line">Traces <span class="keyword">the</span> areas that disable pre-emption <span class="keyword">or</span> interrupts, <span class="keyword">and</span> records <span class="keyword">the</span> maximum amount <span class="keyword">of</span> <span class="built_in">time</span> <span class="keyword">for</span> which pre-emption <span class="keyword">or</span> interrupts were disabled.</span><br><span class="line">preemptoff</span><br><span class="line">Similar <span class="built_in">to</span> <span class="keyword">the</span> preemptirqsoff tracer but traces only <span class="keyword">the</span> maximum interval <span class="keyword">for</span> which preemption was disabled.</span><br><span class="line">irqsoff</span><br><span class="line">Similar <span class="built_in">to</span> <span class="keyword">the</span> preemptirqsoff tracer but traces only <span class="keyword">the</span> maximum interval <span class="keyword">for</span> which interrupts were disabled.</span><br><span class="line">nop</span><br><span class="line">The default tracer. It does <span class="keyword">not</span> provide <span class="keyword">any</span> tracing facility itself, but <span class="keyword">as</span> events may interleave <span class="keyword">into</span> <span class="keyword">any</span> tracer, <span class="keyword">the</span> nop tracer is used <span class="keyword">for</span> specific interest <span class="keyword">in</span> tracing events.</span><br><span class="line"></span><br><span class="line">instances:</span><br><span class="line">This is <span class="keyword">a</span> way <span class="built_in">to</span> make multiple trace buffers where different events can be recorded <span class="keyword">in</span> different buffers. See <span class="string">&quot;Instances&quot;</span> section below.</span><br><span class="line"></span><br><span class="line">Disable <span class="function"><span class="keyword">function</span> <span class="title">and</span> <span class="title">function_graph</span> <span class="title">tracing</span></span></span><br><span class="line">default is enabled</span><br></pre></td></tr></table></figure><p>cat /sys/kernel/debug/tracing/options/function-trace<br>1</p><p>echo 0 &gt; /sys/kernel/debug/tracing/options/function-trace</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">echo</span> the <span class="keyword">number</span> of microseconds above which latencies must <span class="keyword">be</span></span><br><span class="line">recorded:</span><br></pre></td></tr></table></figure><p>echo 200 &gt; /sys/kernel/debug/tracing/tracing_thresh</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>/sys/kernel/debug/tracing is a instance, if you need more instance, you could mkdir /sys/kernel/debug/tracing/instances/foo<br>echo &gt; trace # clean buffer<br>echo $pid &gt; set_ftrace_pid</p><p>cat available_filter_functions<br>echo $(get from cat available_filter_functions) &gt; set_ftrace_filter<br>echo sched* &gt; set_ftrace_filter<br>echo <em>lock</em> &gt; set_ftrace_filter<br>echo spin_* &gt; set_ftrace_filter<br>echo <em>cpu</em> &gt; set_ftrace_filter<br>set_ftrace_notrace (opposite to that of set_ftrace_filter)</p><p>echo 1 &gt; tracing_on #enable trace<br>echo 0 &gt; tracing_on #disable</p><h1 id="tracer-function"><a href="#tracer-function" class="headerlink" title="tracer: function"></a>tracer: function</h1><p>#</p><h1 id="entries-in-buffer-entries-written-975-975-P-40"><a href="#entries-in-buffer-entries-written-975-975-P-40" class="headerlink" title="entries-in-buffer/entries-written: 975/975   #P:40"></a>entries-in-buffer/entries-written: 975/975   #P:40</h1><p>#</p><h1 id="-gt-irqs-off"><a href="#-gt-irqs-off" class="headerlink" title="_=&gt; irqs-off"></a>_=&gt; irqs-off</h1><h1 id="-gt-need-resched"><a href="#-gt-need-resched" class="headerlink" title="/ _-=&gt; need-resched"></a>/ _-=&gt; need-resched</h1><h1 id="-gt-hardirq-softirq"><a href="#-gt-hardirq-softirq" class="headerlink" title="| / _=&gt; hardirq/softirq"></a>| / _=&gt; hardirq/softirq</h1><h1 id="-gt-preempt-depth"><a href="#-gt-preempt-depth" class="headerlink" title="|| / _=&gt; preempt-depth"></a>|| / _=&gt; preempt-depth</h1><h1 id="delay"><a href="#delay" class="headerlink" title="||| /     delay"></a>||| /     delay</h1><h1 id="TASK-PID-CPU-TIMESTAMP-FUNCTION"><a href="#TASK-PID-CPU-TIMESTAMP-FUNCTION" class="headerlink" title="TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION"></a>TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</h1><h1 id=""><a href="#" class="headerlink" title="| |       |   ||||       |         |"></a>| |       |   ||||       |         |</h1><pre><code>    z_wr_iss-3045  [014] .... 188761.253438: schedule &lt;-taskq_thread    z_wr_iss-3045  [014] .... 188761.277938: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [008] .... 188761.278328: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [008] .... 188761.278333: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [008] .... 188761.278368: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [008] .... 188761.279231: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [012] d.h. 188761.279421: scheduler_tick &lt;-update_process_times    z_wr_iss-3045  [012] .... 188761.279662: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [008] .... 188761.279750: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [004] .... 188761.279785: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [004] .... 188761.279896: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [004] .... 188761.280008: schedule_preempt_disabled &lt;-__mutex_lock_slowpath    z_wr_iss-3045  [004] .... 188761.280020: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</code></pre><p>$ echo function_graph &gt; current_tracer<br>$ cat trace  | head -20</p><h1 id="tracer-function-graph"><a href="#tracer-function-graph" class="headerlink" title="tracer: function_graph"></a>tracer: function_graph</h1><p>#</p><h1 id="CPU-DURATION-FUNCTION-CALLS"><a href="#CPU-DURATION-FUNCTION-CALLS" class="headerlink" title="CPU  DURATION                  FUNCTION CALLS"></a>CPU  DURATION                  FUNCTION CALLS</h1><h1 id="-1"><a href="#-1" class="headerlink" title="|     |   |                     |   |   |   |"></a>|     |   |                     |   |   |   |</h1><ol start="2"><li>0.114 us    |                            finish_task_switch();</li><li><ul><li>31.319 us   |                          } /* __schedule */</li></ul></li><li><ul><li>32.114 us   |                        } /* schedule_preempt_disabled */</li></ul></li><li>0.108 us    |                        _raw_spin_lock();</li><li>|                        schedule_preempt_disabled() {</li><li>|                          __schedule() {</li><li>0.047 us    |                            rcu_note_context_switch();</li><li>0.050 us    |                            _raw_spin_lock_irq();</li><li>|                            deactivate_task() {</li><li>|                              dequeue_task() {</li><li>0.098 us    |                                update_rq_clock.part.81();</li><li>|                                dequeue_task_fair() {</li><li>|                                  dequeue_entity() {</li><li>|                                    update_curr() {</li><li>0.049 us    |                                      intel_pstate_update_util();</li><li>0.050 us    |                                      __calc_delta();</li></ol><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Events</span><br></pre></td></tr></table></figure><p>To enable all events, echo <em>:</em> or *: to the set_event file:<br>$ echo <em>:</em> &gt; /sys/kernel/debug/tracing/set_event</p><p>To enable event sched_wakeup:<br>$ echo 1 &gt; /sys/kernel/debug/tracing/events/sched/sched_wakeup/enable</p><p>To disable it:<br>$ echo 0 &gt; /sys/kernel/debug/tracing/events/sched/sched_wakeup/enable</p><p>To enable all events in sched subsystem:<br>$ echo 1 &gt; /sys/kernel/debug/tracing/events/sched/enable</p><p>To enable all events:<br>$ echo 1 &gt; /sys/kernel/debug/tracing/events/enable</p><p>When reading one of these enable files, there are four results:</p><p> 0 - all events this file affects are disabled<br> 1 - all events this file affects are enabled<br> X - there is a mixture of events enabled and disabled<br> ? - this file does not affect any event</p><p>echo 0 &gt; tracing_on<br>echo nop &gt; current_tracer</p><p>cat available_events<br>or<br>cd /sys/kernel/debug/tracing/events</p><p>cat set_ftrace_pid<br>no pid<br>echo &gt; trace<br>echo 99479 &gt; set_ftrace_pid<br>echo 1 &gt; tracing_on<br>echo sched:* &gt; set_event<br>echo irq:<em> &gt;&gt; set_event<br>echo lock:</em> &gt;&gt; set_event</p><h1 id="tracer-nop"><a href="#tracer-nop" class="headerlink" title="tracer: nop"></a>tracer: nop</h1><p>#</p><h1 id="entries-in-buffer-entries-written-4916-4916-P-40"><a href="#entries-in-buffer-entries-written-4916-4916-P-40" class="headerlink" title="entries-in-buffer/entries-written: 4916/4916   #P:40"></a>entries-in-buffer/entries-written: 4916/4916   #P:40</h1><p>#</p><h1 id="-gt-irqs-off-1"><a href="#-gt-irqs-off-1" class="headerlink" title="_=&gt; irqs-off"></a>_=&gt; irqs-off</h1><h1 id="-gt-need-resched-1"><a href="#-gt-need-resched-1" class="headerlink" title="/ _-=&gt; need-resched"></a>/ _-=&gt; need-resched</h1><h1 id="-gt-hardirq-softirq-1"><a href="#-gt-hardirq-softirq-1" class="headerlink" title="| / _=&gt; hardirq/softirq"></a>| / _=&gt; hardirq/softirq</h1><h1 id="-gt-preempt-depth-1"><a href="#-gt-preempt-depth-1" class="headerlink" title="|| / _=&gt; preempt-depth"></a>|| / _=&gt; preempt-depth</h1><h1 id="delay-1"><a href="#delay-1" class="headerlink" title="||| /     delay"></a>||| /     delay</h1><h1 id="TASK-PID-CPU-TIMESTAMP-FUNCTION-1"><a href="#TASK-PID-CPU-TIMESTAMP-FUNCTION-1" class="headerlink" title="TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION"></a>TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</h1><h1 id="-2"><a href="#-2" class="headerlink" title="| |       |   ||||       |         |"></a>| |       |   ||||       |         |</h1><pre><code>       &lt;...&gt;-99479 [010] d... 197736.430796: sched_stat_runtime: comm=bash pid=99479 runtime=152273 [ns] vruntime=833140516509 [ns]       &lt;...&gt;-99479 [010] dN.. 197736.430798: sched_wakeup: comm=kworker/10:0 pid=94482 prio=120 success=1 target_cpu=010       &lt;...&gt;-99479 [010] dN.. 197736.430798: sched_wakeup: comm=bash pid=99479 prio=120 success=1 target_cpu=010       &lt;...&gt;-99479 [010] d... 197736.430800: sched_switch: prev_comm=bash prev_pid=99479 prev_prio=120 prev_state=R ==&gt; next_comm=kworker/10:0 next_pid=94482 next_prio=120       &lt;...&gt;-94482 [010] d... 197736.430804: sched_wakeup: comm=sshd pid=99477 prio=120 success=1 target_cpu=032       &lt;...&gt;-94482 [010] d... 197736.430805: sched_stat_runtime: comm=kworker/10:0 pid=94482 runtime=9300 [ns] vruntime=833128525809 [ns]       &lt;...&gt;-94482 [010] d... 197736.430806: sched_switch: prev_comm=kworker/10:0 prev_pid=94482 prev_prio=120 prev_state=S ==&gt; next_comm=bash next_pid=99479 next_prio=120      &lt;idle&gt;-0     [032] d... 197736.430807: sched_switch: prev_comm=swapper/32 prev_pid=0 prev_prio=120 prev_state=R ==&gt; next_comm=sshd next_pid=99477 next_prio=120       &lt;...&gt;-99477 [032] d... 197736.430839: sched_stat_runtime: comm=sshd pid=99477 runtime=36358 [ns] vruntime=9311452689443 [ns]       &lt;...&gt;-99477 [032] d... 197736.430848: sched_switch: prev_comm=sshd prev_pid=99477 prev_prio=120 prev_state=S ==&gt; next_comm=swapper/32 next_pid=0 next_prio=120       &lt;...&gt;-99479 [010] d... 197736.431094: sched_stat_runtime: comm=bash pid=99479 runtime=288569 [ns] vruntime=833140805078 [ns]       &lt;...&gt;-99479 [010] dN.. 197736.431095: sched_wakeup: comm=kworker/10:0 pid=94482 prio=120 success=1 target_cpu=010       &lt;...&gt;-99479 [010] dN.. 197736.431095: sched_wakeup: comm=bash pid=99479 prio=120 success=1 target_cpu=010       &lt;...&gt;-99479 [010] d... 197736.431096: sched_switch: prev_comm=bash prev_pid=99479 prev_prio=120 prev_state=R ==&gt; next_comm=kworker/10:0 next_pid=94482 next_prio=120</code></pre><p>######## Get sched_switch filter options</p><p>cat /sys/kernel/debug/tracing/events/sched/sched_switch/format<br>name: sched_switch<br>ID: 324<br>format:<br>    field:unsigned short common_type;    offset:0;    size:2;    signed:0;<br>    field:unsigned char common_flags;    offset:2;    size:1;    signed:0;<br>    field:unsigned char common_preempt_count;    offset:3;    size:1;    signed:0;<br>    field:int common_pid;    offset:4;    size:4;    signed:1;</p><pre><code>field:char prev_comm[16];    offset:8;    size:16;    signed:1;field:pid_t prev_pid;    offset:24;    size:4;    signed:1;field:int prev_prio;    offset:28;    size:4;    signed:1;field:long prev_state;    offset:32;    size:8;    signed:1;field:char next_comm[16];    offset:40;    size:16;    signed:1;field:pid_t next_pid;    offset:56;    size:4;    signed:1;field:int next_prio;    offset:60;    size:4;    signed:1;</code></pre><p>print fmt: prev_comm=%s prev_pid=%d prev_prio=%d prev_state=%s%s ==&gt; next_comm=%s next_pid=%d next_prio=%d, REC-&gt;prev_comm, REC-&gt;prev_pid, REC-&gt;prev_prio, REC-&gt;prev_state &amp; (1024-1) ? __print_flags(REC-&gt;prev_state &amp; (1024-1), |, { 1, S} , { 2, D }, { 4, T }, { 8, t }, { 16, Z }, { 32, X }, { 64, x }, { 128, K }, { 256, W }, { 512, P }) : R, REC-&gt;prev_state &amp; 1024 ? + : , REC-&gt;next_comm, REC-&gt;next_pid, REC-&gt;next_prio</p><p>$echo next_comm ~ cs &gt; /sys/kernel/debug/tracing/events/sched/sched_switch/filter</p><p>$ cat trace | head -40</p><h1 id="tracer-nop-1"><a href="#tracer-nop-1" class="headerlink" title="tracer: nop"></a>tracer: nop</h1><p>#</p><h1 id="entries-in-buffer-entries-written-1017-1017-P-40"><a href="#entries-in-buffer-entries-written-1017-1017-P-40" class="headerlink" title="entries-in-buffer/entries-written: 1017/1017   #P:40"></a>entries-in-buffer/entries-written: 1017/1017   #P:40</h1><p>#</p><h1 id="-gt-irqs-off-2"><a href="#-gt-irqs-off-2" class="headerlink" title="_=&gt; irqs-off"></a>_=&gt; irqs-off</h1><h1 id="-gt-need-resched-2"><a href="#-gt-need-resched-2" class="headerlink" title="/ _-=&gt; need-resched"></a>/ _-=&gt; need-resched</h1><h1 id="-gt-hardirq-softirq-2"><a href="#-gt-hardirq-softirq-2" class="headerlink" title="| / _=&gt; hardirq/softirq"></a>| / _=&gt; hardirq/softirq</h1><h1 id="-gt-preempt-depth-2"><a href="#-gt-preempt-depth-2" class="headerlink" title="|| / _=&gt; preempt-depth"></a>|| / _=&gt; preempt-depth</h1><h1 id="delay-2"><a href="#delay-2" class="headerlink" title="||| /     delay"></a>||| /     delay</h1><h1 id="TASK-PID-CPU-TIMESTAMP-FUNCTION-2"><a href="#TASK-PID-CPU-TIMESTAMP-FUNCTION-2" class="headerlink" title="TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION"></a>TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</h1><h1 id="-3"><a href="#-3" class="headerlink" title="| |       |   ||||       |         |"></a>| |       |   ||||       |         |</h1><pre><code>       &lt;...&gt;-99479 [004] d... 198076.877184: sched_stat_runtime: comm=bash pid=99479 runtime=192500 [ns] vruntime=910963064502 [ns]       &lt;...&gt;-99479 [004] dN.. 198076.877185: sched_wakeup: comm=kworker/4:2 pid=437777 prio=120 success=1 target_cpu=004       &lt;...&gt;-99479 [004] dN.. 198076.877186: sched_wakeup: comm=bash pid=99479 prio=120 success=1 target_cpu=004       &lt;...&gt;-437777 [004] d... 198076.877192: sched_wakeup: comm=sshd pid=99477 prio=120 success=1 target_cpu=032       &lt;...&gt;-437777 [004] d... 198076.877193: sched_stat_runtime: comm=kworker/4:2 pid=437777 runtime=9871 [ns] vruntime=910951074373 [ns]       &lt;...&gt;-99477 [032] d... 198076.877225: sched_stat_runtime: comm=sshd pid=99477 runtime=34303 [ns] vruntime=9311457538136 [ns]       &lt;...&gt;-99479 [004] d.h. 198076.877272: sched_stat_runtime: comm=bash pid=99479 runtime=78293 [ns] vruntime=910963142795 [ns]       &lt;...&gt;-99479 [004] d.H. 198076.877281: sched_wakeup: comm=rcu_sched pid=10 prio=120 success=1 target_cpu=010   rcu_sched-10    [010] d... 198076.877287: sched_stat_runtime: comm=rcu_sched pid=10 runtime=7465 [ns] vruntime=833154240570 [ns]       &lt;...&gt;-99479 [004] d... 198076.877487: sched_stat_runtime: comm=bash pid=99479 runtime=215091 [ns] vruntime=910963357886 [ns]       &lt;...&gt;-99479 [004] dN.. 198076.877487: sched_wakeup: comm=kworker/4:2 pid=437777 prio=120 success=1 target_cpu=004       &lt;...&gt;-99479 [004] dN.. 198076.877488: sched_wakeup: comm=bash pid=99479 prio=120 success=1 target_cpu=004       &lt;...&gt;-437777 [004] d... 198076.877492: sched_wakeup: comm=sshd pid=99477 prio=120 success=1 target_cpu=032       &lt;...&gt;-437777 [004] d... 198076.877493: sched_stat_runtime: comm=kworker/4:2 pid=437777 runtime=6786 [ns] vruntime=910951364672 [ns]       &lt;...&gt;-99479 [004] d... 198076.877499: sched_stat_runtime: comm=bash pid=99479 runtime=5766 [ns] vruntime=910963363652 [ns]       &lt;...&gt;-99477 [032] d... 198076.877526: sched_stat_runtime: comm=sshd pid=99477 runtime=34484 [ns] vruntime=9311457572620 [ns]      &lt;idle&gt;-0     [010] dNs. 198076.881270: sched_wakeup: comm=rcu_sched pid=10 prio=120 success=1 target_cpu=010   rcu_sched-10    [010] d... 198076.881286: sched_stat_runtime: comm=rcu_sched pid=10 runtime=15885 [ns] vruntime=833154256455 [ns]      &lt;idle&gt;-0     [016] dNs. 198076.881495: sched_wakeup: comm=kworker/u896:0 pid=163541 prio=120 success=1 target_cpu=016       &lt;...&gt;-163541 [016] d... 198076.881501: sched_stat_runtime: comm=kworker/u896:0 pid=163541 runtime=5333 [ns] vruntime=847786361111 [ns]</code></pre><p>$ cd /sys/kernel/debug/tracing/events/signal/signal_generate<br>$ echo ((sig &gt;= 10 &amp;&amp; sig &lt; 15) || sig == 17) &amp;&amp; comm != bash &gt; filter</p><h1 id="clear-filters"><a href="#clear-filters" class="headerlink" title="clear filters"></a>clear filters</h1><p>$ echo 0 &gt; filter</p><p>$ cd /sys/kernel/debug/tracing/events/sched<br>$ echo prev_pid == 0 &gt; filter</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h3 id="stacktrace"><a href="#stacktrace" class="headerlink" title="stacktrace"></a>stacktrace</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ echo <span class="number">1</span> &gt; /proc/sys/kernel/stack_tracer_enabled</span><br><span class="line">$ cat stack_max_size</span><br><span class="line"><span class="number">4720</span></span><br><span class="line">$ cat stack_trace</span><br><span class="line">        Depth    Size   Location    (<span class="number">57</span> entries)</span><br><span class="line">        -----    ----   --------</span><br><span class="line">  <span class="number">0</span>)     <span class="number">4720</span>     <span class="number">320</span>   alloc_iova_fast+<span class="number">0xd8</span>/<span class="number">0x1e0</span></span><br><span class="line">  <span class="number">1</span>)     <span class="number">4400</span>      <span class="number">48</span>   <span class="built_in">int</span>el_alloc_iova+<span class="number">0xa5</span>/<span class="number">0xd0</span></span><br><span class="line">  <span class="number">2</span>)     <span class="number">4352</span>      <span class="number">80</span>   __intel_map_single+<span class="number">0x97</span>/<span class="number">0x1a0</span></span><br><span class="line">  <span class="number">3</span>)     <span class="number">4272</span>      <span class="number">16</span>   <span class="built_in">int</span>el_map_page+<span class="number">0x33</span>/<span class="number">0x40</span></span><br><span class="line">  <span class="number">4</span>)     <span class="number">4256</span>      <span class="number">16</span>   dma_map_page_attrs+<span class="number">0x36</span>/<span class="number">0x38</span> [i40e]</span><br><span class="line">  <span class="number">5</span>)     <span class="number">4240</span>     <span class="number">184</span>   i40e_lan_xmit_frame+<span class="number">0x115b</span>/<span class="number">0x13b0</span> [i40e]</span><br><span class="line">  <span class="number">6</span>)     <span class="number">4056</span>     <span class="number">120</span>   dev_hard_start_xmit+<span class="number">0x246</span>/<span class="number">0x3b0</span></span><br><span class="line">  <span class="number">7</span>)     <span class="number">3936</span>      <span class="number">80</span>   sch_direct_xmit+<span class="number">0x11a</span>/<span class="number">0x250</span></span><br><span class="line">  <span class="number">8</span>)     <span class="number">3856</span>     <span class="number">112</span>   __dev_queue_xmit+<span class="number">0x4a1</span>/<span class="number">0x660</span></span><br><span class="line">  <span class="number">9</span>)     <span class="number">3744</span>      <span class="number">16</span>   dev_queue_xmit+<span class="number">0x10</span>/<span class="number">0x20</span></span><br><span class="line"> <span class="number">10</span>)     <span class="number">3728</span>      <span class="number">32</span>   bond_dev_queue_xmit+<span class="number">0x32</span>/<span class="number">0x80</span> [bonding]</span><br><span class="line"> <span class="number">11</span>)     <span class="number">3696</span>      <span class="number">72</span>   bond_start_xmit+<span class="number">0x1be</span>/<span class="number">0x420</span> [bonding]</span><br><span class="line"> <span class="number">12</span>)     <span class="number">3624</span>     <span class="number">120</span>   dev_hard_start_xmit+<span class="number">0x246</span>/<span class="number">0x3b0</span></span><br><span class="line"> <span class="number">13</span>)     <span class="number">3504</span>     <span class="number">120</span>   __dev_queue_xmit+<span class="number">0x529</span>/<span class="number">0x660</span></span><br><span class="line"> <span class="number">14</span>)     <span class="number">3384</span>      <span class="number">16</span>   dev_queue_xmit+<span class="number">0x10</span>/<span class="number">0x20</span></span><br></pre></td></tr></table></figure><h3 id="trace-cmd"><a href="#trace-cmd" class="headerlink" title="trace-cmd"></a>trace-cmd</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> less /syskernel/debug/tracing/available_events</span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> record <span class="literal">-e</span> tcp:tcp_destroy_sock</span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> yum <span class="literal">-y</span> install <span class="built_in">trace-cmd</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> <span class="built_in">ls</span> <span class="literal">-l</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> record <span class="literal">-p</span> <span class="function"><span class="keyword">function</span> <span class="title">ls</span> -<span class="title">l</span></span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> record <span class="literal">-p</span> <span class="function"><span class="keyword">function</span> -<span class="title">l</span> &#x27;<span class="title">sched</span>*&#x27; <span class="title">myapp</span></span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> record <span class="literal">-e</span> sched_wakeup <span class="built_in">ls</span> /bin</span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> report </span><br><span class="line"></span><br><span class="line"><span class="comment">#enable all irq events</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> <span class="built_in">start</span> <span class="literal">-e</span> irq</span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> <span class="built_in">start</span> <span class="literal">-p</span> wakeup_rt</span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> <span class="built_in">start</span> <span class="literal">-p</span> preemptirqsoff <span class="literal">-d</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">trace-cmd</span> <span class="built_in">start</span> <span class="literal">-p</span> nop</span><br></pre></td></tr></table></figure><h3 id="disk-iohang"><a href="#disk-iohang" class="headerlink" title="disk iohang"></a><a href="http://www.sysnote.org/2017/03/15/error-disk-cause-iohang/">disk iohang</a></h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t debugfs debugfs <span class="regexp">/sys/</span>kernel/debug</span><br><span class="line"></span><br><span class="line">echo <span class="number">1</span> &gt; <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>scsi<span class="regexp">/scsi_dispatch_cmd_start/</span>enable</span><br><span class="line">echo <span class="number">1</span> &gt; <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>scsi<span class="regexp">/scsi_dispatch_cmd_timeout/</span>enable</span><br><span class="line"></span><br><span class="line"><span class="comment">## filter</span></span><br><span class="line">grep <span class="string">&quot;host_no=7 channel=0 id=0 lun=0&quot;</span> <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing/trace</span><br></pre></td></tr></table></figure><h3 id="trace-func"><a href="#trace-func" class="headerlink" title="trace func"></a>trace func</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
            <tag> trace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nfs info</title>
      <link href="2018/11/13/nfs/"/>
      <url>2018/11/13/nfs/</url>
      
        <content type="html"><![CDATA[<h3 id="NFS-timeout"><a href="#NFS-timeout" class="headerlink" title="NFS timeout"></a>NFS timeout</h3><p>timo=600 (60s)<br>retrs=2: only work with soft<br>hard: retry forever and not return error</p><h3 id="test-a-short-nfs-interrupt-from-network"><a href="#test-a-short-nfs-interrupt-from-network" class="headerlink" title="test a short nfs interrupt from network"></a>test a short nfs interrupt from network</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nfs client $ mount <span class="variable">$nfs_server</span>:/mountpoint /<span class="variable">$nfs_mount</span> -o timeo=60,retrans=2,soft</span><br><span class="line">nfs client $ dd <span class="keyword">if</span>=/dev/zero of=/<span class="variable">$nfs_mount</span>/write_file bs=1M </span><br><span class="line">nfs server $ iptables -A INPUT -s <span class="variable">$nfs_client_ip</span> -j DROP</span><br></pre></td></tr></table></figure><p>nfs client</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">nfs client $ ss -i </span><br><span class="line">tcp    ESTAB      0      1569744 nfs_client:732                  nfs_server:nfs</span><br><span class="line"> cubic wscale:7,7 rto:201 rtt:0.827/0.127 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1140 ssthresh:749 bytes_acked:3422225317 bytes_received:3575596188 segs_out:2375575 segs_in:90001 send 15968.3Mbps pacing_rate 31931.7Mbps unacked:1040 retrans:0/3 rcv_rtt:6.875 rcv_space:9177516</span><br><span class="line"></span><br><span class="line"><span class="comment">###### --------- firewall block -----------</span></span><br><span class="line"></span><br><span class="line">tcp    ESTAB      0      408    nfs_client:732                  nfs_server:nfs</span><br><span class="line"> cubic wscale:7,7 rto:406 backoff:1 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517451 segs_in:93659 send 5.0Mbps lastsnd:315 lastrcv:528 lastack:534 pacing_rate 11534.3Mbps unacked:1 retrans:1/5 lost:1 rcv_rtt:16 rcv_space:9177516</span><br><span class="line"></span><br><span class="line">backoff: 1,3,3,4,4,4,5,5,5,5,5,5,5, ....</span><br><span class="line">1 x 1</span><br><span class="line">2 x 3</span><br><span class="line">3 x 4</span><br><span class="line">7 x 5</span><br><span class="line">when backoff:8, I clear the firewall rule</span><br><span class="line">I don <span class="string">&#x27;t know why there is no any ss info in 2 seconds. could not the ip addra</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">These value has changed</span></span><br><span class="line"><span class="string">rtt:&lt;rtt&gt;/&lt;rttvar&gt;</span></span><br><span class="line"><span class="string">rtt is the average round trip time, rttvar is the mean deviation of rtt, their units are millisecond</span></span><br><span class="line"><span class="string">backoff:&lt;icsk_backoff&gt;</span></span><br><span class="line"><span class="string">used for exponential backoff re-transmission, the actual re-transmission timeout value is icsk_rto &lt;&lt; icsk_backoff</span></span><br><span class="line"><span class="string">rto:&lt;icsk_rto&gt;</span></span><br><span class="line"><span class="string">tcp re-transmission timeout value, the unit is millisecond</span></span><br><span class="line"><span class="string">cwnd:&lt;cwnd&gt;</span></span><br><span class="line"><span class="string">congestion window size</span></span><br><span class="line"><span class="string">ssthresh:&lt;ssthresh&gt;</span></span><br><span class="line"><span class="string">tcp congestion window slow start threshold</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">like this:</span></span><br><span class="line"><span class="string">33</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      4154312 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:12992 backoff:6 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517461 segs_in:93664 send 5.0Mbps lastsnd:10832 lastrcv:23667 lastack:23673 pacing_rate 11534.3Mbps unacked:1 retrans:1/10 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### here from ESTAB to FIN-WAIT-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">34</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:12992 backoff:6 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517461 segs_in:93664 send 5.0Mbps lastsnd:11837 lastrcv:24672 lastack:24678 pacing_rate 11534.3Mbps unacked:1 retrans:1/10 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">110</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:51968 backoff:8 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517465 segs_in:93666 send 5.0Mbps lastsnd:49203 lastrcv:101094 lastack:101100 pacing_rate 11534.3Mbps unacked:1 retrans:1/12 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">111</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:51968 backoff:8 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517465 segs_in:93666 send 5.0Mbps lastsnd:50208 lastrcv:102099 lastack:102105 pacing_rate 11534.3Mbps unacked:1 retrans:1/12 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">112</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:51968 backoff:8 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517465 segs_in:93666 send 5.0Mbps lastsnd:51214 lastrcv:103105 lastack:103111 pacing_rate 11534.3Mbps unacked:1 retrans:1/12 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">113</span></span><br><span class="line"><span class="string">## TCP socket closed, reconnect</span></span><br><span class="line"><span class="string">114</span></span><br><span class="line"><span class="string">115</span></span><br><span class="line"><span class="string">116</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:66 lastrcv:66 lastack:66 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string">117</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:1071 lastrcv:1071 lastack:1071 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string">118</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:2077 lastrcv:2077 lastack:2077 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string">119</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:3083 lastrcv:3083 lastack:3083 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## nfs info, add 10 rpc calls timeout in dmesg </span></span><br><span class="line"><span class="string">16</span></span><br><span class="line"><span class="string">Client rpc stats:</span></span><br><span class="line"><span class="string">calls      retrans    authrefrsh</span></span><br><span class="line"><span class="string">7170       0          7171</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">17</span></span><br><span class="line"><span class="string">Client rpc stats:</span></span><br><span class="line"><span class="string">calls      retrans    authrefrsh</span></span><br><span class="line"><span class="string">7180       0          7181</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:31 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7180 x18</span></span><br><span class="line"><span class="string">7190 x18</span></span><br><span class="line"><span class="string">7191 x30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">nfs client $ dd if=/dev/zero of=/$nfs_mount/write_file bs=1M</span></span><br><span class="line"><span class="string">dd: error writing t: Input/output error</span></span><br><span class="line"><span class="string">3513+0 records in</span></span><br><span class="line"><span class="string">3512+0 records out</span></span><br><span class="line"><span class="string">3682598912 bytes (3.7 GB) copied, 120.265 s, 30.6 MB/s</span></span><br></pre></td></tr></table></figure><h3 id="test-case2-just-ss-log"><a href="#test-case2-just-ss-log" class="headerlink" title="test case2 ,just ss log"></a>test case2 ,just ss log</h3><p>In the 10 second, the nfs server block the client<br>the client not modify sysctl.conf, before reboot, all parameters have been commentted.<br>default value was net.ipv4.tcp_syn_retries = 6 #in the default set, the TCP_RTO_MAX was 64s, if HZ equal 1s, the TCP_RTO_MAX equal 120s, that means you could not improve it to 128s</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tcp_syn_retries - INTEGER</span><br><span class="line">Number of times initial SYNs <span class="keyword">for</span> an active TCP<span class="built_in"> connection </span>attempt</span><br><span class="line">will be retransmitted. Should <span class="keyword">not</span> be higher than 127.<span class="built_in"> Default </span>value</span><br><span class="line">is 6, which corresponds <span class="keyword">to</span> 63seconds till the last retransmission</span><br><span class="line">with the current initial RTO of 1second. With this the final timeout</span><br><span class="line"><span class="keyword">for</span> an active TCP<span class="built_in"> connection </span>attempt will happen after 127 seconds.</span><br><span class="line"></span><br><span class="line"><span class="comment">#define TCP_RTO_MAX ((unsigned)(120*HZ))</span></span><br><span class="line"><span class="comment">#define TCP_RTO_MIN ((unsigned)(HZ/5))</span></span><br></pre></td></tr></table></figure><p>singel cp command has been copy the file in the nfs mount point</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">tcp    ESTAB      0      204    nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:202 rtt:1.164/0.065 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1882 ssthresh:1641 bytes_acked:6002294501 bytes_received:6019345332 segs_out:4166222 segs_in:152076 send 18729.5Mbps lastsnd:11 lastrcv:11 lastack:11 unacked:1 rcv_rtt:2 rcv_space:6157740</span><br><span class="line">9</span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:202 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1959 ssthresh:1641 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356084 segs_in:157556 send 17523.6Mbps lastsnd:157 lastrcv:162 lastack:167 unacked:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### nfs server block the client</span></span><br><span class="line"></span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:808 backoff:2 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356088 segs_in:157558 send 8.9Mbps lastsnd:554 lastrcv:1166 lastack:1171 unacked:1962 retrans:1/2 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">11</span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:1616 backoff:3 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356090 segs_in:157559 send 8.9Mbps lastsnd:750 lastrcv:2171 lastack:2176 unacked:1962 retrans:1/3 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">12</span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:3232 backoff:4 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356092 segs_in:157560 send 8.9Mbps lastsnd:134 lastrcv:3175 lastack:3180 unacked:1962 retrans:1/4 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">13</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### from 15 to 16, the ESTAB convert to FIN_WAIT-1</span></span><br><span class="line"></span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:3232 backoff:4 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356092 segs_in:157560 send 8.9Mbps lastsnd:2142 lastrcv:5183 lastack:5188 unacked:1962 retrans:1/4 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">15</span><br><span class="line">tcp    FIN-WAIT-1 0      3675873 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:3232 backoff:4 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356092 segs_in:157560 send 8.9Mbps lastsnd:3145 lastrcv:6186 lastack:6191 unacked:1962 retrans:1/4 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### From 216 to 217, the FIN-WAIT-1 convert to SYN-SENT, total 201 FIN-WAIT-1</span></span><br><span class="line"></span><br><span class="line">tcp    FIN-WAIT-1 0      3675873 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:103424 backoff:9 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356102 segs_in:157565 send 8.9Mbps lastsnd:103531 lastrcv:206948 lastack:206953 unacked:1962 retrans:1/9 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">216</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic rto:1000 mss:524 rcvmss:88 advmss:1460 cwnd:10 segs_out:1 lastsnd:1807447 lastrcv:1807447 lastack:1807447 unacked:1</span><br><span class="line">217</span><br><span class="line"></span><br><span class="line"><span class="comment"># rto will always changed in SYN-SENT</span></span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">just output 3s number, not output any ss -i connection info</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">after 3s ,try again</span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">after 6s, try again</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">after 12s, try again</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">tcp_syn_retries = 6 just work <span class="keyword">in</span> rto retry timer ,1s,2s,4s,8s,16s,32s,64s, modify it to 3, it work right now.</span><br><span class="line">the tcp SYN-SENT retry interval was 3s,6s,12s,24s ,after 24s , it <span class="string">&#x27;s will fix to 45s, each 45s the tcp SYN-SENT probe will be send</span></span><br><span class="line"><span class="string">I try to modify tcp_syn_retries, tcp_keepalive_intvl, tcp_retries1, tcp_retries2, tcp_synack_retries. it &#x27;</span>s not worked, always 45~46s, centos 7, 8 has the same result</span><br><span class="line"></span><br><span class="line"><span class="comment">#the same with tcpdump log, the last package time to next begin time about 49~50s, the last package rto was 4000ms, 49-4=45s</span></span><br><span class="line">02:39:28.383410 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2638733895, win 29200, options [mss 1460,sackOK,TS val 83069440 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:29.385376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2638733895, win 29200, options [mss 1460,sackOK,TS val 83070442 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:31.391375 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2638733895, win 29200, options [mss 1460,sackOK,TS val 83072448 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:39:38.407391 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2795358566, win 29200, options [mss 1460,sackOK,TS val 83079464 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:39.409376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2795358566, win 29200, options [mss 1460,sackOK,TS val 83080466 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:41.415375 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2795358566, win 29200, options [mss 1460,sackOK,TS val 83082472 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:39:51.439390 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2998983553, win 29200, options [mss 1460,sackOK,TS val 83092496 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:52.441377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2998983553, win 29200, options [mss 1460,sackOK,TS val 83093498 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:54.447374 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2998983553, win 29200, options [mss 1460,sackOK,TS val 83095504 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:40:10.495403 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3296733769, win 29200, options [mss 1460,sackOK,TS val 83111552 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:11.497378 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3296733769, win 29200, options [mss 1460,sackOK,TS val 83112554 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:13.503377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3296733769, win 29200, options [mss 1460,sackOK,TS val 83114560 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:40:41.599396 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3782733652, win 29200, options [mss 1460,sackOK,TS val 83142656 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:42.601376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3782733652, win 29200, options [mss 1460,sackOK,TS val 83143658 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:44.607377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3782733652, win 29200, options [mss 1460,sackOK,TS val 83145664 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:41:33.695391 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 301766284, win 29200, options [mss 1460,sackOK,TS val 83194752 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:41:34.697377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 301766284, win 29200, options [mss 1460,sackOK,TS val 83195754 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:41:36.703375 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 301766284, win 29200, options [mss 1460,sackOK,TS val 83197760 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:42:25.791393 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 1115766302, win 29200, options [mss 1460,sackOK,TS val 83246848 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:42:26.793376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 1115766302, win 29200, options [mss 1460,sackOK,TS val 83247850 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:42:28.799378 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 1115766302, win 29200, options [mss 1460,sackOK,TS val 83249856 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:43:17.887397 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 1929766369, win 29200, options [mss 1460,sackOK,TS val 83298944 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:43:18.889376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 1929766369, win 29200, options [mss 1460,sackOK,TS val 83299946 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:43:20.895377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 1929766369, win 29200, options [mss 1460,sackOK,TS val 83301952 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:44:09.983399 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2743766395, win 29200, options [mss 1460,sackOK,TS val 83351040 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:44:10.985377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2743766395, win 29200, options [mss 1460,sackOK,TS val 83352042 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:44:12.991383 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 2743766395, win 29200, options [mss 1460,sackOK,TS val 83354048 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:45:02.079401 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3557766342, win 29200, options [mss 1460,sackOK,TS val 83403136 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:03.081377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3557766342, win 29200, options [mss 1460,sackOK,TS val 83404138 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:05.087378 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 3557766342, win 29200, options [mss 1460,sackOK,TS val 83406144 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:45:54.175399 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 76799092, win 29200, options [mss 1460,sackOK,TS val 83455232 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:55.177379 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 76799092, win 29200, options [mss 1460,sackOK,TS val 83456234 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:57.183379 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], seq 76799092, win 29200, options [mss 1460,sackOK,TS val 83458240 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:1000 mss:524 rcvmss:88 advmss:1460 cwnd:10 segs_out:1 lastsnd:83559872 lastrcv:83559872 lastack:83559872 unacked:1</span><br><span class="line">716</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83560877 lastrcv:83560877 lastack:83560877 unacked:1 retrans:1/1 lost:1</span><br><span class="line">717</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83561882 lastrcv:83561882 lastack:83561882 unacked:1 retrans:1/1 lost:1</span><br><span class="line">718</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83562886 lastrcv:83562886 lastack:83562886 unacked:1 retrans:1/2 lost:1</span><br><span class="line">719</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83563892 lastrcv:83563892 lastack:83563892 unacked:1 retrans:1/2 lost:1</span><br><span class="line">720</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83564897 lastrcv:83564897 lastack:83564897 unacked:1 retrans:1/2 lost:1</span><br><span class="line">721</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83565902 lastrcv:83565902 lastack:83565902 unacked:1 retrans:1/2 lost:1</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------&gt;&gt; after 45s, begin to try again</span></span><br><span class="line"></span><br><span class="line">767</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:1000 mss:524 rcvmss:88 advmss:1460 cwnd:10 segs_out:1 lastsnd:83612024 lastrcv:83612024 lastack:83612024 unacked:1</span><br><span class="line">768</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83613029 lastrcv:83613029 lastack:83613029 unacked:1 retrans:1/1 lost:1</span><br><span class="line">769</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83614034 lastrcv:83614034 lastack:83614034 unacked:1 retrans:1/1 lost:1</span><br><span class="line">770</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83615039 lastrcv:83615039 lastack:83615039 unacked:1 retrans:1/2 lost:1</span><br><span class="line">771</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83616043 lastrcv:83616043 lastack:83616043 unacked:1 retrans:1/2 lost:1</span><br><span class="line">772</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83617049 lastrcv:83617049 lastack:83617049 unacked:1 retrans:1/2 lost:1</span><br><span class="line">773</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line"> cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83618054 lastrcv:83618054 lastack:83618054 unacked:1 retrans:1/2 lost:1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ext4 info</title>
      <link href="2018/11/13/ext4/"/>
      <url>2018/11/13/ext4/</url>
      
        <content type="html"><![CDATA[<h3 id="mkfs-ext4-for-stripe"><a href="#mkfs-ext4-for-stripe" class="headerlink" title="mkfs ext4 for stripe"></a>mkfs ext4 for stripe</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.ext4 -E stride=8,stripe-width=128,lazy_itable_init=0,lazy_journal_init=0 /dev/sdxx1</span><br></pre></td></tr></table></figure><p>Oh, shit , data loss, here is lustre ldiskfs</p><p>backup data<br>When backing up operating system partitions, the partition must be unmounted.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/mapper/3600a098000b5ea3e000006065be52460 of=3600a098000b5ea3e000006065be52460 bs=1M conv=sparse</span><br><span class="line">or you could </span><br><span class="line">$ dump -0uf /backup-files/sda3.dump /dev/sda3</span><br><span class="line">$ dump -0u -f - /dev/sda1 | ssh root@test-server dd of=/tmp/sda1.dump</span><br><span class="line"><span class="comment"># recovery </span></span><br><span class="line">$ mount -t ext3 /dev/sda3 /mnt/sda3</span><br><span class="line">$ <span class="built_in">cd</span> /mnt/sda3</span><br><span class="line">restore -rf /backup-files/sda3.dump</span><br></pre></td></tr></table></figure><a id="more"></a><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">debugfs</span> <span class="string">/dev/mapper/3600a098000b5ea3e000006065be52460</span></span><br><span class="line"><span class="string">debugfs</span> <span class="number">1.42</span><span class="number">.13</span><span class="string">.wc5</span> <span class="string">(15-Apr-2016)</span></span><br><span class="line"><span class="string">/dev/mapper/3600a098000b5ea3e000006065be52460:</span> <span class="string">Can&#x27;t</span> <span class="string">read</span> <span class="string">an</span> <span class="string">inode</span> <span class="string">bitmap</span> <span class="string">while</span> <span class="string">reading</span> <span class="string">inode</span> <span class="string">bitmap</span></span><br><span class="line"><span class="attr">debugfs:</span>  <span class="string">stats</span></span><br><span class="line"><span class="attr">stats:</span> <span class="string">Filesystem</span> <span class="string">not</span> <span class="string">open</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">dumpe2fs</span> <span class="string">/dev/mapper/3600a098000b5ea3e000006065be52460</span></span><br><span class="line"><span class="string">dumpe2fs</span> <span class="number">1.42</span><span class="number">.13</span><span class="string">.wc5</span> <span class="string">(15-Apr-2016)</span></span><br><span class="line"><span class="attr">Filesystem volume name:</span>   <span class="string">ldfsqd1-OST0004</span></span><br><span class="line"><span class="attr">Last mounted on:</span>          <span class="string">/</span></span><br><span class="line"><span class="attr">Filesystem UUID:</span>          <span class="string">8ffd7826-f9f5-4e92-99ef-75cca46c281a</span></span><br><span class="line"><span class="attr">Filesystem magic number:</span>  <span class="number">0xEF53</span></span><br><span class="line"><span class="string">Filesystem</span> <span class="string">revision</span> <span class="comment">#:    1 (dynamic)</span></span><br><span class="line"><span class="attr">Filesystem features:</span>      <span class="string">has_journal</span> <span class="string">ext_attr</span> <span class="string">dir_index</span> <span class="string">filetype</span> <span class="string">needs_recovery</span> <span class="string">extent</span> <span class="string">64bit</span> <span class="string">mmp</span> <span class="string">flex_bg</span> <span class="string">sparse_super</span> <span class="string">large_file</span> <span class="string">huge_file</span> <span class="string">uninit_bg</span> <span class="string">dir_nlink</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">Filesystem flags:</span>         <span class="string">signed_directory_hash</span></span><br><span class="line"><span class="attr">Default mount options:</span>    <span class="string">user_xattr</span> <span class="string">acl</span></span><br><span class="line"><span class="attr">Filesystem state:</span>         <span class="string">clean</span></span><br><span class="line"><span class="attr">Errors behavior:</span>          <span class="string">Continue</span></span><br><span class="line"><span class="attr">Filesystem OS type:</span>       <span class="string">Linux</span></span><br><span class="line"><span class="attr">Inode count:</span>              <span class="number">62914560</span></span><br><span class="line"><span class="attr">Block count:</span>              <span class="number">16106127360</span></span><br><span class="line"><span class="attr">Reserved block count:</span>     <span class="number">805306368</span></span><br><span class="line"><span class="attr">Free blocks:</span>              <span class="number">3782402091</span></span><br><span class="line"><span class="attr">Free inodes:</span>              <span class="number">60311208</span></span><br><span class="line"><span class="attr">First block:</span>              <span class="number">0</span></span><br><span class="line"><span class="attr">Block size:</span>               <span class="number">4096</span></span><br><span class="line"><span class="attr">Fragment size:</span>            <span class="number">4096</span></span><br><span class="line"><span class="attr">Group descriptor size:</span>    <span class="number">64</span></span><br><span class="line"><span class="attr">Blocks per group:</span>         <span class="number">32768</span></span><br><span class="line"><span class="attr">Fragments per group:</span>      <span class="number">32768</span></span><br><span class="line"><span class="attr">Inodes per group:</span>         <span class="number">128</span></span><br><span class="line"><span class="attr">Inode blocks per group:</span>   <span class="number">8</span></span><br><span class="line"><span class="attr">Flex block group size:</span>    <span class="number">256</span></span><br><span class="line"><span class="attr">Filesystem created:</span>       <span class="string">Tue</span> <span class="string">Oct</span> <span class="number">10</span> <span class="number">13</span><span class="string">:54:45</span> <span class="number">2017</span></span><br><span class="line"><span class="attr">Last mount time:</span>          <span class="string">Sat</span> <span class="string">Oct</span> <span class="number">20</span> <span class="number">16</span><span class="string">:15:57</span> <span class="number">2018</span></span><br><span class="line"><span class="attr">Last write time:</span>          <span class="string">Sat</span> <span class="string">Oct</span> <span class="number">20</span> <span class="number">16</span><span class="string">:15:57</span> <span class="number">2018</span></span><br><span class="line"><span class="attr">Mount count:</span>              <span class="number">8</span></span><br><span class="line"><span class="attr">Maximum mount count:</span>      <span class="number">-1</span></span><br><span class="line"><span class="attr">Last checked:</span>             <span class="string">Tue</span> <span class="string">Oct</span> <span class="number">10</span> <span class="number">13</span><span class="string">:54:45</span> <span class="number">2017</span></span><br><span class="line"><span class="attr">Check interval:</span>           <span class="number">0</span> <span class="string">(&lt;none&gt;)</span></span><br><span class="line"><span class="attr">Lifetime writes:</span>          <span class="number">5132 </span><span class="string">GB</span></span><br><span class="line"><span class="attr">Reserved blocks uid:</span>      <span class="number">0</span> <span class="string">(user</span> <span class="string">root)</span></span><br><span class="line"><span class="attr">Reserved blocks gid:</span>      <span class="number">0</span> <span class="string">(group</span> <span class="string">root)</span></span><br><span class="line"><span class="attr">First inode:</span>              <span class="number">11</span></span><br><span class="line"><span class="attr">Inode size:</span>          <span class="number">256</span></span><br><span class="line"><span class="attr">Required extra isize:</span>     <span class="number">28</span></span><br><span class="line"><span class="attr">Desired extra isize:</span>      <span class="number">28</span></span><br><span class="line"><span class="attr">Journal inode:</span>            <span class="number">8</span></span><br><span class="line"><span class="attr">Default directory hash:</span>   <span class="string">half_md4</span></span><br><span class="line"><span class="attr">Directory Hash Seed:</span>      <span class="string">7d46aee3-a481-456b-b9ff-6c7ab59a6e1c</span></span><br><span class="line"><span class="attr">Journal backup:</span>           <span class="string">inode</span> <span class="string">blocks</span></span><br><span class="line"><span class="attr">MMP block number:</span>         <span class="number">10246</span></span><br><span class="line"><span class="attr">MMP update interval:</span>      <span class="number">5</span></span><br><span class="line"><span class="attr">User quota inode:</span>         <span class="number">3</span></span><br><span class="line"><span class="attr">Group quota inode:</span>        <span class="number">4</span></span><br><span class="line"><span class="string">Journal</span> <span class="string">superblock</span> <span class="string">magic</span> <span class="string">number</span> <span class="string">invalid!</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">$</span> <span class="string">grep</span>  <span class="string">--binary-files=text</span> <span class="number">0000430</span> <span class="string">3600a09800099437b000008f05be52536</span></span><br><span class="line"><span class="attr">0000430:</span> <span class="string">9aba</span> <span class="string">e45b</span> <span class="string">0c00</span> <span class="string">ffff</span> <span class="string">53ef</span> <span class="number">0100 </span><span class="number">0100 </span><span class="number">0000</span>  <span class="string">...[....S.......</span></span><br><span class="line"><span class="string">The</span> <span class="string">magic</span> <span class="string">number</span> <span class="string">is</span> <span class="string">little-endian</span> <span class="number">0xef53</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">dumpe2fs</span> <span class="string">/dev/mapper/3600a098000b5ea3e000006055be52442</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">superblock</span> <span class="string">-i</span></span><br><span class="line"><span class="string">dumpe2fs</span> <span class="number">1.42</span><span class="number">.13</span><span class="string">.wc5</span> <span class="string">(15-Apr-2016)</span></span><br><span class="line">  <span class="string">Primary</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">0</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">1</span><span class="number">-7680</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">32768</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">32769</span><span class="number">-40448</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">98304</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">98305</span><span class="number">-105984</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">163840</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">163841</span><span class="number">-171520</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">229376</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">229377</span><span class="number">-237056</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">294912</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">294913</span><span class="number">-302592</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">819200</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">819201</span><span class="number">-826880</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">884736</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">884737</span><span class="number">-892416</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">1605632</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">1605633</span><span class="number">-1613312</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">2654208</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">2654209</span><span class="number">-2661888</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">4096000</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">4096001</span><span class="number">-4103680</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">7962624</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">7962625</span><span class="number">-7970304</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">11239424</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">11239425</span><span class="number">-11247104</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">20480000</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">20480001</span><span class="number">-20487680</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">23887872</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">23887873</span><span class="number">-23895552</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">71663616</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">71663617</span><span class="number">-71671296</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">78675968</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">78675969</span><span class="number">-78683648</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">102400000</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">102400001</span><span class="number">-102407680</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">214990848</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">214990849</span><span class="number">-214998528</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">512000000</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">512000001</span><span class="number">-512007680</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">550731776</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">550731777</span><span class="number">-550739456</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">644972544</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">644972545</span><span class="number">-644980224</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">1934917632</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">1934917633</span><span class="number">-1934925312</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">2560000000</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">2560000001</span><span class="number">-2560007680</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">3855122432</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">3855122433</span><span class="number">-3855130112</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">5804752896</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">5804752897</span><span class="number">-5804760576</span></span><br><span class="line">  <span class="string">Backup</span> <span class="string">superblock</span> <span class="string">at</span> <span class="number">12800000000</span><span class="string">,</span> <span class="string">Group</span> <span class="string">descriptors</span> <span class="string">at</span> <span class="number">12800000001</span><span class="number">-12800007680</span></span><br></pre></td></tr></table></figure><p>Why some parition all superblock were missing ?</p><h3 id="For-huge-parttion-there-is-no-enough-memory-it-will-cause-slow"><a href="#For-huge-parttion-there-is-no-enough-memory-it-will-cause-slow" class="headerlink" title="For huge parttion, there is no enough memory, it will cause slow"></a>For huge parttion, there is no enough memory, it will cause slow</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/etc/</span>e2fsck.conf</span><br><span class="line">[scratch_files]</span><br><span class="line">directory = <span class="regexp">/var/</span>cache/e2fsck</span><br></pre></td></tr></table></figure><h3 id="guess-partion-start"><a href="#guess-partion-start" class="headerlink" title="guess partion start"></a><a href="https://unix.stackexchange.com/questions/103919/how-do-i-find-the-offset-of-an-ext4-filesystem">guess partion start</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bsz=512 <span class="comment"># or 1024, 2048, 4096 higher = faster</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;2..10000000&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;---&gt;<span class="variable">$i</span>&lt;---&quot;</span></span><br><span class="line">    mount -o offset=$((<span class="variable">$bsz</span>*<span class="variable">$i</span>)) -t ext4 /dev/whatever /mnt/foo</span><br><span class="line">    <span class="keyword">if</span> [ $? == 0 ]; <span class="keyword">then</span> <span class="comment"># whahoo!</span></span><br><span class="line">        <span class="built_in">echo</span> Eureka</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="Found-ext-magic-number"><a href="#Found-ext-magic-number" class="headerlink" title="Found ext magic number"></a>Found ext magic number</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0000400: 0000 c003 0000 00c0 0000 0030 60c4 98a4  ...........0`...</span><br><span class="line">0000410: e243 9703 0000 0000 0200 0000 0200 0000  .C..............</span><br><span class="line">0000420: 0080 0000 0080 0000 8000 0000 9aba e45b  ...............[</span><br><span class="line">0000430: 9aba e45b 0c00 ffff 53ef 0100 0100 0000  ...[....S.......</span><br><span class="line">0000440: 8760 dc59 0000 0000 0000 0000 0100 0000  .`.Y............</span><br><span class="line">0000450: 0000 0000 0b00 0000 0001 0000 2c00 0000  ............,...</span><br><span class="line">0000460: c603 0000 3b01 0000 1c09 a61a 05f9 42cb  ....;.........B.</span><br><span class="line">0000470: a3a9 e929 ee10 20be 6c64 6673 7164 312d  ...).. .ldfsqd1-</span><br><span class="line">0000480: 4f53 5430 3030 3000 2f00 6d70 2f6d 6e74  OST0000./.mp/mnt</span><br><span class="line">0000490: 584e 4435 3733 0000 0000 0000 0000 0000  XND573..........</span><br><span class="line">00004a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00004b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00004c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br></pre></td></tr></table></figure><h3 id="because-there-is-no-any-parttion-in-this-block-dev"><a href="#because-there-is-no-any-parttion-in-this-block-dev" class="headerlink" title="because there is no any parttion in this block dev"></a>because there is no any parttion in this block dev</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ parted /dev/mapper/3600a098000b5ea3e000006065be52460 p</span><br><span class="line">Model: Linux device-mapper (multipath) (dm)</span><br><span class="line">Disk /dev/mapper/3600a098000b5ea3e000006065be52460: 66.0TB</span><br><span class="line">Sector size (logical/physical): 512B/4096B</span><br><span class="line">Partition Table: loop <span class="comment">#######that means there is no parttion </span></span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start  End     Size    File system  Flags</span><br><span class="line"> 1      0.00B  66.0TB  66.0TB  ext4</span><br></pre></td></tr></table></figure><h3 id="You-cant-fsck-by-default"><a href="#You-cant-fsck-by-default" class="headerlink" title="You cant fsck by default"></a>You cant fsck by default</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ e2fsck -n -b <span class="number">32768</span> /dev/mapper/<span class="number">3600</span>a098000b5ea3e000006065be52460</span><br><span class="line">e2fsck <span class="number">1.42</span><span class="number">.13</span>.wc5 (<span class="number">15</span>-Apr<span class="number">-2016</span>)</span><br><span class="line">MMP <span class="built_in">int</span>erval <span class="keyword">is</span> <span class="number">10</span> seconds <span class="keyword">and</span> total wait time <span class="keyword">is</span> <span class="number">42</span> seconds. Please wait...</span><br><span class="line">Superblock has an invalid journal (inode <span class="number">8</span>).</span><br><span class="line">Clear? no</span><br><span class="line"></span><br><span class="line">e2fsck: Illegal inode number <span class="keyword">while</span> checking ext3 journal <span class="keyword">for</span> ldfsqd1-OST0004</span><br><span class="line"></span><br><span class="line">ldfsqd1-OST0004: ********** WARNING: Filesystem still has errors **********</span><br><span class="line"></span><br><span class="line">$ e2fsck -n -b <span class="number">819200</span> /dev/mapper/<span class="number">3600</span>a098000b5ea3e000006065be52460</span><br><span class="line">e2fsck <span class="number">1.42</span><span class="number">.13</span>.wc5 (<span class="number">15</span>-Apr<span class="number">-2016</span>)</span><br><span class="line">MMP <span class="built_in">int</span>erval <span class="keyword">is</span> <span class="number">10</span> seconds <span class="keyword">and</span> total wait time <span class="keyword">is</span> <span class="number">42</span> seconds. Please wait...</span><br><span class="line">Superblock has an invalid journal (inode <span class="number">8</span>).</span><br><span class="line">Clear? no</span><br><span class="line"></span><br><span class="line">e2fsck: Illegal inode number <span class="keyword">while</span> checking ext3 journal <span class="keyword">for</span> ldfsqd1-OST0004</span><br><span class="line"></span><br><span class="line">ldfsqd1-OST0004: ********** WARNING: Filesystem still has errors **********</span><br></pre></td></tr></table></figure><h3 id="Found-some-info-form-superblock"><a href="#Found-some-info-form-superblock" class="headerlink" title="Found some info form superblock"></a>Found some info form superblock</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-n     Causes mke2fs to not actually create a filesystem, but display what it would <span class="keyword">do</span> <span class="keyword">if</span> it were to create  a  filesystem.   </span><br><span class="line">       This can  be used to determine the location of the backup superblocks <span class="keyword">for</span> a particular filesystem, </span><br><span class="line">       so long as the mke2fs parameters that were passed when the filesystem was originally created are used again.  </span><br><span class="line">       (With the -n option added, of course!)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Maybe you could rewrite the superblock</span></span><br><span class="line">mke2fs -S</span><br><span class="line">    -S    Write  superblock and group descriptors only.  This is useful <span class="keyword">if</span> all</span><br><span class="line">          of the superblock and backup superblocks are corrupted, and a  last-</span><br><span class="line">          ditch  recovery method is desired.  It causes mke2fs to reinitialize</span><br><span class="line">          the superblock and group descriptors, <span class="keyword">while</span> not touching  the  inode</span><br><span class="line">          table and the block and inode bitmaps.  The e2fsck program should be</span><br><span class="line">          run immediately after this option is used, and there is no guarantee</span><br><span class="line">          that  any  data  will be salvageable.  It is critical to specify the</span><br><span class="line">          correct filesystem blocksize when using this option, or there is  no</span><br><span class="line">          chance of recovery.</span><br></pre></td></tr></table></figure><h3 id="You-have-to-disable-ext-journal-make-it-like-ext2-all-blocks-full-scan"><a href="#You-have-to-disable-ext-journal-make-it-like-ext2-all-blocks-full-scan" class="headerlink" title="You have to disable ext journal, make it like ext2, all blocks full scan"></a>You have to disable ext journal, make it like ext2, all blocks full scan</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tune2fs -O ^has_journal,needs_rwcovery -f /dev/mapper/3600a098000b5ea3e000006065be52460</span><br><span class="line"><span class="comment">### you can fsck again, but it &#x27;s too slow..............maybe 60TB will wait 10 years</span></span><br><span class="line"></span><br><span class="line">$ e2fsck -y /dev/mapper/3600a098000b5ea3e000006065be52460</span><br><span class="line"><span class="comment">### it &#x27;s worked</span></span><br></pre></td></tr></table></figure><h3 id="Looks-like-the-block-dev-has-be-destroy-by-hardware-raid-controller-all-data-has-messed"><a href="#Looks-like-the-block-dev-has-be-destroy-by-hardware-raid-controller-all-data-has-messed" class="headerlink" title="Looks like the block dev has be destroy by hardware raid controller, all data has messed"></a>Looks like the block dev has be destroy by hardware raid controller, all data has messed</h3><p>In 60TiB raw dev, Lustre first 10MB is ext meta data and data map, it will not show any file part<br>But I found the horrible things, reserve space has been overrided as 128KiB, 128KiB is the raid controller segment size.<br>I don t think we can recovery all data. when fsck finish, I m not sure the data is it integrity. maybe some block has corruptted in single file</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">00fffa0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00fffb0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00fffc0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00fffd0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00fffe0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">00ffff0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">0100000: dcfa 60ef 039f c372 0793 3a8d 4c6a 642d  ..`....r..:.Ljd-</span><br><span class="line">0100010: 50c7 fddf b3f5 fbed f03f 71b5 ccb3 811c  P........?q.....</span><br><span class="line">0100020: 1495 a0c2 ab24 be48 ac46 1109 a19e aadc  .....$.H.F......</span><br><span class="line">0100030: 16d9 0488 2e26 d238 fe48 e492 27c5 dd02  .....&amp;.8.H..<span class="string">&#x27;...</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line"><span class="string">011ffd0: baf1 35e8 54e1 e97c dab5 e762 e74c 83cc  ..5.T..|...b.L..</span></span><br><span class="line"><span class="string">011ffe0: 7d02 7db3 53f2 613d 6ef4 775b a0e2 767f  &#125;.&#125;.S.a=n.w[..v.</span></span><br><span class="line"><span class="string">011fff0: ff8b 65fe 9c39 1018 3b76 586e 3893 2095  ..e..9..;vXn8. .</span></span><br><span class="line"><span class="string">0120000: c000 8023 c001 8023 0008 8023 0000 0100  ...#...#...#....</span></span><br><span class="line"><span class="string">0120010: 0000 0400 0000 0000 0000 0000 0000 3896  ..............8.</span></span><br><span class="line"><span class="string">0120020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">##### After 128KiB</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">##### Another parttion</span></span><br><span class="line"><span class="string">01bffe0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span><br><span class="line"><span class="string">01bfff0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span><br><span class="line"><span class="string">01c0000: 9fac ef20 dd9d fd1c 18ed a503 a19e 5f7a  ... .........._z</span></span><br><span class="line"><span class="string">01c0010: ea7d b6c7 850d 7a52 a0a9 61a6 a912 f489  .&#125;....zR..a.....</span></span><br><span class="line"><span class="string">01c0020: da1f 4941 4fe4 f612 1b25 ff91 9b61 928a  ..IAO....%...a..</span></span><br><span class="line"><span class="string">01c0030: 405d 5026 e2a7 a59e d08a d376 8c57 0d1f  @]P&amp;.......v.W..</span></span><br><span class="line"><span class="string">....</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">01fff90: 5080 aaaa 0ef0 3c5c 0020 0d5c 6408 2400  P.....&lt;\. .\d.$.</span></span><br><span class="line"><span class="string">01fffa0: ef15 08e8 7d00 2399 d60f 1b1e 0000 0000  ....&#125;.#.........</span></span><br><span class="line"><span class="string">01fffb0: 966c 6516 0000 0000 ff37 fb12 0000 0000  .le......7......</span></span><br><span class="line"><span class="string">01fffc0: 954a c013 0000 0000 ea47 c570 2708 0000  .J.......G.p&#x27;</span>...</span><br><span class="line">01fffd0: 45a6 5fd7 6c03 8ca1 be55 4c44 2a6a 1500  E._.l....ULD*j..</span><br><span class="line">01fffe0: aa06 3ba9 aaba e2a6 fc0f 1b1e 0000 0000  ..;.............</span><br><span class="line">01ffff0: b46c 6516 0000 0000 2838 fb12 0000 0000  .le.....(8......</span><br><span class="line">0200000: 6c65 0975 6e6b 6e6f 776e 0930 0930 0969  le.unknown.0.0.i</span><br><span class="line">0200010: 6e74 726f 6e09 6578 6163 7409 3109 0931  ntron.exact.1..1</span><br><span class="line">0200020: 3709 3130 3030 4745 4e4f 4d45 532c 4142  7.1000GENOMES,AB</span><br><span class="line">0200030: 492c 4146 4659 2c42 4749 2c43 4f4d 504c  I,AFFY,BGI,COMPL</span><br><span class="line">0200040: 4554 455f 4745 4e4f 4d49 4353 2c43 5348  ETE_GENOMICS,CSH</span><br><span class="line">0200050: 4c2d 4841 504d 4150 2c45 4e53 454d 424c  L-HAPMAP,ENSEMBL</span><br><span class="line">0200060: 2c45 5641 2d47 4f4e 4c2c 474d 492c 4855  ,EVA-GONL,GMI,HU</span><br><span class="line">0200070: 4d41 4e47 454e 4f4d 455f 4a43 5649 2c4a  MANGENOME_JCVI,J</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">021ffb0: 454e 4f4d 4553 2c09 3209 2d2c 4154 4141  ENOMES,.2.-,ATAA</span><br><span class="line">021ffc0: 542c 0933 2e30 3030 3030 302c 3530 3035  T,.3.000000,5005</span><br><span class="line">021ffd0: 2e30 3030 3030 302c 0930 2e30 3030 3539  .000000,.0.00059</span><br><span class="line">021ffe0: 392c 302e 3939 3934 3031 2c09 0a37 3032  9,0.999401,..702</span><br><span class="line">021fff0: 0963 6872 3130 0931 3533 3338 3336 3909  .chr10.15338369.</span><br><span class="line">0220000: c000 8043 c001 8043 0008 8043 0000 8000  ...C...C...C....</span><br><span class="line">0220010: 0000 0500 0000 0000 0000 0000 8000 e4f0  ................</span><br><span class="line">0220020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">0220030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">0220040: c100 8043 c101 8043 0808 8043 0000 8000  ...C...C...C....</span><br><span class="line">0220050: 0000 0500 0000 0000 0000 0000 8000 9be0  ................</span><br><span class="line">0220060: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">0220070: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">0220080: c200 8043 c201 8043 1008 8043 0000 8000  ...C...C...C....</span><br><span class="line">0220090: 0000 0500 0000 0000 0000 0000 8000 1ad0  ................</span><br><span class="line">02200a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">02200b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">02200c0: c300 8043 c301 8043 1808 8043 0000 8000  ...C...C...C....</span><br><span class="line"></span><br><span class="line"><span class="comment">## Why there is file part as 128KiB size override file system reserve space ????</span></span><br><span class="line"><span class="comment">## Here is file system log , looks like no problem</span></span><br></pre></td></tr></table></figure><h3 id="debugfs"><a href="#debugfs" class="headerlink" title="debugfs"></a>debugfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/dev/shm/<span class="built_in">test</span> bs=1M count=512</span><br><span class="line">$ mfks.ext3 -b 4096 /dev/shm/<span class="built_in">test</span></span><br><span class="line">$ mount /dev/shm/<span class="built_in">test</span> /mnt</span><br><span class="line"></span><br><span class="line">$ rm -f <span class="built_in">test</span>;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..10000&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>-<span class="variable">$i</span>-<span class="variable">$i</span> &gt;&gt; <span class="built_in">test</span>; <span class="keyword">done</span> </span><br><span class="line">$ filefrag -v <span class="built_in">test</span> </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">Filesystem cylinder groups approximately 4</span><br><span class="line">File size of <span class="built_in">test</span> is 146688 (36 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..      15:       2576..      2591:     16:             merged</span><br><span class="line">   1:       16..      16:      33424..     33424:      1:       2592: merged</span><br><span class="line">   2:       17..      17:      33457..     33457:      1:      33425: merged</span><br><span class="line">   3:       18..      18:      33490..     33490:      1:      33458: merged</span><br><span class="line">   4:       19..      19:      33523..     33523:      1:      33491: merged</span><br><span class="line">   5:       20..      20:      33556..     33556:      1:      33524: merged</span><br><span class="line">   6:       21..      21:      33589..     33589:      1:      33557: merged</span><br><span class="line">   7:       22..      22:      33622..     33622:      1:      33590: merged</span><br><span class="line">   8:       23..      23:      33655..     33655:      1:      33623: merged</span><br><span class="line">   9:       24..      24:      33688..     33688:      1:      33656: merged</span><br><span class="line">  10:       25..      25:      33721..     33721:      1:      33689: merged</span><br><span class="line">  11:       26..      26:      33754..     33754:      1:      33722: merged</span><br><span class="line">  12:       27..      27:      33787..     33787:      1:      33755: merged</span><br><span class="line">  13:       28..      28:      33820..     33820:      1:      33788: merged</span><br><span class="line">  14:       29..      29:      33853..     33853:      1:      33821: merged</span><br><span class="line">  15:       30..      30:      33886..     33886:      1:      33854: merged</span><br><span class="line">  16:       31..      31:      33919..     33919:      1:      33887: merged</span><br><span class="line">  17:       32..      32:      33952..     33952:      1:      33920: merged</span><br><span class="line">  18:       33..      33:      34017..     34017:      1:      33953: merged</span><br><span class="line">  19:       34..      34:      34082..     34082:      1:      34018: merged</span><br><span class="line">  20:       35..      35:      34147..     34147:      1:      34083: last,merged,eof</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">$ debugfs /dev/shm/<span class="built_in">test</span> </span><br><span class="line">debugfs 1.42.13 (17-May-2015)</span><br><span class="line">debugfs: <span class="built_in">stat</span> &lt;14&gt; </span><br><span class="line"></span><br><span class="line">Inode: 14   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 3749441442    Version: 0x00000000:00000001</span><br><span class="line">User:     0   Group:     0   Size: 146688</span><br><span class="line">File ACL: 0    Directory ACL: 0</span><br><span class="line">Links: 1   Blockcount: 296</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line"> ctime: 0x58763a68:1f1d1ee4 -- Wed Jan 11 22:00:08 2017</span><br><span class="line"> atime: 0x58763a67:e66e9d44 -- Wed Jan 11 22:00:07 2017</span><br><span class="line"> mtime: 0x58763a68:1f1d1ee4 -- Wed Jan 11 22:00:08 2017</span><br><span class="line">crtime: 0x58763a67:e66e9d44 -- Wed Jan 11 22:00:07 2017</span><br><span class="line">Size of extra inode fields: 32</span><br><span class="line">BLOCKS:</span><br><span class="line">(0-11):2576-2587, (IND):1538, (12-15):2588-2591, (16):33424, (17):33457, (18):33490, (19):33523, (20):33556, (21):33589, (22):33622, (23):33655, (24):33688, (25):33721, (26):33754, (27):33787, (28):33820, (29):33853, (30):33886, (31):33919, (32):33952, (33):34017, (34):34082, (35):34147</span><br><span class="line">TOTAL: 37</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/shm/<span class="built_in">test</span> of=test-1 bs=4K skip=2576 count=$((<span class="number">2591</span>-<span class="number">2576</span>+<span class="number">1</span>))</span><br><span class="line">$ head test-1 ; wc -l test-1 ;tail test-1</span><br><span class="line">0-0-0</span><br><span class="line">1-1-1</span><br><span class="line">2-2-2</span><br><span class="line">3-3-3</span><br><span class="line">4-4-4</span><br><span class="line">5-5-5</span><br><span class="line">6-6-6</span><br><span class="line">7-7-7</span><br><span class="line">8-8-8</span><br><span class="line">9-9-9</span><br><span class="line">4591 test-1</span><br><span class="line">4582-4582-4582</span><br><span class="line">4583-4583-4583</span><br><span class="line">4584-4584-4584</span><br><span class="line">4585-4585-4585</span><br><span class="line">4586-4586-4586</span><br><span class="line">4587-4587-4587</span><br><span class="line">4588-4588-4588</span><br><span class="line">4589-4589-4589</span><br><span class="line">4590-4590-4590</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/shm/<span class="built_in">test</span> of=test-2 bs=4K skip=33424 count=1</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000193943 s, 21.1 MB/s</span><br><span class="line">$ head test-2 ; wc -l test-2 ;tail test-2</span><br><span class="line">591-4591-4591</span><br><span class="line">4592-4592-4592</span><br><span class="line">4593-4593-4593</span><br><span class="line">4594-4594-4594</span><br><span class="line">4595-4595-4595</span><br><span class="line">4596-4596-4596</span><br><span class="line">4597-4597-4597</span><br><span class="line">4598-4598-4598</span><br><span class="line">4599-4599-4599</span><br><span class="line">4600-4600-4600</span><br><span class="line">273 test-2</span><br><span class="line">4855-4855-4855</span><br><span class="line">4856-4856-4856</span><br><span class="line">4857-4857-4857</span><br><span class="line">4858-4858-4858</span><br><span class="line">4859-4859-4859</span><br><span class="line">4860-4860-4860</span><br><span class="line">4861-4861-4861</span><br><span class="line">4862-4862-4862</span><br><span class="line">4863-4863-4863</span><br><span class="line">48</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/shm/<span class="built_in">test</span> of=test-3 bs=4K skip=33457 count=1</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000193132 s, 21.2 MB/s</span><br><span class="line">$ head test-3 ; wc -l test-3 ;tail test-3</span><br><span class="line">64-4864-4864</span><br><span class="line">4865-4865-4865</span><br><span class="line">4866-4866-4866</span><br><span class="line">4867-4867-4867</span><br><span class="line">4868-4868-4868</span><br><span class="line">4869-4869-4869</span><br><span class="line">4870-4870-4870</span><br><span class="line">4871-4871-4871</span><br><span class="line">4872-4872-4872</span><br><span class="line">4873-4873-4873</span><br><span class="line">273 test-3</span><br><span class="line">5128-5128-5128</span><br><span class="line">5129-5129-5129</span><br><span class="line">5130-5130-5130</span><br><span class="line">5131-5131-5131</span><br><span class="line">5132-5132-5132</span><br><span class="line">5133-5133-5133</span><br><span class="line">5134-5134-5134</span><br><span class="line">5135-5135-5135</span><br><span class="line">5136-5136-5136</span><br><span class="line">513</span><br></pre></td></tr></table></figure><h3 id="check-ext4-fragment"><a href="#check-ext4-fragment" class="headerlink" title="check ext4 fragment"></a>check ext4 fragment</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ e4defrag -c /mnt</span><br><span class="line">&lt;Fragmented files&gt;                             now/best       size/ext</span><br><span class="line">1. /mnt/rw.24.9                                313/1            104 KB</span><br><span class="line">2. /mnt/rw.4.89                                265/1            123 KB</span><br><span class="line">3. /mnt/rw.29.99                               319/1            102 KB</span><br><span class="line">4. /mnt/rw.23.7                                291/1            112 KB</span><br><span class="line">5. /mnt/rw.31.71                               366/1             89 KB</span><br><span class="line"></span><br><span class="line"> Total/best extents1184802/4096</span><br><span class="line"> Average size per extent113 KB</span><br><span class="line"> Fragmentation score28</span><br><span class="line"> [0-30 no problem: 31-55 a little bit fragmented: 56- needs defrag]</span><br><span class="line"> This directory (/mnt) does not need defragmentation.</span><br><span class="line"> Done.</span><br><span class="line"></span><br><span class="line">$ e4defrag /dev/sda &amp;</span><br></pre></td></tr></table></figure><h3 id="mount-the-backup-superblock"><a href="#mount-the-backup-superblock" class="headerlink" title="mount the backup superblock"></a>mount the backup superblock</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$  dumpe2fs /dev/sda2 | grep superblock</span><br><span class="line">$  fsck -b 32768 /dev/sda2</span><br><span class="line">or you could </span><br><span class="line">$  mount sb=32768 /dev/sda2 /mnt </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ext4 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SAS HBA</title>
      <link href="2018/09/27/hba/"/>
      <url>2018/09/27/hba/</url>
      
        <content type="html"><![CDATA[<h2 id="mptsas"><a href="#mptsas" class="headerlink" title="mptsas"></a>mptsas</h2><h3 id="parameters"><a href="#parameters" class="headerlink" title="parameters"></a>parameters</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging_level:</span></span><br><span class="line"><span class="string">The</span> <span class="string">logging_level</span> <span class="string">feature</span> <span class="string">prints</span> <span class="string">debug</span> <span class="string">messages</span> <span class="string">of</span> <span class="string">the</span> <span class="string">enabled</span> <span class="string">log</span> <span class="string">areas</span> <span class="string">to</span> <span class="string">the</span> <span class="string">kernel</span> <span class="string">message</span> <span class="string">log</span> <span class="string">file</span> <span class="string">/var/log/messages.</span> <span class="string">Below</span> <span class="string">is</span> <span class="string">the</span> <span class="string">bit</span> <span class="string">map</span> <span class="string">for</span> <span class="string">enabling</span> <span class="string">additional</span> <span class="string">logging</span> <span class="string">feature</span> <span class="string">to</span> <span class="string">debug</span> <span class="string">below</span> <span class="string">listed</span> <span class="string">areas.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Default=0</span></span><br><span class="line"><span class="string">MPT_DEBUG</span> <span class="number">0x00000001</span></span><br><span class="line"><span class="string">MPT_DEBUG_MSG_FRAME</span> <span class="number">0x00000002</span></span><br><span class="line"><span class="string">MPT_DEBUG_SG</span> <span class="number">0x00000004</span></span><br><span class="line"><span class="string">MPT_DEBUG_EVENTS</span> <span class="number">0x00000008</span></span><br><span class="line"><span class="string">MPT_DEBUG_EVENT_WORK_TASK</span> <span class="number">0x00000010</span></span><br><span class="line"><span class="string">MPT_DEBUG_INIT</span> <span class="number">0x00000020</span></span><br><span class="line"><span class="string">MPT_DEBUG_EXIT</span> <span class="number">0x00000040</span></span><br><span class="line"><span class="string">MPT_DEBUG_FAIL</span> <span class="number">0x00000080</span></span><br><span class="line"><span class="string">MPT_DEBUG_TM</span> <span class="number">0x00000100</span></span><br><span class="line"><span class="string">MPT_DEBUG_REPLY</span> <span class="number">0x00000200</span></span><br><span class="line"><span class="string">MPT_DEBUG_HANDSHAKE</span> <span class="number">0x00000400</span></span><br><span class="line"><span class="string">MPT_DEBUG_CONFIG</span> <span class="number">0x00000800</span></span><br><span class="line"><span class="string">MPT_DEBUG_DL</span> <span class="number">0x00001000</span></span><br><span class="line"><span class="string">MPT_DEBUG_RESET</span> <span class="number">0x00002000</span></span><br><span class="line"><span class="string">MPT_DEBUG_SCSI</span> <span class="number">0x00004000</span></span><br><span class="line"><span class="string">MPT_DEBUG_IOCTL</span> <span class="number">0x00008000</span></span><br><span class="line"><span class="string">MPT_DEBUG_CSMISAS</span> <span class="number">0x00010000</span></span><br><span class="line"><span class="string">MPT_DEBUG_SAS</span> <span class="number">0x00020000</span></span><br><span class="line"><span class="string">MPT_DEBUG_TRANSPORT</span> <span class="number">0x00040000</span></span><br><span class="line"><span class="string">MPT_DEBUG_TASK_SET_FULL</span> <span class="number">0x00080000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sdev_queue_depth:</span></span><br><span class="line"><span class="string">This</span> <span class="string">is</span> <span class="string">the</span> <span class="string">global</span> <span class="string">setting</span> <span class="string">for</span> <span class="string">SAS</span> <span class="string">devices</span> <span class="string">queue</span> <span class="string">depth.</span> <span class="string">This</span> <span class="string">means</span> <span class="string">Scsi</span> <span class="string">Mid</span> <span class="string">Layer</span> <span class="string">can</span> <span class="string">send</span> <span class="string">commands</span> <span class="string">to</span> <span class="string">the</span> <span class="string">drive</span> <span class="string">until</span> <span class="string">the</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pending</span> <span class="string">commands</span> <span class="string">reaches</span> <span class="string">the</span> <span class="string">set</span> <span class="string">queue</span> <span class="string">depth.</span></span><br><span class="line"><span class="string">(Default</span> <span class="attr">Queue Depths:</span> <span class="string">SAS</span> <span class="string">-&gt;</span> <span class="number">254</span><span class="string">,</span> <span class="string">SATA</span> <span class="string">-&gt;</span> <span class="number">32</span><span class="string">,</span> <span class="string">NVMe</span> <span class="string">-&gt;</span> <span class="number">128</span><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_sectors:</span></span><br><span class="line"><span class="string">Driver</span> <span class="string">imposed</span> <span class="string">sector</span> <span class="string">transfer</span> <span class="string">limit.</span> <span class="string">It</span> <span class="string">indicates</span> <span class="string">the</span> <span class="string">maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">sectors</span> <span class="string">to</span> <span class="string">transfer</span> <span class="string">per</span> <span class="string">SCSI</span> <span class="string">IO</span> <span class="string">command.</span> <span class="string">Max_sectors</span> <span class="string">range</span> [<span class="number">64</span> <span class="string">to</span> <span class="number">32767</span>]<span class="string">.</span></span><br><span class="line"><span class="string">Default=32767</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">command_retry_count:</span></span><br><span class="line"><span class="string">The</span> <span class="string">set</span> <span class="string">number</span> <span class="string">of</span> <span class="string">times</span> <span class="string">the</span> <span class="string">internally</span> <span class="string">SCSI</span> <span class="string">Scan</span> <span class="string">(e.g.</span> <span class="string">Inquiry,</span> <span class="string">TUR,</span> <span class="string">Report</span> <span class="string">Lun</span> <span class="string">etc.)</span> <span class="string">commands</span> <span class="string">will</span> <span class="string">be</span> <span class="string">retired</span> <span class="string">during</span> <span class="string">drive</span> <span class="string">discovery</span> <span class="string">process</span> <span class="string">when</span> <span class="string">drive</span> <span class="string">is</span> <span class="string">hot</span> <span class="string">added.</span> <span class="string">Default=144</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">missing_delay:</span></span><br><span class="line"><span class="attr">This field has Device missing delay and Io missing delay as an array of Int. Device missing delay:</span> <span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">seconds</span> <span class="string">the</span> <span class="string">IOC</span> <span class="string">will</span> <span class="string">delay</span> <span class="string">reporting</span> <span class="string">a</span> <span class="string">target</span> <span class="string">device</span> <span class="string">missing</span> <span class="string">after</span> <span class="string">it</span> <span class="string">becomes</span> <span class="string">unavailable.</span> <span class="string">The</span> <span class="string">device</span> <span class="string">will</span> <span class="string">not</span> <span class="string">be</span> <span class="string">reported</span> <span class="string">as</span> <span class="string">missing</span> <span class="string">if</span> <span class="string">it</span> <span class="string">returns</span> <span class="string">before</span> <span class="string">this</span> <span class="string">timer</span> <span class="string">expires.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">IO Missing Delay:</span> <span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">seconds</span> <span class="string">the</span> <span class="string">IOC</span> <span class="string">will</span> <span class="string">delay</span> <span class="string">replying</span> <span class="string">to</span> <span class="string">SCSI</span> <span class="string">Initiators</span> <span class="string">request</span> <span class="string">messages</span> <span class="string">when</span> <span class="string">the</span> <span class="string">addressed</span> <span class="string">device</span> <span class="string">is</span> <span class="string">missing</span> <span class="string">because</span> <span class="string">of</span> <span class="string">the</span> <span class="string">inability</span> <span class="string">to</span> <span class="string">access</span> <span class="string">the</span> <span class="string">target</span> <span class="string">device.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_lun:</span></span><br><span class="line"><span class="string">This</span> <span class="string">sets</span> <span class="string">max_lun</span> <span class="string">field</span> <span class="string">in</span> <span class="string">the</span> <span class="string">Scsi_Host</span> <span class="string">data</span> <span class="string">structure.</span></span><br><span class="line"><span class="string">Default=16895</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">hbas_to_enumerate:</span></span><br><span class="line"><span class="string">A</span> <span class="string">System</span> <span class="string">might</span> <span class="string">have</span> <span class="string">multiple</span> <span class="string">HBAs.</span> <span class="string">This</span> <span class="string">option</span> <span class="string">enables</span> <span class="string">user</span> <span class="string">to</span> <span class="string">select</span> <span class="string">the</span> <span class="string">HBAs</span> <span class="string">to</span> <span class="string">be</span> <span class="string">managed</span> <span class="string">by</span> <span class="string">the</span> <span class="string">driver.</span></span><br><span class="line"><span class="number">0</span> <span class="bullet">-</span> <span class="string">Enumerates</span> <span class="string">all</span> <span class="string">SAS</span> <span class="number">2.0</span><span class="string">,</span> <span class="string">PCIe</span> <span class="string">HBA,</span> <span class="string">SAS3.0</span> <span class="string">&amp;</span> <span class="string">above</span> <span class="string">generation</span></span><br><span class="line"><span class="string">of</span> <span class="string">HBAs.</span></span><br><span class="line"><span class="number">1</span> <span class="bullet">-</span> <span class="string">Enumerates</span> <span class="string">only</span> <span class="string">PCIe</span> <span class="string">HBA</span> <span class="string">&amp;</span> <span class="string">SAS</span> <span class="number">2.0</span> <span class="string">generation</span> <span class="string">HBAs.</span></span><br><span class="line"><span class="number">2</span> <span class="bullet">-</span> <span class="string">Enumerates</span> <span class="string">PCIe</span> <span class="string">HBA,</span> <span class="string">SAS</span> <span class="number">3.0</span> <span class="string">&amp;</span> <span class="string">above</span> <span class="string">generation</span> <span class="string">HBAs.</span></span><br><span class="line"><span class="string">Default=-1</span> <span class="string">(Enumerates</span> <span class="string">all</span> <span class="string">SAS</span> <span class="number">2.0</span><span class="string">,</span> <span class="string">PCIe</span> <span class="string">HBA,</span> <span class="string">SAS</span> <span class="number">3.0</span> <span class="string">&amp;</span> <span class="string">above</span> <span class="string">generation</span> <span class="string">HBAs</span> <span class="string">else</span> <span class="string">PCIe</span> <span class="string">HBA,</span> <span class="string">SAS</span> <span class="number">3.0</span> <span class="string">&amp;</span> <span class="string">above</span> <span class="string">generation</span> <span class="string">HBAs</span> <span class="string">only)</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">multipath_on_hba:</span></span><br><span class="line"><span class="string">Multipath</span> <span class="string">support</span> <span class="string">to</span> <span class="string">add</span> <span class="string">same</span> <span class="string">target</span> <span class="string">device</span> <span class="string">as</span> <span class="string">many</span> <span class="string">times</span> <span class="string">as</span> <span class="string">it</span> <span class="string">is</span> <span class="string">visible</span> <span class="string">to</span> <span class="string">HBA</span> <span class="string">from</span> <span class="string">various</span> <span class="string">paths.</span> <span class="string">Default=0</span> <span class="string">(Disabled)</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">disable_eedp:</span></span><br><span class="line"><span class="string">End-to-end</span> <span class="string">Data</span> <span class="string">Protection</span> <span class="string">is</span> <span class="string">a</span> <span class="string">feature</span> <span class="string">in</span> <span class="string">hard</span> <span class="string">drives</span> <span class="string">that</span> <span class="string">extends</span> <span class="string">error</span> <span class="string">detection</span> <span class="string">to</span> <span class="string">cover</span> <span class="string">the</span> <span class="string">entire</span> <span class="string">path</span> <span class="string">from</span> <span class="string">the</span> <span class="string">computer</span> <span class="string">system</span> <span class="string">to</span> <span class="string">the</span> <span class="string">hard</span> <span class="string">drive</span> <span class="string">media</span> <span class="string">and</span> <span class="string">back.</span> <span class="string">Default=0</span> <span class="string">(EEDP</span> <span class="string">support</span> <span class="string">is</span> <span class="string">enabled)</span> <span class="string">(uint)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">diag_buffer_enable:</span></span><br><span class="line"><span class="string">When</span> <span class="string">this</span> <span class="string">module</span> <span class="string">parameter</span> <span class="string">is</span> <span class="string">set</span> <span class="string">then</span> <span class="string">corresponding</span> <span class="string">diag</span> <span class="string">buffers</span> <span class="string">will</span> <span class="string">be</span> <span class="string">registered</span> <span class="string">with</span> <span class="string">the</span> <span class="string">HBA</span> <span class="string">firmware.</span> <span class="string">Here</span> <span class="string">are</span> <span class="string">list</span> <span class="string">of</span> <span class="string">diag</span> <span class="string">buffer</span> <span class="string">that</span> <span class="string">user</span> <span class="string">can</span> <span class="string">register.</span></span><br><span class="line"><span class="string">Bit</span> <span class="string">fields</span> <span class="string">for</span> <span class="string">diag_buffer_enable</span></span><br><span class="line"><span class="string">Bit</span> <span class="number">0</span> <span class="string">set</span> <span class="string">=</span> <span class="string">TRACE</span></span><br><span class="line"><span class="string">Bit</span> <span class="number">1</span> <span class="string">set</span> <span class="string">=</span> <span class="string">SNAPSHOT</span></span><br><span class="line"><span class="string">Bit</span> <span class="number">2</span> <span class="string">set</span> <span class="string">=</span> <span class="string">EXTENDED</span></span><br><span class="line"><span class="string">Default=0</span> <span class="string">(none</span> <span class="string">of</span> <span class="string">the</span> <span class="string">diag</span> <span class="string">buffers</span> <span class="string">will</span> <span class="string">be</span> <span class="string">registered)(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">disable_discovery:</span></span><br><span class="line"><span class="string">Setting</span> <span class="string">this</span> <span class="string">module</span> <span class="string">parameter</span> <span class="string">will</span> <span class="string">disables</span> <span class="string">discovery</span> <span class="string">of</span> <span class="string">attached</span> <span class="string">drives.</span></span><br><span class="line"><span class="string">Default=0</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">allow_drive_spindown:</span></span><br><span class="line"><span class="string">Allows</span> <span class="string">host</span> <span class="string">driver</span> <span class="string">to</span> <span class="string">issue</span> <span class="string">START</span> <span class="string">STOP</span> <span class="string">UNIT</span> <span class="string">(STOP)</span> <span class="string">command</span> <span class="string">to</span> <span class="string">spin</span> <span class="string">down</span> <span class="string">the</span> <span class="string">drives</span> <span class="string">before</span> <span class="string">shutdown</span> <span class="string">or</span> <span class="string">driver</span> <span class="string">unload.</span> </span><br><span class="line"><span class="string">Default=1</span> <span class="string">(Spindown</span> <span class="string">SSD</span> <span class="string">but</span> <span class="string">not</span> <span class="string">HDD)</span> <span class="string">(uint)</span></span><br><span class="line"><span class="number">0</span> <span class="string">=&gt;</span> <span class="string">dont</span> <span class="string">Spindown</span> <span class="string">any</span> <span class="string">SATA</span> <span class="string">drives.</span></span><br><span class="line"><span class="number">1</span> <span class="string">=&gt;</span> <span class="string">Spindown</span> <span class="string">SSD</span> <span class="string">but</span> <span class="string">not</span> <span class="string">HDD</span></span><br><span class="line"><span class="number">2</span> <span class="string">=&gt;</span> <span class="string">Spindown</span> <span class="string">HDD</span> <span class="string">but</span> <span class="string">not</span> <span class="string">SSD</span></span><br><span class="line"><span class="number">3</span> <span class="string">=&gt;</span> <span class="string">Spindown</span> <span class="string">all</span> <span class="string">SATA</span> <span class="string">drives</span></span><br><span class="line"></span><br><span class="line"><span class="attr">prot_mask:</span></span><br><span class="line"><span class="string">Permits</span> <span class="string">overriding</span> <span class="string">the</span> <span class="string">host</span> <span class="string">protection</span> <span class="string">capabilities</span> <span class="string">mask.</span> <span class="string">DIF</span> <span class="string">defines</span> <span class="string">the</span> <span class="string">exchange</span> <span class="string">of</span> <span class="string">protection</span> <span class="string">information</span> <span class="string">between</span> <span class="string">initiator</span> <span class="string">and</span> <span class="string">SBC</span> <span class="string">block</span> <span class="string">device</span> <span class="string">(HBA</span> <span class="string">and</span> <span class="string">Disk).</span> <span class="string">DIX</span> <span class="string">defines</span> <span class="string">the</span> <span class="string">exchange</span> <span class="string">of</span> <span class="string">protection</span> <span class="string">information</span> <span class="string">between</span> <span class="string">OS</span> <span class="string">and</span> <span class="string">initiator</span> <span class="string">(OS</span> <span class="string">and</span> <span class="string">HBA).</span></span><br><span class="line"><span class="string">Bits</span> <span class="string">for</span> <span class="string">enabling</span> <span class="string">DIF/DIX</span></span><br><span class="line"><span class="string">SHOST_DIF_TYPE1_PROTECTION</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">0</span></span><br><span class="line"><span class="string">SHOST_DIF_TYPE2_PROTECTION</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">1</span></span><br><span class="line"><span class="string">SHOST_DIF_TYPE3_PROTECTION</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">2</span></span><br><span class="line"><span class="string">SHOST_DIX_TYPE0_PROTECTION</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">3</span></span><br><span class="line"><span class="string">SHOST_DIX_TYPE1_PROTECTION</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">4</span></span><br><span class="line"><span class="string">SHOST_DIX_TYPE2_PROTECTION</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">5</span></span><br><span class="line"><span class="string">SHOST_DIX_TYPE3_PROTECTION</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">6</span></span><br><span class="line"><span class="string">Default=0x07</span> <span class="string">(DIX</span> <span class="string">support</span> <span class="string">is</span> <span class="string">disabled</span> <span class="string">and</span> <span class="string">only</span> <span class="string">DIF</span> <span class="string">will</span> <span class="string">be</span></span><br><span class="line"><span class="string">enabled)</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">protection_guard_mask:</span></span><br><span class="line"><span class="string">This</span> <span class="string">permits</span> <span class="string">overriding</span> <span class="string">the</span> <span class="string">host</span> <span class="string">protection</span> <span class="string">algorithm</span> <span class="string">mask</span> <span class="string">Available</span> <span class="string">(T10</span> <span class="string">CRC/</span> <span class="string">IP</span> <span class="string">Checksum).</span></span><br><span class="line"><span class="string">All</span> <span class="string">DIX-capable</span> <span class="string">initiators</span> <span class="string">must</span> <span class="string">support</span> <span class="string">the</span> <span class="string">T10-mandated</span> <span class="string">CRC</span> <span class="string">checksum.</span> <span class="string">Controllers</span> <span class="string">can</span> <span class="string">optionally</span> <span class="string">implement</span> <span class="string">the</span> <span class="string">IP</span> <span class="string">checksum</span> <span class="string">scheme</span> <span class="string">which</span> <span class="string">has</span> <span class="string">much</span> <span class="string">lower</span> <span class="string">impact</span> <span class="string">on</span> <span class="string">system</span> <span class="string">performance.</span> <span class="string">Note</span> <span class="string">that</span> <span class="string">the</span> <span class="string">main</span> <span class="string">rationale</span> <span class="string">for</span> <span class="string">the</span> <span class="string">checksum</span> <span class="string">is</span> <span class="string">to</span> <span class="string">match</span> <span class="string">integrity</span> <span class="string">metadata</span> <span class="string">with</span> <span class="string">data.</span></span><br><span class="line"><span class="string">SHOST_DIX_GUARD_CRC</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">0</span></span><br><span class="line"><span class="string">SHOST_DIX_GUARD_IP</span> <span class="string">=</span> <span class="number">1</span> <span class="string">&lt;&lt;</span> <span class="number">1</span></span><br><span class="line"><span class="string">Default=3</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">issue_scsi_cmd_to_bringup_drive:</span> <span class="string">Setting</span> <span class="string">this</span> <span class="string">allows</span> <span class="string">host</span> <span class="string">driver</span> <span class="string">to</span> <span class="string">issue</span> <span class="string">SCSI</span> <span class="string">commands</span> <span class="string">internally</span> <span class="string">to</span> <span class="string">bring</span> <span class="string">the</span> <span class="string">drive</span> <span class="string">to</span> <span class="string">READY</span> <span class="string">state.</span> <span class="string">Default=1</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sata_smart_polling:</span> <span class="string">Setting</span> <span class="string">this</span> <span class="string">feature,</span> <span class="string">allows</span> <span class="string">polling</span> <span class="string">for</span> <span class="string">smart</span> <span class="string">errors</span> <span class="string">on</span> <span class="string">SATA</span> <span class="string">drives.</span></span><br><span class="line"><span class="string">Default=0</span> <span class="string">(uint)</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">max_queue_depth:</span></span><br><span class="line"><span class="string">User</span> <span class="string">can</span> <span class="string">use</span> <span class="string">this</span> <span class="string">to</span> <span class="string">set</span> <span class="string">hba</span> <span class="string">queue</span> <span class="string">depth</span> <span class="string">to</span> <span class="string">be</span> <span class="string">used</span> <span class="string">by</span> <span class="string">the</span> <span class="string">controller.</span> <span class="string">Max</span> <span class="string">controller</span> <span class="string">queue</span> <span class="string">depth</span> <span class="string">can</span> <span class="string">be</span> <span class="string">up</span> <span class="string">to</span> <span class="number">30000</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_sgl_entries:</span></span><br><span class="line"><span class="string">This</span> <span class="string">allows</span> <span class="string">user</span> <span class="string">to</span> <span class="string">specify</span> <span class="string">the</span> <span class="string">maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">ScatterGather</span> <span class="string">entries</span> <span class="string">per</span> <span class="string">I/O.</span> <span class="string">Default=128</span> <span class="string">in</span> <span class="string">most</span> <span class="string">kernels.</span> <span class="string">(Range</span> <span class="number">16</span> <span class="string">to</span> <span class="number">256</span><span class="string">)</span> <span class="string">(int)</span></span><br><span class="line"><span class="string">The</span> <span class="string">Linux</span> <span class="string">scatter/gather</span> <span class="string">table</span> <span class="string">size</span> <span class="string">needs</span> <span class="string">to</span> <span class="string">be</span> <span class="string">large</span> <span class="string">enough</span> <span class="string">to</span> <span class="string">allow</span> <span class="string">IO_SIZE</span> <span class="string">IO,</span> <span class="string">if</span> <span class="string">possible.</span> <span class="string">For</span> <span class="string">most</span> <span class="string">drivers,</span> <span class="string">this</span> <span class="string">typically</span> <span class="string">requires</span> <span class="string">a</span> <span class="string">sg_tablesize</span> <span class="string">value</span> <span class="string">of</span> <span class="number">256</span> <span class="string">or</span> <span class="string">greater</span> <span class="string">for</span> <span class="string">4MB</span> <span class="string">IO.</span> <span class="string">Different</span> <span class="string">vendors</span> <span class="string">have</span> <span class="string">different</span> <span class="string">defaults</span> <span class="string">for</span> <span class="string">this</span> <span class="string">parameter,</span> <span class="string">and</span> <span class="string">may</span> <span class="string">require</span> <span class="string">a</span> <span class="string">modprobe.conf</span> <span class="string">entry</span> <span class="string">to</span> <span class="string">increase</span> <span class="string">the</span> <span class="string">value.</span> <span class="string">The</span> <span class="string">QLogic</span> <span class="string">driver</span> <span class="string">defaults</span> <span class="string">to</span> <span class="string">a</span> <span class="string">value</span> <span class="string">of</span> <span class="number">1024. </span><span class="string">For</span> <span class="string">Emulex,</span> <span class="string">a</span> <span class="string">modeprobe.conf</span> <span class="string">entry</span> <span class="string">needs</span> <span class="string">to</span> <span class="string">be</span> <span class="string">added</span> <span class="string">to</span> <span class="string">increase</span> <span class="string">the</span> <span class="string">value</span> <span class="string">to</span> <span class="number">256</span> <span class="string">or</span> <span class="string">greater,</span> <span class="attr">such as:</span></span><br><span class="line"><span class="string">options</span> <span class="string">lpfc</span> <span class="string">lpfc_sg_seg_cnt=256</span></span><br><span class="line"><span class="string">The</span> <span class="string">LSI</span> <span class="string">SAS</span> <span class="string">driver,</span> <span class="string">mpt2sas,</span> <span class="string">uses</span> <span class="string">the</span> <span class="string">parameter</span> <span class="string">named</span> <span class="string">max_sgl_entries</span> <span class="string">to</span> <span class="string">control</span> <span class="string">this</span> <span class="string">value.</span> <span class="string">Its</span> <span class="string">maximum</span> <span class="string">value</span> <span class="string">in</span> <span class="string">RHEL</span> <span class="number">6.</span><span class="string">x</span> <span class="string">currently</span> <span class="string">only</span> <span class="number">128</span><span class="string">.</span></span><br><span class="line"><span class="attr">The value of sg_tablesize can be validated via:</span></span><br><span class="line"><span class="string">&#x27;cat /sys/class/scsi_host/host&#123;n&#125;/sg_tablesize&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">msix_disable:</span></span><br><span class="line"><span class="string">Setting</span> <span class="number">1</span> <span class="string">disables</span> <span class="string">MSIX</span> <span class="string">routed</span> <span class="string">interrupts</span> <span class="string">and</span> <span class="string">uses</span> <span class="string">legacy</span> <span class="string">interrupts.</span></span><br><span class="line"><span class="string">Default=0</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">smp_affinity_enable:</span></span><br><span class="line"><span class="string">This</span> <span class="string">defines</span> <span class="string">the</span> <span class="string">CPU</span> <span class="string">cores</span> <span class="string">that</span> <span class="string">are</span> <span class="string">allowed</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">the</span> <span class="string">ISR</span> <span class="string">for</span> <span class="string">that</span> <span class="string">IRQ.</span> <span class="string">Setting</span> <span class="string">this</span> <span class="string">enables</span> <span class="string">SMP</span> <span class="string">affinity</span> <span class="string">feature.</span> <span class="string">Enable/Disable</span> <span class="string">(1/0)</span></span><br><span class="line"><span class="string">Default=1</span> <span class="string">Enabled</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_msix_vectors:</span></span><br><span class="line"><span class="string">Controls</span> <span class="string">the</span> <span class="string">number</span> <span class="string">of</span> <span class="string">msix</span> <span class="string">vectors</span> <span class="string">to</span> <span class="string">be</span> <span class="string">used</span> <span class="string">by</span> <span class="string">mpt3sas</span> <span class="string">driver.</span> <span class="string">SAS3.0</span> <span class="string">controllers</span> <span class="string">like</span> <span class="string">Invader</span> <span class="string">supports</span> <span class="string">max</span> <span class="number">96</span> <span class="string">msix</span> <span class="string">vectors</span> <span class="string">SAS3.5</span> <span class="string">products</span> <span class="string">like</span> <span class="string">Ventura</span> <span class="string">supports</span> <span class="string">max</span> <span class="number">128</span> <span class="string">msix.</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">irqpoll_weight:</span></span><br><span class="line"><span class="string">irq</span> <span class="string">poll</span> <span class="string">weight</span> <span class="string">is</span> <span class="string">used</span> <span class="string">as</span> <span class="string">the</span> <span class="string">budget</span> <span class="string">in</span> <span class="string">processing</span> <span class="string">of</span> <span class="string">reply</span> <span class="string">descriptors</span> <span class="string">from</span> <span class="string">reply</span> <span class="string">descriptor</span> <span class="string">post</span> <span class="string">queues.</span> <span class="string">Also</span> <span class="string">once</span> <span class="string">irqpoll_weight</span> <span class="string">numbers</span> <span class="string">of</span> <span class="string">reply</span> <span class="string">descriptors</span> <span class="string">are</span> <span class="string">continuously</span> <span class="string">processed</span> <span class="string">in</span> <span class="string">ISR</span> <span class="string">context</span> <span class="string">then</span> <span class="string">driver</span> <span class="string">will</span> <span class="string">quit</span> <span class="string">from</span> <span class="string">the</span> <span class="string">ISR</span> <span class="string">and</span> <span class="string">invoke</span> <span class="string">the</span> <span class="string">irq</span> <span class="string">polling</span> <span class="string">thread</span> <span class="string">to</span> <span class="string">process</span> <span class="string">the</span> <span class="string">remaining</span> <span class="string">reply</span> <span class="string">descriptors.</span></span><br><span class="line"><span class="string">Default=one</span> <span class="string">fourth</span> <span class="string">of</span> <span class="string">HBA</span> <span class="string">queue</span> <span class="string">depth.</span> <span class="string">(int)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mpt3sas_fwfault_debug:</span></span><br><span class="line"><span class="string">Setting</span> <span class="string">this</span> <span class="string">enables</span> <span class="string">detection</span> <span class="string">of</span> <span class="string">firmware</span> <span class="string">fault</span> <span class="string">and</span> <span class="string">halts</span> <span class="string">firmware.</span> <span class="string">Usually</span> <span class="string">this</span> <span class="string">is</span> <span class="string">set</span> <span class="string">to</span> <span class="string">collect</span> <span class="string">the</span> <span class="string">HBA</span> <span class="string">FW</span> <span class="string">logs</span> <span class="string">during</span> <span class="string">firmware</span> <span class="string">fault.</span></span><br><span class="line"><span class="string">Default=0</span> <span class="string">(int)</span></span><br></pre></td></tr></table></figure><h4 id="mptsas-drvier-parameters"><a href="#mptsas-drvier-parameters" class="headerlink" title="mptsas drvier parameters"></a>mptsas drvier parameters</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kernel: mpt2sas1: iomem(0x0000000091c40000), mapped(0xffffc90003760000), size(65536)</span><br><span class="line">kernel: mpt2sas1: ioport(0x0000000000002000), size(256)</span><br><span class="line">kernel: mpt2sas1: Allocated physical memory: size(17329 kB)</span><br><span class="line">kernel: mpt2sas1: Current Controller Queue Depth(9979), Max Controller Queue Depth(10240)</span><br></pre></td></tr></table></figure><p>CONFIG_SCSI_MPT2SAS_MAX_SGE: This option allows you to specify the maximum number of scatter-gather entries per I/O. The driver default is 128, which matches MAX_HW_SEGMENTS. However, it may decreased down to 16. Decreasing this parameter will reduce memory requirements on a per controller instance</p><p>parm: command_retry_count: Device discovery TUR command retry count: (default=144) (int)<br>retry count default was 144, it s too large</p><p>parm: max_queue_depth: max controller queue depth (int)</p><p>The Linux scatter/gather table size needs to be large enough to allow IO_SIZE IO, if possible. For most drivers, this typically requires a sg_tablesize value of 256 or greater for 4MB IO. Different vendors have different defaults for this parameter, and may require a modprobe.conf entry to increase the value. The QLogic driver defaults to a value of 1024. For Emulex, a modeprobe.conf entry needs to be added to increase the value to 256 or greater, such as:<br>options lpfc lpfc_sg_seg_cnt=256</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ lspci | grep 2308</span><br><span class="line">01:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS2308 PCI-Express Fusion-MPT SAS-2 (rev 05)</span><br><span class="line">$ cat /sys/devices/pci0000:00/0000:00:02.1/0000:01:00.0/host1/scsi_host/host1/sg_tablesize</span><br><span class="line">128</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 256 &gt; /sys/devices/pci0000:00/0000:00:02.1/0000:01:00.0/host1/scsi_host/host1/sg_tablesize</span><br><span class="line"><span class="built_in">echo</span>: write error: Input/output error</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> it at modprobe.d/mpt3sas.conf</span><br></pre></td></tr></table></figure><h3 id="Error-code"><a href="#Error-code" class="headerlink" title="Error code"></a><a href="https://elixir.bootlin.com/linux/v4.18.20/source/drivers/scsi/mpt3sas/mpi/mpi2_ioc.h">Error code</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define MPI2_EVENT_LOG_DATA                         (0x0001)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_STATE_CHANGE                     (0x0002)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_HARD_RESET_RECEIVED              (0x0005)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_EVENT_CHANGE                     (0x000A)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_TASK_SET_FULL                    (0x000E)/*obsolete */</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEVICE_STATUS_CHANGE         (0x000F)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_IR_OPERATION_STATUS              (0x0014)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DISCOVERY                    (0x0016)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_BROADCAST_PRIMITIVE          (0x0017)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_INIT_DEVICE_STATUS_CHANGE    (0x0018)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_INIT_TABLE_OVERFLOW          (0x0019)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST         (0x001C)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_ENCL_DEVICE_STATUS_CHANGE    (0x001D)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_ENCL_DEVICE_STATUS_CHANGE        (0x001D)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_IR_VOLUME                        (0x001E)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_IR_PHYSICAL_DISK                 (0x001F)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_IR_CONFIGURATION_CHANGE_LIST     (0x0020)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_LOG_ENTRY_ADDED                  (0x0021)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_PHY_COUNTER                  (0x0022)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_GPIO_INTERRUPT                   (0x0023)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_HOST_BASED_DISCOVERY_PHY         (0x0024)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_QUIESCE                      (0x0025)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_NOTIFY_PRIMITIVE             (0x0026)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_TEMP_THRESHOLD                   (0x0027)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_HOST_MESSAGE                     (0x0028)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_POWER_PERFORMANCE_CHANGE         (0x0029)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_PCIE_DEVICE_STATUS_CHANGE        (0x0030)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_PCIE_ENUMERATION                 (0x0031)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_PCIE_TOPOLOGY_CHANGE_LIST        (0x0032)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_PCIE_LINK_COUNTER                (0x0033)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_ACTIVE_CABLE_EXCEPTION           (0x0034)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEVICE_DISCOVERY_ERROR       (0x0035)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_MIN_PRODUCT_SPECIFIC             (0x006E)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_MAX_PRODUCT_SPECIFIC             (0x007F)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_SMART_DATA                           (0x05)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_UNSUPPORTED                          (0x07)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_INTERNAL_DEVICE_RESET                (0x08)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_TASK_ABORT_INTERNAL                  (0x09)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_ABORT_TASK_SET_INTERNAL              (0x0A)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_CLEAR_TASK_SET_INTERNAL              (0x0B)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_QUERY_TASK_INTERNAL                  (0x0C)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_ASYNC_NOTIFICATION                   (0x0D)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_CMP_INTERNAL_DEV_RESET               (0x0E)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_CMP_TASK_ABORT_INTERNAL              (0x0F)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_SATA_INIT_FAILURE                    (0x10)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_EXPANDER_REDUCED_FUNCTIONALITY       (0x11)</span></span><br><span class="line"><span class="comment">#define MPI2_EVENT_SAS_DEV_STAT_RC_CMP_EXPANDER_REDUCED_FUNCTIONALITY   (0x12)</span></span><br></pre></td></tr></table></figure><h3 id="Err-Log"><a href="#Err-Log" class="headerlink" title="Err Log"></a>Err Log</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">_scsih_block_io_device</span> <span class="string">(set</span> <span class="string">the</span> <span class="string">device</span> <span class="string">state</span> <span class="string">to</span> <span class="string">SDEV_BLOCK)</span></span><br><span class="line"><span class="string">mpt3sas_scsih_event_callback</span> <span class="string">(firmware</span> <span class="string">event</span> <span class="string">handler</span> <span class="string">(called</span> <span class="string">at</span> <span class="string">ISR</span> <span class="string">time))</span></span><br><span class="line"><span class="string">case</span> <span class="string">match</span> <span class="string">MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST</span></span><br><span class="line">        <span class="string">https://elixir.bootlin.com/linux/v4.7/source/drivers/scsi/mpt3sas/mpt3sas_base.c#L627</span></span><br><span class="line">        <span class="attr">case MPI2_EVENT_SAS_INIT_DEVICE_STATUS_CHANGE:</span></span><br><span class="line"><span class="string">desc</span> <span class="string">=</span> <span class="string">&quot;SAS Init Device Status Change&quot;</span><span class="string">;</span></span><br><span class="line"><span class="string">break;</span></span><br><span class="line">        <span class="string">https://elixir.bootlin.com/linux/v4.7/source/drivers/scsi/mpt3sas/mpi/mpi2_ioc.h#L507</span></span><br><span class="line">        <span class="comment">#define MPI2_EVENT_SAS_INIT_DEVICE_STATUS_CHANGE    (0x0018)</span></span><br><span class="line">        <span class="comment">#define MPI2_EVENT_EVENT_CHANGE                     (0x000A)</span></span><br><span class="line"><span class="string">drivers/scsi/mpt3sas/mpt3sas_scsih.c</span></span><br><span class="line"><span class="string">_scsih_check_topo_delete_events</span></span><br><span class="line">    <span class="string">(This</span> <span class="string">handles</span> <span class="string">the</span> <span class="string">case</span> <span class="string">where</span> <span class="string">driver</span> <span class="string">receives</span> <span class="string">multiple</span> <span class="string">expander</span> <span class="string">add</span> <span class="string">and</span> <span class="string">delete</span> <span class="string">events</span> <span class="string">in</span> <span class="string">a</span> <span class="string">single</span> <span class="string">shot.</span>  <span class="string">When</span> <span class="string">there</span> <span class="string">is</span> <span class="string">a</span> <span class="string">delete</span> <span class="string">event</span> <span class="string">the</span> <span class="string">routine</span> <span class="string">will</span> <span class="string">void</span> <span class="string">any</span> <span class="string">pending</span> <span class="string">add</span> <span class="string">events</span> <span class="string">waiting</span> <span class="string">in</span> <span class="string">the</span> <span class="string">event</span> <span class="string">queue)</span></span><br><span class="line"><span class="string">_scsih_block_io_to_children_attached_directly</span></span><br><span class="line">  <span class="string">_scsih_block_io_all_device</span> <span class="string">(set</span> <span class="string">the</span> <span class="string">device</span> <span class="string">state</span> <span class="string">to</span> <span class="string">SDEV_BLOCK)</span></span><br><span class="line">                <span class="attr">log:</span> </span><br><span class="line">                <span class="attr">kernel:</span> [ <span class="number">7118.402902</span>] <span class="attr">ses 1:0:12:0:</span> <span class="string">_scsih_block_io_device</span> <span class="string">skip</span> <span class="string">device_block</span> <span class="string">for</span> <span class="string">SES</span> <span class="string">handle(0x0018)</span></span><br><span class="line">                <span class="attr">kernel:</span> [ <span class="number">7118.465245</span>] <span class="attr">ses 1:0:52:0:</span> <span class="string">_scsih_block_io_device</span> <span class="string">skip</span> <span class="string">device_block</span> <span class="string">for</span> <span class="string">SES</span> <span class="string">handle(0x0040)</span></span><br><span class="line">                <span class="string">if</span> <span class="string">(sas_device_priv_data-&gt;ignore_delay_remove)</span> &#123;</span><br><span class="line">                        <span class="string">sdev_printk(KERN_INFO</span>, <span class="string">sdev</span>,</span><br><span class="line">                        <span class="string">&quot;%s skip device_block for SES handle(0x%04x)\n&quot;</span>,</span><br><span class="line">                        <span class="string">__func__</span>, <span class="string">sas_device_priv_data-&gt;sas_target-&gt;handle);</span></span><br><span class="line">                        <span class="string">continue;</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="string">_scsih_internal_device_block</span> <span class="string">(</span> <span class="string">_scsih_internal_device_block</span> <span class="bullet">-</span> <span class="string">block</span> <span class="string">the</span> <span class="string">sdev</span> <span class="string">device</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">device</span> <span class="string">is</span> <span class="string">blocked</span> <span class="string">without</span> <span class="string">error)</span> </span><br><span class="line">                        <span class="attr">log: kernel:</span> [ <span class="number">7118.402781</span>] <span class="attr">sd 1:0:0:0:</span> <span class="string">device_block,</span> <span class="string">handle(0x000a)</span></span><br><span class="line"><span class="string">sdev_printk(KERN_INFO,</span> <span class="string">sdev,</span> <span class="string">&quot;device_block, handle(0x%04x)\n&quot;</span><span class="string">,sas_device_priv_data-&gt;sas_target-&gt;handle);</span></span><br><span class="line">                       <span class="attr">kernel description:</span> </span><br><span class="line">                               <span class="string">scsi_internal_device_block</span> <span class="string"></span> <span class="string">internal</span> <span class="string">function</span> <span class="string">to</span> <span class="string">put</span> <span class="string">a</span> <span class="string">device</span> <span class="string">temporarily</span> <span class="string">into</span> <span class="string">the</span> <span class="string">SDEV_BLOCK</span> <span class="string">state</span> </span><br><span class="line">                               <span class="attr">SDEV_BLOCK state:</span></span><br><span class="line"><span class="string">Block</span> <span class="string">request</span> <span class="string">made</span> <span class="string">by</span> <span class="string">scsi</span> <span class="string">lld&#x27;s</span> <span class="string">to</span> <span class="string">temporarily</span> <span class="string">stop</span> <span class="string">all</span> <span class="string">scsi</span> <span class="string">commands</span> <span class="string">on</span> <span class="string">the</span> <span class="string">specified</span> <span class="string">device.</span> <span class="string">May</span> <span class="string">sleep.</span></span><br><span class="line"></span><br><span class="line"><span class="string">_scsih_sas_broadcast_primitive_event</span></span><br><span class="line"><span class="string">_scsih_remove_unresponding_sas_devices</span></span><br><span class="line"><span class="string">_scsih_ublock_io_all_device</span> <span class="string">(unblock</span> <span class="string">every</span> <span class="string">device)</span></span><br><span class="line"><span class="string">_scsih_internal_device_unblock</span></span><br><span class="line"><span class="string">unblock</span> <span class="string">the</span> <span class="string">sdev</span> <span class="string">device,</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">device</span> <span class="string">is</span> <span class="string">unblocked</span> <span class="string">without</span> <span class="string">error,</span> <span class="string">if</span> <span class="string">not</span> <span class="string">retry</span> <span class="string">by</span> <span class="string">blocking</span> <span class="string">and</span> <span class="string">then</span> <span class="string">unblocking</span></span><br><span class="line">        <span class="string">sdev_printk(KERN_WARNING,</span> <span class="string">sdev,</span> <span class="string">&quot;device_unblock and setting to running, &quot;</span></span><br><span class="line">            <span class="string">&quot;handle(0x%04x)\n&quot;</span><span class="string">,</span> <span class="string">sas_device_priv_data-&gt;sas_target-&gt;handle);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">log</span> <span class="string">order</span></span><br><span class="line"><span class="attr">sd 1:0:0:0:</span> <span class="string">device_block,</span> <span class="string">handle(0x000a)</span></span><br><span class="line"><span class="attr">ses 1:0:12:0:</span> <span class="string">_scsih_block_io_device</span> <span class="string">skip</span> <span class="string">device_block</span> <span class="string">for</span> <span class="string">SES</span> <span class="string">handle(0x0018)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sd 1:0:22:0:</span> <span class="string">device_unblock</span> <span class="string">and</span> <span class="string">setting</span> <span class="string">to</span> <span class="string">running,</span> <span class="string">handle(0x0022)</span></span><br><span class="line"><span class="attr">sd 1:0:0:0:</span> <span class="string">device_unblock</span> <span class="string">and</span> <span class="string">setting</span> <span class="string">to</span> <span class="string">running,</span> <span class="string">handle(0x000a)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">--------------------</span> </span><br><span class="line"><span class="attr">kernel: sd 1:0:0:0:</span> [<span class="string">sdb</span>] <span class="string">Synchronizing</span> <span class="string">SCSI</span> <span class="string">cache</span></span><br><span class="line"><span class="attr">kernel: sd 1:0:0:0:</span> [<span class="string">sdb</span>] <span class="string">Synchronize</span> <span class="string">Cache(10)</span> <span class="attr">failed: Result:</span> <span class="string">hostbyte=DID_NO_CONNECT</span> <span class="string">driverbyte=DRIVER_OK</span></span><br><span class="line"></span><br><span class="line"><span class="string">sd_shutdown</span></span><br><span class="line"><span class="string">(Send</span> <span class="string">a</span> <span class="string">SYNCHRONIZE</span> <span class="string">CACHE</span> <span class="string">instruction</span> <span class="string">down</span> <span class="string">to</span> <span class="string">the</span> <span class="string">device</span> <span class="string">through</span> <span class="string">the</span> <span class="string">normal</span> <span class="string">SCSI</span> <span class="string">command</span> <span class="string">structure.</span>  <span class="string">Wait</span> <span class="string">for</span> <span class="string">the</span> <span class="string">command</span> <span class="string">to</span> <span class="string">complete)</span></span><br><span class="line"><span class="string">sd_sync_cache</span></span><br><span class="line"><span class="string">sd_print_result(sdkp,</span> <span class="string">&quot;Synchronize Cache(10) failed&quot;</span><span class="string">,</span> <span class="string">res);</span></span><br><span class="line"><span class="string">sd_suspend</span></span><br><span class="line"><span class="string">./drivers/scsi/sd.c:</span><span class="string">sd_printk(KERN_NOTICE,</span> <span class="string">sdkp,</span> <span class="string">&quot;Synchronizing SCSI cache\n&quot;</span><span class="string">);</span> <span class="attr">E.g.:</span> <span class="string">runtime</span> <span class="string">suspend</span> <span class="string">following</span> <span class="string">sd_remove()</span></span><br><span class="line"><span class="string">sd_remove</span></span><br><span class="line"><span class="attr">Note:</span> <span class="string">this</span> <span class="string">function</span> <span class="string">is</span> <span class="string">invoked</span> <span class="string">from</span> <span class="string">the</span> <span class="string">scsi</span> <span class="string">mid-level.</span> <span class="string">This</span> <span class="string">function</span> <span class="string">potentially</span> <span class="string">frees</span> <span class="string">up</span> <span class="string">a</span> <span class="string">device</span> <span class="string">name</span> <span class="string">(e.g.</span> <span class="string">/dev/sdc)</span> <span class="string">that</span> <span class="string">could</span> <span class="string">be</span> <span class="string">re-used</span> <span class="string">by</span> <span class="string">a</span> <span class="string">subsequent</span> <span class="string">sd_probe().</span> <span class="string">This</span> <span class="string">function</span> <span class="string">is</span> <span class="string">not</span> <span class="string">called</span> <span class="string">when</span> <span class="string">the</span> <span class="string">built-in</span> <span class="string">sd</span> <span class="string">driver</span> <span class="string">is</span> <span class="string">&quot;exit-ed&quot;</span><span class="string">.</span></span><br><span class="line"><span class="string">sd_shutdown</span></span><br><span class="line"><span class="string">Send</span> <span class="string">a</span> <span class="string">SYNCHRONIZE</span> <span class="string">CACHE</span> <span class="string">instruction</span> <span class="string">down</span> <span class="string">to</span> <span class="string">the</span> <span class="string">device</span> <span class="string">through</span> <span class="string">the</span> <span class="string">normal</span> <span class="string">SCSI</span> <span class="string">command</span> <span class="string">structure.</span>  <span class="string">Wait</span> <span class="string">for</span> <span class="string">the</span> <span class="string">command</span> <span class="string">to</span> <span class="string">complete.</span></span><br><span class="line"></span><br><span class="line"><span class="string">./drivers/scsi/sd.c:</span><span class="string">sd_print_result(sdkp,</span> <span class="string">&quot;Synchronize Cache(10) failed&quot;</span><span class="string">,</span> <span class="string">res);</span></span><br><span class="line"><span class="string">https://www.suse.com/support/kb/doc/?id=000017385</span></span><br><span class="line"><span class="string"></span> <span class="string">driver_type</span> <span class="string"></span></span><br><span class="line"><span class="string">driver_byte,bit23bit31,8mid-level.DRIVER_SENSE,sense</span> <span class="string">data,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kernel:</span> [ <span class="number">7120.074184</span>] <span class="attr">mpt3sas_cm0:</span> <span class="string">removing</span> <span class="string">handle(0x000a),</span> <span class="string">sas_addr(0x5000cca251b21196)</span></span><br><span class="line"><span class="attr">kernel:</span> [ <span class="number">7120.074188</span>] <span class="attr">mpt3sas_cm0:</span> <span class="string">enclosure</span> <span class="string">logical</span> <span class="string">id(0x500304800927023f),</span> <span class="string">slot(0)</span></span><br><span class="line"><span class="attr">kernel:</span> [ <span class="number">7120.074189</span>] <span class="attr">mpt3sas_cm0:</span> <span class="string">enclosure</span> <span class="string">level(0x0000),connector</span> <span class="string">name(</span>     <span class="string">)</span></span><br><span class="line"><span class="attr">kernel: mpt3sas_cm0:</span> <span class="string">removing</span> <span class="string">handle(0x000a),</span> <span class="string">sas_addr(0x5000cca251b21196)</span></span><br><span class="line"><span class="attr">kernel: mpt3sas_cm0:</span> <span class="string">enclosure</span> <span class="string">logical</span> <span class="string">id(0x500304800927023f),</span> <span class="string">slot(0)</span></span><br><span class="line"><span class="attr">kernel: mpt3sas_cm0:</span> <span class="string">enclosure</span> <span class="string">level(0x0000),connector</span> <span class="string">name(</span>     <span class="string">)</span></span><br><span class="line"><span class="string">./drivers/scsi/mpt3sas/mpt3sas_scsih.c</span></span><br><span class="line"><span class="string">/**</span></span><br><span class="line"> <span class="string">*</span> <span class="string">_scsih_sas_device_remove</span> <span class="bullet">-</span> <span class="string">remove</span> <span class="string">sas_device</span> <span class="string">from</span> <span class="string">list.</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@ioc:</span> <span class="string">per</span> <span class="string">adapter</span> <span class="string">object</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@sas_device:</span> <span class="string">the</span> <span class="string">sas_device</span> <span class="string">object</span></span><br><span class="line"> <span class="string">*</span> <span class="attr">Context:</span> <span class="string">This</span> <span class="string">function</span> <span class="string">will</span> <span class="string">acquire</span> <span class="string">ioc-&gt;sas_device_lock.</span></span><br><span class="line"> <span class="string">*</span></span><br><span class="line"> <span class="string">*</span> <span class="string">If</span> <span class="string">sas_device</span> <span class="string">is</span> <span class="string">on</span> <span class="string">the</span> <span class="string">list,</span> <span class="string">remove</span> <span class="string">it</span> <span class="string">and</span> <span class="string">decrement</span> <span class="string">its</span> <span class="string">reference</span> <span class="string">count.</span></span><br><span class="line"> <span class="string">*/</span></span><br><span class="line"><span class="string">_scsih_probe_boot_devices</span></span><br><span class="line"><span class="string">_scsih_probe_sas</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">mpt3sas_send_trigger_data_event</span> <span class="string">(send</span> <span class="string">event</span> <span class="string">for</span> <span class="string">processing</span> <span class="string">trigger</span> <span class="string">data)</span></span><br><span class="line"><span class="string">_scsih_error_recovery_delete_devices</span> <span class="string">(remove</span> <span class="string">devices</span> <span class="string">not</span> <span class="string">responding)</span></span><br><span class="line"><span class="string">mpt3sas_port_enable_complete</span> <span class="string">(port</span> <span class="string">enable</span> <span class="string">completed</span> <span class="string">(fake</span> <span class="string">event))</span></span><br><span class="line"><span class="string">_scsih_send_event_to_turn_on_pfa_led</span> <span class="string">(fire</span> <span class="string">delayed</span> <span class="string">event)</span></span><br><span class="line"><span class="string">mpt3sas_scsih_event_callback</span> <span class="string">(firmware</span> <span class="string">event</span> <span class="string">handler</span> <span class="string">(called</span> <span class="string">at</span> <span class="string">ISR</span> <span class="string">time))</span></span><br><span class="line"><span class="string">This</span> <span class="string">function</span> <span class="string">merely</span> <span class="string">adds</span> <span class="string">a</span> <span class="string">new</span> <span class="string">work</span> <span class="string">task</span> <span class="string">into</span> <span class="string">ioc-&gt;firmware_event_thread,</span> <span class="string">The</span> <span class="string">tasks</span> <span class="string">are</span> <span class="string">worked</span> <span class="string">from</span> <span class="string">_firmware_event_work</span> <span class="string">in</span> <span class="string">user</span> <span class="string">context</span></span><br><span class="line">  <span class="string">_scsih_fw_event_add</span> <span class="string">(</span> <span class="string">This</span> <span class="string">adds</span> <span class="string">the</span> <span class="string">firmware</span> <span class="string">event</span> <span class="string">object</span> <span class="string">into</span> <span class="string">link</span> <span class="string">list,</span> <span class="string">then</span> <span class="string">queues</span> <span class="string">it</span> <span class="string">up</span> <span class="string">to</span> <span class="string">be</span> <span class="string">processed</span> <span class="string">from</span> <span class="string">user</span> <span class="string">context.)</span></span><br><span class="line">   <span class="string">_firmware_event_work</span> <span class="string">(wrappers</span> <span class="string">for</span> <span class="string">the</span> <span class="string">work</span> <span class="string">thread</span> <span class="string">handling</span> <span class="string">firmware</span> <span class="string">events)</span></span><br><span class="line">     <span class="string">This</span> <span class="string">function</span> <span class="string">merely</span> <span class="string">adds</span> <span class="string">a</span> <span class="string">new</span> <span class="string">work</span> <span class="string">task</span> <span class="string">into</span> <span class="string">ioc-&gt;firmware_event_thread.The</span> <span class="string">tasks</span> <span class="string">are</span> <span class="string">worked</span> <span class="string">from</span> <span class="string">_firmware_event_work</span> <span class="string">in</span> <span class="string">user</span> <span class="string">context.</span></span><br><span class="line"><span class="string">_mpt3sas_fw_work</span> <span class="string">(delayed</span> <span class="string">task</span> <span class="string">for</span> <span class="string">processing</span> <span class="string">firmware</span> <span class="string">events)</span></span><br><span class="line"><span class="string">MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST</span></span><br><span class="line"><span class="string">_scsih_sas_topology_change_event</span> <span class="string">(handle</span> <span class="string">topology</span> <span class="string">changes)</span></span><br><span class="line"><span class="string">_scsih_add_device</span></span><br><span class="line"><span class="string">creating</span> <span class="string">sas</span> <span class="string">device</span> <span class="string">object,</span> <span class="string">Creating</span> <span class="string">end</span> <span class="string">device</span> <span class="string">object,</span> <span class="string">stored</span> <span class="string">in</span> <span class="string">ioc-&gt;sas_device_list</span></span><br><span class="line"><span class="string">_scsih_sas_device_add</span></span><br><span class="line"><span class="string">_scsih_sas_device_remove</span></span><br><span class="line">        <span class="string">pr_info(MPT3SAS_FMT</span></span><br><span class="line">            <span class="string">&quot;removing handle(0x%04x), sas_addr(0x%016llx)\n&quot;</span><span class="string">,</span></span><br><span class="line">            <span class="string">ioc-&gt;name,</span> <span class="string">sas_device-&gt;handle,</span></span><br><span class="line">            <span class="string">(unsigned</span> <span class="string">long</span> <span class="string">long)</span> <span class="string">sas_device-&gt;sas_address);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">_scsih_scsi_ioc_info</span> <span class="string">(translated</span> <span class="string">non-succesfull</span> <span class="string">SCSI_IO</span> <span class="string">request)</span></span><br><span class="line"><span class="string">This</span> <span class="string">function</span> <span class="string">show</span> <span class="string">ioc</span> <span class="string">status</span> <span class="string">in</span> <span class="string">firmware</span></span><br><span class="line"></span><br><span class="line"><span class="string">_scsih_tm_tr_send</span> <span class="string">(send</span> <span class="string">task</span> <span class="string">management</span> <span class="string">request)</span></span><br><span class="line"> <span class="string">*</span> <span class="string">This</span> <span class="string">code</span> <span class="string">is</span> <span class="string">to</span> <span class="string">initiate</span> <span class="string">the</span> <span class="string">device</span> <span class="string">removal</span> <span class="string">handshake</span> <span class="string">protocol</span></span><br><span class="line"> <span class="string">*</span> <span class="string">with</span> <span class="string">controller</span> <span class="string">firmware.</span>  <span class="string">This</span> <span class="string">function</span> <span class="string">will</span> <span class="string">issue</span> <span class="string">target</span> <span class="string">reset</span></span><br><span class="line"> <span class="string">*</span> <span class="string">using</span> <span class="string">high</span> <span class="string">priority</span> <span class="string">request</span> <span class="string">queue.</span>  <span class="string">It</span> <span class="string">will</span> <span class="string">send</span> <span class="string">a</span> <span class="string">sas</span> <span class="string">iounit</span></span><br><span class="line"> <span class="string">*</span> <span class="string">control</span> <span class="string">request</span> <span class="string">(MPI2_SAS_OP_REMOVE_DEVICE)</span> <span class="string">from</span> <span class="string">this</span> <span class="string">completion.</span></span><br><span class="line"> <span class="string">*</span></span><br><span class="line"> <span class="string">*</span> <span class="string">This</span> <span class="string">is</span> <span class="string">designed</span> <span class="string">to</span> <span class="string">send</span> <span class="string">muliple</span> <span class="string">task</span> <span class="string">management</span> <span class="string">request</span> <span class="string">at</span> <span class="string">the</span> <span class="string">same</span></span><br><span class="line"> <span class="string">*</span> <span class="string">time</span> <span class="string">to</span> <span class="string">the</span> <span class="string">fifo.</span> <span class="string">If</span> <span class="string">the</span> <span class="string">fifo</span> <span class="string">is</span> <span class="string">full,</span> <span class="string">we</span> <span class="string">will</span> <span class="string">append</span> <span class="string">the</span> <span class="string">request,</span></span><br><span class="line"> <span class="string">*</span> <span class="string">and</span> <span class="string">process</span> <span class="string">it</span> <span class="string">in</span> <span class="string">a</span> <span class="string">future</span> <span class="string">completion.</span></span><br><span class="line"><span class="string">_scsih_tm_display_info</span> <span class="string">(displays</span> <span class="string">info</span> <span class="string">about</span> <span class="string">the</span> <span class="string">device)</span></span><br><span class="line"><span class="string">scsih_slave_configure</span> <span class="string">(device</span> <span class="string">configure</span> <span class="string">routine)</span></span><br><span class="line"> <span class="string">Returns</span> <span class="number">0</span> <span class="string">if</span> <span class="string">ok.</span> <span class="string">Any</span> <span class="string">other</span> <span class="string">return</span> <span class="string">is</span> <span class="string">assumed</span> <span class="string">to</span> <span class="string">be</span> <span class="string">an</span> <span class="string">error</span> <span class="string">and</span> <span class="string">the</span> <span class="string">device</span> <span class="string">is</span> <span class="string">ignored.</span></span><br><span class="line"><span class="string">_scsih_sas_device_init_add</span></span><br><span class="line"><span class="string">_scsih_sas_device_add</span></span><br><span class="line"><span class="string">_scsih_sas_device_remove</span></span><br><span class="line"><span class="string">_scsih_display_enclosure_chassis_info</span> <span class="string">(</span> <span class="string">device</span> <span class="string">location</span> <span class="string">info)</span></span><br><span class="line">                <span class="string">if</span> <span class="string">(sas_device-&gt;enclosure_handle</span> <span class="type">!=</span> <span class="number">0</span><span class="string">)</span></span><br><span class="line">                        <span class="string">sdev_printk(KERN_INFO,</span> <span class="string">sdev,</span></span><br><span class="line">                            <span class="string">&quot;enclosure logical id (0x%016llx), slot(%d) \n&quot;</span><span class="string">,</span></span><br><span class="line">                            <span class="string">(unsigned</span> <span class="string">long</span> <span class="string">long)</span></span><br><span class="line">                            <span class="string">sas_device-&gt;enclosure_logical_id,</span></span><br><span class="line">                            <span class="string">sas_device-&gt;slot);</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> scsi </tag>
            
            <tag> mpt3sas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>intel isdct</title>
      <link href="2018/08/07/isdct/"/>
      <url>2018/08/07/isdct/</url>
      
        <content type="html"><![CDATA[<h3 id="Show-all-info"><a href="#Show-all-info" class="headerlink" title="Show all info"></a>Show all info</h3><p><a href="https://www.intel.com/content/dam/support/us/en/documents/memory-and-storage/Intel_SSD_DCT_3_0_x_User_Guide.pdf">isdct</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">nvme</span> <span class="string">list</span></span><br><span class="line"><span class="string">Node</span>             <span class="string">SN</span>                   <span class="string">Model</span>                                    <span class="string">Namespace</span> <span class="string">Usage</span>                      <span class="string">Format</span>           <span class="string">FW</span> <span class="string">Rev</span></span><br><span class="line"><span class="string">----------------</span> <span class="string">--------------------</span> <span class="string">----------------------------------------</span> <span class="string">---------</span> <span class="string">--------------------------</span> <span class="string">----------------</span> <span class="string">--------</span></span><br><span class="line"><span class="string">/dev/nvme0n1</span>     <span class="string">FUKS731100771P5CGN</span>   <span class="string">INTEL</span> <span class="string">SSDPED1K015TA</span>                      <span class="number">1</span>           <span class="number">1.50</span>  <span class="string">TB</span> <span class="string">/</span>   <span class="number">1.50</span>  <span class="string">TB</span>    <span class="number">512</span>   <span class="string">B</span> <span class="string">+</span>  <span class="number">0</span> <span class="string">B</span>   <span class="string">E2010435</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">isdct</span>  <span class="string">show</span> <span class="string">-a</span> <span class="string">-intelssd</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="string">Intel</span> <span class="string">SSD</span> <span class="string">DC</span> <span class="string">S3510</span> <span class="string">Series</span> <span class="string">BTWA650406RK480FGN</span> <span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="attr">AccessibleMaxAddressSupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">AggregationThreshold :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">AggregationTime :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">ArbitrationBurst :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">CoalescingDisable :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">DIPMEnabled :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">DIPMSupported :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">DevicePath :</span> <span class="string">/dev/sg0</span></span><br><span class="line"><span class="attr">DeviceStatus :</span> <span class="string">Healthy</span></span><br><span class="line"><span class="attr">DigitalFenceSupported :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">DownloadMicrocodePossible :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">DynamicMMIOEnabled :</span> <span class="string">The</span> <span class="string">selected</span> <span class="string">drive</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">feature.</span></span><br><span class="line"><span class="attr">EDriveSupported :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">EnduranceAnalyzer :</span> <span class="number">7195.06 </span><span class="string">years</span></span><br><span class="line"><span class="attr">ErrorString :</span></span><br><span class="line"><span class="attr">Firmware :</span> <span class="string">G201DL2B</span></span><br><span class="line"><span class="attr">FirmwareActivationNoticesConfiguration :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">FirmwareUpdateAvailable :</span> <span class="string">Please</span> <span class="string">contact</span> <span class="string">your</span> <span class="string">Intel</span> <span class="string">representative</span> <span class="string">about</span> <span class="string">firmware</span> <span class="string">update</span> <span class="string">for</span> <span class="string">this</span> <span class="string">drive.</span></span><br><span class="line"><span class="attr">HDD :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">HighPriorityWeightArbitration :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">IOCompletionQueuesRequested :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">IOSubmissionQueuesRequested :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">Index :</span> <span class="number">1</span></span><br><span class="line"><span class="attr">Intel :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">IntelGen3SATA :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">IntelNVMe :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">InterruptVector :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">IsDualPort :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">LatencyTrackingEnabled :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">LowPriorityWeightArbitration :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">MaximumLBA :</span> <span class="number">937703087</span></span><br><span class="line"><span class="attr">MediumPriorityWeightArbitration :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">ModelNumber :</span> <span class="string">INTEL</span> <span class="string">SSDSC2BB480G6R</span></span><br><span class="line"><span class="attr">NVMePowerState :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">NamespaceAttributeNoticesConfiguration :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">NativeMaxLBA :</span> <span class="number">937703087</span></span><br><span class="line"><span class="attr">OEM :</span> <span class="string">Dell</span></span><br><span class="line"><span class="attr">PLITestTimeInterval :</span> <span class="number">10080</span> <span class="string">minutes</span></span><br><span class="line"><span class="attr">PhyConfig :</span> <span class="number">0</span> <span class="string">(Default</span> <span class="string">Enterprise</span> <span class="string">Settings)</span></span><br><span class="line"><span class="attr">PhySpeed :</span> <span class="number">6.0</span> <span class="string">Gbps</span></span><br><span class="line"><span class="attr">PhysicalSectorSize :</span> <span class="number">4096 </span><span class="string">bytes</span></span><br><span class="line"><span class="attr">PhysicalSize :</span> <span class="number">480103981056</span></span><br><span class="line"><span class="attr">PowerGovernorAveragePower :</span> <span class="number">8500 </span><span class="string">milliwatts</span></span><br><span class="line"><span class="attr">PowerGovernorBurstPower :</span> <span class="number">8500 </span><span class="string">milliwatts</span></span><br><span class="line"><span class="attr">PowerGovernorMode :</span> <span class="number">0</span> <span class="string">Unconstrained.</span> <span class="string">Limited</span> <span class="string">by</span> <span class="string">maximum</span> <span class="string">budget</span></span><br><span class="line"><span class="attr">Product :</span> <span class="string">HaleyvilleSE</span> <span class="string">L95</span></span><br><span class="line"><span class="attr">ProductFamily :</span> <span class="string">Intel</span> <span class="string">SSD</span> <span class="string">DC</span> <span class="string">S3510</span> <span class="string">Series</span></span><br><span class="line"><span class="attr">ProductProtocol :</span> <span class="string">ATA</span></span><br><span class="line"><span class="attr">ReadErrorRecoveryTimer :</span> <span class="number">80</span></span><br><span class="line"><span class="attr">RemoteSecureEraseSupported :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">SMARTEnabled :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SMARTHealthCriticalWarningsConfiguration :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">SMARTSelfTestSupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SMBusAddress :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">SMI :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">SSCEnabled :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">SanitizeBlockEraseSupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SanitizeCryptoScrambleSupported :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">SanitizeSupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SataGen1 :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SataGen2 :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SataGen3 :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SataNegotiatedSpeed :</span> <span class="number">6.0</span> <span class="string">Gbs</span></span><br><span class="line"><span class="attr">SectorSize :</span> <span class="number">512</span></span><br><span class="line"><span class="attr">SecurityEnabled :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">SecurityFrozen :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SecurityLocked :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">SecuritySupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">SerialNumber :</span> <span class="string">xxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">TCGSupported :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">TelemetryLogNoticesConfiguration :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">TelemetryLogSupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">TempThreshold :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">TemperatureLoggingInterval :</span> <span class="number">1</span> <span class="string">minute(s)</span></span><br><span class="line"><span class="attr">ThermalThrottleEnabled :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">TimeLimitedErrorRecovery :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">TrimSize :</span> <span class="number">4</span></span><br><span class="line"><span class="attr">TrimSupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">VolatileWriteCacheEnabled :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">WWID :</span> <span class="number">934300737939264973</span></span><br><span class="line"><span class="attr">WriteAtomicityDisableNormal :</span> <span class="string">Device</span> <span class="string">does</span> <span class="string">not</span> <span class="string">support</span> <span class="string">this</span> <span class="string">command</span> <span class="string">set.</span></span><br><span class="line"><span class="attr">WriteCacheEnabled :</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">WriteCacheReorderingStateEnabled :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">WriteCacheState :</span> <span class="number">1</span></span><br><span class="line"><span class="attr">WriteCacheSupported :</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">WriteErrorRecoveryTimer :</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h4 id="Enable-write-cache"><a href="#Enable-write-cache" class="headerlink" title="Enable write cache"></a>Enable write cache</h4><p>1: Write cache state is determined by ATA Set Features<br>2: Write cache is enabled.<br>3: Write cache is disabled.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ isdct <span class="built_in">set</span> -intelssd 1 WriteCacheState=3</span><br><span class="line">Set WriteCacheState successful. Completed successfully.</span><br><span class="line"></span><br><span class="line">$ isdct  show -a -intelssd 1  | grep -i writecache</span><br><span class="line">VolatileWriteCacheEnabled : Device does not support this <span class="built_in">command</span> <span class="built_in">set</span>.</span><br><span class="line">WriteCacheEnabled : False</span><br><span class="line">WriteCacheReorderingStateEnabled : True</span><br><span class="line">WriteCacheState : 3</span><br><span class="line">WriteCacheSupported : True</span><br><span class="line"></span><br><span class="line">$ isdct <span class="built_in">set</span> -intelssd 1 WriteCacheState=2</span><br><span class="line">Set WriteCacheState successful. Completed successfully.</span><br><span class="line"></span><br><span class="line">$ isdct  show -a -intelssd 1  | grep -i writecache</span><br><span class="line">VolatileWriteCacheEnabled : Device does not support this <span class="built_in">command</span> <span class="built_in">set</span>.</span><br><span class="line">WriteCacheEnabled : True</span><br><span class="line">WriteCacheReorderingStateEnabled : True</span><br><span class="line">WriteCacheState : 2</span><br><span class="line">WriteCacheSupported : True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## I don &#x27;t know why &quot;WriteCacheEnabled&quot; not work....</span></span><br><span class="line"></span><br><span class="line">$ isdct <span class="built_in">set</span> -intelssd 1 WriteCacheEnabled=<span class="literal">false</span></span><br><span class="line">Set WriteCacheEnabled successful. Completed successfully.</span><br><span class="line"></span><br><span class="line">$ isdct  show -a -intelssd 1  | grep -i writecache</span><br><span class="line">VolatileWriteCacheEnabled : Device does not support this <span class="built_in">command</span> <span class="built_in">set</span>.</span><br><span class="line">WriteCacheEnabled : True</span><br><span class="line">WriteCacheReorderingStateEnabled : True</span><br><span class="line">WriteCacheState : 2</span><br><span class="line">WriteCacheSupported : True</span><br></pre></td></tr></table></figure><h4 id="Trim-feature"><a href="#Trim-feature" class="headerlink" title="Trim feature"></a>Trim feature</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ isdct  show -a -intelssd 1  | grep -i TrimSupported</span><br><span class="line">TrimSupported : True</span><br></pre></td></tr></table></figure><h4 id="Intel-ssd-secure-erase"><a href="#Intel-ssd-secure-erase" class="headerlink" title="Intel ssd secure erase"></a>Intel ssd secure erase</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">isdct  show -intelssd 5</span><br><span class="line">- Intel Optane(TM) SSD DC P4800X Series PHKS7413003T375AGN -</span><br><span class="line"></span><br><span class="line">Bootloader : EB3B0306</span><br><span class="line">DevicePath : /dev/nvme5n1</span><br><span class="line">DeviceStatus : Healthy</span><br><span class="line">Firmware : E2010324</span><br><span class="line">FirmwareUpdateAvailable : The selected Intel SSD contains current firmware as of this tool release.</span><br><span class="line">Index : 5</span><br><span class="line"></span><br><span class="line">isdct  start -nvmeformat -intelssd 5 SecureEraseSetting = 0</span><br><span class="line">isdct delete  -intelssd 5</span><br><span class="line">isdct  start -nvmeformat -intelssd 5</span><br></pre></td></tr></table></figure><h4 id="get-smart"><a href="#get-smart" class="headerlink" title="get smart"></a>get smart</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ isdct  show -smart -intelssd 0</span><br></pre></td></tr></table></figure><h4 id="intel-nvme-switch-to-AF"><a href="#intel-nvme-switch-to-AF" class="headerlink" title="intel nvme switch to AF"></a>intel nvme switch to AF</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#change 512 Bytes to 4096 Bytes</span></span><br><span class="line">$ isdct start -intelssd 0 Function=NVMEFormat LBAForma=3 SecureEraseSetting=0 ProtectionInformation=0 MetaDataSetting=0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssd </tag>
            
            <tag> isdct </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>numa</title>
      <link href="2018/08/06/numa/"/>
      <url>2018/08/06/numa/</url>
      
        <content type="html"><![CDATA[<h3 id="Get-hardware-status-from-numactl"><a href="#Get-hardware-status-from-numactl" class="headerlink" title="Get hardware status from numactl"></a>Get hardware status from numactl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ lspci -tvv</span><br><span class="line"> \-[0000:00]-+-00.0  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D DMI2</span><br><span class="line">             +-01.0-[01-02]----00.0  LSI Logic / Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3</span><br><span class="line">             +-02.0-[03-04]--+-00.0  Intel Corporation Ethernet Controller X710 <span class="keyword">for</span> 10GbE SFP+</span><br><span class="line">             |               \-00.1  Intel Corporation Ethernet Controller X710 <span class="keyword">for</span> 10GbE SFP+</span><br><span class="line">             +-02.2-[05-06]--+-00.0  Intel Corporation Ethernet Controller 10-Gigabit X540-AT2</span><br><span class="line">             |               \-00.1  Intel Corporation Ethernet Controller 10-Gigabit X540-AT2</span><br><span class="line">             +-03.0-[07]--</span><br><span class="line">             +-03.2-[08]----00.0  Intel Corporation I210 Gigabit Network Connection</span><br><span class="line">             +-04.0  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 0</span><br><span class="line">             +-04.1  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 1</span><br><span class="line">             +-04.2  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 2</span><br><span class="line">             +-04.3  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 3</span><br><span class="line">             +-04.4  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 4</span><br><span class="line">             +-04.5  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 5</span><br><span class="line">             +-04.6  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 6</span><br><span class="line">             +-04.7  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Crystal Beach DMA Channel 7</span><br><span class="line">             +-05.0  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D Map/VTd_Misc/System Management</span><br><span class="line">             +-05.1  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D IIO Hot Plug</span><br><span class="line">             +-05.2  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D IIO RAS/Control Status/Global Errors</span><br><span class="line">             +-05.4  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D I/O APIC</span><br><span class="line">             +-11.0  Intel Corporation C610/X99 series chipset SPSR</span><br><span class="line">             +-11.3  Intel Corporation C610/X99 series chipset MS SMBus 2</span><br><span class="line">             +-11.4  Intel Corporation C610/X99 series chipset sSATA Controller [AHCI mode]</span><br><span class="line">             +-14.0  Intel Corporation C610/X99 series chipset USB xHCI Host Controller</span><br><span class="line">             +-16.0  Intel Corporation C610/X99 series chipset MEI Controller <span class="comment">#1</span></span><br><span class="line">             +-16.1  Intel Corporation C610/X99 series chipset MEI Controller <span class="comment">#2</span></span><br><span class="line">             +-1a.0  Intel Corporation C610/X99 series chipset USB Enhanced Host Controller <span class="comment">#2</span></span><br><span class="line">             +-1c.0-[09]--</span><br><span class="line">             +-1c.2-[0a-0b]----00.0-[0b]----00.0  ASPEED Technology, Inc. ASPEED Graphics Family</span><br><span class="line">             +-1d.0  Intel Corporation C610/X99 series chipset USB Enhanced Host Controller <span class="comment">#1</span></span><br><span class="line">             +-1f.0  Intel Corporation C610/X99 series chipset LPC Controller</span><br><span class="line">             +-1f.2  Intel Corporation C610/X99 series chipset 6-Port SATA Controller [AHCI mode]</span><br><span class="line">             +-1f.3  Intel Corporation C610/X99 series chipset SMBus Controller</span><br><span class="line">             \-1f.6  Intel Corporation C610/X99 series chipset Thermal Subsystem</span><br><span class="line"></span><br><span class="line">$ numactl --prefer pci:0000:00:01.0 --show</span><br><span class="line">policy: preferred</span><br><span class="line">preferred node: 0</span><br><span class="line">physcpubind: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</span><br><span class="line">cpubind: 0 1</span><br><span class="line">nodebind: 0 1</span><br><span class="line">membind: 0 1</span><br><span class="line"></span><br><span class="line">$ numactl --prefer pci:0000:00:02.0-04 --show</span><br><span class="line">policy: preferred</span><br><span class="line">preferred node: 0</span><br><span class="line">physcpubind: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</span><br><span class="line">cpubind: 0 1</span><br><span class="line">nodebind: 0 1</span><br><span class="line">membind: 0 1</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="show-status"><a href="#show-status" class="headerlink" title="show status"></a>show status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg -T | grep numa -i</span><br><span class="line">[Mon Aug  6 19:40:25 2018] No NUMA configuration found</span><br><span class="line">[Mon Aug  6 19:41:05 2018] pci_bus 0000:00: on NUMA node 0</span><br><span class="line"></span><br><span class="line">$ numastat</span><br><span class="line">                           node0</span><br><span class="line">numa_hit                 2614819</span><br><span class="line">numa_miss                      0</span><br><span class="line">numa_foreign                   0</span><br><span class="line">interleave_hit           1649936</span><br><span class="line">local_node               2614819</span><br><span class="line">other_node                     0</span><br><span class="line"></span><br><span class="line">If ACPI is disabled, that will also <span class="built_in">disable</span> NUMA; verify that ACPI is not disabled by a grub.conf kernel parameter and remove it <span class="keyword">if</span> found</span><br><span class="line">be careful you have not <span class="built_in">disable</span> ACPI <span class="keyword">in</span> BIOS, <span class="keyword">if</span> you don <span class="string">&#x27;t know how to do, please reset the BIOS to default setting.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># reset the BIOS to default</span></span><br><span class="line"><span class="string">$ numastat</span></span><br><span class="line"><span class="string">                           node0           node1           node2           node3</span></span><br><span class="line"><span class="string">numa_hit                 8998488         9332734         8955045         9799005</span></span><br><span class="line"><span class="string">numa_miss                      0               0               0               0</span></span><br><span class="line"><span class="string">numa_foreign                   0               0               0               0</span></span><br><span class="line"><span class="string">interleave_hit            412304          412624          412322          412620</span></span><br><span class="line"><span class="string">local_node               8996406         8912288         8534168         9378404</span></span><br><span class="line"><span class="string">other_node                  2082          420446          420877          420601</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ numactl --hardware</span></span><br><span class="line"><span class="string">available: 4 nodes (0-3)</span></span><br><span class="line"><span class="string">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74</span></span><br><span class="line"><span class="string">node 0 size: 786305 MB</span></span><br><span class="line"><span class="string">node 0 free: 768918 MB</span></span><br><span class="line"><span class="string">node 1 cpus: 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89</span></span><br><span class="line"><span class="string">node 1 size: 786432 MB</span></span><br><span class="line"><span class="string">node 1 free: 768579 MB</span></span><br><span class="line"><span class="string">node 2 cpus: 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104</span></span><br><span class="line"><span class="string">node 2 size: 786432 MB</span></span><br><span class="line"><span class="string">node 2 free: 769063 MB</span></span><br><span class="line"><span class="string">node 3 cpus: 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119</span></span><br><span class="line"><span class="string">node 3 size: 786432 MB</span></span><br><span class="line"><span class="string">node 3 free: 766922 MB</span></span><br><span class="line"><span class="string">node distances:</span></span><br><span class="line"><span class="string">node   0   1   2   3</span></span><br><span class="line"><span class="string">  0:  10  21  21  21</span></span><br><span class="line"><span class="string">  1:  21  10  21  21</span></span><br><span class="line"><span class="string">  2:  21  21  10  21</span></span><br><span class="line"><span class="string">  3:  21  21  21  10</span></span><br></pre></td></tr></table></figure><h4 id="Interleave-mode"><a href="#Interleave-mode" class="headerlink" title="Interleave mode"></a>Interleave mode</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm.zone_reclaim_mode = 0 <span class="comment">## default,could use remote numa memroy</span></span><br><span class="line">numactl --interleave=all ./your_script</span><br></pre></td></tr></table></figure><h4 id="disable-numa-in-grub"><a href="#disable-numa-in-grub" class="headerlink" title="disable numa in grub"></a>disable numa in grub</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rhgb quiet numa=off</span><br></pre></td></tr></table></figure><h4 id="Get-your-process-info-about-numa"><a href="#Get-your-process-info-about-numa" class="headerlink" title="Get your process info about numa"></a>Get your process info about numa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `pidof qemu-kvm`; <span class="keyword">do</span> cat /proc/<span class="variable">$i</span>/status | grep -E <span class="string">&#x27;Cpus_allowed_list|Mems_allowed_list&#x27;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="numad-service"><a href="#numad-service" class="headerlink" title="numad service"></a>numad service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf install numad</span><br><span class="line">systemctl <span class="built_in">enable</span> numad</span><br><span class="line">systemctl start numad</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpu </tag>
            
            <tag> memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pcie debug</title>
      <link href="2018/07/29/pcie/"/>
      <url>2018/07/29/pcie/</url>
      
        <content type="html"><![CDATA[<h3 id="PCIE-error-handling"><a href="#PCIE-error-handling" class="headerlink" title="PCIE error handling"></a><a href="https://wiki.opnfv.org/display/fastpath/PCIe+Errors+High+Level+Design">PCIE error handling</a></h3><p>The purpose of this feature is to monitor and report PCI Express errors. There are two mechanisms for error handling. First is base line which is mandatory for every PCIe device, but provides only limited information as there are only four error types. It resides in Device Status register of PCI Express capability. The second is extended capability with Advance Error Reporting. It can provide detailed information about errors set on device. Its occurrence is optional, and not every device provides this extended information.</p><a id="more"></a><h3 id="Advance-Error-Reporting-support"><a href="#Advance-Error-Reporting-support" class="headerlink" title="Advance Error Reporting support"></a>Advance Error Reporting support</h3><h4 id="BIOS-setting"><a href="#BIOS-setting" class="headerlink" title="BIOS setting"></a><a href="https://docs.oracle.com/cd/E20815_01/html/E20818/gqkje.html">BIOS setting</a></h4><h4 id="Enable-in-82599"><a href="#Enable-in-82599" class="headerlink" title="Enable in 82599"></a><a href="https://access.redhat.com/solutions/150063">Enable in 82599</a></h4><h5 id="example"><a href="#example" class="headerlink" title="example"></a><a href="https://git.kernel.org/pub/scm/linux/kernel/git/gong.chen/aer-inject.git/tree/examples/">example</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Settings &gt; Chipset &gt; NorthBridge Configuration and change:</span><br><span class="line">PCIE-MMIO-64 Bits Support to Enabled</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ lspci -vvv -s 02:00.0 | grep -i advance</span><br><span class="line">Capabilities: [100 v2] Advanced Error Reporting</span><br><span class="line"><span class="comment">#The example of Device Status and AER registers obtained with lspci:</span></span><br><span class="line"></span><br><span class="line">$ cat aer</span><br><span class="line">AER</span><br><span class="line">BUS 2 DEV 0 FN 0</span><br><span class="line">COR_STATUS BAD_TLP</span><br><span class="line">HEADER_LOG 0 1 2 3</span><br><span class="line"></span><br><span class="line">$ yum install ras-utils</span><br><span class="line">$ modprobe aer-inject</span><br><span class="line">$ aer-inject aer</span><br><span class="line">[Sun Jul 29 17:20:44 2018] ixgbe 0000:02:00.0: invalid short VPD tag 06 at offset 4</span><br><span class="line">[Sun Jul 29 17:21:45 2018] pcieport 0000:00:02.0: AER: Corrected error received: id=0200</span><br><span class="line">[Sun Jul 29 17:21:45 2018] ixgbe 0000:02:00.0: PCIe Bus Error: severity=Corrected, <span class="built_in">type</span>=Data Link Layer, id=0200(Receiver ID)</span><br><span class="line">[Sun Jul 29 17:21:45 2018] ixgbe 0000:02:00.0:   device [8086:10fb] error status/mask=00000040/00002000</span><br><span class="line">[Sun Jul 29 17:21:45 2018] ixgbe 0000:02:00.0:    [ 6] Bad TLP</span><br></pre></td></tr></table></figure><h4 id="config-example"><a href="#config-example" class="headerlink" title="config example"></a><a href="https://kernel.googlesource.com/pub/scm/linux/kernel/git/gong.chen/aer-inject/+/master/examples">config example</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">$ cat mixed-corr-nonfatal</span><br><span class="line"><span class="comment"># Simultaneously inject a correctable bad TLP and an</span></span><br><span class="line"><span class="comment"># uncorrectable/non-fatal completion abort error into the device with header</span></span><br><span class="line"><span class="comment"># log words 0 1 2 3.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Either specify the PCI id on the command-line option or uncomment and edit</span></span><br><span class="line"><span class="comment"># the PCI_ID line below using the correct PCI ID.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that system firmware/BIOS may mask certain errors, change their severity</span></span><br><span class="line"><span class="comment"># and/or not report header log words.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># PCI_ID [WWWW:]XX.YY.Z</span></span><br><span class="line">COR_STATUS BAD_TLP</span><br><span class="line">UNCOR_STATUS COMP_ABORT</span><br><span class="line">HEADER_LOG 0 1 2 3</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line"></span><br><span class="line">$ cat fatal</span><br><span class="line"><span class="comment"># Inject an uncorrectable/fatal malformed TLP error into the device</span></span><br><span class="line"><span class="comment"># with header log words 0 1 2 3.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Either specify the PCI id on the command-line option or uncomment and edit</span></span><br><span class="line"><span class="comment"># the PCI_ID line below using the correct PCI ID.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that system firmware/BIOS may mask certain errors, change their severity</span></span><br><span class="line"><span class="comment"># and/or not report header log words.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># PCI_ID [WWWW:]XX.YY.Z</span></span><br><span class="line">UNCOR_STATUS MALF_TLP</span><br><span class="line">HEADER_LOG 0 1 2 3</span><br><span class="line"></span><br><span class="line">$ cat correctable</span><br><span class="line"><span class="comment"># Inject a correctable bad TLP error into the device with header log</span></span><br><span class="line"><span class="comment"># words 0 1 2 3.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Either specify the PCI id on the command-line option or uncomment and edit</span></span><br><span class="line"><span class="comment"># the PCI_ID line below using the correct PCI ID.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that system firmware/BIOS may mask certain errors and/or not report</span></span><br><span class="line"><span class="comment"># header log words.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># PCI_ID [WWWW:]XX.YY.Z</span></span><br><span class="line">COR_STATUS BAD_TLP</span><br><span class="line">HEADER_LOG 0 1 2 3</span><br><span class="line"></span><br><span class="line">-------------------------------</span><br><span class="line"></span><br><span class="line">$ cat multiple-corr-nonfatal</span><br><span class="line"><span class="comment"># Sequentially inject a correctable bad TLP and a</span></span><br><span class="line"><span class="comment"># uncorrectable/non-fatal completion abort error into the device with header</span></span><br><span class="line"><span class="comment"># various header log words.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Either specify the PCI id on the command-line option or uncomment and edit</span></span><br><span class="line"><span class="comment"># the PCI_ID line below using the correct PCI ID.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that system firmware/BIOS may mask certain errors, change their severity</span></span><br><span class="line"><span class="comment"># and/or not report header log words.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># PCI_ID [WWWW:]XX.YY.Z</span></span><br><span class="line">COR_STATUS BAD_TLP</span><br><span class="line">HEADER_LOG 0 1 2 3</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># PCI_ID [WWWW:]XX.YY.Z</span></span><br><span class="line">UNCOR_STATUS COMP_ABORT</span><br><span class="line">HEADER_LOG 4 5 6 7</span><br><span class="line"></span><br><span class="line">---------------------------</span><br><span class="line"></span><br><span class="line">$ cat syntax-variations</span><br><span class="line"><span class="comment"># Variations in syntax</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Either specify the PCI id on the command-line option or uncomment and edit</span></span><br><span class="line"><span class="comment"># the PCI_ID line below using the correct PCI ID.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We can use lower-case:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">aer</span><br><span class="line"><span class="comment"># pci_id [WWWW:]XX.YY.Z</span></span><br><span class="line">cor_status rcvr</span><br><span class="line">header_log 0 1 2 3</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We can use aliases for key words:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># ID [WWWW:]XX.YY.Z</span></span><br><span class="line">COR BAD_TLP</span><br><span class="line">HL 4 5 6 7</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We can put multiple errors on the same line and use octal and hexadecimal</span></span><br><span class="line"><span class="comment"># numbers:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># PCI_ID [WWWW:]XX.YY.Z</span></span><br><span class="line">COR_STATUS BAD_DLLP REP_ROLL</span><br><span class="line">HEADER_LOG 010 0x9 0xa 0xB</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We can use defaults:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER</span><br><span class="line"><span class="comment"># PCI_ID [WWWW:]XX.YY.Z</span></span><br><span class="line">COR_STATUS REP_TIMER</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Newlines are ignored and the PCI ID can be specified on the command-line.</span></span><br><span class="line"><span class="comment"># We can also use raw numbers for the error:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AER COR_STATUS 0x2 HEADER_LOG 0 1 2 3</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pcie_ports=native</span><br><span class="line"></span><br><span class="line">pcie_ports=     [PCIE] PCIe ports handling:</span><br><span class="line">                auto    Ask the BIOS whether or not to use native PCIe services</span><br><span class="line">                        associated with PCIe ports (PME, hot-plug, AER).  Use</span><br><span class="line">                        them only <span class="keyword">if</span> that is allowed by the BIOS.</span><br><span class="line">                native  Use native PCIe services associated with PCIe ports</span><br><span class="line">                        unconditionally.</span><br><span class="line">                compat  Treat PCIe ports as PCI-to-PCI bridges, <span class="built_in">disable</span> the PCIe</span><br><span class="line">                        ports driver.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pci </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>storage benchmark</title>
      <link href="2018/07/12/storage_benchmark/"/>
      <url>2018/07/12/storage_benchmark/</url>
      
        <content type="html"><![CDATA[<h3 id="Block-benchmark-trap"><a href="#Block-benchmark-trap" class="headerlink" title="Block benchmark trap"></a>Block benchmark trap</h3><p>fio sequential write in the same device block cause the test result too high</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[rw]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=posixaio</span><br><span class="line">iodepth=4</span><br><span class="line">nrfiles=8</span><br><span class="line">bssplit=1M/100</span><br><span class="line">direct=1</span><br><span class="line">filename=/dev/sdb1</span><br><span class="line">numjobs=4</span><br><span class="line">size=2000G</span><br></pre></td></tr></table></figure><a id="more"></a><p>For avoid this issue, and I don t know why I have to wait after 10% test process, the speed will from 4GB/s down to 1.6GB/s<br>If you use fio test raw device, you d better set numjobs=1, single core is enough</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=posixaio</span><br><span class="line">iodepth=4</span><br><span class="line">nrfiles=8</span><br><span class="line">bssplit=1M/100</span><br><span class="line">direct=1</span><br><span class="line">filename=/dev/sdb1</span><br><span class="line">numjobs=1</span><br><span class="line">size=2000G</span><br><span class="line">zonemode=strided</span><br><span class="line">zonesize=100G</span><br><span class="line"></span><br><span class="line">[job1]</span><br><span class="line">zoneskip=1000G</span><br><span class="line">[job1]</span><br><span class="line">zoneskip=2000G</span><br><span class="line">[job3]</span><br><span class="line">zoneskip=3000G</span><br><span class="line">[job4]</span><br><span class="line">zoneskip=4000G</span><br><span class="line"></span><br><span class="line">job1: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=posixaio, iodepth=4</span><br><span class="line">job1: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=posixaio, iodepth=4</span><br><span class="line">job3: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=posixaio, iodepth=4</span><br><span class="line">job4: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=posixaio, iodepth=4</span><br><span class="line">fio-3.16</span><br><span class="line">Starting 4 processes</span><br><span class="line">Jobs: 4 (f=4): [W(4)][10.2%][w=1648MiB/s][w=1647 IOPS][eta 49m:02s]</span><br><span class="line"></span><br><span class="line"><span class="comment"># dd version to reproduce</span></span><br><span class="line"><span class="keyword">for</span> ((i=0;i&lt;=3200000; i=i+100000)); <span class="keyword">do</span> dd <span class="keyword">if</span>=/dev/zero of=/dev/sdb1 bs=1M seek=<span class="variable">$i</span> oflag=direct &amp; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>The two test function could help you get diff information</p><h3 id="Install-sysbench-0-5"><a href="#Install-sysbench-0-5" class="headerlink" title="Install sysbench 0.5"></a>Install sysbench 0.5</h3><p>OS version: CentOS 7</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/mysql &amp;&amp; mount /dev/sdb1 /var/lib/mysql</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deadline&quot;</span> &gt; /sys/class/block/sdb/queue/scheduler</span><br><span class="line">yum install git automake libtool</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/hgxl64/sysbench-mariadb.git</span><br><span class="line"><span class="built_in">cd</span> sysbench-mariadb</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line"><span class="built_in">cd</span> sysbech/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:$(<span class="built_in">pwd</span>)/</span><br><span class="line">sysbench --version</span><br><span class="line">sysbench 0.5</span><br></pre></td></tr></table></figure><h3 id="Install-mariadb"><a href="#Install-mariadb" class="headerlink" title="Install mariadb"></a>Install mariadb</h3><p><a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=syringa&distro=CentOS&distro_release=centos7-amd64--centos7&version=10.1">MariaDB.repo</a></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MariaDB 10.1 CentOS repository list - created 2016-03-02 02:05 UTC</span></span><br><span class="line"><span class="comment"># http://mariadb.org/mariadb/repositories/</span></span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = <span class="symbol">http:</span>/<span class="regexp">/yum.mariadb.org/</span><span class="number">10.1</span>/centos7-amd64</span><br><span class="line">gpgkey=<span class="symbol">https:</span>/<span class="regexp">/yum.mariadb.org/</span>RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">yum install mariadb-server mariadb-client mariadb-devel</span><br></pre></td></tr></table></figure><h4 id="limit-conf"><a href="#limit-conf" class="headerlink" title="limit.conf"></a>limit.conf</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*               soft    nofile           <span class="number">20000</span></span><br><span class="line">*               hard    nofile           <span class="number">20000</span></span><br><span class="line">*               soft    nproc            <span class="number">20000</span></span><br><span class="line">*               hard    nproc            <span class="number">20000</span></span><br></pre></td></tr></table></figure><h4 id="my-cnf-ubuntu-16-04-mariadb-10-1"><a href="#my-cnf-ubuntu-16-04-mariadb-10-1" class="headerlink" title="my.cnf (ubuntu 16.04, mariadb 10.1)"></a>my.cnf (ubuntu 16.04, mariadb 10.1)</h4><figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">cat</span> /etc/mysql/my.cnf | grep -v \#</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"><span class="attribute">port</span>= <span class="number">3306</span></span><br><span class="line"><span class="attribute">socket</span>= /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="attribute">socket</span>= /var/run/mysqld/mysqld.sock</span><br><span class="line"><span class="attribute">nice</span>= <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">user</span>= mysql</span><br><span class="line"><span class="attribute">pid</span>-file= /var/run/mysqld/mysqld.pid</span><br><span class="line"><span class="attribute">socket</span>= /var/run/mysqld/mysqld.sock</span><br><span class="line"><span class="attribute">port</span>= <span class="number">3306</span></span><br><span class="line"><span class="attribute">basedir</span>= /usr</span><br><span class="line"><span class="attribute">datadir</span>= /var/lib/mysql</span><br><span class="line"><span class="attribute">tmpdir</span>= /tmp</span><br><span class="line"><span class="attribute">lc_messages_dir</span>= /usr/share/mysql</span><br><span class="line"><span class="attribute">lc_messages</span>= en_US</span><br><span class="line"><span class="attribute">skip</span>-external-locking</span><br><span class="line"><span class="attribute">bind</span>-address= <span class="number">127.0.0.1</span></span><br><span class="line"><span class="attribute">max_connections</span>= <span class="number">1024</span></span><br><span class="line"><span class="attribute">connect_timeout</span>= <span class="number">60</span></span><br><span class="line"><span class="attribute">wait_timeout</span>= <span class="number">600</span></span><br><span class="line"><span class="attribute">max_allowed_packet</span>= <span class="number">16</span>M</span><br><span class="line"><span class="attribute">thread_cache_size</span>       = <span class="number">128</span></span><br><span class="line"><span class="attribute">sort_buffer_size</span>= <span class="number">4</span>M</span><br><span class="line"><span class="attribute">bulk_insert_buffer_size</span>= <span class="number">16</span>M</span><br><span class="line"><span class="attribute">tmp_table_size</span>= <span class="number">32</span>M</span><br><span class="line"><span class="attribute">max_heap_table_size</span>= <span class="number">32</span>M</span><br><span class="line"><span class="attribute">myisam_recover_options</span> = BACKUP</span><br><span class="line"><span class="attribute">key_buffer_size</span>= <span class="number">8</span>M</span><br><span class="line"><span class="attribute">table_open_cache</span>= <span class="number">800</span></span><br><span class="line"><span class="attribute">myisam_sort_buffer_size</span>= <span class="number">512</span>M</span><br><span class="line"><span class="attribute">concurrent_insert</span>= <span class="number">2</span></span><br><span class="line"><span class="attribute">general_log</span>             = <span class="number">0</span></span><br><span class="line"><span class="attribute">log_warnings</span>= <span class="number">2</span></span><br><span class="line"><span class="attribute">slow_query_log_file</span>= /var/log/mysql/mariadb-slow.log</span><br><span class="line"><span class="attribute">long_query_time</span> = <span class="number">60</span></span><br><span class="line"><span class="attribute">log_slow_verbosity</span>= query_plan</span><br><span class="line"></span><br><span class="line"><span class="comment">#log_bin= /var/log/mysql/mariadb-bin</span></span><br><span class="line"><span class="comment">#log_bin_index= /var/log/mysql/mariadb-bin.index</span></span><br><span class="line"><span class="comment">#expire_logs_days= 10</span></span><br><span class="line"><span class="comment">#max_binlog_size         = 100M</span></span><br><span class="line"><span class="comment">#diable /var/log/mysql bin-logs</span></span><br><span class="line"><span class="attribute">skip</span>-log-bin</span><br><span class="line"><span class="attribute">default_storage_engine</span>= InnoDB</span><br><span class="line"><span class="attribute">innodb_log_file_size</span>= <span class="number">50</span>M</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>= <span class="number">256</span>M</span><br><span class="line"><span class="attribute">innodb_log_buffer_size</span>= <span class="number">16</span>M</span><br><span class="line"><span class="attribute">innodb_file_per_table</span>= true</span><br><span class="line"><span class="attribute">innodb_open_files</span>= <span class="number">4000</span></span><br><span class="line"><span class="attribute">innodb_io_capacity</span>= <span class="number">4000</span></span><br><span class="line"><span class="attribute">innodb_lru_scan_depth</span>   = <span class="number">4000</span></span><br><span class="line"><span class="attribute">innodb_flush_method</span>= O_DIRECT</span><br><span class="line"><span class="attribute">innodb_use_trim</span>=<span class="literal">ON</span></span><br><span class="line"><span class="attribute">innodb_use_fallocate</span>=<span class="literal">ON</span></span><br><span class="line"><span class="attribute">innodb_page_size</span>=<span class="number">16</span>k</span><br><span class="line"><span class="attribute">innodb_thread_concurrency</span>=<span class="number">0</span></span><br><span class="line"><span class="attribute">innodb_write_io_threads</span>=<span class="number">24</span></span><br><span class="line"><span class="attribute">innodb_read_io_threads</span>=<span class="number">24</span></span><br><span class="line"><span class="attribute">innodb_buffer_pool_instances</span>=<span class="number">16</span></span><br><span class="line"><span class="attribute">innodb_mtflush_threads</span>=<span class="number">16</span></span><br><span class="line"><span class="attribute">innodb_doublewrite</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">[galera]</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line"><span class="attribute">quick</span></span><br><span class="line"><span class="attribute">quote</span>-names</span><br><span class="line"><span class="attribute">max_allowed_packet</span>= <span class="number">16</span>M</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">[isamchk]</span><br><span class="line"><span class="attribute">key_buffer</span>= <span class="number">16</span>M</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">ulimit</span> -n <span class="number">20000</span></span><br><span class="line"><span class="attribute">mysqld_safe</span> --defaults-file=/etc/my.cnf</span><br><span class="line"><span class="attribute">mysql</span> -u root -e <span class="string">&quot;create database sbtest&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Run-benchmark"><a href="#Run-benchmark" class="headerlink" title="Run benchmark"></a>Run benchmark</h4><p>If you have password, please add mysql-password=yourpass</p><h5 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h5><p>Could not use prepare, run means parallel.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/parallel_prepare.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --oltp-tables-count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span> --num-threads=<span class="number">128</span> --max-time=<span class="number">300</span> run</span><br></pre></td></tr></table></figure><h5 id="read"><a href="#read" class="headerlink" title="read"></a>read</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sysbench</span> <span class="string">--test=tests/db/oltp.lua</span> <span class="string">--mysql-host=127.0.0.1</span> <span class="string">--mysql-port=3306</span> <span class="string">--mysql-user=root</span> <span class="string">--mysql-db=sbtest</span> <span class="string">--oltp_tables_count=128</span> <span class="string">--oltp-table-size=500000</span>  <span class="string">--rand-type=uniform</span> <span class="string">--oltp-read-only=on</span> <span class="string">--num-threads=128</span> <span class="string">--max-requests=0</span> <span class="string">--max-time=300</span> <span class="string">--report-interval=3</span> <span class="string">run</span></span><br></pre></td></tr></table></figure><h5 id="rw"><a href="#rw" class="headerlink" title="rw"></a>rw</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/oltp.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure><h5 id="update"><a href="#update" class="headerlink" title="update"></a>update</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/update_non_index.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure><h5 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/<span class="keyword">delete</span>.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure><h5 id="result"><a href="#result" class="headerlink" title="result"></a>result</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OLTP test statistics:</span></span><br><span class="line">    <span class="attr">queries performed:</span></span><br><span class="line">        <span class="attr">read:</span>                            <span class="number">492604</span></span><br><span class="line">        <span class="attr">write:</span>                           <span class="number">140744</span></span><br><span class="line">        <span class="attr">other:</span>                           <span class="number">70372</span></span><br><span class="line">        <span class="attr">total:</span>                           <span class="number">703720</span></span><br><span class="line">    <span class="attr">transactions:</span>                        <span class="number">35186</span>  <span class="string">(117.12</span> <span class="string">per</span> <span class="string">sec.)</span></span><br><span class="line">    <span class="attr">read/write requests:</span>                 <span class="number">633348</span> <span class="string">(2108.17</span> <span class="string">per</span> <span class="string">sec.)</span></span><br><span class="line">    <span class="attr">other operations:</span>                    <span class="number">70372</span>  <span class="string">(234.24</span> <span class="string">per</span> <span class="string">sec.)</span></span><br><span class="line">    <span class="attr">ignored errors:</span>                      <span class="number">0</span>      <span class="string">(0.00</span> <span class="string">per</span> <span class="string">sec.)</span></span><br><span class="line">    <span class="attr">reconnects:</span>                          <span class="number">0</span>      <span class="string">(0.00</span> <span class="string">per</span> <span class="string">sec.)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">General statistics:</span></span><br><span class="line">    <span class="attr">total time:</span>                          <span class="number">300.</span><span class="string">4258s</span></span><br><span class="line">    <span class="attr">total number of events:</span>              <span class="number">35186</span></span><br><span class="line">    <span class="attr">total time taken by event execution:</span> <span class="number">9603.</span><span class="string">6924s</span></span><br><span class="line">    <span class="attr">response time:</span></span><br><span class="line">         <span class="attr">min:</span>                                 <span class="number">53.</span><span class="string">39ms</span></span><br><span class="line">         <span class="attr">avg:</span>                                <span class="number">272.</span><span class="string">94ms</span></span><br><span class="line">         <span class="attr">max:</span>                               <span class="number">1713.</span><span class="string">77ms</span></span><br><span class="line">         <span class="attr">approx.  95 percentile:</span>             <span class="number">496.</span><span class="string">65ms</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Threads fairness:</span></span><br><span class="line">    <span class="string">events</span> <span class="string">(avg/stddev):</span>           <span class="number">1099.5625</span><span class="string">/11.17</span></span><br><span class="line">    <span class="string">execution</span> <span class="string">time</span> <span class="string">(avg/stddev):</span>   <span class="number">300.1154</span><span class="string">/0.12</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure><h5 id="About-performance-in-openzfs"><a href="#About-performance-in-openzfs" class="headerlink" title="About performance in openzfs"></a>About performance in openzfs</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">MariaDB</span> [<span class="string">(none)</span>]<span class="string">&gt;</span> <span class="string">SHOW</span> <span class="string">VARIABLES</span> <span class="string">LIKE</span> <span class="string">&quot;innodb_page_size&quot;</span><span class="string">;</span></span><br><span class="line"><span class="string">+------------------+-------+</span></span><br><span class="line"><span class="string">|</span> <span class="string">Variable_name</span>    <span class="string">|</span> <span class="string">Value</span> <span class="string">|</span></span><br><span class="line"><span class="string">+------------------+-------+</span></span><br><span class="line"><span class="string">|</span> <span class="string">innodb_page_size</span> <span class="string">|</span> <span class="number">16384</span> <span class="string">|</span></span><br><span class="line"><span class="string">+------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure><p><a href="https://wiki.archlinux.org/index.php/ZFS#Database">zfs db</a><br><a href="https://www-304.ibm.com/partnerworld/wps/servlet/download/DownloadServlet?id=YxooL$U5GZkiPCA$cnt&attachmentName=primer_to_run_sysbench_and_mariadb_benchmarks_on_lop.pdf&token=MTQ1NjgyMjIzMTcyNA==&locale=en_ALL_ZZ">reference</a><br><a href="https://mariadb.org/using-lua-enabled-sysbench/">reference2</a></p>]]></content>
      
      
      <categories>
          
          <category> Benchmark </category>
          
      </categories>
      
      
        <tags>
            
            <tag> test </tag>
            
            <tag> benchmark </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>scsi device maintain</title>
      <link href="2018/07/08/scsi_dev/"/>
      <url>2018/07/08/scsi_dev/</url>
      
        <content type="html"><![CDATA[<h3 id="How-many-devices-can-you-connect"><a href="#How-many-devices-can-you-connect" class="headerlink" title="How many devices can you connect?"></a><a href="https://www.microsemi.com/document-portal/doc_download/136098-university-training-what-is-sas">How many devices can you connect?</a></h3><p>Individual SAS RAID adapters can typically support up to 128 end devices with the use of SAS expanders, and can communicate with both SAS and SATA devices.</p><p>Note: Although you can use both SAS and SATA disk drives in the same SAS domain (see page 93), we recommend that you not combine SAS and SATA disk drives within the same array or logical<br>drive. The difference in performance between the two types of disk drives may adversely affect the performance of the array.</p><p>However, as you read in the previous section, with the use of fanout and edge expanders, a single SAS domain can comprise up to 16,384 SAS ports.</p><a id="more"></a><h3 id="Enable-scsi-device-led-from-JBOD"><a href="#Enable-scsi-device-led-from-JBOD" class="headerlink" title="Enable scsi device led from JBOD"></a>Enable scsi device led from JBOD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### Active sas/sata dev led</span></span><br><span class="line"><span class="comment">#### LSI</span></span><br><span class="line">```bash</span><br><span class="line">sas3ircu 0 display</span><br><span class="line"></span><br><span class="line">Device is a Hard disk</span><br><span class="line">  Enclosure <span class="comment">#                             : 3</span></span><br><span class="line">  Slot <span class="comment">#                                  : 14</span></span><br><span class="line">  SAS Address                             : 0000000-0-0000-0000</span><br><span class="line">  State                                   : Ready (RDY)</span><br><span class="line">  Size (<span class="keyword">in</span> MB)/(<span class="keyword">in</span> sectors)               : 3815447/976754645</span><br><span class="line">  Manufacturer                            : HGST</span><br><span class="line">  Model Number                            : HUS726040AL4210</span><br><span class="line">  Firmware Revision                       : AD05</span><br><span class="line">  Serial No                               : 00000000</span><br><span class="line">  Unit Serial No(VPD)                     : 00000000</span><br><span class="line">  GUID                                    : 0000000000000000</span><br><span class="line">  Protocol                                : SAS</span><br><span class="line">  Drive Type                              : SAS_HDD</span><br><span class="line"></span><br><span class="line">sas3ircu 0 locate 3:14 on</span><br><span class="line">sas3ircu 0 locate 3:14 off</span><br></pre></td></tr></table></figure><h4 id="Dell"><a href="#Dell" class="headerlink" title="Dell"></a>Dell</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ lsscsi -gi | grep 35000cca2735b4104</span><br><span class="line">[17:0:132:0] disk    HGST     HUH721010AL5200  LS14  /dev/sddw  35000cca2735b4104  /dev/sg134</span><br><span class="line"></span><br><span class="line">$ shmcli list drives | grep /dev/sg134</span><br><span class="line">     5000cca2735b4107 /dev/sg134                   HGST                          HUH721010AL5200            2YHM5T6D     LS14      8.91TB          50050cc11ac013c6 (EN-8435A-E6EBD)  TH007FPRHGT0087762ZGA02</span><br><span class="line"></span><br><span class="line">$ shmcli blink drive -d = 5000cca2735b4107</span><br><span class="line">blink drive - Executing <span class="built_in">command</span>..</span><br><span class="line"></span><br><span class="line">Blink drive successful.</span><br><span class="line"></span><br><span class="line">blink drive - Command execution complete.</span><br><span class="line"></span><br><span class="line">$ shmcli list drive slots -a = 0 -enc = 0 -verbose | grep 2000000D -i </span><br><span class="line"><span class="comment"># -a = 0 was SAS HBA index</span></span><br><span class="line"><span class="comment"># -enc = 0 was enclosure index</span></span><br><span class="line"></span><br><span class="line">Enc Slot Drwr/Slot Status Vendor  ProductId       Serial   Size   Lnk   Rev Blnk? Logical Vols       SAS Connections</span><br><span class="line">65    1 / 23         OK    HGST   HUH721010AL5200 2000000D 8.91TB 6G,6G LS14 YES,  5000cca27330a695,      n/a</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable led</span></span><br><span class="line">$ shmcli blink drive -d = 5000cca2736726c7 -off</span><br></pre></td></tr></table></figure><h4 id="SCSI-command"><a href="#SCSI-command" class="headerlink" title="SCSI command"></a>SCSI command</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># looks like solt number could be map</span></span><br><span class="line"></span><br><span class="line">$ sas3ircu 0 display | grep c3b1 -A 5 -B 3</span><br><span class="line"></span><br><span class="line">Device is a Hard disk</span><br><span class="line">  Enclosure <span class="comment">#                             : 2</span></span><br><span class="line">  Slot <span class="comment">#                                  : 49</span></span><br><span class="line">  SAS Address                             : 5000cca-2-6b90-c3b1</span><br><span class="line">  State                                   : Ready (RDY)</span><br><span class="line">  Size (<span class="keyword">in</span> MB)/(<span class="keyword">in</span> sectors)               : 9537535/19532873727</span><br><span class="line">  Manufacturer                            : HGST</span><br><span class="line">  Model Number                            : HUH721010AL5200</span><br><span class="line">  Firmware Revision                       : A384</span><br><span class="line"></span><br><span class="line">$ sg_ses /dev/sg52 -p0x2 -j | grep c3b1  -i -A 8</span><br><span class="line">join_work: oi=0, ei=9, eiioe=1 not <span class="keyword">in</span> join_arr</span><br><span class="line">Drive Slot <span class="comment">#50_5000CCA26B90C3B1 [0,49]  Element type: Array device slot</span></span><br><span class="line">  Enclosure Status:</span><br><span class="line">    Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">    OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">    In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">    App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">    Ready to insert=0, RMV=0, Ident=0, Report=0                           <span class="comment"># here is the device status</span></span><br><span class="line">    App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">    Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line"></span><br><span class="line">$ $ lsscsi -git</span><br><span class="line">[0:0:0:0]    disk    sas:0x500056b3787358c0          /dev/sda   -  /dev/sg0</span><br><span class="line">[0:0:1:0]    disk    sas:0x500056b3787358c1          /dev/sdb   -  /dev/sg1</span><br><span class="line">[0:0:2:0]    disk    sas:0x500056b3787358c2          /dev/sdc   -  /dev/sg2</span><br><span class="line">[0:0:3:0]    disk    sas:0x500056b3787358c3          /dev/sdd   -  /dev/sg3</span><br><span class="line">[0:0:4:0]    disk    sas:0x500056b3787358c4          /dev/sde   -  /dev/sg4</span><br><span class="line">[0:0:5:0]    disk    sas:0x500056b3787358c5          /dev/sdf   -  /dev/sg5</span><br><span class="line">[0:0:6:0]    disk    sas:0x500056b3787358c6          /dev/sdg   -  /dev/sg6</span><br><span class="line">[0:0:7:0]    disk    sas:0x500056b3787358c7          /dev/sdh   -  /dev/sg7</span><br><span class="line">[0:0:8:0]    disk    sas:0x500056b3787358c8          /dev/sdi   -  /dev/sg8</span><br><span class="line">[0:0:9:0]    disk    sas:0x500056b3787358c9          /dev/sdj   -  /dev/sg9</span><br><span class="line">[0:0:10:0]   disk    sas:0x500056b3787358ca          /dev/sdk   -  /dev/sg10</span><br><span class="line">[0:0:11:0]   disk    sas:0x500056b3787358cb          /dev/sdl   -  /dev/sg11</span><br><span class="line">[0:0:12:0]   enclosu sas:0x500056b3787358fd          -          -  /dev/sg12</span><br><span class="line">[15:0:0:0]   disk    sata:                           /dev/sdm   -  /dev/sg13</span><br><span class="line">[17:0:0:0]   process sata:                           -          -  /dev/sg14</span><br><span class="line"></span><br><span class="line">$ sg_ses -p 0xa /dev/sg12 |grep -E <span class="string">&#x27;Element|slot&#x27;</span></span><br><span class="line">    &lt;&lt;&lt;additional: response too short&gt;&gt;&gt;</span><br><span class="line">    Element <span class="built_in">type</span>: Array device slot, subenclosure id: 0 [ti=0]</span><br><span class="line">      Element index: 0  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 0</span><br><span class="line">      Element index: 1  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 1</span><br><span class="line">      Element index: 2  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 2</span><br><span class="line">      Element index: 3  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 3</span><br><span class="line">      Element index: 4  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 4</span><br><span class="line">      Element index: 5  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 5</span><br><span class="line">      Element index: 6  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 6</span><br><span class="line">      Element index: 7  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 7</span><br><span class="line">      Element index: 8  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 8</span><br><span class="line">      Element index: 9  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 9</span><br><span class="line">      Element index: 10  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 10</span><br><span class="line">      Element index: 11  eiioe=0</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 11</span><br><span class="line"></span><br><span class="line"><span class="comment"># the light color depends hardware vendor</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--clear, --get, --<span class="built_in">set</span> acronyms <span class="keyword">for</span> Enclosure Status/Control [<span class="string">&#x27;es&#x27;</span> or <span class="string">&#x27;ec&#x27;</span>] page:</span><br><span class="line">    active  [Device slot] [2:7:1]</span><br><span class="line">    active  [Array device slot] [2:7:1]</span><br><span class="line">    <span class="built_in">disable</span>  [*] [0:5:1]</span><br><span class="line">    devoff  [Device slot] [3:4:1]</span><br><span class="line">    devoff  [Array device slot] [3:4:1]</span><br><span class="line">    dnr  [Device slot] [2:6:1]</span><br><span class="line">    dnr  [Array device slot] [2:6:1]</span><br><span class="line">    fault  [Device slot] [3:5:1]</span><br><span class="line">    fault  [Array device slot] [3:5:1]</span><br><span class="line">    ident  [Device slot] [2:1:1]</span><br><span class="line">    ident  [Array device slot] [2:1:1]</span><br><span class="line">    ident  [Power supply] [1:7:1]</span><br><span class="line">    ident  [Cooling] [1:7:1]</span><br><span class="line">    ident  [Enclosure] [1:7:1]</span><br><span class="line">    insert  [Device slot] [2:3:1]</span><br><span class="line">    insert  [Array device slot] [2:3:1]</span><br><span class="line">    locate  [Device slot] [2:1:1]</span><br><span class="line">    locate  [Array device slot] [2:1:1]</span><br><span class="line">    locate  [Power supply] [1:7:1]</span><br><span class="line">    locate  [Cooling] [1:7:1]</span><br><span class="line">    locate  [Enclosure] [1:7:1]</span><br><span class="line">    missing  [Device slot] [2:4:1]</span><br><span class="line">    missing  [Array device slot] [2:4:1]</span><br><span class="line">    locate  [Device slot] [2:1:1]</span><br><span class="line">    locate  [Array device slot] [2:1:1]</span><br><span class="line">    prdfail  [*] [0:6:1]</span><br><span class="line">    remove  [Device slot] [2:2:1]</span><br><span class="line">    remove  [Array device slot] [2:2:1]</span><br><span class="line">    speed_act  [Cooling] [2:7:8]</span><br><span class="line">    speed_code  [Cooling] [3:2:3]</span><br><span class="line">    swap  [*] [0:4:1]</span><br><span class="line"></span><br><span class="line">--clear, --get, --<span class="built_in">set</span> acronyms <span class="keyword">for</span> Threshold In/Out [<span class="string">&#x27;th&#x27;</span>] page:</span><br><span class="line">    high_crit  [*] [0:7:8]</span><br><span class="line">    high_warn  [*] [1:7:8]</span><br><span class="line">    low_crit  [*] [2:7:8]</span><br><span class="line">    low_warn  [*] [3:7:8]</span><br><span class="line"></span><br><span class="line">--get acronyms <span class="keyword">for</span> Additional Element Status [<span class="string">&#x27;aes&#x27;</span>] page (SAS EIP=1):</span><br><span class="line">    at_sas_addr  [*] [20:7:64]</span><br><span class="line">    dev_type  [*] [8:6:3]</span><br><span class="line">    phy_id  [*] [28:7:8]</span><br><span class="line">    sas_addr  [*] [12:7:64]</span><br><span class="line">    sata_dev  [*] [11:0:1]</span><br><span class="line">    sata_port_sel  [*] [11:7:1]</span><br><span class="line">    smp_init  [*] [10:1:1]</span><br><span class="line">    smp_targ  [*] [11:1:1]</span><br><span class="line">    ssp_init  [*] [10:3:1]</span><br><span class="line">    ssp_targ  [*] [11:3:1]</span><br><span class="line">    stp_init  [*] [10:2:1]</span><br><span class="line">    stp_targ  [*] [11:2:1]</span><br><span class="line"></span><br><span class="line">$ sg_ses --index=7 --setl=ident /dev/sg12</span><br><span class="line"><span class="comment">### rebuild , green led blink</span></span><br><span class="line">$ sg_ses --index=7 --<span class="built_in">set</span>=1:1:1 /dev/sg12</span><br><span class="line">$ sg_ses --index=7 --<span class="built_in">set</span>=1:1:1 /dev/sg12</span><br><span class="line"><span class="comment">### fault , red led blink</span></span><br><span class="line">$ sg_ses --index=7 --<span class="built_in">set</span>=fault /dev/sg12</span><br><span class="line">$ sg_ses --index=7 --clear=fault /dev/sg12</span><br><span class="line"><span class="comment">### prdfail, orange and green blink by turn</span></span><br><span class="line">$ sg_ses --index=7 --<span class="built_in">set</span>=prdfail /dev/sg12</span><br><span class="line">$ sg_ses --index=7 --clear=prdfail /dev/sg12</span><br><span class="line"><span class="comment">### locate not work</span></span><br><span class="line">$ sg_ses --index=7 --<span class="built_in">set</span>=2:1:1 /dev/sg12</span><br><span class="line">$ sg_ses --index=7 --clear=2:1:1 /dev/sg12</span><br></pre></td></tr></table></figure><p>Element Customization<br>Array device slot control element</p><table><thead><tr><th>Byte Bit</th><th align="center">7</th><th align="right">6</th><th align="right">5</th><th align="right">4</th><th align="right">3</th><th align="right">2</th><th align="right">1</th><th align="right">0</th></tr></thead><tbody><tr><td>0</td><td align="center">select</td><td align="right">PRDFAIL</td><td align="right">DISABLED</td><td align="right">RST SWAP</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td></tr><tr><td>1</td><td align="center">RQST OK</td><td align="right">RQSD RSVE DEV</td><td align="right">RQST HOT SPA</td><td align="right">RQST CONS CHK</td><td align="right">RQST IN CRIT ARR</td><td align="right">RQST IN FAILED ARR</td><td align="right">RQST REBUILD/REMAP</td><td align="right">RQST R/R ABORT</td></tr><tr><td>2</td><td align="center">RQST active</td><td align="right">DO NOT REMOVE</td><td align="right">RESERVED</td><td align="right">RQST MISSING</td><td align="right">RQST REMOVE</td><td align="right">RQST REMOVE</td><td align="right">RQST IDENT</td><td align="right">RESERVED</td></tr><tr><td>3</td><td align="center">RESERVED</td><td align="right">RESERVED</td><td align="right">RQST FAULT</td><td align="right">DEVICE OFF</td><td align="right">ENABLE BYP B</td><td align="right">ENABLE BYP B</td><td align="right">RESERVED</td><td align="right">RESERVED</td></tr></tbody></table><h4 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### view pages from the enclosure</span></span><br><span class="line">$ sg_ses -p 0 /dev/sg103</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lsscsi -git</span><br><span class="line">[15:0:50:0]  enclosu sas:0x5000ccab0202777d          -          -  /dev/sg103</span><br><span class="line"></span><br><span class="line">$ sg_ses -p 2 /dev/sg103</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">        Actual speed=0 rpm, Fan stopped</span><br><span class="line">        Actual speed=4100 rpm, Fan at lowest speed</span><br><span class="line">        Actual speed=4100 rpm, Fan at lowest speed</span><br><span class="line">        Actual speed=4100 rpm, Fan at lowest speed</span><br><span class="line">        Actual speed=4100 rpm, Fan at lowest speed</span><br><span class="line">        Actual speed=4100 rpm, Fan at lowest speed</span><br><span class="line">        Actual speed=4100 rpm, Fan at lowest speed</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">    Element <span class="built_in">type</span>: Temperature sensor, subenclosure id: 0 [ti=3]</span><br><span class="line">        Temperature: &lt;reserved&gt;</span><br><span class="line">        Temperature=32 C</span><br><span class="line">        Temperature=30 C</span><br><span class="line">        Temperature=37 C</span><br><span class="line">        Temperature=59 C</span><br><span class="line">        Temperature=31 C</span><br><span class="line">        Temperature=32 C</span><br><span class="line">        Temperature=32 C</span><br><span class="line">        Temperature=57 C</span><br><span class="line">        Temperature=21 C</span><br><span class="line">        Temperature=21 C</span><br><span class="line">        Temperature=45 C</span><br><span class="line">        Temperature=29 C</span><br><span class="line">        Temperature=35 C</span><br><span class="line">        Temperature=47 C</span><br><span class="line">        Temperature=31 C</span><br><span class="line">        Temperature=36 C</span><br><span class="line"></span><br><span class="line">$  sg_ses -p 2 /dev/sg103 -r</span><br><span class="line">        00 00 00 00 05 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        05 00 00 00 05 00 00 00  05 00 00 00 05 00 00 00</span><br><span class="line">        05 00 00 00 05 00 00 00  05 00 00 00 05 00 00 00</span><br><span class="line">        05 00 00 00 05 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 00 00 00  01 01 9a 01 01 01 95 01</span><br><span class="line">        01 01 9a 01 01 01 9a 01  01 01 9a 01 01 01 9a 01</span><br><span class="line">        01 00 00 00 01 00 34 00  01 00 32 00 01 00 39 00</span><br><span class="line">        01 00 50 00 01 00 33 00  01 00 34 00 01 00 34 00</span><br><span class="line">        01 00 4e 00 01 00 29 00  01 00 29 00 01 00 41 00</span><br><span class="line">        01 00 31 00 01 00 37 00  01 00 43 00 01 00 33 00</span><br><span class="line">        01 00 38 00 01 00 00 00  01 00 01 80 01 00 01 80</span><br><span class="line">        01 00 00 00 01 00 00 00  01 00 00 00 01 00 00 5f</span><br><span class="line">        01 00 00 64 01 00 00 b6  01 00 01 4c 01 00 00 5c</span><br><span class="line">        01 00 00 63 01 00 00 b4  01 00 01 46 01 00 04 bf</span><br><span class="line">        01 00 04 bf 01 00 00 00  01 00 00 00 01 00 00 00</span><br><span class="line">        01 00 00 00 01 03 ff 00  01 03 ff 00 01 03 ff 00</span><br><span class="line">        01 03 ff 00</span><br><span class="line"></span><br><span class="line">$ sg_ses /dev/sg129 -p0x2 -I2,1 -j</span><br><span class="line">first 2 menas Fan,1 is power,3 is temperature</span><br><span class="line">-I2,0 means the first Fan, -I 2,1 means second fan</span><br><span class="line"></span><br><span class="line">$ sg_ses -p 0 /dev/sg343</span><br><span class="line">  SMC946    R39                 1C</span><br><span class="line">Supported diagnostic pages:</span><br><span class="line">  Supported Diagnostic Pages [sdp] [0x0]</span><br><span class="line">  Configuration (SES) [cf] [0x1]</span><br><span class="line">  Enclosure Status/Control (SES) [ec,es] [0x2]</span><br><span class="line">  String In/Out (SES) [str] [0x4]</span><br><span class="line">  Threshold In/Out (SES) [th] [0x5]</span><br><span class="line">  Element Descriptor (SES) [ed] [0x7]</span><br><span class="line">  Additional Element Status (SES-2) [aes] [0xa]</span><br><span class="line">  Supported SES Diagnostic Pages (SES-2) [ssp] [0xd]</span><br><span class="line">  Download Microcode (SES-2) [dm] [0xe]</span><br><span class="line">  Subenclosure Nickname (SES-2) [snic] [0xf]</span><br><span class="line"></span><br><span class="line">$ sg_ses -p 0 /dev/sg103</span><br><span class="line">  HGST      4U60_STOR_ENCL    0210</span><br><span class="line">Supported diagnostic pages:</span><br><span class="line">  Supported Diagnostic Pages [sdp] [0x0]</span><br><span class="line">  Configuration (SES) [cf] [0x1]</span><br><span class="line">  Enclosure Status/Control (SES) [ec,es] [0x2]</span><br><span class="line">  String In/Out (SES) [str] [0x4]</span><br><span class="line">  Threshold In/Out (SES) [th] [0x5]</span><br><span class="line">  Element Descriptor (SES) [ed] [0x7]</span><br><span class="line">  Additional Element Status (SES-2) [aes] [0xa]</span><br><span class="line">  Download Microcode (SES-2) [dm] [0xe]</span><br><span class="line">  &lt;unknown&gt; [0x10]</span><br><span class="line">  &lt;unknown&gt; [0x11]</span><br><span class="line">  &lt;unknown&gt; [0x12]</span><br><span class="line">  &lt;unknown&gt; [0x13]</span><br><span class="line">  &lt;unknown&gt; [0x14]</span><br><span class="line">  &lt;unknown&gt; [0x15]</span><br><span class="line">  &lt;unknown&gt; [0x16]</span><br><span class="line">$ sg_ses -p 0 /dev/sg91</span><br><span class="line">  DELL      EN-8435A-E6EBD    3535</span><br><span class="line">Supported diagnostic pages:</span><br><span class="line">  Supported Diagnostic Pages [sdp] [0x0]</span><br><span class="line">  Configuration (SES) [cf] [0x1]</span><br><span class="line">  Enclosure Status/Control (SES) [ec,es] [0x2]</span><br><span class="line">  Threshold In/Out (SES) [th] [0x5]</span><br><span class="line">  Element Descriptor (SES) [ed] [0x7]</span><br><span class="line">  Additional Element Status (SES-2) [aes] [0xa]</span><br><span class="line">  Download Microcode (SES-2) [dm] [0xe]</span><br><span class="line">  &lt;unknown&gt; [0x84]</span><br><span class="line">  &lt;unknown&gt; [0x85]</span><br><span class="line">  &lt;unknown&gt; [0x90]</span><br><span class="line">  &lt;unknown&gt; [0x91]</span><br><span class="line">  &lt;unknown&gt; [0x92]</span><br><span class="line">  &lt;unknown&gt; [0x93]</span><br><span class="line">$ sg_ses -p 0 /dev/sg335</span><br><span class="line">  HPE       D6020             1.63</span><br><span class="line">Supported diagnostic pages:</span><br><span class="line">  Supported Diagnostic Pages [sdp] [0x0]</span><br><span class="line">  Configuration (SES) [cf] [0x1]</span><br><span class="line">  Enclosure Status/Control (SES) [ec,es] [0x2]</span><br><span class="line">  Help Text (SES) [ht] [0x3]</span><br><span class="line">  Element Descriptor (SES) [ed] [0x7]</span><br><span class="line">  Additional Element Status (SES-2) [aes] [0xa]</span><br><span class="line">  &lt;unknown&gt; [0x10]</span><br><span class="line">  &lt;unknown&gt; [0x14]</span><br><span class="line"></span><br><span class="line">sg_ses -ee /dev/sg291</span><br><span class="line">&gt;&gt;&gt; DEVICE /dev/sg291 ignored when --enumerate option given.</span><br><span class="line">--clear, --get, --<span class="built_in">set</span> acronyms <span class="keyword">for</span> Enclosure Status/Control [<span class="string">&#x27;es&#x27;</span> or <span class="string">&#x27;ec&#x27;</span>] page:</span><br><span class="line">    active  [Device slot] [2:7:1]</span><br><span class="line">    active  [Array device slot] [2:7:1]</span><br><span class="line">    <span class="built_in">disable</span>  [*] [0:5:1]</span><br><span class="line">    devoff  [Device slot] [3:4:1]</span><br><span class="line">    devoff  [Array device slot] [3:4:1]</span><br><span class="line">    dnr  [Device slot] [2:6:1]</span><br><span class="line">    dnr  [Array device slot] [2:6:1]</span><br><span class="line">    fault  [Device slot] [3:5:1]</span><br><span class="line">    fault  [Array device slot] [3:5:1]</span><br><span class="line">    ident  [Device slot] [2:1:1]</span><br><span class="line">    ident  [Array device slot] [2:1:1]</span><br><span class="line">    ident  [Power supply] [1:7:1]</span><br><span class="line">    ident  [Cooling] [1:7:1]</span><br><span class="line">    ident  [Enclosure] [1:7:1]</span><br><span class="line">    insert  [Device slot] [2:3:1]</span><br><span class="line">    insert  [Array device slot] [2:3:1]</span><br><span class="line">    locate  [Device slot] [2:1:1]</span><br><span class="line">    locate  [Array device slot] [2:1:1]</span><br><span class="line">    locate  [Power supply] [1:7:1]</span><br><span class="line">    locate  [Cooling] [1:7:1]</span><br><span class="line">    locate  [Enclosure] [1:7:1]</span><br><span class="line">    missing  [Device slot] [2:4:1]</span><br><span class="line">    missing  [Array device slot] [2:4:1]</span><br><span class="line">    locate  [Device slot] [2:1:1]</span><br><span class="line">    locate  [Array device slot] [2:1:1]</span><br><span class="line">    prdfail  [*] [0:6:1]</span><br><span class="line">    remove  [Device slot] [2:2:1]</span><br><span class="line">    remove  [Array device slot] [2:2:1]</span><br><span class="line">    speed_act  [Cooling] [2:7:8]</span><br><span class="line">    speed_code  [Cooling] [3:2:3]</span><br><span class="line">    swap  [*] [0:4:1]</span><br><span class="line"></span><br><span class="line">--clear, --get, --<span class="built_in">set</span> acronyms <span class="keyword">for</span> Threshold In/Out [<span class="string">&#x27;th&#x27;</span>] page:</span><br><span class="line">    high_crit  [*] [0:7:8]</span><br><span class="line">    high_warn  [*] [1:7:8]</span><br><span class="line">    low_crit  [*] [2:7:8]</span><br><span class="line">    low_warn  [*] [3:7:8]</span><br><span class="line"></span><br><span class="line">--get acronyms <span class="keyword">for</span> Additional Element Status [<span class="string">&#x27;aes&#x27;</span>] page (SAS EIP=1):</span><br><span class="line">    at_sas_addr  [*] [20:7:64]</span><br><span class="line">    dev_type  [*] [8:6:3]</span><br><span class="line">    phy_id  [*] [28:7:8]</span><br><span class="line">    sas_addr  [*] [12:7:64]</span><br><span class="line">    sata_dev  [*] [11:0:1]</span><br><span class="line">    sata_port_sel  [*] [11:7:1]</span><br><span class="line">    smp_init  [*] [10:1:1]</span><br><span class="line">    smp_targ  [*] [11:1:1]</span><br><span class="line">    ssp_init  [*] [10:3:1]</span><br><span class="line">    ssp_targ  [*] [11:3:1]</span><br><span class="line">    stp_init  [*] [10:2:1]</span><br><span class="line">    stp_targ  [*] [11:2:1]</span><br><span class="line"></span><br><span class="line">$ sg_ses -es /dev/sg291</span><br><span class="line">&gt;&gt;&gt; DEVICE /dev/sg291 ignored when --enumerate option given.</span><br><span class="line">Diagnostic pages, followed by abbreviation(s) <span class="keyword">then</span> page code:</span><br><span class="line">    Supported Diagnostic Pages  [sdp] [0x0]</span><br><span class="line">    Configuration (SES)  [cf] [0x1]</span><br><span class="line">    Enclosure Status/Control (SES)  [ec,es] [0x2]</span><br><span class="line">    Help Text (SES)  [ht] [0x3]</span><br><span class="line">    String In/Out (SES)  [str] [0x4]</span><br><span class="line">    Threshold In/Out (SES)  [th] [0x5]</span><br><span class="line">    Array Status/Control (SES, obsolete)  [ac,as] [0x6]</span><br><span class="line">    Element Descriptor (SES)  [ed] [0x7]</span><br><span class="line">    Short Enclosure Status (SES)  [ses] [0x8]</span><br><span class="line">    Enclosure Busy (SES-2)  [eb] [0x9]</span><br><span class="line">    Additional Element Status (SES-2)  [aes] [0xa]</span><br><span class="line">    Subenclosure Help Text (SES-2)  [sht] [0xb]</span><br><span class="line">    Subenclosure String In/Out (SES-2)  [sstr] [0xc]</span><br><span class="line">    Supported SES Diagnostic Pages (SES-2)  [ssp] [0xd]</span><br><span class="line">    Download Microcode (SES-2)  [dm] [0xe]</span><br><span class="line">    Subenclosure Nickname (SES-2)  [snic] [0xf]</span><br><span class="line">    Protocol Specific (SAS transport)  [] [0x3f]</span><br><span class="line">    Translate Address (SBC)  [] [0x40]</span><br><span class="line">    Device Status (SBC)  [] [0x41]</span><br><span class="line">    Rebuild Assist (SBC)  [] [0x42]</span><br><span class="line"></span><br><span class="line">SES element <span class="built_in">type</span> names, followed by abbreviation and element <span class="built_in">type</span> code:</span><br><span class="line">    Unspecified  [un] [0x0]</span><br><span class="line">    Device slot  [dev] [0x1]</span><br><span class="line">    Power supply  [ps] [0x2]</span><br><span class="line">    Cooling  [coo] [0x3]</span><br><span class="line">    Temperature sensor  [ts] [0x4]</span><br><span class="line">    Door  [<span class="keyword">do</span>] [0x5]</span><br><span class="line">    Audible alarm  [aa] [0x6]</span><br><span class="line">    Enclosure services controller electronics  [esc] [0x7]</span><br><span class="line">    SCC controller electronics  [sce] [0x8]</span><br><span class="line">    Nonvolatile cache  [nc] [0x9]</span><br><span class="line">    Invalid operation reason  [ior] [0xa]</span><br><span class="line">    Uninterruptible power supply  [ups] [0xb]</span><br><span class="line">    Display  [dis] [0xc]</span><br><span class="line">    Key pad entry  [kpe] [0xd]</span><br><span class="line">    Enclosure  [enc] [0xe]</span><br><span class="line">    SCSI port/transceiver  [sp] [0xf]</span><br><span class="line">    Language  [lan] [0x10]</span><br><span class="line">    Communication port  [cp] [0x11]</span><br><span class="line">    Voltage sensor  [vs] [0x12]</span><br><span class="line">    Current sensor  [cs] [0x13]</span><br><span class="line">    SCSI target port  [stp] [0x14]</span><br><span class="line">    SCSI initiator port  [sip] [0x15]</span><br><span class="line">    Simple subenclosure  [ss] [0x16]</span><br><span class="line">    Array device slot  [arr] [0x17]</span><br><span class="line">    SAS expander  [sse] [0x18]</span><br><span class="line">    SAS connector  [ssc] [0x19]</span><br><span class="line"></span><br><span class="line">[13:0:90:0]  disk    HGST     HUH721010AL5200  A21D  /dev/sdji  35000cca251ae9e94  /dev/sg278  10.0TB</span><br><span class="line">[13:0:91:0]  disk    HGST     HUH721010AL5200  A21D  /dev/sdmv  35000cca251ac584c  /dev/sg372  10.0TB</span><br><span class="line">[13:0:92:0]  disk    HGST     HUH721010AL5200  A21D  /dev/sdmw  35000cca251aca1b4  /dev/sg373  10.0TB</span><br><span class="line">[14:0:0:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjj  35000cca251b137a0  /dev/sg279  10.0TB</span><br><span class="line">[14:0:1:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjk  35000cca251b29994  /dev/sg280  10.0TB</span><br><span class="line">[14:0:2:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjl  35000cca251ab4d30  /dev/sg281  10.0TB</span><br><span class="line">[14:0:3:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjm  35000cca25198c678  /dev/sg282  10.0TB</span><br><span class="line">[14:0:4:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjn  35000cca251b12a14  /dev/sg283  10.0TB</span><br><span class="line">[14:0:5:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjo  35000cca251ac5a14  /dev/sg284  10.0TB</span><br><span class="line">[14:0:6:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjp  35000cca251b21390  /dev/sg285  10.0TB</span><br><span class="line">[14:0:7:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjq  35000cca251b25234  /dev/sg286  10.0TB</span><br><span class="line">[14:0:8:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjr  35000cca251b2f228  /dev/sg287  10.0TB</span><br><span class="line">[14:0:9:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdjs  35000cca251b380d8  /dev/sg288  10.0TB</span><br><span class="line">[14:0:10:0]  disk    HGST     HUH721010AL5200  A21D  /dev/sdjt  35000cca251b272ec  /dev/sg289  10.0TB</span><br><span class="line">[14:0:11:0]  disk    HGST     HUH721010AL5200  A21D  /dev/sdju  35000cca251b13860  /dev/sg290  10.0TB</span><br><span class="line">[14:0:12:0]  enclosu SMC946   12                 1C  -          -  /dev/sg291</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get all descriptor</span></span><br><span class="line">$ sg_ses -p 0x7 /dev/sg291</span><br><span class="line">  SMC946    12                  1C</span><br><span class="line">  Primary enclosure logical identifier (hex): 5003048009281a3f</span><br><span class="line">Element Descriptor In diagnostic page:</span><br><span class="line">  generation code: 0x0</span><br><span class="line">  element descriptor by <span class="built_in">type</span> list</span><br><span class="line">    Element <span class="built_in">type</span>: Array device slot, subenclosure id: 0 [ti=0]</span><br><span class="line">      Overall descriptor: ArrayDevicesInSubEnclsr0</span><br><span class="line">      Element 0 descriptor: Slot00</span><br><span class="line">      Element 1 descriptor: Slot01</span><br><span class="line">      Element 2 descriptor: Slot02</span><br><span class="line">      Element 3 descriptor: Slot03</span><br><span class="line">      Element 4 descriptor: Slot04</span><br><span class="line">      Element 5 descriptor: Slot05</span><br><span class="line">      Element 6 descriptor: Slot06</span><br><span class="line">      Element 7 descriptor: Slot07</span><br><span class="line">      Element 8 descriptor: Slot08</span><br><span class="line">      Element 9 descriptor: Slot09</span><br><span class="line">      Element 10 descriptor: Slot10</span><br><span class="line">      Element 11 descriptor: Slot11</span><br><span class="line">    Element <span class="built_in">type</span>: SAS expander, subenclosure id: 0 [ti=1]</span><br><span class="line">      Overall descriptor: SAS Expander</span><br><span class="line">      Element 0 descriptor: Expander0</span><br><span class="line">    Element <span class="built_in">type</span>: SAS connector, subenclosure id: 0 [ti=2]</span><br><span class="line">      Overall descriptor: SAS Connectors</span><br><span class="line">      Element 0 descriptor: ConnectorA</span><br><span class="line">      Element 1 descriptor: ConnectorB</span><br><span class="line">      Element 2 descriptor: ConnectorC</span><br><span class="line">      Element 3 descriptor: ConnectorD</span><br><span class="line">      Element 4 descriptor: Drive Connector 00</span><br><span class="line">      Element 5 descriptor: Drive Connector 01</span><br><span class="line">      Element 6 descriptor: Drive Connector 02</span><br><span class="line">      Element 7 descriptor: Drive Connector 03</span><br><span class="line">      Element 8 descriptor: Drive Connector 04</span><br><span class="line">      Element 9 descriptor: Drive Connector 05</span><br><span class="line">      Element 10 descriptor: Drive Connector 06</span><br><span class="line">      Element 11 descriptor: Drive Connector 07</span><br><span class="line">      Element 12 descriptor: Drive Connector 08</span><br><span class="line">      Element 13 descriptor: Drive Connector 09</span><br><span class="line">      Element 14 descriptor: Drive Connector 10</span><br><span class="line">      Element 15 descriptor: Drive Connector 11</span><br><span class="line">    Element <span class="built_in">type</span>: Enclosure, subenclosure id: 0 [ti=3]</span><br><span class="line">      Overall descriptor: EnclosureElementInSubEnclsr0</span><br><span class="line">      Element 0 descriptor: RD-BHE-000-02343</span><br><span class="line">    Element <span class="built_in">type</span>: Temperature sensor, subenclosure id: 0 [ti=4]</span><br><span class="line">      Overall descriptor: TempSensorsInSubEnclsr0</span><br><span class="line">      Element 0 descriptor: ChipDie</span><br><span class="line">      Element 1 descriptor: VRM1</span><br><span class="line">      Element 2 descriptor: VRM2</span><br><span class="line">      Element 3 descriptor: SYSTemp</span><br><span class="line">      Element 4 descriptor: HDDBPN</span><br><span class="line">    Element <span class="built_in">type</span>: Voltage sensor, subenclosure id: 0 [ti=5]</span><br><span class="line">      Overall descriptor: VoltageSensorsInSubEnclsr0</span><br><span class="line">      Element 0 descriptor: 12VSB</span><br><span class="line">      Element 1 descriptor: 3P3VSB</span><br><span class="line">      Element 2 descriptor: 1P2BMC</span><br><span class="line">      Element 3 descriptor: 1P5BMC</span><br><span class="line">      Element 4 descriptor: VBAT</span><br><span class="line">      Element 5 descriptor: 12VCC</span><br><span class="line">      Element 6 descriptor: 3P3VCC</span><br><span class="line">      Element 7 descriptor: 1P8VEXP1</span><br><span class="line">      Element 8 descriptor: 0P9VEXP1</span><br><span class="line">      Element 9 descriptor: 0P9VREXP1</span><br><span class="line">      Element 10 descriptor: 1P8VEXP2</span><br><span class="line">      Element 11 descriptor: 0P9VEXP2</span><br><span class="line">      Element 12 descriptor: 0P9VREXP2</span><br><span class="line">      Element 13 descriptor: 1P8VEXP3</span><br><span class="line">      Element 14 descriptor: 0P9VEXP3</span><br><span class="line">      Element 15 descriptor: 0P9VREXP3</span><br><span class="line">    Element <span class="built_in">type</span>: Cooling, subenclosure id: 0 [ti=6]</span><br><span class="line">      Overall descriptor: CoolingElementInSubEnclsr0</span><br><span class="line">      Element 0 descriptor: Fan1</span><br><span class="line">      Element 1 descriptor: Fan2</span><br><span class="line">      Element 2 descriptor: Fan3</span><br><span class="line">      Element 3 descriptor: Fan4</span><br><span class="line">      Element 4 descriptor: Fan5</span><br><span class="line">      Element 5 descriptor: Fan1C</span><br><span class="line">      Element 6 descriptor: Fan2C</span><br><span class="line">      Element 7 descriptor: Fan3C</span><br><span class="line">      Element 8 descriptor: Fan4C</span><br><span class="line">      Element 9 descriptor: Fan5C</span><br><span class="line">    Element <span class="built_in">type</span>: Power supply, subenclosure id: 0 [ti=7]</span><br><span class="line">      Overall descriptor: PowerSupplyStatus</span><br><span class="line">      Element 0 descriptor: PWS1</span><br><span class="line">      Element 1 descriptor: PWS2</span><br><span class="line">      Element 2 descriptor: PWS3</span><br><span class="line">      Element 3 descriptor: PWS4</span><br><span class="line"></span><br><span class="line">$  sg_ses -p 0x2 /dev/sg291</span><br><span class="line">  SMC946    12                  1C</span><br><span class="line">  Primary enclosure logical identifier (hex): 5003048009281a3f</span><br><span class="line">Enclosure Status diagnostic page:</span><br><span class="line">  INVOP=0, INFO=0, NON-CRIT=0, CRIT=1, UNRECOV=0</span><br><span class="line">  generation code: 0x0</span><br><span class="line">  status descriptor list</span><br><span class="line">    Element <span class="built_in">type</span>: Array device slot, subenclosure id: 0 [ti=0]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 1 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 2 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 3 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 4 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 5 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 6 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 7 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 8 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 9 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 10 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">      Element 11 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        OK=0, Reserved device=0, Hot spare=0, Cons check=0</span><br><span class="line">        In crit array=0, In failed array=0, Rebuild/remap=0, R/R abort=0</span><br><span class="line">        App client bypass A=0, Do not remove=0, Enc bypass A=0, Enc bypass B=0</span><br><span class="line">        Ready to insert=0, RMV=0, Ident=0, Report=0</span><br><span class="line">        App client bypass B=0, Fault sensed=0, Fault reqstd=0, Device off=0</span><br><span class="line">        Bypassed A=0, Bypassed B=0, Dev bypassed A=0, Dev bypassed B=0</span><br><span class="line">    Element <span class="built_in">type</span>: SAS expander, subenclosure id: 0 [ti=1]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        Ident=0, Fail=0</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0</span><br><span class="line">    Element <span class="built_in">type</span>: SAS connector, subenclosure id: 0 [ti=2]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        Ident=0, No information</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Mini SAS HD 4i receptacle (SFF-8643) [max 4 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 1 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Mini SAS HD 4i receptacle (SFF-8643) [max 4 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 2 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Mini SAS HD 4i receptacle (SFF-8643) [max 4 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 3 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Mini SAS HD 4i receptacle (SFF-8643) [max 4 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 4 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 5 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 6 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 7 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 8 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 9 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 10 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 11 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 12 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 13 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 14 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">      Element 15 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, SAS Drive backplane receptacle (SFF-8482) [max 2 phys]</span><br><span class="line">        Connector physical link=0x0, Fail=0</span><br><span class="line">    Element <span class="built_in">type</span>: Enclosure, subenclosure id: 0 [ti=3]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        Ident=0, Time until power cycle=0, Failure indication=0</span><br><span class="line">        Warning indication=0, Requested power off duration=0</span><br><span class="line">        Failure requested=0, Warning requested=0</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Time until power cycle=0, Failure indication=0</span><br><span class="line">        Warning indication=0, Requested power off duration=0</span><br><span class="line">        Failure requested=0, Warning requested=0</span><br><span class="line">    Element <span class="built_in">type</span>: Temperature sensor, subenclosure id: 0 [ti=4]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        Ident=0, Fail=0, OT failure=0, OT warning=0, UT failure=0</span><br><span class="line">        UT warning=0</span><br><span class="line">        Temperature: &lt;reserved&gt;</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0, OT failure=0, OT warning=0, UT failure=0</span><br><span class="line">        UT warning=0</span><br><span class="line">        Temperature=79 C</span><br><span class="line">      Element 1 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0, OT failure=0, OT warning=0, UT failure=0</span><br><span class="line">        UT warning=0</span><br><span class="line">        Temperature=46 C</span><br><span class="line">      Element 2 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0, OT failure=0, OT warning=0, UT failure=0</span><br><span class="line">        UT warning=0</span><br><span class="line">        Temperature=43 C</span><br><span class="line">      Element 3 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0, OT failure=0, OT warning=0, UT failure=0</span><br><span class="line">        UT warning=0</span><br><span class="line">        Temperature=78 C</span><br><span class="line">      Element 4 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0, OT failure=0, OT warning=0, UT failure=0</span><br><span class="line">        UT warning=0</span><br><span class="line">        Temperature=29 C</span><br><span class="line">    Element <span class="built_in">type</span>: Voltage sensor, subenclosure id: 0 [ti=5]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 0.00 volts</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 12.20 volts</span><br><span class="line">      Element 1 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 3.20 volts</span><br><span class="line">      Element 2 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 1.20 volts</span><br><span class="line">      Element 3 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 1.50 volts</span><br><span class="line">      Element 4 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 3.20 volts</span><br><span class="line">      Element 5 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 11.90 volts</span><br><span class="line">      Element 6 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 3.20 volts</span><br><span class="line">      Element 7 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 1.80 volts</span><br><span class="line">      Element 8 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 0.90 volts</span><br><span class="line">      Element 9 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 0.90 volts</span><br><span class="line">      Element 10 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 1.80 volts</span><br><span class="line">      Element 11 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 0.80 volts</span><br><span class="line">      Element 12 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 0.90 volts</span><br><span class="line">      Element 13 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 1.80 volts</span><br><span class="line">      Element 14 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 0.90 volts</span><br><span class="line">      Element 15 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Fail=0,  Warn Over=0, Warn Under=0, Crit Over=0</span><br><span class="line">        Crit Under=0</span><br><span class="line">        Voltage: 0.90 volts</span><br><span class="line">    Element <span class="built_in">type</span>: Cooling, subenclosure id: 0 [ti=6]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        Ident=0, Hot swap=0, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=0 rpm, Fan stopped</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=12000 rpm, Fan stopped</span><br><span class="line">      Element 1 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=11700 rpm, Fan stopped</span><br><span class="line">      Element 2 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=11100 rpm, Fan stopped</span><br><span class="line">      Element 3 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=11700 rpm, Fan stopped</span><br><span class="line">      Element 4 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=11800 rpm, Fan stopped</span><br><span class="line">      Element 5 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=11000 rpm, Fan stopped</span><br><span class="line">      Element 6 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=10900 rpm, Fan stopped</span><br><span class="line">      Element 7 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=11900 rpm, Fan stopped</span><br><span class="line">      Element 8 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=10800 rpm, Fan stopped</span><br><span class="line">      Element 9 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=0, Hot swap=1, Fail=0, Requested on=0, Off=0</span><br><span class="line">        Actual speed=11000 rpm, Fan stopped</span><br><span class="line">    Element <span class="built_in">type</span>: Power supply, subenclosure id: 0 [ti=7]</span><br><span class="line">      Overall descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: Unsupported</span><br><span class="line">        Ident=0, DC overvoltage=0, DC undervoltage=0, DC overcurrent=0</span><br><span class="line">        Hot swap=0, Fail=0, Requested on=0, Off=0, Overtmp fail=0</span><br><span class="line">        Temperature warn=0, AC fail=0, DC fail=0</span><br><span class="line">      Element 0 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=1, DC overvoltage=0, DC undervoltage=0, DC overcurrent=0</span><br><span class="line">        Hot swap=1, Fail=0, Requested on=1, Off=0, Overtmp fail=0</span><br><span class="line">        Temperature warn=0, AC fail=0, DC fail=0</span><br><span class="line">      Element 1 descriptor:</span><br><span class="line">        Predicted failure=1, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=1, DC overvoltage=0, DC undervoltage=0, DC overcurrent=0</span><br><span class="line">        Hot swap=1, Fail=0, Requested on=1, Off=0, Overtmp fail=0</span><br><span class="line">        Temperature warn=0, AC fail=0, DC fail=0</span><br><span class="line">      Element 2 descriptor:</span><br><span class="line">        Predicted failure=1, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=1, DC overvoltage=0, DC undervoltage=0, DC overcurrent=0</span><br><span class="line">        Hot swap=1, Fail=0, Requested on=1, Off=0, Overtmp fail=0</span><br><span class="line">        Temperature warn=0, AC fail=0, DC fail=0</span><br><span class="line">      Element 3 descriptor:</span><br><span class="line">        Predicted failure=0, Disabled=0, Swap=0, status: OK</span><br><span class="line">        Ident=1, DC overvoltage=0, DC undervoltage=0, DC overcurrent=0</span><br><span class="line">        Hot swap=1, Fail=0, Requested on=1, Off=0, Overtmp fail=0</span><br><span class="line">        Temperature warn=0, AC fail=0, DC fail=0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">[0:0:9:0]    disk    HGST     HUH721010AL5200  LS14  /dev/sdj   35000cca26c1b8630  /dev/sg9   10.0TB</span><br><span class="line"></span><br><span class="line">Element 9 descriptor: Drive Slot 9</span><br><span class="line"></span><br><span class="line">      Element index: 9  eiioe=0</span><br><span class="line">        Transport protocol: SAS</span><br><span class="line">        number of phys: 2, not all phys: 0, device slot number: 9</span><br><span class="line">        phy index: 0</span><br><span class="line">          SAS device <span class="built_in">type</span>: end device</span><br><span class="line">          initiator port <span class="keyword">for</span>:</span><br><span class="line">          target port <span class="keyword">for</span>: SSP</span><br><span class="line">          attached SAS address: 0x500056b3787358ff</span><br><span class="line">          SAS address: 0x5000cca26c1b8631</span><br><span class="line">          phy identifier: 0x0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Turn off the device slot power</span></span><br><span class="line">$ sg_ses --descriptor=<span class="string">&quot;Drive Slot 9&quot;</span> --<span class="built_in">set</span>=3:4:1 /dev/sg12</span><br><span class="line"></span><br><span class="line">$ sg_ses --descriptor=<span class="string">&quot;Drive Slot 9&quot;</span> --get=3:4:1 /dev/sg12</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Turn on the device slot power</span></span><br><span class="line">$ sg_ses --descriptor=<span class="string">&quot;Drive Slot 9&quot;</span> --clear=3:4:1 /dev/sg12</span><br><span class="line"></span><br><span class="line"><span class="comment">########## Power</span></span><br><span class="line">    Element <span class="built_in">type</span>: Power supply, subenclosure id: 0 [ti=7]</span><br><span class="line">      Overall descriptor: PowerSupplyStatus</span><br><span class="line">      Element 0 descriptor: PWS1</span><br><span class="line">      Element 1 descriptor: PWS2</span><br><span class="line">      Element 2 descriptor: PWS3</span><br><span class="line">      Element 3 descriptor: PWS4</span><br><span class="line"></span><br><span class="line"><span class="comment"># Turn off PWS1</span></span><br><span class="line">$ sg_ses --discriptor=<span class="string">&quot;PWS1&quot;</span> --clear=3:5:1 /dev/sg291</span><br><span class="line"></span><br><span class="line"><span class="comment"># Power on </span></span><br><span class="line">$ sg_ses --discriptor=<span class="string">&quot;PWS1&quot;</span> --<span class="built_in">set</span>=3:5:1 /dev/sg291</span><br><span class="line"></span><br><span class="line"><span class="comment">############ Fan</span></span><br><span class="line">    Element <span class="built_in">type</span>: Cooling, subenclosure id: 0 [ti=6]</span><br><span class="line">      Overall descriptor: CoolingElementInSubEnclsr0</span><br><span class="line">      Element 0 descriptor: Fan1</span><br><span class="line">      Element 1 descriptor: Fan2</span><br><span class="line">      Element 2 descriptor: Fan3</span><br><span class="line">      Element 3 descriptor: Fan4</span><br><span class="line">      Element 4 descriptor: Fan5</span><br><span class="line">      Element 5 descriptor: Fan1C</span><br><span class="line">      Element 6 descriptor: Fan2C</span><br><span class="line">      Element 7 descriptor: Fan3C</span><br><span class="line">      Element 8 descriptor: Fan4C</span><br><span class="line">      Element 9 descriptor: Fan5C</span><br><span class="line"></span><br><span class="line"><span class="comment">#Light the FAN led</span></span><br><span class="line">$ sg_ses --descriptor=Fan1C --<span class="built_in">set</span>=1:7:1 /dev/sg291</span><br><span class="line"></span><br><span class="line"><span class="comment">#REQUESTED SPEED MODE  PWM</span></span><br><span class="line">7 Full speed</span><br><span class="line">6 Second highest </span><br><span class="line">5 third highest</span><br><span class="line">4 Intermediate</span><br><span class="line">3 Third Loweest</span><br><span class="line">2 Second lowest</span><br><span class="line">1 Lowest speed</span><br><span class="line">0 Leave at current speed</span><br><span class="line"></span><br><span class="line">$ sg_ses --descriptor=Fan1C --<span class="built_in">set</span>=3:2:3=7 /dev/sg291</span><br><span class="line">$ sg_ses --descriptor=Fan1C --<span class="built_in">set</span>=3:2:3=5 /dev/sg291</span><br><span class="line"></span><br></pre></td></tr></table></figure><table><thead><tr><th>Byte Bit</th><th align="center">7</th><th align="right">6</th><th align="right">5</th><th align="right">4</th><th align="right">3</th><th align="right">2</th><th align="right">1</th><th align="right">0</th></tr></thead><tbody><tr><td>0</td><td align="center">select</td><td align="right">PRDFAIL</td><td align="right">DISABLED</td><td align="right">RST SWAP</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td></tr><tr><td>1</td><td align="center">RQST IDENT</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td></tr><tr><td>2</td><td align="center">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">RESERVED</td></tr><tr><td>3</td><td align="center">RESERVED</td><td align="right">RQST FAIL</td><td align="right">RQST ON</td><td align="right">RESERVED</td><td align="right">RESERVED</td><td align="right">REQUESTED SPEED CODE</td><td align="right">REQUESTED SPEED CODE</td><td align="right">REQUESTED SPEED CODE</td></tr></tbody></table><h4 id="Avoid-multiple-JBOD-devs-across-in-single-raidz"><a href="#Avoid-multiple-JBOD-devs-across-in-single-raidz" class="headerlink" title="Avoid multiple JBOD devs across in single raidz"></a>Avoid multiple JBOD devs across in single raidz</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tempdir=/tmp;</span><br><span class="line">lsscsi -tiv  | sed -z <span class="string">&#x27;s/\n  dir:/ /g&#x27;</span> | awk -v tempdir=<span class="string">&quot;<span class="variable">$tempdir</span>&quot;</span> -F <span class="string">&#x27;[:\\[/ ]+&#x27;</span> <span class="string">&#x27;$10!~/-/ &amp;&amp; $0~/disk/ &amp;&amp; $7~/sas/ &#123;print &quot;/dev/disk/by-id/scsi-&quot;$11,$2 &gt; tempdir&quot;/&quot;$30&quot;_&quot;$31&quot;_&quot;$32&quot;_&quot;$33&quot;_&quot;$34&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="map-element-index-and-sas-addr"><a href="#map-element-index-and-sas-addr" class="headerlink" title="map element index and sas addr"></a>map element index and sas addr</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[0:0:12:0]   enclosu DP       BP14G+EXP        2.25  -          -  /dev/sg12</span><br><span class="line"></span><br><span class="line">$ sg_ses -p 0xa /dev/sg12 | awk <span class="string">&#x27;&#123;if($0!~/0x0000000000000000/ &amp;&amp; $0!~/attached SAS address/) &#123;if ($0~/Element index/) &#123;printf &quot;Element_index &quot;$3&quot; &quot;&#125;; if ($0~/number of phys/) &#123;printf &quot;slot &quot;$NF&quot; &quot;&#125;; if ($0~/SAS address/) &#123;print &quot;sasaddr &quot;$NF&#125; &#125;&#125;&#x27;</span></span><br><span class="line">Element_index 0 slot 0 sasaddr 0x500056b3787358c0</span><br><span class="line">Element_index 1 slot 1 sasaddr 0x500056b3787358c1</span><br><span class="line">Element_index 2 slot 2 sasaddr 0x500056b3787358c2</span><br><span class="line">Element_index 3 slot 3 sasaddr 0x500056b3787358c3</span><br><span class="line">Element_index 4 slot 4 sasaddr 0x500056b3787358c4</span><br><span class="line">Element_index 5 slot 5 sasaddr 0x500056b3787358c5</span><br><span class="line">Element_index 6 slot 6 sasaddr 0x500056b3787358c6</span><br><span class="line">Element_index 7 slot 7 sasaddr 0x500056b3787358c7</span><br><span class="line">Element_index 8 slot 8 sasaddr 0x500056b3787358c8</span><br><span class="line">Element_index 9 slot 9 sasaddr 0x500056b3787358c9</span><br><span class="line">Element_index 10 slot 10 sasaddr 0x500056b3787358ca</span><br></pre></td></tr></table></figure><h3 id="SATA"><a href="#SATA" class="headerlink" title="SATA"></a>SATA</h3><h4 id="Enable-SATA-TLER-ERC-CCTL"><a href="#Enable-SATA-TLER-ERC-CCTL" class="headerlink" title="Enable SATA TLER/ERC/CCTL"></a>Enable SATA TLER/ERC/CCTL</h4><p>Western Digital/HGST TLER - Time-Limited Error Recovery<br>Seagate ERC- Error Recovery Control<br>Hitachi/Samsung CCTL - Command Completion Time Limit</p><p>Streaming Commands<br>When the device is in standby mode, Streaming Commands cant be completed<br>while waiting for the spindle to reach operating speed even if execution time<br>exceeds specified CCTL(Command Completion Time Limit). The minimum CCTL<br>is 50ms.CCTL is set to 50ms when the specified value is shorter than 50ms.</p><p>SCT<br>When the device is in standby mode, any command where error recovery time<br>limit is specified cant be completed while waiting for the spindle to reach operating<br>speed even if execution time exceeds specified recovery time limit. The minimum<br>time limit is 6.5 second. When the specified time limit is shorter than 6.5 second,<br>the issued command is aborted.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ lsscsi -gi | grep sdy</span><br><span class="line">[1:0:18:0]   disk    ATA      HGST HUH721212AL T3D0  /dev/sdy   -  /dev/sg25</span><br><span class="line"></span><br><span class="line">$ smartctl -l scterc,70,70 /dev/sdy</span><br><span class="line">smartctl 6.5 2016-05-07 r4318 [x86_64-linux-3.10.0-957.el7_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">SCT Error Recovery Control <span class="built_in">set</span> to:</span><br><span class="line">           Read:     70 (7.0 seconds)</span><br><span class="line">          Write:     70 (7.0 seconds)</span><br><span class="line"></span><br><span class="line">$ smartctl -l scterc /dev/sdy</span><br><span class="line">martctl 6.5 2016-05-07 r4318 [x86_64-linux-3.10.0-957.el7_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-16, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">SCT Error Recovery Control:</span><br><span class="line">           Read:     70 (7.0 seconds)</span><br><span class="line">          Write:     70 (7.0 seconds)</span><br></pre></td></tr></table></figure><h3 id="Get-hide-area-from-SATA-SSD"><a href="#Get-hide-area-from-SATA-SSD" class="headerlink" title="Get hide area from SATA SSD"></a><a href="https://tinyapps.org/docs/wipe_drives_hdparm.html">Get hide area from SATA SSD</a></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">$ hdparm -I /dev/sdx</span><br><span class="line">....</span><br><span class="line">Security:</span><br><span class="line">        Master password revision code = 65534</span><br><span class="line">                supported</span><br><span class="line">        not     enabled</span><br><span class="line">        not     locked</span><br><span class="line">        not     frozen</span><br><span class="line">        not     expired: security count</span><br><span class="line">                supported: enhanced erase</span><br><span class="line">        4min for SECURITY ERASE UNIT. 4min for ENHANCED SECURITY ERASE UNIT.</span><br><span class="line"></span><br><span class="line"><span class="comment"># set password</span></span><br><span class="line">$ hdparm <span class="comment">--user-master u --security-set-pass p /dev/sdx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Erase the dev</span></span><br><span class="line">$ hdparm <span class="comment">--user-master u --security-erase p /dev/sdx</span></span><br><span class="line"><span class="comment"># if you dev support security-erase-enhanced, you could use security-erase-enhanced</span></span><br><span class="line">Secure erase overwrites all user data areas <span class="keyword">with</span> <span class="built_in">binary</span> zeroes. Enhanced secure erase writes predetermined <span class="keyword">data</span> patterns (<span class="keyword">set</span> <span class="keyword">by</span> the manufacturer) <span class="keyword">to</span> <span class="keyword">all</span> <span class="keyword">user</span> <span class="keyword">data</span> areas, <span class="keyword">including</span> sectors that <span class="keyword">are</span> <span class="keyword">no</span> longer <span class="keyword">in</span> <span class="keyword">use</span> due <span class="keyword">to</span> reallocation. ***NOTE: the enhanced secure erase <span class="keyword">option</span> <span class="keyword">is</span> <span class="keyword">not</span> supported <span class="keyword">by</span> <span class="keyword">all</span> ATA drives.</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">after</span> <span class="keyword">security</span>-erase</span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdx bs=<span class="number">8192</span> <span class="keyword">status</span>=progress | hexdump</span><br><span class="line"><span class="number">0000000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if your dev has locked</span></span><br><span class="line">    <span class="keyword">locked</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#unlock</span></span><br><span class="line">$ hdparm <span class="comment">--user-master u --security-unlock p /dev/sdx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#disable security</span></span><br><span class="line">$ hdparm <span class="comment">--user-master u --security-disable p /dev/sdx</span></span><br><span class="line"></span><br><span class="line">$ hdparm -I /dev/sdx</span><br><span class="line"><span class="keyword">not</span>     enabled</span><br><span class="line"><span class="keyword">not</span>     <span class="keyword">locked</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## hide Areas</span></span><br><span class="line">$ hdparm -N /dev/sda</span><br><span class="line"></span><br><span class="line">/dev/sda:</span><br><span class="line"> READ_NATIVE_MAX_ADDRESS_EXT <span class="keyword">failed</span>: <span class="keyword">Input</span>/<span class="keyword">output</span> <span class="keyword">error</span></span><br><span class="line"></span><br><span class="line">$ hdparm -N /dev/sdd</span><br><span class="line"></span><br><span class="line">/dev/sdd:</span><br><span class="line"> <span class="keyword">max</span> sectors   = <span class="number">3907029168</span>/<span class="number">3907029168</span>, HPA <span class="keyword">is</span> disabled</span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line">$ hdparm -N /dev/sdx</span><br><span class="line"></span><br><span class="line">/dev/sdx:</span><br><span class="line"><span class="keyword">max</span> sectors   = <span class="number">78125000</span>/<span class="number">78165360</span>, HPA <span class="keyword">is</span> enabled</span><br><span class="line"></span><br><span class="line">$ hdparm -N p78165360 /dev/sdx</span><br><span class="line"></span><br><span class="line">/dev/sdx:</span><br><span class="line">setting <span class="keyword">max</span> <span class="keyword">visible</span> sectors <span class="keyword">to</span> <span class="number">78165360</span> (<span class="keyword">permanent</span>)</span><br><span class="line"><span class="keyword">max</span> sectors   = <span class="number">78165360</span>/<span class="number">78165360</span>, HPA <span class="keyword">is</span> disabled</span><br><span class="line"></span><br><span class="line">$ hdparm <span class="comment">--dco-identify /dev/sdx</span></span><br><span class="line"></span><br><span class="line">/dev/sdx:</span><br><span class="line">DCO Revision: <span class="number">0x0001</span></span><br><span class="line">The <span class="keyword">following</span> features can be selectively disabled via DCO:</span><br><span class="line">       Transfer modes:</span><br><span class="line">                udma0 udma1 udma2 udma3 udma4 udma5</span><br><span class="line">       <span class="built_in">Real</span> <span class="keyword">max</span> sectors: <span class="number">78165360</span></span><br><span class="line">       ATA command/feature <span class="keyword">sets</span>:</span><br><span class="line">                AAM HPA</span><br><span class="line"></span><br><span class="line">$ hdparm <span class="comment">--dco-restore /dev/sdx</span></span><br><span class="line"></span><br><span class="line">/dev/sdx:</span><br><span class="line"><span class="keyword">Use</span> <span class="keyword">of</span> <span class="comment">--dco-restore is VERY DANGEROUS.</span></span><br><span class="line">You <span class="keyword">are</span> trying <span class="keyword">to</span> deliberately <span class="keyword">reset</span> your drive configuration back <span class="keyword">to</span></span><br><span class="line">the factory defaults.</span><br><span class="line">This may <span class="keyword">change</span> the apparent <span class="keyword">capacity</span> <span class="keyword">and</span> feature <span class="keyword">set</span> <span class="keyword">of</span> the drive,</span><br><span class="line">making <span class="keyword">all</span> <span class="keyword">data</span> <span class="keyword">on</span> it inaccessible.</span><br><span class="line">You could lose *everything*.</span><br><span class="line">Please supply the <span class="comment">--yes-i-know-what-i-am-doing flag if you really want this.</span></span><br><span class="line">Program aborted.</span><br><span class="line"></span><br><span class="line">$ hdparm <span class="comment">--yes-i-know-what-i-am-doing --dco-restore /dev/sdx</span></span><br><span class="line"></span><br><span class="line">/dev/sdx:</span><br><span class="line">issuing DCO <span class="keyword">restore</span> command</span><br></pre></td></tr></table></figure><h3 id="Enable-SAS-SATA-dev-cache"><a href="#Enable-SAS-SATA-dev-cache" class="headerlink" title="Enable SAS/SATA dev cache"></a>Enable SAS/SATA dev cache</h3><h4 id="SAS-cache"><a href="#SAS-cache" class="headerlink" title="SAS cache"></a>SAS cache</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#simple way</span></span><br><span class="line"><span class="string">$</span> <span class="string">sdparm</span> <span class="string">-s</span> <span class="string">WCE=1,RCD=0</span> <span class="string">/dev/sdX</span></span><br><span class="line"></span><br><span class="line"><span class="string">Byte</span>  <span class="number">7</span>   <span class="number">6</span>    <span class="number">5</span>   <span class="number">4</span>    <span class="number">3</span>   <span class="number">2</span>   <span class="number">1</span>   <span class="number">0</span>               <span class="string">Default</span></span><br><span class="line"><span class="number">0</span>    <span class="string">ps</span> <span class="number">0</span>  <span class="string">page</span> <span class="string">code=08h</span>                             <span class="string">88h</span></span><br><span class="line"><span class="number">1</span>    <span class="string">page</span> <span class="string">length</span> <span class="string">=</span> <span class="string">12h</span>                               <span class="string">12h</span></span><br><span class="line"><span class="number">2</span>    <span class="string">ic</span> <span class="string">ABPF</span> <span class="string">CAP</span> <span class="string">DISC</span> <span class="string">SIZE</span> <span class="string">WCE</span> <span class="string">MF</span> <span class="string">RCD</span>                <span class="string">04h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#show detail</span></span><br><span class="line"><span class="string">$</span> <span class="string">sg_wr_mode</span> <span class="string">-p</span> <span class="number">0x8</span> <span class="string">/dev/sda</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span> <span class="literal">No</span> <span class="string">contents</span> <span class="string">given,</span> <span class="attr">so show current mode page data:</span></span><br><span class="line">  <span class="attr">header:</span></span><br><span class="line"><span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">08</span></span><br><span class="line">  <span class="string">block</span> <span class="string">descriptor(s):</span></span><br><span class="line"><span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span></span><br><span class="line">  <span class="attr">mode page:</span></span><br><span class="line"><span class="number">88</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">00</span>  <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Enable read and write cache</span></span><br><span class="line"><span class="string">$</span> <span class="string">sg_wr_mode</span> <span class="string">-p</span> <span class="number">0x8</span> <span class="string">/dev/sda</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span> <span class="literal">No</span> <span class="string">contents</span> <span class="string">given,</span> <span class="attr">so show current mode page data:</span></span><br><span class="line">  <span class="attr">header:</span></span><br><span class="line"><span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">08</span></span><br><span class="line">  <span class="string">block</span> <span class="string">descriptor(s):</span></span><br><span class="line"><span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span></span><br><span class="line">  <span class="attr">mode page:</span></span><br><span class="line"><span class="number">88</span> <span class="number">12</span> <span class="number">04</span> <span class="number">00</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">00</span>  <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Disable all</span></span><br><span class="line"><span class="string">$</span> <span class="string">sg_wr_mode</span> <span class="string">-p</span> <span class="number">0x8</span> <span class="string">/dev/sda</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span> <span class="literal">No</span> <span class="string">contents</span> <span class="string">given,</span> <span class="attr">so show current mode page data:</span></span><br><span class="line">  <span class="attr">header:</span></span><br><span class="line"><span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">08</span></span><br><span class="line">  <span class="string">block</span> <span class="string">descriptor(s):</span></span><br><span class="line"><span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span></span><br><span class="line">  <span class="attr">mode page:</span></span><br><span class="line"><span class="number">88</span> <span class="number">12</span> <span class="number">05</span> <span class="number">00</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">00</span>  <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="string">ff</span> <span class="number">00</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><h4 id="SATA-cache"><a href="#SATA-cache" class="headerlink" title="SATA cache"></a>SATA cache</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#simple way</span><br><span class="line">$ hdparm -W1 /dev/sdc</span><br><span class="line"></span><br><span class="line">#show detail</span><br><span class="line">$ sg_sat_set_features --feature=<span class="number">2</span>h -v /dev/sdc #Enable write cache</span><br><span class="line">    ATA pass-through(<span class="number">16</span>) cdb: <span class="number">85</span> <span class="number">06</span> <span class="number">0</span>c <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ef <span class="number">00</span></span><br><span class="line">    <span class="number">85</span>      -     <span class="number">0x7429</span>   Commands <span class="keyword">and</span> feature sets supported <span class="keyword">or</span> enabled</span><br><span class="line">   <span class="number">255</span>      -     <span class="number">0xe0a5</span>   Integrity word</span><br><span class="line">   <span class="number">255</span>     <span class="number">15</span>:<span class="number">8</span>     <span class="number">0xe0</span>   Checksum</span><br><span class="line"><span class="number">0x7429</span>=<span class="number">111</span>,<span class="number">0100</span>,<span class="number">0010</span>,<span class="number">1001</span></span><br><span class="line"></span><br><span class="line">$ sg_sat_set_features --feature=AAh -v /dev/sdc #after enable write cache, <span class="keyword">continue</span> to enabel read cahe</span><br><span class="line">    ATA pass-through(<span class="number">16</span>) cdb: <span class="number">85</span> <span class="number">06</span> <span class="number">0</span>c <span class="number">00</span> aa <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ef <span class="number">00</span></span><br><span class="line">    <span class="number">85</span>      -     <span class="number">0x7469</span>   Commands <span class="keyword">and</span> feature sets supported <span class="keyword">or</span> enabled   </span><br><span class="line">   <span class="number">255</span>      -     <span class="number">0xa0a5</span>   Integrity word</span><br><span class="line">   <span class="number">255</span>     <span class="number">15</span>:<span class="number">8</span>     <span class="number">0xa0</span>   Checksum</span><br><span class="line"><span class="number">0x7469</span>=<span class="number">111</span>,<span class="number">0100</span>,<span class="number">0110</span>,<span class="number">1001</span></span><br><span class="line">   </span><br><span class="line">$ sg_sat_set_features --feature=<span class="number">55</span>h -v /dev/sdc #disable read cache</span><br><span class="line">    ATA pass-through(<span class="number">16</span>) cdb: <span class="number">85</span> <span class="number">06</span> <span class="number">0</span>c <span class="number">00</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ef <span class="number">00</span></span><br><span class="line">    <span class="number">85</span>      -     <span class="number">0x7429</span>   Commands <span class="keyword">and</span> feature sets supported <span class="keyword">or</span> enabled</span><br><span class="line">    <span class="number">85</span>      <span class="number">5</span>          <span class="number">1</span>   Write cache enabled  ## Here will <span class="built_in">auto</span> add a new line</span><br><span class="line">   <span class="number">255</span>      -     <span class="number">0xe0a5</span>   Integrity word</span><br><span class="line">   <span class="number">255</span>     <span class="number">15</span>:<span class="number">8</span>     <span class="number">0xe0</span>   Checksum</span><br><span class="line"><span class="number">0x7429</span>=<span class="number">111</span>,<span class="number">0100</span>,<span class="number">0010</span>,<span class="number">1001</span></span><br><span class="line"></span><br><span class="line">$ sg_sat_set_features --feature=<span class="number">82</span>h -v /dev/sdc #after disable read cache, <span class="keyword">continue</span> to disable write cache</span><br><span class="line">    ATA pass-through(<span class="number">16</span>) cdb: <span class="number">85</span> <span class="number">06</span> <span class="number">0</span>c <span class="number">00</span> <span class="number">82</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> ef <span class="number">00</span></span><br><span class="line">    <span class="number">85</span>      -     <span class="number">0x7409</span>   Commands <span class="keyword">and</span> feature sets supported <span class="keyword">or</span> enabled</span><br><span class="line">   <span class="number">255</span>      -     <span class="number">0x00a5</span>   Integrity word</span><br><span class="line"><span class="number">0x7409</span>=<span class="number">111</span>,<span class="number">0100</span>,<span class="number">0000</span>,<span class="number">1001</span></span><br></pre></td></tr></table></figure><p>Set Features (EFh)</p><table><thead><tr><th align="center">FUNCTION</th><th align="center">FEATURES REGISTER</th><th align="center">SECTOR COUNTREGISTER</th></tr></thead><tbody><tr><td align="center">Enable read cache1</td><td align="center">AAh</td><td align="center">Dont care</td></tr><tr><td align="center">Disable read cache1</td><td align="center">55h</td><td align="center">Dont care</td></tr><tr><td align="center">Enable write cache1</td><td align="center">02h</td><td align="center">Dont care</td></tr><tr><td align="center">Disable write cache1</td><td align="center">82h</td><td align="center">Dont care</td></tr><tr><td align="center">Set Transfer Mode</td><td align="center">03h</td><td align="center">Dont care</td></tr><tr><td align="center">Enable use of Serial ATA Feature</td><td align="center">10h</td><td align="center">02h-DMA Setup FIS Auto-Activate optimization 06h-Software Settings</td></tr><tr><td align="center">Disable use of Serial ATA Feature</td><td align="center">90h</td><td align="center">02h-DMA Setup FIS Auto-Activate optimization 06h-Software Settings</td></tr></tbody></table><p>Note: Changes are only valid while power remains applied to the drive. After power is cycled, the drive reverts to the<br>default settings.</p><p>Sends an ATA SET FEATURES command via a SAT pass through.<br>Primary feature code is placed in feature=FEA with count=CO and lba=LBA being auxiliaries for some features.  The arguments CO, FEA and LBA are decimal unless prefixed by 0x or have a trailing h.</p><h3 id="sector-size"><a href="#sector-size" class="headerlink" title="sector size"></a><a href="http://people.redhat.com/msnitzer/docs/linux-advanced-storage-6.1.pdf">sector size</a></h3><h4 id="512e-SATA"><a href="#512e-SATA" class="headerlink" title="512e SATA"></a>512e SATA</h4><p>the first logical block does begin on a boundary aligned to the physical block size</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> 106      -     0x6003   Physical sector size / logical sector size</span><br><span class="line"> 106     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"> 106     13          1   Multiple logical sectors per physical sector</span><br><span class="line"> 106      3:0      0x3   2^X logical sectors per physical sector</span><br><span class="line">...</span><br><span class="line"> 209      -     0x4000   Alignment of logical sectors</span><br><span class="line"> 209     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"></span><br><span class="line">$ dc -e <span class="string">&#x27;16i2o0x6003p&#x27;</span></span><br><span class="line">110000000000011</span><br><span class="line">110,0000,0000,0011 &lt;- 2^3=8, 512 Bytes x 8 = 4096 Bytes (phy)</span><br><span class="line"> ^</span><br><span class="line"> |</span><br><span class="line"><span class="comment">#Word 106 bit 15 must be 0 and bit 14 must be 1. This signals that word 106 is valid. Bit 13 must be set to indicate that bits 3:0 are valid and that word 209 is specified.</span></span><br><span class="line">first 110, I guess 0 means 3:0 are valid  and that word 209 is specified</span><br><span class="line"></span><br><span class="line"><span class="comment">#Bits 3:0 indicate the physical block size exponent. I.e. 2n logical blocks/physical block. For a drive with 4096-byte physical blocks and 512-byte logical blocks, a value of 3 is reported in bits 3:0 (23 = 8).</span></span><br><span class="line"></span><br><span class="line">$ dc -e <span class="string">&#x27;16i2o0x4000p&#x27;</span></span><br><span class="line">100000000000000</span><br><span class="line">100,0000,0000,0000</span><br></pre></td></tr></table></figure><p>If the first logical block does <code>not</code> begin on a boundary aligned to the physical block size<br>word 209 should be reported by the device. Bit 15 must be zero, bit 14 must be 1. Bits 13:0 indicate the logical sector offset within the first physical sector where the first logical sector is placed.<br>For compatibility with legacy operating systems some vendors may align the blocks so that LBA 63 falls on a physical block boundary. In that case an alignment of 1 should be reported.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### I have not reproduce this case</span></span><br><span class="line">IDENTIFY DEVICE 106 0110 0000 0000 0011 0x6003</span><br><span class="line">IDENTIFY DEVICE 209 0100 0000 0000 0001 0x4001</span><br></pre></td></tr></table></figure><h4 id="4KN"><a href="#4KN" class="headerlink" title="4KN"></a>4KN</h4><p>If a drive uses 4KiB logical and physical blocks, IDENTIFY DEVICE words 106, 117, and 118 must be specified.<br>Word 106 bit 15 must be 0 and bit 14 must be 1. This signals that word 106 is valid. Bit 12 must be set to indicate that words 117 and 118 are specified.<br>Word 117 (LSB) and 118 (MSB) specify the logical block size in words. </p><p>I.e. for a 4KiB drive that would be 2048.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IDENTIFY DEVICE 106 0101 0000 0000 0000 0x5000</span><br><span class="line">IDENTIFY DEVICE 117 0000 1000 0000 0000 0x0800 <span class="comment"># 2^11=2048=0x0800</span></span><br><span class="line">IDENTIFY DEVICE 118 0000 0000 0000 0000 0x0000</span><br></pre></td></tr></table></figure><h4 id="Nominal-media-rotation-rate"><a href="#Nominal-media-rotation-rate" class="headerlink" title="Nominal media rotation rate"></a>Nominal media rotation rate</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">217      -     0x1c20   Nominal media rotation rate</span><br><span class="line">$ dc -e <span class="string">&#x27;16i2o0x1c20p&#x27;</span></span><br><span class="line">100000</span><br><span class="line">10,0000</span><br><span class="line"><span class="comment"># why dell SATA HDD not be 0x1.</span></span><br><span class="line">IDENTIFY DEVICE 217 0000 0000 0000 0001 0x0001</span><br></pre></td></tr></table></figure><p>If the storage device is non-rotational (i.e. SSD or array) word 217 of IDENTIFY DEVICE should be set to one. The I/O scheduler may then be less agressive in terms of seek avoidance. Any other value reported in 217 will be ignored.</p><h3 id="Does-devices-support-the-scsi-Persistent-Reservation"><a href="#Does-devices-support-the-scsi-Persistent-Reservation" class="headerlink" title="Does devices support the scsi-Persistent-Reservation"></a>Does devices support the scsi-Persistent-Reservation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ sg_persist -c /dev/sdi</span><br><span class="line">  ATA       HGST HUH721010AL  LT14</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">PR <span class="keyword">in</span> (Report capabilities): <span class="built_in">command</span> not supported</span><br><span class="line">sg_persist failed: Illegal request, Invalid opcode</span><br><span class="line"></span><br><span class="line">$ sg_persist -c /dev/sdj</span><br><span class="line">  HGST      HUH721010AL5200   LS14</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">Report capabilities response:</span><br><span class="line">  Replace Lost Reservation Capable(RLR_C): 0</span><br><span class="line">  Compatible Reservation Handling(CRH): 0</span><br><span class="line">  Specify Initiator Ports Capable(SIP_C): 1</span><br><span class="line">  All Target Ports Capable(ATP_C): 1</span><br><span class="line">  Persist Through Power Loss Capable(PTPL_C): 1</span><br><span class="line">  Type Mask Valid(TMV): 1</span><br><span class="line">  Allow Commands: 0</span><br><span class="line">  Persist Through Power Loss Active(PTPL_A): 0</span><br><span class="line">    Support indicated <span class="keyword">in</span> Type mask:</span><br><span class="line">      Write Exclusive, all registrants: 0</span><br><span class="line">      Exclusive Access, registrants only: 1</span><br><span class="line">      Write Exclusive, registrants only: 1</span><br><span class="line">      Exclusive Access: 1</span><br><span class="line">      Write Exclusive: 1</span><br><span class="line">      Exclusive Access, all registrants: 0</span><br><span class="line"></span><br><span class="line">A: [1:0:14:0]   disk    HP       MK0800JVYPQ      HPD6  /dev/sdo   35001173d028c863c  /dev/sg16</span><br><span class="line">B: [1:0:14:0]   disk    HP       MK0800JVYPQ      HPD6  /dev/sdo   35001173d028c863c  /dev/sg16</span><br><span class="line"></span><br><span class="line">$ sg_persist --read-keys /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0x0, there are NO registered reservation keys</span><br><span class="line">$ sg_persist --read-reservation /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0x0, there is NO reservation held</span><br><span class="line">$ sg_persist /dev/sdo</span><br><span class="line">&gt;&gt; No service action given; assume Persistent Reserve In <span class="built_in">command</span></span><br><span class="line">&gt;&gt; with Read Keys service action</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0x0, there are NO registered reservation keys</span><br><span class="line">$ sg_persist -n -i -r -d /dev/sdo</span><br><span class="line">  PR generation=0x0, there is NO reservation held</span><br></pre></td></tr></table></figure><h4 id="Add-it-to-multipath-test-in-HUS-150-worked"><a href="#Add-it-to-multipath-test-in-HUS-150-worked" class="headerlink" title="Add it to multipath, test in HUS 150, worked"></a>Add it to multipath, test in HUS 150, worked</h4><p>mulitpath just for little device, not for software raid solution</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">no_path_retry queue</span><br><span class="line">features <span class="string">&quot;0&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Because-brain-split-zfs-will-corrupt"><a href="#Because-brain-split-zfs-will-corrupt" class="headerlink" title="Because brain-split, zfs will corrupt"></a>Because brain-split, zfs will corrupt</h3><p>process<br>register -&gt; reserve -&gt; preempt-abort -&gt; re-register another node</p><h4 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># register</span></span><br><span class="line">A $ openssl rand -hex 4</span><br><span class="line">f089a155</span><br><span class="line">A $ sg_persist --out --register --param-sark=f089a155 -d /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">A $ sg_persist --read-keys /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0x7, 1 registered reservation key follows:</span><br><span class="line">    0xf089a155</span><br></pre></td></tr></table></figure><h4 id="Reserve"><a href="#Reserve" class="headerlink" title="Reserve"></a>Reserve</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">A</span> $ sg_persist --out --reserve --param-rk=f<span class="number">089</span>a<span class="number">155</span> --prout-type=<span class="number">1</span> /dev/sdo</span><br><span class="line">  <span class="attribute">HP</span>        MK<span class="number">0800</span>JVYPQ       HPD<span class="number">6</span></span><br><span class="line">  <span class="attribute">Peripheral</span> device type: disk</span><br><span class="line"></span><br><span class="line"><span class="attribute">B</span> $ sg_persist --read-keys /dev/sdo</span><br><span class="line">  <span class="attribute">HP</span>        MK<span class="number">0800</span>JVYPQ       HPD<span class="number">6</span></span><br><span class="line">  <span class="attribute">Peripheral</span> device type: disk</span><br><span class="line">  <span class="attribute">PR</span> generation=<span class="number">0</span>xd, <span class="number">1</span> registered reservation key follows:</span><br><span class="line">    <span class="attribute">0xf089a155</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">B</span> $ sg_persist --read-reservation /dev/sdo</span><br><span class="line">  <span class="attribute">HP</span>        MK<span class="number">0800</span>JVYPQ       HPD<span class="number">6</span></span><br><span class="line">  <span class="attribute">Peripheral</span> device type: disk</span><br><span class="line">  <span class="attribute">PR</span> generation=<span class="number">0</span>xd, Reservation follows:</span><br><span class="line">    <span class="attribute">Key</span>=<span class="number">0</span>xf<span class="number">089</span>a<span class="number">155</span></span><br><span class="line">    <span class="attribute">scope</span>: LU_SCOPE,  type: Write Exclusive</span><br><span class="line"></span><br><span class="line"><span class="attribute">A</span> $ dd if=/dev/zero of=/dev/sdo bs=<span class="number">1</span>M count=<span class="number">10</span> oflag=sync</span><br><span class="line"><span class="attribute">10</span>+<span class="number">0</span> records in</span><br><span class="line"><span class="attribute">10</span>+<span class="number">0</span> records out</span><br><span class="line"><span class="attribute">10485760</span> bytes (<span class="number">10</span> MB) copied, <span class="number">0</span>.<span class="number">0191827</span> s, <span class="number">547</span> MB/s</span><br><span class="line"></span><br><span class="line"><span class="attribute">B</span> $ dd if=/dev/zero of=/dev/mapper/<span class="number">35000</span>cca<span class="number">2515</span>f<span class="number">34</span>c<span class="number">4</span> bs=<span class="number">1</span>M count=<span class="number">10</span> oflag=sync</span><br><span class="line"><span class="attribute">dd</span>: error writing /dev/sdo: Input/output error</span><br><span class="line"><span class="attribute">1</span>+<span class="number">0</span> records in</span><br><span class="line"><span class="attribute">0</span>+<span class="number">0</span> records out</span><br><span class="line"><span class="attribute">0</span> bytes (<span class="number">0</span> B) copied, <span class="number">0</span>.<span class="number">618006</span> s, <span class="number">0</span>.<span class="number">0</span> kB/s</span><br></pre></td></tr></table></figure><h4 id="Server-B-preempt-the-reservation"><a href="#Server-B-preempt-the-reservation" class="headerlink" title="Server B preempt the reservation"></a>Server B preempt the reservation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">B $ openssl rand -hex 4</span><br><span class="line">f7ec3033</span><br><span class="line">B $ sg_persist --read-keys /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0x1, 1 registered reservation key follows:</span><br><span class="line">    0xf089a155</span><br><span class="line"></span><br><span class="line">B $ sg_persist --out --register --param-sark=f7ec3033 -d /dev/sdo</span><br><span class="line">B $ sg_persist --read-keys /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0xa, 2 registered reservation keys follow:</span><br><span class="line">    0xf089a155</span><br><span class="line">    0xf7ec3033</span><br><span class="line"></span><br><span class="line">B $ sg_persist --read-reservation /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0xa, Reservation follows:</span><br><span class="line">    Key=0xf089a155</span><br><span class="line">    scope: LU_SCOPE,  <span class="built_in">type</span>: Write Exclusive</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">B $ sg_persist -n -o -A -K f7ec3033 -S f089a155  -T 1 -v -d /dev/sdo</span><br><span class="line">    Persistent Reservation Out cmd: 5f 05 01 00 00 00 00 00 18 00</span><br><span class="line">PR out: <span class="built_in">command</span> (Preempt and abort) successful</span><br><span class="line"></span><br><span class="line">B $ sg_persist --read-reservation -d /dev/sdo<span class="string">&quot;</span></span><br><span class="line"><span class="string">  HP        MK0800JVYPQ       HPD6</span></span><br><span class="line"><span class="string">  Peripheral device type: disk</span></span><br><span class="line"><span class="string">  PR generation=0xf, Reservation follows:</span></span><br><span class="line"><span class="string">    Key=0xf7ec3033</span></span><br><span class="line"><span class="string">    scope: LU_SCOPE,  type: Write Exclusive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A $ dd if=/dev/zero of=/dev/sdo bs=1M count=10 oflag=sync</span></span><br><span class="line"><span class="string">dd: error writing /dev/sdo: Input/output error</span></span><br><span class="line"><span class="string">1+0 records in</span></span><br><span class="line"><span class="string">0+0 records out</span></span><br><span class="line"><span class="string">0 bytes (0 B) copied, 0.617521 s, 0.0 kB/s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">B $ dd if=/dev/zero of=/dev/sdo bs=1M count=10 oflag=sync</span></span><br><span class="line"><span class="string">10+0 records in</span></span><br><span class="line"><span class="string">10+0 records out</span></span><br><span class="line"><span class="string">10485760 bytes (10 MB) copied, 0.0212361 s, 494 MB/s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### if you input wrong -K and -S value, it will return error</span></span><br><span class="line"><span class="string">B $ sg_persist -n -o -A -d /dev/sdo -K f7ec3zzz -S f08fsd55  -T 1 -v</span></span><br><span class="line"><span class="string">    Persistent Reservation Out cmd: 5f 05 01 00 00 00 00 00 18 00</span></span><br><span class="line"><span class="string">    persistent reserve out: scsi status: Reservation Conflict</span></span><br><span class="line"><span class="string">    PR out: command failed</span></span><br></pre></td></tr></table></figure><h4 id="After-preempt-abort-Server-A-preempt-the-reservation"><a href="#After-preempt-abort-Server-A-preempt-the-reservation" class="headerlink" title="After preempt-abort, Server A preempt the reservation"></a>After preempt-abort, Server A preempt the reservation</h4><p>Need to be register again</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">A $ sg_persist --read-keys /dev/sdo<span class="string">&quot;</span></span><br><span class="line"><span class="string">  HP        MK0800JVYPQ       HPD6</span></span><br><span class="line"><span class="string">  Peripheral device type: disk</span></span><br><span class="line"><span class="string">  PR generation=0xf, 1 registered reservation key follows:</span></span><br><span class="line"><span class="string">    0xf7ec3033</span></span><br><span class="line"><span class="string">A $ sg_persist --out --register --param-sark=f089a155 -d /dev/sdo</span></span><br><span class="line"><span class="string">  HP        MK0800JVYPQ       HPD6</span></span><br><span class="line"><span class="string">  Peripheral device type: disk</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A $ sg_persist --read-keys /dev/sdo</span></span><br><span class="line"><span class="string">  HP        MK0800JVYPQ       HPD6</span></span><br><span class="line"><span class="string">  Peripheral device type: disk</span></span><br><span class="line"><span class="string">  PR generation=0x10, 2 registered reservation keys follow:</span></span><br><span class="line"><span class="string">    0xf089a155</span></span><br><span class="line"><span class="string">    0xf7ec3033</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A $ sg_persist -n -o -A -K f089a155 -S f7ec3033  -T 1 -v -d /dev/sdo</span></span><br><span class="line"><span class="string">    Persistent Reservation Out cmd: 5f 05 01 00 00 00 00 00 18 00</span></span><br><span class="line"><span class="string">PR out: command (Preempt and abort) successful</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A $ sg_persist --read-reservation /dev/sdo</span></span><br><span class="line"><span class="string">  HP        MK0800JVYPQ       HPD6</span></span><br><span class="line"><span class="string">  Peripheral device type: disk</span></span><br><span class="line"><span class="string">  PR generation=0x11, Reservation follows:</span></span><br><span class="line"><span class="string">    Key=0xf089a155</span></span><br><span class="line"><span class="string">    scope: LU_SCOPE,  type: Write Exclusive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A $ dd if=/dev/zero of=/dev/sdo bs=1M count=10 oflag=sync</span></span><br><span class="line"><span class="string">10+0 records in</span></span><br><span class="line"><span class="string">10+0 records out</span></span><br><span class="line"><span class="string">10485760 bytes (10 MB) copied, 0.0188563 s, 556 MB/s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">B $ dd if=/dev/zero of=/dev/sdo bs=1M count=10 oflag=sync&quot;</span></span><br><span class="line">dd: error writing /dev/sdo: Input/output error</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes (0 B) copied, 0.744081 s, 0.0 kB/s</span><br></pre></td></tr></table></figure><h4 id="Prout-type"><a href="#Prout-type" class="headerlink" title="Prout-type"></a>Prout-type</h4><p>1-&gt; write exclusive<br>3-&gt; exclusive access<br>5-&gt; write exclusive - registrants only<br>6-&gt; exclusive access - registrants only<br>7-&gt; write exclusive - all registrants<br>8-&gt; exclusive access - all registrants</p><h4 id="Release-reservation"><a href="#Release-reservation" class="headerlink" title="Release reservation"></a>Release reservation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sg_persist --out --release -K f089a155 --prout-type=1 /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line"></span><br><span class="line">$ sg_persist --<span class="keyword">in</span> -r --no-inquiry -d /dev/sdo</span><br><span class="line">  PR generation=0x5f, there is NO reservation held</span><br><span class="line"></span><br><span class="line">$ sg_persist --read-reservation /dev/sdo</span><br><span class="line">  HP        MK0800JVYPQ       HPD6</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">  PR generation=0x11, there is NO reservation held</span><br></pre></td></tr></table></figure><h4 id="Unregister-key"><a href="#Unregister-key" class="headerlink" title="Unregister key"></a>Unregister key</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A $ sg_persist --out --register -K f089a155 -d /dev/sdo</span><br><span class="line">  HGST      HUH721010AL5200   A21D</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">A $ sg_persist --<span class="keyword">in</span> -k --no-inquiry -d /dev/sdo</span><br><span class="line">  PR generation=0x60, there are NO registered reservation keys</span><br></pre></td></tr></table></figure><h4 id="Force-mode"><a href="#Force-mode" class="headerlink" title="Force mode ?"></a>Force mode ?</h4><p>It releases the persistent reservation (if any) and clears all registrations from the device</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A $ sg_persist --out --clear -K f089a155 /dev/sdo</span><br></pre></td></tr></table></figure><h4 id="After-A-and-B-reboot-the-reservation-worked"><a href="#After-A-and-B-reboot-the-reservation-worked" class="headerlink" title="After A and B reboot, the reservation worked"></a>After A and B reboot, the reservation worked</h4><h4 id="Plugin-it-to-another-JBOD-all-key-reservation-will-missing"><a href="#Plugin-it-to-another-JBOD-all-key-reservation-will-missing" class="headerlink" title="Plugin it to another JBOD, all key, reservation will missing"></a>Plugin it to another JBOD, all key, reservation will missing</h4><pre><code>   -Z, --param-aptpl          set  the &#39;activate persist through power loss&#39; (APTPL) flag in the parameter block of the PROUT command. Relevant for &#39;regis          ter&#39;, &#39;register and ignore existing key&#39; and &#39;register and move&#39; sub-commands.</code></pre><p><a href="http://scsi3pr.blogspot.com/2010/11/scsi-3-persistent-group-reservation.html">SCSI-3 Persistent Group Reservation</a><br><a href="https://dhelios.blogspot.com/2015/04/how-can-i-view-create-and-remove-scsi.html">How can I view create and remove scsi</a><br><a href="http://lkml.iu.edu/hypermail/linux/kernel/0903.3/02074.html">Target_Core_Mod</a><br><a href="https://lists.wpkg.org/pipermail/stgt/2010-October/017304.html">Support for persistent reservations</a><br><a href="https://assets.cdn.sap.com/sapcom/docs/2016/06/84ea994f-767c-0010-82c7-eda71af511fa.pdf">SAP HANA Fiber Channel Storage Connector Admin Guide</a><br><a href="http://scsi3pr.blogspot.com/2010/11/scsi-3-persistent-group-reservation.html">When to use SCSI-3 Persistent Group Reservation</a></p><h3 id="NVME-persist-reservation"><a href="#NVME-persist-reservation" class="headerlink" title="NVME persist reservation"></a><a href="https://blogs.vmware.com/virtualblocks/2018/08/20/nvme-over-fabrics-part-two/">NVME persist reservation</a></h3><h3 id="the-others-sg-tools"><a href="#the-others-sg-tools" class="headerlink" title="the others sg tools"></a>the others sg tools</h3><h4 id="sg-readcap"><a href="#sg-readcap" class="headerlink" title="sg_readcap"></a>sg_readcap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sg_readcap -l /dev/sdc</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=0, p_type=0, p_i_exponent=0</span><br><span class="line">   Thin provisioning: tpe=0, tprz=0</span><br><span class="line">   Last logical block address=15628053167 (0x3a3812aaf), Number of logical blocks=15628053168</span><br><span class="line">   Logical block length=512 bytes</span><br><span class="line">   Logical blocks per physical block exponent=3</span><br><span class="line">   Lowest aligned logical block address=0</span><br><span class="line">Hence:</span><br><span class="line">   Device size: 8001563222016 bytes, 7630885.3 MiB, 8001.56 GB</span><br></pre></td></tr></table></figure><h4 id="sginfo"><a href="#sginfo" class="headerlink" title="sginfo"></a>sginfo</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">$ $ sginfo -e /dev/sdg</span><br><span class="line">Read-Write Error Recovery mode page (0x1)</span><br><span class="line">-----------------------------------------</span><br><span class="line">AWRE                               1</span><br><span class="line">ARRE                               0</span><br><span class="line">TB                                 0</span><br><span class="line">RC                                 0</span><br><span class="line">EER                                0</span><br><span class="line">PER                                0</span><br><span class="line">DTE                                0</span><br><span class="line">DCR                                0</span><br><span class="line">Read Retry Count                   0</span><br><span class="line">Correction Span                    0</span><br><span class="line">Head Offset Count                  0</span><br><span class="line">Data Strobe Offset Count           0</span><br><span class="line">Write Retry Count                  0</span><br><span class="line">Recovery Time Limit (ms)           0</span><br><span class="line"></span><br><span class="line">$ sginfo -f /dev/sdg</span><br><span class="line">Format Device mode page (0x3)</span><br><span class="line">-----------------------------</span><br><span class="line">Tracks per Zone                    128</span><br><span class="line">Alternate sectors per zone         0</span><br><span class="line">Alternate tracks per zone          0</span><br><span class="line">Alternate tracks per lu            0</span><br><span class="line">Sectors per track                  128</span><br><span class="line">Data bytes per physical sector     512</span><br><span class="line">Interleave                         0</span><br><span class="line">Track skew factor                  1</span><br><span class="line">Cylinder skew factor               0</span><br><span class="line">Supports Soft Sectoring            0</span><br><span class="line">Supports Hard Sectoring            1</span><br><span class="line">Removable Medium                   0</span><br><span class="line">Surface                            0</span><br><span class="line"></span><br><span class="line">$ sginfo -d /dev/sdg</span><br><span class="line">INQUIRY response (cmd: 0x12)</span><br><span class="line">----------------------------</span><br><span class="line">Device Type                        0</span><br><span class="line">Vendor:                    ATA</span><br><span class="line">Product:                   HGST HUH721010AL</span><br><span class="line">Revision level:            LT14</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Unable to <span class="built_in">read</span> primary (PLIST) defect data.</span><br><span class="line">&gt;&gt;&gt; Unable to <span class="built_in">read</span> grown (GLIST) defect data.</span><br><span class="line"></span><br><span class="line">$ sginfo -c /dev/sdg</span><br><span class="line">Caching mode page (0x8)</span><br><span class="line">-----------------------</span><br><span class="line">Initiator Control                  0</span><br><span class="line">ABPF                               0</span><br><span class="line">CAP                                0</span><br><span class="line">DISC                               0</span><br><span class="line">SIZE                               0</span><br><span class="line">Write Cache Enabled                1</span><br><span class="line">MF                                 0</span><br><span class="line">Read Cache Disabled                0</span><br><span class="line">Demand Read Retention Priority     0</span><br><span class="line">Demand Write Retention Priority    0</span><br><span class="line">Disable Pre-fetch Transfer Length  0</span><br><span class="line">Minimum Pre-fetch                  0</span><br><span class="line">Maximum Pre-fetch                  0</span><br><span class="line">Maximum Pre-fetch Ceiling          0</span><br><span class="line">FSW                                0</span><br><span class="line">LBCSS                              0</span><br><span class="line">DRA                                0</span><br><span class="line">NV_DIS                             0</span><br><span class="line">Number of Cache Segments           0</span><br><span class="line">Cache Segment size                 0</span><br><span class="line">Non-Cache Segment size             0</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### sg_logs</span></span><br><span class="line">```bash</span><br><span class="line">$ sg_logs -q /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Supported <span class="built_in">log</span> pages  [0x0]:</span><br><span class="line">    0x00        Supported <span class="built_in">log</span> pages [sp]</span><br><span class="line">    0x02        Write error [we]</span><br><span class="line">    0x03        Read error [re]</span><br><span class="line">    0x05        Verify error [ve]</span><br><span class="line">    0x06        Non medium [nm]</span><br><span class="line">    0x08        Format status [fs]</span><br><span class="line">    0x0d        Temperature [temp]</span><br><span class="line">    0x0e        Start-stop cycle counter [sscc]</span><br><span class="line">    0x0f        Application client [ac]</span><br><span class="line">    0x10        Self <span class="built_in">test</span> results [str]</span><br><span class="line">    0x15        Background scan results [bsr]</span><br><span class="line">    0x18        Protocol specific port [psp]</span><br><span class="line">    0x19        General Statistics and Performance [gsp]</span><br><span class="line">    0x1a        Power condition transitions [pct]</span><br><span class="line">    0x2f        Informational exceptions [ie]</span><br><span class="line">    0x30        Performance counters (Hitachi) [pc_hi]</span><br><span class="line">    0x37        Cache (seagate) [c_se]</span><br><span class="line"></span><br><span class="line">$ sg_logs -p 0x18 /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Protocol Specific port page <span class="keyword">for</span> SAS SSP  (sas-2) [0x18]</span><br><span class="line">relative target port id = 1</span><br><span class="line">  generation code = 2</span><br><span class="line">  number of phys = 1</span><br><span class="line">  phy identifier = 0</span><br><span class="line">    attached device <span class="built_in">type</span>: expander device</span><br><span class="line">    attached reason: SMP phy control <span class="keyword">function</span></span><br><span class="line">    reason: unknown</span><br><span class="line">    negotiated logical link rate: 12 Gbps</span><br><span class="line">    attached initiator port: ssp=0 stp=0 smp=0</span><br><span class="line">    attached target port: ssp=0 stp=0 smp=1</span><br><span class="line">    SAS address = 0x5000cca26c1b8631</span><br><span class="line">    attached SAS address = 0x500056b3787358ff</span><br><span class="line">    attached phy identifier = 9</span><br><span class="line">    Invalid DWORD count = 0</span><br><span class="line">    Running disparity error count = 0</span><br><span class="line">    Loss of DWORD synchronization = 0</span><br><span class="line">    Phy reset problem = 0</span><br><span class="line">    Phy event descriptors:</span><br><span class="line">     Invalid word count: 0</span><br><span class="line">     Running disparity error count: 0</span><br><span class="line">     Loss of dword synchronization count: 0</span><br><span class="line">     Phy reset problem count: 0</span><br><span class="line">relative target port id = 2</span><br><span class="line">  generation code = 2</span><br><span class="line">  number of phys = 1</span><br><span class="line">  phy identifier = 1</span><br><span class="line">    attached device <span class="built_in">type</span>: no device attached</span><br><span class="line">    attached reason: unknown</span><br><span class="line">    reason: power on</span><br><span class="line">    negotiated logical link rate: phy enabled; unknown reason</span><br><span class="line">    attached initiator port: ssp=0 stp=0 smp=0</span><br><span class="line">    attached target port: ssp=0 stp=0 smp=0</span><br><span class="line">    SAS address = 0x5000cca26c1b8632</span><br><span class="line">    attached SAS address = 0x0</span><br><span class="line">    attached phy identifier = 0</span><br><span class="line">    Invalid DWORD count = 0</span><br><span class="line">    Running disparity error count = 0</span><br><span class="line">    Loss of DWORD synchronization = 0</span><br><span class="line">    Phy reset problem = 0</span><br><span class="line">    Phy event descriptors:</span><br><span class="line">     Invalid word count: 0</span><br><span class="line">     Running disparity error count: 0</span><br><span class="line">     Loss of dword synchronization count: 0</span><br><span class="line">     Phy reset problem count: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#write err</span></span><br><span class="line">$ sg_logs -p 0x02 /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Write error counter page  [0x2]</span><br><span class="line">  Errors corrected without substantial delay = 0</span><br><span class="line">  Errors corrected with possible delays = 0</span><br><span class="line">  Total rewrites or rereads = 0</span><br><span class="line">  Total errors corrected = 1</span><br><span class="line">  Total <span class="built_in">times</span> correction algorithm processed = 404822</span><br><span class="line">  Total bytes processed = 35127905470928</span><br><span class="line">  Total uncorrected errors = 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#read err</span></span><br><span class="line">$ sg_logs -p 0x03 /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Read error counter page  [0x3]</span><br><span class="line">  Errors corrected without substantial delay = 0</span><br><span class="line">  Errors corrected with possible delays = 0</span><br><span class="line">  Total rewrites or rereads = 0</span><br><span class="line">  Total errors corrected = 0</span><br><span class="line">  Total <span class="built_in">times</span> correction algorithm processed = 1350903</span><br><span class="line">  Total bytes processed = 49018892496048</span><br><span class="line">  Total uncorrected errors = 0</span><br><span class="line">$ sg_logs -p 0x05 /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Verify error counter page  [0x5]</span><br><span class="line">  Errors corrected without substantial delay = 0</span><br><span class="line">  Errors corrected with possible delays = 0</span><br><span class="line">  Total rewrites or rereads = 0</span><br><span class="line">  Total errors corrected = 0</span><br><span class="line">  Total <span class="built_in">times</span> correction algorithm processed = 5154</span><br><span class="line">  Total bytes processed = 101563105280</span><br><span class="line">  Total uncorrected errors = 0</span><br><span class="line">$ sg_logs -p 0x06 /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Non-medium error page  [0x6]</span><br><span class="line">  Non-medium error count = 0</span><br><span class="line"></span><br><span class="line"><span class="comment">## the &quot;Total errors corrected&quot; has the a lot of growth in some of issue seagate HDDs</span></span><br><span class="line"></span><br><span class="line">$ sg_logs -p 0x08 /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Format status page  [0x8]</span><br><span class="line">  Format data out:</span><br><span class="line"> 00     00 02 00 00                                         ....</span><br><span class="line">  Grown defects during certification = 0</span><br><span class="line">  Total blocks reassigned during format = 0</span><br><span class="line">  Total new blocks reassigned = 0</span><br><span class="line">  Power on minutes since format = 10647</span><br><span class="line"></span><br><span class="line">$ sg_logs -p 0x1a /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Power condition transitions page  [0x1a]</span><br><span class="line">  Accumulated transitions to active = 700283</span><br><span class="line">  Accumulated transitions to idle_a = 698441</span><br><span class="line">  Accumulated transitions to idle_b = 1855</span><br><span class="line">  Accumulated transitions to idle_c = 0</span><br><span class="line">  Accumulated transitions to standby_z = 0</span><br><span class="line">  Accumulated transitions to standby_y = 0</span><br><span class="line"></span><br><span class="line">$ sg_logs -p 0x2f /dev/sdj</span><br><span class="line">    HGST      HUH721010AL5200   LS14</span><br><span class="line">Informational Exceptions page  [0x2f]</span><br><span class="line">  IE asc = 0x0, ascq = 0x0</span><br><span class="line">    Current temperature = 29 C</span><br><span class="line">    Threshold temperature = 85 C  [common extension]</span><br><span class="line">  parameter code = 0x1, contents <span class="keyword">in</span> hex:</span><br><span class="line"> 00     00 01 03 03 64 64 19</span><br></pre></td></tr></table></figure><h4 id="sg-senddiag"><a href="#sg-senddiag" class="headerlink" title="sg_senddiag"></a>sg_senddiag</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sg_senddiag -l /dev/sg18</span><br><span class="line">Supported diagnostic pages response:</span><br><span class="line">  0x00  Supported diagnostic pages</span><br><span class="line">  0x3f  Protocol specific (SAS transport)</span><br><span class="line">  0x40  Translate<span class="built_in"> address </span>(direct access)</span><br><span class="line">  0xdf  &lt;unknown&gt;</span><br></pre></td></tr></table></figure><h4 id="sg-inq"><a href="#sg-inq" class="headerlink" title="sg_inq"></a>sg_inq</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">$ sg_inq -d /dev/sdj</span><br><span class="line">standard INQUIRY:</span><br><span class="line">  PQual=0  Device_type=0  RMB=0  LU_CONG=0  version=0x06  [SPC-4]</span><br><span class="line">  [AERC=0]  [TrmTsk=0]  NormACA=0  HiSUP=1  Resp_data_format=2</span><br><span class="line">  SCCS=0  ACC=0  TPGS=0  3PC=0  Protect=1  [BQue=0]</span><br><span class="line">  EncServ=0  MultiP=1 (VS=0)  [MChngr=0]  [ACKREQQ=0]  Addr16=0</span><br><span class="line">  [RelAdr=0]  WBus16=0  Sync=0  [Linked=0]  [TranDis=0]  CmdQue=1</span><br><span class="line">  [SPI: Clocking=0x0  QAS=0  IUS=0]</span><br><span class="line">    length=164 (0xa4)   Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line"> Vendor identification: HGST</span><br><span class="line"> Product identification: HUH721010AL5200</span><br><span class="line"> Product revision level: LS14</span><br><span class="line"> Unit serial number: 1DGH47ZZ</span><br><span class="line"></span><br><span class="line">$ sg_inq -e /dev/sdj</span><br><span class="line">VPD INQUIRY, page code=0x00:</span><br><span class="line">   Supported VPD pages:</span><br><span class="line">     0x0        Supported VPD pages</span><br><span class="line">     0x3</span><br><span class="line">     0x80       Unit serial number</span><br><span class="line">     0x83       Device identification</span><br><span class="line">     0x86       Extended INQUIRY data</span><br><span class="line">     0x87       Mode page policy</span><br><span class="line">     0x88       SCSI ports</span><br><span class="line">     0x8a       Power condition</span><br><span class="line">     0x8d       Power consumption</span><br><span class="line">     0x90       Protocol-specific logical unit information</span><br><span class="line">     0x91       Protocol-specific port information</span><br><span class="line">     0xb0       Block limits (sbc2)</span><br><span class="line">     0xb1       Block device characteristics (sbc3)</span><br><span class="line">     0xb2       Logical block provisioning (sbc3)</span><br><span class="line">     0xd1</span><br><span class="line">     0xd2</span><br><span class="line">     0xdc</span><br><span class="line"></span><br><span class="line">$ sg_vpd /dev/sdj</span><br><span class="line">Supported VPD pages VPD page:</span><br><span class="line">  Supported VPD pages [sv]</span><br><span class="line">  0x3</span><br><span class="line">  Unit serial number [sn]</span><br><span class="line">  Device identification [di]</span><br><span class="line">  Extended inquiry data [ei]</span><br><span class="line">  Mode page policy [mpp]</span><br><span class="line">  SCSI ports [sp]</span><br><span class="line">  Power condition [pc]</span><br><span class="line">  Power consumption [psm]</span><br><span class="line">  Protocol-specific logical unit information [pslu]</span><br><span class="line">  Protocol-specific port information [pspo]</span><br><span class="line">  Block limits (SBC) [bl]</span><br><span class="line">  Block device characteristics (SBC) [bdc]</span><br><span class="line">  Logical block provisioning (SBC) [lbpv]</span><br><span class="line">  0xd1</span><br><span class="line">  0xd2</span><br><span class="line">  0xdc</span><br><span class="line"></span><br><span class="line">$ sg_vpd --page=xx /dev/sdj</span><br><span class="line">abbreviation doesn<span class="string">&#x27;t match a VPD page</span></span><br><span class="line"><span class="string">Available standard VPD pages:</span></span><br><span class="line"><span class="string">  ai         0x89      ATA information (SAT)</span></span><br><span class="line"><span class="string">  aod        0x82      ASCII implemented operating definition (obsolete)</span></span><br><span class="line"><span class="string">  adsn       0xb3      Automation device serial number (SSC)</span></span><br><span class="line"><span class="string">  bl         0xb0      Block limits (SBC)</span></span><br><span class="line"><span class="string">  ble        0xb7      Block limits extension (SBC)</span></span><br><span class="line"><span class="string">  bdc        0xb1      Block device characteristics (SBC)</span></span><br><span class="line"><span class="string">  bdce       0xb5      Block device characteristics extension (SBC)</span></span><br><span class="line"><span class="string">  cfa        0x8c      CFA profile information</span></span><br><span class="line"><span class="string">  dc         0x8b      Device constituents</span></span><br><span class="line"><span class="string">  di         0x83      Device identification</span></span><br><span class="line"><span class="string">  di_asis    0x83      Like &#x27;</span>di<span class="string">&#x27; but designators ordered as found</span></span><br><span class="line"><span class="string">  di_lu      0x83      Device identification, lu only</span></span><br><span class="line"><span class="string">  di_port    0x83      Device identification, target port only</span></span><br><span class="line"><span class="string">  di_target  0x83      Device identification, target device only</span></span><br><span class="line"><span class="string">  dtde       0xb4      Data transfer device element address (SSC)</span></span><br><span class="line"><span class="string">  ei         0x86      Extended inquiry data</span></span><br><span class="line"><span class="string">  iod        0x81      Implemented operating definition (obsolete)</span></span><br><span class="line"><span class="string">  lbpro      0xb5      Logical block protection (SSC)</span></span><br><span class="line"><span class="string">  lbpv       0xb2      Logical block provisioning (SBC)</span></span><br><span class="line"><span class="string">  mas        0xb1      Manufacturer assigned serial number (SSC)</span></span><br><span class="line"><span class="string">  masa       0xb1      Manufacturer assigned serial number (ADC)</span></span><br><span class="line"><span class="string">  mna        0x85      Management network addresses</span></span><br><span class="line"><span class="string">  mpp        0x87      Mode page policy</span></span><br><span class="line"><span class="string">  oi         0xb0      OSD information</span></span><br><span class="line"><span class="string">  pc         0x8a      Power condition</span></span><br><span class="line"><span class="string">  psm        0x8d      Power consumption</span></span><br><span class="line"><span class="string">  pslu       0x90      Protocol-specific logical unit information</span></span><br><span class="line"><span class="string">  pspo       0x91      Protocol-specific port information</span></span><br><span class="line"><span class="string">  ref        0xb3      Referrals (SBC)</span></span><br><span class="line"><span class="string">  sad        0xb0      Sequential access device capabilities (SSC)</span></span><br><span class="line"><span class="string">  sbl        0xb4      Supported block lengths and protection types (SBC)</span></span><br><span class="line"><span class="string">  sfs        0x92      SCSI feature sets</span></span><br><span class="line"><span class="string">  sii        0x84      Software interface identification</span></span><br><span class="line"><span class="string">  sinq       -1        Standard inquiry response</span></span><br><span class="line"><span class="string">  sn         0x80      Unit serial number</span></span><br><span class="line"><span class="string">  sp         0x88      SCSI ports</span></span><br><span class="line"><span class="string">  st         0xb1      Security token (OSD)</span></span><br><span class="line"><span class="string">  sv         0x00      Supported VPD pages</span></span><br><span class="line"><span class="string">  tas        0xb2      TapeAlert supported flags (SSC)</span></span><br><span class="line"><span class="string">  tpc        0x8f      Third party copy</span></span><br><span class="line"><span class="string">  zbdc       0xb6      Zoned block device characteristics</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Vendor/product identifiers:</span></span><br><span class="line"><span class="string">  dds        3      DDS tape family from IBM</span></span><br><span class="line"><span class="string">  emc        2      EMC (company)</span></span><br><span class="line"><span class="string">  hit        7      WDC/Hitachi disk</span></span><br><span class="line"><span class="string">  hp3par     4      3PAR array (HP was Left Hand)</span></span><br><span class="line"><span class="string">  hp_lto     6      HP LTO tape/systems</span></span><br><span class="line"><span class="string">  ibm_lto    5      IBM LTO tape/systems</span></span><br><span class="line"><span class="string">  nvme       8      NVMe related</span></span><br><span class="line"><span class="string">  rdac       1      RDAC array (NetApp E-Series)</span></span><br><span class="line"><span class="string">  sea        0      Seagate disk</span></span><br><span class="line"><span class="string">  sg         9      sg3_utils extensions</span></span><br><span class="line"><span class="string">  wdc        7      WDC/Hitachi disk</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Vendor specific VPD pages:</span></span><br><span class="line"><span class="string">  aci        0xc5,6      ACI revision level (HP LTO)</span></span><br><span class="line"><span class="string">  datc       0xc1,0      Date code (Seagate)</span></span><br><span class="line"><span class="string">  dcrl       0xc0,5      Drive component revision levels (IBM LTO)</span></span><br><span class="line"><span class="string">  ddsver     0xc0,3      Firmware revision (DDS)</span></span><br><span class="line"><span class="string">  devb       0xc3,0      Device behavior (Seagate)</span></span><br><span class="line"><span class="string">  dsn        0xc1,5      Drive serial numbers (IBM LTO)</span></span><br><span class="line"><span class="string">  ducd       0xc7,5      Device unique configuration data (IBM LTO)</span></span><br><span class="line"><span class="string">  edid       0xc8,1      Extended device identification (RDAC)</span></span><br><span class="line"><span class="string">  firm       0xc0,0      Firmware numbers (Seagate)</span></span><br><span class="line"><span class="string">  frl        0xc0,6      Firmware revision level (HP LTO)</span></span><br><span class="line"><span class="string">  fwr4       0xc1,1      Firmware version (RDAC)</span></span><br><span class="line"><span class="string">  head       0xc4,6      Head Assy revision level (HP LTO)</span></span><br><span class="line"><span class="string">  hp3par     0xc0,4      Volume information (HP/3PAR)</span></span><br><span class="line"><span class="string">  hrl        0xc1,6      Hardware revision level (HP LTO)</span></span><br><span class="line"><span class="string">  hwr4       0xc0,1      Hardware version (RDAC)</span></span><br><span class="line"><span class="string">  jump       0xc2,0      Jump setting (Seagate)</span></span><br><span class="line"><span class="string">  mech       0xc3,6      Mechanism revision level (HP LTO)</span></span><br><span class="line"><span class="string">  mpds       0xc8,5      Mode parameter default settings (IBM LTO)</span></span><br><span class="line"><span class="string">  nicr       0xde,9      NVMe Identify Controller Response (sg3_utils)</span></span><br><span class="line"><span class="string">  pca        0xc2,6      PCA revision level (HP LTO)</span></span><br><span class="line"><span class="string">  prm4       0xc3,1      Feature Parameters (RDAC)</span></span><br><span class="line"><span class="string">  rvsi       0xca,1      Replicated volume source identifier (RDAC)</span></span><br><span class="line"><span class="string">  said       0xd0,1      Storage array world wide name (RDAC)</span></span><br><span class="line"><span class="string">  subs       0xc4,1      Subsystem identifier (RDAC)</span></span><br><span class="line"><span class="string">  swr4       0xc2,1      Software version (RDAC)</span></span><br><span class="line"><span class="string">  upr        0xc0,2      Unit path report (EMC)</span></span><br><span class="line"><span class="string">  vac1       0xc9,1      Volume access control (RDAC)</span></span><br><span class="line"><span class="string">  wp3        0x03,7      Page 0x3 (WDC/Hitachi)</span></span><br><span class="line"><span class="string">  wpd1       0xd1,7      Page 0xd1 (WDC/Hitachi)</span></span><br><span class="line"><span class="string">  wpd2       0xd2,7      Page 0xd2 (WDC/Hitachi)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sg_vpd --page=sp /dev/sdj</span></span><br><span class="line"><span class="string">SCSI Ports VPD page:</span></span><br><span class="line"><span class="string">  Relative port=1</span></span><br><span class="line"><span class="string">    Target port descriptor(s):</span></span><br><span class="line"><span class="string">  SCSI Ports:</span></span><br><span class="line"><span class="string">    designator type: NAA,  code set: Binary</span></span><br><span class="line"><span class="string">     transport: Serial Attached SCSI Protocol (SPL-4)</span></span><br><span class="line"><span class="string">      0x5000cca26c1b8631</span></span><br><span class="line"><span class="string">  Relative port=2</span></span><br><span class="line"><span class="string">    Target port descriptor(s):</span></span><br><span class="line"><span class="string">  SCSI Ports:</span></span><br><span class="line"><span class="string">    designator type: NAA,  code set: Binary</span></span><br><span class="line"><span class="string">     transport: Serial Attached SCSI Protocol (SPL-4)</span></span><br><span class="line"><span class="string">      0x5000cca26c1b8632</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sg_vpd --page=pc /dev/sdj</span></span><br><span class="line"><span class="string">Power condition VPD page:</span></span><br><span class="line"><span class="string">  Standby_y=0 Standby_z=1 Idle_c=1 Idle_b=1 Idle_a=1</span></span><br><span class="line"><span class="string">  Stopped condition recovery time (ms) 18400</span></span><br><span class="line"><span class="string">  Standby_z condition recovery time (ms) 10200</span></span><br><span class="line"><span class="string">  Standby_y condition recovery time (ms) 3350</span></span><br><span class="line"><span class="string">  Idle_a condition recovery time (ms) 10</span></span><br><span class="line"><span class="string">  Idle_b condition recovery time (ms) 900</span></span><br><span class="line"><span class="string">  Idle_c condition recovery time (ms) 3350</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$  sg_scan -x</span></span><br><span class="line"><span class="string">/dev/sg0: scsi0 channel=0 id=0 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg1: scsi0 channel=0 id=1 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg2: scsi0 channel=0 id=2 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg3: scsi0 channel=0 id=3 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg4: scsi0 channel=0 id=4 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg5: scsi0 channel=0 id=5 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg6: scsi0 channel=0 id=6 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg7: scsi0 channel=0 id=7 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg8: scsi0 channel=0 id=8 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg9: scsi0 channel=0 id=9 lun=0  cmd_per_lun=7 queue_depth=254</span></span><br><span class="line"><span class="string">/dev/sg10: scsi0 channel=0 id=10 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg11: scsi0 channel=0 id=11 lun=0  cmd_per_lun=7 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg12: scsi0 channel=0 id=12 lun=0  cmd_per_lun=7 queue_depth=254</span></span><br><span class="line"><span class="string">/dev/sg13: scsi15 channel=0 id=0 lun=0 [em]  cmd_per_lun=0 queue_depth=32</span></span><br><span class="line"><span class="string">/dev/sg14: scsi17 channel=0 id=0 lun=0 [em]  cmd_per_lun=0 queue_depth=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[0:0:0:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sda   -  /dev/sg0   10.0TB</span></span><br><span class="line"><span class="string">[0:0:1:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sdb   -  /dev/sg1   10.0TB</span></span><br><span class="line"><span class="string">[0:0:2:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sdc   -  /dev/sg2   10.0TB</span></span><br><span class="line"><span class="string">[0:0:3:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sdd   -  /dev/sg3   10.0TB</span></span><br><span class="line"><span class="string">[0:0:4:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sde   -  /dev/sg4   10.0TB</span></span><br><span class="line"><span class="string">[0:0:5:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sdf   -  /dev/sg5   10.0TB</span></span><br><span class="line"><span class="string">[0:0:6:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sdg   -  /dev/sg6   10.0TB</span></span><br><span class="line"><span class="string">[0:0:7:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sdh   -  /dev/sg7   10.0TB</span></span><br><span class="line"><span class="string">[0:0:8:0]    disk    ATA      HGST HUH721010AL LT14  /dev/sdi   -  /dev/sg8   10.0TB</span></span><br><span class="line"><span class="string">[0:0:9:0]    disk    HGST     HUH721010AL5200  LS14  /dev/sdj   35000cca26c1b8630  /dev/sg9   9.79TB</span></span><br><span class="line"><span class="string">[0:0:10:0]   disk    ATA      HGST HUH721010AL LT14  /dev/sdk   -  /dev/sg10  10.0TB</span></span><br><span class="line"><span class="string">[0:0:11:0]   disk    ATA      HGST HUH721010AL LT14  /dev/sdl   -  /dev/sg11  10.0TB</span></span><br><span class="line"><span class="string">[0:0:12:0]   enclosu DP       BP14G+EXP        2.25  -          -  /dev/sg12       -</span></span><br><span class="line"><span class="string">[15:0:0:0]   disk    ATA      DELLBOSS VD      00-0  /dev/sdm   -  /dev/sg13   119GB</span></span><br><span class="line"><span class="string">[17:0:0:0]   process Marvell  Console          1.01  -          -  /dev/sg14       -</span></span><br></pre></td></tr></table></figure><h4 id="sg-opcodes"><a href="#sg-opcodes" class="headerlink" title="sg_opcodes"></a>sg_opcodes</h4><p>sg_opcodes -n /dev/sg9</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">sg_opcodes -n /dev/sg9</span><br><span class="line">--no-inquiry ignored because --pdt= not given</span><br><span class="line"></span><br><span class="line">Opcode  Service    CDB    CDLP   Name</span><br><span class="line">(hex)   action(h)  size</span><br><span class="line">-----------------------------------------------</span><br><span class="line"> 00                  6      0    Test Unit Ready</span><br><span class="line"> 01                  6      0    Rezero Unit</span><br><span class="line"> 03                  6      0    Request Sense</span><br><span class="line"> 04                  6      0    Format Unit</span><br><span class="line"> 07                  6      0    Reassign Blocks</span><br><span class="line"> 08                  6      0    Read(6)</span><br><span class="line"> 0a                  6      0    Write(6)</span><br><span class="line"> 0b                  6      0    Seek(6)</span><br><span class="line"> 12                  6      0    Inquiry</span><br><span class="line"> 15                  6      0    Mode select(6)</span><br><span class="line"> 16                  6      0    Reserve(6)</span><br><span class="line"> 17                  6      0    Release(6)</span><br><span class="line"> 1a                  6      0    Mode sense(6)</span><br><span class="line"> 1b                  6      0    Start stop unit</span><br><span class="line"> 1c                  6      0    Receive diagnostic results</span><br><span class="line"> 1d                  6      0    Send diagnostic</span><br><span class="line"> 25                 10      0    Read capacity(10)</span><br><span class="line"> 28                 10      0    Read(10)</span><br><span class="line"> 2a                 10      0    Write(10)</span><br><span class="line"> 2b                 10      0    Seek(10)</span><br><span class="line"> 2e                 10      0    Write and verify(10)</span><br><span class="line"> 2f                 10      0    Verify(10)</span><br><span class="line"> 34                 10      0    Pre-fetch(10)</span><br><span class="line"> 35                 10      0    Synchronize cache(10)</span><br><span class="line"> 37                 10      0    Read defect data(10)</span><br><span class="line"> 3b        0        10      0    Write buffer, combined header and data [or multiple modes]</span><br><span class="line"> 3b        2        10      0    Write buffer, data</span><br><span class="line"> 3b        4        10      0    Write buffer, download microcode and activate</span><br><span class="line"> 3b        5        10      0    Write buffer, download microcode, save, and activate</span><br><span class="line"> 3b        7        10      0    Write buffer, download microcode with offsets, save, and activate</span><br><span class="line"> 3b        a        10      0    Write buffer, write data to <span class="built_in">echo</span> buffer</span><br><span class="line"> 3b        d        10      0    Write buffer, download microcode with offsets, select activation events, save and defer activate</span><br><span class="line"> 3b        e        10      0    Write buffer, download microcode with offsets, save and defer activate</span><br><span class="line"> 3b        f        10      0    Write buffer, activate deferred microcode</span><br><span class="line"> 3b       1a        10      0    Write buffer, <span class="built_in">enable</span> expander comms protocol and <span class="built_in">echo</span> buffer</span><br><span class="line"> 3c        0        10      0    Read buffer(10), combined header and data [or multiple modes]</span><br><span class="line"> 3c        2        10      0    Read buffer(10), data</span><br><span class="line"> 3c        3        10      0    Read buffer(10), descriptor</span><br><span class="line"> 3c        a        10      0    Read buffer(10), <span class="built_in">read</span> data from <span class="built_in">echo</span> buffer</span><br><span class="line"> 3c        b        10      0    Read buffer(10), <span class="built_in">echo</span> buffer descriptor</span><br><span class="line"> 3c       1a        10      0    Read buffer(10), <span class="built_in">enable</span> expander comms protocol and <span class="built_in">echo</span> buffer</span><br><span class="line"> 3c       1c        10      0    Read buffer(10), error <span class="built_in">history</span></span><br><span class="line"> 3e                 10      0    Read long(10)</span><br><span class="line"> 3f                 10      0    Write long(10)</span><br><span class="line">41                 10      0    Write same(10)</span><br><span class="line"> 48        1        10      0    Sanitize, overwrite</span><br><span class="line"> 48        3        10      0    Sanitize, cryptographic erase</span><br><span class="line"> 48       1f        10      0    Sanitize, <span class="built_in">exit</span> failure mode</span><br><span class="line"> 4c                 10      0    Log select</span><br><span class="line"> 4d                 10      0    Log sense</span><br><span class="line"> 55                 10      0    Mode select(10)</span><br><span class="line"> 56                 10      0    Reserve(10)</span><br><span class="line"> 57                 10      0    Release(10)</span><br><span class="line"> 5a                 10      0    Mode sense(10)</span><br><span class="line"> 5e        0        10      0    Persistent reserve <span class="keyword">in</span>, <span class="built_in">read</span> keys</span><br><span class="line"> 5e        1        10      0    Persistent reserve <span class="keyword">in</span>, <span class="built_in">read</span> reservation</span><br><span class="line"> 5e        2        10      0    Persistent reserve <span class="keyword">in</span>, report capabilities</span><br><span class="line"> 5e        3        10      0    Persistent reserve <span class="keyword">in</span>, <span class="built_in">read</span> full status</span><br><span class="line"> 5f        0        10      0    Persistent reserve out, register</span><br><span class="line"> 5f        1        10      0    Persistent reserve out, reserve</span><br><span class="line"> 5f        2        10      0    Persistent reserve out, release</span><br><span class="line"> 5f        3        10      0    Persistent reserve out, clear</span><br><span class="line"> 5f        4        10      0    Persistent reserve out, preempt</span><br><span class="line"> 5f        5        10      0    Persistent reserve out, preempt and abort</span><br><span class="line"> 5f        6        10      0    Persistent reserve out, register and ignore existing key</span><br><span class="line"> 88                 16      0    Read(16)</span><br><span class="line"> 8a                 16      0    Write(16)</span><br><span class="line"> 8e                 16      0    Write and verify(16)</span><br><span class="line"> 8f                 16      0    Verify(16)</span><br><span class="line"> 90                 16      0    Pre-fetch(16)</span><br><span class="line"> 91                 16      0    Synchronize cache(16)</span><br><span class="line"> 93                 16      0    Write same(16)</span><br><span class="line"> 9e       10        16      0    Read capacity(16)</span><br><span class="line"> 9e       11        16      0    Read long(16)</span><br><span class="line"> 9f       11        16      0    Write long(16)</span><br><span class="line"> a0                 12      0    Report luns</span><br><span class="line"> a3        5        12      0    Report identifying information</span><br><span class="line"> a3        c        12      0    Report supported operation codes</span><br><span class="line"> a3        d        12      0    Report supported task management <span class="built_in">functions</span></span><br><span class="line"> a3        f        12      0    Report timestamp</span><br><span class="line"> a4        6        12      0    Set identifying information</span><br><span class="line"> a4        f        12      0    Set timestamp</span><br><span class="line"> a8                 12      0    Read(12)</span><br><span class="line"> aa                 12      0    Write(12)</span><br><span class="line"> ae                 12      0    Write and verify(12)</span><br><span class="line"> af                 12      0    Verify(12)</span><br><span class="line"> b7                 12      0    Read defect data(12)</span><br></pre></td></tr></table></figure><h4 id="sg-write-same"><a href="#sg-write-same" class="headerlink" title="sg_write_same"></a>sg_write_same</h4><p>not make sure<br>This command writes the given block NUM times to consecutive blocks on  the  DEVICE  starting  at  logical  block address LBA.<br>If these conditions are not met and the LBPRZ bit is set then the UNMAP  bit  is  ignored  and  the data-out  buffer  is  written  to the DEVICE as if the UNMAP bit was zero</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sg_write_same man page</span><br><span class="line">sg_unmap - send SCSI UNMAP <span class="built_in">command</span> (known as <span class="string">&#x27;trim&#x27;</span> <span class="keyword">in</span> ATA specs)</span><br><span class="line">$ cat /sys/block/sdb/size</span><br><span class="line">488397168</span><br><span class="line">$ sg_write_same --16 --unmap --verbose --lba=488397167 --num=1 /dev/sdb</span><br><span class="line"><span class="comment">#The same func with sg_write_same ?</span></span><br><span class="line">$ sg_unmap --verbose --lba=488397167 --num=1 /dev/sdb</span><br><span class="line"></span><br><span class="line">$ sg_unmap --verbose --lba=0 --num=488397167 /dev/sdb</span><br></pre></td></tr></table></figure><h4 id="sg-readcap-1"><a href="#sg-readcap-1" class="headerlink" title="sg_readcap"></a>sg_readcap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ --16   Use the 16 byte cdb variant of the READ CAPACITY <span class="built_in">command</span>. See the <span class="string">&#x27;--long&#x27;</span> option.  -b, --brief outputs two  hex  numbers  (prefixed  with  <span class="string">&#x27;0x&#x27;</span>  and  space  separated) to stdout. The first number is the maximum number of blocks on the device (<span class="built_in">which</span> is one plus the lba of the last accessible block). The second number is the size <span class="keyword">in</span> bytes of each block.If the operation fails <span class="keyword">then</span> <span class="string">&quot;0x0 0x0&quot;</span> is written to stdout.</span><br><span class="line"></span><br><span class="line">$ sg_readcap --16 -b /dev/sdj <span class="comment">#10TB 512E</span></span><br><span class="line">0x474800000 0x200</span><br><span class="line"></span><br><span class="line">Raw Size: 8.910 TB [0x474800000 Sectors]</span><br><span class="line">0x200 = 512 Bytes</span><br><span class="line"></span><br><span class="line">$ sg_readcap --16 -b /dev/sdj <span class="comment">#8TB 4KN</span></span><br><span class="line">0x74702556 0x1000</span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH728080AL4200</span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   4096 bytes</span><br><span class="line">$ cat logical_block_size minimum_io_size physical_block_size</span><br><span class="line">4096</span><br><span class="line">4096</span><br><span class="line">4096</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Got the issue, dell SAS 10TB HDD looks like only 9.79TB, Dell hide some area, the physical sector only 4096 Bytes</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dell SATA</span></span><br><span class="line">Model Family:     HGST Ultrastar He10</span><br><span class="line">Device Model:     HGST HUH721010ALE600</span><br><span class="line">LU WWN Device Id: 5 000cca 26aef5ec1</span><br><span class="line">Add. Product Id:  DELL(tm)</span><br><span class="line">Firmware Version: LHDELT14</span><br><span class="line">User Capacity:    10,000,831,348,736 bytes [10.0 TB]</span><br><span class="line">Sector Sizes:     512 bytes logical, 4096 bytes physical</span><br><span class="line"></span><br><span class="line"><span class="comment"># SAS 10TB</span></span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH721010AL5200</span><br><span class="line">Revision:             A21D</span><br><span class="line">User Capacity:        10,000,831,348,736 bytes [10.0 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br><span class="line">Physical block size:  4096 bytes</span><br><span class="line">Lowest aligned LBA:   0</span><br><span class="line">Logical block provisioning <span class="built_in">type</span> unreported, LBPME=0, LBPRZ=0</span><br><span class="line">Rotation Rate:        7200 rpm</span><br><span class="line">Device <span class="built_in">type</span>:          disk</span><br><span class="line">Transport protocol:   SAS</span><br><span class="line"></span><br><span class="line"><span class="comment">#Dell SAS 10TB</span></span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH721010AL5200</span><br><span class="line">Revision:             LS14</span><br><span class="line">Compliance:           SPC-4</span><br><span class="line">User Capacity:        9,796,820,402,176 bytes [9.79 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br><span class="line">Physical block size:  4096 bytes</span><br><span class="line">Formatted with <span class="built_in">type</span> 2 protection</span><br><span class="line">LU is fully provisioned</span><br><span class="line">Rotation Rate:        7200 rpm</span><br><span class="line">Form Factor:          3.5 inches</span><br><span class="line">Device <span class="built_in">type</span>:          disk</span><br><span class="line">Transport protocol:   SAS (SPL-3)</span><br></pre></td></tr></table></figure><h4 id="reset-bus-host-target"><a href="#reset-bus-host-target" class="headerlink" title="reset bus, host, target"></a><a href="http://fibrevillage.com/storage/593-sg-reset-command-examples">reset bus, host, target</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># reset bus</span></span><br><span class="line">$ sg_reset -v -b /dev/sdf</span><br><span class="line">[root@kvm-manager-a23-2 ~]<span class="comment"># sg_reset -v -b /dev/sdf</span></span><br><span class="line">sg_reset: starting bus reset</span><br><span class="line">sg_reset: completed bus (or host) reset</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">[Mon Jun 17 12:19:41 2019] mpt3sas_cm0: attempting host reset! scmd(ffff96107b4a6a00)</span><br><span class="line">[Mon Jun 17 12:19:41 2019] sd 0:0:3:0: CDB: Test Unit Ready</span><br><span class="line">[Mon Jun 17 12:19:41 2019] mpt3sas_cm0: sending diag reset !!</span><br><span class="line">[Mon Jun 17 12:19:42 2019] mpt3sas_cm0: diag reset: SUCCESS</span><br><span class="line">[Mon Jun 17 12:19:42 2019] mpt3sas_cm0: IOC Number : 0</span><br><span class="line">[Mon Jun 17 12:19:42 2019] mpt3sas_cm0: CurrentHostPageSize is 0: Setting default host page size to 4k</span><br><span class="line">[Mon Jun 17 12:19:42 2019] mpt3sas_cm0: LSISAS3008: FWVersion(15.00.03.00), ChipRevision(0x02), BiosVersion(08.31.00.00)</span><br><span class="line">[Mon Jun 17 12:19:42 2019] mpt3sas_cm0: Protocol=(Initiator), Capabilities=(Raid,TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)</span><br><span class="line">[Mon Jun 17 12:19:42 2019] mpt3sas_cm0: sending port <span class="built_in">enable</span> !!</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: port <span class="built_in">enable</span>: SUCCESS</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:0: handle(0x000a), sas_address(0x5000c5003015b562), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:0: enclosure logical id(0x500304801d72dd7f), slot(0)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:1: handle(0x000b), sas_address(0x5000c5003015b786), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:1: enclosure logical id(0x500304801d72dd7f), slot(1)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:2: handle(0x000c), sas_address(0x5000c5003015b57a), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:2: enclosure logical id(0x500304801d72dd7f), slot(2)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:3: handle(0x000d), sas_address(0x5000c5003015b56a), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:3: enclosure logical id(0x500304801d72dd7f), slot(3)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:4: handle(0x000e), sas_address(0x5000c500301b8b06), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:4: enclosure logical id(0x500304801d72dd7f), slot(4)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:5: handle(0x000f), sas_address(0x5000c5003015b566), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:5: enclosure logical id(0x500304801d72dd7f), slot(5)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:6: handle(0x0010), sas_address(0x5000c5003015b582), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:6: enclosure logical id(0x500304801d72dd7f), slot(6)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:7: handle(0x0011), sas_address(0x5000c5003015b56e), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:7: enclosure logical id(0x500304801d72dd7f), slot(7)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:8: handle(0x0012), sas_address(0x5000c5003015b5b6), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:8: enclosure logical id(0x500304801d72dd7f), slot(8)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:9: handle(0x0013), sas_address(0x5000c500301b8b7e), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:9: enclosure logical id(0x500304801d72dd7f), slot(9)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:10: handle(0x0014), sas_address(0x500304801d72ddfd), port: 255</span><br><span class="line">[Mon Jun 17 12:19:49 2019] scsi target0:0:10: enclosure logical id(0x500304801d72dd7f), slot(24)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: <span class="built_in">break</span> from _scsih_search_responding_sas_devices: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: search <span class="keyword">for</span> end-devices: complete</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: search <span class="keyword">for</span> PCIe end-devices: complete</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: search <span class="keyword">for</span> raid volumes: start</span><br><span class="line">[Mon Jun 17 12:19:49 2019] mpt3sas_cm0: search <span class="keyword">for</span> responding raid volumes: complete</span><br><span class="line">[Mon Jun 17 12:19:50 2019] mpt3sas_cm0: search <span class="keyword">for</span> expanders: start</span><br><span class="line">[Mon Jun 17 12:19:50 2019] expander present: handle(0x0009), sas_addr(0x500304801d72ddff), port:255</span><br><span class="line">[Mon Jun 17 12:19:50 2019] mpt3sas_cm0: <span class="built_in">break</span> from _scsih_search_responding_expanders: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:19:50 2019] mpt3sas_cm0: search <span class="keyword">for</span> expanders: complete</span><br><span class="line">[Mon Jun 17 12:19:50 2019] mpt3sas_cm0: host reset: SUCCESS scmd(ffff96107b4a6a00)</span><br><span class="line">[Mon Jun 17 12:20:00 2019]  sdf: sdf1 sdf9</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: removing unresponding devices: start</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: removing unresponding devices: sas end-devices</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: removing unresponding devices: pcie end-devices</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: removing unresponding devices: volumes</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: removing unresponding devices: expanders</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: removing unresponding devices: complete</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: start</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: expanders start</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: <span class="built_in">break</span> from expander scan: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: expanders complete</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: phys disk start</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: <span class="built_in">break</span> from phys disk scan: ioc_status(0x0022), loginfo(0x00000000)</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: phys disk complete</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: volumes start</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: <span class="built_in">break</span> from volume scan: ioc_status(0x0022), loginfo(0x00000000)</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: volumes complete</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: sas end devices start</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: <span class="built_in">break</span> from sas end device scan: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: sas end devices complete</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: pcie end devices start</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: log_info(0x3003011d): originator(IOP), code(0x03), sub_code(0x011d)</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: log_info(0x3003011d): originator(IOP), code(0x03), sub_code(0x011d)</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: <span class="built_in">break</span> from pcie end device scan: ioc_status(0x0021), loginfo(0x3003011d)</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: pcie devices: pcie end devices complete</span><br><span class="line">[Mon Jun 17 12:20:00 2019] mpt3sas_cm0: scan devices: complete</span><br><span class="line"></span><br><span class="line"><span class="comment"># reset host</span></span><br><span class="line">$ sg_reset -v -H /dev/sdf</span><br><span class="line">sg_reset: starting host reset</span><br><span class="line">sg_reset: completed host reset</span><br><span class="line"></span><br><span class="line">[Mon Jun 17 12:22:10 2019] mpt3sas_cm0: attempting host reset! scmd(ffff9620717edc00)</span><br><span class="line">[Mon Jun 17 12:22:10 2019] sd 0:0:3:0: CDB: Test Unit Ready</span><br><span class="line">[Mon Jun 17 12:22:10 2019] mpt3sas_cm0: sending diag reset !!</span><br><span class="line">[Mon Jun 17 12:22:11 2019] mpt3sas_cm0: diag reset: SUCCESS</span><br><span class="line">[Mon Jun 17 12:22:11 2019] mpt3sas_cm0: IOC Number : 0</span><br><span class="line">[Mon Jun 17 12:22:11 2019] mpt3sas_cm0: CurrentHostPageSize is 0: Setting default host page size to 4k</span><br><span class="line">[Mon Jun 17 12:22:11 2019] mpt3sas_cm0: LSISAS3008: FWVersion(15.00.03.00), ChipRevision(0x02), BiosVersion(08.31.00.00)</span><br><span class="line">[Mon Jun 17 12:22:11 2019] mpt3sas_cm0: Protocol=(Initiator), Capabilities=(Raid,TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)</span><br><span class="line">[Mon Jun 17 12:22:11 2019] mpt3sas_cm0: sending port <span class="built_in">enable</span> !!</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: port <span class="built_in">enable</span>: SUCCESS</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:0: handle(0x000a), sas_address(0x5000c5003015b562), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:0: enclosure logical id(0x500304801d72dd7f), slot(0)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:1: handle(0x000b), sas_address(0x5000c5003015b786), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:1: enclosure logical id(0x500304801d72dd7f), slot(1)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:2: handle(0x000c), sas_address(0x5000c5003015b57a), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:2: enclosure logical id(0x500304801d72dd7f), slot(2)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:3: handle(0x000d), sas_address(0x5000c5003015b56a), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:3: enclosure logical id(0x500304801d72dd7f), slot(3)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:4: handle(0x000e), sas_address(0x5000c500301b8b06), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:4: enclosure logical id(0x500304801d72dd7f), slot(4)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:5: handle(0x000f), sas_address(0x5000c5003015b566), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:5: enclosure logical id(0x500304801d72dd7f), slot(5)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:6: handle(0x0010), sas_address(0x5000c5003015b582), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:6: enclosure logical id(0x500304801d72dd7f), slot(6)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:7: handle(0x0011), sas_address(0x5000c5003015b56e), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:7: enclosure logical id(0x500304801d72dd7f), slot(7)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:8: handle(0x0012), sas_address(0x5000c5003015b5b6), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:8: enclosure logical id(0x500304801d72dd7f), slot(8)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:9: handle(0x0013), sas_address(0x5000c500301b8b7e), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:9: enclosure logical id(0x500304801d72dd7f), slot(9)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:10: handle(0x0014), sas_address(0x500304801d72ddfd), port: 255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] scsi target0:0:10: enclosure logical id(0x500304801d72dd7f), slot(24)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: <span class="built_in">break</span> from _scsih_search_responding_sas_devices: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> end-devices: complete</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> PCIe end-devices: complete</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> raid volumes: start</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> responding raid volumes: complete</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> expanders: start</span><br><span class="line">[Mon Jun 17 12:22:18 2019] expander present: handle(0x0009), sas_addr(0x500304801d72ddff), port:255</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: <span class="built_in">break</span> from _scsih_search_responding_expanders: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: search <span class="keyword">for</span> expanders: complete</span><br><span class="line">[Mon Jun 17 12:22:18 2019] mpt3sas_cm0: host reset: SUCCESS scmd(ffff9620717edc00)</span><br><span class="line">[Mon Jun 17 12:22:28 2019]  sdf: sdf1 sdf9</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: removing unresponding devices: start</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: removing unresponding devices: sas end-devices</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: removing unresponding devices: pcie end-devices</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: removing unresponding devices: volumes</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: removing unresponding devices: expanders</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: removing unresponding devices: complete</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: start</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: expanders start</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: <span class="built_in">break</span> from expander scan: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: expanders complete</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: phys disk start</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: <span class="built_in">break</span> from phys disk scan: ioc_status(0x0022), loginfo(0x00000000)</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: phys disk complete</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: volumes start</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: <span class="built_in">break</span> from volume scan: ioc_status(0x0022), loginfo(0x00000000)</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: volumes complete</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: sas end devices start</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: <span class="built_in">break</span> from sas end device scan: ioc_status(0x0022), loginfo(0x310f0400)</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: sas end devices complete</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: pcie end devices start</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: log_info(0x3003011d): originator(IOP), code(0x03), sub_code(0x011d)</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: log_info(0x3003011d): originator(IOP), code(0x03), sub_code(0x011d)</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: <span class="built_in">break</span> from pcie end device scan: ioc_status(0x0021), loginfo(0x3003011d)</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: pcie devices: pcie end devices complete</span><br><span class="line">[Mon Jun 17 12:22:28 2019] mpt3sas_cm0: scan devices: complete</span><br><span class="line"></span><br><span class="line"><span class="comment"># reset target, I guess there is the same with -d, looks like I &#x27;m right</span></span><br><span class="line">$ sg_reset -v -t /dev/sdf</span><br><span class="line">sg_reset: starting target reset</span><br><span class="line">sg_reset: completed target (or bus or host) reset</span><br><span class="line"></span><br><span class="line">[Mon Jun 17 12:23:27 2019] scsi target0:0:3: attempting target reset! scmd(ffff961e69a2f2c0)</span><br><span class="line">[Mon Jun 17 12:23:27 2019] sd 0:0:3:0: CDB: Test Unit Ready</span><br><span class="line">[Mon Jun 17 12:23:27 2019] scsi target0:0:3: _scsih_tm_display_info: handle(0x000d), sas_address(0x5000c5003015b56a), phy(15)</span><br><span class="line">[Mon Jun 17 12:23:27 2019] scsi target0:0:3: enclosurelogical id(0x500304801d72dd7f), slot(3)</span><br><span class="line">[Mon Jun 17 12:23:27 2019] scsi target0:0:3: enclosure level(0x0000), connector name(     )</span><br><span class="line">[Mon Jun 17 12:23:27 2019] scsi target0:0:3: target reset: SUCCESS scmd(ffff961e69a2f2c0)</span><br><span class="line">[Mon Jun 17 12:23:27 2019]  sdf: sdf1 sdf9</span><br><span class="line"></span><br><span class="line">$ sg_reset -v -d /dev/sdf</span><br><span class="line">sg_reset: starting device reset</span><br><span class="line">sg_reset: completed device (or target or bus or host) reset</span><br><span class="line"></span><br><span class="line">[Mon Jun 17 12:24:35 2019] sd 0:0:3:0: attempting device reset! scmd(ffff9620717edf80)</span><br><span class="line">[Mon Jun 17 12:24:35 2019] sd 0:0:3:0: CDB: Test Unit Ready</span><br><span class="line">[Mon Jun 17 12:24:35 2019] scsi target0:0:3: _scsih_tm_display_info: handle(0x000d), sas_address(0x5000c5003015b56a), phy(15)</span><br><span class="line">[Mon Jun 17 12:24:35 2019] scsi target0:0:3: enclosurelogical id(0x500304801d72dd7f), slot(3)</span><br><span class="line">[Mon Jun 17 12:24:35 2019] scsi target0:0:3: enclosure level(0x0000), connector name(     )</span><br><span class="line">[Mon Jun 17 12:24:35 2019] sd 0:0:3:0: device reset: SUCCESS scmd(ffff9620717edf80)</span><br><span class="line">[Mon Jun 17 12:24:35 2019]  sdf: sdf1 sdf9</span><br></pre></td></tr></table></figure><h3 id="mpt2sas-driver-layer"><a href="#mpt2sas-driver-layer" class="headerlink" title="mpt2sas driver layer"></a>mpt2sas driver layer</h3><p>Because HBA connect with JBOD will cause some of counts<br>I will record all counts at boot time. compare these counts with future<br>If you found some number increase that means there are some errors in sas driver layer</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">lsscsi -g &gt; /dev/shm/lsscsi.log</span><br><span class="line"><span class="built_in">cd</span> /sys/class/sas_phy;<span class="keyword">for</span> i <span class="keyword">in</span> $(ls); <span class="keyword">do</span></span><br><span class="line">value=$(cat <span class="variable">$i</span>/running_disparity_error_count)</span><br><span class="line">value2=$(cat <span class="variable">$i</span>/phy_reset_problem_count)</span><br><span class="line">value3=$(cat <span class="variable">$i</span>/loss_of_dword_sync_count)</span><br><span class="line">value4=$(cat <span class="variable">$i</span>/invalid_dword_count)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$value</span> -gt 0 ]] || [[ <span class="variable">$value2</span> -gt 0 ]] || [[ <span class="variable">$value3</span> -gt 0 ]] || [[ <span class="variable">$value4</span> -gt 0 ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  devtype=$(cat /dev/shm/lsscsi.log | grep -i <span class="variable">$i</span> | awk <span class="string">&#x27;&#123;print $1,$NF&#125;&#x27;</span>)</span><br><span class="line">  <span class="built_in">echo</span> -n <span class="variable">$i</span><span class="string">&quot;-- &quot;</span></span><br><span class="line">  <span class="built_in">echo</span> -n running_disparity_error_count<span class="string">&quot;:&quot;</span><span class="variable">$value</span><span class="string">&quot; &quot;</span><span class="variable">$devtype</span><span class="string">&quot; &quot;</span></span><br><span class="line">  <span class="built_in">echo</span> -n phy_reset_problem_count<span class="string">&quot;:&quot;</span><span class="variable">$value2</span><span class="string">&quot; &quot;</span><span class="variable">$devtype</span><span class="string">&quot; &quot;</span></span><br><span class="line">  <span class="built_in">echo</span> -n loss_of_dword_sync_count<span class="string">&quot;:&quot;</span><span class="variable">$value3</span><span class="string">&quot; &quot;</span><span class="variable">$devtype</span><span class="string">&quot; &quot;</span></span><br><span class="line">  <span class="built_in">echo</span> invalid_dword_count<span class="string">&quot;:&quot;</span><span class="variable">$value4</span><span class="string">&quot; &quot;</span><span class="variable">$devtype</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">phy-0:0:13-- running_disparity_error_count:1  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:1</span><br><span class="line">phy-0:0:15-- running_disparity_error_count:0  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:5</span><br><span class="line">phy-0:0:17-- running_disparity_error_count:0  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:5</span><br><span class="line">phy-0:0:19-- running_disparity_error_count:1  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:1</span><br><span class="line">phy-0:0:21-- running_disparity_error_count:0  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:6</span><br><span class="line">phy-0:0:23-- running_disparity_error_count:1  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:5</span><br><span class="line">phy-0:0:25-- running_disparity_error_count:0  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:6</span><br><span class="line">phy-0:0:27-- running_disparity_error_count:0  phy_reset_problem_count:0  loss_of_dword_sync_count:1  invalid_dword_count:5</span><br><span class="line">phy-12:2:3-- running_disparity_error_count:0  phy_reset_problem_count:1  loss_of_dword_sync_count:0  invalid_dword_count:0</span><br><span class="line">phy-14:1:22-- running_disparity_error_count:2  phy_reset_problem_count:4  loss_of_dword_sync_count:4  invalid_dword_count:30</span><br></pre></td></tr></table></figure><p>Counters that are defined in SAS 1.1 Standard:</p><ul><li><p>Invalid DWORDs<br>A dword that is not a data word or a primitive (i.e., in the character context, a dword that contains an invalid character, a control character not in the first character position, a control character other than K28.3 or K28.5 in the first character position or one or more characters with a running disparity error). This could mark the beginning of a loss of dword synchronization. Synchronization is lost after the fourth non-nullified invalid dword (if followed by a valid dword).</p></li><li><p>Phy reset problem<br>Number of times a PHY reset problem occurs. When a PHY or link is reset, it will run through its reset sequence (OOB, Speed Negotiation, Multiplexing, and Identification).</p></li></ul><p><a href="https://www.seagate.com/staticfiles/support/disc/manuals/Interface%20manuals/100293071c.pdf">for more scsi info</a></p><ul><li><p>Running disparity error count<br>A binary value indicating the cumulative encoded signal imbalance between the one and zero signal state of all characters since dword synchronization has been achieved.<br>Cumulative encoded signal imbalance between the one and zero signal state. Any dwords with one or more Running Disparity Errors will be considered as invalid dwords.</p></li><li><p>Loss of DWORD synchroization count<br>If occur loss_of_dword_sync, the sas protocol will retrans the bad data ? if occur multiple times at the short time(half an hour), the HBA will reset the link (from driver ? HBA itself ? )</p></li></ul><p>These errors mean that there is a problem in the link between the drive and the upstream port, if you have a cable in there the cable may be bad, if not it means one of the port is bad. Ofcourse even if you have a cable it can still mean one of the ports is bad.<br>After dword synchronization has been achieved, this machine monitors invalid dwords that are received. When an invalid dword is detected, it requires two valid dwords to nullify its effect. When four invalid dwords are detected without nullification, dword synchronization is considered lost.</p><p>The way to diagnose it is to use a different disk in the same slot and see if the error goes away or not, if it went away the disk is bad. If the error stayed the original disk is fine but the port on the server/chassis is bad and the server/chassis needs to be replaced.<br>The issue with loss of dword synchronization is that it means additional retries for some sent IOs and it will increase the latency of IOs by way of waiting more for data transmission due to these retransmits.</p><p>Errors are collected from PHYs on:<br>    SAS expanders.<br>    SAS disks.<br>    SAS I/O protocol ASICs.</p><p>SATA has its phy error count, just not same with T10, it s T13<br><a href="https://kb.netapp.com/app/answers/answer_view/a_id/1072439/~/how-to-troubleshoot-a-sas-e-series-storage-system-using-the-sasphyerrorlogs.csv">Note: SATA drives do not report any errors. As these are SATA devices, they do not have the same reporting functionality as their SAS counterparts.</a></p><h4 id="mpt2sas-debug-code"><a href="#mpt2sas-debug-code" class="headerlink" title="mpt2sas debug code"></a>mpt2sas debug code</h4><p>Example: this enables firmware events and reply with additional info<br>#insmod mpt2sas.ko logging_level=0x218<br>Example: this enables handshake and initialization logging<br>#insmod mpt2sas.ko logging_level=0x420<br>Example: this enables application using IOCTLS logging<br>#insmod mpt2sas.ko logging_level=0x8000<br>Example: this enables manufacture configuration logging<br>#insmod mpt2sas.ko logging_level=0x800<br>Example: this enables host reset and task management logging<br>#insmod mpt2sas.ko logging_level=0x2100<br>Example: this enables task set full logging<br>#insmod mpt2sas.ko logging_level=0x80000</p><p>NOTE: Many of the driver debug prints are using KERN_DEBUG and KERN_INFO logging level. Red Hat and SuSE tend to set the default logging level set to a higher level, perhaps KERN_WARNING. When set to KERN_WARNING you will be missing most the debug info. To turn on the additional logs, you will need to see the set klogd to KERN_DEBUG. In both SuSE and Red Hat offer configuration of klogd from the file /etc/sysconfig/syslog. Please refer to the klogd manual page for more info.</p><h5 id="mpt2sas-fwfault-debug"><a href="#mpt2sas-fwfault-debug" class="headerlink" title="mpt2sas_fwfault_debug"></a><a href="https://git.congatec.com/arm/qmx6_kernel/commit/fa7f31673583a6e0876f8bb420735cdd8a3ffa57">mpt2sas_fwfault_debug</a></h5><p>Added command line option and shost sysfs attribute called mpt2sas_fwfault_debug. When enduser writes a 1 to this parameter, this will enable support in the driver for debugging firmware timeout related issues.</p><p>This handling was added in three areas<br>(a) scsi error handling callback called task_abort<br>(b) IOCTL interface<br>(c) other timeouts that result in diag resets, such as manufacturing config pages.<br>When this support is enabled, the driver will provide dump_stack to console, halt controller firmware, and panic driver. The end user probably would want to setup serial console redirection so the dump stack can be seen.</p><p>Here are the three methods for enable this support:</p><p>(a) # insmod mpt2sas.ko mpt2sas_fwfault_debug=1<br>(b) # echo 1 &gt; /sys/module/mpt2sas/parameters/mpt2sas_fwfault_debug<br>(c) # echo 1 &gt; /sys/class/scsi_host/host#/fwfault_debug  (where # is the host number)</p><p>At this time, there is some issues in HBA, you could compare with these time stamps.<br>The hardware(HBA) throw out a lot of error log to kernel<br>It s not the kernel behavior, it s the error log from HBA</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Feb 14 10:53:28 host1.example kernel: : mpt2sas0:</span> <span class="string">fault_state(0x5841)!</span></span><br><span class="line"><span class="attr">Feb 14 10:53:28 host1.example kernel: : mpt2sas0:</span> <span class="string">sending</span> <span class="string">diag</span> <span class="string">reset</span> <span class="string">!!</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">Feb 14 11:14:27 host1.example kernel: : mpt2sas0:</span> <span class="string">fault_state(0x5841)!</span></span><br><span class="line"><span class="attr">Feb 14 11:14:27 host1.example kernel: : mpt2sas0:</span> <span class="string">sending</span> <span class="string">diag</span> <span class="string">reset</span> <span class="string">!</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">Feb 14 11:25:30 host1.example kernel: : mpt2sas0:</span> <span class="string">fault_state(0x5841)!</span></span><br><span class="line"><span class="attr">Feb 14 11:25:30 host1.example kernel: : mpt2sas0:</span> <span class="string">sending</span> <span class="string">diag</span> <span class="string">reset</span> <span class="string">!!</span></span><br><span class="line"><span class="attr">Feb 14 11:25:30 host1.example kernel: : mpt2sas0:</span> <span class="string">fault_state(0x5841)!</span></span><br><span class="line"><span class="attr">Feb 14 11:25:30 host1.example kernel: : mpt2sas0:</span> <span class="string">sending</span> <span class="string">diag</span> <span class="string">reset</span> <span class="string">!!</span></span><br><span class="line"><span class="attr">Feb 14 11:25:31 host1.example kernel: : mpt2sas0: diag reset:</span> <span class="string">SUCCESS</span></span><br><span class="line"><span class="attr">Feb 14 11:25:31 host1.example kernel: : mpt2sas0: diag reset:</span> <span class="string">SUCCESS</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0: LSISAS2008:</span> <span class="string">FWVersion(08.00.09.00),</span> <span class="string">ChipRevision(0x03),</span> <span class="string">BiosVersion(07.15.00.00)</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">Protocol=(Initiator,Target),</span> <span class="string">Capabilities=(Raid,TLR,EEDP,Snapshot</span> <span class="string">Buffer,Diag</span> <span class="string">Trace</span> <span class="string">Buffer,Task</span> <span class="string">Set</span> <span class="string">Full,NCQ)</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">sending</span> <span class="string">port</span> <span class="string">enable</span> <span class="string">!!</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0: port enable:</span> <span class="string">SUCCESS</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">_scsih_search_responding_sas_devices</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0: LSISAS2008:</span> <span class="string">FWVersion(08.00.09.00),</span> <span class="string">ChipRevision(0x03),</span> <span class="string">BiosVersion(07.15.00.00)</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">Protocol=(Initiator,Target),</span> <span class="string">Capabilities=(Raid,TLR,EEDP,Snapshot</span> <span class="string">Buffer,Diag</span> <span class="string">Trace</span> <span class="string">Buffer,Task</span> <span class="string">Set</span> <span class="string">Full,NCQ)</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">sending</span> <span class="string">port</span> <span class="string">enable</span> <span class="string">!!</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0: port enable:</span> <span class="string">SUCCESS</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">_scsih_search_responding_sas_devices</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">_scsih_search_responding_raid_devices</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">_scsih_search_responding_raid_devices</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">_scsih_search_responding_expanders</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0: _base_fault_reset_work: hard reset:</span> <span class="string">success</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0:</span> <span class="string">_scsih_search_responding_expanders</span></span><br><span class="line"><span class="attr">Feb 14 11:25:38 host1.example kernel: : mpt2sas0: _base_fault_reset_work: hard reset:</span> <span class="string">success</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">Feb 14 13:46:48 host1.example kernel: : mpt2sas0:</span> <span class="string">fault_state(0x5841)!</span></span><br><span class="line"><span class="attr">Feb 14 13:46:48 host1.example kernel: : mpt2sas0:</span> <span class="string">sending</span> <span class="string">diag</span> <span class="string">reset</span> <span class="string">!!</span></span><br><span class="line"><span class="string">```</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">### SATA log</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="comment"># smartctl man page</span></span><br><span class="line"><span class="string">error</span>  <span class="bullet">-</span>  [<span class="string">ATA</span>]  <span class="string">prints</span>  <span class="string">the</span> <span class="string">Summary</span> <span class="string">SMART</span> <span class="string">error</span> <span class="string">log.</span> <span class="string">SMART</span> <span class="string">disks</span> <span class="string">maintain</span> <span class="string">a</span> <span class="string">log</span> <span class="string">of</span> <span class="string">the</span> <span class="string">most</span> <span class="string">recent</span> <span class="string">five</span> <span class="string">non-trivial</span> <span class="string">errors.</span> <span class="string">For</span> <span class="string">each</span> <span class="string">of</span> <span class="string">these</span> <span class="string">errors,</span> <span class="string">the</span> <span class="string">disk</span> <span class="string">power-on</span> <span class="string">lifetime</span> <span class="string">at</span> <span class="string">which</span> <span class="string">the</span> <span class="string">error</span> <span class="string">occurred</span> <span class="string">is</span> <span class="string">recorded,</span> <span class="string">as</span> <span class="string">is</span> <span class="string">the</span> <span class="string">device</span> <span class="string">status</span>  <span class="string">(idle,</span> <span class="string">standby,</span>  <span class="string">etc)</span>  <span class="string">at</span>  <span class="string">the</span> <span class="string">time</span> <span class="string">of</span> <span class="string">the</span> <span class="string">error.</span>  <span class="string">For</span> <span class="string">some</span> <span class="string">common</span> <span class="string">types</span> <span class="string">of</span> <span class="string">errors,</span> <span class="string">the</span> <span class="string">Error</span> <span class="string">Register</span> <span class="string">(ER)</span> <span class="string">and</span> <span class="string">Status</span> <span class="string">Register</span> <span class="string">(SR)</span> <span class="attr">values are decoded and printed as text. The meanings of these are:</span></span><br><span class="line">   <span class="attr">ABRT:</span>  <span class="string">Command</span> <span class="string">ABoRTed</span></span><br><span class="line">   <span class="attr">AMNF:</span>  <span class="string">Address</span> <span class="string">Mark</span> <span class="string">Not</span> <span class="string">Found</span></span><br><span class="line">   <span class="attr">CCTO:</span>  <span class="string">Command</span> <span class="string">Completion</span> <span class="string">Timed</span> <span class="string">Out</span></span><br><span class="line">   <span class="attr">EOM:</span>   <span class="string">End</span> <span class="string">Of</span> <span class="string">Media</span></span><br><span class="line">   <span class="attr">ICRC:</span>  <span class="string">Interface</span> <span class="string">Cyclic</span> <span class="string">Redundancy</span> <span class="string">Code</span> <span class="string">(CRC)</span> <span class="string">error</span></span><br><span class="line">   <span class="attr">IDNF:</span>  <span class="string">IDentity</span> <span class="string">Not</span> <span class="string">Found</span></span><br><span class="line">   <span class="attr">ILI:</span>   <span class="string">(packet</span> <span class="string">command-set</span> <span class="string">specific)</span></span><br><span class="line">   <span class="attr">MC:</span>    <span class="string">Media</span> <span class="string">Changed</span></span><br><span class="line">   <span class="attr">MCR:</span>   <span class="string">Media</span> <span class="string">Change</span> <span class="string">Request</span></span><br><span class="line">   <span class="attr">NM:</span>    <span class="literal">No</span> <span class="string">Media</span></span><br><span class="line">   <span class="attr">obs:</span>   <span class="string">obsolete</span></span><br><span class="line">   <span class="attr">TK0NF:</span> <span class="string">TracK</span> <span class="number">0</span> <span class="string">Not</span> <span class="string">Found</span></span><br><span class="line">   <span class="attr">UNC:</span>   <span class="string">UNCorrectable</span> <span class="string">Error</span> <span class="string">in</span> <span class="string">Data</span></span><br><span class="line">   <span class="attr">WP:</span>    <span class="string">Media</span> <span class="string">is</span> <span class="string">Write</span> <span class="string">Protected</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">smartctl</span> <span class="string">-l</span> <span class="string">statphy</span> <span class="string">/dev/sdb&quot;</span></span><br><span class="line"><span class="string">smartctl</span> <span class="number">6.6</span> <span class="number">2017-11-05 </span><span class="string">r4594</span> [<span class="string">x86_64-linux-4.18.0-80.11.2.el8_0.x86_64</span>] <span class="string">(local</span> <span class="string">build)</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(C)</span> <span class="number">2002-17</span><span class="string">,</span> <span class="string">Bruce</span> <span class="string">Allen,</span> <span class="string">Christian</span> <span class="string">Franke,</span> <span class="string">www.smartmontools.org</span></span><br><span class="line"></span><br><span class="line"><span class="string">=======&gt;</span> <span class="attr">INVALID ARGUMENT TO -l:</span> <span class="string">statphy</span></span><br><span class="line"><span class="string">=======&gt;</span> <span class="attr">VALID ARGUMENTS ARE:</span> <span class="string">error,</span> <span class="string">selftest,</span> <span class="string">selective,</span> <span class="string">directory[,g|s],</span> <span class="string">xerror[,N][,error],</span> <span class="string">xselftest[,N][,selftest],</span> <span class="string">background,</span> <span class="string">sasphy[,reset],</span> <span class="string">sataphy[,reset],</span> <span class="string">scttemp[sts,hist],</span> <span class="string">scttempint,N[,p],</span> <span class="string">scterc[,N,M],</span> <span class="string">devstat[,N],</span> <span class="string">defects[,N],</span> <span class="string">ssd,</span> <span class="string">gplog,N[,RANGE],</span> <span class="string">smartlog,N[,RANGE],</span> <span class="string">nvmelog,N,SIZE</span> <span class="string">&lt;=======</span></span><br><span class="line"></span><br><span class="line"><span class="string">Use</span> <span class="string">smartctl</span> <span class="string">-h</span> <span class="string">to</span> <span class="string">get</span> <span class="string">a</span> <span class="string">usage</span> <span class="string">summary</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">smartctl</span> <span class="string">-l</span> <span class="string">sataphy</span> <span class="string">/dev/sdb</span></span><br><span class="line"><span class="string">smartctl</span> <span class="number">6.6</span> <span class="number">2017-11-05 </span><span class="string">r4594</span> [<span class="string">x86_64-linux-4.18.0-80.11.2.el8_0.x86_64</span>] <span class="string">(local</span> <span class="string">build)</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(C)</span> <span class="number">2002-17</span><span class="string">,</span> <span class="string">Bruce</span> <span class="string">Allen,</span> <span class="string">Christian</span> <span class="string">Franke,</span> <span class="string">www.smartmontools.org</span></span><br><span class="line"></span><br><span class="line"><span class="string">SATA</span> <span class="string">Phy</span> <span class="string">Event</span> <span class="string">Counters</span> <span class="string">(GP</span> <span class="string">Log</span> <span class="number">0x11</span><span class="string">)</span></span><br><span class="line"><span class="string">ID</span>      <span class="string">Size</span>     <span class="string">Value</span>  <span class="string">Description</span></span><br><span class="line"><span class="number">0x0001</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Command</span> <span class="string">failed</span> <span class="string">due</span> <span class="string">to</span> <span class="string">ICRC</span> <span class="string">error</span></span><br><span class="line"><span class="number">0x0002</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0003</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">device-to-host</span> <span class="string">data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0004</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">host-to-device</span> <span class="string">data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0005</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">non-data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0006</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">device-to-host</span> <span class="string">non-data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0007</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">host-to-device</span> <span class="string">non-data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0008</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Device-to-host</span> <span class="string">non-data</span> <span class="string">FIS</span> <span class="string">retries</span></span><br><span class="line"><span class="number">0x0009</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Transition</span> <span class="string">from</span> <span class="string">drive</span> <span class="string">PhyRdy</span> <span class="string">to</span> <span class="string">drive</span> <span class="string">PhyNRdy</span></span><br><span class="line"><span class="number">0x000a</span>  <span class="number">2</span>            <span class="number">1</span>  <span class="string">Device-to-host</span> <span class="string">register</span> <span class="string">FISes</span> <span class="string">sent</span> <span class="string">due</span> <span class="string">to</span> <span class="string">a</span> <span class="string">COMRESET</span></span><br><span class="line"><span class="number">0x000b</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">CRC</span> <span class="string">errors</span> <span class="string">within</span> <span class="string">host-to-device</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x000d</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Non-CRC</span> <span class="string">errors</span> <span class="string">within</span> <span class="string">host-to-device</span> <span class="string">FIS</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#except phy error, the smart attr will show some error too</span></span><br><span class="line"><span class="string">SMART</span> <span class="number">5</span> <span class="bullet">-</span> <span class="string">Reallocated_Sector_Count.</span></span><br><span class="line"><span class="string">SMART</span> <span class="number">187</span> <span class="bullet">-</span> <span class="string">Reported_Uncorrectable_Errors.</span></span><br><span class="line"><span class="string">SMART</span> <span class="number">188</span> <span class="bullet">-</span> <span class="string">Command_Timeout.</span></span><br><span class="line"><span class="string">SMART</span> <span class="number">197</span> <span class="bullet">-</span> <span class="string">Current_Pending_Sector_Count.</span></span><br><span class="line"><span class="string">SMART</span> <span class="number">198</span> <span class="bullet">-</span> <span class="string">Offline_Uncorrectable</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">smartclt</span> <span class="string">-l</span> <span class="string">defects</span> <span class="string">-x</span> <span class="string">/dev/sdx</span></span><br><span class="line"><span class="string">===</span> <span class="string">START</span> <span class="string">OF</span> <span class="string">INFORMATION</span> <span class="string">SECTION</span> <span class="string">===</span></span><br><span class="line"><span class="attr">Model Family:</span>     <span class="string">HGST</span> <span class="string">Ultrastar</span> <span class="string">He10</span></span><br><span class="line"><span class="attr">Device Model:</span>     <span class="string">HGST</span> <span class="string">HUH721010ALE600</span></span><br><span class="line"><span class="attr">Serial Number:</span>    <span class="string">XXXXXXXXXX</span></span><br><span class="line"><span class="attr">LU WWN Device Id:</span> <span class="number">5</span> <span class="string">000cca</span> <span class="string">xxxxxxxx</span></span><br><span class="line"><span class="attr">Add. Product Id:</span>  <span class="string">XXXXXX</span></span><br><span class="line"><span class="attr">Firmware Version:</span> <span class="string">LHDELT14</span></span><br><span class="line"><span class="attr">User Capacity:</span>    <span class="number">10</span><span class="string">,000,831,348,736</span> <span class="string">bytes</span> [<span class="number">10.0</span> <span class="string">TB</span>]</span><br><span class="line"><span class="attr">Sector Sizes:</span>     <span class="number">512</span> <span class="string">bytes</span> <span class="string">logical,</span> <span class="number">4096 </span><span class="string">bytes</span> <span class="string">physical</span></span><br><span class="line"><span class="attr">Rotation Rate:</span>    <span class="number">7200 </span><span class="string">rpm</span></span><br><span class="line"><span class="attr">Form Factor:</span>      <span class="number">3.5</span> <span class="string">inches</span></span><br><span class="line"><span class="attr">Device is:</span>        <span class="string">In</span> <span class="string">smartctl</span> <span class="string">database</span> [<span class="attr">for details use:</span> <span class="string">-P</span> <span class="string">show</span>]</span><br><span class="line"><span class="attr">ATA Version is:</span>   <span class="string">ACS-2,</span> <span class="string">ATA8-ACS</span> <span class="string">T13/1699-D</span> <span class="string">revision</span> <span class="number">4</span></span><br><span class="line"><span class="attr">SATA Version is:</span>  <span class="string">SATA</span> <span class="number">3.2</span><span class="string">,</span> <span class="number">6.0</span> <span class="string">Gb/s</span> <span class="string">(current:</span> <span class="number">6.0</span> <span class="string">Gb/s)</span></span><br><span class="line"><span class="attr">Local Time is:</span>    <span class="string">Tue</span> <span class="string">Dec</span> <span class="number">10</span> <span class="number">11</span><span class="string">:18:58</span> <span class="number">2019 </span><span class="string">EST</span></span><br><span class="line"><span class="attr">SMART support is:</span> <span class="string">Available</span> <span class="bullet">-</span> <span class="string">device</span> <span class="string">has</span> <span class="string">SMART</span> <span class="string">capability.</span></span><br><span class="line"><span class="attr">SMART support is:</span> <span class="string">Enabled</span></span><br><span class="line"><span class="attr">AAM feature is:</span>   <span class="string">Unavailable</span></span><br><span class="line"><span class="attr">APM feature is:</span>   <span class="string">Disabled</span></span><br><span class="line"><span class="attr">Rd look-ahead is:</span> <span class="string">Enabled</span></span><br><span class="line"><span class="attr">Write cache is:</span>   <span class="string">Disabled</span></span><br><span class="line"><span class="attr">DSN feature is:</span>   <span class="string">Unavailable</span></span><br><span class="line"><span class="attr">ATA Security is:</span>  <span class="string">Disabled,</span> <span class="string">NOT</span> <span class="string">FROZEN</span> [<span class="string">SEC1</span>]</span><br><span class="line"><span class="attr">Wt Cache Reorder:</span> <span class="string">Enabled</span></span><br><span class="line"></span><br><span class="line"><span class="string">===</span> <span class="string">START</span> <span class="string">OF</span> <span class="string">READ</span> <span class="string">SMART</span> <span class="string">DATA</span> <span class="string">SECTION</span> <span class="string">===</span></span><br><span class="line"><span class="attr">SMART overall-health self-assessment test result:</span> <span class="string">PASSED</span></span><br><span class="line"></span><br><span class="line"><span class="attr">General SMART Values:</span></span><br><span class="line"><span class="attr">Offline data collection status:</span>  <span class="string">(0x82)</span> <span class="string">Offline</span> <span class="string">data</span> <span class="string">collection</span> <span class="string">activity</span></span><br><span class="line">                                        <span class="string">was</span> <span class="string">completed</span> <span class="string">without</span> <span class="string">error.</span></span><br><span class="line">                                        <span class="attr">Auto Offline Data Collection:</span> <span class="string">Enabled.</span></span><br><span class="line"><span class="attr">Self-test execution status:</span>      <span class="string">(</span>  <span class="number">40</span><span class="string">)</span> <span class="string">The</span> <span class="string">self-test</span> <span class="string">routine</span> <span class="string">was</span> <span class="string">interrupted</span></span><br><span class="line">                                        <span class="string">by</span> <span class="string">the</span> <span class="string">host</span> <span class="string">with</span> <span class="string">a</span> <span class="string">hard</span> <span class="string">or</span> <span class="string">soft</span> <span class="string">reset.</span></span><br><span class="line"><span class="string">Total</span> <span class="string">time</span> <span class="string">to</span> <span class="string">complete</span> <span class="string">Offline</span></span><br><span class="line"><span class="attr">data collection:</span>                <span class="string">(</span>   <span class="number">90</span><span class="string">)</span> <span class="string">seconds.</span></span><br><span class="line"><span class="string">Offline</span> <span class="string">data</span> <span class="string">collection</span></span><br><span class="line"><span class="attr">capabilities:</span>                    <span class="string">(0x5b)</span> <span class="string">SMART</span> <span class="string">execute</span> <span class="string">Offline</span> <span class="string">immediate.</span></span><br><span class="line">                                        <span class="string">Auto</span> <span class="string">Offline</span> <span class="string">data</span> <span class="string">collection</span> <span class="string">on/off</span> <span class="string">support.</span></span><br><span class="line">                                        <span class="string">Suspend</span> <span class="string">Offline</span> <span class="string">collection</span> <span class="string">upon</span> <span class="string">new</span></span><br><span class="line">                                        <span class="string">command.</span></span><br><span class="line">                                        <span class="string">Offline</span> <span class="string">surface</span> <span class="string">scan</span> <span class="string">supported.</span></span><br><span class="line">                                        <span class="string">Self-test</span> <span class="string">supported.</span></span><br><span class="line">                                        <span class="literal">No</span> <span class="string">Conveyance</span> <span class="string">Self-test</span> <span class="string">supported.</span></span><br><span class="line">                                        <span class="string">Selective</span> <span class="string">Self-test</span> <span class="string">supported.</span></span><br><span class="line"><span class="attr">SMART capabilities:</span>            <span class="string">(0x0003)</span> <span class="string">Saves</span> <span class="string">SMART</span> <span class="string">data</span> <span class="string">before</span> <span class="string">entering</span></span><br><span class="line">                                        <span class="string">power-saving</span> <span class="string">mode.</span></span><br><span class="line">                                        <span class="string">Supports</span> <span class="string">SMART</span> <span class="string">auto</span> <span class="string">save</span> <span class="string">timer.</span></span><br><span class="line"><span class="attr">Error logging capability:</span>        <span class="string">(0x01)</span> <span class="string">Error</span> <span class="string">logging</span> <span class="string">supported.</span></span><br><span class="line">                                        <span class="string">General</span> <span class="string">Purpose</span> <span class="string">Logging</span> <span class="string">supported.</span></span><br><span class="line"><span class="string">Short</span> <span class="string">self-test</span> <span class="string">routine</span></span><br><span class="line"><span class="attr">recommended polling time:</span>        <span class="string">(</span>   <span class="number">2</span><span class="string">)</span> <span class="string">minutes.</span></span><br><span class="line"><span class="string">Extended</span> <span class="string">self-test</span> <span class="string">routine</span></span><br><span class="line"><span class="attr">recommended polling time:</span>        <span class="string">(1063)</span> <span class="string">minutes.</span></span><br><span class="line"><span class="attr">SCT capabilities:</span>              <span class="string">(0x003d)</span> <span class="string">SCT</span> <span class="string">Status</span> <span class="string">supported.</span></span><br><span class="line">                                        <span class="string">SCT</span> <span class="string">Error</span> <span class="string">Recovery</span> <span class="string">Control</span> <span class="string">supported.</span></span><br><span class="line">                                        <span class="string">SCT</span> <span class="string">Feature</span> <span class="string">Control</span> <span class="string">supported.</span></span><br><span class="line">                                        <span class="string">SCT</span> <span class="string">Data</span> <span class="string">Table</span> <span class="string">supported.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SMART Attributes Data Structure revision number:</span> <span class="number">16</span></span><br><span class="line"><span class="attr">Vendor Specific SMART Attributes with Thresholds:</span></span><br><span class="line"><span class="string">ID#</span> <span class="string">ATTRIBUTE_NAME</span>          <span class="string">FLAGS</span>    <span class="string">VALUE</span> <span class="string">WORST</span> <span class="string">THRESH</span> <span class="string">FAIL</span> <span class="string">RAW_VALUE</span></span><br><span class="line">  <span class="number">1</span> <span class="string">Raw_Read_Error_Rate</span>     <span class="string">PO-R--</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">016</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line">  <span class="number">2</span> <span class="string">Throughput_Performance</span>  <span class="string">--S---</span>   <span class="number">134</span>   <span class="number">134</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">96</span></span><br><span class="line">  <span class="number">3</span> <span class="string">Spin_Up_Time</span>            <span class="string">POS---</span>   <span class="number">191</span>   <span class="number">191</span>   <span class="number">024</span>    <span class="bullet">-</span>    <span class="number">344</span> <span class="string">(Average</span> <span class="number">344</span><span class="string">)</span></span><br><span class="line">  <span class="number">4</span> <span class="string">Start_Stop_Count</span>        <span class="string">-O--C-</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">33</span></span><br><span class="line">  <span class="number">5</span> <span class="string">Reallocated_Sector_Ct</span>   <span class="string">PO--CK</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">005</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line">  <span class="number">7</span> <span class="string">Seek_Error_Rate</span>         <span class="string">-O-R--</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line">  <span class="number">8</span> <span class="string">Seek_Time_Performance</span>   <span class="string">--S---</span>   <span class="number">128</span>   <span class="number">128</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">18</span></span><br><span class="line">  <span class="number">9</span> <span class="string">Power_On_Hours</span>          <span class="string">-O--C-</span>   <span class="number">099</span>   <span class="number">099</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">7599</span></span><br><span class="line"> <span class="number">10</span> <span class="string">Spin_Retry_Count</span>        <span class="string">-O--C-</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line"> <span class="number">12</span> <span class="string">Power_Cycle_Count</span>       <span class="string">-O--CK</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">33</span></span><br><span class="line"> <span class="number">22</span> <span class="string">Helium_Level</span>            <span class="string">PO---K</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">025</span>    <span class="bullet">-</span>    <span class="number">100</span></span><br><span class="line"><span class="number">192</span> <span class="string">Power-Off_Retract_Count</span> <span class="string">-O--CK</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">547</span></span><br><span class="line"><span class="number">193</span> <span class="string">Load_Cycle_Count</span>        <span class="string">-O--C-</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">547</span></span><br><span class="line"><span class="number">194</span> <span class="string">Temperature_Celsius</span>     <span class="string">-O----</span>   <span class="number">206</span>   <span class="number">206</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">29</span> <span class="string">(Min/Max</span> <span class="number">24</span><span class="string">/32)</span></span><br><span class="line"><span class="number">196</span> <span class="string">Reallocated_Event_Count</span> <span class="string">-O--CK</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line"><span class="number">197</span> <span class="string">Current_Pending_Sector</span>  <span class="string">-O---K</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line"><span class="number">198</span> <span class="string">Offline_Uncorrectable</span>   <span class="string">---R--</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line"><span class="number">199</span> <span class="string">UDMA_CRC_Error_Count</span>    <span class="string">-O-R--</span>   <span class="number">200</span>   <span class="number">200</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line"><span class="number">223</span> <span class="string">Load_Retry_Count</span>        <span class="string">-O-R--</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">0</span></span><br><span class="line"><span class="number">241</span> <span class="string">Total_LBAs_Written</span>      <span class="string">-O--C-</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">50732585533</span></span><br><span class="line"><span class="number">242</span> <span class="string">Total_LBAs_Read</span>         <span class="string">-O--C-</span>   <span class="number">100</span>   <span class="number">100</span>   <span class="number">000</span>    <span class="bullet">-</span>    <span class="number">26707853436</span></span><br><span class="line">                            <span class="string">||||||_</span> <span class="string">K</span> <span class="string">auto-keep</span></span><br><span class="line">                            <span class="string">|||||__</span> <span class="string">C</span> <span class="string">event</span> <span class="string">count</span></span><br><span class="line">                            <span class="string">||||___</span> <span class="string">R</span> <span class="string">error</span> <span class="string">rate</span></span><br><span class="line">                            <span class="string">|||____</span> <span class="string">S</span> <span class="string">speed/performance</span></span><br><span class="line">                            <span class="string">||_____</span> <span class="string">O</span> <span class="string">updated</span> <span class="string">online</span></span><br><span class="line">                            <span class="string">|______</span> <span class="string">P</span> <span class="string">prefailure</span> <span class="string">warning</span></span><br><span class="line"></span><br><span class="line"><span class="string">General</span> <span class="string">Purpose</span> <span class="string">Log</span> <span class="string">Directory</span> <span class="string">Version</span> <span class="number">1</span></span><br><span class="line"><span class="string">SMART</span>           <span class="string">Log</span> <span class="string">Directory</span> <span class="string">Version</span> <span class="number">1</span> [<span class="string">multi-sector</span> <span class="string">log</span> <span class="string">support</span>]</span><br><span class="line"><span class="string">Address</span>    <span class="string">Access</span>  <span class="string">R/W</span>   <span class="string">Size</span>  <span class="string">Description</span></span><br><span class="line"><span class="number">0x00</span>       <span class="string">GPL,SL</span>  <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">Log</span> <span class="string">Directory</span></span><br><span class="line"><span class="number">0x01</span>           <span class="string">SL</span>  <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">Summary</span> <span class="string">SMART</span> <span class="string">error</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x02</span>           <span class="string">SL</span>  <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">Comprehensive</span> <span class="string">SMART</span> <span class="string">error</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x03</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">Ext.</span> <span class="string">Comprehensive</span> <span class="string">SMART</span> <span class="string">error</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x04</span>       <span class="string">GPL</span>     <span class="string">R/O</span>    <span class="number">256</span>  <span class="string">Device</span> <span class="string">Statistics</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x04</span>       <span class="string">SL</span>      <span class="string">R/O</span>    <span class="number">255</span>  <span class="string">Device</span> <span class="string">Statistics</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x06</span>           <span class="string">SL</span>  <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">SMART</span> <span class="string">self-test</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x07</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">Extended</span> <span class="string">self-test</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x08</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">2</span>  <span class="string">Power</span> <span class="string">Conditions</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x09</span>           <span class="string">SL</span>  <span class="string">R/W</span>      <span class="number">1</span>  <span class="string">Selective</span> <span class="string">self-test</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x0c</span>       <span class="string">GPL</span>     <span class="string">R/O</span>   <span class="number">5501  </span><span class="string">Pending</span> <span class="string">Defects</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x10</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">NCQ</span> <span class="string">Command</span> <span class="string">Error</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x11</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">SATA</span> <span class="string">Phy</span> <span class="string">Event</span> <span class="string">Counters</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x12</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">SATA</span> <span class="string">NCQ</span> <span class="string">Non-Data</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x13</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">SATA</span> <span class="string">NCQ</span> <span class="string">Send</span> <span class="string">and</span> <span class="string">Receive</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x21</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">Write</span> <span class="string">stream</span> <span class="string">error</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x22</span>       <span class="string">GPL</span>     <span class="string">R/O</span>      <span class="number">1</span>  <span class="string">Read</span> <span class="string">stream</span> <span class="string">error</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x24</span>       <span class="string">GPL</span>     <span class="string">R/O</span>    <span class="number">256</span>  <span class="string">Current</span> <span class="string">Device</span> <span class="string">Internal</span> <span class="string">Status</span> <span class="string">Data</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x25</span>       <span class="string">GPL</span>     <span class="string">R/O</span>    <span class="number">256</span>  <span class="string">Saved</span> <span class="string">Device</span> <span class="string">Internal</span> <span class="string">Status</span> <span class="string">Data</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x30</span>       <span class="string">GPL,SL</span>  <span class="string">R/O</span>      <span class="number">9</span>  <span class="string">IDENTIFY</span> <span class="string">DEVICE</span> <span class="string">data</span> <span class="string">log</span></span><br><span class="line"><span class="number">0x80</span><span class="number">-0x9f</span>  <span class="string">GPL,SL</span>  <span class="string">R/W</span>     <span class="number">16</span>  <span class="string">Host</span> <span class="string">vendor</span> <span class="string">specific</span> <span class="string">log</span></span><br><span class="line"><span class="number">0xdf</span>       <span class="string">GPL,SL</span>  <span class="string">VS</span>       <span class="number">1</span>  <span class="string">Device</span> <span class="string">vendor</span> <span class="string">specific</span> <span class="string">log</span></span><br><span class="line"><span class="number">0xe0</span>       <span class="string">GPL,SL</span>  <span class="string">R/W</span>      <span class="number">1</span>  <span class="string">SCT</span> <span class="string">Command/Status</span></span><br><span class="line"><span class="number">0xe1</span>       <span class="string">GPL,SL</span>  <span class="string">R/W</span>      <span class="number">1</span>  <span class="string">SCT</span> <span class="string">Data</span> <span class="string">Transfer</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SMART Extended Comprehensive Error Log Version:</span> <span class="number">1</span> <span class="string">(1</span> <span class="string">sectors)</span></span><br><span class="line"><span class="literal">No</span> <span class="string">Errors</span> <span class="string">Logged</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SMART Extended Self-test Log Version:</span> <span class="number">1</span> <span class="string">(1</span> <span class="string">sectors)</span></span><br><span class="line"><span class="string">Num</span>  <span class="string">Test_Description</span>    <span class="string">Status</span>                  <span class="string">Remaining</span>  <span class="string">LifeTime(hours)</span>  <span class="string">LBA_of_first_error</span></span><br><span class="line"><span class="comment"># 1  Short offline       Interrupted (host reset)      80%      7288         -</span></span><br><span class="line"><span class="comment"># 2  Short offline       Interrupted (host reset)      80%      5140         -</span></span><br><span class="line"><span class="comment"># 3  Short offline       Interrupted (host reset)      80%      3438         -</span></span><br><span class="line"><span class="comment"># 4  Short offline       Interrupted (host reset)      80%      3241         -</span></span><br><span class="line"><span class="comment"># 5  Short offline       Interrupted (host reset)      80%      3196         -</span></span><br><span class="line"><span class="comment"># 6  Short offline       Interrupted (host reset)      80%      3194         -</span></span><br><span class="line"><span class="comment"># 7  Short offline       Interrupted (host reset)      80%      3102         -</span></span><br><span class="line"><span class="comment"># 8  Short offline       Interrupted (host reset)      80%      3098         -</span></span><br><span class="line"><span class="comment"># 9  Short offline       Interrupted (host reset)      80%      3080         -</span></span><br><span class="line"><span class="comment">#10  Short offline       Interrupted (host reset)      80%      3080         -</span></span><br><span class="line"><span class="comment">#11  Short offline       Interrupted (host reset)      80%      3080         -</span></span><br><span class="line"><span class="comment">#12  Short offline       Interrupted (host reset)      80%      3080         -</span></span><br><span class="line"><span class="comment">#13  Short offline       Interrupted (host reset)      80%      3079         -</span></span><br><span class="line"><span class="comment">#14  Short offline       Interrupted (host reset)      80%      2574         -</span></span><br><span class="line"><span class="comment">#15  Short offline       Interrupted (host reset)      80%      1013         -</span></span><br><span class="line"><span class="comment">#16  Short offline       Interrupted (host reset)      70%      1011         -</span></span><br><span class="line"><span class="comment">#17  Short offline       Interrupted (host reset)      70%       938         -</span></span><br><span class="line"><span class="comment">#18  Short offline       Interrupted (host reset)      70%       814         -</span></span><br><span class="line"><span class="comment">#19  Short offline       Interrupted (host reset)      70%       281         -</span></span><br><span class="line"></span><br><span class="line"><span class="string">SMART</span> <span class="string">Selective</span> <span class="string">self-test</span> <span class="string">log</span> <span class="string">data</span> <span class="string">structure</span> <span class="string">revision</span> <span class="string">number</span> <span class="number">1</span></span><br><span class="line"> <span class="string">SPAN</span>  <span class="string">MIN_LBA</span>  <span class="string">MAX_LBA</span>  <span class="string">CURRENT_TEST_STATUS</span></span><br><span class="line">    <span class="number">1</span>        <span class="number">0</span>        <span class="number">0</span>  <span class="string">Not_testing</span></span><br><span class="line">    <span class="number">2</span>        <span class="number">0</span>        <span class="number">0</span>  <span class="string">Not_testing</span></span><br><span class="line">    <span class="number">3</span>        <span class="number">0</span>        <span class="number">0</span>  <span class="string">Not_testing</span></span><br><span class="line">    <span class="number">4</span>        <span class="number">0</span>        <span class="number">0</span>  <span class="string">Not_testing</span></span><br><span class="line">    <span class="number">5</span>        <span class="number">0</span>        <span class="number">0</span>  <span class="string">Not_testing</span></span><br><span class="line"><span class="string">Selective</span> <span class="string">self-test</span> <span class="string">flags</span> <span class="string">(0x0):</span></span><br><span class="line">  <span class="string">After</span> <span class="string">scanning</span> <span class="string">selected</span> <span class="string">spans,</span> <span class="string">do</span> <span class="string">NOT</span> <span class="string">read-scan</span> <span class="string">remainder</span> <span class="string">of</span> <span class="string">disk.</span></span><br><span class="line"><span class="string">If</span> <span class="string">Selective</span> <span class="string">self-test</span> <span class="string">is</span> <span class="string">pending</span> <span class="string">on</span> <span class="string">power-up,</span> <span class="string">resume</span> <span class="string">after</span> <span class="number">0</span> <span class="string">minute</span> <span class="string">delay.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SCT Status Version:</span>                  <span class="number">3</span></span><br><span class="line"><span class="string">SCT</span> <span class="string">Version</span> <span class="string">(vendor</span> <span class="string">specific):</span>       <span class="number">256</span> <span class="string">(0x0100)</span></span><br><span class="line"><span class="attr">SCT Support Level:</span>                   <span class="number">0</span></span><br><span class="line"><span class="attr">Device State:</span>                        <span class="string">Active</span> <span class="string">(0)</span></span><br><span class="line"><span class="attr">Current Temperature:</span>                    <span class="number">29</span> <span class="string">Celsius</span></span><br><span class="line"><span class="attr">Power Cycle Min/Max Temperature:</span>     <span class="number">28</span><span class="string">/30</span> <span class="string">Celsius</span></span><br><span class="line"><span class="attr">Lifetime    Min/Max Temperature:</span>     <span class="number">24</span><span class="string">/32</span> <span class="string">Celsius</span></span><br><span class="line"><span class="attr">Under/Over Temperature Limit Count:</span>   <span class="number">0</span><span class="string">/0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SCT Temperature History Version:</span>     <span class="number">2</span></span><br><span class="line"><span class="attr">Temperature Sampling Period:</span>         <span class="number">1</span> <span class="string">minute</span></span><br><span class="line"><span class="attr">Temperature Logging Interval:</span>        <span class="number">1</span> <span class="string">minute</span></span><br><span class="line"><span class="attr">Min/Max recommended Temperature:</span>      <span class="number">0</span><span class="string">/60</span> <span class="string">Celsius</span></span><br><span class="line"><span class="attr">Min/Max Temperature Limit:</span>           <span class="number">-40</span><span class="string">/70</span> <span class="string">Celsius</span></span><br><span class="line"><span class="string">Temperature</span> <span class="string">History</span> <span class="string">Size</span> <span class="string">(Index):</span>    <span class="number">128</span> <span class="string">(92)</span></span><br><span class="line"><span class="string">Index</span>    <span class="string">Estimated</span> <span class="string">Time</span>   <span class="string">Temperature</span> <span class="string">Celsius</span></span><br><span class="line">  <span class="number">93</span>    <span class="number">2019-12-10 </span><span class="number">09</span><span class="string">:11</span>    <span class="number">29</span>  <span class="string">**********</span></span><br><span class="line"> <span class="string">...</span>    <span class="string">..(126</span> <span class="string">skipped).</span>    <span class="string">..</span>  <span class="string">**********</span></span><br><span class="line">  <span class="number">92</span>    <span class="number">2019-12-10 </span><span class="number">11</span><span class="string">:18</span>    <span class="number">29</span>  <span class="string">**********</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SCT Error Recovery Control:</span></span><br><span class="line">           <span class="attr">Read:</span>     <span class="number">80</span> <span class="string">(8.0</span> <span class="string">seconds)</span></span><br><span class="line">          <span class="attr">Write:</span>     <span class="number">80</span> <span class="string">(8.0</span> <span class="string">seconds)</span></span><br><span class="line"></span><br><span class="line"><span class="string">Device</span> <span class="string">Statistics</span> <span class="string">(GP/SMART</span> <span class="string">Log</span> <span class="number">0x04</span><span class="string">)</span> <span class="string">not</span> <span class="string">supported</span></span><br><span class="line"></span><br><span class="line"><span class="string">Pending</span> <span class="string">Defects</span> <span class="string">log</span> <span class="string">(GP</span> <span class="string">Log</span> <span class="number">0x0c</span><span class="string">)</span></span><br><span class="line"><span class="literal">No</span> <span class="string">Defects</span> <span class="string">Logged</span></span><br><span class="line"></span><br><span class="line"><span class="string">SATA</span> <span class="string">Phy</span> <span class="string">Event</span> <span class="string">Counters</span> <span class="string">(GP</span> <span class="string">Log</span> <span class="number">0x11</span><span class="string">)</span></span><br><span class="line"><span class="string">ID</span>      <span class="string">Size</span>     <span class="string">Value</span>  <span class="string">Description</span></span><br><span class="line"><span class="number">0x0001</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Command</span> <span class="string">failed</span> <span class="string">due</span> <span class="string">to</span> <span class="string">ICRC</span> <span class="string">error</span></span><br><span class="line"><span class="number">0x0002</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0003</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">device-to-host</span> <span class="string">data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0004</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">host-to-device</span> <span class="string">data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0005</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">non-data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0006</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">device-to-host</span> <span class="string">non-data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0007</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">R_ERR</span> <span class="string">response</span> <span class="string">for</span> <span class="string">host-to-device</span> <span class="string">non-data</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x0008</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Device-to-host</span> <span class="string">non-data</span> <span class="string">FIS</span> <span class="string">retries</span></span><br><span class="line"><span class="number">0x0009</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Transition</span> <span class="string">from</span> <span class="string">drive</span> <span class="string">PhyRdy</span> <span class="string">to</span> <span class="string">drive</span> <span class="string">PhyNRdy</span></span><br><span class="line"><span class="number">0x000a</span>  <span class="number">2</span>            <span class="number">1</span>  <span class="string">Device-to-host</span> <span class="string">register</span> <span class="string">FISes</span> <span class="string">sent</span> <span class="string">due</span> <span class="string">to</span> <span class="string">a</span> <span class="string">COMRESET</span></span><br><span class="line"><span class="number">0x000b</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">CRC</span> <span class="string">errors</span> <span class="string">within</span> <span class="string">host-to-device</span> <span class="string">FIS</span></span><br><span class="line"><span class="number">0x000d</span>  <span class="number">2</span>            <span class="number">0</span>  <span class="string">Non-CRC</span> <span class="string">errors</span> <span class="string">within</span> <span class="string">host-to-device</span> <span class="string">FIS</span></span><br></pre></td></tr></table></figure><h3 id="How-to-calculate-scsi-logging-level"><a href="#How-to-calculate-scsi-logging-level" class="headerlink" title="How to calculate scsi logging_level"></a>How to calculate scsi logging_level</h3><p><a href="https://en.opensuse.org/SDB:SCSI_debugging_hints">A useful setting of the logging level without being buried in logging details is ERROR=3, SCAN=3, MLQUEUE=2, MLCOMPLETE=2, which evaluates to echo 9411 &gt; /proc/sys/dev/scsi/logging_level</a></p><p>means 111(7) is the maximum value</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">scsi_logging_level -g</span><br><span class="line">Current scsi logging level:</span><br><span class="line">/proc/sys/dev/scsi/logging_level = <span class="number">9411</span> (<span class="number">10</span>,<span class="number">010</span>,<span class="number">011</span>,<span class="number">000</span>,<span class="number">011</span>)</span><br><span class="line">SCSI_LOG_ERROR=<span class="number">3</span></span><br><span class="line">SCSI_LOG_TIMEOUT=<span class="number">0</span></span><br><span class="line">SCSI_LOG_SCAN=<span class="number">3</span></span><br><span class="line">SCSI_LOG_MLQUEUE=<span class="number">2</span></span><br><span class="line">SCSI_LOG_MLCOMPLETE=<span class="number">2</span></span><br><span class="line">SCSI_LOG_LLQUEUE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_LLCOMPLETE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_HLQUEUE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_HLCOMPLETE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_IOCTL=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">$ scsi_logging_level -s --error <span class="number">3</span> --timeout <span class="number">3</span> --scan=<span class="number">3</span> --mlqueue=<span class="number">2</span> --mlcomplete=<span class="number">3</span> --all <span class="number">0</span></span><br><span class="line">New scsi logging level:</span><br><span class="line">/proc/sys/dev/scsi/logging_level = <span class="number">13531</span>(<span class="number">011</span>,<span class="number">010</span>,<span class="number">011</span>,<span class="number">011</span>,<span class="number">011</span>)</span><br><span class="line">SCSI_LOG_ERROR=<span class="number">3</span></span><br><span class="line">SCSI_LOG_TIMEOUT=<span class="number">3</span></span><br><span class="line">SCSI_LOG_SCAN=<span class="number">3</span></span><br><span class="line">SCSI_LOG_MLQUEUE=<span class="number">2</span></span><br><span class="line">SCSI_LOG_MLCOMPLETE=<span class="number">3</span></span><br><span class="line">SCSI_LOG_LLQUEUE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_LLCOMPLETE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_HLQUEUE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_HLCOMPLETE=<span class="number">0</span></span><br><span class="line">SCSI_LOG_IOCTL=<span class="number">0</span></span><br><span class="line">https:<span class="comment">//www.ibm.com/support/knowledgecenter/en/linuxonibm/com.ibm.linux.z.lgdd/lgdd_r_scsilog_cmd.html</span></span><br><span class="line"></span><br><span class="line">scsi debug</span><br><span class="line">scsi_logging_level syntax</span><br><span class="line">Read syntax diagramSkip visual syntax diagram</span><br><span class="line">                       .- ---------------------------.</span><br><span class="line">                       V                             |</span><br><span class="line">&gt;&gt;-scsi_logging_level----+-------------------------+-+--+- -s -+-&gt;&lt;</span><br><span class="line">                         +- -a-- &lt;level&gt;-----------+    +- -g -+</span><br><span class="line">                         +- -E-- &lt;level&gt;-----------+    <span class="string">&#x27;- -c -&#x27;</span></span><br><span class="line">                         +- -T-- &lt;level&gt;-----------+</span><br><span class="line">                         +- -S-- &lt;level&gt;-----------+</span><br><span class="line">                         +- -M-- &lt;level&gt;-----------+</span><br><span class="line">                         +- --mlqueue-- &lt;level&gt;----+</span><br><span class="line">                         +- --mlcomplete-- &lt;level&gt;-+</span><br><span class="line">                         +- -L-- &lt;level&gt;-----------+</span><br><span class="line">                         +- --llqueue-- &lt;level&gt;----+</span><br><span class="line">                         +- --llcomplete-- &lt;level&gt;-+</span><br><span class="line">                         +- -H-- &lt;level&gt;-----------+</span><br><span class="line">                         +- --hlqueue-- &lt;level&gt;----+</span><br><span class="line">                         +- --hlcomplete-- &lt;level&gt;-+</span><br><span class="line">                         <span class="string">&#x27;- -I-- &lt;level&gt;-----------&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Error Type</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drivers/scsi/scsi_logging.h</span><br></pre></td></tr></table></figure><p>ERROR<br>Used by any command which has to be retried/recovered via the SCSI error handling mechanism</p><p>TIMEOUT<br>Used by drivers/scsi/sg.c</p><p>SCAN<br>Used during device scan, ie whenever a new device HBA is initialized</p><p>MLQUEUE<br>Mid-layer queue; requests are being pulled from the block-layer queue and submitted to the HBA</p><p>MLCOMPLETE<br>Mid-layer queue; requests are being completed by the HBA and results are being pushed back to the block-layer</p><p>LLQUEUE<br>Low-layer queue; Not used<br>LLCOMPLETE<br>Low-layer queue; Not used</p><p>HLQUEUE<br>High-layer queue; command preparation in drivers/scsi/sd.c</p><p>HLCOMPLETE<br>High-layer queue; command completion in drivers/scsi/sd.c</p><p>IOCTL<br>SCSI IOCTL logging<br>The detailed error level description</p><p>ERROR<br>Error logging when a command is recovered via the SCSI error handling mechanism. The following levels are uses:<br>Error handler thread statistics<br>Error handler command statistics<br>Error handler command logging<br>Not used<br>Error handler command details<br>and higher: not used</p><p>SCAN<br>Logging during HBA / target scanning. The following levels are used:<br>Logging of unusual devices where LUN 0 has a pqual of 3<br>Logging of devices with pqual 3<br>Logging of SCSI commands sent during scanning<br>and higher: not used.</p><p>MLQUEUE<br>The MLQUEUE area is used when a command is being pulled from the block-layer queue and send to the HBA. It has the following levels:<br>nothing (match completion)<br>log opcode + command of all commands<br>same as 2 plus dump cmd address<br>same as 3 plus dump extra junk<br>and higher: not used</p><p>MLCOMPLETE<br>Logging of command completion from the HBA, before the completion is being called for the block-layer request. It has the following levels:<br>log disposition, result, opcode + command, and conditionally sense data for failures or non SUCCESS dispositions.<br>same as 1 but for all command completions.<br>same as 2 plus dump cmd address<br>same as 3 plus dump extra junk<br>and higher: not used</p><h3 id="smp-utils"><a href="#smp-utils" class="headerlink" title="smp_utils"></a>smp_utils</h3><p>not make sure</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ smp_rep_phy_sata <span class="attribute">--phy</span>=2 /dev/sdb</span><br><span class="line">$ smp_phy_control <span class="attribute">--phy</span>=2 <span class="attribute">--op</span>=tspss  /dev/sdb</span><br></pre></td></tr></table></figure><h3 id="T10-PI-practice"><a href="#T10-PI-practice" class="headerlink" title="T10 PI practice"></a><a href="https://www.snia.org/sites/default/files/SDCEMEA/2020/3%20-%20Mikhail%20Malygin%20Yadro%20-%20Using%20Linux%20block%20integrity.pdf">T10 PI practice</a></h3><p>mpt3sas driver set module parameter prot_mask=0x7F to enable DIX support</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">$ sg_vpd --page=ei --long /dev/sda |grep SPT <span class="comment"># Does the device support DIF</span></span><br><span class="line">$ sg_format --format --size 520  /dev/sdX <span class="comment"># HUS724030ALS640 support</span></span><br><span class="line"><span class="comment">#type 3</span></span><br><span class="line">$ sg_format -v --long --format --size=512 --fmtpinfo=3 --pfu=0 /dev/sdX <span class="comment">#  HUH721010AL5200 support ,4K or 512B could work</span></span><br><span class="line">$ sg_format --format --fmtpinfo=3 --pfu=1 /dev/sdX <span class="comment"># HUH721010AL5200 not support</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#type 1</span></span><br><span class="line">$ sg_format --format --size 4096 --fmtpinfo=2 -vvv /dev/sdX <span class="comment"># HUH721010AL5200 support</span></span><br><span class="line">open /dev/sdl with flags=0x802</span><br><span class="line">    inquiry cdb: 12 00 00 00 24 00</span><br><span class="line">    SEAGATE   ST800FM0043       0007   peripheral_type: disk [0x0]</span><br><span class="line">      PROTECT=1</span><br><span class="line">      &lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">    inquiry cdb: 12 01 00 00 24 00</span><br><span class="line">    inquiry: pass-through requested 36 bytes (data-in) but got 21 bytes</span><br><span class="line">    inquiry cdb: 12 01 80 01 00 00</span><br><span class="line">    inquiry: pass-through requested 256 bytes (data-in) but got 24 bytes</span><br><span class="line">      Unit serial number: Z3G01AQM0000Z3G01AQM</span><br><span class="line">    inquiry cdb: 12 01 83 01 00 00</span><br><span class="line">    inquiry: pass-through requested 256 bytes (data-in) but got 76 bytes</span><br><span class="line">      LU name: 5000c5003015b5b7</span><br><span class="line">    mode sense(10) cdb: 5a 00 01 00 00 00 00 00 <span class="built_in">fc</span> 00</span><br><span class="line">      duration=1 ms</span><br><span class="line">    mode sense(10): pass-through requested 252 bytes (data-in) but got 28 bytes</span><br><span class="line">    mode sense(10): response:</span><br><span class="line">00 1a 00 10 00 00 00 08  0b a4 d9 d6 00 00 10 00</span><br><span class="line">81 0a c0 01 5a 00 00 00  0b 00 ff ff</span><br><span class="line">Mode Sense (block descriptor) data, prior to changes:</span><br><span class="line">  Number of blocks=195353046 [0xba4d9d6]</span><br><span class="line">  Block size=4096 [0x1000]</span><br><span class="line"></span><br><span class="line">A FORMAT UNIT will commence <span class="keyword">in</span> 15 seconds</span><br><span class="line">    ALL data on /dev/sdl will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line"></span><br><span class="line">A FORMAT UNIT will commence <span class="keyword">in</span> 10 seconds</span><br><span class="line">    ALL data on /dev/sdl will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line"></span><br><span class="line">A FORMAT UNIT will commence <span class="keyword">in</span> 5 seconds</span><br><span class="line">    ALL data on /dev/sdl will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">    Format unit cdb: 04 98 00 00 00 00</span><br><span class="line">    Format unit parameter list:</span><br><span class="line">00 02 00 00</span><br><span class="line">    Format unit timeout: 20 seconds</span><br><span class="line">      duration=22 ms</span><br><span class="line"></span><br><span class="line">Format unit has started</span><br><span class="line">    <span class="built_in">test</span> unit ready cdb: 00 00 00 00 00 00</span><br><span class="line">FORMAT UNIT Complete</span><br><span class="line"></span><br><span class="line">still no integrity on block level:</span><br><span class="line">/sys/block/sda/integrity/device_is_integrity_capable -&gt; 0</span><br><span class="line">/sys/block/sda/integrity/tag_size -&gt; 0</span><br><span class="line"></span><br><span class="line">$ cat /sys/block/sdl/integrity/device_is_integrity_capable  /sys/block/sdl/integrity/tag_size</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Protection: prot_en=1, p_type=0, p_i_exponent=0 [type 1 protection]</span></span><br><span class="line">$ sg_readcap -v --long /dev/sdl</span><br><span class="line">    <span class="built_in">read</span> capacity(16) cdb: 9e 10 00 00 00 00 00 00 00 00 00 00 00 20 00 00</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=1, p_type=0, p_i_exponent=0 [<span class="built_in">type</span> 1 protection]</span><br><span class="line">   Logical block provisioning: lbpme=1, lbprz=1</span><br><span class="line">   Last LBA=195353045 (0xba4d9d5), Number of logical blocks=195353046</span><br><span class="line">   Logical block length=4096 bytes</span><br><span class="line">   Logical blocks per physical block exponent=0</span><br><span class="line">   Lowest aligned LBA=0</span><br><span class="line">Hence:</span><br><span class="line">   Device size: 800166076416 bytes, 763097.8 MiB, 800.17 GB</span><br><span class="line"></span><br><span class="line">$ cat /etc/modprobe.d/mpt3sas.conf</span><br><span class="line">options mpt3sas prot_mask=63</span><br><span class="line"></span><br><span class="line">$ reboot <span class="comment"># for reload prot_mask parameter</span></span><br><span class="line">$ sg_wr_mode -v -p 0a -c 00,00,00,00,00,80,00,00,00,00,00,00 -m 00,00,00,00,00,80,00,00,00,00,00,00 /dev/sdl</span><br><span class="line"></span><br><span class="line"><span class="comment"># in my test env, it is not work, I think the HBA/Expander firmware do not support it, driver and firmware must be support it</span></span><br><span class="line">$ cat /sys/block/sdl/integrity/device_is_integrity_capable </span><br><span class="line">1</span><br><span class="line">$ cat /sys/block/sdl/integrity/tag_size </span><br><span class="line">2</span><br><span class="line">$ cat /sys/block/sdl/integrity/format </span><br><span class="line">T10-DIF-TYPE1-CRC</span><br></pre></td></tr></table></figure><h5 id="About-dell-PERC-9"><a href="#About-dell-PERC-9" class="headerlink" title="About dell PERC 9"></a>About dell PERC 9</h5><p>In Dell document, T10 protection information is an end-to-end data integrity feature of the PERC 9 series.<br>Only dell certified PI disks are supported<br>Note: pi is not supported on SAS disks with 512-byte native and 512-byte emulated block size and SATA disks</p><p>Enabling T10 Pi<br>ctrl + R to access the BIOS configuration utility<br>     the virtual disk management<br>         selected controller<br>            Use the arrow keys to highlight the PERC 9 series of cards or disk group<br>                Note: The H330 PERC card does not support T10 PI feature<br>                   press F2, list of available actionsis displayed<br>                     Click Enable data protection</p><h4 id="nvme-pi"><a href="#nvme-pi" class="headerlink" title="nvme pi"></a>nvme pi</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">$ nvme id-ns -H /dev/nvme0n1</span><br><span class="line">NVME Identify Namespace 1:</span><br><span class="line">nsze    : 0x2baa5cd0</span><br><span class="line">ncap    : 0x2baa5cd0</span><br><span class="line">nuse    : 0x2baa5cd0</span><br><span class="line">nsfeat  : 0</span><br><span class="line">  [2:2] : 0Deallocated or Unwritten Logical Block error Not Supported</span><br><span class="line">  [1:1] : 0Namespace uses AWUN, AWUPF, and ACWU</span><br><span class="line">  [0:0] : 0Thin Provisioning Not Supported</span><br><span class="line"></span><br><span class="line">nlbaf   : 6</span><br><span class="line">flbas   : 0</span><br><span class="line">  [4:4] : 0Metadata Transferred <span class="keyword">in</span> Separate Contiguous Buffer</span><br><span class="line">  [3:0] : 0Current LBA Format Selected</span><br><span class="line"></span><br><span class="line">mc      : 0x1</span><br><span class="line">  [1:1] : 0Metadata Pointer Not Supported</span><br><span class="line">  [0:0] : 0x1Metadata as Part of Extended Data LBA Supported</span><br><span class="line"></span><br><span class="line">dpc     : 0x11</span><br><span class="line">  [4:4] : 0x1Protection Information Transferred as Last 8 Bytes of Metadata Supported</span><br><span class="line">  [3:3] : 0Protection Information Transferred as First 8 Bytes of Metadata Not Supported</span><br><span class="line">  [2:2] : 0Protection Information Type 3 Not Supported</span><br><span class="line">  [1:1] : 0Protection Information Type 2 Not Supported</span><br><span class="line">  [0:0] : 0x1Protection Information Type 1 Supported</span><br><span class="line"></span><br><span class="line">dps     : 0</span><br><span class="line">  [3:3] : 0Protection Information is Transferred as Last 8 Bytes of Metadata</span><br><span class="line">  [2:0] : 0Protection Information Disabled</span><br><span class="line"></span><br><span class="line">nmic    : 0</span><br><span class="line">  [0:0] : 0Namespace Multipath Not Capable</span><br><span class="line"></span><br><span class="line">rescap  : 0</span><br><span class="line">  [6:6] : 0Exclusive Access - All Registrants Not Supported</span><br><span class="line">  [5:5] : 0Write Exclusive - All Registrants Not Supported</span><br><span class="line">  [4:4] : 0Exclusive Access - Registrants Only Not Supported</span><br><span class="line">  [3:3] : 0Write Exclusive - Registrants Only Not Supported</span><br><span class="line">  [2:2] : 0Exclusive Access Not Supported</span><br><span class="line">  [1:1] : 0Write Exclusive Not Supported</span><br><span class="line">  [0:0] : 0Persist Through Power Loss Not Supported</span><br><span class="line"></span><br><span class="line">fpi     : 0</span><br><span class="line">  [7:7] : 0Format Progress Indicator Not Supported</span><br><span class="line"></span><br><span class="line">dlfeat  : 0</span><br><span class="line">  [4:4] : 0Guard Field of Deallocated Logical Blocks is <span class="built_in">set</span> to 0xFFFF</span><br><span class="line">  [3:3] : 0Deallocate Bit <span class="keyword">in</span> the Write Zeroes Command is Not Supported</span><br><span class="line">  [2:0] : 0Bytes Read From a Deallocated Logical Block and its Metadata are Not Reported</span><br><span class="line"></span><br><span class="line">nawun   : 0</span><br><span class="line">nawupf  : 0</span><br><span class="line">nacwu   : 0</span><br><span class="line">nabsn   : 0</span><br><span class="line">nabo    : 0</span><br><span class="line">nabspf  : 0</span><br><span class="line">noiob   : 0</span><br><span class="line">nvmcap  : 0</span><br><span class="line">nsattr: 0</span><br><span class="line">nvmsetid: 0</span><br><span class="line">anagrpid: 0</span><br><span class="line">endgid  : 0</span><br><span class="line">nguid   : 00000000000000000000000000000000</span><br><span class="line">eui64   : 5cd2e4e419330100</span><br><span class="line">LBA Format  0 : Metadata Size: 0   bytes - Data Size: 512 bytes - Relative Performance: 0x2 Good (<span class="keyword">in</span> use)</span><br><span class="line">LBA Format  1 : Metadata Size: 8   bytes - Data Size: 512 bytes - Relative Performance: 0x2 Good</span><br><span class="line">LBA Format  2 : Metadata Size: 16  bytes - Data Size: 512 bytes - Relative Performance: 0x2 Good</span><br><span class="line">LBA Format  3 : Metadata Size: 0   bytes - Data Size: 4096 bytes - Relative Performance: 0 Best</span><br><span class="line">LBA Format  4 : Metadata Size: 8   bytes - Data Size: 4096 bytes - Relative Performance: 0 Best</span><br><span class="line">LBA Format  5 : Metadata Size: 64  bytes - Data Size: 4096 bytes - Relative Performance: 0 Best</span><br><span class="line">LBA Format  6 : Metadata Size: 128 bytes - Data Size: 4096 bytes - Relative Performance: 0 Best</span><br><span class="line"></span><br><span class="line"><span class="comment">### you can see</span></span><br><span class="line">dps     : 0</span><br><span class="line">  [3:3] : 0     Protection Information is Transferred as Last 8 Bytes of Metadata</span><br><span class="line">  [2:0] : 0     Protection Information Disabled</span><br></pre></td></tr></table></figure><h3 id="SAS-smart"><a href="#SAS-smart" class="headerlink" title="SAS smart"></a><a href="https://superuser.com/questions/618736/how-do-i-interpret-smart-data-for-sas-disks">SAS smart</a></h3><p>Delayed errors are errors that slow down other requests. ECC corrected errors arent much of a worry on SCSI/SAS drives, we have drives deployed with hundreds of millions of them and they still run fine. Correction algorithm invocations is a bit more serious, those may require rereading/rewriting the disk, and retrying the ECC calculation.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0        0         0         0          6          0.565           0</span><br><span class="line">write:         0      400         0       400         51       1034.246           0</span><br><span class="line">verify:        0        0         0         0         37          0.000           0</span><br></pre></td></tr></table></figure><h3 id="sdparm"><a href="#sdparm" class="headerlink" title="sdparm"></a>sdparm</h3><h4 id="command"><a href="#command" class="headerlink" title="command"></a>command</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Flush the SAS dev buff</span></span><br><span class="line"><span class="comment"># sync: send a SYNCHRONIZE CACHE SCSI command to the device.</span></span><br><span class="line">$ sdparm --<span class="built_in">command</span>=sync /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#spindown the device</span></span><br><span class="line">$ sdparm --<span class="built_in">command</span>=stop /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#spinup the device</span></span><br><span class="line">$ sdparm --<span class="built_in">command</span>=start /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#sense: reports sense data (from a REQUEST SENSE SCSI command); can include power condition information, a progress indication for a time consuming command (e.g. format) or a report an informational exception (when MRIE=6)</span></span><br><span class="line">$ sdparm --<span class="built_in">command</span>=sense /dev/sdx</span><br><span class="line">    /dev/sdb: SEAGATE   ST10000NM0256     TT55</span><br><span class="line">Additional sense: Warning - enclosure degraded</span><br><span class="line"></span><br><span class="line"><span class="comment">#capacity: sends a READ CAPACITY and if successful reports the number of blocks, block length and capacity expressed in MibiBytes (1048576 bytes). Valid for disks and CD/DVD drives with the appropriate media loaded.</span></span><br><span class="line">$ sdparm --<span class="built_in">command</span>=capacity /dev/sdb</span><br><span class="line">    /dev/sdb: SEAGATE   ST10000NM0256     TT55</span><br><span class="line">blocks: 19134414848</span><br><span class="line">block_length: 512</span><br><span class="line">capacity_mib: 9342976.0</span><br><span class="line"></span><br><span class="line">    eject: stops the medium (<span class="keyword">if</span> it is spinning) and ejects it from the drive. Note that this may be prevented by software <span class="keyword">in</span> <span class="built_in">which</span> <span class="keyword">case</span> use the <span class="string">&#x27;unlock&#x27;</span> <span class="built_in">command</span> first.</span><br><span class="line"></span><br><span class="line">    load: loads the medium and <span class="keyword">then</span> spins it up</span><br><span class="line"></span><br><span class="line">    profile: lists the profiles (e.g. DVD+R and DVD-RAM) supported by a CD/DVD/HD_DVD/BD drive. If media is present <span class="keyword">in</span> the drive <span class="keyword">then</span> its corresponding profile has an asterisk (<span class="string">&quot;*&quot;</span>) to its right <span class="keyword">in</span> the list.</span><br><span class="line"></span><br><span class="line">    ready: reports whether the medium is ready <span class="keyword">for</span> IO. Ready usually means that it is present and spun up. If the device is not ready <span class="keyword">then</span> the <span class="built_in">exit</span> status will be 2 (see <span class="built_in">exit</span> status section below).</span><br><span class="line"></span><br><span class="line">    speed: takes and argument (e.g. --<span class="built_in">command</span>=speed=1350 or -C sp=1350 ) <span class="built_in">which</span> is <span class="keyword">in</span> kilobytes per second (1000 bytes per second units). Attempts to <span class="built_in">set</span> CD/DVD/BD media to given <span class="built_in">read</span> speed. If argument is zero <span class="keyword">then</span> <span class="built_in">set</span> drive back to its optimum setting. <span class="string">&quot;Times one&quot;</span> speeds are 177 kB/s <span class="keyword">for</span> CD, 1350  kB/s <span class="keyword">for</span> DVD and 4500 kB/s <span class="keyword">for</span> HD-DVD and BD.</span><br><span class="line"></span><br><span class="line">    unlock: instructs the device to allow medium removal (i.e. an eject). Beware, the OS may have had a good reason <span class="keyword">for</span> preventing removal of the medium (e.g. it contains a mounted file system). Use at your own risk.</span><br></pre></td></tr></table></figure><h4 id="enumerate"><a href="#enumerate" class="headerlink" title="enumerate"></a>enumerate</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">$ sdparm --enumerate /dev/sdb</span><br><span class="line">&lt;scsi_device&gt; as well as most options are ignored when <span class="string">&#x27;--enumerate&#x27;</span> is given</span><br><span class="line">Mode pages:</span><br><span class="line">  addp 0x0e,0x02  DT device primary port (ADC)</span><br><span class="line">  adlu 0x0e,0x03  logical unit (ADC)</span><br><span class="line">  adtd 0x0e,0x01  Targer device (ADC)</span><br><span class="line">  adts 0x0e,0x04  Targer device serial number (ADC)</span><br><span class="line">  apo  0x1a,0xf1  SAT ATA Power condition</span><br><span class="line">  atag 0x0a,0x02  Application tag (SBC)</span><br><span class="line">  bc   0x1c,0x01  Background control (SBC)</span><br><span class="line">  ca   0x08       Caching (SBC)</span><br><span class="line">  cms  0x2a       CD/DVD (MM) capabilities and mechanical status (MMC)</span><br><span class="line">  co   0x0a       Control</span><br><span class="line">  coe  0x0a,0x01  Control extension</span><br><span class="line">  cdp  0x0a,0xf0  Control data protection (SSC)</span><br><span class="line">  dac  0x0f       Data compression (SSC)</span><br><span class="line">  dc   0x10       Device configuration (SSC)</span><br><span class="line">  dca  0x1f       Device capabilities (SMC)</span><br><span class="line">  dce  0x10,0x01  Device configuration extension (SSC)</span><br><span class="line">  dr   0x02       Disconnect-reconnect (SPC + transports)</span><br><span class="line">  eaa  0x1d       Element address assignment (SMC)</span><br><span class="line">  edc  0x1f,0x41  Extended device capabilities (SMC)</span><br><span class="line">  esm  0x14       Enclosure services management (SES)</span><br><span class="line">  fo   0x03       Format (SBC)</span><br><span class="line">  ie   0x1c       Informational exceptions control</span><br><span class="line">  lbp  0x1c,0x02  Logical block provisioning (SBC)</span><br><span class="line">  mco  0x1d       Medium configuration (SSC)</span><br><span class="line">  mpa  0x11       Medium partition (SSC)</span><br><span class="line">  mrw  0x03       Mount rainier reWritable (MMC)</span><br><span class="line">  pat  0x0a,0xf1  SAT pATA control</span><br><span class="line">  pl   0x18       Protocol specific logical unit</span><br><span class="line">  po   0x1a       Power condition</span><br><span class="line">  ps   0x1a,0x01  Power consumption</span><br><span class="line">  poo  0x0d       Power condition - old version</span><br><span class="line">  pp   0x19       Protocol specific port</span><br><span class="line">  rbc  0x06       RBC device parameters (RBC)</span><br><span class="line">  rd   0x04       Rigid disk (SBC)</span><br><span class="line">  rw   0x01       Read write error recovery</span><br><span class="line">  tgp  0x1e       Transport geometry parameters (SMC)</span><br><span class="line">  tp   0x1d       Timeout and protect (MMC)</span><br><span class="line">  ve   0x07       Verify error recovery (SBC)</span><br><span class="line">  wp   0x05       Write parameters (MMC)</span><br><span class="line">  xo   0x10       XOR control (SBC)a</span><br><span class="line"></span><br><span class="line">$ sdparm --get WCE /dev/sdb</span><br><span class="line">    /dev/sdb: SEAGATE   ST10000NM0256     TT55</span><br><span class="line">WCE         0  [cha: y, def:  0, sav:  0]</span><br><span class="line"></span><br><span class="line">$ sdparm --enumerate --page=0x8 --long --long /dev/sda</span><br><span class="line">&lt;scsi_device&gt; as well as most options are ignored when <span class="string">&#x27;--enumerate&#x27;</span> is given</span><br><span class="line">Caching (SBC) [ca: 0x8] [SBC-3] mode page:</span><br><span class="line">  IC         [0x02:7:1 ]  Initiator control</span><br><span class="line">0: disk uses own adaptive caching algorithm</span><br><span class="line">1: disk caching algorithm controlled by NCS or CCS</span><br><span class="line">  ABPF       [0x02:6:1 ]  Abort pre-fetch</span><br><span class="line">  CAP        [0x02:5:1 ]  Caching analysis permitted</span><br><span class="line">  DISC       [0x02:4:1 ]  Discontinuity</span><br><span class="line">0: pre-fetch truncated or wrapped at time discontinuity</span><br><span class="line">1: pre-fetch continues across time discontinuity</span><br><span class="line">  SIZE       [0x02:3:1 ]  Size <span class="built_in">enable</span></span><br><span class="line">0: number of cache segments (NCS) controls cache segmentation</span><br><span class="line">1: the cache segment size (CCS) controls cache segmentation</span><br><span class="line">  WCE        [0x02:2:1 ]  Write cache <span class="built_in">enable</span></span><br><span class="line">  MF         [0x02:1:1 ]  Multiplication factor</span><br><span class="line">0: MIPF and MAPF specify blocks</span><br><span class="line">1: multiply MIPF and MAPF by blocks <span class="keyword">in</span> <span class="built_in">read</span> <span class="built_in">command</span></span><br><span class="line">  RCD        [0x02:0:1 ]  Read cache <span class="built_in">disable</span></span><br><span class="line">  DRRP       [0x03:7:4 ]  Demand <span class="built_in">read</span> retention priority</span><br><span class="line">0: treat requested and other data equally</span><br><span class="line">1: replace requested data before other data</span><br><span class="line">15: replace other data before requested data</span><br><span class="line">  WRP        [0x03:3:4 ]  Write retention priority</span><br><span class="line">0: treat requested and other data equally</span><br><span class="line">1: replace requested data before other data</span><br><span class="line">15: replace other data before requested data</span><br><span class="line">  DPTL       [0x04:7:16]  Disable pre-fetch transfer length</span><br><span class="line">  MIPF       [0x06:7:16]  Minimum pre-fetch</span><br><span class="line">  MAPF       [0x08:7:16]  Maximum pre-fetch</span><br><span class="line">  MAPFC      [0x0a:7:16]  Maximum pre-fetch ceiling</span><br><span class="line">  FSW        [0x0c:7:1 ]  Force sequential write</span><br><span class="line">  LBCSS      [0x0c:6:1 ]  Logical block cache segment size</span><br><span class="line">0: CSS unit is bytes; 1: CSS unit is blocks</span><br><span class="line">  DRA        [0x0c:5:1 ]  Disable <span class="built_in">read</span> ahead</span><br><span class="line">  SYNC_PROG  [0x0c:2:2 ]  Synchronous cache progress indication</span><br><span class="line">0: no pollable sense data during sync</span><br><span class="line">1: allow pollable sense data, allow all commands during sync</span><br><span class="line">2: allow pollable sense data, allow some commands during sync</span><br><span class="line">  NV_DIS     [0x0c:0:1 ]  Non-volatile cache <span class="built_in">disable</span></span><br><span class="line">  NCS        [0x0d:7:8 ]  Number of cache segments</span><br><span class="line">  CSS        [0x0e:7:16]  Cache segment size</span><br><span class="line"></span><br><span class="line">DRA (Disable READ-Ahead) bit</span><br><span class="line">0 When the DRA bit equals zero, the target may <span class="built_in">continue</span> to <span class="built_in">read</span> logical blocks into the buffer beyond the addressed</span><br><span class="line">logical block(s). means <span class="built_in">enable</span> read-ahead</span><br><span class="line"></span><br><span class="line">RCD </span><br><span class="line"></span><br><span class="line">FSW (FORCE SEQUENTIAL WRITE) bit</span><br><span class="line">0 When the FSW bit equals zero, the target is allowed to reorder the sequence of writing addressed logical blocks <span class="keyword">in</span></span><br><span class="line">order to achieve a faster <span class="built_in">command</span> completion.</span><br><span class="line"></span><br><span class="line">RCD (READ Cache Disable) bit</span><br><span class="line">0 SCSI READ commands may access the cache or the media.</span><br><span class="line"></span><br><span class="line">WCE (Write Cache Enable) bit</span><br><span class="line">1 SCSI WRITE commands may <span class="built_in">return</span> status and completion message bytes as soon as all data has been received</span><br><span class="line">from the host</span><br><span class="line"></span><br><span class="line">ABPF (ABORT PREFETCH) bit</span><br><span class="line">0 When <span class="built_in">set</span> to zero, with the DRA bit equal to zero, the termination of any active PREFETCH is dependent upon</span><br><span class="line">Caching Page bytes 4 through 11 and is operation and/or vendor-specific.</span><br><span class="line"></span><br><span class="line">DFUA (Disable Force Unit Access) bit</span><br><span class="line">1 When the Disable Force Unit Access (DFUA) bit is <span class="built_in">set</span> to 1, the drive ignores the FUA bit <span class="keyword">in</span> READ and WRITE com-</span><br><span class="line">mands. This can result <span class="keyword">in</span> better drive performance <span class="keyword">in</span> some circumstances.</span><br><span class="line">0 When the DFUA is <span class="built_in">set</span> to 0, the drive obeys the FUA setting <span class="keyword">in</span> READ and WRITE commands</span><br><span class="line"></span><br><span class="line">DPO (DISABLE PAGE OUT) bit</span><br><span class="line">If DPO = 1, the cache replacement algorithm should not replace existing cache data with the current data (<span class="keyword">if</span> possible). If a</span><br><span class="line">cache segment must be overwritten, it should be made the LRU.</span><br><span class="line">FUA (FORCE UNIT ACCESS) bit</span><br><span class="line">READ: If FUA = 1, the requested data must be <span class="built_in">read</span> from the media. If cache data <span class="built_in">which</span> overlaps the request has not yet been written to the media, it should be written before the <span class="built_in">read</span> is allowed to occur.</span><br><span class="line">WRITE: If FUA = 1, all data must be written to the media before the SCSI operation returns the status and completion message bytes( write through )</span><br><span class="line"></span><br><span class="line">$ sdparm -g WCE -H  /dev/sdb</span><br><span class="line">0x00 0x01 0x00 0x00 </span><br><span class="line"></span><br><span class="line"><span class="comment"># set it to default</span></span><br><span class="line">$ sdparm --page=ca --defaults --save /dev/sdd</span><br><span class="line"></span><br><span class="line"><span class="comment"># the same</span></span><br><span class="line">$ sdparm --<span class="built_in">set</span>=WCE --clear=RCD --save /dev/sdd</span><br><span class="line">$ sdparm -s WCE=1,RCD=0 -S /dev/sdd</span><br><span class="line"></span><br><span class="line"><span class="comment"># set page value, not make sure</span></span><br><span class="line">$ sdparm --page=0 --hex /dev/sdd</span><br><span class="line">$ sdparm --page=0 --<span class="built_in">set</span>=2:7:1=1 --save /dev/sdd</span><br></pre></td></tr></table></figure><h3 id="sdparm-with-hdparm"><a href="#sdparm-with-hdparm" class="headerlink" title="sdparm with hdparm"></a><a href="sg.danny.cz/sg/sdparm.html">sdparm with hdparm</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disable read-ahead</span></span><br><span class="line">$ sdparm --<span class="built_in">set</span> DRA=1 /dev/sdx</span><br><span class="line">$ hdparm -A0 /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable read-ahead</span></span><br><span class="line">$ sdparm --<span class="built_in">set</span> DRA=0 /dev/sdx</span><br><span class="line">$ hdparm -A1 /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment">#fetch the current device power state</span></span><br><span class="line">$ sdparm --comand=ready or --<span class="built_in">command</span>=sense /dev/sdx</span><br><span class="line">$ hdparm -C /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment">#sync</span></span><br><span class="line">$ sdparm --commnad=sync /dev/sdx</span><br><span class="line">$ hdparm -f /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># INQUIRY response plus the &quot;device identification&quot; VPD page</span></span><br><span class="line">$ sdparm --inquiry /dev/sdx</span><br><span class="line">$ hdparm -I /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># save</span></span><br><span class="line">$ sdparm --save /dev/sdx</span><br><span class="line">$ hdparm -K1 /dev/sdx</span><br></pre></td></tr></table></figure><h3 id="SAS-2-Support-multiple-STP-affiliations"><a href="#SAS-2-Support-multiple-STP-affiliations" class="headerlink" title="SAS-2 Support multiple STP affiliations"></a><a href="https://www.t10.org/ftp/t10/document.06/06-188r3.pdf">SAS-2 Support multiple STP affiliations</a></h3><p>The LSI SAS Expander has implemented this feature.<br>If the two server connectting with the single IO expander, the SATA device could read and write in two server and the same time.<br>And the SATA device could be brain split too.</p><h3 id="disable-background-scans"><a href="#disable-background-scans" class="headerlink" title="disable background scans"></a><a href="https://www.reddit.com/r/DataHoarder/comments/e677p1/psa_if_you_have_sas_drives_check_the_background/">disable background scans</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disable</span></span><br><span class="line">$ sdparm /dev/sdj -p bc -s EN_BMS=0</span><br><span class="line">Background scan results <span class="built_in">log</span></span><br><span class="line">  Status: no scans active</span><br><span class="line"></span><br><span class="line">$ sdparm /dev/sdj -p bc</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">Background control (SBC) mode page:</span><br><span class="line">  S_L_FULL      0  [cha: y, def:  0, sav:  0]</span><br><span class="line">  LOWIR         0  [cha: y, def:  0, sav:  0]</span><br><span class="line">  EN_BMS        0  [cha: y, def:  1, sav:  1]</span><br><span class="line">  EN_PS         0  [cha: y, def:  0, sav:  0]</span><br><span class="line">  BMS_I         168  [cha: y, def:168, sav:168]</span><br><span class="line">  BPS_TL        0  [cha: y, def:  0, sav:  0]</span><br><span class="line">  MIN_IDLE      250  [cha: y, def:250, sav:250]</span><br><span class="line">  MAX_SUSP      0  [cha: y, def:  0, sav:  0]</span><br><span class="line"></span><br><span class="line">$ smartctl -x /dev/sdj</span><br><span class="line"></span><br><span class="line">Background scan results <span class="built_in">log</span></span><br><span class="line">  Status: waiting until BMS interval timer expires</span><br><span class="line">    Accumulated power on time, hours:minutes 13155:51 [789351 minutes]</span><br><span class="line">    Number of background scans performed: 73,  scan progress: 0.00%</span><br><span class="line">    Number of background medium scans performed: 73</span><br><span class="line"></span><br><span class="line">$ sdparm --clear=EN_BMS --save /dev/sdj</span><br><span class="line">change_mode_page: failed setting page: Background control (SBC)</span><br><span class="line"></span><br><span class="line">$ sdparm /dev/sdj -p bc -s EN_BMS=1</span><br><span class="line">Background scan results <span class="built_in">log</span></span><br><span class="line">  Status: waiting until BMS interval timer expires</span><br><span class="line">    Accumulated power on time, hours:minutes 13165:02 [789902 minutes]</span><br><span class="line">    Number of background scans performed: 73,  scan progress: 0.00%</span><br><span class="line">    Number of background medium scans performed: 73</span><br><span class="line"></span><br><span class="line"><span class="comment">#number of hours between media scans - here, run a scan every 24 hours</span></span><br><span class="line">$ sdparm /dev/sdb -p bc -s BMS_I=24</span><br><span class="line"></span><br><span class="line"><span class="comment"># how many milliseconds the drive must be idle before a scan can begin</span></span><br><span class="line"><span class="comment"># here, the drive must be idle for two second at time of scan start, </span></span><br><span class="line"><span class="comment">#     or else the scan will wait until the drive is idle for 2000ms.</span></span><br><span class="line"><span class="comment"># the same applies if scan is interrupted for user activity - scan resumes when</span></span><br><span class="line"><span class="comment">#     this period of time has elapsed with no activity.</span></span><br><span class="line">$ sdparm /dev/sdb -p bc -s MIN_IDLE=2000</span><br><span class="line"></span><br><span class="line"><span class="comment"># how many milliseconds the drive is permitted to take to return to regular service</span></span><br><span class="line"><span class="comment">#     if a command is received during a background media scan - here, the drive must</span></span><br><span class="line"><span class="comment">#     stop the BMS within 500ms of receiving a read/write command from the host</span></span><br><span class="line">$ sdparm /dev/sdb -p bc -s MAX_SUSP=500</span><br><span class="line"></span><br><span class="line"><span class="comment"># perform a background media scan (pre-scan) at the next disk power-on regardless of the timer</span></span><br><span class="line"><span class="comment"># this option is reset to 0 after disk power-up - it is only applied to the next disk power-up</span></span><br><span class="line">$ sdparm /dev/sdb -p bc -s EN_PS=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># how long the background pre-scan is permitted to take after disk power on, in hours.</span></span><br><span class="line"><span class="comment"># if this many hours elapses and the pre-scan isn&#x27;t finished, the pre-scan is aborted.</span></span><br><span class="line"><span class="comment"># here, cancel scan if not done in 6 hours</span></span><br><span class="line">$ sdparm /dev/sdb -p bc -s BPS_TL=6</span><br><span class="line"></span><br><span class="line"><span class="comment"># if this is set to 1, only log events in the scan log that might require user intervention,</span></span><br><span class="line"><span class="comment">#     such as unrecoverable sectors. if 0, log any sectors the scan detects, even those that</span></span><br><span class="line"><span class="comment">#     the drive is able to fix on its own</span></span><br><span class="line">$ sdparm /dev/sdb -p bc -s LOWIR=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># if set to 1, STOP running scans when the drive&#x27;s internal log fills up</span></span><br><span class="line">$ sdparm /dev/sdb -p bc -s S_L_FULL=0</span><br></pre></td></tr></table></figure><p>Since the background scan functions are only done during idle periods, BMS causes a negligible impact to system performance. The firstBMS scan for a newly manufactured drive is performed as quickly as possible to verify the media and protect data by setting the Start timeafter idle to 5ms, all subsequent scans begin after 500ms of idle time. Other features that normally use idle time to function will functionnormally because BMS functions for bursts of 800ms and then suspends activity for 100ms to allow other background functions to operate</p><p>BMS interrupts immediately to service host commands from the interface bus while performing reads. BMS will complete any BMS-initiatederror recovery prior to returning to service host-initiated commands. Overhead associated with a return to host-servicing activity from BMSonly impacts the first command that interrupted BMS, this results in a typical delay of about 1 ms</p><p>Media Pre-Scan is a feature that allows the drive to repair media errors that would otherwise have been found by the host system duringcritical data accesses early in the drives life. The default setting for Media Pre-Scan is enabled on standard products. Media Pre-Scanchecks each write command to determine if the destination LBAs have been scanned by BMS. If the LBAs have been verified, the driveproceeds with the normal write command. If the LBAs have not been verified by BMS, Pre-Scan will convert the write to a write verify tocertify that the data was properly written to the disk</p><h3 id="Power-status"><a href="#Power-status" class="headerlink" title="Power status"></a>Power status</h3><p>Idle_A</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Disks rotating at full speed (7200 RPM)</li></ul><p>Idle_B</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Heads are unloaded to drive ramp.</li><li>Disks rotating at full speed (7200 RPM)</li></ul><p>Idle_C/Standby_Y (SAS Only)</p><ul><li>Disables most of the servo system, reduces processor and channel power consumption</li><li>Heads are unloaded to drive ramp.</li><li>Drive speed reduced to a lower RPM (reduced RPM)</li></ul><p>Standby_Z</p><ul><li>Heads are unloaded to drive ramp.</li><li>Drive motor is spun down.</li><li>Drive still responds to non-media access host commands</li></ul><p>0 is disable, 1 is enable the function</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ sdparm -p po /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">Power condition mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]</span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]</span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]</span><br><span class="line">  IDLE          1  [cha: y, def:  1, sav:  1]</span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]</span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ sdparm --flexible -6 -p po -l /dev/sdj</span><br><span class="line">    /dev/sdj: HGST      HUH721010AL5200   LS14</span><br><span class="line">    Direct access device specific parameters: WP=0  DPOFUA=1</span><br><span class="line">Power condition [po] mode page:</span><br><span class="line">  PM_BG         0  [cha: n, def:  0, sav:  0]  Power management, background <span class="built_in">functions</span>, precedence</span><br><span class="line">  STANDBY_Y     0  [cha: n, def:  0, sav:  0]  Standby_y timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_C        0  [cha: y, def:  0, sav:  0]  Idle_c timer <span class="built_in">enable</span></span><br><span class="line">  IDLE_B        1  [cha: y, def:  1, sav:  1]  Idle_b timer <span class="built_in">enable</span></span><br><span class="line">  IDLE          1  [cha: y, def:  1, sav:  1]  Idle_a timer <span class="built_in">enable</span></span><br><span class="line">  STANDBY       0  [cha: y, def:  0, sav:  0]  Standby_z timer <span class="built_in">enable</span></span><br><span class="line">  ICT           20  [cha: n, def: 20, sav: 20]  Idle_a condition timer (100 ms)</span><br><span class="line">  SCT           0  [cha: y, def:  0, sav:  0]  Standby_z condition timer (100 ms)</span><br><span class="line">  IBCT          6000  [cha: n, def:6000, sav:6000]  Idle_b condition timer (100 ms)</span><br><span class="line">  ICCT          9000  [cha: n, def:9000, sav:9000]  Idle_c condition timer (100 ms)</span><br><span class="line">  SYCT          0  [cha: n, def:  0, sav:  0]  Standby_y condition timer (100 ms)</span><br><span class="line">  CCF_IDLE      1  [cha: y, def:  1, sav:  1]  check condition on transition from idle</span><br><span class="line">  CCF_STAND     2  [cha: y, def:  2, sav:  2]  check condition on transition from standby</span><br><span class="line">  CCF_STOPP     2  [cha: y, def:  2, sav:  2]  check condition on transition from stopped</span><br></pre></td></tr></table></figure><h4 id="Disable-SATA-power-save"><a href="#Disable-SATA-power-save" class="headerlink" title="Disable SATA power save"></a><a href="https://wiki.archlinux.org/index.php/Hdparm">Disable SATA power save</a></h4><p>-B Set the Advanced Power Management feature. Possible values are between 1 and 255, low values mean more aggressive power management and higher values mean better performance. Values from 1 to 127 permit spin-down, whereas values from 128 to 254 do not. A value of 255 completely disables the feature.</p><p>-S Set the standby (spindown) timeout for the drive. The timeout specifies how long to wait in idle (with no disk activity) before turning off the motor to save power. The value of 0 disables spindown, the values from 1 to 240 specify multiples of 5 seconds and values from 241 to 251 specify multiples of 30 minutes.</p><p>-M Set the Automatic Acoustic Management feature. Most modern hard disk drives have the ability to speed down the head movements to reduce their noise output. The possible value depends on the disk, some disks may not support this feature.</p><p>-J Get/set  the  Western  Digital (WD) Green Drives idle3 timeout value.  This timeout controls how often the drive parks its heads and enters a low power consumption state.  The factory default is eight (8) seconds, which is a very  poor  choice  for use  with  Linux.   Leaving it at the default will result in hundreds of thousands of head load/unload cycles in a very short period of time.  The drive mechanism is only rated for 300,000 to 1,000,000 cycles, so leaving it at the default could result in premature failure, not to mention the performance impact of the drive often having to wake-up before doing routine I/O.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$  hdparm -I /dev/sda | grep level</span><br><span class="line">Advanced power management level: 128</span><br><span class="line">$  hdparm -B 255 /dev/sda</span><br><span class="line"></span><br><span class="line">/dev/sda:</span><br><span class="line"> setting Advanced Power Management level to disabled</span><br><span class="line"> APM_level= off</span><br><span class="line"></span><br><span class="line">$ hdparm -I /dev/sdl | grep level</span><br><span class="line">Advanced power management level: disabled</span><br><span class="line"></span><br><span class="line">$ hdparm -S 245 /dev/sdl</span><br><span class="line"></span><br><span class="line">/dev/sdl:</span><br><span class="line"> setting standby to 245 (2 hours + 30 minutes)</span><br><span class="line"></span><br><span class="line">$ hdparm -S 0 /dev/sdl</span><br><span class="line"></span><br><span class="line">/dev/sdl:</span><br><span class="line"> setting standby to 0 (off)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get/set  the  Western  Digital (WD) Green Drive&#x27;s &quot;idle3&quot; timeout value</span></span><br><span class="line">$ hdparm -J /dev/sda</span><br><span class="line"></span><br><span class="line">/dev/sda:</span><br><span class="line">wdidle3_vsc_enable_disable: Input/output error</span><br><span class="line"></span><br><span class="line">$ hdparm -J 30 --please-destroy-my-drive /dev/sda</span><br><span class="line"></span><br><span class="line">$ hdparm -M /dev/sda</span><br><span class="line"></span><br><span class="line">/dev/sda:</span><br><span class="line"> acoustic      = not supported</span><br></pre></td></tr></table></figure><h3 id="upgrade-LSI-firmware"><a href="#upgrade-LSI-firmware" class="headerlink" title="upgrade LSI firmware"></a>upgrade LSI firmware</h3><p>HBA reset no impact the zfs service</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ sas2flash.efi -o -e 7</span><br><span class="line">$ sas2flash.efi -f 2308T207.ROM -c 1</span><br><span class="line">$ sas2flash.efi -b mptsas2.rom -c 1</span><br><span class="line">$ sas2flash.efi -b x64sas2.rom -c 1</span><br><span class="line">$ sas2flash.efi -o -sasaddhi XXXXXXX -c 1</span><br><span class="line"></span><br><span class="line">$ sas3flash -c 3 -f 2308T207.ROM -b mpt3x64.rom -b x64sas3.rom -noreset</span><br><span class="line"></span><br><span class="line">[Mon Apr 27 19:49:53 2020] mpt2sas_cm0: sending diag reset !!</span><br><span class="line">[Mon Apr 27 19:49:54 2020] mpt2sas_cm0: diag reset: SUCCESS</span><br><span class="line">[Mon Apr 27 19:49:54 2020] mpt2sas_cm0: CurrentHostPageSize is 0: Setting default host page size to 4k</span><br><span class="line">[Mon Apr 27 19:49:54 2020] mpt2sas_cm0: LSISAS2308: FWVersion(19.00.00.00), ChipRevision(0x05), BiosVersion(07.37.00.00)</span><br><span class="line">[Mon Apr 27 19:49:54 2020] mpt2sas_cm0: Protocol=(Initiator,Target), Capabilities=(TLR,EEDP,Snapshot Buffer,Diag Trace Buffer,Task Set Full,NCQ)</span><br><span class="line">[Mon Apr 27 19:49:54 2020] mpt2sas_cm0: sending port <span class="built_in">enable</span> !!</span><br><span class="line">[Mon Apr 27 19:50:01 2020] mpt2sas_cm0: port <span class="built_in">enable</span>: SUCCESS</span><br><span class="line">[Mon Apr 27 19:50:01 2020] mpt2sas_cm0: search <span class="keyword">for</span> end-devices: start</span><br><span class="line">[Mon Apr 27 19:50:01 2020] scsi target0:0:0: handle(0x000a), sas_addr(0x5000c5008375be35)</span><br><span class="line">[Mon Apr 27 19:50:01 2020] scsi target0:0:0: enclosure logical id(0x5003048000d412bf), slot(0)</span><br><span class="line">[Mon Apr 27 19:50:01 2020] scsi target0:0:1: handle(0x000b), sas_addr(0x5000c50083753969)</span><br><span class="line">[Mon Apr 27 19:50:01 2020] scsi target0:0:1: enclosure logical id(0x5003048000d412bf), slot(1)</span><br><span class="line">[Mon Apr 27 19:50:01 2020] scsi target0:0:2: handle(0x000c), sas_addr(0x5000c50083758d41)</span><br><span class="line">[Mon Apr 27 19:50:01 2020] scsi target0:0:2: enclosure logical id(0x5003048000d412bf), slot(2)</span><br><span class="line">[Mon Apr 27 19:50:01 2020] scsi target0:0:3: handle(0x000d), sas_addr(0x5000c500837593a1)</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h3 id="SAS-Link-layer-2-has-the-flow-control"><a href="#SAS-Link-layer-2-has-the-flow-control" class="headerlink" title="SAS Link layer 2 has the flow control"></a>SAS Link layer 2 has the flow control</h3><p>Inside an SSP connection</p><ul><li>Phys exchange SSP frames<ul><li>SSP frame = SOF primitive, data dwords, EOF primitive</li><li>Each frame results in an ACK or NAK primitive</li></ul></li><li>Credit-based flow control<ul><li>Permission to send a frame must be granted with RRDY primitives</li></ul></li><li>Full duplex<ul><li>SSP frames can be sent in both directions simultaneously</li><li>Independent credit for each direction</li></ul></li><li>ACK, NAK, and RRDY primitives may be interjected among frame dwords<br>   (so can ALIGNs and NOTIFYs)</li></ul><p>My question:<br>If some of performance differents in SAS switch port, the flow control will cause the performance different in your SAS device ?<br>Some high loading in your vibration HDD devices, Does the vibration cause the region of resonate in your JBOD ? the region will impact the device performance ?<br>If the sas switch has the performance issue cause these sas port performance not balancing ?</p>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> scsi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>memory</title>
      <link href="2018/07/02/mem/"/>
      <url>2018/07/02/mem/</url>
      
        <content type="html"><![CDATA[<h3 id="Make-sure-the-ECC-work-in-Linux"><a href="#Make-sure-the-ECC-work-in-Linux" class="headerlink" title="Make sure the ECC work in Linux"></a>Make sure the ECC work in Linux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmidecode -t memory  | grep -Ei <span class="string">&#x27;error correction type&#x27;</span></span><br><span class="line">Error Correction Type: Single-bit ECC</span><br><span class="line">$ dmidecode -t memory  | grep -Ei <span class="string">&#x27;error correction type&#x27;</span></span><br><span class="line">Error Correction Type: Multi-bit ECC</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Monitor-ECC-error"><a href="#Monitor-ECC-error" class="headerlink" title="Monitor ECC error"></a>Monitor ECC error</h3><h4 id="From-OS"><a href="#From-OS" class="headerlink" title="From OS"></a>From OS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Intel x86 scalable</span></span><br><span class="line">skx_edac</span><br><span class="line"></span><br><span class="line"><span class="comment">#Intel x86 E3</span></span><br><span class="line">ie31200-edac</span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers are loaded. 1 MC detected:</span><br><span class="line">  mc0:IE31200</span><br><span class="line"></span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers loaded. No memory controllers found</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ edac-util -v</span><br><span class="line">mc0: 0 Uncorrected Errors with no DIMM info</span><br><span class="line">mc0: 0 Corrected Errors with no DIMM info</span><br><span class="line">mc0: csrow0: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow0: mc<span class="comment">#0csrow#0channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow0: mc<span class="comment">#0csrow#0channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow1: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow1: mc<span class="comment">#0csrow#1channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow1: mc<span class="comment">#0csrow#1channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow2: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow2: mc<span class="comment">#0csrow#2channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow2: mc<span class="comment">#0csrow#2channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow3: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow3: mc<span class="comment">#0csrow#3channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow3: mc<span class="comment">#0csrow#3channel#1: 0 Corrected Errors</span></span><br><span class="line">edac-util: No errors to report.</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 7.7 not support Xeon E2000, the kernel merge the patch at 2019-06, maybe wait CentOS 7.8</span></span><br><span class="line"><span class="comment">#Intel x86 E2000</span></span><br><span class="line">ie31200-edac</span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers loaded. No memory controllers found</span><br></pre></td></tr></table></figure><h4 id="From-IPMI"><a href="#From-IPMI" class="headerlink" title="From IPMI"></a>From IPMI</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool sel elist</span><br></pre></td></tr></table></figure><h3 id="NIC-page-allocation-failure"><a href="#NIC-page-allocation-failure" class="headerlink" title="NIC page allocation failure"></a><a href="https://access.redhat.com/solutions/641323">NIC page allocation failure</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">[Mon Jul  2 10:38:25 2018] swapper/16: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Mon Jul  2 10:38:25 2018] CPU: 16 PID: 0 Comm: swapper/16 Tainted: P           OE  ------------   3.10.0-693.5.2.el7_lustre.x86_64 <span class="comment">#1</span></span><br><span class="line">[Mon Jul  2 10:38:25 2018] Hardware name: Dell Inc. PowerEdge R730/072T6D, BIOS 2.4.3 01/17/2017</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  0000000000104020 7e870b98ec876be5 ffff88103e8039d8 ffffffff816a3e2d</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  ffff88103e803a68 ffffffff81188820 0000000000000246 ffff88103e803a28</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  fffffffffffffffc 0010402000000000 ffff88107ffdb018 7e870b98ec876be5</span><br><span class="line">[Mon Jul  2 10:38:25 2018] Call Trace:</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  &lt;IRQ&gt;  [&lt;ffffffff816a3e2d&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81188820&gt;] warn_alloc_failed+0x110/0x180</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8169fe2a&gt;] __alloc_pages_slowpath+0x6b6/0x724</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8118cdb5&gt;] __alloc_pages_nodemask+0x405/0x420</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffffc031abba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffffc031ba97&gt;] bnx2x_rx_int+0x227/0x17c0 [bnx2x]</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81573004&gt;] ? consume_skb+0x34/0x80</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81585dad&gt;] ? __dev_kfree_skb_any+0x3d/0x50</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffffc031eecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  &lt;EOI&gt;  [&lt;ffffffff816ab546&gt;] ? native_safe_halt+0x6/0x10</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff816ab3de&gt;] default_idle+0x1e/0xc0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81035006&gt;] arch_cpu_idle+0x26/0x30</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Mon Jul  2 10:38:25 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line"></span><br><span class="line"><span class="comment"># in my case </span></span><br><span class="line">[Thu Jul 12 04:23:16 2018]  00000000ad5e4ed1</span><br><span class="line">[Thu Jul 12 04:23:16 2018] Call Trace:</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  ffff88103e643a20 ffffffff81188820</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;IRQ&gt;</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  00000000000000c3</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816a3e2d&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  0000000000000282</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81188820&gt;] warn_alloc_failed+0x110/0x180</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  fffffffffffffffc 0010402000000000</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  ffff8816385ea000 66b8573252d2c8c3</span><br><span class="line">[Thu Jul 12 04:23:16 2018] Call Trace:</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;IRQ&gt;  [&lt;ffffffff816a3e2d&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8169fe2a&gt;] __alloc_pages_slowpath+0x6b6/0x724</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81188820&gt;] warn_alloc_failed+0x110/0x180</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8169fe2a&gt;] __alloc_pages_slowpath+0x6b6/0x724</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118cdb5&gt;] __alloc_pages_nodemask+0x405/0x420</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] ? __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118cdb5&gt;] __alloc_pages_nodemask+0x405/0x420</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810d1c02&gt;] ? load_balance+0x192/0x9a0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810d1bd2&gt;] ? load_balance+0x162/0x9a0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81573004&gt;] ? consume_skb+0x34/0x80</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81585dad&gt;] ? __dev_kfree_skb_any+0x3d/0x50</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f95c2&gt;] ? bnx2x_free_tx_pkt+0x1f2/0x2d0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f0062&gt;] ? bnx2x_test_link+0x42/0x270 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811d1078&gt;] alloc_pages_current+0x98/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8118761e&gt;] __get_free_pages+0xe/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811dca2e&gt;] kmalloc_order_trace+0x2e/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] ? __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811e05c1&gt;] __kmalloc+0x211/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f8bba&gt;] bnx2x_frag_alloc.isra.61+0x2a/0x40 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527d42&gt;] ? cpuidle_enter_state+0x52/0xc0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527e88&gt;] cpuidle_idle_call+0xd8/0x210</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81034fee&gt;] arch_cpu_idle+0xe/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02f9124&gt;] bnx2x_alloc_rx_data.isra.69+0x54/0x1c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fa0b6&gt;] bnx2x_rx_int+0x846/0x17c0 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810d1c02&gt;] ? load_balance+0x192/0x9a0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527d42&gt;] ? cpuidle_enter_state+0x52/0xc0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527e88&gt;] cpuidle_idle_call+0xd8/0x210</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;  [&lt;ffffffff81527d42&gt;] ? cpuidle_enter_state+0x52/0xc0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81527e88&gt;] cpuidle_idle_call+0xd8/0x210</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81034fee&gt;] arch_cpu_idle+0xe/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81034fee&gt;] arch_cpu_idle+0xe/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffffc02fcecd&gt;] bnx2x_poll+0x1dd/0x260 [bnx2x]</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8158799d&gt;] net_rx_action+0x16d/0x380</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090b4f&gt;] __do_softirq+0xef/0x280</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810e7bda&gt;] cpu_startup_entry+0x14a/0x1c0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81051af6&gt;] start_secondary+0x1b6/0x230</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b6b1c&gt;] call_softirq+0x1c/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff8102d3c5&gt;] do_softirq+0x65/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81090ed5&gt;] irq_exit+0x105/0x110</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b76b6&gt;] do_IRQ+0x56/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816ac2ad&gt;] common_interrupt+0x6d/0x6d</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  &lt;EOI&gt;  [&lt;ffffffff811a3178&gt;] ? fragmentation_index+0x38/0xa0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811a877b&gt;] compaction_suitable+0x5b/0xb0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81199102&gt;] balance_pgdat+0x502/0x5e0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff81199353&gt;] kswapd+0x173/0x440</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b1920&gt;] ? wake_up_atomic_t+0x30/0x30</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff811991e0&gt;] ? balance_pgdat+0x5e0/0x5e0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b099f&gt;] kthread+0xcf/0xe0</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b08d0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff816b4fd8&gt;] ret_from_fork+0x58/0x90</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  [&lt;ffffffff810b08d0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Thu Jul 12 04:23:16 2018] swapper/32: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Thu Jul 12 04:23:16 2018] CPU: 32 PID: 0 Comm: swapper/32 Tainted: P           OE  ------------   3.10.0-693.5.2.el7_lustre.x86_64 <span class="comment">#1</span></span><br><span class="line">[Thu Jul 12 04:23:16 2018] Hardware name: Dell Inc. PowerEdge R730/072T6D, BIOS 2.4.3 01/17/2017</span><br><span class="line">[Thu Jul 12 04:23:16 2018]  0000000000104020 1fc54c56797ed550 ffff88103ea03990 ffffffff816a3e2d</span><br><span class="line">[Thu Jul 12 04:23:16 2018] swapper/12: page allocation failure: order:2, mode:0x104020</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can see a lot of processes could not allocation memory</span></span><br><span class="line">[Fri Aug 16 06:08:22 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] swapper/10: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 06:43:21 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:53:18 2019] swapper/22: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 07:58:18 2019] java: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] kswapd0: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] systemd-journal: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/16: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/16: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/4: page allocation failure: order:2, mode:0x104020</span><br><span class="line">[Fri Aug 16 09:08:22 2019] swapper/4: page allocation failure: order:2, mode:0x104020</span><br></pre></td></tr></table></figure><p>zone_reclaim_mode<br>sysctl -w vm.zone_reclaim_mode=1<br>#This can be set to 1 to attempt reclamation of memory within a NUMA node before reclaiming from other NUMA nodes.</p><p><code>min_free_kbytes</code> (it s worked, the page allocation failure was missing)<br>sysctl -w vm.min_free_kbytes = 540672<br>#Increase the virtual memory kernel tunable vm.min_free_kbytes, which instructs the virtual memory subsystem to try keep a certain amount of memory always free for allocation.</p><p>The network driver is receiving traffic from the network adapter into kernel memory, however when the driver tried to allocate memory, the allocation failed.</p><p>Kernel memory is required to be a contiguous block of a certain size. The kernel memory may be all consumed or fragmented, hence why a contiguous block could not be allocated.</p><p>Tuning of the systems use of kernel memory is required to ensure the kernel can always service kernel memory allocations when running in interrupt context.</p><p>kswapd high cpu usage in some of not enough memory case<br>reslove the issue temporary</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sar -rB 2 <span class="comment"># check system vm status</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/compact_memory</span><br></pre></td></tr></table></figure><p>reduce memory compaction ratio<br>echo 1000 &gt;  /proc/sys/vm/extfrag_threshold # 0~1000 ,1000 means the minimum trigger memory compaction operation, it means kernel memory is required to be a contiguous block of a certain size. The kernel memory may be all consumed or fragmented, hence why a contiguous block could not be allocated.</p><p>Some times there are a lot of free memory in your system. But I m not sure the sk_buffer to malloc memroy range from the linux kernel when the NIC driver tirgger the issue.</p><h4 id="dirty-page"><a href="#dirty-page" class="headerlink" title="dirty page"></a>dirty page</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sysctl -a | grep dirty</span><br><span class="line">vm.dirty_background_bytes = 0</span><br><span class="line">vm.dirty_background_ratio = 10</span><br><span class="line">vm.dirty_bytes = 0</span><br><span class="line">vm.dirty_expire_centisecs = 3000</span><br><span class="line">vm.dirty_ratio = 20</span><br><span class="line">vm.dirty_writeback_centisecs = 500</span><br></pre></td></tr></table></figure><h3 id="ZRAM"><a href="#ZRAM" class="headerlink" title="ZRAM"></a><a href="http://liujunming.top/2016/07/04/Linux%E5%86%85%E6%A0%B8%E4%B8%ADzram%E6%A8%A1%E5%9D%97%E7%9A%84%E7%90%86%E8%A7%A3/">ZRAM</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">description <span class="string">&quot;Initializes zram swaping&quot;</span></span><br><span class="line">start on runlevel [2345]</span><br><span class="line">stop on runlevel [!2345]</span><br><span class="line">pre-start script</span><br><span class="line"><span class="comment"># load dependency modules</span></span><br><span class="line">modprobe zram num_devices=2</span><br><span class="line"><span class="comment"># initialize the devices</span></span><br><span class="line"><span class="built_in">echo</span> 1073741824 &gt; /sys/block/zram0/disksize</span><br><span class="line"><span class="built_in">echo</span> 1073741824 &gt; /sys/block/zram1/disksize</span><br><span class="line"><span class="comment"># Creating swap filesystems</span></span><br><span class="line">mkswap /dev/zram0</span><br><span class="line">mkswap /dev/zram1</span><br><span class="line"><span class="comment"># Switch the swaps on</span></span><br><span class="line">swapon -p 5 /dev/zram0</span><br><span class="line">swapon -p 5 /dev/zram1</span><br><span class="line">end script</span><br><span class="line">post-stop script</span><br><span class="line"><span class="comment"># Switching off swap</span></span><br><span class="line">swapoff /dev/zram0</span><br><span class="line">swapoff /dev/zram1</span><br><span class="line">rmmod zram</span><br><span class="line">end script</span><br><span class="line"></span><br><span class="line"><span class="comment">##test zram</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;  </span></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">//<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, sizeof(int));</span><br><span class="line">int  *mem;</span><br><span class="line">int i, size;</span><br><span class="line">size = 0x70000000;</span><br><span class="line">mem = (int*)malloc(size*sizeof(int));</span><br><span class="line"><span class="keyword">for</span>(i = 0; i &lt; size; i++)</span><br><span class="line">mem[i] = (i%1024);</span><br><span class="line">getchar();</span><br><span class="line">free(mem);</span><br><span class="line"><span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Some-parameter-about-numa"><a href="#Some-parameter-about-numa" class="headerlink" title="Some parameter about numa"></a>Some parameter about numa</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">numactl --interleave=all <span class="comment">#Two/Four socket CPU will share all memory, but you can&#x27; t got the best performance except you need more memory</span></span><br><span class="line">vm.zone_reclaim_mode = 0  <span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> -15 &gt; /proc/&lt;pid&gt;/oom_adj <span class="comment">#reduce kill ratio</span></span><br><span class="line">huge page will not be swaped</span><br></pre></td></tr></table></figure><h3 id="Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage"><a href="#Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage" class="headerlink" title="Soft lockup detected on a large NUMA system under a heavy memory usage"></a><a href="https://access.redhat.com/solutions/1560893">Soft lockup detected on a large NUMA system under a heavy memory usage</a></h3><p>Systems with numa factor lower than or equal to 30 may hang under the high load.<br>Soft lockup detected under a heavy memory pressure on a large NUMA system.</p><p>For RHEL 7, users must be aware of the following steps that can avoid the soft lockup from occurring. Disable Transparent Huge Page (THP) to avoid such busy memory-compaction, and add numa_balancing=disable to the kernel parameter followed by reboot, OR set /proc/sys/vm/zone_reclaim_mode to 1.<br>For RHEL 6,<br>disable Transparent Huge Page (THP) to avoid such busy memory-compaction OR set /proc/sys/vm/zone_reclaim_mode to 1.</p><p>The default value(zero) of /proc/sys/vm/zone_reclaim_mode results in the CPUs running on the memory exhausted nodes to skip over to the next node with available memory to attempt the memory allocation.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">kernel: BUG: soft lockup - CPU<span class="comment">#102 stuck for 22s! [forkoff:235364]</span></span><br><span class="line">kernel: Modules linked <span class="keyword">in</span>: fuse btrfs zlib_deflate raid6_pq xor msdos ext4</span><br><span class="line">mbcache jbd2 binfmt_misc xt_CHECKSUM iptable_mangle ipt_MASQUERADE</span><br><span class="line">nf_nat_masquerade_ipv4 iptable_nat nf_nat_ipv4 nf_nat nf_conntrack_ipv4</span><br><span class="line">nf_defrag_ipv4 xt_conntrack nf_conntrack ipt_REJECT iptable_filter ip_tables</span><br><span class="line">tun bridge stp llc dm_mirror dm_region_hash dm_log dm_mod iTCO_wdt</span><br><span class="line">iTCO_vendor_support vfat fat intel_powerclamp coretemp intel_rapl kvm_intel</span><br><span class="line">kvm crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel</span><br><span class="line">lrw gf128mul glue_helper ablk_helper cryptd pcspkr sb_edac edac_core lpc_ich</span><br><span class="line">i2c_i801 mfd_core shpchp ipmi_si ipmi_msghandler tpm_infineon nls_utf8 isofs</span><br><span class="line">loop uinput xfs libcrc32c sd_mod crc_t10dif crct10dif_common mgag200</span><br><span class="line">syscopyarea sysfillrect sysimgblt drm_kms_helper igb qla2xxx e1000e</span><br><span class="line">kernel: ttm dca ptp scsi_transport_fc drm i2c_algo_bit pps_core scsi_tgt</span><br><span class="line">megaraid_sas i2c_core</span><br><span class="line">kernel: CPU: 102 PID: 235364 Comm: forkoff Not tainted 3.10.0-229.el7.x86_64</span><br><span class="line"><span class="comment">#1                                                                                                                                                                                                                                                                             </span></span><br><span class="line">kernel:</span><br><span class="line">kernel: task: ffff911d25eea220 ti: ffff927835154000 task.ti: ffff927835154000</span><br><span class="line">kernel: RIP: 0010:[&lt;ffffffff811798ef&gt;]  [&lt;ffffffff811798ef&gt;]</span><br><span class="line">isolate_freepages_block+0xaf/0x380</span><br><span class="line">kernel: RSP: 0000:ffff927835157860  EFLAGS: 00000286</span><br><span class="line">kernel: RAX: 00000000ffffffff RBX: 00000014e4b60000 RCX: ffff927835157aa8</span><br><span class="line">kernel: RDX: 0000000053345c00 RSI: 0000000053345a00 RDI: ffff927835157a50</span><br><span class="line">kernel: RBP: ffff9278351578f8 R08: 0000000000000000 R09: ffff8e007ffda000</span><br><span class="line">kernel: R10: 00000014cd168000 R11: 0000000060080000 R12: 0000000000000301</span><br><span class="line">kernel: R13: ffff927835157850 R14: 0000000000000000 R15: 00007f4501f64000</span><br><span class="line">kernel: FS:  00007f4f4d540740(0000) GS:ffff90fa7f9a0000(0000)</span><br><span class="line">knlGS:0000000000000000</span><br><span class="line">kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">kernel: CR2: 00007f4690400000 CR3: 000009baa7060000 CR4: 00000000001407e0</span><br><span class="line">kernel: DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000</span><br><span class="line">kernel: DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400</span><br><span class="line">kernel: Stack:</span><br><span class="line">kernel: ffffea2a02311040 0000000060080000 0000000000000094 ffff927835157948</span><br><span class="line">kernel: 0000000053345a00 ffff927835157a50 000000004808ec38 00ff8e0000000000</span><br><span class="line">kernel: ffff927835157a90 ffff927835157aa8 ffff927835157a50 ffff8e007ffad000</span><br><span class="line">kernel: Call Trace:</span><br><span class="line">kernel: [&lt;ffffffff81179d8f&gt;] compaction_alloc+0x1cf/0x240</span><br><span class="line">kernel: [&lt;ffffffff811b15ce&gt;] migrate_pages+0xce/0x610</span><br><span class="line">kernel: [&lt;ffffffff81179bc0&gt;] ? isolate_freepages_block+0x380/0x380</span><br><span class="line">kernel: [&lt;ffffffff8117abb9&gt;] compact_zone+0x299/0x400</span><br><span class="line">kernel: [&lt;ffffffff8117adbc&gt;] compact_zone_order+0x9c/0xf0</span><br><span class="line">kernel: [&lt;ffffffff8117b171&gt;] try_to_compact_pages+0x121/0x1a0</span><br><span class="line">kernel: [&lt;ffffffff815ff336&gt;] __alloc_pages_direct_compact+0xac/0x196</span><br><span class="line">kernel: [&lt;ffffffff81160758&gt;] __alloc_pages_nodemask+0x788/0xb90</span><br><span class="line">kernel: [&lt;ffffffff810b11c0&gt;] ? task_numa_fault+0x8d0/0xbb0</span><br><span class="line">kernel: [&lt;ffffffff811a24aa&gt;] alloc_pages_vma+0x9a/0x140</span><br><span class="line">kernel: [&lt;ffffffff811b674b&gt;] do_huge_pmd_anonymous_page+0x10b/0x410</span><br><span class="line">kernel: [&lt;ffffffff81182334&gt;] handle_mm_fault+0x184/0xd60</span><br><span class="line">kernel: [&lt;ffffffff8160f1e6&gt;] __do_page_fault+0x156/0x520</span><br><span class="line">kernel: [&lt;ffffffff8118a945&gt;] ? change_protection+0x65/0xa0</span><br><span class="line">kernel: [&lt;ffffffff811a0dbb&gt;] ? change_prot_numa+0x1b/0x40</span><br><span class="line">kernel: [&lt;ffffffff810adb86&gt;] ? task_numa_work+0x266/0x300</span><br><span class="line">kernel: [&lt;ffffffff8160f5ca&gt;] do_page_fault+0x1a/0x70</span><br><span class="line">kernel: [&lt;ffffffff81013b0c&gt;] ? do_notify_resume+0x9c/0xb0</span><br><span class="line">kernel: [&lt;ffffffff8160b808&gt;] page_fault+0x28/0x30</span><br><span class="line">kernel: Code: 89 ee 48 89 4d b0 41 89 c5 eb 1d 90 49 83 c7 01 48 83 c3 40 4d</span><br><span class="line">39 <span class="built_in">fc</span> 0f 86 07 01 00 00 41 83 c5 01 4d 85 f6 4c 0f 44 f3 8b 43 18 &lt;83&gt; f8 80</span><br><span class="line">75 dc 48 8b 45 b8 0f b6 55 c0 48 8d 75 c8 4c 8b 45 b0</span><br></pre></td></tr></table></figure><h3 id="Transparent-Huge-Page"><a href="#Transparent-Huge-Page" class="headerlink" title="Transparent Huge Page"></a><a href="https://access.redhat.com/solutions/46111">Transparent Huge Page</a></h3><p>The transparent Huge Page implementation in the Linux kernel includes functionality that provides compaction. Compaction operations are system level processes that are resource intensive</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Enable or disable</span></span><br><span class="line">$ cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[always] madvise never</span><br><span class="line">$ cat /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line">[always] madvise never</span><br><span class="line"></span><br><span class="line">$ grep AnonHugePages /proc/meminfo</span><br><span class="line">AnonHugePages:  19523584 kB</span><br><span class="line"></span><br><span class="line">$ cat /proc/meminfo|grep Huge</span><br><span class="line">AnonHugePages:  1681086464 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line"></span><br><span class="line"><span class="comment">## means 1681086464/2048 = 820843x 2MB huge pages</span></span><br><span class="line"></span><br><span class="line">$ grep -Ei <span class="string">&#x27;trans|thp&#x27;</span> /proc/vmstat</span><br><span class="line">nr_anon_transparent_hugepages 9533</span><br><span class="line">thp_fault_alloc 24017</span><br><span class="line">thp_fault_fallback 16231</span><br><span class="line">thp_collapse_alloc 1687</span><br><span class="line">thp_collapse_alloc_failed 39449</span><br><span class="line">thp_split 2926</span><br><span class="line">thp_zero_page_alloc 1</span><br><span class="line">thp_zero_page_alloc_failed 0</span><br><span class="line"></span><br><span class="line"><span class="comment">### check the process</span></span><br><span class="line">$ grep -e AnonHugePages  /proc/*/smaps | awk -F <span class="string">&#x27;[/ ]+&#x27;</span> <span class="string">&#x27;$(NF-1)&gt;4 &#123;system(&quot;ps -fp  &quot;$3)&#125;&#x27;</span></span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">nobody    5023  5016  3 Jun07 ?        22:28:27 /sbin/lustre_exporter --collector.ost=disabled --collector.mdt=core</span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">polkitd    743     1  0 Jun07 ?        00:00:19 /usr/lib/polkit-1/polkitd --no-debug</span><br></pre></td></tr></table></figure><h3 id="Single-process-memory"><a href="#Single-process-memory" class="headerlink" title="Single process memory"></a>Single process memory</h3><pre><code>   /proc/[pid]/statm          Provides information about memory usage, measured in pages.          The columns are:              size       (1) total program size                         (same as VmSize in /proc/[pid]/status)              resident   (2) resident set size                         (same as VmRSS in /proc/[pid]/status)              shared     (3) number of resident shared pages (i.e., backed by a file)                         (same as RssFile+RssShmem in /proc/[pid]/status)              text       (4) text (code)              lib        (5) library (unused since Linux 2.6; always 0)              data       (6) data + stack              dt         (7) dirty pages (unused since Linux 2.6; always 0)</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/3760/statm</span><br><span class="line">400865 96456 37653 27355 0 157019 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Second field means res (resident)<br>pmap $(pgrep bash)</p><p>There are some of share library in each resident</p><p>If you want get share library memory consumption.<br>/proc/[pid]/smaps (since Linux 2.6.14)<br>              This file shows memory consumption for each of the processs<br>              mappings.  (The pmap(1) command displays similar information,<br>              in a form that may be easier for parsing.)</p><h4 id="Slab"><a href="#Slab" class="headerlink" title="Slab"></a>Slab</h4><p>In-kernel data structures cache.</p><p>Cache pool for often userd dupulication objects<br>you could found these objects from slabtop</p><p>Get all slabsize<br>awk BEGIN{sum=0;}{sum=sum+$3*$4;}END{print sum/1024/1024} /proc/slabinfo MB</p><h4 id="Page-table"><a href="#Page-table" class="headerlink" title="Page table"></a>Page table</h4><p>awk $0~/PageTables/ {print $2} /proc/meminfo KB</p><h4 id="Struct-page"><a href="#Struct-page" class="headerlink" title="Struct page"></a>Struct page</h4><p>page frame minimum unit. every page frame has a struct page to point<br><a href="https://stackoverflow.com/questions/34836806/how-to-get-physical-address-from-struct-page-in-linux-kernel">struct page could mapping page frame to physical address</a><br>all page frame in the LUR list.<br>There are 2.3%(96/4096) usage in linux 2.6.32</p><h3 id="Use-hugetlbfs"><a href="#Use-hugetlbfs" class="headerlink" title="Use hugetlbfs"></a><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/tuning_and_optimizing_red_hat_enterprise_linux_for_oracle_9i_and_10g_databases/sect-oracle_9i_and_10g_tuning_guide-large_memory_optimization_big_pages_and_huge_pages-configuring_huge_pages_in_red_hat_enterprise_linux_4_or_5">Use hugetlbfs</a></h3><h4 id="set-hugepage"><a href="#set-hugepage" class="headerlink" title="set hugepage"></a><a href="https://paolozaino.wordpress.com/2016/10/02/how-to-force-any-linux-application-to-use-hugepages-without-modifying-the-source-code/">set hugepage</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install libhugetlbfs-utils libhugetlbfs</span><br><span class="line"><span class="comment"># To set the 2MB pool minimum to 512 pages:</span></span><br><span class="line">$ hugeadm --pool-pages-min 2MB:512</span><br><span class="line">$ hugeadm --pool-pages-max 2MB:2048</span><br><span class="line">$ hugeadm --pool-list</span><br><span class="line"></span><br><span class="line">$ mkdir -p /mnt/hugetlbfs-64K</span><br><span class="line">$ mount -t hugetlbfs none -opagesize=64k /mnt/hugetlbfs-64K</span><br><span class="line">or </span><br><span class="line">$ mount -t hugetlbfs none /mnt/hugetlbfs -o uid=postfix -o gid=postfix</span><br><span class="line">$ hugeadm --set-recommended-shmmax</span><br><span class="line">$ hugeadm --explain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ LD_PRELOAD=libhugetlbfs.so HUGETLB_MORECORE=yes ./run_your_cmd</span><br><span class="line"><span class="comment">## looks like it &#x27;s ok</span></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">31723 root      20   0  642.7g  94996   1348 S  1734  0.0 101:41.53 ./ft.E.x</span><br></pre></td></tr></table></figure><h4 id="Defragment-kernel-memory"><a href="#Defragment-kernel-memory" class="headerlink" title="Defragment kernel memory"></a>Defragment kernel memory</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t debugfs none  /sys/kernel/debug</span><br><span class="line">$ cat /proc/buddyinfo</span><br><span class="line">                          2^0    2^1    2^2    2^3    2^4    2^5    2^6    2^7    2^8    2^9    2^10 (1024K)</span><br><span class="line">Node 0, zone      DMA      1      0      1      0      2      1      1      0      1      1      3</span><br><span class="line">Node 0, zone    DMA32      3      3      2      2      3      2      4      2      1      0    458</span><br><span class="line">Node 0, zone   Normal 579745  20289    510     94      0      0      0      0      0      0      0</span><br><span class="line">Node 1, zone   Normal 2230945 587911  23339      0      0      0      0      0      0      0      0</span><br><span class="line">Node 2, zone   Normal 2332274 236445  28213   9936    922     23      9      0      0      0      0</span><br><span class="line">Node 3, zone   Normal 654981   7909    163     47     11      1      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> m &gt; /proc/sysrq-trigger <span class="comment"># same with buddyinfo</span></span><br><span class="line"></span><br><span class="line">$ cat /sys/kernel/debug/extfrag/extfrag_index</span><br><span class="line">Node 0, zone      DMA -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000</span><br><span class="line">Node 0, zone    DMA32 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000</span><br><span class="line">Node 0, zone   Normal -1.000 0.500 0.750 0.875 0.938 0.969 0.985 0.993 0.996 0.998 0.999</span><br><span class="line">Node 1, zone   Normal -1.000 -1.000 0.750 0.875 0.938 0.969 0.985 0.993 0.996 0.998 0.999</span><br><span class="line">Node 2, zone   Normal -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 0.990 0.995</span><br><span class="line">Node 3, zone   Normal -1.000 -1.000 -1.000 0.860 0.930 0.965 0.983 0.992 0.996 0.998 0.999</span><br><span class="line"><span class="comment">#### -1.000 is ok,</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/compact_memory</span><br><span class="line"></span><br><span class="line">$ cat /proc/buddyinfo</span><br><span class="line">Node 0, zone      DMA      1      0      1      0      2      1      1      0      1      1      3</span><br><span class="line">Node 0, zone    DMA32      3      3      2      2      3      2      4      2      1      0    458</span><br><span class="line">Node 0, zone   Normal  13927    290      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node 1, zone   Normal 415126 488237 168310  90724  38203   7840    443      9      0      0      0</span><br><span class="line">Node 2, zone   Normal 2068303 341591  58672  25946   4986    920    239     40      1      0      0</span><br><span class="line">Node 3, zone   Normal   9030    668      5     23      7      1      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">$ cat /sys/kernel/debug/extfrag/extfrag_index</span><br><span class="line">Node 0, zone      DMA -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000</span><br><span class="line">Node 0, zone    DMA32 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000</span><br><span class="line">Node 0, zone   Normal -1.000 -1.000 -1.000 -1.000 0.935 0.968 0.984 0.992 0.996 0.998 0.999</span><br><span class="line">Node 1, zone   Normal -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 0.987 0.994 0.997</span><br><span class="line">Node 2, zone   Normal -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 0.998 0.999</span><br><span class="line">Node 3, zone   Normal -1.000 -1.000 -1.000 -1.000 0.933 0.967 0.984 0.992 0.996 0.998 0.999</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat /proc/sys/vm/extfrag_threshold</span><br><span class="line">500</span><br><span class="line"><span class="comment">## if the value large than extfrag_threshold ,the kswapd will trigger memory compaction, reduce the value to 200 ? </span></span><br><span class="line"><span class="comment">## -1.000 means engough memory, if the value near the 1.000 that means more extfrag_threshold </span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>compact_memory<br>Available only when CONFIG_COMPACTION is set. When 1 is written to the file, all zones are compacted such that free memory is available in contiguous blocks where possible. This can be important for example in the allocation of huge pages although processes will also directly compact memory as required.</p><p>in another node, looks like there are 8 ~ 16K page in centos 7.6 ,3.10.0-957.10.1.el7.x86_64</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> cat /proc/buddyinfo</span><br><span class="line">Node 0, zone      DMA      0      1      1      0      2      1      1      0      1      1      3</span><br><span class="line">Node 0, zone    DMA32     12   6308  12784   5977   1766    440     93     11     19      0      0</span><br><span class="line">Node 0, zone   Normal    190   2376   2586 170387  88814  17747   4114   1895   1211      0      0</span><br><span class="line">Node 1, zone   Normal    186    871    437 165556  81041  12616   2113    978    607      0      0</span><br><span class="line">Node 2, zone   Normal    427   2125   1593 137923  87498  19412   6125    883    552      0      0</span><br><span class="line">Node 3, zone   Normal    280   2686   1041  74979  80569  16675   4315   1792   1145      0      0</span><br></pre></td></tr></table></figure><p><a href="https://paolozaino.wordpress.com/2016/10/02/how-to-force-any-linux-application-to-use-hugepages-without-modifying-the-source-code/">At this point is time to start running your application using libhugetlbfs so that your app will use Hugepages.</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ grep Hugepagesize /proc/meminfo</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">$ <span class="built_in">echo</span> 512 &gt; /proc/sys/vm/nr_hugepages</span><br><span class="line">This means <span class="keyword">if</span> a 1GB Huge Pages pool should be allocated, <span class="keyword">then</span> 512 Huge Pages need to be allocated</span><br><span class="line">it <span class="string">&#x27;s the static huge page</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 1000 &gt; /proc/sys/vm/hugetlb_shm_group</span></span><br><span class="line"><span class="string">##means only members of group testuser(1000) can allocate &quot;huge&quot; Shared memory segment</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o uid=1000,gid=1000,mode=775,size=10g none /data/hugeshm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#kernel parameter, 4x1G, 1024x2M</span></span><br><span class="line"><span class="string">default_hugepagesz=1G hugepagesz=1G hugepages=4 hugepagesz=2M hugepages=1024</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o pagesize=1G none /dev/hugepages1G</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o pagesize=2M none /dev/hugepages2M</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 4 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"><span class="string">echo 1024 &gt; /sys/devices/system/node/node3/hugepages/hugepages-2048kB/nr_hugepages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/proc/sys/vm/nr_overcommit_hugepages</span></span><br><span class="line"><span class="string">Defines the maximum number of additional huge pages that can be created and used by the system through overcommitting memory. Writing any non-zero value into this file indicates that the system obtains that number of huge pages from the kernel&#x27;</span>s normal page pool <span class="keyword">if</span> the persistent huge page pool is exhausted. As these surplus huge pages become unused, they are <span class="keyword">then</span> freed and returned to the kernel<span class="string">&#x27;s normal page pool.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h4 id="memlock"><a href="#memlock" class="headerlink" title="memlock"></a>memlock</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oracle           soft    memlock         1048576</span><br><span class="line">oracle           hard    memlock         1048576</span><br></pre></td></tr></table></figure><p>The memlock parameter specifies how much memory the oracle user can lock into its address space. Note that Huge Pages are locked in physical memory. The memlock setting is specified in KB and must match the memory size of the number of Huge Pages that Oracle should be able to allocate. So if the Oracle database should be able to use 512 Huge Pages, then memlock must be set to at least 512 * Hugepagesize, which on this system would be 1048576 KB (512<em>1024</em>2). If memlock is too small, then no single Huge Page will be allocated when the Oracle database starts</p><h4 id="free-hugepage"><a href="#free-hugepage" class="headerlink" title="free hugepage"></a>free hugepage</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/vm/nr_hugepages</span><br></pre></td></tr></table></figure><h4 id="manage-tools"><a href="#manage-tools" class="headerlink" title="manage tools"></a>manage tools</h4><p>hugeadm</p><h4 id="reduce-OOM-kill-rate"><a href="#reduce-OOM-kill-rate" class="headerlink" title="reduce OOM kill rate"></a>reduce OOM kill rate</h4><p>echo -15 &gt; /proc/${pid}/oom_adj</p><h4 id="get-pagesize"><a href="#get-pagesize" class="headerlink" title="get pagesize"></a>get pagesize</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getconf PAGESIZE</span><br><span class="line">4096</span><br></pre></td></tr></table></figure><h3 id="enable-huge-page-for-performance"><a href="#enable-huge-page-for-performance" class="headerlink" title="enable huge page for performance"></a>enable huge page for performance</h3><ul><li>Hugepages is a feature that allows the Linux kernel to utilize the multiple page size capabilities of<br>modern hardware architectures.<ul><li>A page is the basic unit of virtual memory, with the default page size being 4 KB in the x86 architecture.</li></ul></li><li>Leave sufficient memory for OS use<ul><li>no longer subject to normal memory allocations</li></ul></li><li>Huge Pages are pinned to physical RAM and cannot be swapped/paged out.<ul><li>Preference is for 1G hugepages.</li><li>Each hugepage requires a TLB entry. Smaller hugepages =&gt; more TLBs and TLB lookups due to page faults =&gt; higher probability of packet drop blips</li></ul></li></ul><p>hugepagesz<br>[HW,IA-64,PPC,X86-64] The size of the HugeTLB pages.<br>On x86-64 and powerpc, this option can be specified multiple times interleaved with hugepages= to reserve huge pages of different sizes. Valid pages sizes on x86-64 are 2M (when the CPU supports pse) and 1G (when the CPU supports the pdpe1gb cpuinfo flag).</p><p>hugepages<br>[HW,X86-32,IA-64] HugeTLB pages to allocate at boot.</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hugepagesz</span>=1G <span class="attribute">hugepages</span>=224</span><br></pre></td></tr></table></figure><h3 id="slab-exhaust-all-memory-because-a-lot-of-scan"><a href="#slab-exhaust-all-memory-because-a-lot-of-scan" class="headerlink" title="slab exhaust all memory because a lot of scan"></a>slab exhaust all memory because a lot of scan</h3><p>top<br><img src="/img/top-mem1.png"></p><p>Why Slab=24021820 kB (24GB)</p><p>slabtop<br><img src="/img/slabtop1.png"> </p><p>meminfo</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">MemTotal:       32832340 kB</span><br><span class="line">MemFree:          829744 kB</span><br><span class="line">Buffers:           85096 kB</span><br><span class="line">Cached:          1895216 kB</span><br><span class="line">SwapCached:       164592 kB</span><br><span class="line">Active:          4572372 kB</span><br><span class="line">Inactive:        2520612 kB</span><br><span class="line">Active(anon):    4131784 kB</span><br><span class="line">Inactive(anon):   983612 kB</span><br><span class="line">Active(file):     440588 kB</span><br><span class="line">Inactive(file):  1537000 kB</span><br><span class="line">Unevictable:       25864 kB</span><br><span class="line">Mlocked:            9512 kB</span><br><span class="line">SwapTotal:       8191996 kB</span><br><span class="line">SwapFree:        5818864 kB</span><br><span class="line">Dirty:               120 kB</span><br><span class="line">Writeback:             0 kB</span><br><span class="line">AnonPages:       4974644 kB</span><br><span class="line">Mapped:            12584 kB</span><br><span class="line">Shmem:                36 kB</span><br><span class="line">Slab:           24021820 kB</span><br><span class="line">SReclaimable:   11202668 kB</span><br><span class="line">SUnreclaim:     12819152 kB</span><br><span class="line">KernelStack:       10624 kB</span><br><span class="line">PageTables:        38088 kB</span><br><span class="line">NFS_Unstable:          0 kB</span><br><span class="line">Bounce:                0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line">CommitLimit:    24608164 kB</span><br><span class="line">Committed_AS:    7777952 kB</span><br><span class="line">VmallocTotal:   34359738367 kB</span><br><span class="line">VmallocUsed:      413916 kB</span><br><span class="line">VmallocChunk:   34359269244 kB</span><br><span class="line">HardwareCorrupted:     0 kB</span><br><span class="line">AnonHugePages:     30720 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">DirectMap4k:        4096 kB</span><br><span class="line">DirectMap2M:     1957888 k</span><br></pre></td></tr></table></figure><h3 id="memmap"><a href="#memmap" class="headerlink" title="memmap"></a><a href="https://docs.pmem.io/getting-started-guide/creating-development-environments/linux-environments/linux-memmap">memmap</a></h3><p><a href="https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt">https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">memmap=exactmap[KNL,X86] Enable setting of an exact</span><br><span class="line">E820 memory map, as specified by the user.</span><br><span class="line">Such memmap=exactmap lines can be constructed based on</span><br><span class="line">BIOS output or other requirements. See the memmap=nn@ss</span><br><span class="line">option description.</span><br><span class="line"></span><br><span class="line">memmap=nn[KMG]@ss[KMG]</span><br><span class="line">[KNL] Force usage of a specific region of memory.</span><br><span class="line">Region of memory to be used is from ss to ss+nn.</span><br><span class="line">If @ss[KMG] is omitted, it is equivalent to mem=nn[KMG],</span><br><span class="line"><span class="built_in">which</span> limits max address to nn[KMG].</span><br><span class="line">Multiple different regions can be specified,</span><br><span class="line">comma delimited.</span><br><span class="line">Example:</span><br><span class="line">memmap=100M@2G,100M<span class="comment">#3G,1G!1024G</span></span><br><span class="line"></span><br><span class="line">memmap=nn[KMG]<span class="comment">#ss[KMG]</span></span><br><span class="line">[KNL,ACPI] Mark specific memory as ACPI data.</span><br><span class="line">Region of memory to be marked is from ss to ss+nn.</span><br><span class="line"></span><br><span class="line">memmap=nn[KMG]<span class="variable">$ss</span>[KMG]</span><br><span class="line">[KNL,ACPI] Mark specific memory as reserved.</span><br><span class="line">Region of memory to be reserved is from ss to ss+nn.</span><br><span class="line">Example: Exclude memory from 0x18690000-0x1869ffff</span><br><span class="line">         memmap=64K<span class="variable">$0x18690000</span></span><br><span class="line">         or</span><br><span class="line">         memmap=0x10000<span class="variable">$0x18690000</span></span><br><span class="line">Some bootloaders may need an escape character before <span class="string">&#x27;$&#x27;</span>,</span><br><span class="line">like Grub2, otherwise <span class="string">&#x27;$&#x27;</span> and the following number</span><br><span class="line">will be eaten.</span><br><span class="line"></span><br><span class="line">memmap=nn[KMG]!ss[KMG]</span><br><span class="line">[KNL,X86] Mark specific memory as protected.</span><br><span class="line">Region of memory to be used, from ss to ss+nn.</span><br><span class="line">The memory region may be marked as e820 <span class="built_in">type</span> 12 (0xc)</span><br><span class="line">and is NVDIMM or ADR memory.</span><br></pre></td></tr></table></figure><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> dmesg | grep e820</span><br><span class="line"><span class="symbol">$</span> grubby --args=<span class="string">&quot;memmap=96G:32G&quot;</span> --update-kernel=<span class="keyword">ALL</span></span><br></pre></td></tr></table></figure><p>mapping /dev/pmemX can be used to create a DAX filesystem</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo parted <span class="regexp">/dev/</span>pmem0</span><br><span class="line">(parted) mkpart</span><br><span class="line">Partition type?  primary/extended? p</span><br><span class="line"><span class="keyword">File</span> system type?  [ext2]? ext4</span><br><span class="line">Start? <span class="number">2</span>MiB</span><br><span class="line">End? <span class="number">100</span>GiB</span><br><span class="line">(parted)</span><br><span class="line"></span><br><span class="line">(parted) mkpart</span><br><span class="line">Partition type?  primary/extended? p</span><br><span class="line"><span class="keyword">File</span> system type?  [ext2]? ext4</span><br><span class="line">Start? <span class="number">100</span>GiB</span><br><span class="line">End? <span class="number">200</span>GiB</span><br><span class="line"></span><br><span class="line">$  getconf PAGE_SIZE</span><br><span class="line"><span class="number">4096</span></span><br><span class="line"></span><br><span class="line">$ sudo mkfs.ext4 -b <span class="number">4096</span> -E stride=<span class="number">512</span> -F <span class="regexp">/dev/</span>pmem0</span><br><span class="line">$ sudo mkdir /pmem</span><br><span class="line">$ sudo mount -o dax <span class="regexp">/dev/</span>pmem0p1 /pmem</span><br><span class="line">$ sudo mount -v | <span class="keyword">grep</span> /pmem</span><br><span class="line">$ fallocate --length <span class="number">1</span>G <span class="regexp">/pmem/</span>data</span><br><span class="line">$ echo <span class="number">1</span> &gt; <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>fs_dax<span class="regexp">/dax_pmd_fault_done/</span>enable</span><br><span class="line">$ echo <span class="number">0</span> &gt; <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>fs_dax<span class="regexp">/dax_pmd_fault_done/</span>enable</span><br><span class="line"></span><br><span class="line"># Verify the namespace is in fsdax mode</span><br><span class="line">$ ndctl list -u</span><br><span class="line">$ cat <span class="regexp">/proc/i</span>omem</span><br></pre></td></tr></table></figure><h4 id="Monitor-ecc-error"><a href="#Monitor-ecc-error" class="headerlink" title="Monitor ecc error"></a>Monitor ecc error</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg -T |  grep -Ei <span class="string">&quot;Err.*bit ECC&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor multiple bit</span></span><br><span class="line">$ cat /sys/devices/system/edac/mc/mc*/[u,c]e_count | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> [[ ! <span class="variable">$line</span> -eq 0 ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;Got DRAM ecc error&quot;</span> &amp;&amp; <span class="built_in">exit</span> 2; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="Benchmark-by-perf"><a href="#Benchmark-by-perf" class="headerlink" title="Benchmark by perf"></a>Benchmark by perf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">......</span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          8.837 secs slowest (max) thread-runtime</span><br><span class="line">          8.000 secs fastest (min) thread-runtime</span><br><span class="line">          8.182 secs average thread-runtime</span><br><span class="line">          4.738 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.702 nsecs/byte/thread runtime</span><br><span class="line">          1.424 GB/sec/thread speed</span><br><span class="line">         14.239 GB/sec total speed</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          5.528 secs slowest (max) thread-runtime</span><br><span class="line">          5.000 secs fastest (min) thread-runtime</span><br><span class="line">          5.084 secs average thread-runtime</span><br><span class="line">          4.776 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.439 nsecs/byte/thread runtime</span><br><span class="line">          2.276 GB/sec/thread speed</span><br><span class="line">         22.764 GB/sec total speed</span><br></pre></td></tr></table></figure><h3 id="AMD-roma-CPU-memroy"><a href="#AMD-roma-CPU-memroy" class="headerlink" title="AMD roma CPU memroy"></a>AMD roma CPU memroy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">dmidecode</span> <span class="string">-t</span> <span class="string">memory</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-Ei</span> <span class="string">&#x27;1638|32&#x27;</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Size:</span> <span class="number">16384</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"><span class="attr">Configured Memory Speed:</span> <span class="number">3200 </span><span class="string">MT/s</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">5</span><span class="string">..8</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">echo</span> <span class="string">$i;</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">4</span><span class="string">,$i</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">         <span class="number">12.818</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line">         <span class="number">12.757</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line">         <span class="number">12.810</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line">         <span class="number">13.142</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">21</span><span class="string">..24</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">echo</span> <span class="string">$i;</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">20</span><span class="string">,$i</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line">         <span class="number">12.836</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">22</span></span><br><span class="line">         <span class="number">12.824</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">23</span></span><br><span class="line">         <span class="number">12.847</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="number">24</span></span><br><span class="line">         <span class="number">13.183</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">20</span><span class="string">,46</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span></span><br><span class="line">         <span class="number">13.125</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br><span class="line"><span class="string">$</span> <span class="string">perf</span> <span class="string">bench</span> <span class="string">numa</span> <span class="string">mem</span>  <span class="string">-p</span> <span class="number">1</span> <span class="string">-t</span> <span class="number">2</span>  <span class="string">-T</span> <span class="number">15000</span>  <span class="string">-Irq</span> <span class="string">-H</span> <span class="number">1</span> <span class="string">-C</span> <span class="number">20</span><span class="string">,47</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">&quot;sec total speed&quot;</span></span><br><span class="line">         <span class="number">13.137</span> <span class="string">GB/sec</span> <span class="string">total</span> <span class="string">speed</span></span><br></pre></td></tr></table></figure><p>AMD roma looks like 4 cores share a mem channel, 2 threads x 15000MB = 30G , 12GB/s means in a mem channel, 13GB/s means pass two mem channel, just guess.</p>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ethernet nic tuning</title>
      <link href="2018/06/01/ethernet_nic_tuning/"/>
      <url>2018/06/01/ethernet_nic_tuning/</url>
      
        <content type="html"><![CDATA[<h3 id="slot-status"><a href="#slot-status" class="headerlink" title="slot status"></a>slot status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ 05:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 <span class="keyword">for</span> 25GbE SFP28 (rev 02)</span><br><span class="line">$ lspci -s 05:00.0 -vvv | grep -Ei <span class="string">&#x27;8G|MSI-X&#x27;</span></span><br><span class="line">      Capabilities: [70] MSI-X: Enable+ Count=129 Masked-</span><br><span class="line">              LnkCap: Port <span class="comment">#0, Speed 8GT/s, Width x8, ASPM L1, Latency L0 &lt;2us, L1 &lt;16us</span></span><br><span class="line">              LnkSta: Speed 8GT/s, Width x8, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-</span><br><span class="line"></span><br><span class="line"><span class="comment">## RSS support</span></span><br><span class="line">$ lspci -v -s 83:00.0 | grep <span class="string">&quot;MSI-X: Enable+&quot;</span></span><br><span class="line">83:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line">        Flags: bus master, fast devsel, latency 0, IRQ 247, NUMA node 1</span><br><span class="line">        I/O ports at d020 [size=32]</span><br><span class="line">        Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit+</span><br><span class="line">        Capabilities: [70] MSI-X: Enable+ Count=64 Masked-</span><br><span class="line"></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="THEORETICAL-MAXIMUM-RATE"><a href="#THEORETICAL-MAXIMUM-RATE" class="headerlink" title="THEORETICAL MAXIMUM RATE"></a><a href="https://support-kb.spirent.com/resources/sites/SPIRENT/content/live/FAQS/10000/FAQ10597/en_US/How_to_Test_10G_Ethernet_WhitePaper_RevB.PDF">THEORETICAL MAXIMUM RATE</a></h3><p>There are two important concepts related to 10GbE performance: frame rate and throughput. The MAC bit rate of 10GbE, defined in the IEEE standard 802.3ae, is 10 billion bits per second. Frame rate is a simple arithmetic calculation based on the bit rate and frame format definitions. Throughput, defined in IETF RFC 1242, is the highest rate at which the system under test can forward the offered load, without loss. Manufacturers can claim line-rate throughput only if their switch forwards all the traffic offered at the 10Gb/s line rate for the entire duration of the test. The bit rate at which 10GbE Media Access Layer (MAC) operates, 10 billion bits per second, is only one of the parameters in defining the transmission rate for this important new technology. The usual description of true network performance is frame rate, which indicates how many Ethernet frames are moving across the network. The maximum frame rate for 10GbE is determined by a formula that divides the 10 billion bits per second by the preamble, frame length, and inter-frame gap fields, expressed in bits. The maximum frame rate is calculated using the minimum values of the following parameters, as described in the IEEE 802.3ae standard:</p><ul><li>Preamble - 8 bytes * 8 = 64 bits</li><li>Frame length - 64 bytes (minimum) * 8 = 512 bits</li><li>Inter-frame gap - 12 bytes (minimum) * 8 = 96 bits<br>Therefore,<br>Maximum Frame Rate =<br>MAC Transmit Bit Rate/<br>(Preamble + Frame Length + Inter-frame Gap)<br>= 10,000,000,000 / (64 + 512 + 96)<br>= 10,000,000,000 / 672<br>= 14,880,952.38 frame per second (fps)</li></ul><h3 id="About-FEC"><a href="#About-FEC" class="headerlink" title="About FEC"></a><a href="https://solarflare.hammer-europe.com/assets/uploads/resources/QLogic%20-%20White%20Paper%20-%2025Gb%20Ethernet.pdf">About FEC</a></h3><p>IEEE 802.3 Standard Interfaces that Specify 25GbE</p><table><thead><tr><th align="center">Phy layer</th><th align="center">Name</th><th align="center">error Correction</th></tr></thead><tbody><tr><td align="center">MMF Optics</td><td align="center">25GBASE-SR</td><td align="center">RS-FEC</td></tr><tr><td align="center">Direct Attach Copper</td><td align="center">25GBASE-CR</td><td align="center">BASE-R FEC or RS-FEC</td></tr><tr><td align="center">Direct Attach Copper</td><td align="center">25GBASE-CR-S</td><td align="center">BASE-R FEC or disabled</td></tr><tr><td align="center">Electrical Backplane</td><td align="center">25GBASE-KR</td><td align="center">BASE-R FEC or RS-FEC</td></tr><tr><td align="center">Electrical Backplane</td><td align="center">25GBASE-KR-S</td><td align="center">BASE-R FEC or disabled</td></tr><tr><td align="center">Twisted Pair</td><td align="center">25GBASE-T</td><td align="center">N/A</td></tr></tbody></table><p>The IEEE standard specifies two backplane and copper interfaces. These have different goals, hence the different interface. The S short reach interfaces aim to support high-quality cables without Forward Error Correction (FEC) to minimize latency. Full reach interfaces aimto support the lowest possible cable or backplane cost and the longest possible reach, which do require the use of FEC. FEC options include BASE-R FEC (also referred to as Fire Code) and RS-FEC (also referred to as Reed-Solomon). RS-FEC has been used for a range of applications including data storage satellite transmissions. BASE-R FEC is a newer technology that is particularly well suited for correction of the burst errors<br>typical in a backplane channel resulting from error propagation in the receive equalizer.</p><p>IEEE S FEC<br>FECFEC <br> BASE-R FEC Fire Code RS-FEC Reed-SolomonRS-FEC BASE-R FEC </p><h3 id="Tune-adm-policy"><a href="#Tune-adm-policy" class="headerlink" title="Tune-adm policy"></a>Tune-adm policy</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default config files</span></span><br><span class="line">$ ls /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">tuned</span></span></span><br><span class="line">balanced  desktop  functions  latency-performance  network-latency  network-throughput  powersave  recommend.d  throughput-performance  virtual-guest  virtual-host</span><br><span class="line"></span><br><span class="line">$ tuned-adm list</span><br><span class="line">$ tuned-adm profile network-throughput</span><br><span class="line">$ tuned-adm active</span><br></pre></td></tr></table></figure><p>Custom tuned.conf</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="regexp">/etc/</span>tuned/my-variables.conf</span><br><span class="line"></span><br><span class="line">[variables]</span><br><span class="line"><span class="keyword">include</span>=<span class="regexp">/etc/</span>tuned/my-variables.conf</span><br><span class="line"></span><br><span class="line">[bootloader]</span><br><span class="line">cmdline=isolcpus=<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="CPU-setting"><a href="#CPU-setting" class="headerlink" title="CPU setting"></a>CPU setting</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cpupower  frequency-set -g performance</span><br><span class="line">cpupower idle-set -d 3</span><br><span class="line">cpupower idle-set -d 2</span><br><span class="line">cpupower idle-set -d 1</span><br><span class="line">cpupower idle-set -d 0</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> performance &gt; /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line"></span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get local cpus</span></span><br><span class="line">$ cat /sys/class/net/eth7/device/local_cpus</span><br><span class="line">0000,000fffc0,00000000,0fffc000</span><br></pre></td></tr></table></figure><h3 id="nic-offload"><a href="#nic-offload" class="headerlink" title="nic offload"></a>nic offload</h3><table><thead><tr><th>Features</th><th>status</th></tr></thead><tbody><tr><td>TSO TCP Segmentation Offload</td><td>hardware on</td></tr><tr><td>GSO Generic Segmentation Offload,soft TSO</td><td>software off</td></tr><tr><td>GRO Generic Receive Offload/LRO</td><td>hardware on, options ixgbe LRO=1</td></tr><tr><td>UFO UDP Fragmentation Offload</td><td>hardware off fixed</td></tr><tr><td>rx-checksumming</td><td>hardware on</td></tr><tr><td>tx-checksumming</td><td>hardware on</td></tr><tr><td>scatter-gather</td><td>hardware on</td></tr><tr><td>RSS Receive side scaling</td><td>hardware on</td></tr><tr><td>RPS software RSS</td><td>software off</td></tr><tr><td>RFS Receive Flow Streering,UDP support ?</td><td>software on</td></tr><tr><td>XPS Transmit Packet Steering</td><td>software on</td></tr><tr><td>busy-poll: on fixed</td><td>hw and sw, work with sysctl.net.core.busy_poll &gt; 0</td></tr></tbody></table><p>TSO = LSO (also called large segmentation offload)<br>RFS and XPS has the same function from receive or transmit, avoid cache miss, numa overhead<br>Receive Packet Steering (RPS) is logically a software implementation of RSS<br>Generic segmentation offload (GSO) is logically a software implementation of TSO</p><p>if TSO was on, disable GSO, same with RSS and RPS</p><p>Enabling the RFS requires enabling the ntuple flag via the ethtool,RFS requires the kernel to be compiled with the CONFIG_RFS_ACCEL option. This options is available in kernels 2.6.39 and above. Furthermore, RFS requires Device Managed Flow Steering support.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool --offload enp5s0 rx on tx on</span><br><span class="line">Actual changes:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">tx-checksum-ipv4: on</span><br><span class="line">tx-checksum-ipv6: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">tx-tcp-segmentation: on</span><br><span class="line">tx-tcp6-segmentation: on</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable TSO</span></span><br><span class="line"><span class="comment"># If your NIC not support TSO, you could enable GSO</span></span><br><span class="line">$ ethtool -K enp4s0 tso on</span><br><span class="line">$ ethtool -K enp4s0 gso off</span><br><span class="line">$ ethtool -K ethX rx on  <span class="comment">## rx-checksuming tcp offload</span></span><br><span class="line">$ ethtool -K ethX sg on  <span class="comment">## tcp-sgmentation offloading</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#In case tx-nocache-copy is enabled, (this is the case for some kernels, e.g. kernel 3.10, which is the default for RH7.0) tx-nocache-copy should be disabled.</span></span><br><span class="line">$ ethtool -K ethX tx-nocache-copy off</span><br></pre></td></tr></table></figure><p><a href="(https://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters_Archive.pdf">100GbE setting</a></p><h4 id="Resize-the-hardware-buffer-queue-to-max"><a href="#Resize-the-hardware-buffer-queue-to-max" class="headerlink" title="Resize the hardware buffer queue to max"></a>Resize the hardware buffer queue to max</h4><p>Reduce the number of packets being dropped by increasing the size of the queue so that the it does not overflow as easily</p><p>big buffer will cause high latency with the throughput setting</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -G enp1s0f0 RX 4096 TX 4096</span><br><span class="line">$ ethtool -g enp1s0f0</span><br><span class="line">Ring parameters <span class="keyword">for</span> enp1s0f0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:4096</span><br><span class="line">RX Mini:0</span><br><span class="line">RX Jumbo:0</span><br><span class="line">TX:4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:4096</span><br><span class="line">RX Mini:0</span><br><span class="line">RX Jumbo:0</span><br><span class="line">TX:4096</span><br></pre></td></tr></table></figure><h4 id="setting-driver"><a href="#setting-driver" class="headerlink" title="setting driver"></a>setting driver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/modprobe.d/ixgbe.conf</span><br><span class="line">options ixgbe allow_unsupported_sfp=1,1</span><br><span class="line">options ixgbe MQ=1,1 RSS=8,8 <span class="comment"># I don &#x27;t think too many CPU is a good setting</span></span><br><span class="line">options ixgbe LRO=1</span><br><span class="line">options ixgbe InterruptThrottleRate=20000,20000</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsupport optical module</span></span><br><span class="line">$ modprobe ixgbe allow_unsupported_sfp=1,1</span><br></pre></td></tr></table></figure><p>MQ:Disable or enable Multiple Queues, default 1 (array of int)<br>RSS:Number of Receive-Side Scaling Descriptor Queues, default 0=number of cpus (array of int)<br>InterruptThrottleRate:Maximum interrupts per second, per vector, (0,1,956-488281), default 1 (array of int)<br>LRO:Large Receive Offload (0,1), default 0 = off (array of int)</p><h3 id="Interrupt-Queues"><a href="#Interrupt-Queues" class="headerlink" title="Interrupt Queues"></a>Interrupt Queues</h3><h4 id="Busy-Polling"><a href="#Busy-Polling" class="headerlink" title="Busy Polling"></a>Busy Polling</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">                        high-latency</span><br><span class="line">interrupt-based -----------------------------&gt; poll-based</span><br></pre></td></tr></table></figure><p>Busy polling helps reduce latency in the network receive path by allowing socket layer code to poll the receive queue of a network device, and disabling network interrupts. </p><p><code>This removes delays caused by the interrupt and the resultant context switch.</code><br>However, <code>it also increases CPU utilization</code>. Busy polling also prevents the CPU from sleeping, which can incur additional power consumption.</p><p>single queue map single cpu core, avoid lock or race cpu resource </p><p>kernel 3.11 support SO_BUSY_POLL<br>Busy polling is disabled by default (sysctl.net.core.busy_poll = 0)<br>This parameter controls the number of microseconds to wait for packets on the device queue for socket poll and selects. Red Hat recommends a value of 50</p><p>To enable busy polling globally<br>you must also set sysctl.net.core.busy_read to a value other than 0.<br>This parameter controls the number of microseconds to wait for packets on the device queue for socket reads.<br>It also sets the default value of the SO_BUSY_POLL option. </p><p>Red Hat recommends a value of 50 for a small number of sockets, and a value of 100 for large numbers of sockets. For extremely large numbers of sockets (more than several hundred), use epoll(kernel 4.12) instead.</p><p><a href="https://oxnz.github.io/2016/05/03/performance-tuning-networking/">Busy polling helps reduce latency in the network receive path by</a></p><ul><li>allowing socket layer code to poll the receive queue of a network device </li><li>and disable network interrupts</li></ul><p>delays caused by the interrupts and the resultant context switches<br>increses CPU utilization.Also prevent the CPU from sleeping, which can incur additional power comsumption.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sw</span></span><br><span class="line">net.core.busy_poll = 50 <span class="comment"># default 0</span></span><br><span class="line">net.core.busy_read = 100 <span class="comment"># default 0, redhat recommand only 50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#hw</span></span><br><span class="line">$ethtool -k device | grep <span class="string">&quot;busy-poll&quot;</span></span><br><span class="line">busy-poll: on [fixed]</span><br></pre></td></tr></table></figure><p>Busy polling behavior is supported by the following drivers. These drivers are also supported on Red Hat Enterprise Linux 7.1<br>driver support: bnx2x,be2net,ixgbe,mlx4,myri10ge</p><p>mlx4 driver with busy polling</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rx-usecs: 16</span><br><span class="line">rx-frames: 44</span><br></pre></td></tr></table></figure><p><a href="http://www.cnhalo.net/2017/07/24/linux-busy-poll/">netperf TCP_RR 1 byte payload each way, 3.11 kernel,default 17500tps, busy poll could reach 6300tps</a></p><h3 id="Socket-receive-queues"><a href="#Socket-receive-queues" class="headerlink" title="Socket receive queues"></a>Socket receive queues</h3><h4 id="Change-the-speed-of-the-incoming-queue"><a href="#Change-the-speed-of-the-incoming-queue" class="headerlink" title="Change the speed of the incoming queue"></a>Change the speed of the incoming queue</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/net/core/dev_weight</span><br><span class="line">64</span><br><span class="line"><span class="comment">#64 was default value</span></span><br></pre></td></tr></table></figure><p>The maximum number of packets that kernel can handle on a NAPI interrupt, its a Per-CPU variable. For drivers that support LRO HW or GRO_HW, a hardware aggregated packet is counted as one packet in this context</p><p>Altering the drain rate of a queue is usually the simplest way to mitigate poor network performance. However, increasing the number of packets that a device can receive at one time uses additional processor time, during which no other processes can be scheduled, so this can cause other performance problems</p><p>Device weight refers to the number of packets a device can receive at one time (in a single scheduled processor access). You can increase the rate at which a queue is drained by increasing its device weight, which is controlled by the dev_weight parameter.</p><p>it will increase CPU overhead</p><p>Altering the drain rate of a queue is usually the simplest way to mitigate poor network performance. However, increasing the number of packets that a device can receive at one time uses additional processor time, during which no other processes can be scheduled, so this can cause other performance problems.</p><h5 id="Increase-the-depth-of-the-applications-socket-queue"><a href="#Increase-the-depth-of-the-applications-socket-queue" class="headerlink" title="Increase the depth of the applications socket queue"></a>Increase the depth of the applications socket queue</h5><p>Increase the value of /proc/sys/net/core/rmem_default</p><ul><li>Decrease the speed of incoming traffic<ul><li>filter</li><li>dropping</li><li>lower devcei weight</li></ul></li><li>Increse the depth of the applications socket queue (not a long-term solution)</li></ul><p>This parameter controls the default size of the receive buffer used by sockets. This value must be smaller than or equal to the value of /proc/sys/net/core/rmem_max.</p><p>This parameter controls the maximum size in bytes of a sockets receive buffer. Use getsockopt to get current value</p><h4 id="Use-setsockopt-to-configure-a-larger-SO-RCVBUF-value-userspace"><a href="#Use-setsockopt-to-configure-a-larger-SO-RCVBUF-value-userspace" class="headerlink" title="Use setsockopt to configure a larger SO_RCVBUF value (userspace)"></a>Use setsockopt to configure a larger SO_RCVBUF value (userspace)</h4><p>This parameter controls the maximum size in bytes of a sockets receive buffer. Use the getsockopt system call to determine the current value of the buffer.</p><h4 id="RSS-IRQ-Affinity"><a href="#RSS-IRQ-Affinity" class="headerlink" title="RSS IRQ Affinity"></a><a href="https://access.redhat.com/solutions/2144921">RSS IRQ Affinity</a></h4><p>Get the PCIE device numa node</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/class/net/[interface]/device/numa_node</span><br><span class="line">$ cat /sys/devices/[PCI root]/[PCIe <span class="keyword">function</span>]/numa_node</span><br></pre></td></tr></table></figure><table><thead><tr><th>CPU</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr></thead><tbody><tr><td>bin</td><td>0001</td><td>0010</td><td>0100</td><td>1000</td><td>10000</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Deci</td><td>1</td><td>2</td><td>4</td><td>8</td><td>16</td><td>32</td><td>64</td><td>128</td><td>256</td><td>512</td><td>1024</td><td>2048</td><td>4096</td></tr><tr><td>Hex</td><td>1</td><td>2</td><td>4</td><td>8</td><td>10</td><td>20</td><td>40</td><td>80</td><td>100</td><td>200</td><td>400</td><td>800</td><td>1000</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">printf</span> <span class="string">&#x27;%x\n&#x27;</span> <span class="string">&quot;<span class="subst">$((2#10101010101)</span>)&quot;</span></span><br><span class="line">555 <span class="comment">#numa_node0</span></span><br><span class="line"></span><br><span class="line">$ awk -F: <span class="string">&#x27;$0~/enp5/ || $0~/mlx4/ &#123;print $1&#125;&#x27;</span> /proc/interrupts | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 555 &gt; /proc/irq/<span class="variable">$line</span>/smp_affinity</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#For example, to handle interrupts with CPUs 0, 1, 2, and 3, set the value of rps_cpus to f, which is the hexadecimal value for 15. In binary representation, 15 is 00001111 (1+2+4+8).</span></span><br><span class="line"></span><br><span class="line">or you could</span><br><span class="line">/sys/class/net</span><br><span class="line">eno1 -&gt; ../../devices/pci0000:17/0000:17:02.0/0000:18:00.0/net/eno1</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /sys/devices/pci0000:17/0000:17:02.0/0000:18:00.0</span><br><span class="line">$ ls /sys/devices/pci0000:17/0000:17:02.0/0000:18:00.0/msi_irqs</span><br><span class="line">56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85</span><br><span class="line">$ ls -l /sys/devices/pci0000:17/0000:17:02.0/0000:18:00.0/msi_irqs</span><br><span class="line"></span><br><span class="line"><span class="comment">#intel</span></span><br><span class="line">$ set_irq_affinity -x all ethX</span><br><span class="line">$ set_irq_affinity -x <span class="built_in">local</span> ethX</span><br><span class="line">$ set_irq_affinity 1-2 ethX</span><br><span class="line"></span><br><span class="line"><span class="comment">#mellanox</span></span><br><span class="line">set_irq_affinity_bynode.sh 0 p7p1</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">printf</span> %0.2x<span class="string">&#x27;\n&#x27;</span> 1024</span><br><span class="line">400</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">printf</span> %0.2x<span class="string">&#x27;\n&#x27;</span> 4096</span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 400 &gt; /proc/irq/66/smp_affinity</span><br><span class="line">$ <span class="built_in">echo</span> 400 &gt; /proc/irq/67/smp_affinity</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; /proc/irq/69/smp_affinity</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; /proc/irq/70/smp_affinity</span><br></pre></td></tr></table></figure><p>When configuring RSS, Red Hat recommends <code>limiting the number of queues to one per physical CPU core</code><br>Hyper-threads are often represented as separate cores in analysis tools, but configuring queues for all cores including logical cores such as <code>hyper-threads has not proven beneficial to network performance</code></p><p>When enabled, RSS distributes network processing equally between available CPUs based on the amount of processing each CPU has queued. However, you can use the ethtool show-rxfh-indir and set-rxfh-indir parameters to modify how network activity is distributed, and weight certain types of network activity as more important than others.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool --set-rxfh-indir enp1s0f0 equal 4</span><br><span class="line">$ watch -d  -n 1 <span class="string">&quot;cat /proc/interrupts | grep enp1s0f0&quot;</span></span><br><span class="line"><span class="comment"># You could see only 4 interrupt number increase a lot</span></span><br><span class="line"></span><br><span class="line">$ ethtool --show-rxfh-indir enp1s0f0</span><br><span class="line">$ ethtool -x enp1s0f0</span><br><span class="line"><span class="comment">## You can set priority for each queue.</span></span><br><span class="line">RX flow <span class="built_in">hash</span> indirection table <span class="keyword">for</span> p4p1 with 48 RX ring(s):</span><br><span class="line">    0:      0     1     2     3     4     5     6     7</span><br><span class="line">    8:      8     9    10    11    12    13    14    15</span><br><span class="line">   16:     16    17    18    19    20    21    22    23</span><br><span class="line">   24:     24    25    26    27    28    29    30    31</span><br><span class="line">   32:     32    33    34    35    36    37    38    39</span><br><span class="line">   40:     40    41    42    43    44    45    46    47</span><br><span class="line">   48:      0     1     2     3     4     5     6     7</span><br><span class="line">   56:      8     9    10    11    12    13    14    15</span><br><span class="line">   64:     16    17    18    19    20    21    22    23</span><br><span class="line">   72:     24    25    26    27    28    29    30    31</span><br><span class="line">   80:     32    33    34    35    36    37    38    39</span><br><span class="line">   88:     40    41    42    43    44    45    46    47</span><br><span class="line">   96:      0     1     2     3     4     5     6     7</span><br><span class="line">  104:      8     9    10    11    12    13    14    15</span><br><span class="line">  112:     16    17    18    19    20    21    22    23</span><br><span class="line">  120:     24    25    26    27    28    29    30    31</span><br><span class="line"><span class="comment">### 16 (line) x 8 (column) = 128, total 128 value, that means indirection table = 128, total 48 RX rings</span></span><br><span class="line"><span class="comment">### eg: line &quot;96:&quot; second field(1), means 98th hash data equal 2, the data will go to second queue</span></span><br><span class="line"><span class="comment">### ethtool -X eth0 weight 6 5 4 3 2 1 .... , you can set 48 x weights, 48 data sum will not large than 128</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set weight for the queue</span></span><br><span class="line">$ ethtool --set-rxfh-indir eth3 weight 6 2</span><br><span class="line">$ ethtool --set-rxfh-indir eth3 weight 1 2</span><br></pre></td></tr></table></figure><p><code>The irqbalance daemon can be used in conjunction with RSS to reduce the likelihood of cross-node memory transfers and cache line bouncing. This lowers the latency of processing network packets.</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> irqbalance</span><br><span class="line">$ systemctl start irqbalance</span><br><span class="line"><span class="comment"># debug irqblaance</span></span><br><span class="line">$ irqbalance -d -f</span><br></pre></td></tr></table></figure><h5 id="Support-for-UDP-RSS"><a href="#Support-for-UDP-RSS" class="headerlink" title="Support for UDP RSS"></a><a href="https://downloadmirror.intel.com/22919/eng/README.txt">Support for UDP RSS</a></h5><p>   rx-flow-hash tcp4|udp4|ah4|esp4|sctp4|tcp6|udp6|ah6|esp6|sctp6<br>     Retrieves the hash options for the specified network traffic type.</p><p>  -N config-nfc<br>     Configures the receive network flow classification.</p><p>   rx-flow-hash tcp4|udp4|ah4|esp4|sctp4|tcp6|udp6|ah6|esp6|sctp6<br>   m|v|t|s|d|f|n|r<br>     Configures the hash options for the specified network traffic type.</p><pre><code> udp4    UDP over IPv4 udp6    UDP over IPv6 f   Hash on bytes 0 and 1 of the Layer 4 header of the rx packet. n   Hash on bytes 2 and 3 of the Layer 4 header of the rx packet.</code></pre><p>The following is an example using udp4 (UDP over IPv4):</p><p>  To include UDP port numbers in RSS hashing run:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ethtool</span> -N ethX rx-flow-hash udp<span class="number">4</span> sdfn</span><br></pre></td></tr></table></figure><p>  To exclude UDP port numbers from RSS hashing run:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ethtool</span> -N ethX rx-flow-hash udp<span class="number">4</span> sd</span><br></pre></td></tr></table></figure><p>  To display UDP hashing current configuration run:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ethtool</span> -n ethX rx-flow-hash udp<span class="number">4</span></span><br></pre></td></tr></table></figure><p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index">redhat performance tuning guide</a><br><a href="https://fasterdata.es.net/host-tuning/100g-tuning/">100GbE tuning</a><br><a href="https://www.intel.com/content/dam/www/public/us/en/documents/reference-guides/xl710-x710-performance-tuning-linux-guide.pdf">xl710-x710-performance-tuning-linux-guide</a></p><p>Receive Packet Steering (RPS) is similar to RSS in that it is used to direct packets to specific CPUs for processing. However, RPS is implemented at the software level, and helps to prevent the hardware queue of a single network interface card from becoming a bottleneck in network traffic.<br>Does the all cpu cores share a  hardware-based receive queues ?</p><h3 id="Receive-Flow-Streering-RFS"><a href="#Receive-Flow-Streering-RFS" class="headerlink" title="Receive Flow Streering (RFS)"></a>Receive Flow Streering (RFS)</h3><p>Receive Flow Steering (RFS) extends RPS/RSS behavior to increase the CPU cache hit rate and thereby reduce network latency. Where RPS forwards packets based solely on queue length, RFS uses the RPS backend to calculate the most appropriate CPU, then forwards packets based on the location of the application consuming the packet. This increases CPU cache efficiency.</p><p>RFS is disabled by default. To enable RFS, you must edit two files:<br>/proc/sys/net/core/rps_sock_flow_entries</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 32768 &gt; /proc/sys/net/core/rps_sock_flow_entries</span><br><span class="line">$ <span class="keyword">for</span> f <span class="keyword">in</span> /sys/class/net/ens6/queues/rx-*/rps_flow_cnt; <span class="keyword">do</span> <span class="built_in">echo</span> 4096 &gt; <span class="variable">$f</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>Set the value of this file to the maximum expected number of concurrently active connections. We recommend a value of 32768 for moderate server loads. All values entered are rounded up to the nearest power of 2 in practice.</p><p>Set the value of this file to the value of rps_sock_flow_entries divided by N, where N is the number of receive queues on a device. For example, if rps_flow_entries is set to 32768 and there are 16 configured receive queues, rps_flow_cnt should be set to 2048(I improve it to 4096). For single-queue devices, the value of rps_flow_cnt is the same as the value of rps_sock_flow_entries.</p><p>Data received from a single sender is not sent to more than one CPU. If the amount of data received from a single sender is greater than a single CPU can handle, configure a larger frame size to reduce the number of interrupts and therefore the amount of processing work for the CPU.</p><p>About large frame </p><ul><li>large mtu</li><li>TCP Segmentation Offload, merge to large than mtu size</li></ul><p>Consider using numactl or taskset in conjunction with RFS to pin applications to specific cores, sockets, or NUMA nodes. This can help prevent packets from being processed out of order.</p><h5 id="Accelerated-RFS"><a href="#Accelerated-RFS" class="headerlink" title="Accelerated RFS"></a>Accelerated RFS</h5><p>RFS and accelerated RFS (aRFS) are kernel features currently available in most distributions. The aRFS feature requires explicit configuration in order to enable it.<br>it need the driver support</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_RFS_ACCEL=y</span><br><span class="line">CONFIG_MLX5_EN_ARFS=y</span><br></pre></td></tr></table></figure><p>Accelerated RFS boosts the speed of RFS by adding hardware assistance. Like RFS, packets are forwarded based on the location of the application consuming the packet. Unlike traditional RFS, however, packets are sent directly to a CPU that is local to the thread consuming the data: either the CPU that is executing the application, or a CPU local to that CPU in the cache hierarchy.<br>Accelerated RFS is only available if the following conditions are met:<br>Accelerated RFS must be supported by the network interface card. Accelerated RFS is supported by cards that export the ndo_rx_flow_steer() netdevice function.<br>ntuple filtering must be enabled.</p><p>CPU to queue mapping is deduced based on the IRQ affinities configured by the driver for each receive queue.</p><ol><li>RFS enabled</li><li>CONFIG_RFS_ACCEL enabled</li><li>Enable ntuple</li><li>Configure your IRQ settings to ensure each RX queue is handled by one of your desired network processing CPUs.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default ATR automated Application Targeting Routing</span></span><br><span class="line">$ ethtool -K ens6 ntuple on</span><br><span class="line">$ ethtool -k ens6</span><br><span class="line">ntuple-filters: on</span><br><span class="line">$ systemctl stop irqbalance</span><br><span class="line"><span class="comment">#Configure your IRQ settings to ensure each RX queue is handled by one of your desired network processing CPUs.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Custom policy</span></span><br><span class="line">$ ethtool -u eth0</span><br><span class="line">40 RX rings available</span><br><span class="line">Total 0 rules</span><br><span class="line"><span class="comment">### dest port 80 go to rx queue 2</span></span><br><span class="line">$ ethtool -U eth0 flow-type tcp4 dst-port 80 action 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you are mellanox NIC</span></span><br><span class="line">$ show_irq_affinity.sh ens6</span><br><span class="line"></span><br><span class="line"><span class="comment">### Custom policy, EP(Externally Programed) mode</span></span><br><span class="line">$ ethtool --config-ntuple eth2 flow-type ip4 src-ip 192.168.100.1  action -1</span><br><span class="line">$ ethtool --config-ntuple eth2 flow-type tcp4 src-port 80  action 2</span><br><span class="line">$ ethtool --config-ntuple eth2 flow-type udp4 src-port 80  action 2</span><br><span class="line"></span><br><span class="line"><span class="comment">#To specify that all traffic from 10.23.4.6 to 10.23.4.18 be placed in queue 4, issue this command:</span></span><br><span class="line">$ ethtool --config-ntuple flow-type tcp4 src-ip 10.23.4.6 dst-ip 10.23.4.18 action 4</span><br><span class="line"></span><br><span class="line"><span class="comment">#Forwards to queue 2 all IPv4 TCP traffic from 192.168.10.1:2000 that is going to 192.168.10.2:2001, placing the filter at position 33 of the Perfect-Match filter table (and overwriting any rule currently in that position):</span></span><br><span class="line">$ ethtool --config-ntuple &lt;interface name&gt; flow-type tcp4 src-ip 192.168.10.1 dst-ip 192.168.10.2 src-port 2000 dst-port 2001 action 2 loc 33</span><br><span class="line"></span><br><span class="line"><span class="comment">#Drops all UDP packets from 10.4.83.2:</span></span><br><span class="line">$ ethtool --config-ntuple flow-type udp4 src-ip 10.4.82.2 action -1</span><br><span class="line"><span class="comment">#Note: The VLAN field is not a supported filter with the i40e driver (Intel Ethernet Controller XL710 and Intel Ethernet Controller X710 NICs).</span></span><br><span class="line"><span class="comment">#For more information and options, see the ethtool man page documentation on the -U, -N, or --config-ntuple option.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List</span></span><br><span class="line">$ ethtool --show-ntuple p2p1</span><br><span class="line">10 RX rings available</span><br><span class="line">Total 0 rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># Remove</span></span><br><span class="line">$ ethtool --config-ntuple &lt;interface name&gt; delete N</span><br><span class="line"></span><br><span class="line"><span class="comment"># There&#x27;s generic flow steering rule configuration interface on ethtool, called RX NFC.</span></span><br><span class="line">$ ethtool --config-nfc ix00 flow-type tcp4 src-ip 10.0.0.1 dst-ip 10.0.0.2 src-port 10000 dst-port 10001 action 6</span><br><span class="line">Added rule with ID 2045</span><br><span class="line">$ ethtool --show-nfc ix00</span><br><span class="line">12 RX rings available</span><br><span class="line">Total 1 rules</span><br><span class="line">Filter: 2045</span><br><span class="line">     Rule Type: TCP over IPv4</span><br><span class="line">     Src IP addr: 10.0.0.1 mask: 0.0.0.0</span><br><span class="line">     Dest IP addr: 10.0.0.2 mask: 0.0.0.0</span><br><span class="line">     TOS: 0x0 mask: 0xff</span><br><span class="line">     Src port: 10000 mask: 0x0</span><br><span class="line">     Dest port: 10001 mask: 0x0</span><br><span class="line">     VLAN EtherType: 0x0 mask: 0xffff</span><br><span class="line">     VLAN: 0x0 mask: 0xffff</span><br><span class="line">     User-defined: 0x0 mask: 0xffffffffffffffff</span><br><span class="line">     Action: Direct to queue 6</span><br></pre></td></tr></table></figure><p><a href="https://community.mellanox.com/s/article/howto-configure-arfs-on-connectx-4">monitor</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S eno1 | egrep rx.*pack</span><br><span class="line"><span class="comment"># disable</span></span><br><span class="line">$ ethtool -K ens6 ntuple off</span><br><span class="line"></span><br><span class="line">$ taskset -c 5 netserver &amp;</span><br><span class="line">$ netperf -H <span class="variable">$ipaddr</span> -l 200 -t TCP_STREAM &amp;</span><br><span class="line"></span><br><span class="line">$ ethtool -S ens6 | egrep rx.*pack</span><br><span class="line"><span class="comment"># only rx8 improved</span></span><br><span class="line">rx7_packets: 0</span><br><span class="line">rx7_lro_packets: 0</span><br><span class="line">rx8_packets: 6296748</span><br><span class="line">rx8_lro_packets: 0</span><br><span class="line">rx9_packets: 0</span><br><span class="line"></span><br><span class="line">$ ethtool -K ens6 ntuple on</span><br><span class="line">$ taskset -c 5 netserver &amp;</span><br><span class="line">$ netperf -H 11.134.201.5 -l 200 -t TCP_STREAM &amp;</span><br><span class="line">$ ethtool -S ens6 | egrep rx.*pack</span><br><span class="line">rx5_packets: 234532 <span class="comment"># only rx5 increase, it s worked</span></span><br><span class="line">rx5_lro_packets: 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># mellanox enable the driver arfs</span></span><br><span class="line">$ enable_arfs.sh ens6</span><br></pre></td></tr></table></figure><h3 id="Interrupt-Moderation-interrupt-coalescence-or-Interrupt-Blanking"><a href="#Interrupt-Moderation-interrupt-coalescence-or-Interrupt-Blanking" class="headerlink" title="Interrupt Moderation (interrupt coalescence or Interrupt Blanking)"></a>Interrupt Moderation (interrupt coalescence or Interrupt Blanking)</h3><p>parm:           InterruptThrottleRate:Maximum interrupts per second, per vector, (0,1,956-488281), default 1 (array of int) </p><p>0 = Setting InterruptThrottleRate to 0 turns off any interrupt moderation and may improve small packet latency, but is generally not suitable for bulk throughput traffic due to the increased cpu utilization of the higher interrupt rate. Please note that on 82599-based adapters, disabling InterruptThrottleRate will also result in the driver disabling HW RSC(receive side coalescing).</p><p>HW RSC looks like TCP Segmentation offload or GSO, merge 1500~9000 mtu to a large frame(65536 or more), you could get it by tcpdump</p><p>On 82598-based adapters, disabling InterruptThrottleRate will also result in disabling LRO (Large Receive Offloads).</p><p>1 = Dynamic mode attempts to moderate interrupts per vector while maintaining very low latency. <code>This can sometimes cause extra CPU utilization.</code><br>If planning on deploying ixgbe in a latency sensitive environment please consider this parameter.</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe ixgbe InterruptThrottleRate=<span class="number">8000</span>,<span class="number">4000</span></span><br></pre></td></tr></table></figure><p>956-488281, Interrupt Throttle Rate (interrupts/sec). The ITR parameter controls how many interrupts each interrupt vector can generate per second. On MQ/RSS enabled kernels with MSI-X interrupts this means that each RX vector can generate 8000 interrupts per second and each TX vector can generate 4000 interrupts per second. Increasing ITR lowers latency at the cost of increased CPU utilization, though it may help throughput in some circumstances.</p><p><code>Note: Adaptive moderation must be disabled in order to ensure that static values are in use.</code><br>It is possible to change the values for ethtool as well:</p><p>Mellanox example</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C eth4 rx-usecs <span class="number">0</span> rx-frames <span class="number">10</span> tx-usecs <span class="number">16</span> tx-frames <span class="number">100</span></span><br><span class="line">$ ethtool -c eth4</span><br></pre></td></tr></table></figure><p>if you need to improve value of rx-usecs, improve latency and througput, and suggestion improve </p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#must tso could be enabled</span></span><br><span class="line">$ ethtool -K eth2 tso <span class="keyword">on</span> </span><br><span class="line">$ net.ipv4.tcp_tso_win_divisor = <span class="number">30</span> <span class="comment">#default 3</span></span><br></pre></td></tr></table></figure><p>This allows control over what percentage of the congestion window can be consumed by a single TSO frame. The setting of this parameter is a choice between burstiness and building larger TSO frames.</p><p>rx-frames[-irq] rx-usecs[-irq] tx-frames[-irq] tx-usecs[-irq]<br>The range of 0-235 microseconds provides an effective range of 4,310 to 250,000 interrupts per second. The value of rx-secs-high can be set independent of rx-secs and tx-secs in the same ethtool command, and is also independent of the adaptive interrupt moderation algorithm. The underlying hardware supports granularity in 2-microsecond intervals, so adjacent values might result in the same interrupt rate.</p><p>DIM is enabled by default. In case you wish to disable it. in some spcical case, you will modify these interrupt options<br><a href="https://community.mellanox.com/s/article/dynamically-tuned-interrupt-moderation--dim-x">not recommended disable Dynamically Interrupt Moderation</a></p><ul><li><a href="https://www.ibm.com/support/knowledgecenter/en/SSQPD3_2.6.0/com.ibm.wllm.doc/usingethtoolrates.html">adaptive-rx Dynamic control to decrease RX latency at low packet rates and increase throughput at high packet rates</a></li><li>rx-usecs This is the number of microseconds to wait before raising an RX interrupt after a packet has been received. When rx-usecs is set to 0 rx-frames is used</li><li>rx-frames     This is the number of frames to queue up before raising an RX interrupt.</li><li>adaptive-tx Dynamic control to decrease TX latency at low packet rates and increase throughput at high packet rates</li><li>tx-usecs This is the number of microseconds to wait before raising an TX interrupt after a packet has been sent. When tx-usecs is set to 0 tx-frames is used</li><li>tx-frames This is the number of frames to queue up before raising an TX interrupt</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#To turn on adaptive interrupt moderation, recommand</span></span><br><span class="line">$ ethtool -C ethX adaptive-rx on adaptive-tx on</span><br><span class="line"></span><br><span class="line"><span class="comment">#To turn off adaptive interrupt moderation</span></span><br><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off</span><br></pre></td></tr></table></figure><p>A good place to start for general tuning is 84 s, or ~12000 interrupts/s. If you see rx_dropped counters are running during traffic (using ethtool -S ethX) then you probably have too slow of a CPU, not enough buffers from the adapters ring size (ethtool -G) to hold packets for 84 s or to low of an interrupt rate.<br>That mean CPU too slower or kernel handler too slower.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off rx-usecs 84 tx-usecs 84</span><br></pre></td></tr></table></figure><p>The next value to try, if you are not maxed out on CPU utilization, is 62 s. This uses more CPU, but it services buffers faster, and requires fewer descriptors (ring size, ethtool -G). </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off rx-usecs 62 tx-usecs 62</span><br></pre></td></tr></table></figure><p>If your CPU is at 100%, then increasing the interrupt rate is not advised. In certain circumstances such as a CPU bound workload, you might want to increase the s value to enable more CPU time for other applications.</p><p>If you require low latency performance and/or have plenty of CPU to devote to network processing, you can disable interrupt moderation entirely, which enables the interrupts to fire as fast as possible.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -C ethX adaptive-rx off adaptive-tx off rx-usecs 0 tx-usecs 0</span><br></pre></td></tr></table></figure><p>Totaly, tx,rx-usecs value the lower means the smaller frame to interrupt moderation. the more cpu overhead and the lower latency<br>increase tx,tx-usecs that means high latency and get the biger frame to interrupt moderation, the lower cpu overhead and high latency and high througput, it will impact tcp performance, so increase tcp_tso_win_divisor to 30</p><p>If cache pressure is suspected (many queues active) reducing buffers from default can help Intel Data Direct I/O (Intel DDIO) operate with better efficiently. Intel recommends trying 128 or 256 per queue, being aware that an increase in interrupt rate via ethtool -C might be necessary to avoid an increase in rx_dropped.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -G eth12 rx 256 tx 256</span><br></pre></td></tr></table></figure><p>Change the Tx and Rx ring sizes as needed, a larger value takes more resources but can provide better forwarding rates:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -G ethX rx 4096 tx 4096</span><br></pre></td></tr></table></figure><p>Layer 2 flow control can impact TCP performance considerably and is recommended to be disabled for most workloads</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -A ethX rx off tx off</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -c enp4s0d1</span><br><span class="line">Coalesce parameters <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">Adaptive RX: off  TX: off</span><br><span class="line">stats-block-usecs: 0</span><br><span class="line">sample-interval: 0</span><br><span class="line">pkt-rate-low: 400000</span><br><span class="line">pkt-rate-high: 450000</span><br><span class="line"></span><br><span class="line">rx-usecs: 0</span><br><span class="line">rx-frames: 0</span><br><span class="line">rx-usecs-irq: 0</span><br><span class="line">rx-frames-irq: 0</span><br><span class="line"></span><br><span class="line">tx-usecs: 8</span><br><span class="line">tx-frames: 16</span><br><span class="line">tx-usecs-irq: 0</span><br><span class="line">tx-frames-irq: 256</span><br><span class="line"></span><br><span class="line">rx-usecs-low: 0</span><br><span class="line">rx-frame-low: 0</span><br><span class="line">tx-usecs-low: 0</span><br><span class="line">tx-frame-low: 0</span><br><span class="line"></span><br><span class="line">rx-usecs-high: 128</span><br><span class="line">rx-frame-high: 0</span><br><span class="line">tx-usecs-high: 0</span><br><span class="line">tx-frame-high: 0</span><br><span class="line"></span><br><span class="line">$ ethtool -i p5p2</span><br><span class="line">driver: i40e</span><br><span class="line">version: 2.4.6</span><br><span class="line">firmware-version: 6.01 0x80003554 1.1747.0</span><br><span class="line">bus-info: 0000:05:00.1</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br><span class="line"></span><br><span class="line">$ ethtool -l p5p2</span><br><span class="line">Channel parameters <span class="keyword">for</span> p5p2:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:             0</span><br><span class="line">TX:             0</span><br><span class="line">Other:          1</span><br><span class="line">Combined:       64</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:             0</span><br><span class="line">TX:             0</span><br><span class="line">Other:          1</span><br><span class="line">Combined:       8</span><br><span class="line"></span><br><span class="line">$ ethtool -L enp1s0f1 combined 8  <span class="comment">#combined means tx and rx</span></span><br><span class="line">$ ethtool -L enp1s0f1 rx 8 </span><br><span class="line"></span><br><span class="line">$ ethtool -x eth0</span><br><span class="line"><span class="comment"># check rx flow hash indirection table for eth0</span></span><br><span class="line"></span><br><span class="line">$ ethtool -g p5p2</span><br><span class="line">Ring parameters <span class="keyword">for</span> p5p2:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:             4096</span><br><span class="line">RX Mini:        0</span><br><span class="line">RX Jumbo:       0</span><br><span class="line">TX:             4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:             512</span><br><span class="line">RX Mini:        0</span><br><span class="line">RX Jumbo:       0</span><br><span class="line">TX:             512</span><br></pre></td></tr></table></figure><p><a href="https://download.01.org/packet-processing/ONPS2.1/Intel_ONP_Release_2.1_Performance_Test_Report_Rev1.0.pdf">Intel_ONP_Release_2.1_performance_test_report</a></p><h3 id="disable-PCIE-power-save"><a href="#disable-PCIE-power-save" class="headerlink" title="disable PCIE power save"></a>disable PCIE power save</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;pcie_aspm=off&#x27;</span> --args=<span class="string">&#x27;intel_idle.max_cstate=0&#x27;</span> --args=<span class="string">&#x27;processor.max_cstate=1&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="disable-numa"><a href="#disable-numa" class="headerlink" title="disable numa"></a>disable numa</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>echo kernel.numa_balancing=0 &gt;&gt; <span class="regexp">/etc/sysctl</span>.conf</span><br><span class="line"><span class="variable">$ </span>sysctl -p</span><br></pre></td></tr></table></figure><h3 id="RFC2544-stipulates-that-the-latency-test"><a href="#RFC2544-stipulates-that-the-latency-test" class="headerlink" title="RFC2544 stipulates that the latency test"></a>RFC2544 stipulates that the latency test</h3><ul><li>Should be at least 120 seconds in duration</li><li>Frame sizes to be used on Ethernet 64, 128, 256, 512, 1024, 1280, and 1518</li><li>Should include an identifying tag in one frame after 60 seconds with the type of tag being implementation dependent</li><li>Records the time at which the frame is fully transmitted (timestamp A)</li><li>The receiver logic in the test equipment must recognize the tag information in the frame stream and record the time at which the tagged frame was received (timestamp B)</li><li>This test should be performed with the test frame addressed to the same destination as the rest of the data stream, and also with each of the test frames addressed to a new destination network</li><li>The test must be repeated at least 20 times with the reported value being the average of the recorded values</li><li>The latency is timestamp B minus timestamp A, as per the relevant definition from RFC</li></ul><h3 id="The-network-latency"><a href="#The-network-latency" class="headerlink" title="The network latency"></a><a href="https://www.marvell.com/documents/rjx203ukari4r93gntem/">The network latency</a></h3><p>There are new technologies that are pushing latencies into the singledigit microsecond range when measured back-to-back in benchmark<br>repeat 20 times and get the average result</p><p>50  125s   1Gb Ethernet (TCP/IP)</p><ul><li>Multi-tasking: multiple highbandwidth applications running<br>simultaneously</li><li>Bulk data transfer</li><li>Transactional database backup and<br>applications</li><li>Web (front-end for data centers)</li></ul><p>5  50s 10Gb Ethernet<br>(TCP/IP)</p><ul><li>Bulk data transfer</li><li>Real-time video streaming</li><li>Database backup and applications</li></ul><p>3  5s RDMA, RoCEE, and<br>iWARP</p><ul><li>High Performance Computing</li><li>High-Frequency Trading (HFT)</li><li>Inter-process communication (IPC)<br>cluster</li><li>Low-latency applications</li></ul><p>Sub-3s(less than 3s) InfiniBand (QDR)<br>and proprietary</p><ul><li>High Performance Computing</li><li>High Frequency Trading (HFT)</li><li>Ultra-low latency applications</li></ul><h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><h4 id="nc-test"><a href="#nc-test" class="headerlink" title="nc test"></a>nc test</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Server $ nc -l 22222 &lt; /dev/zero</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 &gt; /dev/null</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 | pv  <span class="comment"># show the speed</span></span><br></pre></td></tr></table></figure><h4 id="iperf3"><a href="#iperf3" class="headerlink" title="iperf3"></a>iperf3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ iperf3 -s -D -p 520<span class="variable">$i</span></span><br><span class="line">Client $ iperf3 -c <span class="variable">$client_ip</span> -P 1 -t 360000 -p 520<span class="variable">$i</span></span><br></pre></td></tr></table></figure><h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Server $ qperf -lp <span class="variable">$port</span> &amp;</span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 36000 -oo msg_size:1K:4K:*2 <span class="variable">$server_ip</span> tcp_bw </span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 60 -oo msg_size:64:1024K:*4 <span class="variable">$server_ip</span> tcp_lat</span><br></pre></td></tr></table></figure><h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Server $ taskset -c 5 netserver &amp;</span><br><span class="line">Client $ netperf -H <span class="variable">$ipaddr</span> -l 200 -t TCP_STREAM </span><br><span class="line"></span><br><span class="line">Server $ numactl -C 2 netserver -D  -4 -v 2 -p 5000 -f -L 192.168.12.201</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_STREAM -l 15 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t UDP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br></pre></td></tr></table></figure><h4 id="sockperf"><a href="#sockperf" class="headerlink" title="sockperf"></a>sockperf</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./sockperf<span class="built_in"> server </span>--tcp -p 11111</span><br><span class="line">./sockperf<span class="built_in"> server </span>-p 11111 #udp</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf tp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf pp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br></pre></td></tr></table></figure><h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ LD_PRELOAD=libvma.so VMA_STATS_FD_NUM=500 redis-server --port 7777  --protected-mode no --maxmemory 12000mb --maxmemory-samples 10 --maxmemory-policy allkeys-lru</span><br><span class="line">Client $ numactl -C 2 redis-benchmark -r 10000000 -n 20000000 -t get,<span class="built_in">set</span>,lpush,lpop -P 16 -q -h 192.168.12.201 -p 7777 -d 16</span><br></pre></td></tr></table></figure><h3 id="RFC6349-TCP-benchmark"><a href="#RFC6349-TCP-benchmark" class="headerlink" title="RFC6349 TCP benchmark"></a><a href="https://www.viavisolutions.com/zh-cn/literature/rfc-6349-testing-truespeed-viavi-solutions-experience-your-network-your-custom-application-notes-zh.pdf">RFC6349 TCP benchmark</a></h3><ul><li><p>RFC 4821 through PLPMTUD make sure network path mtu</p></li><li><p>benchmark RRT(Round-Trip Time) and BB(bottle neck bandwidth)</p><ul><li><p>example:RRT=25ms, bandwidth=45Mbps, window=64KB, receiver take 12.5ms to sender<br>BDP(bandwidth-delay product) = BB * RRT /8 = 140.625 KB, double sender s window size</p></li><li><p>TCP global synchronization</p></li><li><p>RWND(Receive Window)</p></li><li><p>CWND(Congestion Window)</p></li><li><p>LFN(Long fat network)</p></li><li><p>RTD(round-trip delay time)</p></li><li><p>TDP(Tail drop polocy)</p></li><li><p>tcp transfer time</p><ul><li>In the 500Mbps netowrk, start 5x transmit services, each transmit means 100Mbps, actually, the 5 x tansmit bandwith are not balancing. 5 x sender transfer 100MB file.<ul><li>500MB/(500Mbps/8)=8 sec, in fact, the test use 12sec, that means 12sec/8sec=1.5, 1.5x late than the theoretically</li></ul></li></ul></li><li><p>tcp efficiency</p><ul><li>(total bytes - retrans bytes)/total bytes * 100 = 98%, in our data center , there are 2 percent tcp retrans. that too bad in some times.</li></ul></li><li><p>tcp cache latency percent, (test average rrt - base rrt)/base rrt * 100, if base rrt= 25ms, in the test, the average rrt=32ms, (32-25)/25*100=28%, tcp RTD increase 28%(congestion)</p></li></ul></li><li><p>if the tcp performance not reach your expect</p><ul><li>re-gen tcp connection, and modify tcp rwnd size, mtu size</li><li>speed limit cause tail drop polocy and cause too many tcp retrans</li><li>the maximum tcp cache size, it limit by OS memory size, and to check tcp queue</li><li>socket buffer size, a lot of OS could modify the each connection receive and transmit buffer limit. the socket buffer must be large enough.</li></ul></li></ul><h4 id="irqbalance"><a href="#irqbalance" class="headerlink" title="irqbalance"></a>irqbalance</h4><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--powerthresh </span></span><br><span class="line"><span class="comment">--hintpolicy </span></span><br><span class="line"><span class="comment">--policyscript </span></span><br><span class="line"><span class="comment">--banirq</span></span><br><span class="line"><span class="comment">--ban </span></span><br><span class="line"><span class="comment">--balance_level </span></span><br><span class="line"><span class="comment">--numa_node</span></span><br></pre></td></tr></table></figure><h4 id="turbostat"><a href="#turbostat" class="headerlink" title="turbostat"></a>turbostat</h4><h4 id="numastat"><a href="#numastat" class="headerlink" title="numastat"></a>numastat</h4><h4 id="numad"><a href="#numad" class="headerlink" title="numad"></a>numad</h4><h4 id="OProfile"><a href="#OProfile" class="headerlink" title="OProfile"></a>OProfile</h4><h4 id="valgrind"><a href="#valgrind" class="headerlink" title="valgrind"></a>valgrind</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind <span class="attribute">--tool</span>=memcheck <span class="attribute">--leak-check</span>=<span class="literal">yes</span> <span class="attribute">--show-reachable</span>=<span class="literal">yes</span> <span class="attribute">--num-callers</span>=20 <span class="attribute">--track-fds</span>=<span class="literal">yes</span> ./lustre_exporter</span><br></pre></td></tr></table></figure><h4 id="intel-cmt-cat"><a href="#intel-cmt-cat" class="headerlink" title="intel-cmt-cat"></a>intel-cmt-cat</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ yum install <span class="built_in">int</span>el-cmt-cat.x86_64</span><br><span class="line"></span><br><span class="line">TIME <span class="number">2020</span><span class="number">-01</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">05</span></span><br><span class="line">           LLC(Last Level Cache): CMT(Cache Monitoring Technology) Cache Occupancy </span><br><span class="line">           MBL:MBM local bandwidth</span><br><span class="line">           MBR:MBM Remote bandwidth                             </span><br><span class="line">$ pqos</span><br><span class="line">    CORE   IPC   MISSES     LLC[KB]   MBL[MB/s]   MBR[MB/s]</span><br><span class="line">                                            </span><br><span class="line">       <span class="number">0</span>  <span class="number">0.26</span>       <span class="number">6</span>k      <span class="number">1080.0</span>         <span class="number">0.2</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">1</span>  <span class="number">0.26</span>       <span class="number">0</span>k         <span class="number">0.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">2</span>  <span class="number">0.27</span>       <span class="number">4</span>k      <span class="number">4600.0</span>         <span class="number">0.5</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">3</span>  <span class="number">0.26</span>       <span class="number">5</span>k       <span class="number">520.0</span>         <span class="number">0.0</span>         <span class="number">0.2</span></span><br><span class="line">       <span class="number">4</span>  <span class="number">0.27</span>       <span class="number">8</span>k      <span class="number">1120.0</span>         <span class="number">0.7</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">5</span>  <span class="number">0.25</span>      <span class="number">12</span>k      <span class="number">1080.0</span>         <span class="number">0.7</span>         <span class="number">0.2</span></span><br><span class="line">       <span class="number">6</span>  <span class="number">0.28</span>      <span class="number">18</span>k      <span class="number">1040.0</span>         <span class="number">0.9</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">7</span>  <span class="number">0.25</span>       <span class="number">0</span>k         <span class="number">0.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">8</span>  <span class="number">0.27</span>       <span class="number">4</span>k      <span class="number">3400.0</span>         <span class="number">0.2</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">9</span>  <span class="number">0.25</span>       <span class="number">0</span>k      <span class="number">1360.0</span>         <span class="number">0.1</span>         <span class="number">0.1</span></span><br><span class="line">      <span class="number">10</span>  <span class="number">0.26</span>      <span class="number">14</span>k      <span class="number">7000.0</span>         <span class="number">1.3</span>         <span class="number">0.0</span></span><br><span class="line">      <span class="number">11</span>  <span class="number">0.39</span>       <span class="number">1</span>k       <span class="number">120.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/intel/intel-cmt-cat/wiki/Usage-Examples">Usage-example</a></p><p>Cache Monitoring Technology (CMT)<br>Cache Allocation Technology (CAT)<br>Memory Bandwidth Monitoring (MBM)<br>Memory Bandwidth Allocation (MBA)<br>Code and Data Prioritization (CDP)</p><h3 id="mellanox-nic-exapmle"><a href="#mellanox-nic-exapmle" class="headerlink" title="mellanox nic exapmle"></a>mellanox nic exapmle</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">ethtool</span> <span class="string">-k</span>  <span class="string">enp131s0f1</span></span><br><span class="line"><span class="attr">Features for enp131s0f1:</span></span><br><span class="line"><span class="attr">rx-checksumming:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-checksumming:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-checksum-ipv4:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-checksum-ip-generic:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-checksum-ipv6:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-checksum-fcoe-crc:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-checksum-sctp:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">scatter-gather:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-scatter-gather:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-scatter-gather-fraglist:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tcp-segmentation-offload:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-tcp-segmentation:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-tcp-ecn-segmentation:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-tcp6-segmentation:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-tcp-mangleid-segmentation:</span> <span class="string">off</span></span><br><span class="line"><span class="attr">udp-fragmentation-offload:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">generic-segmentation-offload:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">generic-receive-offload:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">large-receive-offload:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">rx-vlan-offload:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-vlan-offload:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">ntuple-filters:</span> <span class="string">off</span></span><br><span class="line"><span class="attr">receive-hashing:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">highdma:</span> <span class="string">on</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">rx-vlan-filter:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">vlan-challenged:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-lockless:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">netns-local:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-gso-robust:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-fcoe-segmentation:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-gre-segmentation:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-ipip-segmentation:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-sit-segmentation:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-udp_tnl-segmentation:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">fcoe-mtu:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-nocache-copy:</span> <span class="string">off</span></span><br><span class="line"><span class="attr">loopback:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">rx-fcs:</span> <span class="string">off</span></span><br><span class="line"><span class="attr">rx-all:</span> <span class="string">off</span></span><br><span class="line"><span class="attr">tx-vlan-stag-hw-insert:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">rx-vlan-stag-hw-parse:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">rx-vlan-stag-filter:</span> <span class="string">on</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">busy-poll:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">tx-gre-csum-segmentation:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-udp_tnl-csum-segmentation:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-gso-partial:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">tx-sctp-segmentation:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">rx-gro-hw:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">l2-fwd-offload:</span> <span class="string">off</span> [<span class="string">fixed</span>]</span><br><span class="line"><span class="attr">hw-tc-offload:</span> <span class="string">off</span></span><br><span class="line"><span class="attr">rx-udp_tunnel-port-offload:</span> <span class="string">on</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ethtool</span> <span class="string">-i</span> <span class="string">enp131s0f1</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">mlx5_core</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">5.0</span><span class="number">-0</span></span><br><span class="line"><span class="attr">firmware-version:</span> <span class="number">14.20</span><span class="number">.1010</span> <span class="string">(MT_2420110034)</span></span><br><span class="line"><span class="attr">expansion-rom-version:</span></span><br><span class="line"><span class="attr">bus-info:</span> <span class="number">0000</span><span class="string">:83:00.1</span></span><br><span class="line"><span class="attr">supports-statistics:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">supports-test:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">supports-eeprom-access:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-register-dump:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-priv-flags:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="string">ethtool</span> <span class="string">-g</span> <span class="string">enp131s0f1</span></span><br><span class="line"><span class="attr">Ring parameters for enp131s0f1:</span></span><br><span class="line"><span class="attr">Pre-set maximums:</span></span><br><span class="line"><span class="attr">RX:</span><span class="number">8192</span></span><br><span class="line"><span class="attr">RX Mini:</span><span class="number">0</span></span><br><span class="line"><span class="attr">RX Jumbo:</span><span class="number">0</span></span><br><span class="line"><span class="attr">TX:</span><span class="number">8192</span></span><br><span class="line"><span class="attr">Current hardware settings:</span></span><br><span class="line"><span class="attr">RX:</span><span class="number">8192</span></span><br><span class="line"><span class="attr">RX Mini:</span><span class="number">0</span></span><br><span class="line"><span class="attr">RX Jumbo:</span><span class="number">0</span></span><br><span class="line"><span class="attr">TX:</span><span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="string">ethtool</span> <span class="string">-i</span> <span class="string">enp131s0f1</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">mlx5_core</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">5.0</span><span class="number">-0</span></span><br><span class="line"><span class="attr">firmware-version:</span> <span class="number">14.20</span><span class="number">.1010</span> <span class="string">(MT_2420110034)</span></span><br><span class="line"><span class="attr">expansion-rom-version:</span></span><br><span class="line"><span class="attr">bus-info:</span> <span class="number">0000</span><span class="string">:83:00.1</span></span><br><span class="line"><span class="attr">supports-statistics:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">supports-test:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">supports-eeprom-access:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-register-dump:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">supports-priv-flags:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure><h3 id="ixgbe-example"><a href="#ixgbe-example" class="headerlink" title="ixgbe example"></a>ixgbe example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -g enp1s0f0</span><br><span class="line">Ring parameters <span class="keyword">for</span> enp1s0f0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:4096</span><br><span class="line">RX Mini:0</span><br><span class="line">RX Jumbo:0</span><br><span class="line">TX:4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:4096</span><br><span class="line">RX Mini:0</span><br><span class="line">RX Jumbo:0</span><br><span class="line">TX:4096</span><br><span class="line"></span><br><span class="line">$ ethtool -i enp1s0f0</span><br><span class="line">driver: ixgbe</span><br><span class="line">version: 5.5.2</span><br><span class="line">firmware-version: 0x800006da, 255.65535.255</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:01:00.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: yes</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Features <span class="keyword">for</span> enp1s0f0:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">tx-checksum-ipv4: off [fixed]</span><br><span class="line">tx-checksum-ip-generic: on</span><br><span class="line">tx-checksum-ipv6: off [fixed]</span><br><span class="line">tx-checksum-fcoe-crc: on [fixed]</span><br><span class="line">tx-checksum-sctp: on</span><br><span class="line">scatter-gather: on</span><br><span class="line">tx-scatter-gather: on</span><br><span class="line">tx-scatter-gather-fraglist: off [fixed]</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">tx-tcp-segmentation: on</span><br><span class="line">tx-tcp-ecn-segmentation: off [fixed]</span><br><span class="line">tx-tcp6-segmentation: on</span><br><span class="line">tx-tcp-mangleid-segmentation: off</span><br><span class="line">udp-fragmentation-offload: off [fixed]</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">large-receive-offload: off    </span><br><span class="line">rx-vlan-offload: on</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: off</span><br><span class="line">receive-hashing: on</span><br><span class="line">highdma: on [fixed]</span><br><span class="line">rx-vlan-filter: on</span><br><span class="line">vlan-challenged: off [fixed]</span><br><span class="line">tx-lockless: off [fixed]</span><br><span class="line">netns-local: off [fixed]</span><br><span class="line">tx-gso-robust: off [fixed]</span><br><span class="line">tx-fcoe-segmentation: on [fixed]</span><br><span class="line">tx-gre-segmentation: on</span><br><span class="line">tx-ipip-segmentation: off [fixed]</span><br><span class="line">tx-sit-segmentation: off [fixed]</span><br><span class="line">tx-udp_tnl-segmentation: on</span><br><span class="line">fcoe-mtu: off [fixed]</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off [fixed]</span><br><span class="line">rx-fcs: off [fixed]</span><br><span class="line">rx-all: off</span><br><span class="line">tx-vlan-stag-hw-insert: off [fixed]</span><br><span class="line">rx-vlan-stag-hw-parse: off [fixed]</span><br><span class="line">rx-vlan-stag-filter: off [fixed]</span><br><span class="line">busy-poll: on [fixed]</span><br><span class="line">tx-gre-csum-segmentation: on</span><br><span class="line">tx-udp_tnl-csum-segmentation: on</span><br><span class="line">tx-gso-partial: on</span><br><span class="line">tx-sctp-segmentation: off [fixed]</span><br><span class="line">rx-gro-hw: off [fixed]</span><br><span class="line">l2-fwd-offload: off [fixed]</span><br><span class="line">hw-tc-offload: off</span><br><span class="line">rx-udp_tunnel-port-offload: on</span><br></pre></td></tr></table></figure><h3 id="txqueueleng"><a href="#txqueueleng" class="headerlink" title="txqueueleng"></a>txqueueleng</h3><p><a href="https://www.nas.nasa.gov/assets/pdf/papers/NAS_Technical_Report_NAS-2014-01.pdf">This queue parameter is mostly applicable for high-speed WAN transfers. For low-latency networks, the default setting of 1000 is sufficient. The receiving end is configured with the sysctl setting net.core.netdev_max_backlog. The default for this setting is also 1000 and does not need to be modified unless there is significant latency.</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip link <span class="built_in">set</span> dev enp5s0 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev enp5s0d1 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev bond0 txqueuelen 2000</span><br></pre></td></tr></table></figure><h4 id="Enable-jumbo-frames"><a href="#Enable-jumbo-frames" class="headerlink" title="Enable jumbo frames"></a><a href="http://ehealth-aussie.blogspot.com/2011/11/in-depth-look-into-path-mtu-discovery.html">Enable jumbo frames</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.ipv4.tcp_base_mss = 512</span><br><span class="line">net.ipv4.ip_no_pmtu_disc = 0</span><br></pre></td></tr></table></figure><h3 id="NIC-receive-packages"><a href="#NIC-receive-packages" class="headerlink" title="NIC receive packages"></a><a href="https://oxnz.github.io/2016/05/03/performance-tuning-networking/">NIC receive packages</a></h3><p>packet -&gt; NIC -&gt; internal hardware buffer or ring buffer -&gt; hardware interrupt request -&gt; software interrupt operation -&gt;<br>from buffer to network stack -&gt; forwarded/discarded/rejected/passed to a socket receive queue for an application -&gt;<br>remove from network stack until no packets left in NIC buffer or a certain number of packets are transferred (/proc/sys/net/core/dev_weight)</p><h4 id="Bottle-neck"><a href="#Bottle-neck" class="headerlink" title="Bottle neck"></a>Bottle neck</h4><ul><li><p>The NIC hardware buffer or ring buffer</p></li><li><p>The hardware or software interrupt queues</p></li><li><p>The socket receive queue for the application</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">eno1</span>: flags=<span class="number">6211</span>&lt;UP,BROADCAST,RUNNING,SLAVE,MULTICAST&gt;  mtu <span class="number">9000</span></span><br><span class="line">        <span class="attribute">ether</span> e<span class="number">4</span>:<span class="number">43</span>:<span class="number">4</span>b:<span class="number">08</span>:<span class="number">41</span>:e<span class="number">2</span>  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">104934573253</span>  bytes <span class="number">236357913149742</span> (<span class="number">214</span>.<span class="number">9</span> TiB)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">228</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">311616323933</span>  bytes <span class="number">1529707025808932</span> (<span class="number">1</span>.<span class="number">3</span> PiB)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure></li><li><p>RX</p><pre><code>  * frame/length counts only misaligned frames, it means frames with a length not divisible by 8. Because of that length is not a valid frame and it is simply discarded (too-short frames and too-long frames)  * overruns/fifo counts that times when there is fifo overruns, caused by the rate at which the buffer gets full and the kernel isn&#39;t able to reclaim the buffer          * No cpu resource, interrupt not balance and not affinity, eg: all nic interrupt in core0  * [dropped(normal) counts](https://serverfault.com/questions/528290/ifconfig-eth0-rx-dropped-packets/601186)          * Softnet backlog full          * Bad / Unintended VLAN tags          * Unknown / Unregistered protocols          * IPv6 frames when the server is not configured for IPv6  * dropped (in my opinion)          * Overloading          * Hardware issue                  * NIC ring buffer too slower                  * NIC/optical module issue                  * PCIE issue                  * Bad cable</code></pre></li><li><p><a href="http://blog.hyfather.com/blog/2013/03/04/ifconfig/">TX</a></p><pre><code>  *  aborted transmission  *  errors due to carrirer  *  fifo err  *  heartbeat erros  *  window err  *  collisions is the number of transmissions terminated due to CSMA/CD (Carrier Sense Multiple Access with Collision Detection).</code></pre></li></ul><p>The number of collisions tells us how many packets (ethernet frames) ended up colliding (being put on the network medium at the same time as) other packets, the result being that each of them would have to be recalled and resent by their respective network interfaces shortly afterwards. A high collision rate would indicate that the network is very busy, possibly overloaded. The more collisions you have, the more packets have to be resent, the more traffic you have and so on.</p><h3 id="Linux-network-parameters"><a href="#Linux-network-parameters" class="headerlink" title="Linux network parameters"></a>Linux network parameters</h3><h4 id="TCP-control-algorithms"><a href="#TCP-control-algorithms" class="headerlink" title="TCP control algorithms"></a>TCP control algorithms</h4><ul><li>cubic</li><li>reno</li><li>htcp<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_congestion_control=htcp</span><br><span class="line">net.ipv4.tcp_low_latency=0</span><br></pre></td></tr></table></figure></li><li>bbr for the bad network env<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_low_latency=1</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br></pre></td></tr></table></figure></li></ul><h4 id="The-others-parameters"><a href="#The-others-parameters" class="headerlink" title="The others parameters"></a>The others parameters</h4><h5 id="tcp-frto"><a href="#tcp-frto" class="headerlink" title="tcp_frto"></a>tcp_frto</h5><p>tcp_frto (integer; default: 0; since Linux 2.4.21/2.6)<br>Enable  F-RTO,  an enhanced recovery algorithm for TCP retransmission timeouts (RTOs).   It  is  particularly  beneficial  in wireless  environments  where  packet  loss is typically due to random radio interference rather than intermediate router  congestion.  See RFC 4138 for more details.<br>              This file can have one of the following values:<br>              0  Disabled.<br>              1  The basic version F-RTO algorithm is enabled.<br>              2  Enable  SACK-enhanced  F-RTO  if  flow uses SACK.  The basic version can be used also when SACK is in use though in  that case scenario(s) exists where F-RTO interacts badly with the packet counting of the SACK-enabled TCP flow.</p><p>In some of a lot of tcp-retrans in our LAN, but I have not permission to what happend in network switch, I m just do my best to avoid it in linux kernel</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_frto=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_sack=<span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_frto=<span class="number">2</span></span><br></pre></td></tr></table></figure><h5 id="tcp-window-scaling"><a href="#tcp-window-scaling" class="headerlink" title="tcp_window_scaling"></a>tcp_window_scaling</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#default</span></span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br></pre></td></tr></table></figure><p>tcp_window_scaling - support for large TCP Windows (RFC 1323).<br>The options info in SYN or SYN/ACK packages<br>Needs to be set to 1 if the Max TCP Window is over 65535</p><h5 id="tcp-win-scale"><a href="#tcp-win-scale" class="headerlink" title="tcp_win_scale"></a>tcp_win_scale</h5><p>The following variable is used to tell the kernel how much of the socket buffer space should be used for TCP window size, and how much to save for an application buffer<br>A value of 1 means the socket buffer will be divided evenly between TCP windows size and application</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_adv_win_scale=1</span><br></pre></td></tr></table></figure><h5 id="tcp-timestamps"><a href="#tcp-timestamps" class="headerlink" title="tcp_timestamps"></a>tcp_timestamps</h5><p>add additional 10 bytes to each packet but more accurate timestamp make TCP congestion control algorithms work better and are recommonded for fast networks</p><p>The following changes are recommended for improving IPv4 traffic performance, Disable the TCP timestamps option for better CPU utilization</p><p>I will enable it</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_timestamps=1</span><br></pre></td></tr></table></figure><h5 id="keepalive"><a href="#keepalive" class="headerlink" title="keepalive"></a>keepalive</h5><p>This determines the wait time between isAlive interval probes</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decrease the time default value for connections to keep alive</span></span><br><span class="line"><span class="comment">#default net.ipv4.tcp_keepalive_intvl = 75</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line"><span class="comment">#default net.ipv4.tcp_keepalive_probes = 9</span></span><br><span class="line">net.ipv4.tcp_keepalive_probes = 5</span><br><span class="line"><span class="comment">#default net.ipv4.tcp_keepalive_time = 7200</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 1800</span><br></pre></td></tr></table></figure><h5 id="tcp-tw-reuse"><a href="#tcp-tw-reuse" class="headerlink" title="tcp_tw_reuse"></a>tcp_tw_reuse</h5><p>This allows reusing sockets in TIME_WAIT state for new connections when it is safe from protocol viewpoint.<br>Allow to reuse TIME_WAIT sockets for new connections when it is safe from protocol viewpoint. It should not be changed without advice/request of technical experts.</p><p>Note: The tcp_tw_reuse setting is particularly useful in environments where numerous short connections are open and left in TIME_WAIT state, such as web servers. Reusing the sockets can be very effective in reducing server load.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_tw_reuse=1</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 1440000</span><br></pre></td></tr></table></figure><h5 id="tcp-sack"><a href="#tcp-sack" class="headerlink" title="tcp_sack"></a>tcp_sack</h5><p>Enable the TCP selective acks option for better throughput:<br>With selective acknowledgments, the data receiver can inform the sender about all segments that have arrived successfully, so the sender need retransmit only the segments that have actually been lost.</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sysctl</span> -w net.ipv<span class="number">4</span>.tcp_sack=<span class="number">1</span></span><br></pre></td></tr></table></figure><p><a href="https://support.hpe.com/hpsc/doc/public/display?docId=emr_na-c00916755">There are warnings saying that net.ipv4.tcp_tw_reuse and</a></p><pre><code>net.ipv4.tcp_tw_recycle tunables should not be changed without consulting experts first.  What does this mean and what can gowrong if they are enabled.Answer:  Potential problems are not specific to Linux.  Enabling these tunables will not make the host crash or unstable, but it may break TCP/IP functionality if the host is connected to devices such as load-balancers or firewalls.  Some of these devices can reject SYN if it reuses the same connection (i.e. src/dst IP and src/dst ports are the same) too quickly.  RFC 1122 describes when it is acceptable to recycle the connection when SYN arrives for a connection in TIME_WAIT state.</code></pre><h5 id="netfilter"><a href="#netfilter" class="headerlink" title="netfilter"></a>netfilter</h5><p>To reduce the number of connections in TIME_WAIT state, we can decrease the number of seconds connections are kept in this state before being dropped:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># reduce TIME_WAIT from the 120s default to 30-60s</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait=30</span><br><span class="line"><span class="comment"># reduce FIN_WAIT from teh 120s default to 30-60s</span></span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait=30</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line"><span class="comment">#### [Neighbour Table Overflow](https://www.cyberciti.biz/faq/centos-redhat-debian-linux-neighbor-table-overflow/)</span></span><br><span class="line">```bash</span><br><span class="line"><span class="comment">## works best with &lt;= 500 client computers ##</span></span><br><span class="line"><span class="comment"># Force gc to clean-up quickly</span></span><br><span class="line">net.ipv4.neigh.default.gc_interval = 1800</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set ARP cache entry timeout</span></span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 1800</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup DNS threshold for arp</span></span><br><span class="line"><span class="comment"># gc_thresh3 represents the hard maximum number of entries in the ARP cache</span></span><br><span class="line">net.ipv4.neigh.default.gc_thresh3 = 8192</span><br><span class="line">net.ipv4.neigh.default.gc_thresh2 = 4096</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1 = 1024</span><br></pre></td></tr></table></figure><p>gc_thresh1 (since Linux 2.2)<br>       The minimum number of entries to keep in  the  ARP  cache. The garbage collector will not run if there are fewer than this number of entries in the cache.  Defaults to 128.</p><p>gc_thresh2 (since Linux 2.2)<br>       The soft maximum number of entries to keep  in  the  ARP  cache.The garbage collector will allow the number of entries to exceed this  for  5  seconds  before  collection  will  be   performed. Defaults to 512.</p><p>gc_thresh3 (since Linux 2.2)<br>       The  hard  maximum  number  of entries to keep in the ARP cache.The garbage collector will always run if  there  are  more  than this number of entries in the cache.  Defaults to 1024.</p><h3 id="sysctl-conf"><a href="#sysctl-conf" class="headerlink" title="sysctl.conf"></a>sysctl.conf</h3><p><a href="https://levelup.gitconnected.com/linux-kernel-tuning-for-high-performance-networking-receive-backlog-5b3f54fb82a7">network_receive</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### Interrupt Coalescing (soft IRQ) and Ingress QDisc</span></span><br><span class="line">net.core.netdev_max_backlog = 65536 </span><br><span class="line">net.core.netdev_max_backlog = 2000</span><br><span class="line"><span class="comment">#  the maximum number of packets, queued on the INPUT side (the ingress qdisc), when the interface receives packets faster than kernel can process them.</span></span><br><span class="line"><span class="comment"># Sets the maximum number of packets allowed to queue when a particular interface receives packets faster than the kernel can process them.</span></span><br><span class="line"><span class="comment"># Each CPU core can hold a number of packets in a ring buffer before the network stack is able to process them. If the buffer is filled faster than TCP stack can process them, a dropped packet counter is incremented and they will be dropped. The net.core.netdev_max_backlog setting should be increased to maximize the number of packets queued for processing on servers with high burst traffic.</span></span><br><span class="line"></span><br><span class="line">net.core.netdev_budget=600</span><br><span class="line"><span class="comment">#netdev_budget is the maximum number of packets taken from all interfaces in one polling cycle (NAPI poll). In one polling cycle interfaces which are registered to polling are probed in a round-robin manner. Also, a polling cycle may not exceed netdev_budget_usecs microseconds, even if netdev_budget has not been exhausted.</span></span><br><span class="line"><span class="comment">#Maximum number of packets received in one NAPI polling cycle, total for all interfaces/CPUs. Cannot exceed</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Be careful of increasing this value unless there is a very good reason. A value exceeding 1000 is unlikely to be very helpful. In fact increasing this value too much can have detrimental effect and in the worse case scenario lead to softirq hangs or performance problems, as the softirqs can run for too long and starve other processes of CPU. the maximum number of packets taken from all interfaces in one polling cycle (NAPI poll). In one polling cycle interfaces which are registered to polling are probed in a round-robin manner. Also, a polling cycle may not exceed netdev_budget_usecs microseconds, even if netdev_budget has not been exhausted.</span></span><br><span class="line"></span><br><span class="line">net.core.netdev_budget_usecs=2000 <span class="comment">#default 2000</span></span><br><span class="line"><span class="comment">#is the maximum number of packets, queued on the INPUT side (the ingress qdisc), when the interface receives packets faster than kernel can process them.</span></span><br><span class="line"><span class="comment">#netdev_budget_usecs maximum number of microseconds in one NAPI polling cycle. Polling will exit when either netdev_budget_usecs have elapsed during the poll cycle or the number of packets processed reaches netdev_budget</span></span><br><span class="line"></span><br><span class="line">net.core.dev_weight=128 <span class="comment">#default 64</span></span><br><span class="line"><span class="comment">#he maximum number of packets that kernel can handle on a NAPI interrupt, it&#x27;s a Per-CPU variable. For drivers that support LRO or GRO_HW, a hardware aggregated packet is counted as one packet in this.</span></span><br><span class="line"><span class="comment"># Maximum number of packets the driver can receive during a NAPI interrupt, per CPU.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## need hardware support</span></span><br><span class="line">net.core.busy_poll = 50 </span><br><span class="line"><span class="comment"># This parameter controls the number of microseconds to wait for packets on the device queue for socket poll and selects </span></span><br><span class="line"><span class="comment"># default 0</span></span><br><span class="line"><span class="comment"># This parameter controls the number of microseconds to wait for packets on the device queue for socket reads</span></span><br><span class="line">net.core.busy_read = 100 </span><br><span class="line"><span class="comment"># default 0</span></span><br><span class="line"><span class="comment">#bnx2x</span></span><br><span class="line"><span class="comment">#be2net</span></span><br><span class="line"><span class="comment">#ixgbe</span></span><br><span class="line"><span class="comment">#mlx4</span></span><br><span class="line"><span class="comment">#myri10ge</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### Egress qdisc</span></span><br><span class="line">default_qdisc is the default queuing discipline to use <span class="keyword">for</span> network devices</span><br></pre></td></tr></table></figure><p>sysctl net.core.default_qdisc<br>net.core.default_qdisc<br>#net.core.default_qdisc = pfifo_fast<br>#net.core.default_qdisc=fq_codel<br>#net.core.default_qdisc=fq<br>net.core.default_qdisc = pfifo_fast</p><p>$ ifconfig ethX txqueuelen 2000<br>txqueuelen is the maximum number of packets, queued on the OUTPUT side.</p><p>$ tc -s qdisc ls dev enp1s0f0<br>qdisc mq 0: root<br> Sent 8704680006739 bytes 1081832598 pkt (dropped 0, overlimits 0 requeues 38187748)<br> backlog 0b 0p requeues 38187748<br>qdisc pfifo_fast 0: parent :c bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 34858645 bytes 521805 pkt (dropped 0, overlimits 0 requeues 17)<br> backlog 0b 0p requeues 17<br>qdisc pfifo_fast 0: parent :b bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 676539 bytes 3021 pkt (dropped 0, overlimits 0 requeues 0)<br> backlog 0b 0p requeues 0<br>qdisc pfifo_fast 0: parent :a bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 37492499 bytes 9420 pkt (dropped 0, overlimits 0 requeues 390)<br> backlog 0b 0p requeues 390<br>qdisc pfifo_fast 0: parent :9 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 422056 bytes 1476 pkt (dropped 0, overlimits 0 requeues 0)<br> backlog 0b 0p requeues 0<br>qdisc pfifo_fast 0: parent :8 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 98686230031 bytes 12114256 pkt (dropped 0, overlimits 0 requeues 756171)<br> backlog 0b 0p requeues 756171<br>qdisc pfifo_fast 0: parent :7 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 108277741139 bytes 12015011 pkt (dropped 0, overlimits 0 requeues 636061)<br> backlog 0b 0p requeues 636061<br>qdisc pfifo_fast 0: parent :6 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 991256915583 bytes 110945978 pkt (dropped 0, overlimits 0 requeues 12727685)<br> backlog 0b 0p requeues 12727685<br>qdisc pfifo_fast 0: parent :5 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 4394205535 bytes 754058 pkt (dropped 0, overlimits 0 requeues 246)<br> backlog 0b 0p requeues 246<br>qdisc pfifo_fast 0: parent :4 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 2788904555347 bytes 315235199 pkt (dropped 0, overlimits 0 requeues 15808716)<br> backlog 0b 0p requeues 15808716<br>qdisc pfifo_fast 0: parent :3 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 56526646 bytes 85576 pkt (dropped 0, overlimits 0 requeues 2)<br> backlog 0b 0p requeues 2<br>qdisc pfifo_fast 0: parent :2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 2752219594535 bytes 315360937 pkt (dropped 0, overlimits 0 requeues 8257982)<br> backlog 0b 0p requeues 8257982<br>qdisc pfifo_fast 0: parent :1 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1<br> Sent 1960810788184 bytes 314785861 pkt (dropped 0, overlimits 0 requeues 478)<br> backlog 0b 0p requeues 478</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">### TCP FSM and congestion algorithm</span></span><br><span class="line"><span class="attribute">net</span>.core.somaxconn = <span class="number">65536</span></span><br><span class="line"><span class="comment">#Limit of socket listen() backlog, known in userspace as SOMAXCONN. Defaults to 128.</span></span><br><span class="line"><span class="comment">#provides an upper limit on the value of the backlog parameter passed to the listen() function</span></span><br><span class="line"><span class="comment">#Decrease the time default value for tcp_fin_timeout connection, FIN-WAIT-2</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_fin_timeout = <span class="number">15</span></span><br><span class="line"><span class="comment">#tcp_available_congestion_control - shows the available congestion control choices that are registered.</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_max_syn_backlog = <span class="number">2048</span> # default <span class="number">256</span></span><br><span class="line"><span class="comment">#Maximum number of packets taken from all interfaces in one polling cycle (NAPI poll).</span></span><br><span class="line"><span class="comment">#In one polling cycle interfaces which are registered to polling are probed in a round-robin manner. Also, a polling cycle may not exceed netdev_budget_usecs microseconds, even if netdev_budget has not been exhausted.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Maximum number of remembered connection requests, which are still did not receive an acknowledgment from connecting client. The default value is 1024 for systems with more than 128Mb of memory, and 128 for low memory machines.</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_available_congestion_control #default reno cubic</span><br><span class="line"><span class="comment">#shows the available congestion control choices that are registered.</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_congestion_control </span><br><span class="line"><span class="comment">#default cubic</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_slow_start_after_idle=<span class="number">1</span> </span><br><span class="line"><span class="comment">#enable tcp slow start</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### TCP buffer</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_moderate_rcvbuf = <span class="number">1</span></span><br><span class="line"><span class="comment">#If set, TCP performs receive buffer auto-tuning, attempting to automatically size the buffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># min (size used under memory pressure), default (initial size), max (maximum size) - size of receive buffer used by TCP sockets.</span></span><br><span class="line"><span class="comment"># default (initial size), max (maximum size) - size of send buffer used by TCP sockets.</span></span><br><span class="line"><span class="comment"># the number of pages(default 4K) allocated falls below the low, pressure, high mark.</span></span><br><span class="line"><span class="comment">#                     (64M) (512M)  (16G)</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_mem =  <span class="number">16384</span> <span class="number">131072</span>   <span class="number">4194304</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_wmem = <span class="number">16384</span> <span class="number">131072</span>   <span class="number">4194304</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#                    (128M) (512M)  (24G) here is page</span></span><br><span class="line"><span class="comment"># measured in units of the system page size</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_rmem = <span class="number">32768</span> <span class="number">131072</span>  <span class="number">6291456</span></span><br><span class="line"><span class="comment"># default: net.ipv4.tcp_wmem = 4096163844194304 (4194304*4/1024/1024=16M)</span></span><br><span class="line"><span class="comment"># default: net.ipv4.tcp_wmem = 4096163844194304 (16M)</span></span><br><span class="line"><span class="comment"># default: net.ipv4.tcp_rmem = 40961310726291456 (24M)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#256M 64M, here is bytes</span></span><br><span class="line"><span class="attribute">net</span>.core.rmem_max = <span class="number">268435456</span></span><br><span class="line"><span class="attribute">net</span>.core.rmem_default = <span class="number">67108864</span> </span><br><span class="line"><span class="comment">#Socket Receive Queues, avoid package loss</span></span><br><span class="line"><span class="attribute">net</span>.core.wmem_max = <span class="number">268435456</span></span><br><span class="line"><span class="attribute">net</span>.core.wmem_default = <span class="number">67108864</span></span><br><span class="line"><span class="comment"># Each network socket is allocated a send buffer for outbound packets and a receive socket for inbound packets. These buffers are assigned a default size that depends on parameters of the operating system</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### The others</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_sack = <span class="number">1</span></span><br><span class="line"><span class="comment">#Enable the TCP selective acks option for better throughput</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_timestamps=<span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_mtu_probing=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_tw_reuse=<span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_adv_win_scale=<span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_window_scaling = <span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_mtu_probing=<span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.core.rmem_max=<span class="number">16777216</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_congestion_control=cubic</span><br><span class="line"></span><br><span class="line"><span class="comment"># fast retrans</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_frto=<span class="number">1</span></span><br><span class="line"><span class="comment">#Enable  F-RTO,  an enhanced recovery algorithm for TCP retransmission timeouts (RTOs).   It  is  particularly  beneficial  in wireless  environments  where  packet  loss is typically due to random radio interference rather than intermediate router  congestion.  See RFC 4138 for more details.</span></span><br><span class="line"><span class="comment">#              This file can have one of the following values:</span></span><br><span class="line"><span class="comment">#              0  Disabled.</span></span><br><span class="line"><span class="comment">#              1  The basic version F-RTO algorithm is enabled.</span></span><br><span class="line"><span class="comment">#              2  Enable  SACK-enhanced  F-RTO  if  flow uses SACK.  The basic version can be used also when SACK is in use though in  that case scenario(s) exists where F-RTO interacts badly with the packet counting of the SACK-enabled TCP flow.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># works best with &lt;= 1000 client computers ##</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.neigh.default.gc_interval = <span class="number">30</span> </span><br><span class="line"><span class="comment">#default, How frequently the garbage collector for neighbour entries should attempt to run.Defaults to 30 seconds.  </span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.neigh.default.gc_stale_time = <span class="number">60</span> </span><br><span class="line"><span class="comment">#default,  Determines how often to check for stale neighbour entries. When a neighbour entry is considered stale it is resolved again before sending data to it. Defaults to 60 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gc_thresh3 represents the hard maximum number of entries in the ARP cache</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.neigh.default.gc_thresh<span class="number">3</span> = <span class="number">8192</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.neigh.default.gc_thresh<span class="number">2</span> = <span class="number">4096</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.neigh.default.gc_thresh<span class="number">1</span> = <span class="number">2048</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># don&#x27;t cache ssthresh from previous connection</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_no_metrics_save = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#use cookies to process SYN queue overflow</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_syncookies = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RHEL 7 default: 32768 61000</span></span><br><span class="line"><span class="comment"># outgoing port range</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.ip_local_port_range = <span class="number">2000</span> <span class="number">65535</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Decrease the time default value for tcp_fin_timeout connection, FIN-WAIT-2</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_fin_timeout = <span class="number">15</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.netfilter.ip_conntrack_max=<span class="number">204800</span></span><br><span class="line"><span class="comment"># default net.ipv4.route.gc_timeout = 300</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.icmp_ignore_bogus_error_responses = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># In WAN network connection</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_bic=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_keepalive_intvl = <span class="number">30</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_keepalive_probes = <span class="number">5</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_keepalive_time = <span class="number">1800</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_tw_reuse=<span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_max_tw_buckets = <span class="number">1440000</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_adv_win_scale=<span class="number">1</span></span><br><span class="line"><span class="comment">#The options info in SYN or SYN/ACK packages </span></span><br><span class="line"><span class="comment">#Needs to be set to 1 if the Max TCP Window is over 65535</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#The following variable is used to tell the kernel how much of the socket buffer space should be used for TCP window size, and how much to save for an application buffer</span></span><br><span class="line"><span class="comment">#A value of 1 means the socket buffer will be divided evenly between TCP windows size and application</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_window_scaling = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_low_latency=<span class="number">0</span></span><br><span class="line"><span class="comment">### htcp</span></span><br><span class="line"><span class="attribute">net</span>.ipv<span class="number">4</span>.tcp_congestion_control=htcp</span><br><span class="line"></span><br><span class="line"><span class="comment">### default</span></span><br><span class="line"><span class="attribute">tcp_congestion_control</span>=cubic </span><br><span class="line"><span class="attribute">net</span>.core.default_qdisc=fq_codel</span><br><span class="line"><span class="comment">#net.core.default_qdisc = pfifo_fast</span></span><br></pre></td></tr></table></figure><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">### throughput performance</span><br><span class="line">net.core.dev_weight = <span class="number">128</span></span><br><span class="line">net.core.netdev_max_backlog = <span class="number">65536</span> </span><br><span class="line">net.core.netdev_budget=<span class="number">600</span></span><br><span class="line">net.core.busy_poll = <span class="number">50</span> </span><br><span class="line">net.core.busy_read = <span class="number">100</span> </span><br><span class="line">net.core.somaxconn = <span class="number">65536</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = <span class="number">15</span></span><br><span class="line">net.ipv4.tcp_slow_start_after_idle=<span class="number">1</span> </span><br><span class="line">net.ipv4.tcp_moderate_rcvbuf = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_mem =  <span class="number">16384</span> <span class="number">131072</span>   <span class="number">4194304</span></span><br><span class="line">net.ipv4.tcp_wmem = <span class="number">16384</span> <span class="number">131072</span>   <span class="number">4194304</span></span><br><span class="line">net.ipv4.tcp_rmem = <span class="number">32768</span> <span class="number">131072</span>  <span class="number">6291456</span></span><br><span class="line">net.core.rmem_max = <span class="number">268435456</span></span><br><span class="line">net.core.rmem_default = <span class="number">67108864</span> </span><br><span class="line">net.core.wmem_max = <span class="number">268435456</span></span><br><span class="line">net.core.wmem_default = <span class="number">67108864</span></span><br><span class="line">net.ipv4.tcp_sack = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_timestamps=<span class="number">1</span></span><br><span class="line">net.ipv4.tcp_mtu_probing=<span class="number">1</span></span><br><span class="line">net.ipv4.tcp_tw_reuse=<span class="number">1</span></span><br><span class="line">net.ipv4.tcp_adv_win_scale=<span class="number">1</span></span><br><span class="line">net.ipv4.tcp_window_scaling = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_mtu_probing=<span class="number">1</span></span><br><span class="line">net.ipv4.tcp_frto=<span class="number">1</span></span><br><span class="line">net.ipv4.neigh.<span class="section">default</span>.gc_interval = <span class="number">30</span> </span><br><span class="line">net.ipv4.neigh.<span class="section">default</span>.gc_stale_time = <span class="number">60</span> </span><br><span class="line">net.ipv4.neigh.<span class="section">default</span>.gc_thresh3 = <span class="number">8192</span></span><br><span class="line">net.ipv4.neigh.<span class="section">default</span>.gc_thresh2 = <span class="number">4096</span></span><br><span class="line">net.ipv4.neigh.<span class="section">default</span>.gc_thresh1 = <span class="number">2048</span></span><br><span class="line">net.ipv4.tcp_no_metrics_save = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_syncookies = <span class="number">1</span></span><br><span class="line">net.ipv4.ip_local_port_range = <span class="number">2000</span> <span class="number">65535</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = <span class="number">15</span></span><br><span class="line">net.ipv4.netfilter.ip_conntrack_max=<span class="number">204800</span></span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl = <span class="number">30</span></span><br><span class="line">net.ipv4.tcp_keepalive_probes = <span class="number">5</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = <span class="number">1800</span></span><br><span class="line">net.ipv4.tcp_tw_reuse=<span class="number">1</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = <span class="number">1440000</span></span><br><span class="line">net.ipv4.tcp_adv_win_scale=<span class="number">1</span></span><br><span class="line">net.ipv4.tcp_window_scaling = <span class="number">1</span></span><br><span class="line">net.ipv4.tcp_low_latency=<span class="number">0</span></span><br><span class="line">net.ipv4.tcp_congestion_control=cubic</span><br><span class="line">net.core.default_qdisc=fq_codel</span><br><span class="line"></span><br><span class="line"># if you custom pin cpu resources</span><br><span class="line">#kernel.numa_balancing=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">#avoid the bad udp package</span><br><span class="line">#net.inet.udp.checksum=<span class="number">1</span></span><br><span class="line">#zero means not receive source route info ip package</span><br><span class="line">#net.ipv4.conf.<span class="section">default</span>.accept_source_route = <span class="number">0</span></span><br></pre></td></tr></table></figure><h5 id="tcp-syn-retries"><a href="#tcp-syn-retries" class="headerlink" title="tcp_syn_retries"></a><a href="https://testerhome.com/topics/8859">tcp_syn_retries</a></h5><p>net.ipv4.tcp_syn_retries = 6</p><p>tcp_syn_retries - INTEGER</p><p>Number of times initial SYNs for an active TCP connection attempt will be retransmitted. Should not be higher than 127. Default value<br>is 6, which corresponds to 63seconds till the last retransmission with the current initial RTO of 1second. With this the final timeout for an active TCP connection attempt will happen after 127seconds.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">time telnet <span class="variable">$ip</span> <span class="variable">$port</span></span><br><span class="line"></span><br><span class="line">Trying <span class="variable">$ip</span>...</span><br><span class="line">telnet: connect to address <span class="variable">$ip</span>: Connection timed out</span><br><span class="line">telnet <span class="variable">$ip</span> <span class="variable">$port</span>  0.00s user 0.00s system 0% cpu 2:07.29 total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">18:04:23.765507 IP <span class="variable">$ip1</span>.<span class="variable">$port1</span> &gt; <span class="variable">$ip2</span>.<span class="variable">$port2</span>: Flags [S], seq 922947731, win 29200, options [mss 1460,sackOK,TS val 13801993 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:04:24.768182 IP <span class="variable">$ip1</span>.<span class="variable">$port1</span> &gt; <span class="variable">$ip2</span>.<span class="variable">$port2</span>: Flags [S], seq 922947731, win 29200, options [mss 1460,sackOK,TS val 13802996 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:04:26.772188 IP <span class="variable">$ip1</span>.<span class="variable">$port1</span> &gt; <span class="variable">$ip2</span>.<span class="variable">$port2</span>: Flags [S], seq 922947731, win 29200, options [mss 1460,sackOK,TS val 13805000 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:04:30.780189 IP <span class="variable">$ip1</span>.<span class="variable">$port1</span> &gt; <span class="variable">$ip2</span>.<span class="variable">$port2</span>: Flags [S], seq 922947731, win 29200, options [mss 1460,sackOK,TS val 13809008 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:04:38.796205 IP <span class="variable">$ip1</span>.<span class="variable">$port1</span> &gt; <span class="variable">$ip2</span>.<span class="variable">$port2</span>: Flags [S], seq 922947731, win 29200, options [mss 1460,sackOK,TS val 13817024 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:04:54.828196 IP <span class="variable">$ip1</span>.<span class="variable">$port1</span> &gt; <span class="variable">$ip2</span>.<span class="variable">$port2</span>: Flags [S], seq 922947731, win 29200, options [mss 1460,sackOK,TS val 13833056 ecr 0,nop,wscale 7], length 0</span><br><span class="line">18:05:26.860210 IP <span class="variable">$ip1</span>.<span class="variable">$port1</span> &gt; <span class="variable">$ip2</span>.<span class="variable">$port2</span>: Flags [S], seq 922947731, win 29200, options [mss 1460,sackOK,TS val 13865088 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">18:04:23.765507</span><br><span class="line">18:04:24.768182 1s</span><br><span class="line">18:04:26.772188 2s</span><br><span class="line">18:04:30.780189 4s</span><br><span class="line">18:04:38.796205 8s</span><br><span class="line">18:04:54.828196 16s</span><br><span class="line">18:05:26.860210 32s</span><br><span class="line">06:30.98        64s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line"><span class="comment">#net.ipv4.tcp_syn_retries = 6</span></span><br><span class="line">``</span><br><span class="line"></span><br><span class="line"><span class="comment">##### Enabling flow limits and tuning flow limit hash table size</span></span><br><span class="line">```bash</span><br><span class="line">$ sysctl -w net.core.flow_limit_table_len=8192</span><br><span class="line">The value is only consulted when a new table is allocated. Modifying it does not update active tables.</span><br><span class="line"></span><br><span class="line">$ cat /proc/sys/net/core/flow_limit_cpu_bitmap</span><br><span class="line">00000</span><br><span class="line"></span><br><span class="line"><span class="comment"># set a bitmask</span></span><br><span class="line"><span class="built_in">echo</span> f &gt; /proc/sys/net/core/flow_limit_cpu_bitmap</span><br><span class="line"></span><br><span class="line">Per-flow rate is calculated by hashing each packet into a hashtable bucket and incrementing a per-bucket counter. The <span class="built_in">hash</span> <span class="keyword">function</span> is the same that selects a CPU <span class="keyword">in</span> RPS, but as the number of buckets can be much larger than the number of CPUs, flow <span class="built_in">limit</span> has finer-grained identification of large flows and fewer <span class="literal">false</span> positives. The default table has 4096 buckets. This value can be modified through sysctl</span><br><span class="line"></span><br><span class="line">Flow <span class="built_in">limit</span> is useful on systems with many concurrent connections, <span class="built_in">where</span> a single connection taking up 50% of a CPU indicates a problem. In such environments, <span class="built_in">enable</span> the feature on all CPUs that handle network rx interrupts (as <span class="built_in">set</span> <span class="keyword">in</span> /proc/irq/N/smp_affinity).</span><br><span class="line"></span><br><span class="line">The feature depends on the input packet queue length to exceed the flow <span class="built_in">limit</span> threshold (50%) + the flow <span class="built_in">history</span> length (256). Setting net.core.netdev_max_backlog to either 1000 or 10000 performed well <span class="keyword">in</span> experiments.</span><br></pre></td></tr></table></figure><h3 id="NFS-hangs-because-zero-window-problem"><a href="#NFS-hangs-because-zero-window-problem" class="headerlink" title="NFS hangs because zero window problem"></a><a href="https://access.redhat.com/solutions/1610363">NFS hangs because zero window problem</a></h3><p>Zero Window is something to investigate. TCP Zero Window is when the Window size in a machine remains at zero for a specified amount of time. This means that a client is not able to receive further information at the moment, and the TCP transmission is halted until it can process the information in its receive buffer.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_sack=0</span><br></pre></td></tr></table></figure><p>disable tcp sack and remount the nfs</p><p><a href="https://wiki.wireshark.org/TCP%20ZeroWindow">Troubleshooting a Zero Window</a> For one reason or another, the machine alerting the Zero Window will not receive any more data from the host. It could be that the machine is running too many processes at that moment, and its processor is maxed. Or it could be that there is an error in the TCP receiver, like a Windows registry misconfiguration. Try to determine what the client was doing when the TCP Zero Window happened.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ tcpkill -i eth0 port 21</span><br><span class="line">$ tcpkill host 192.168.1.2</span><br><span class="line">$ tcpkill ip host 192.168.1.2 and not 192.168.1.111</span><br></pre></td></tr></table></figure><h4 id="All-NFS-connection-are-hang-all-TCP-state-are-in-TIMEWAIT-status"><a href="#All-NFS-connection-are-hang-all-TCP-state-are-in-TIMEWAIT-status" class="headerlink" title="All NFS connection are hang, all TCP state are in TIMEWAIT status"></a>All NFS connection are hang, all TCP state are in TIMEWAIT status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#modify</span></span><br><span class="line">net.ipv4.tcp_low_latency=0 to net.ipv4.tcp_low_latency=1</span><br><span class="line">net.ipv4.tcp_adv_win_scale=0 to net.ipv4.tcp_adv_win_scale=1</span><br></pre></td></tr></table></figure><p>restart service ,it s not work, restart rpcbind ,it s not work, looks like tcp issue.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_tw_reuse=1</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 1440000</span><br><span class="line"><span class="comment"># net.ipv4.tcp_tw_recycle has been removed</span></span><br></pre></td></tr></table></figure><p>all TCP state to ESTABLISHED, it s recovery.</p><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><h4 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">dropwatch</span> <span class="string">-l</span> <span class="string">kas</span></span><br><span class="line"><span class="string">Initalizing</span> <span class="string">kallsyms</span> <span class="string">db</span></span><br><span class="line"><span class="string">dropwatch&gt;</span> <span class="string">start</span></span><br><span class="line"><span class="string">Enabling</span> <span class="string">monitoring...</span></span><br><span class="line"><span class="string">Kernel</span> <span class="string">monitoring</span> <span class="string">activated.</span></span><br><span class="line"><span class="string">Issue</span> <span class="string">Ctrl-C</span> <span class="string">to</span> <span class="string">stop</span> <span class="string">monitoring</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_queue_purge+18</span> <span class="string">(0xffffffff91a38848)</span></span><br><span class="line"><span class="number">187</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"><span class="number">164</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"><span class="number">131</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"><span class="number">30</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"><span class="number">113</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"><span class="number">69</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"><span class="number">71</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"><span class="number">78</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_release_data+10e</span> <span class="string">(0xffffffff91a386de)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### iperf3 and qperf tcp and udp test between boardcom 57800</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">skb_queue_purge+18</span> <span class="string">(0xffffffff88038848)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">__udp4_lib_rcv+b9</span> <span class="string">(0xffffffff880cda49)</span></span><br><span class="line"><span class="number">2</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">__udp4_lib_rcv+b9</span> <span class="string">(0xffffffff880cda49)</span></span><br><span class="line"><span class="number">2</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">neigh_probe+5f</span> <span class="string">(0xffffffff8805d3cf)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">__udp4_lib_rcv+b9</span> <span class="string">(0xffffffff880cda49)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">neigh_probe+5f</span> <span class="string">(0xffffffff8805d3cf)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">arp_error_report+39</span> <span class="string">(0xffffffff880cf779)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">neigh_probe+5f</span> <span class="string">(0xffffffff8805d3cf)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">icmp_rcv+125</span> <span class="string">(0xffffffff880d30c5)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">neigh_probe+5f</span> <span class="string">(0xffffffff8805d3cf)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">neigh_probe+5f</span> <span class="string">(0xffffffff8805d3cf)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">arp_error_report+39</span> <span class="string">(0xffffffff880cf779)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">icmp_rcv+125</span> <span class="string">(0xffffffff880d30c5)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">unix_dgram_sendmsg+4f8</span> <span class="string">(0xffffffff881108a8)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">__udp4_lib_rcv+b9</span> <span class="string">(0xffffffff880cda49)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">tcp_v4_rcv+87</span> <span class="string">(0xffffffff880c1d37)</span></span><br><span class="line"><span class="number">6</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">unix_stream_connect+2da</span> <span class="string">(0xffffffff881101ea)</span></span><br><span class="line"><span class="number">4</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">unix_dgram_sendmsg+4f8</span> <span class="string">(0xffffffff881108a8)</span></span><br><span class="line"><span class="number">2</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">unix_stream_connect+2da</span> <span class="string">(0xffffffff881101ea)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">__udp4_lib_rcv+b9</span> <span class="string">(0xffffffff880cda49)</span></span><br><span class="line"><span class="number">1</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">__udp4_lib_rcv+b9</span> <span class="string">(0xffffffff880cda49)</span></span><br><span class="line"><span class="number">2</span> <span class="string">drops</span> <span class="string">at</span> <span class="string">__udp4_lib_rcv+b9</span> <span class="string">(0xffffffff880cda49)</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ss</span> <span class="string">-eipnt</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-A</span> <span class="number">1</span> <span class="string">$ipaddr</span> <span class="string">--color</span>  <span class="string">|</span> <span class="string">grep</span> <span class="string">-B</span> <span class="number">1</span> <span class="string">-Ei</span> <span class="string">&#x27;cwnd|ssthresh&#x27;</span></span><br><span class="line">    <span class="string">*</span> <span class="string">If</span> <span class="string">cwnd</span> <span class="string">and</span> <span class="string">ssthresh</span> <span class="string">and</span> <span class="string">cwnd</span> <span class="string">&#x27;s value up and down frequently that means there is a bad network env(maybe it &#x27;</span><span class="string">s</span> <span class="string">trigger</span> <span class="string">the</span> <span class="string">tcp</span> <span class="string">slow</span> <span class="string">start</span> <span class="string">algorithm</span> <span class="string">and</span> <span class="string">TCP</span> <span class="string">Congestion</span> <span class="string">avoidance</span> <span class="string">algorithm)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Recv-Q is the count of bytes not copied by the user program connected to this socket.</span></span><br><span class="line"><span class="comment">#Send-Q is the count of bytes not acknowledged by the remote host.</span></span><br><span class="line"><span class="comment">#If there are Send-Q values/counts that are persistent:</span></span><br><span class="line">   <span class="comment">#Some of these are data the host has already sent but that have not yet arrived at the receiver, merely due to geographic distance.</span></span><br><span class="line">   <span class="comment">#Likewise, some are for sent data for which the receiver has emitted acknowledgements, which are still in transit on the return path. Some can be due to sent data which has been dropped by the network, or the responses for those.</span></span><br><span class="line">   <span class="comment">#Finally, when the receiver tells the sender to pause sending, or the sending application is faster than the network can support, an unsent-data queue can build up</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Similarly a non-zero value in Recv-Q does not really indicate a system problem but an application level issue. If the counts in Recv-Q increases it implies that application running on system is not picking up the data that the kernel is signalling to them. This may or may not be a problem. For example if the receiving application is writing to a filesystem which is slower than both the sender and the network, a receive queue would be expected to build up.</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">sar</span> <span class="string">-n</span> <span class="string">TCP,ETCP</span> <span class="number">2</span></span><br><span class="line"><span class="number">02</span><span class="string">:47:30</span> <span class="string">AM</span>  <span class="string">active/s</span> <span class="string">passive/s</span>    <span class="string">iseg/s</span>    <span class="string">oseg/s</span></span><br><span class="line"><span class="number">02</span><span class="string">:47:31</span> <span class="string">AM</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">8.51</span>      <span class="number">6.38</span></span><br><span class="line"></span><br><span class="line"><span class="number">02</span><span class="string">:47:30</span> <span class="string">AM</span>  <span class="string">atmptf/s</span>  <span class="string">estres/s</span> <span class="string">retrans/s</span> <span class="string">isegerr/s</span>   <span class="string">orsts/s</span></span><br><span class="line"><span class="number">02</span><span class="string">:47:31</span> <span class="string">AM</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># active/s: Number of locally-initiated TCP connections per second (e.g., via connect()).</span></span><br><span class="line"><span class="comment"># passive/s: Number of remotely-initiated TCP connections per second (e.g., via accept()).</span></span><br><span class="line"><span class="comment"># retrans/s: Number of TCP retransmits per second.</span></span><br><span class="line"><span class="comment"># The active and passive counts are often useful as a rough measure of server load: number of new accepted connections (passive), and number of downstream connections (active). It might help to think of active as outbound, and passive as inbound, but this isnt strictly true (e.g., consider a localhost to localhost connection).</span></span><br><span class="line"><span class="comment"># Retransmits are a sign of a network or server issue; it may be an unreliable network (e.g., the public Internet), or it may be due a server being overloaded and dropping packets. The example above shows just one new TCP connection per-second.</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/proc/sys/net/ipv4/tcp_mem</span></span><br><span class="line"><span class="number">3082008</span><span class="number">4109346</span><span class="number">6164016</span> <span class="comment"># here is 4K page, but in sysctl.conf config file was bytes</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/proc/net/sockstat</span></span><br><span class="line"><span class="attr">sockets:</span> <span class="string">used</span> <span class="number">181</span>                                <span class="comment"># total sockets</span></span><br><span class="line"><span class="attr">TCP:</span> <span class="string">inuse</span> <span class="number">16</span> <span class="string">orphan</span> <span class="number">0</span> <span class="string">tw</span> <span class="number">0</span> <span class="string">alloc</span> <span class="number">27</span> <span class="string">mem</span> <span class="number">5</span>       <span class="comment"># inuse = netstat lnt | grep ^tcp | wc l; cat /proc/sys/net/ipv4/tcp_max_orphans</span></span><br><span class="line"><span class="attr">UDP:</span> <span class="string">inuse</span> <span class="number">3</span> <span class="string">mem</span> <span class="number">0</span>                              </span><br><span class="line"><span class="attr">UDPLITE:</span> <span class="string">inuse</span> <span class="number">0</span></span><br><span class="line"><span class="attr">RAW:</span> <span class="string">inuse</span> <span class="number">0</span></span><br><span class="line"><span class="attr">FRAG:</span> <span class="string">inuse</span> <span class="number">0</span> <span class="string">memory</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># orphan , /proc/sys/net/ipv4/tcp_max_orphans, Maximal number of TCP sockets not attached to any user file handle held by system.</span></span><br><span class="line"><span class="comment"># tw , netstat ant | grep TIME_WAIT | wc l</span></span><br><span class="line"><span class="comment"># alloc, netstat ant | grep ^tcp | wc l</span></span><br><span class="line"><span class="comment"># mem,  proc/net/sockstat, specifically the mem field, is where to look. This value is is reported in kernel pages and corresponds directly to /proc/sys/net/ipv4/tcp_mem.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#At the individual socket level, memory is allocated in kernel space only until the user space code reads it, at which time the kernel memory is freed. sk_buff-&gt;truesize is the sum of both the amount of data buffered, as well as the socket structure itself</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#The device drivers allocate a region of memory for the device to perform DMA to incoming packets</span></span><br><span class="line"><span class="comment">#https://unix.stackexchange.com/questions/419518/how-to-tell-how-much-memory-tcp-buffers-are-actually-using/419525</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### tcp status</span></span><br></pre></td></tr></table></figure><p>$ cat /proc/net/tcp<br>  sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode</p><p>$ cat /proc/net/dev<br>Inter-   |   Receive                                                |  Transmit<br> face    |bytes    packets errs drop fifo frame compressed multicast|bytes    packets errs drop fifo colls carrier compressed<br>enp1s0f0:  8681      58    0    0    0     0          0        18    10054      48    0    0    0     0       0          0<br>enp1s0f1:  3200      30    0    0    0     0          0        17     1110      15    0    0    0     0       0          0<br>  eno1:     180       3    0    0    0     0          0        72        0       0    0    0    0     0       0          0<br> bond0:   11881      88    0    0    0     0          0        35    11164      63    0    0    0     0       0          0<br>  eth0:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0<br>    lo:    1120      13    0    0    0     0          0         0     1120      13    0    0    0     0       0          0</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### kernel <span class="keyword">drop</span></span><br><span class="line">eg: TcpExtTCPReqQFullDrop, TcpExtTCPReqQFullDoCookies   </span><br><span class="line">[<span class="number">1.</span>](https://github.com/netdata/netdata/issues/<span class="number">3234</span>#issuecomment<span class="number">-423935842</span>) The SYN queue tracks TCP handshakes <span class="keyword">until</span> connections are fully established. It overflows <span class="keyword">when</span> too many incoming TCP <span class="keyword">connection</span> requests hang <span class="keyword">in</span> the half-<span class="keyword">open</span> state <span class="keyword">and</span> the <span class="keyword">server</span> <span class="keyword">is</span> <span class="keyword">not</span> configured <span class="keyword">to</span> fall back <span class="keyword">to</span> SYN cookies*. Overflows are usually caused <span class="keyword">by</span> SYN flood DoS attacks (i.e. someone sends lots <span class="keyword">of</span> SYN packets <span class="keyword">and</span> never completes the handshakes).  </span><br><span class="line"><span class="number">2.</span> The accept queue holds fully established TCP connections waiting <span class="keyword">to</span> be handled <span class="keyword">by</span> the listening application. It overflows <span class="keyword">when</span> the <span class="keyword">server</span> application fails <span class="keyword">to</span> accept <span class="built_in">new</span> connections at the rate they are coming <span class="keyword">in</span>.    </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>$ awk /TcpExt/ { print $21,$22 } /proc/net/netstat<br>ListenOverflows ListenDrops<br>0 0</p><h1 id="ListenOverflows"><a href="#ListenOverflows" class="headerlink" title="ListenOverflows"></a>ListenOverflows</h1><h1 id="ListenDrops"><a href="#ListenDrops" class="headerlink" title="ListenDrops"></a>ListenDrops</h1><p>$ nstat -rsz | grep -Ei fail|crc|dis|drop|miss|err|over|timeout|jabb|full<br>IpInHdrErrors                   0                  0.0<br>IpInAddrErrors                  0                  0.0<br>IpInDiscards                    0                  0.0<br>IpOutDiscards                   58866              0.0<br>IpReasmTimeout                  0                  0.0<br>IpReasmFails                    0                  0.0<br>IpFragFails                     0                  0.0<br>IcmpInErrors                    5                  0.0<br>IcmpInCsumErrors                0                  0.0<br>IcmpOutErrors                   0                  0.0<br>TcpAttemptFails                 27                 0.0<br>TcpInErrs                       6                  0.0<br>TcpInCsumErrors                 0                  0.0<br>UdpInErrors                     0                  0.0<br>UdpRcvbufErrors                 0                  0.0<br>UdpSndbufErrors                 0                  0.0<br>UdpInCsumErrors                 0                  0.0<br>UdpLiteInErrors                 0                  0.0<br>UdpLiteRcvbufErrors             0                  0.0<br>UdpLiteSndbufErrors             0                  0.0<br>UdpLiteInCsumErrors             0                  0.0<br>Ip6InHdrErrors                  0                  0.0<br>Ip6InTooBigErrors               0                  0.0<br>Ip6InAddrErrors                 0                  0.0<br>Ip6InDiscards                   0                  0.0<br>Ip6OutDiscards                  0                  0.0<br>Ip6ReasmTimeout                 0                  0.0<br>Ip6ReasmFails                   0                  0.0<br>Ip6FragFails                    0                  0.0<br>Icmp6InErrors                   0                  0.0<br>Icmp6OutErrors                  0                  0.0<br>Icmp6InCsumErrors               0                  0.0<br>Udp6InErrors                    0                  0.0<br>Udp6RcvbufErrors                0                  0.0<br>Udp6SndbufErrors                0                  0.0<br>Udp6InCsumErrors                0                  0.0<br>UdpLite6InErrors                0                  0.0<br>UdpLite6RcvbufErrors            0                  0.0<br>UdpLite6SndbufErrors            0                  0.0<br>UdpLite6InCsumErrors            0                  0.0<br>TcpExtSyncookiesFailed          2493               0.0<br>TcpExtLockDroppedIcmps          0                  0.0<br>TcpExtListenOverflows           0                  0.0<br>TcpExtListenDrops               0                  0.0<br>TcpExtTCPPrequeueDropped        0                  0.0<br>TcpExtTCPRenoRecovery           0                  0.0<br>TcpExtTCPSackRecovery           53258339           0.0<br>TcpExtTCPFullUndo               26344              0.0<br>TcpExtTCPRenoFailures           0                  0.0<br>TcpExtTCPSackFailures           2014346            0.0<br>TcpExtTCPLossFailures           102464             0.0<br>TcpExtTCPTimeouts               482369             0.0<br>TcpExtTCPLossProbeRecovery      1789543            0.0<br>TcpExtTCPRenoRecoveryFail       0                  0.0<br>TcpExtTCPSackRecoveryFail       833476             0.0<br>TcpExtTCPSchedulerFailed        0                  0.0<br>TcpExtTCPAbortOnTimeout         1277               0.0<br>TcpExtTCPAbortFailed            0                  0.0<br>TcpExtTCPSACKDiscard            0                  0.0<br>TcpExtTCPBacklogDrop            0                  0.0<br>TcpExtTCPMinTTLDrop             0                  0.0<br>TcpExtTCPDeferAcceptDrop        0                  0.0<br>TcpExtTCPTimeWaitOverflow       0                  0.0<br>TcpExtTCPReqQFullDoCookies      0                  0.0<br>TcpExtTCPReqQFullDrop           0                  0.0<br>TcpExtTCPRetransFail            5889               0.0<br>TcpExtTCPOFODrop                0                  0.0<br>TcpExtTCPFastOpenActiveFail     0                  0.0<br>TcpExtTCPFastOpenPassiveFail    0                  0.0<br>TcpExtTCPFastOpenListenOverflow 0                  0.0<br>IpExtInCsumErrors               0                  0.0<br>IpExtReasmOverlaps              0                  0.0</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">#### softirq networking</span><br><span class="line">$ cat /proc/net/softnet_stat</span><br><span class="line"># 4 cores</span><br><span class="line">000cc282 00000000 000004e7 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">0000b828 00000000 00000053 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">0000945b 00000000 00000046 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">0003d716 00000000 000001f7 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">-----    -----    --------                                              -------  -------</span><br><span class="line">   \      \_ drop count \                                                  \        \-flow limit cont</span><br><span class="line">    \_ packet count      \                                                  \-- cpu collision</span><br><span class="line">                          \- time sequeeze</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## in some overflow status</span><br><span class="line">024fd330 00000000 0000000d 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">01a95901 00000000 00000004 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">026bd147 00000000 00000009 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">036311fc 00000000 00000006 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">032f4c78 00000000 0000000b 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">01d79287 00000000 0000005a 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br><span class="line"></span><br><span class="line">#Each line of /proc/net/softnet_stat corresponds to a struct softnet_data structure, of which there is 1 per CPU.</span><br><span class="line"></span><br><span class="line">#The values are separated by a single space and are displayed in hexadecimal</span><br><span class="line">#The first value, sd-&gt;processed, is the number of network frames processed. This can be more than the total number of network frames received if you are using ethernet bonding. There are cases where the ethernet bonding driver will trigger network data to be re-processed, which would increment the sd-&gt;processed count more than once for the same packet.</span><br><span class="line"></span><br><span class="line">The second value, sd-&gt;dropped, is the number of network frames dropped because there was no room on the processing queue. More on this later.</span><br><span class="line">If second values are gorwing, improve sysctl -w net.core.netdev_max_backlog = 2000, A value over 10000 is unlikely to be very helpful.</span><br><span class="line">The second colume number of frames dropped due to netdev_max_backlog being exceeded</span><br><span class="line"></span><br><span class="line">#The third value, sd-&gt;time_squeeze, is (as we saw) the number of times the net_rx_action loop terminated because the budget was consumed or the time limit was reached, but more work could have been. Increasing the budget as explained earlier can help reduce this.</span><br><span class="line">#If 3rd column is growing,improve sysctl -w net.core.netdev_budget=600</span><br><span class="line">Be careful of increasing this value unless there is a very good reason. A value exceeding 1000 is unlikely to be very helpful. In fact increasing this value too much can have detrimental effect and in the worse case scenario lead to softirq hangs or performance problems, as the softirqs can run for too long and starve other processes of CPU</span><br><span class="line">3rd colume is number of times ksoftirqd ran out of netdev_budget or CPU time when there was still work to be done</span><br><span class="line"></span><br><span class="line">#The next 5 values are always 0.</span><br><span class="line"></span><br><span class="line">#The ninth value, sd-&gt;cpu_collision, is a count of the number of times a collision occurred when trying to obtain a device lock when transmitting packets. This article is about receive, so this statistic will not be seen below.</span><br><span class="line"></span><br><span class="line">#The tenth value, sd-&gt;received_rps, is a count of the number of times this CPU has been woken up to process packets via an Inter-processor Interrupt</span><br><span class="line"></span><br><span class="line">#The last value, flow_limit_count, is a count of the number of times the flow limit has been reached. Flow limiting is an optional Receive Packet Steering feature that will be examined shortly.</span><br><span class="line"></span><br><span class="line">#If you decide to monitor this file and graph the results, you must be extremely careful that the ordering of these fields hasnt changed and that the meaning of each field has been preserved. You will need to read the kernel source to verify this.</span><br><span class="line"></span><br><span class="line"><span class="attribute">seq_printf(seq,</span></span><br><span class="line">       &quot;%08x %08x %08x %08x %08x %08x %08x %08x %08x %08x %08x\n&quot;,</span><br><span class="line">       sd-&gt;processed, sd-&gt;dropped, sd-&gt;time_squeeze, 0,</span><br><span class="line">       0, 0, 0, 0, /* was fastroute */</span><br><span class="line">       sd-&gt;cpu_collision, sd-&gt;received_rps, flow_limit_count);</span><br><span class="line"></span><br><span class="line">#convert these data by bash</span><br><span class="line"></span><br><span class="line">cat ./softnet_stat.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">awk &#x27;BEGIN &#123;</span><br><span class="line">     t[1]=&quot;sd-&gt;processed&quot;</span><br><span class="line">     t[2]=&quot;sd-&gt;dropped&quot;</span><br><span class="line">     t[3]=&quot;sd-&gt;time_squeeze&quot;</span><br><span class="line">     t[9]=&quot;sd-&gt;cpu_collision&quot;</span><br><span class="line">     t[10]=&quot;sd-&gt;received_rps&quot;</span><br><span class="line">     printf &quot;%s %s %s %s %s\n&quot;,t[1],t[2],t[3],t[9],t[10];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   printf &quot;%d %d %d %d %d\n&quot;, strtonum( &quot;0x&quot;$1 ),strtonum( &quot;0x&quot;$2 ),strtonum( &quot;0x&quot;$3 ),strtonum( &quot;0x&quot;$9 ),strtonum( &quot;0x&quot;$10 )</span><br><span class="line">&#125;&#x27;  /proc/net/softnet_stat | column -t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Full throughput duplex</span><br><span class="line">$ watch -d sh ./softnet_stat.sh</span><br><span class="line">Every 2.0s: sh ./softnet_stat.sh                                                                                                  Mon Feb 17 00:23:15 2020</span><br><span class="line"></span><br><span class="line">sd-&gt;processed  sd-&gt;dropped  sd-&gt;time_squeeze  sd-&gt;cpu_collision  sd-&gt;received_rps</span><br><span class="line">46897674       0            15                0                  0</span><br><span class="line">33150875       0            4                 0                  0</span><br><span class="line">46371491       0            10                0                  0</span><br><span class="line">64446426       0            7                 0                  0</span><br><span class="line">57994272       0            11                0                  0</span><br><span class="line">34935375       0            90                0                  0</span><br><span class="line"></span><br><span class="line">### when I was watch it, the time_squeeze not increased. only slowly increasing at rx_steer_missed_packets: 1623</span><br><span class="line">#Herer is mellanox doc: Number of packets that was received by the NIC, however was discarded because it did not match any flow in the NIC flow table. supported from kernel 4.16</span><br><span class="line"></span><br><span class="line"># here is 2 v 1 test case,  node 1 and node 2 send and receive to node 3, there is no tcp retrans in node(little , 0.5/s), but it was full throughput (bond, dual port, tx:2.4GB/s tx 2.4GB/s), only a lot of tcp retrans in node 1 and node 2 (190~200/s) </span><br><span class="line"></span><br><span class="line">If you follow the softnet_break label you stumble upon something interesting. From net/core/dev.c:</span><br><span class="line"><span class="attribute">softnet_break:</span></span><br><span class="line">  sd-&gt;time_squeeze++;</span><br><span class="line">  __raise_softirq_irqoff(NET_RX_SOFTIRQ);</span><br><span class="line">  goto out;</span><br><span class="line"></span><br><span class="line">/sys/class/net/em2/statistics/</span><br><span class="line">/proc/net/dev</span><br><span class="line"></span><br><span class="line">$ netstat -s | grep -i retr</span><br><span class="line">    905260805 segments retransmited</span><br><span class="line">    9599 times recovered from packet loss due to fast retransmit</span><br><span class="line">    TCPLostRetransmit: 6059087</span><br><span class="line">    152 timeouts after reno fast retransmit</span><br><span class="line">    737224794 fast retransmits</span><br><span class="line">    13068581 forward retransmits</span><br><span class="line">    146850567 retransmits in slow start</span><br><span class="line">    1015 classic Reno fast retransmits failed</span><br><span class="line">    3214020 SACK retransmits failed</span><br><span class="line">    TCPRetransFail: 16</span><br><span class="line">    TCPSynRetrans: 61</span><br></pre></td></tr></table></figure><p><a href="http://www.brendangregg.com/blog/2014-09-06/linux-ftrace-tcp-retransmit-tracing.html">tcpretrans</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">11:14:40 0      10.0.19.53:988      R&gt; 10.0.4.143:1022     ESTABLISHED</span><br><span class="line">11:14:40 0      10.0.19.53:988      R&gt; 10.0.4.143:1022     ESTABLISHED</span><br><span class="line">11:14:40 0      10.0.19.53:988      R&gt; 10.0.4.143:1022     ESTABLISHED</span><br><span class="line"></span><br><span class="line">$ grep -E <span class="string">&quot;CPU0|enp1s0f0&quot;</span> /proc/interrupts</span><br><span class="line">           CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7</span><br><span class="line"> 48:          0          0          1          0         73          0        154          0   PCI-MSI 524289-edge      i40e-enp1s0f0-TxRx-0</span><br><span class="line"> 49:         70          0         51         45          0        112          0        121   PCI-MSI 524290-edge      i40e-enp1s0f0-TxRx-1</span><br><span class="line"> 50:         34          0        273         90         33         53          0          7   PCI-MSI 524291-edge      i40e-enp1s0f0-TxRx-2</span><br><span class="line"> 51:      83286          0          0        229          0          1          0          0   PCI-MSI 524292-edge      i40e-enp1s0f0-TxRx-3</span><br><span class="line"> 52:          0        226          0          0          5          0          1          0   PCI-MSI 524293-edge      i40e-enp1s0f0-TxRx-4</span><br><span class="line"> 53:         29          0        192         72          0          0          0          1   PCI-MSI 524294-edge      i40e-enp1s0f0-TxRx-5</span><br><span class="line"> 54:         16          0          0          0          0          5        438         11   PCI-MSI 524295-edge      i40e-enp1s0f0-TxRx-6</span><br><span class="line"> 55:         78          1          0          0          0       6430          0      13438   PCI-MSI 524296-edge      i40e-enp1s0f0-TxRx-7</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="kernel-improved"><a href="#kernel-improved" class="headerlink" title="kernel improved"></a>kernel improved</h5><p>linux 4.4 lockless listener<br>&lt; linux 4.4, each listener has a request queue. after insert a new request the each sync package will lock listener</p><blockquote><p>= linux 4.4 create an new tcp ehash table for reduece the lock compete </p></blockquote><p>tcp_probe<br>That function is now replaced by tcp/tcp_probe trace-event. You can use it via ftrace or perftools</p><h4 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S enp1s0f0 | grep -Ei <span class="string">&#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb|full&#x27;</span></span><br><span class="line">     rx_errors: 0</span><br><span class="line">     tx_errors: 0</span><br><span class="line">     rx_dropped: 0</span><br><span class="line">     tx_dropped: 0</span><br><span class="line">     rx_over_errors: 0</span><br><span class="line">     rx_crc_errors: 0</span><br><span class="line">     rx_frame_errors: 0</span><br><span class="line">     fdir_miss: 710538</span><br><span class="line">     fdir_overflow: 0</span><br><span class="line">     rx_fifo_errors: 0</span><br><span class="line">     rx_missed_errors: 0</span><br><span class="line">     tx_aborted_errors: 0</span><br><span class="line">     tx_carrier_errors: 0</span><br><span class="line">     tx_fifo_errors: 0</span><br><span class="line">     tx_heartbeat_errors: 0</span><br><span class="line">     tx_timeout_count: 0</span><br><span class="line">     rx_length_errors: 0</span><br><span class="line">     rx_long_length_errors: 0</span><br><span class="line">     rx_short_length_errors: 0</span><br><span class="line">     rx_csum_offload_errors: 0</span><br><span class="line">     alloc_rx_page_failed: 0</span><br><span class="line">     alloc_rx_buff_failed: 0</span><br><span class="line">     tx_hwtstamp_timeouts: 0</span><br><span class="line">     fcoe_bad_fccrc: 0</span><br><span class="line">     rx_fcoe_dropped: 0</span><br><span class="line"></span><br><span class="line">$ ethtool -S p2p2 | grep -Ei <span class="string">&#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb&#x27;</span></span><br><span class="line">     rx_errors: 0</span><br><span class="line">     tx_errors: 0</span><br><span class="line">     rx_dropped: 0</span><br><span class="line">     tx_dropped: 0</span><br><span class="line">     rx_length_errors: 0</span><br><span class="line">     rx_crc_errors: 0</span><br><span class="line">     rx_alloc_fail: 0</span><br><span class="line">     rx_pg_alloc_fail: 0</span><br><span class="line">     veb.rx_discards: 0</span><br><span class="line">     veb.tx_discards: 0</span><br><span class="line">     veb.tx_errors: 0</span><br><span class="line">     port.tx_errors: 0</span><br><span class="line">     port.rx_dropped: 0</span><br><span class="line">     port.tx_dropped_link_down: 0</span><br><span class="line">     port.rx_crc_errors: 0</span><br><span class="line">     port.tx_timeout: 0</span><br><span class="line">     port.rx_length_errors: 0</span><br><span class="line">     port.rx_oversize: 0</span><br><span class="line">     port.rx_jabber: 0</span><br><span class="line">     port.arq_overflows: 0</span><br><span class="line">     port.tx_hwtstamp_timeouts: 0</span><br></pre></td></tr></table></figure><p>rx_no_buffer_count,there was nowhere to DMA the packet<br>DMA skb-data to rx-buffer-info(linux RAM, soft-interrupt).</p><p>RNBC is a warning sign of a slow drain from the MAC and can be treated by adding more buffers.<br>There will be times when the RNBC will go up, but it will look like the stack and driver have a ton of buffers but work is not being done.  If you have a task that is eating up the CPU, the ISR or polling routines wont refill the buffers fast enough and RNBC will happen.</p><p>Imagine we have a slow CPU, but a wicked fastbus.  The software is very slow to process the descriptors and return them, but once the descriptors are given to the hardware, it empties the backlog (read the FIFO) faster than the incoming frames are filling the FIFO.  Returning to our kitchen sink analogy, the water is coming in at a fairly constant rate.  But imagine the stopper is down, making the sink fill up.  Just before it over flows, the drain is opened and down it goes.  Once the water doesnt go down the drain would be the same moment our RNBC would be incremented.  The kitchen sink itself becomes our FIFO and if the FIFO is big enough, it can save frame for quiet some time.  This is 1 Gigabit (or faster) that were talking about, so with a good sized FIFO (24K RX for example) thats only 375 frames at 64 bytes, or 267microseconds of data.  Thats not very much time.  But in a world full of 2 and 3 Gigahertz CPUs thats long enough.</p><p>rx_missed_error,rx_no_buffer_count happened enough times that packets were dropped<br>MPC is a failure condition leading to dropped packets and can be treated with more buffers and faster interconnect buses</p><p><code>fifo queues(ring buffer or kernel queue?) full will cause the error too ? and the package not go to NIC reveive ring buffer(ring buffer or kernel queue ?), if you have no any CPU or memory resource, you will got the same result, NIC/CPU/MEM resource not enough will cause the same issue</code></p><p><code>I guess if the drop in fifo queue from driver, it &#39;s the rx_missed_error, if it dropped in kernel, it &#39;s the overrun</code> </p><p><a href="https://www.cisco.com/c/en/us/support/docs/dial-access/asynchronous-connections/15286-serial-overruns.html">Q. What are overruns on a serial interface?</a></p><p>A. Overruns appear in the output of the show interface Serial 0 command when the serial receiver hardware is unable to hand received data to a hardware buffer because the input rate exceeds the receivers ability to handle the data.<br>This occurs due to a limitation of the hardware. Overruns occur when the internal First In, First Out (FIFO) buffer of the chip is full, but is still tries to handle incoming traffic. The serial controller chip has limited internal FIFO.<br>Some chips, for example, have only 256 bytes of buffer space. Data from the network is received into the buffer, whereupon the chip attempts to move the data from the buffer to the routers shared memory for the CPU to process. If the chip is not able to move the data from its internal FIFO buffer into shared memory faster than the rate at which data is received on the interface, then the internal FIFO buffer is full, incoming data is dropped, and the overrun counter is incremented. </p><p>Thank goodness things like TCP/IP will tell the applications data has been dropped, but if using a lossy frame type like UDP its just too bad, your frame is lost to the ether.</p><p>Imagine if you will, an interconnect bus that is slow.  Very slow.  Like a PCI 33hz bus.  Now attach that to a full line rate 1 Gigabit 64 byte packet data stream.  At one descriptor per packet, thats about 1.4 million descriptors per second.  In this case the software is very fast, faster than the bus.  So the number of available descriptors is always kept a level that keeps the buffers available to the hardware to conduct a DMA.  But because the bus is so slow, data backs up into the FIFO.  Now that is what the FIFO is for.  By buffering the packet, it tries to give the packet the best chance at making into host memory alive.  In our slow case, the buffering isnt enough and the FIFO fills up.  It is draining slower than its filling, its just a like a slow draining kitchen sink.  Eventually it overflows and makes a big mess.  Thank goodness things like TCP/IP will tell the applications data has been dropped, but if using a lossy frame type like UDP its just too bad, your frame is lost to the ether.  If you need to keep track, but need to use UDP, youll need to monitor the MPC count and decide what you want to do when it goes up.</p><p><a href="https://community.mellanox.com/s/article/counters-troubleshooting-for-linux-driver">Counters Troubleshooting for Linux Driver</a><br>rx_errors: Number of received packets that were dropped due to PHY layer related errors. For example:</p><ul><li>symbol error, or an invalid block.</li><li>Length related errors (greater than MTU octets, length less than 64 octets, error in length)</li><li>Bad CRC that are not runts, jabbers, or alignment errors.</li><li>This counter is increased at point (1) in the figure above.</li></ul><p>rx_dropped: Number of received packets which were chosen to be discarded even though no errors had been detected to prevent them from passing to the upper layer. For example, drop due to buffer overflow.</p><p>rx_crc_errors: Number of received frames with a bad CRC that are not runts, jabbers, or alignment errors.</p><p>rx_jabbers: Number of received frames with a length greater than MTU octets and a bad CRC.</p><p>rx_fifo_errors: an indication that the RX interrupts cannot allocate buffers fast enough and so the adapter is dropping packets.</p><p>rx_over_errors: Number of received frames that were dropped due to on hardware port receive buffer overflow.</p><p>tx_errors: Number of frames that failed to transmit. Include frame dropped due to error in the length field.</p><p>tx_dropped: Number of transmitted frames that were dropped.</p><p>vport_rx_dropped: Received packets discarded due to luck of software receive buffers (WQEs).<br>Important indication to weather RX completion routines are keeping up with HW ingress packet rate.</p><p>vport_rx_filtered: Received packets dropped due to packet check that was failed. For example:</p><ul><li>Incorrect VLAN</li><li>Incorrect Ethertype</li><li>unavailable queue/QP</li><li>Loopback prevention<br>This counter is increased at point (2) in the figure above.<br>Note: In high performance scenarios vport_rx_filters may increment due to rx_over_errors. In addition,<br>In SRIOV configurations vport_rx_filters increments can be seen and it is a normal condition (expected).</li></ul><p>vport_tx_errors: Packets dropped due to transmit errors.</p><p>counter:</p><p>rx_lro_aggregated: The number of packets processed by the LRO (Large Receive Offload) mechanism (good for IPv4 TCP), and should be equal to rx_packets in good/normal condition.</p><p>rx_lro_flushed: The number of offloaded packets the LRO mechanism passed to kernel. Ideally the packet size is 64KB (depends on kernel). 64KB is the maximum packet size.</p><p>rx_lro_no_desc: This is abnormal condition, and mostly will not happen. The LRO mechanism has no room to receive packets from the adapter. In normal condition, it should not increase, mostly when using 64 packets budget and flush LRO descriptors every NAPI cycle. In addition, LRO has a lot of space (much more than 64).</p><p>tx_tso_packets: When using TCO (TCP Segmentation Offload), it offloads tasks from the CPU and improve CPU utilization. This counter shows the number of offloaded TSO packets received by the driver from the TCP layer. The rate of TSO This counter is correlated strongly with the TX performance and CPU utilization. TSO is crucial for wire speed performance, and the kernel will enable it only when the CPU is not on heavy load.</p><p>tx_queue_stopped: The number of times the kernel didnt manage to send packets as the queue was full. the tx_queue_stopped and tx_wake_queue are usually equal (TX queue is stopped and later gets wake up call). This is an important indication to whether TX completion routines are keeping up with the transmit routines. If the application is sending in an higher rate than driver is evicting CQEs from the buffer this will start to go up.</p><p>tx_wake_queue: The number of time the kernel got message from the adapters that there is a queue to run (tx_queue_stopped is released). his is an important indication to whether TX completion routines are keeping up with the transmit routines. If the application is sending in an higher rate than driver is evicting CQEs from the buffer this will start to go up.</p><p>tx_timeout: This a rare event, that usually indicate on a severe issue. It means around 15 sec timeframe that passed since a packet was sent without a CQE generated. Usually a lost interrupt or a bad cable.</p><p>rx_csum_good: The number of packets received with good checksum (in L4).</p><p>rx_csum_none: The number of packets received with no checksum (in L4).</p><p>tx_cksum_offload: The number of packets sent with hardware checksum.</p><h3 id="About-TCP-fast-retrans"><a href="#About-TCP-fast-retrans" class="headerlink" title="About TCP fast retrans"></a><a href="http://www.ietf.org/rfc/rfc2581.txt">About TCP fast retrans</a></h3><p>twice duplicated ACK because package out of order<br>Dropped packages must be triple duplicated ACK</p><p>If A send 4 TCP segments to B, Number is as follow, N-1 reache B because A received ACK(N) of B, As the order, The received ACK number:<br>                  A &gt; B<br>A send order was N-1,N,N+1,N+2</p><p>B received order</p><p>N-1NN+1N+2<br>A received single ACK (N)</p><p>N-1NN+2N+1<br>A received single ACK (N)</p><p>N-1N+1NN+2<br>A received twice ACK (N)</p><p>N-1N+1N+2N<br>A received triple ACK (N)</p><p>N-1N+2NN+1<br>A received twice ACK (N)</p><p>N-1N+2N+1N<br>A received triple ACK (N)</p><p>If N loss, or not reach B</p><p>N-1N+1N+2<br>A received triple ACK (N)</p><p>N-1N+2N+1<br>A received triple ACK (N)</p><p>TCP segment out of order, there are 2/5 = 40% cause A received triple duplicated ACK(N);<br>If N loss, the ratio is 100%</p><p>When A received triple duplicated ACK(N) and start a Fast Retransmit is OK , retransmit N right now, It s need to Fast Recovery, for reduce the package loss problem</p><p>If A receive twice duplicated ACK(N),It s must be out of order that means all packages has reach B, Just re-sort all packages, Don t need to retrans.</p><h5 id="ABout-TCP-segment-out-of-order"><a href="#ABout-TCP-segment-out-of-order" class="headerlink" title="ABout TCP segment out of order"></a>ABout TCP segment out of order</h5><p>TCP segment packing in IP packagesIf IP package out of order,also tcp</p><ol><li>ECMP loading balance</li></ol><p>multiple path loading balance, base per-packet load balanceeg: packet 1,3,5 go path1, packet 2,4,6 go to path2, its hard to control packet 1 arrived early than packet 2 reach the destination</p><p>Per-session load balance base TCP 5 tuple(source ip,source port,des ip,des port, transfer protocol), the same TCP session will go to a same path</p><ol start="2"><li>route internal traffic scheduling<br>There are multiple traffic process unit in some of route(stream process unit),eg: packet 1,3,5 process by unit1, packet 2,4,6 process by unit2, its hard to control packet 1 arrived early than packet 2 reach the destination</li></ol><p>kernel receive out of order TCP segment, put them to buffer and then all TCP segment has arrived, after re-sort, send all data to application<br>Out of order segment will cause buffer consumption, direct trigger B advertised window size be samller, cause send A window get smaller and smaller,to impact senders transmission performance.</p><p>If A not do fast retransat last it will be retrans by retransmit timer timeout(timeout retransmit),but at this time there is a little winodow size in A, sender A s transmission speed will be too bad.</p><p>Before there is no fast retransmit/recovery, retrans by sender s retransmit timeout,In timeout range, if sender not receive receivers ack hat means the package loss, sender will resend it.</p><ul><li>Why package loss<ul><li>package checksum error</li><li>Traffic jam/Network congestion</li><li>Network connection loss for some unknow reason</li><li>Some of convergence-algorithm in your route</li></ul></li></ul><p>But sender don t know what the situation,<br>The stupid way is sender set half of speed(CWND=1/2),It s good at traffic jam,if connection loss, all packages will loss no matter sender slowing down,For checksum erorr,loss packages is a happenstance.If I loss a package, sender will tuning down the speed, So fast retransmit come out because receiver could recevice the ACK ,because connection has not loss,if in timeout range not receive large than 2 duplicated ACK thaat means maybe is out of order,don t need retrans, just re-sort in receiver.<br>But if sender receive &gt;= 3 x duplicated ACK,loss package has the high possibility.<br>That means sender could receive ACK,The network connection not loss,retrans it first,don t slowing down the speed, if got the correct ACK that means there is no problem and drop that package, If still recive duplicated ACK, maybe it s traffic jam, slowing down the speed.</p><h3 id="NIC-receive-data"><a href="#NIC-receive-data" class="headerlink" title="NIC receive data"></a><a href="https://wsgzao.github.io/post/rps/">NIC receive data</a></h3><p>I guess NIC transfer data by the frame, and the frame has be splitted in sk_buff</p><p>packet -&gt; NIC -&gt; internal hardware buffer or ring buffer -&gt; hardware interrupt request -&gt; software interrupt operation -&gt;<br>from buffer to network stack -&gt; forwarded/discarded/rejected/passed to a socket receive queue for an application -&gt;<br>remove from network stack until no packets left in NIC buffer or a certain number of packets are transferred (/proc/sys/net/core/dev_weight)</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in"> network </span>(packages)</span><br><span class="line">  |</span><br><span class="line">  |</span><br><span class="line"> NIC   (hardware)</span><br><span class="line">  |</span><br><span class="line">  | &lt;-------DMA copy the package <span class="keyword">to</span> ring bufffer</span><br><span class="line">rx ring buffer (kernel memory)</span><br><span class="line">  | </span><br><span class="line">  | </span><br><span class="line">Driver  (kernel)  trigger a<span class="built_in"> hardware </span>interrupt <span class="keyword">to</span> kernel( ring buffer got a package)</span><br><span class="line">  |               The NIC <span class="keyword">from</span> the driver raised the<span class="built_in"> IRQ </span><span class="keyword">to</span> the kernel -- &gt; the kernel runs<span class="built_in"> IRQ </span>handler --&gt; NAPI started</span><br><span class="line">  |</span><br><span class="line">  |  &lt;---driver call into NAPI <span class="keyword">to</span> start a poll loop <span class="keyword">if</span> NAPI was <span class="keyword">not</span> running already</span><br><span class="line">NAPI <span class="keyword">or</span> backlog (ksoftirqd call NAPI poll function got the package <span class="keyword">from</span> ring buffer) </span><br><span class="line">  |  &lt;---ring buffer unmapped the memory <span class="keyword">from</span> the package</span><br><span class="line">  |  &lt;---Data that was DMAd into memory is passed up the networking layer as an <span class="string">&#x27;skb&#x27;</span> <span class="keyword">for</span> more processing.</span><br><span class="line">  |  NAPI poller is added <span class="keyword">to</span> poll_list -&gt; softirq_pending bit <span class="builtin-name">set</span> -&gt;  run_ksoftirqd checks softirq_pending bit -&gt; Registered handler called <span class="keyword">from</span> softirq_vec handlers</span><br><span class="line">  |   (<span class="keyword">from</span> softnet_data Poll list)       (<span class="keyword">to</span> softirq_pending bits)   (ksoftirqd/0 <span class="keyword">if</span> pending -&gt; __do_softirq() -&gt; net_rx_action())</span><br><span class="line">  |  </span><br><span class="line">  | poll_list entry received -&gt; Budget <span class="keyword">and</span> Elapsed Time Checked -&gt; Driver poll function called -&gt;  Packet harvested <span class="keyword">from</span> ring buffer</span><br><span class="line">  |  </span><br><span class="line">  |  Without NAPI: 1 interrupt per packet  high CPU load                                                                     </span><br><span class="line">  |  With NAPI: polling during high packet arrival times</span><br><span class="line">  |  <span class="literal">No</span> work <span class="keyword">to</span> drop packets <span class="keyword">if</span> kernel is too busy (Ring buffer overwrite by NIC)</span><br><span class="line">  |  the ringbuffer is the RAM, <span class="keyword">if</span> there is <span class="literal">no</span> special design</span><br><span class="line">  |                                                                     </span><br><span class="line">packet steering (Incoming<span class="built_in"> network </span>data frames are distributed among multiple CPUs <span class="keyword">if</span> packet steering support)</span><br><span class="line">  |</span><br><span class="line">  |  continue by <span class="string">&quot;Driver poll function called&quot;</span> -&gt; Packets passed <span class="keyword">for</span> possible GRO -&gt; Packets coalesced <span class="keyword">or</span> passed on toward  protocol stacks</span><br><span class="line">  |</span><br><span class="line">  |  (net_rx_action() -&gt; softnet_data Poll list -&gt; mydrv_poll() -&gt; napi_gro_receive() ---------&gt; net_receive_skb)</span><br><span class="line">  |                                                    | Packet harvested <span class="keyword">from</span> ring buffer   |  Packets coalesced <span class="keyword">or</span> passed on toward protocol stacks</span><br><span class="line">  |                                                    |---&gt;ring buffer                      |---&gt;GRO list</span><br><span class="line">  |</span><br><span class="line">network protocol stacks(TCP<span class="built_in">/IP </span>Ethernet) (kernel, the data frames are handed <span class="keyword">to</span> the protocol layers <span class="keyword">from</span> the queues)</span><br><span class="line">  |</span><br><span class="line">  |</span><br><span class="line">socket buffer (kernel)</span><br><span class="line">  |</span><br><span class="line">  |</span><br><span class="line">Application  (user)</span><br></pre></td></tr></table></figure><p>Some devices have the ability to write incoming packets to several different regions of RAM simultaneously; each region is a separate queue. This allows the OS to use multiple CPUs to process incoming data in parallel, starting at the hardware level.</p><p>Interrupts are re-enabled after polling stops</p><ul><li>NAPI Exit<ul><li>No more NAPI poll structures to process</li><li>netdev_budget Exceeded<ul><li>Each driver hardcoded budget for one NAPI structure of 64</li><li>Default is 300</li><li>Approximately 5 driver poll calls</li></ul></li><li>softirq Time Window Exceeded</li></ul></li><li>If no structures remain, re-enable IRQ interrupt</li></ul><h4 id="NIC-lt--gt-driver"><a href="#NIC-lt--gt-driver" class="headerlink" title="NIC &lt;&gt; driver"></a>NIC &lt;&gt; driver</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  --<span class="literal">-</span><span class="comment">1</span><span class="string">.</span> <span class="comment">Allocate</span> <span class="comment">sk_buffer</span>--<span class="literal">-</span>&gt; <span class="comment">SKB|SKB|SKB</span> <span class="comment">(memory)</span> &lt;--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">6</span><span class="string">.</span> <span class="comment">Write</span> <span class="comment">packet</span> <span class="comment">by</span> <span class="comment">DMA</span> --<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line">  <span class="comment">|</span>                                                                                           <span class="comment">|</span></span><br><span class="line"><span class="comment">Driver</span>                                                                                       <span class="comment">NIC</span> &lt;--<span class="literal">-</span><span class="literal">-</span> <span class="comment">5</span><span class="string">.</span> <span class="comment">New</span> <span class="comment">packet</span></span><br><span class="line"><span class="comment">|</span>   <span class="comment">|</span>                                                                                        <span class="comment">|</span> <span class="comment">|</span></span><br><span class="line"><span class="comment">|</span>   --<span class="literal">-</span><span class="literal">-</span><span class="comment">2</span><span class="string">.</span> <span class="comment">Write</span> <span class="comment">description</span> <span class="comment">to</span> <span class="comment">rx</span> <span class="comment">ring</span> --<span class="literal">-</span>&gt; <span class="comment">RX</span> <span class="comment">ring</span> <span class="comment">(memory)</span> &lt;--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">4</span><span class="string">.</span> <span class="comment">Fetch</span> <span class="comment">description</span> <span class="comment">by</span> <span class="comment">DMA</span> --<span class="literal">-</span> <span class="comment">|</span></span><br><span class="line"><span class="comment">|</span>                                                                                              <span class="comment">|</span></span><br><span class="line"><span class="comment"></span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">3</span><span class="string">.</span> <span class="comment">tell</span> <span class="comment">NIC</span> <span class="comment">there</span> <span class="comment">are</span> <span class="comment">some</span> <span class="comment">new</span> <span class="comment">descriptons</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span></span><br></pre></td></tr></table></figure><p>the kernel driver speed &lt; NIC receive packets, after the ring buffer full cause packet loss (rx_fifo_errors = proc/net/dev fifo = ifconfig overruns increase)</p><p>After 6. write packet to SKB by DMA (hardware to driver) &gt; NIC send a hardware interrupt(hardware) &gt; CPU receive the interrupt(drivers) &gt; kernel interrupt handler, send a soft interrupt(kernel) &gt; kernel soft interrrupt hander &gt; copy the SKB data to tcp/ip stacks (kernel)</p><h4 id="Received-packet-details"><a href="#Received-packet-details" class="headerlink" title="Received packet details"></a><a href="https://blog.packagecloud.io/eng/2016/06/22/monitoring-tuning-linux-networking-stack-receiving-data/">Received packet details</a></h4><ol><li><p>Driver is loaded and initialized.</p><ul><li>Kernel malloc a special kernel memory regions for NIC to receive/transmit the network packets<ul><li>struct sk_buff is the memory interface for netowrk data<ul><li><a href="http://elixir.free-electrons.com/linux/v4.4/source/include/linux/skbuff.h#L706">sk_buff has the point to these memory</a>, Ring buffer just store packet descriptor one by one</li><li>There are two status for ring buffer: used or ready<ul><li>ready means (the null descriptor) and it point a free sk_buff<ul><li>Linux malloc system memory mapping&gt; ring buffer queue ( interface:struct sk_buff, netdev_alloc_skb - allocate an skbuff for rx on a specific device ) <a href="https://elixir.bootlin.com/linux/v4.4/source/include/linux/skbuff.h#L706">source code</a></li></ul></li></ul></li></ul></li></ul></li></ul></li><li><p>Packet arrives at the NIC from the network.</p></li><li><p>Packet is copied (via DMA)the data to a ring buffer in kernel memory</p><ul><li>DMA just get data from NIC<ul><li>Got the the next ready descriptor, and save the data to the descriptor,the descriptor point the memory regions(sk_buff), and modify the ready descriptor to used</li><li>It s a FIFO queue</li></ul></li><li>NIC data -DMA-&gt; next ready packet descriptor (The default queuing discipline to use for network devices.)</li></ul></li><li><p>NIC generate the hardware interrupt to let the system know(trigger another software interrupt) a packet is in memory.</p><ul><li>If single packet trigger once IRQ to CPU, it must be exhaust a lot of CPU resources and it s inefficiency</li><li>the kernel begin to run interrupt handler(driver register)</li></ul></li><li><p>Driver calls into NAPI to start a poll loop if one was not running already.</p><ul><li>Create New API(NAPI) to merge IRQs, to reduce IRQ times</li><li>The driver s interrupt handeler use the napi_schedule trigger softirq(<a href="http://elixir.free-electrons.com/linux/v4.4/source/net/core/dev.c#L3204">NET_RX_SOFTIRQ</a> to wake up NAPI subsystem</li></ul></li><li><p>ksoftirqd processes run on each CPU on the system. They are registered at boot time. The ksoftirqd processes pull packets off the ring buffer by calling the NAPI poll function that the device driver registered during initialization.</p></li><li><p>Memory regions in the ring buffer that have had network data written to them are unmapped.</p></li><li><p>Data that was DMAd into memory is passed up the networking layer as an skb for more processing.</p><ul><li>DMA get finish -&gt; trigger the hardware interrupt (IRQ) let CPU receive the data -&gt; if not support NAPI, one irq ,got one frame with single irq ?</li><li>DMA get finish -&gt; trigger the hardware interrupt (IRQ) let CPU receive the data -&gt; support NAPI (driver support), merge IRQ to reduce CPU loading</li></ul></li><li><p>The softirq handler function net_rx_action will call the NAPI poll function to harvest packets (sk_buff).</p><ul><li><a href="http://elixir.free-electrons.com/linux/v4.4/source/drivers/net/ethernet/intel/igb/igb_main.c#L6361">What s the poll doing</a> ?<ul><li>Read out sk_buff from ring buffer</li><li>Check sk_buff, if single frame in multiple sk_buff, merge them</li><li>Deliver these network data frames to the upper-layer protocal from the queues</li><li>Clear sk_buff, reset ring buff to ready</li><li>Update kernel/driver statistics , receive how many packages , bytes</li><li>If no data or if trigger net.core.netdev_budget(packages numbers) or netdev_budget_usecs(timeout), exit the poll</li></ul></li></ul></li><li><p>Driver will disable the NIC IRQ, make sure will not received the new IRQ before poll finish all data</p></li><li><p>After poll receive all packegs, the NIC driver will re-enable NIC interrupts again and disable NAPI subsystem(napi_complete_done), exit pollng, NAPI subsystem will be disable, re-enable  NIC IRQ</p></li><li><p>Go to 3</p></li></ol><h4 id="NIC-Data-Processing"><a href="#NIC-Data-Processing" class="headerlink" title="NIC Data Processing"></a><a href="https://people.redhat.com/pladd/MHVLUG_2017-04_Network_Receive_Stack.pdf">NIC Data Processing</a></h4><h4 id="ring-buffer"><a href="#ring-buffer" class="headerlink" title="ring buffer"></a>ring buffer</h4><p>Does the ring buffer in ethernet NIC or it s just server memory ?<br>Yes, NIC has the microprocess and system memory, but its not ring buffer in linux</p><p>High end ethernet cards(eg: Mellanox) will almost certainly have their own memory and microprocessors to offload work from the rest of the computer.<br>BTW: eg: if tcp stack offload by NIC and bypass kernel that means the ring buffer in NIC.</p><p>Low end ethernet cards may not have their own onboard memory or microprocessors, and will use the host systems resources to handle network traffic.<br>BTW: I think if you NIC adapter could not offload anything, that means all packages will process by linux, some low end ethernet cards could bypass kernel too, could use direct memory access for some of IO</p><p>Infiniband cards on the other hand will tend to have their own onboard processors but no onboard memory, and will use direct memory access for all IO.<br><a href="https://stackoverflow.com/questions/17154759/how-much-memory-does-a-common-nic-have">reference</a></p><p><a href="https://www.ibm.com/support/knowledgecenter/en/SSQPD3_2.6.0/com.ibm.wllm.doc/nicringbuffers.html">Ring buffers on the NIC are important to handle bursts of incoming packets especially if there is some delay when the hardware interrupt handler schedules the packet receiving software interrupt (softirq). NIC ring buffer sizes vary per NIC vendor and NIC grade (that is, server or desktop). By increasing the Rx/Tx ring buffer size as shown below, you can decrease the probability of discarding packets in the NIC during a scheduling delay. The tool used to change ring buffer settings is the Linux utility, ethtool.</a></p><p><a href="https://ylgrgyq.github.io/2017/07/23/linux-receive-packet-1/">reference2</a><br><img src="/img/ring-buffer.png"><br><img src="/img/2012110119582618-tcp-reception.png"><br><img src="/img/2012110119593557-tcp-transmission.png"></p><h3 id="sriov-doc"><a href="#sriov-doc" class="headerlink" title="sriov doc"></a><a href="https://www.intel.com/content/dam/www/public/us/en/documents/technology-briefs/xl710-sr-iov-config-guide-gbe-linux-brief.pdf">sriov doc</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## intel</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;intel_iommu=on&#x27;</span></span><br><span class="line"><span class="comment">## AMD</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;iommu=pt&#x27;</span></span><br></pre></td></tr></table></figure><p><code>Please enable sr-iov in Dell BIOS setting with the NIC</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">On Linux Kernel version 3.8.x and above, the maximum number of VFs supported by the adapter can be queried by reading the sriov_totalvfs parameter via sysfs interface.</span><br><span class="line">```bash</span><br><span class="line">$ dmesg | grep Virtualization</span><br><span class="line">[    0.994611] DMAR: Intel(R) Virtualization Technology <span class="keyword">for</span> Directed I/O</span><br><span class="line"></span><br><span class="line">$ cat /sys/class/net/ens5f0/device/sriov_totalvfs</span><br><span class="line">64</span><br><span class="line">$ cat /sys/class/net/ens5f0/device/sriov_numvfs</span><br><span class="line">4</span><br><span class="line">$ lspci | grep Virtual</span><br><span class="line">03:02.0 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line">03:02.1 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line">03:02.2 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line">03:02.3 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line">03:0a.0 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line">03:0a.1 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line">03:0a.2 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line">03:0a.3 Ethernet controller: Intel Corporation XL710/X710 Virtual Function (rev 02)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 4 &gt; /sys/class/net/ens5f0/device/sriov_numvfs</span><br><span class="line"><span class="built_in">echo</span> 4 &gt; /sys/class/net/ens5f1/device/sriov_numvfs</span><br><span class="line">modprobe -r i40evf</span><br><span class="line">ip link <span class="built_in">set</span> ens5f0 vf 0 mac 52:54:00:e8:a5:78</span><br><span class="line">ip link <span class="built_in">set</span> ens5f0 vf 1 mac 52:54:00:e8:a5:79</span><br><span class="line">ip link <span class="built_in">set</span> ens5f0 vf 2 mac 52:54:00:e8:a5:80</span><br><span class="line">ip link <span class="built_in">set</span> ens5f0 vf 3 mac 52:54:00:e8:a5:81</span><br><span class="line">ip link <span class="built_in">set</span> ens5f1 vf 0 mac 52:54:00:e8:a5:82</span><br><span class="line">ip link <span class="built_in">set</span> ens5f1 vf 1 mac 52:54:00:e8:a5:83</span><br><span class="line">ip link <span class="built_in">set</span> ens5f1 vf 2 mac 52:54:00:e8:a5:84</span><br><span class="line">ip link <span class="built_in">set</span> ens5f1 vf 3 mac 52:54:00:e8:a5:85</span><br><span class="line"></span><br><span class="line">$ ip link show ens5f0</span><br><span class="line">19: ens5f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9000 qdisc mq state UP mode DEFAULT qlen 1000</span><br><span class="line">    link/ether 0c:c4:7a:88:0c:aa brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    vf 0 MAC 52:54:00:e8:a5:78, spoof checking on, link-state auto, trust off</span><br><span class="line">    vf 1 MAC 52:54:00:e8:a5:79, spoof checking on, link-state auto, trust off</span><br><span class="line">    vf 2 MAC 52:54:00:e8:a5:80, spoof checking on, link-state auto, trust off</span><br><span class="line">    vf 3 MAC 52:54:00:e8:a5:81, spoof checking on, link-state auto, trust off</span><br><span class="line">$ ip link show ens5f1</span><br><span class="line">20: ens5f1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000</span><br><span class="line">    link/ether 0c:c4:7a:88:0c:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    vf 0 MAC 52:54:00:e8:a5:82, spoof checking on, link-state auto, trust off</span><br><span class="line">    vf 1 MAC 52:54:00:e8:a5:83, spoof checking on, link-state auto, trust off</span><br><span class="line">    vf 2 MAC 52:54:00:e8:a5:84, spoof checking on, link-state auto, trust off</span><br><span class="line">    vf 3 MAC 52:54:00:e8:a5:85, spoof checking on, link-state auto, trust off</span><br></pre></td></tr></table></figure><h3 id="PCI-init"><a href="#PCI-init" class="headerlink" title="PCI init"></a>PCI init</h3><p>PCI devices are identified by registers in PCI configuration space</p><ul><li><p>Device drivers are compiled with a list of PCI device IDs that they can<br>control (MODULE_DEVICE_TABLE)</p></li><li><p>The kernel uses these tables to determine which device drivers to load<br> Use lspci -nn to find your device<br> Find PCI vendor and device ID<br> Look in /lib/modules/<code>uname -r</code>/</p></li><li><p>modules.pcimap (RHEL6 and earlier)</p></li><li><p>modules.alias (RHEL7 and later)<br>  egrep -i {vid}.*{did} /lib/modules/<code>uname -r</code>/modules.alias</p></li><li><p>PCI probe functions of the device drivers are called to set up devices</p></li><li><p>Enable the device</p></li><li><p>Request memory range &amp; I/O ports</p></li><li><p>Set DMA mask</p></li><li><p>Register ethtool functions supported by driver</p></li><li><p>Watchdog task setup</p></li><li><p>net_device_ops structure setup<br> Function pointers for opening, sending data, setting MAC, etc.</p></li><li><p>net_device struct creation</p></li></ul><h3 id="softirq-Subsystem-Initialization"><a href="#softirq-Subsystem-Initialization" class="headerlink" title="softirq Subsystem Initialization"></a>softirq Subsystem Initialization</h3><p>smpboo.c </p><ol><li>Create ksoftirqd kernel threads (1 per CPU)</li><li>ksoftirqd processing loops started</li><li>Per CPU data structures created<br> softnet_data Poll list<br> softirq_pending bits<br> softirq_vec handlers<pre><code>  net/core/dev.c (net_dev_init)</code></pre></li><li>Softirq handler (net_rx_action) for NET_RX_SOFTIRQ registered</li></ol><h3 id="ethtool-setting"><a href="#ethtool-setting" class="headerlink" title="ethtool setting"></a>ethtool setting</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In <span class="regexp">/etc/</span>sysconfig<span class="regexp">/network-scripts/i</span>fcfg</span><br><span class="line">ETHTOOL_OPTS=-G <span class="variable">$&#123;ifname&#125;</span> &#123;parm&#125; &#123;value&#125;</span><br><span class="line"></span><br><span class="line">In <span class="regexp">/etc/</span>NetworkManager<span class="regexp">/dispatcher.d/</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$1&quot;</span> = <span class="string">&quot;eth0&quot;</span> ] &amp;&amp; [ <span class="string">&quot;$2&quot;</span> = <span class="string">&quot;up&quot;</span> ]; then</span><br><span class="line"> ethtool -K <span class="string">&quot;$1&quot;</span> rx off gro off lro off</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> network </tag>
            
            <tag> benchmark </tag>
            
            <tag> nic </tag>
            
            <tag> irq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cpu</title>
      <link href="2018/05/27/cpu/"/>
      <url>2018/05/27/cpu/</url>
      
        <content type="html"><![CDATA[<h3 id="medium-speed"><a href="#medium-speed" class="headerlink" title="medium speed"></a><a href="https://stackoverflow.com/questions/4087280/approximate-cost-to-access-various-caches-and-main-memory">medium speed</a></h3><p><a href="/img/cpu_speed_a7jWu.png"></a><br>L1 cache (instruction cache and data cache) hit : <del>4 clock cycle<br>L2 cache hit: ~10 clock cycle<br>L3 cache hit, line unshare: ~40 clock cycle<br>L3 cache hit, share line in another core: ~65 clock cycle<br>L3 cache hit, modified in another core ~75 cycles remote<br>L3 cache ~100-300 cycles<br>Local DRAM ~30 ns (</del>120 cycles)<br>Remote DRAM ~100 ns</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">           0.5 ns - CPU L1 dCACHE reference</span><br><span class="line">           1   ns - speed-of-light (a photon) travel a 1 ft (30.5cm) distance</span><br><span class="line">           5   ns - CPU L1 iCACHE Branch mispredict</span><br><span class="line">           7   ns - CPU L2  CACHE reference</span><br><span class="line">          71   ns - CPU cross-QPI/NUMA best  <span class="keyword">case</span> on XEON E5-46*</span><br><span class="line">         100   ns - MUTEX lock/unlock</span><br><span class="line">         100   ns - own DDR MEMORY reference</span><br><span class="line">         135   ns - CPU cross-QPI/NUMA best  <span class="keyword">case</span> on XEON E7-*</span><br><span class="line">         202   ns - CPU cross-QPI/NUMA worst <span class="keyword">case</span> on XEON E7-*</span><br><span class="line">         325   ns - CPU cross-QPI/NUMA worst <span class="keyword">case</span> on XEON E5-46*</span><br><span class="line">      10,000   ns - Compress 1K bytes with Zippy PROCESS</span><br><span class="line">      20,000   ns - Send 2K bytes over 1 Gbps NETWORK</span><br><span class="line">     250,000   ns - Read 1 MB sequentially from MEMORY</span><br><span class="line">     500,000   ns - Round trip within a same DataCenter</span><br><span class="line">  10,000,000   ns - DISK seek</span><br><span class="line">  10,000,000   ns - Read 1 MB sequentially from NETWORK</span><br><span class="line">  30,000,000   ns - Read 1 MB sequentially from DISK</span><br><span class="line"> 150,000,000   ns - Send a NETWORK packet CA -&gt; Netherlands</span><br><span class="line">|   |   |   |</span><br><span class="line">|   |   | ns|</span><br><span class="line">|   | us|</span><br><span class="line">| ms|</span><br></pre></td></tr></table></figure><p>The Cache line is the basic unit, 32B,64B,128B, intel L1 32K, 8-ways, cache line 64B, 32768/64=512 x cache line<br>The intel Cascade Lake L1 was 32K private to each core, 8-ways(8x cache line make a group, 64x8=512B, 32768/512=64)<br>32768/64=512 x Cache lines, 512/8=64 Cache lines,  first find the group, and then index to the client( Set Associativity )<br>In each way, it s 64 cache lines, each cache line has 64 Bytes ,64 x 64 =4096 Bytes<br><a href="https://coolshell.cn/articles/20793.html">For more infor</a></p><p>AMD Roma 7552 L1 instruct 32K 8-way, L1 32K 8-way, L2 512K 8-way, L3-per-socket 192M 16-way</p><h3 id="E3-v6-Turbo-not-work-in-CentOS6"><a href="#E3-v6-Turbo-not-work-in-CentOS6" class="headerlink" title="E3 v6 Turbo not work in CentOS6"></a>E3 v6 Turbo not work in CentOS6</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ cpupower frequency-set --governor ondemand/powersave/performance</span><br><span class="line"></span><br><span class="line">CentOS 6</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line"></span><br><span class="line">CentOS 7</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br></pre></td></tr></table></figure><a id="more"></a><h5 id="Check-cpu-freq-instead-of-cat-proc-cpuinfo-grep-MHz"><a href="#Check-cpu-freq-instead-of-cat-proc-cpuinfo-grep-MHz" class="headerlink" title="Check cpu freq, instead of cat /proc/cpuinfo | grep MHz"></a>Check cpu freq, instead of cat /proc/cpuinfo | grep MHz</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if you could not get the cpu freq from &quot;cpupower frequency-info&quot;</span></span><br><span class="line"><span class="comment"># use the command </span></span><br><span class="line">cpupower monitor -m Mperf</span><br><span class="line"></span><br><span class="line">cpupower frequency-<span class="builtin-name">set</span> -g performance</span><br><span class="line">cpupower idle-<span class="builtin-name">set</span> -d 0</span><br><span class="line">cpupower idle-<span class="builtin-name">set</span> -d 1</span><br><span class="line">cpupower idle-<span class="builtin-name">set</span> -d 2</span><br><span class="line">tuned-adm<span class="built_in"> profile </span>throughput-performance</span><br><span class="line">tuned-adm active</span><br></pre></td></tr></table></figure><h4 id="check-driver"><a href="#check-driver" class="headerlink" title="check driver"></a>check driver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cpupower frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: acpi-cpufreq</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0 1 2 3 4 5 6 7</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency: 10.0 us</span><br><span class="line">  hardware limits: 800 MHz - 3.70 GHz</span><br><span class="line">  available frequency steps:  3.70 GHz, 3.70 GHz, 3.50 GHz, 3.30 GHz, 3.10 GHz, 2.90 GHz, 2.70 GHz, 2.50 GHz, 2.20 GHz, 2.00 GHz, 1.80 GHz, 1.60 GHz, 1.40 GHz, 1.20 GHz, 1000 MHz, 800 MHz</span><br><span class="line">  available cpufreq governors: ondemand userspace performance</span><br><span class="line">  current policy: frequency should be within 800 MHz and 3.70 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;ondemand&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 800 MHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>It s looks like it cound not work in 3.9GHz or 4.1GHz<br>Replace driver to intel_pstate</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">modprobe -r acpi_cpufreq</span><br><span class="line">modprobe intel_pstate</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;install acpi_cpufreq /sbin/modprobe intel_pstate&#x27;</span> &gt;/etc/modprobe.d/cpu.conf</span><br><span class="line">dracut -f --add-drivers intel_pstate</span><br><span class="line"></span><br><span class="line">cpupower frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 800 MHz - 4.10 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 800 MHz and 4.10 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;powersave&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 4.00 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br><span class="line"></span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">3899453</span><br><span class="line">$ cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line"></span><br><span class="line"><span class="comment">#The intel_pstate driver was added later during RHEL6 life cycle and is available in our kernel since RHEL6.5, but Red Hat decided to keep acpi_cpufreq as default to prevent any potential compatibility issues.</span></span><br></pre></td></tr></table></figure><h4 id="When-I-run-pigz-to-benmark"><a href="#When-I-run-pigz-to-benmark" class="headerlink" title="When I run pigz to benmark"></a>When I run pigz to benmark</h4><p>Enable Turbo, acpi-cpufreq(show 3.7GHz) and intel_pstate(3.89GHz) has the same performance (608s finish the benchmark), I can t believe. I test opnessl, Intel Math Kernel Library , all test result is same. that means in CentOS 6.9 with acpi-cpufreq, just show 3.7GHz, the cpu work in 3.9GHz<br>Disable Turbo in BIOS, acpi-cpufreq(show 3.7GHz) and intel_pstate(3.7GHz) has the same performance too (640s finish the benchmark)<br>About 5% raise, same with cpu frequency distance</p><h3 id="Isolated-CPUs-example"><a href="#Isolated-CPUs-example" class="headerlink" title="Isolated CPUs example"></a><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/isolating_cpus_using_tuned-profiles-realtime">Isolated CPUs example</a></h3><p>Isolating CPUs generally involves:<br>removing all user-space threads;<br>removing any unbound kernel threads (bound kernel threads are tied to a specific CPU and may not be moved);<br>removing interrupts by modifying the /proc/irq/N/smp_affinity property of each Interrupt Request (IRQ) number N in the system.</p><p>Plan out CPU allocation, e.g.<br>    * CPUs should NOT be used for more than one task.<br>    * CPUs for host OS<br>    * CPUs for XVIO<br>    * CPUs for VMs<br>        * CPUs for guest OS<br>        * CPUs for VNF or application</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ yum install tuned tuned-profiles-realtime</span><br><span class="line">$ cat /etc/tuned/realtime-variables.conf</span><br><span class="line">isolated_cores=0-3,5,7</span><br><span class="line">$ tuned-adm profile realtime</span><br><span class="line">$ grep isolcpus /proc/cmdline</span><br><span class="line">$ </span><br></pre></td></tr></table></figure><p><img src="/img/cpu-Isolated-334379.png"></p><h3 id="kernel-parameter"><a href="#kernel-parameter" class="headerlink" title="kernel parameter"></a>kernel parameter</h3><p> intel_idle.max_cstate=0 processor.max_cstate=0 idle=mwait<br>     idle=mwait C1 will be entered whenever the core is idle irrespective of other settings<br>     idle=poll keeps the processing cores in C0 state when used in conjunction with intel_idle.max_cstate=0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=32-47,48-63 default_hugepagesz=1GB hugepagesz=1G hugepages=12 intel_idle.max_cstate=0 processor.max_cstate=0 idle=mwait&quot;</span></span><br></pre></td></tr></table></figure><h4 id="tuna"><a href="#tuna" class="headerlink" title="tuna"></a><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-CPU-Configuration_suggestions#sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-Configuration_suggestions-Configuring_CPU_thread_and_interrupt_affinity_with_Tuna">tuna</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ tuna --cpus CPUs --isolate</span><br><span class="line">$ tuna --cpus CPUs --include</span><br><span class="line">$ tuna --irqs IRQs --cpus CPU --move</span><br><span class="line">$ tuna --irqs sfc1* -c7 -m -x</span><br><span class="line">$ tuna --irqs <span class="string">&#x27;enp1s0f*&#x27;</span> --socket 0 --spread --show_irqs</span><br><span class="line">$ tuna --threads thread --priority policy:level  <span class="comment">#level:0-99</span></span><br><span class="line">$ tuna --cpus=0,1 --threads=ssh* --move --cpus=2,3 --threads=http* --move</span><br><span class="line">$ tuna --threads 7861 --show_threads</span><br><span class="line">$ tuna --threads 7861 --priority=RR:40</span><br><span class="line">$ tuna -t qemu* -P -c0 -mP -c1 -mP -c+0 -mP</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0 0xff,0xffffffff    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0 0xff,0xffffffff   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0 0xff,0xffffffff   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0 0xff,0xffffffff  54315196        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0 0xff,0xffffffff  42864592         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        0    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        0   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        0   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        0  54315198        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        0  42864593         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        1  54315200        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        1  42864595         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0      0,1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0      0,1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0      0,1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0      0,1  54315202        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0      0,1  42864597         6630        qemu-kvm</span><br></pre></td></tr></table></figure><h3 id="cpu-IPC-Instruction-Per-Clock-cycle"><a href="#cpu-IPC-Instruction-Per-Clock-cycle" class="headerlink" title="cpu IPC (Instruction Per Clock cycle)"></a>cpu IPC (Instruction Per Clock cycle)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cpu FSB x multiplier = frequency</span><br><span class="line">cpu frequency x IPC</span><br></pre></td></tr></table></figure><h3 id="Benchmark-CPU"><a href="#Benchmark-CPU" class="headerlink" title="Benchmark CPU"></a>Benchmark CPU</h3><h4 id="gcc-x86-options"><a href="#gcc-x86-options" class="headerlink" title="gcc_x86_options"></a><a href="https://gcc.gnu.org/onlinedocs/gcc/x86-Options.html">gcc_x86_options</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">-march=cpu-type</span><br><span class="line">Generate instructions <span class="keyword">for</span> the machine <span class="built_in">type</span> cpu-type. </span><br><span class="line"></span><br><span class="line">-mtune=cpu-type ; only generic and intel</span><br><span class="line">Tune to cpu-type everything applicable about the generated code, except <span class="keyword">for</span> the ABI and the <span class="built_in">set</span> of available instructions. </span><br><span class="line"></span><br><span class="line">-mincoming-stack-boundary=num</span><br><span class="line">Assume the incoming stack is aligned to a 2 raised to num byte boundary. If -mincoming-stack-boundary is not specified, the one specified by -mpreferred-stack-boundary is used.</span><br><span class="line">-mmmx</span><br><span class="line">-msse</span><br><span class="line">-msse2</span><br><span class="line">-msse3</span><br><span class="line">-mssse3</span><br><span class="line">-msse4</span><br><span class="line">-msse4a</span><br><span class="line">-msse4.1</span><br><span class="line">-msse4.2</span><br><span class="line">-mavx</span><br><span class="line">-mavx2</span><br><span class="line">-mavx512f</span><br><span class="line">-mavx512pf</span><br><span class="line">-mavx512er</span><br><span class="line">-mavx512cd</span><br><span class="line">-mavx512vl</span><br><span class="line">-mavx512bw</span><br><span class="line">-mavx512dq</span><br><span class="line">-mavx512ifma</span><br><span class="line">-mavx512vbmi</span><br><span class="line">-mavx512vbmi2</span><br><span class="line">-mavx512bf16</span><br><span class="line">-mavx512vpopcntdq</span><br><span class="line">-mavx512vp2intersect</span><br><span class="line">-mavx5124fmaps</span><br><span class="line">-mavx512vnni</span><br><span class="line">-mavx5124vnniw</span><br><span class="line">-mcldemote</span><br><span class="line">.... <span class="comment">## too many</span></span><br><span class="line"></span><br><span class="line">-mprefer-vector-width=opt</span><br><span class="line">This option instructs GCC to use opt-bit vector width <span class="keyword">in</span> instructions instead of default on the selected platform.</span><br><span class="line">none/128/256/512</span><br></pre></td></tr></table></figure><p>Check gcc parameters</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc <span class="attribute">-march</span>=native -Q <span class="attribute">--help</span>=target</span><br><span class="line"></span><br><span class="line">$ gcc <span class="attribute">-march</span>=native -Q <span class="attribute">--help</span>=target|grep march</span><br><span class="line">-march=                               broadwell</span><br></pre></td></tr></table></figure><h3 id="Disable-AVX"><a href="#Disable-AVX" class="headerlink" title="Disable AVX"></a><a href="https://software.intel.com/en-us/articles/introduction-to-intel-advanced-vector-extensions">Disable AVX</a></h3><p>To use the Intel AVX extensions reliably in most settings, the operating system must support saving and loading the new registers (with XSAVE/XRSTOR) on thread context switches to prevent data corruption. To help avoid such errors, operating systems supporting Intel AVX-aware context switches explicitly set a CPU bit enabling the new instructions; otherwise, an undefined opcode (#UD) exception is generated when Intel AVX instructions are used.</p><p>Add kernel parameter to disable AVX </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">        noxsave         [BUGS=X86] Disables x86 extended register state save</span><br><span class="line">                        and restore using xsave. The kernel will fallback to</span><br><span class="line">                        enabling legacy floating-point and sse state.</span><br><span class="line"></span><br><span class="line">        noxsaveopt      [X86] Disables xsaveopt used <span class="keyword">in</span> saving x86 extended</span><br><span class="line">                        register states. The kernel will fall back to use</span><br><span class="line">                        xsave to save the states. By using this parameter,</span><br><span class="line">                        performance of saving the states is degraded because</span><br><span class="line">                        xsave doesn<span class="string">&#x27;t support modified optimization while</span></span><br><span class="line"><span class="string">                        xsaveopt supports it on xsaveopt enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        noxsaves        [X86] Disables xsaves and xrstors used in saving and</span></span><br><span class="line"><span class="string">                        restoring x86 extended register state in compacted</span></span><br><span class="line"><span class="string">                        form of xsave area. The kernel will fall back to use</span></span><br><span class="line"><span class="string">                        xsaveopt and xrstor to save and restore the states</span></span><br><span class="line"><span class="string">                        in standard form of xsave area. By using this</span></span><br><span class="line"><span class="string">                        parameter, xsave area per process might occupy more</span></span><br><span class="line"><span class="string">                        memory on xsaves enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cpuid | grep XSAVE -i | head</span></span><br><span class="line"><span class="string">Disclaimer: cpuid may not support decoding of all cpuid registers.</span></span><br><span class="line"><span class="string">      FXSAVE/FXRSTOR                         = true</span></span><br><span class="line"><span class="string">      XSAVE/XSTOR states                      = true</span></span><br><span class="line"><span class="string">      OS-enabled XSAVE/XSTOR                  = true</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/0):</span></span><br><span class="line"><span class="string">      bytes required by XSAVE/XRSTOR area     = 0x00000340 (832)</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/1):</span></span><br><span class="line"><span class="string">      XSAVEOPT instruction                        = true</span></span><br><span class="line"><span class="string">      XSAVEC instruction                          = false</span></span><br><span class="line"><span class="string">      XSAVES/XRSTORS instructions                 = false</span></span><br><span class="line"><span class="string">      64-byte alignment in compacted XSAVE     = false</span></span><br></pre></td></tr></table></figure><h3 id="Found-the-half-cores"><a href="#Found-the-half-cores" class="headerlink" title="Found the half cores"></a>Found the half cores</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ((i=0;i&lt;$(grep -c processor /proc/cpuinfo);i++)); </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  cat /sys/devices/system/cpu/cpu<span class="variable">$i</span>/cache/index2/shared_cpu_list; </span><br><span class="line"><span class="keyword">done</span> | awk -F, <span class="string">&#x27;&#123;a[$1]=$0&#125; END&#123;</span></span><br><span class="line"><span class="string">  count=0;</span></span><br><span class="line"><span class="string">  for (i in a) &#123;</span></span><br><span class="line"><span class="string">     if(count==0) &#123;</span></span><br><span class="line"><span class="string">       printf i</span></span><br><span class="line"><span class="string">     &#125; else &#123;</span></span><br><span class="line"><span class="string">       printf &quot;,&quot;i</span></span><br><span class="line"><span class="string">     &#125;;</span></span><br><span class="line"><span class="string">       count++ </span></span><br><span class="line"><span class="string">  &#125; </span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">17,4,18,5,19,6,7,8,9,10,11,12,13,0,14,1,15,2,16,3</span><br></pre></td></tr></table></figure><h3 id="Turn-off-the-cpu-cores"><a href="#Turn-off-the-cpu-cores" class="headerlink" title="Turn off the cpu cores"></a>Turn off the cpu cores</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpu17/online</span><br></pre></td></tr></table></figure><h3 id="set-parameter-for-storage-system"><a href="#set-parameter-for-storage-system" class="headerlink" title="set parameter for storage system"></a>set parameter for storage system</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ find /sys -iname  rq_affinity ! -name <span class="string">&#x27;*irq*&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> <span class="built_in">echo</span> 2 &gt; <span class="variable">$line</span> ; <span class="keyword">done</span></span><br><span class="line">If this option is <span class="string">&#x27;1&#x27;</span>, the block layer will migrate request completions to the cpu <span class="string">&quot;group&quot;</span> that originally submitted the request. For some workloads this provides a significant reduction <span class="keyword">in</span> CPU cycles due to caching effects.</span><br><span class="line"></span><br><span class="line">For storage configurations that need to maximize distribution of completion processing setting this option to <span class="string">&#x27;2&#x27;</span> forces the completion to run on the requesting cpu (bypassing the <span class="string">&quot;group&quot;</span> aggregation logic).</span><br></pre></td></tr></table></figure><h3 id="UDP-performance-in-AMD-roma-2x-7552"><a href="#UDP-performance-in-AMD-roma-2x-7552" class="headerlink" title="UDP performance in AMD roma (2x 7552)"></a>UDP performance in AMD roma (2x 7552)</h3><p>You could see top performance in CPU core 74, pps reach to 0.936M pps</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                96</span><br><span class="line">On-line CPU(s) list:   0-95</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    48</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Vendor ID:             AuthenticAMD</span><br><span class="line">CPU family:            23</span><br><span class="line">Model:                 49</span><br><span class="line">Model name:            AMD EPYC 7552 48-Core Processor</span><br><span class="line">Stepping:              0</span><br><span class="line">CPU MHz:               2200.000</span><br><span class="line">CPU max MHz:           2200.0000</span><br><span class="line">CPU min MHz:           1500.0000</span><br><span class="line">BogoMIPS:              4400.06</span><br><span class="line">Virtualization:        AMD-V</span><br><span class="line">L1d cache:             32K</span><br><span class="line">L1i cache:             32K</span><br><span class="line">L2 cache:              512K</span><br><span class="line">L3 cache:              16384K</span><br><span class="line">NUMA node0 CPU(s):     0-47</span><br><span class="line">NUMA node1 CPU(s):     48-95</span><br><span class="line">Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc art rep_good nopl xtopology nonstop_tsc extd_apicid aperfmperf eagerfpu pni pclmulqdq monitor ssse3 fma cx16 sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand lahf_lm cmp_legacy svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw ibs skinit wdt tce topoext perfctr_core perfctr_nb bpext perfctr_l2 cpb cat_l3 cdp_l3 hw_pstate sme retpoline_amd ssbd ibrs ibpb stibp vmmcall fsgsbase bmi1 avx2 smep bmi2 cqm rdt_a rdseed adx smap clflushopt clwb sha_ni xsaveopt xsavec xgetbv1 cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local clzero irperf xsaveerptr arat npt lbrv svm_lock nrip_save tsc_scale vmcb_clean flushbyasid decodeassists pausefilter pfthreshold avic v_vmsave_vmload vgif umip overflow_recov succor smca</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> ((i=4;i&lt;=96;i=i+10)); <span class="keyword">do</span> <span class="built_in">echo</span> CPU core:<span class="variable">$i</span>; timeout 5 taskset -c <span class="variable">$i</span> ./receiver 0.0.0.0:4321; <span class="keyword">done</span></span><br><span class="line">CPU core:4</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">CPU core:14</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.411M pps  12.538MiB / 105.177Mb</span><br><span class="line">  0.455M pps  13.891MiB / 116.523Mb</span><br><span class="line">  0.452M pps  13.797MiB / 115.737Mb</span><br><span class="line">  0.430M pps  13.109MiB / 109.969Mb</span><br><span class="line">CPU core:24</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.455M pps  13.875MiB / 116.392Mb</span><br><span class="line">  0.411M pps  12.532MiB / 105.124Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">CPU core:34</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.442M pps  13.500MiB / 113.246Mb</span><br><span class="line">  0.425M pps  12.969MiB / 108.790Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">CPU core:44</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.454M pps  13.859MiB / 116.261Mb</span><br><span class="line">  0.455M pps  13.875MiB / 116.392Mb</span><br><span class="line">  0.454M pps  13.844MiB / 116.130Mb</span><br><span class="line">  0.440M pps  13.422MiB / 112.591Mb</span><br><span class="line">CPU core:54</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.719M pps  21.929MiB / 183.950Mb</span><br><span class="line">  0.685M pps  20.907MiB / 175.383Mb</span><br><span class="line">  0.680M pps  20.766MiB / 174.199Mb</span><br><span class="line">  0.544M pps  16.611MiB / 139.345Mb</span><br><span class="line">CPU core:64</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.586M pps  17.888MiB / 150.057Mb</span><br><span class="line">  0.626M pps  19.093MiB / 160.164Mb</span><br><span class="line">  0.629M pps  19.200MiB / 161.061Mb</span><br><span class="line">  0.630M pps  19.232MiB / 161.329Mb</span><br><span class="line">CPU core:74</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.936M pps  28.571MiB / 239.668Mb</span><br><span class="line">  0.935M pps  28.540MiB / 239.410Mb</span><br><span class="line">  0.936M pps  28.563MiB / 239.602Mb</span><br><span class="line">  0.948M pps  28.928MiB / 242.669Mb</span><br><span class="line">CPU core:84</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.616M pps  18.786MiB / 157.585Mb</span><br><span class="line">  0.622M pps  18.976MiB / 159.180Mb</span><br><span class="line">  0.618M pps  18.847MiB / 158.102Mb</span><br><span class="line">  0.615M pps  18.780MiB / 157.541Mb</span><br><span class="line">CPU core:94</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.576M pps  17.589MiB / 147.543Mb</span><br><span class="line">  0.674M pps  20.583MiB / 172.664Mb</span><br><span class="line">  0.672M pps  20.499MiB / 171.958Mb</span><br><span class="line">  0.678M pps  20.684MiB / 173.507Mb</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> ((i=1;i&lt;=96;i=i+10)); <span class="keyword">do</span> <span class="built_in">echo</span> CPU core:<span class="variable">$i</span>; timeout 5 taskset -c <span class="variable">$i</span> ./receiver 0.0.0.0:4321; <span class="keyword">done</span></span><br><span class="line">CPU core:1</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.440M pps  13.422MiB / 112.591Mb</span><br><span class="line">  0.452M pps  13.797MiB / 115.737Mb</span><br><span class="line">  0.442M pps  13.484MiB / 113.115Mb</span><br><span class="line">  0.441M pps  13.453MiB / 112.853Mb</span><br><span class="line">CPU core:11</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.433M pps  13.203MiB / 110.756Mb</span><br><span class="line">  0.433M pps  13.221MiB / 110.907Mb</span><br><span class="line">  0.434M pps  13.234MiB / 111.018Mb</span><br><span class="line">  0.433M pps  13.219MiB / 110.887Mb</span><br><span class="line">CPU core:21</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.439M pps  13.406MiB / 112.460Mb</span><br><span class="line">  0.438M pps  13.375MiB / 112.198Mb</span><br><span class="line">  0.438M pps  13.375MiB / 112.198Mb</span><br><span class="line">  0.438M pps  13.375MiB / 112.198Mb</span><br><span class="line">CPU core:31</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.428M pps  13.047MiB / 109.445Mb</span><br><span class="line">  0.428M pps  13.062MiB / 109.576Mb</span><br><span class="line">  0.428M pps  13.062MiB / 109.576Mb</span><br><span class="line">  0.428M pps  13.047MiB / 109.445Mb</span><br><span class="line">CPU core:41</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.425M pps  12.969MiB / 108.790Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">  0.425M pps  12.984MiB / 108.921Mb</span><br><span class="line">CPU core:51</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.617M pps  18.828MiB / 157.938Mb</span><br><span class="line">  0.651M pps  19.881MiB / 166.777Mb</span><br><span class="line">  0.638M pps  19.465MiB / 163.284Mb</span><br><span class="line">  0.645M pps  19.670MiB / 165.000Mb</span><br><span class="line">CPU core:61</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.595M pps  18.156MiB / 152.307Mb</span><br><span class="line">  0.631M pps  19.271MiB / 161.654Mb</span><br><span class="line">  0.654M pps  19.973MiB / 167.548Mb</span><br><span class="line">  0.654M pps  19.956MiB / 167.400Mb</span><br><span class="line">CPU core:71</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.517M pps  15.792MiB / 132.474Mb</span><br><span class="line">  0.611M pps  18.643MiB / 156.390Mb</span><br><span class="line">  0.611M pps  18.642MiB / 156.381Mb</span><br><span class="line">  0.558M pps  17.035MiB / 142.898Mb</span><br><span class="line">CPU core:81</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.614M pps  18.743MiB / 157.231Mb</span><br><span class="line">  0.616M pps  18.802MiB / 157.720Mb</span><br><span class="line">  0.627M pps  19.136MiB / 160.525Mb</span><br><span class="line">  0.626M pps  19.117MiB / 160.361Mb</span><br><span class="line">CPU core:91</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.613M pps  18.692MiB / 156.800Mb</span><br><span class="line">  0.624M pps  19.055MiB / 159.843Mb</span><br><span class="line">  0.632M pps  19.280MiB / 161.730Mb</span><br><span class="line">  0.633M pps  19.316MiB / 162.035Mb</span><br></pre></td></tr></table></figure><h3 id="intel-cmt-cat"><a href="#intel-cmt-cat" class="headerlink" title="intel-cmt-cat"></a>intel-cmt-cat</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ yum install <span class="built_in">int</span>el-cmt-cat.x86_64</span><br><span class="line"></span><br><span class="line">TIME <span class="number">2020</span><span class="number">-01</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">05</span></span><br><span class="line">           LLC(Last Level Cache): CMT(Cache Monitoring Technology) Cache Occupancy</span><br><span class="line">           MBL:MBM local bandwidth</span><br><span class="line">           MBR:MBM Remote bandwidth</span><br><span class="line">$ pqos</span><br><span class="line">    CORE   IPC   MISSES     LLC[KB]   MBL[MB/s]   MBR[MB/s]</span><br><span class="line"></span><br><span class="line">       <span class="number">0</span>  <span class="number">0.26</span>       <span class="number">6</span>k      <span class="number">1080.0</span>         <span class="number">0.2</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">1</span>  <span class="number">0.26</span>       <span class="number">0</span>k         <span class="number">0.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">2</span>  <span class="number">0.27</span>       <span class="number">4</span>k      <span class="number">4600.0</span>         <span class="number">0.5</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">3</span>  <span class="number">0.26</span>       <span class="number">5</span>k       <span class="number">520.0</span>         <span class="number">0.0</span>         <span class="number">0.2</span></span><br><span class="line">       <span class="number">4</span>  <span class="number">0.27</span>       <span class="number">8</span>k      <span class="number">1120.0</span>         <span class="number">0.7</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">5</span>  <span class="number">0.25</span>      <span class="number">12</span>k      <span class="number">1080.0</span>         <span class="number">0.7</span>         <span class="number">0.2</span></span><br><span class="line">       <span class="number">6</span>  <span class="number">0.28</span>      <span class="number">18</span>k      <span class="number">1040.0</span>         <span class="number">0.9</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">7</span>  <span class="number">0.25</span>       <span class="number">0</span>k         <span class="number">0.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line">       <span class="number">8</span>  <span class="number">0.27</span>       <span class="number">4</span>k      <span class="number">3400.0</span>         <span class="number">0.2</span>         <span class="number">0.1</span></span><br><span class="line">       <span class="number">9</span>  <span class="number">0.25</span>       <span class="number">0</span>k      <span class="number">1360.0</span>         <span class="number">0.1</span>         <span class="number">0.1</span></span><br><span class="line">      <span class="number">10</span>  <span class="number">0.26</span>      <span class="number">14</span>k      <span class="number">7000.0</span>         <span class="number">1.3</span>         <span class="number">0.0</span></span><br><span class="line">      <span class="number">11</span>  <span class="number">0.39</span>       <span class="number">1</span>k       <span class="number">120.0</span>         <span class="number">0.0</span>         <span class="number">0.0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>L3 misses/s (LUR, more L3 and lower misses in some case)</p><p><a href="https://github.com/intel/intel-cmt-cat/wiki/Usage-Examples">Usage-example</a></p><p>Cache Monitoring Technology (CMT)<br>Cache Allocation Technology (CAT)<br>Memory Bandwidth Monitoring (MBM)<br>Memory Bandwidth Allocation (MBA)<br>Code and Data Prioritization (CDP)</p>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ipmitool</title>
      <link href="2018/05/27/ipmi/"/>
      <url>2018/05/27/ipmi/</url>
      
        <content type="html"><![CDATA[<h4 id="ipmi-set-time"><a href="#ipmi-set-time" class="headerlink" title="ipmi set time"></a>ipmi set time</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool sel time <span class="built_in">set</span> now</span><br></pre></td></tr></table></figure><h4 id="set-boot-dev"><a href="#set-boot-dev" class="headerlink" title="set boot dev"></a>set boot dev</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Ipmitool -I lanplus -H x.x.x.x -U USER -P PASSWORD chassis bootdev bios [ pxe | cdrom ] options=persistent</span><br><span class="line">Ipmitool -I lanplus -H x.x.x.x -U USER -P PASSWORD chassis bootdev bios [ pxe | cdrom ]</span><br><span class="line">ipmitool chassis bootdev none options=<span class="built_in">help</span></span><br><span class="line">Legal options settings are:</span><br><span class="line"><span class="built_in">help</span>:<span class="built_in">print</span> this message</span><br><span class="line">valid:Boot flags valid</span><br><span class="line">persistent:Changes are persistent <span class="keyword">for</span> all future boots</span><br><span class="line">efiboot:Extensible Firmware Interface Boot (EFI)</span><br><span class="line">clear-cmos:CMOS clear</span><br><span class="line">lockkbd:Lock Keyboard</span><br><span class="line">screenblank:Screen Blank</span><br><span class="line">lockoutreset:Lock out Resetbuttons</span><br><span class="line">lockout_power:Lock out (power off/sleep request) via Power Button</span><br><span class="line">verbose=default:Request quiet BIOS display</span><br><span class="line">verbose=no:Request quiet BIOS display</span><br><span class="line">verbose=yes:Request verbose BIOS display</span><br><span class="line">force_pet:Force progress event traps</span><br><span class="line">upw_bypass:User password bypass</span><br><span class="line">lockout_sleep:Log Out Sleep Button</span><br><span class="line">cons_redirect=default:Console redirection occurs per BIOS configuration setting</span><br><span class="line">cons_redirect=skip:Suppress (skip) console redirection <span class="keyword">if</span> enabled</span><br><span class="line">cons_redirect=<span class="built_in">enable</span>:Suppress (skip) console redirection <span class="keyword">if</span> enabled</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="debug-info"><a href="#debug-info" class="headerlink" title="debug info"></a>debug info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ipmitool lan <span class="built_in">print</span></span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; shell <span class="comment"># get ipmitool shell, type &#x27;help&#x27;</span></span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; sel list <span class="comment"># Show system event log</span></span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; sdr <span class="comment"># List sensor data</span></span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; sdr elist</span><br><span class="line">ipmitool event <span class="string">&quot;CPU 1 Temp&quot;</span> <span class="string">&quot;lnc : Lower Non-Critical&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#filter string</span></span><br><span class="line">ipmitool sdr list </span><br><span class="line">ipmitool sdr <span class="built_in">type</span> list </span><br><span class="line">ipmitool sdr <span class="built_in">type</span> Temperature </span><br><span class="line">ipmitool sdr <span class="built_in">type</span> Fan </span><br><span class="line">ipmitool sdr <span class="built_in">type</span> <span class="string">&#x27;Power Supply&#x27;</span></span><br><span class="line"></span><br><span class="line">ipmitool sel elist</span><br><span class="line">ipmitool sel time get</span><br></pre></td></tr></table></figure><h4 id="system-status"><a href="#system-status" class="headerlink" title="system status"></a>system status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ipmitool</span> sdr elist full | grep Avg</span><br><span class="line">Avg Power        | 2Eh | ok  | 21.0 | 200 Watts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ipmitool sdr <span class="built_in">type</span> <span class="string">&#x27;Current&#x27;</span></span><br><span class="line">System Level     | 16h | ok  |  7.1 | 268 Watts</span><br><span class="line">Current Latch    | 09h | ns  |  7.1 | Disabled</span><br><span class="line"></span><br><span class="line">$ ipmitool sdr <span class="built_in">type</span> <span class="string">&quot;CPU &quot;</span></span><br><span class="line">Sensor Type <span class="string">&quot;CPU &quot;</span> not found.</span><br><span class="line">Sensor Types:</span><br><span class="line">Temperature               (0x01)   Voltage                   (0x02)</span><br><span class="line">Current                   (0x03)   Fan                       (0x04)</span><br><span class="line">Physical Security         (0x05)   Platform Security         (0x06)</span><br><span class="line">Processor                 (0x07)   Power Supply              (0x08)</span><br><span class="line">Power Unit                (0x09)   Cooling Device            (0x0a)</span><br><span class="line">Other                     (0x0b)   Memory                    (0x0c)</span><br><span class="line">Drive Slot / Bay          (0x0d)   POST Memory Resize        (0x0e)</span><br><span class="line">System Firmwares          (0x0f)   Event Logging Disabled    (0x10)</span><br><span class="line">Watchdog1                 (0x11)   System Event              (0x12)</span><br><span class="line">Critical Interrupt        (0x13)   Button                    (0x14)</span><br><span class="line">Module / Board            (0x15)   Microcontroller           (0x16)</span><br><span class="line">Add-in Card               (0x17)   Chassis                   (0x18)</span><br><span class="line">Chip Set                  (0x19)   Other FRU                 (0x1a)</span><br><span class="line">Cable / Interconnect      (0x1b)   Terminator                (0x1c)</span><br><span class="line">System Boot Initiated     (0x1d)   Boot Error                (0x1e)</span><br><span class="line">OS Boot                   (0x1f)   OS Critical Stop          (0x20)</span><br><span class="line">Slot / Connector          (0x21)   System ACPI Power State   (0x22)</span><br><span class="line">Watchdog2                 (0x23)   Platform Alert            (0x24)</span><br><span class="line">Entity Presence           (0x25)   Monitor ASIC              (0x26)</span><br><span class="line">LAN                       (0x27)   Management Subsys Health  (0x28)</span><br><span class="line">Battery                   (0x29)   Session Audit             (0x2a)</span><br><span class="line">Version Change            (0x2b)   FRU State                 (0x2c)</span><br><span class="line">$ ipmitool sdr <span class="built_in">type</span> Temperature</span><br><span class="line">CPU Temp         | 01h | ok  |  3.1 | 83 degrees C</span><br><span class="line">PCH Temp         | 0Ah | ok  |  7.1 | 29 degrees C</span><br><span class="line">System Temp      | 0Bh | ok  |  7.2 | 26 degrees C</span><br><span class="line">Peripheral Temp  | 0Ch | ok  |  7.3 | 30 degrees C</span><br><span class="line">ART1             | 2Bh | ok  |  7.4 | 25 degrees C</span><br><span class="line">ART2             | 2Ch | ok  |  7.5 | 29 degrees C</span><br><span class="line">VcpuVRM Temp     | 10h | ns  |  7.16 | No Reading</span><br><span class="line">DIMMA1 Temp      | B0h | ok  | 32.0 | 28 degrees C</span><br><span class="line">DIMMA2 Temp      | B1h | ok  | 32.1 | 28 degrees C</span><br><span class="line">DIMMB1 Temp      | B2h | ok  | 32.2 | 26 degrees C</span><br><span class="line">DIMMB2 Temp      | B3h | ok  | 32.3 | 27 degrees C</span><br></pre></td></tr></table></figure><h4 id="User-and-network"><a href="#User-and-network" class="headerlink" title="User and network"></a>User and network</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ipmitool -I lanplus </span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 ipsrc [ static | dhcp ] </span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 ipaddr &lt;ip&gt;</span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 netmask 255.255.255.0</span><br><span class="line">ipmitool -I lanplus -H &lt;ip&gt; -U &lt;user&gt; -P &lt;user&gt; lan <span class="built_in">set</span> 1 defgw ipaddr &lt;ip&gt;</span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; -P &lt;pass&gt; user <span class="built_in">set</span> name 5 admin</span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; -P &lt;pass&gt; user list</span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; -P &lt;pass&gt; user <span class="built_in">set</span> password 5 &lt;pass&gt; </span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; -P &lt;pass&gt; channel setaccess 1 5 link=on ipmi=on callin=on privilege=4</span><br><span class="line">ipmitool -H &lt;ip&gt; -U &lt;user&gt; -P &lt;pass&gt; user <span class="built_in">enable</span> 5</span><br></pre></td></tr></table></figure><h4 id="Get-NIC-mac-from-supermicro-server"><a href="#Get-NIC-mac-from-supermicro-server" class="headerlink" title="Get NIC mac from supermicro server"></a>Get NIC mac from supermicro server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">You can find the MAC address <span class="keyword">for</span> LAN1/eth0 (not the BMC MAC) via the SuperMicro IPMI interface by running the following <span class="built_in">command</span>:</span><br><span class="line">ipmitool -U <span class="variable">$IPMI_USER</span> -P <span class="variable">$IPMI_PASS</span> -H <span class="variable">$IPMI_HOST</span> raw 0x30 0x21 | tail -c 18</span><br><span class="line">The eth0 MAC address will be output <span class="keyword">in</span> this format:</span><br><span class="line">00 25 90 f0 be ef</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">#### reset mc</span></span><br><span class="line">```bash</span><br><span class="line">ipmitool bmc reset cold</span><br></pre></td></tr></table></figure><h4 id="get-SOL-console"><a href="#get-SOL-console" class="headerlink" title="get SOL console"></a>get SOL console</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modprobe lanplus <span class="comment"># If not yet loaded</span></span><br><span class="line">ipmitool -H &lt;IP&gt; -U &lt;user&gt; -I lanplus sol activate</span><br></pre></td></tr></table></figure><h4 id="Set-power-policy"><a href="#Set-power-policy" class="headerlink" title="Set power policy"></a>Set power policy</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool -H <span class="variable">$JBOD_BMCIP</span> -U <span class="variable">$user</span> -P <span class="variable">$your_password</span> chassis<span class="built_in"> policy </span>previous</span><br><span class="line">    always-on   : turn on when power is restored</span><br><span class="line">    previous    : return <span class="keyword">to</span> previous state when power is restored</span><br><span class="line">    always-off  : stay off after power is restored</span><br></pre></td></tr></table></figure><h3 id="IPMI-log-issues"><a href="#IPMI-log-issues" class="headerlink" title="IPMI log issues"></a>IPMI log issues</h3><p>Pass the ipmitool sel elist, I found some interesting things</p><p>case1:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">5de1 | 02/27/2018 | 00:22:39 | Voltage Vcpu | Lower Non-recoverable going low  | Deasserted | Reading 1.22 &lt; Threshold 0.49 Volts</span><br><span class="line">5de2 | 02/27/2018 | 00:22:39 | Voltage Vcpu | Lower Critical going low  | Deasserted | Reading 1.22 &lt; Threshold 0.49 Volts</span><br></pre></td></tr></table></figure><p><a href="https://www.intel.co.uk/content/www/uk/en/support/articles/000024276/server-products/intel-data-center-blocks-intel-dcb.html">case2:</a><br>Here is the issues:<br>In most cases, the event points to the Alternating Current (AC) power (electrical outlet power) spiking under the minimum warning and fault thresholds for over 20 milliseconds while the system powered on. Therefore, check the power source.</p><p>Other steps to consider if necessary:</p><p>Make sure that the firmware is updated to the latest version.<br>Check for foreign objects inside the chassis such as screws that could grind the board. Reset the power supplies.<br>Correctly attach the Intel Server Board to the chassis base with the spacers/stand-offs. Refer to the board service guide if in doubt and make sure not to tighten the screws too much.<br>Check that the cables connecting the chassis front panel to the Intel Server Board are plugged in properly to the front panel header.<br>Make sure the drive ribbon cables inside the computer are attached correctly and securely.<br>If youre using a UPS, see to it that its compliant. Access Frequently Asked Questions About UPS Support for more details.</p><p>If, despite these above recommendations, the situation persists, contact Support with the SysInfo event logs for further diagnosis.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Warning event: PS2 Status reports a predictive failure due to under-voltage that has been detected. This state may result <span class="keyword">in</span> power supply failure.</span><br><span class="line">Warning event: PS1 Status reports a predictive failure due to under-voltage that has been detected. This state may result <span class="keyword">in</span> power supply failure.</span><br><span class="line">Warning event: PS2 Status reports the power supply<span class="string">&#x27;s input (AC/DC) has been lost.</span></span><br><span class="line"><span class="string">CRITICAL event: Pwr Unit Status reports that the power unit has suffered a failure (power supply failure).</span></span><br></pre></td></tr></table></figure><p>Here is the production env<br>At 2019-03-10 the power supply has the jitter in Power Supply, I get this error in a lot of servers at the same time, and they are in the same data center and in diff rack</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1a | 03/10/2019 | 16:04:21 | Power Supply Status | Power Supply AC lost | Deasserted</span><br><span class="line">1b | 03/10/2019 | 16:04:31 | Power Supply PS Redundancy | Fully Redundant | Asserted</span><br></pre></td></tr></table></figure><h3 id="IPMI-hex-to-ipaddr"><a href="#IPMI-hex-to-ipaddr" class="headerlink" title="IPMI hex to ipaddr"></a>IPMI hex to ipaddr</h3><p>C0 A8 30 AF<br>16<em>12(c)+0=192<br>16</em>10(a)+8=168<br>16<em>3+0=48<br>16</em>10(a)+16=176</p><p>192.168.48.176</p><h3 id="IPMI-modify-fru-info"><a href="#IPMI-modify-fru-info" class="headerlink" title="IPMI modify fru info"></a><a href="https://computercheese.blogspot.com/2013/05/ipmi-fru-commands.html">IPMI modify fru info</a></h3><p>You could custom some informations to IPMI, it s easy to access, not depends the root/Administrator</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool fru <span class="built_in">print</span></span><br><span class="line"><span class="comment">#.... print all info</span></span><br><span class="line"></span><br><span class="line">$ ipmitool fru <span class="built_in">read</span> 0 fru0.bin</span><br><span class="line">Fru Size         : 2048 bytes</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">$ ls -lhs fru0.bin</span><br><span class="line">4.0K -rw-r--r-- 1 root root 2.0K Feb 24 14:59 fru0.bin</span><br><span class="line"></span><br><span class="line">$ xxd -b fru0.bin</span><br><span class="line">000000c: 11010001 10100111 10000011 01100100 11001001 10110010  ...d..</span><br><span class="line">0000012: 11001001 01000100 01100101 01101100 01101100 00100000  .Dell</span><br><span class="line">0000018: 01010010 00110111 00110011 00110000 11001110 01000011  R730.C</span><br><span class="line"></span><br><span class="line"><span class="comment"># recover the backup; </span></span><br><span class="line">$ ipmitool fru <span class="built_in">read</span> 0 fru0.bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ipmitool fru <span class="built_in">print</span> 0x00</span><br><span class="line"> Board Mfg Date        : Mon Nov 28 22:52:00 2016</span><br><span class="line"> Board Mfg             : DELL</span><br><span class="line"> Board Product         : PowerEdge R730</span><br><span class="line"> Board Serial          : --------------</span><br><span class="line"> Board Part Number     : ---------</span><br><span class="line"> Product Manufacturer  : DELL</span><br><span class="line"> Product Name          : PowerEdge R730</span><br><span class="line"> Product Version       : 01</span><br><span class="line"> Product Serial        : ---------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ipmitool fru edit 0 field b 1 <span class="string">&quot;Dell R730&quot;</span></span><br><span class="line">String size are not equal, resizing fru to fit new string</span><br><span class="line">Read All FRU area</span><br><span class="line">Fru Size       : 2048 bytes</span><br><span class="line">Copy to new FRU</span><br><span class="line">Section Length: 56</span><br><span class="line">Padding Length: 2</span><br><span class="line">NumByte Change: -5</span><br><span class="line">Start SecChnge: ce</span><br><span class="line">End SecChnge  : 20</span><br><span class="line">Start Section : 1</span><br><span class="line">End Sec wo Pad: c1</span><br><span class="line">End Section   : f1</span><br><span class="line">New Padding Length: 7</span><br><span class="line">Updating Field : <span class="string">&#x27;PowerEdge R730&#x27;</span> with <span class="string">&#x27;Dell R730&#x27;</span> ... (Length from <span class="string">&#x27;206&#x27;</span> to <span class="string">&#x27;201&#x27;</span>)</span><br><span class="line">Copying remaining of sections: 35</span><br><span class="line">Calculate New Checksum: fffffff7</span><br><span class="line">Writing new FRU.</span><br><span class="line">Done.</span><br><span class="line"></span><br><span class="line">$ ipmitool fru <span class="built_in">print</span> 0x00</span><br><span class="line"> Board Mfg Date        : Mon Nov 28 22:52:00 2016</span><br><span class="line"> Board Mfg             : DELL</span><br><span class="line"> Board Product         : Dell R730</span><br><span class="line"> Board Serial          : -------------</span><br><span class="line"> Board Part Number     : --------</span><br><span class="line"> Product Manufacturer  : DELL</span><br><span class="line"> Product Name          : PowerEdge R730</span><br><span class="line"> Product Version       : 01</span><br><span class="line"> Product Serial        : --------</span><br><span class="line"></span><br><span class="line">$ ipmitool fru <span class="built_in">print</span> 0x00</span><br><span class="line"> Board Mfg Date        : Mon Nov 28 22:52:00 2016</span><br><span class="line"> Board Mfg             : DELL</span><br><span class="line"> Board Product         : Dell R730</span><br><span class="line"> Board Serial          : --------------</span><br><span class="line"> Board Part Number     : ------</span><br><span class="line"> Product Manufacturer  : DELL</span><br><span class="line"> Product Name          : PowerEdge R730</span><br><span class="line"> Product Version       : 01</span><br><span class="line"> Product Serial        : ------</span><br><span class="line">$ ipmitool fru edit 0 field p 1 R740 <span class="comment"># modify product from PowerEdge R730 to R740</span></span><br><span class="line">$ ipmitool fru <span class="built_in">print</span> 0x00</span><br><span class="line"> Board Mfg Date        : Mon Nov 28 22:52:00 2016</span><br><span class="line"> Board Mfg             : DELL</span><br><span class="line"> Board Product         : Dell R730</span><br><span class="line"> Board Serial          : -----------</span><br><span class="line"> Board Part Number     : --------</span><br><span class="line"> Product Manufacturer  : DELL</span><br><span class="line"> Product Name          : R740</span><br><span class="line"> Product Extra         : 01</span><br><span class="line"> Product Extra         : --------</span><br></pre></td></tr></table></figure><h4 id="Supermicro-not-suppport-ipmitool"><a href="#Supermicro-not-suppport-ipmitool" class="headerlink" title="Supermicro not suppport ipmitool"></a>Supermicro not suppport ipmitool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ./SMCIPMITool <span class="variable">$the_ipmi_ip</span> ADMIN ADMIN ipmi fruw BPN XXXX</span><br><span class="line">Board mfg. Date/Time (BDT)     = 1996/01/01 00:00:00 (00 00 00)</span><br><span class="line">Board Manufacturer Name (BM)   = Supermicro</span><br><span class="line">Board Product Name (BPN)       = XXXX</span><br><span class="line">Board Serial Number (BS)       =</span><br><span class="line">Board Part Number (BP)         =</span><br><span class="line">Board FRU File ID              =</span><br><span class="line">Product Manufacturer Name (PM) =</span><br><span class="line">Product Name (PN)              =</span><br><span class="line">Product PartModel Number (PPM) =</span><br><span class="line">Product Version (PV)           =</span><br><span class="line">Product Serial Number (PS)     = RD-BIH-00-05056</span><br><span class="line">Product Asset Tag (PAT)        =</span><br><span class="line">Product FRU File ID            =</span><br><span class="line">$ ./SMCIPMITool <span class="variable">$the_ipmi_ip</span> ADMIN ADMIN ipmi fru <span class="built_in">print</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://discuss.pivotal.io/hc/en-us/articles/206396927-How-to-work-on-IPMI-and-IPMITOOL">reference1</a><br><a href="https://www.intel.co.uk/content/www/uk/en/support/articles/000024276/server-products/intel-data-center-blocks-intel-dcb.html">reference2</a></p>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ipmi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BIOS</title>
      <link href="2018/05/27/bios/"/>
      <url>2018/05/27/bios/</url>
      
        <content type="html"><![CDATA[<ul><li>C-state disabled. Ensure that the CPUs are always in the C0 (fully operational) state. Each CPU has several power modes and they are collectively called C-states or C-modes..<br><del>~ *P-state disabled. The processor P-state is the capability of running the processor at different voltage and/or frequency levels. Generally, P0 is the highest state resulting in maximum performance, while P1, P2, and so on, will save power but at some penalty to CPU performance. ~</del><ul><li>I can t agree it, I will active the P-state</li></ul></li><li>Hyper-threading enabled/disabled<ul><li>it s depends your application<br><del>~ * Turbo Boost Disabled. Turbo Boost has a series of dynamic frequency scaling technologies enabling the processor to run above its base operating frequency via dynamic control. Although Turbo Boost (overclocking) would increase the performance, not all cores would be running at the turbo frequency and it would impact the consistency of the performance tests, thus it would not be a real representation of the platform performance. ~</del></li><li>I can t agree it, From Xeon E5 v2 to Scalable Xeon, intel just write single core turbo in ark, but it s not means all cores could bot be turbo.  Eg: I enabled all core turbo for E5 2630v4, the performance same with not enable Turbo from E5 2640v4. I have test E7-4890v2, default cpu frequency only 2.8GHz, All cores turbo could reach 3.2GHz</li></ul></li></ul><a id="more"></a><ul><li><p>System Management Interrupts disabled. Disabling the Processor Power and Utilization Monitoring SMI has a great effect because it generates a processor interrupt eight times a second in G6 and later servers. Disabling the Memory Pre-Failure Notification SMI has a smaller effect because it generates an interrupt at a lower frequency</p></li><li><p>Correct setting of BIOS for DUT (w/ SmartNIC) is important, to address:</p><ul><li>Throughput variations due to CPU power state changes (C-state; P-state)</li><li>Blips (short duration packet drops) due to interrupts (SMI)</li></ul></li><li><p>Power Management</p><ul><li>Power Regulator = [Static High Performance] (was dynamic power<br>savings)</li><li>Minimum Processor Core Idle C-state = [No C-states] (was C-6)</li><li>Minimum Package Idle C-state = [ No package state] (was C-6)</li><li>Power Profile = [ Max Performance ] (was customer) this ended up setting the above anyway (and graying them out)</li></ul></li><li><p>Prevent CPUs from entering power savings modes as transitions cause OS and VM drivers to drop packets.</p><ul><li>Yes, I have the same issues.</li></ul></li></ul><p>Example settings (HP) changes (cont.)</p><ul><li>SMI - System Management Interrupts<ul><li>Memory pre-failure notification = [disabled] (was enabled)</li></ul></li><li>When enabled, CPU is periodically interrupted, resulting in packet drops when close to throughput<br>capacity.<ul><li>Disable all non-essential SMIs</li><li>Frequency of SMI varies<ul><li>On an HP DL380 gen9 it is every 60s</li><li>On gen6,7 it is every hour</li><li>On gen8 every 5 minutes</li></ul></li></ul></li></ul><p>System management interrupts (SMIs) are used to offer extended functionality, such as legacy hardware device emulation. They can also be used for system management tasks. SMIs are similar to NMIs in that they use a special electrical signalling line directly into the CPU, and are generally not able to be masked.<br>When an SMI is received, the CPU will enter System Management Mode (SMM). In this mode, a very low-level handler routine is run to handle the SMIs. The SMM is typically provided directly from the system management firmware, often the BIOS or the EFI.<br>SMIs are most often used to provide legacy hardware emulation. A common example is to emulate a diskette drive. If there is no diskette attached to the system, a virtualized network-managed emulation can be used instead. When the operating system attempts to access the diskette, an SMI is triggered and a handler provides the operating system with an emulated device instead. The operating system then treats the emulation as though it were the legacy device itself.<br>Red Hat Enterprise Linux for Real Time can be adversely affected by SMIs because they take place without the direct involvement of the operating system. A poorly written SMI handling routine may consume many milliseconds of CPU time, and the operating system is not able to preempt the handler if it needs to. This situation creates periodic high latencies in an otherwise well-tuned, highly responsive system. Unfortunately, because SMI handlers can be used by a vendor to manage CPU temperature and fan control, it is not possible to disable them. Instead, it is recommended that you notify the vendor of the problem.<br>You can attempt to isolate SMIs on a Red Hat Enterprise Linux for Real Time system using the hwlatdetect utility, which is available in the rt-tests package. This utility is designed to measure periods of time during which the CPU has been stolen by an SMI handling routine.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">processor: 119</span><br><span class="line">vendor_id: GenuineIntel</span><br><span class="line">cpu family: 6</span><br><span class="line">model: 62</span><br><span class="line">model name: Intel(R) Xeon(R) CPU E7-4890 v2 @ 2.80GHz</span><br><span class="line">stepping: 7</span><br><span class="line">microcode: 0x713</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">cache size: 38400 KB</span><br><span class="line">physical id: 3</span><br><span class="line">siblings: 30</span><br><span class="line">core id: 14</span><br><span class="line">cpu cores: 15</span><br><span class="line">apicid: 125</span><br><span class="line">initial apicid: 125</span><br><span class="line">fpu: yes</span><br><span class="line">fpu_exception: yes</span><br><span class="line">cpuid level: 13</span><br><span class="line">wp: yes</span><br><span class="line">flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm epb intel_ppin ibrs ibpb stibp tpr_shadow vnmi flexpriority ept vpid fsgsbase smep erms xsaveopt dtherm ida arat pln pts spec_ctrl intel_stibp</span><br><span class="line">bogomips: 5638.89</span><br><span class="line">clflush size: 64</span><br><span class="line">cache_alignment: 64</span><br><span class="line">address sizes: 46 bits physical, 48 bits virtual</span><br><span class="line">power management:</span><br><span class="line"></span><br><span class="line">cat /proc/cpuinfo | grep MHz</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">cpu MHz: 3199.902</span><br><span class="line">....</span><br></pre></td></tr></table></figure><h3 id="mpt3sas-mpt2sas-HBA-boot-with-high-density-JBOD"><a href="#mpt3sas-mpt2sas-HBA-boot-with-high-density-JBOD" class="headerlink" title="mpt3sas/mpt2sas HBA boot with high density JBOD"></a>mpt3sas/mpt2sas HBA boot with high density JBOD</h3><h4 id="Set-quick-boot"><a href="#Set-quick-boot" class="headerlink" title="Set quick boot"></a>Set quick boot</h4><p>Under BIOS boot mode and enable HBA ctrl + C option<br><img src="/img/mpt3sas-no-boot.jpg"></p><h3 id="Power-setting"><a href="#Power-setting" class="headerlink" title="Power setting"></a>Power setting</h3><h4 id="OS-control"><a href="#OS-control" class="headerlink" title="OS control"></a>OS control</h4><p><img src="/img/power-policy1.png"></p><h4 id="1-1-loading-balance-mode-for-power-supply"><a href="#1-1-loading-balance-mode-for-power-supply" class="headerlink" title="1+1 loading balance mode for power supply"></a>1+1 loading balance mode for power supply</h4><p><img src="/img/power-policy2.png"></p><p><a href="https://open-nfp.org/m/documents/Measuring_a_25_and_40Gbps_Data_Plane.pdf">reference</a><br><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/reference_guide/system_management_interrupts">reference2</a></p>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bios </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ansible</title>
      <link href="2018/04/12/ansible/"/>
      <url>2018/04/12/ansible/</url>
      
        <content type="html"><![CDATA[<h3 id="Get-all-variables-for-this-group"><a href="#Get-all-variables-for-this-group" class="headerlink" title="Get all variables for this group"></a>Get all variables for this group</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible <span class="built_in">test</span> -m setup</span><br></pre></td></tr></table></figure><h3 id="debug-variable"><a href="#debug-variable" class="headerlink" title="debug variable"></a>debug variable</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: Get the kernel module version</span><br><span class="line">  shell: modinfo mpt3sas</span><br><span class="line">  register: mpt3sas_ver</span><br><span class="line">  ignore_errors: <span class="literal">true</span></span><br><span class="line">  tags:</span><br><span class="line">    - test_install</span><br><span class="line"></span><br><span class="line">- name: output mpt3sas_ver</span><br><span class="line">  debug: var=mpt3sas_ver</span><br></pre></td></tr></table></figure><h3 id="multiple-when-condition"><a href="#multiple-when-condition" class="headerlink" title="multiple when condition"></a><a href="https://github.com/ansible/ansible/issues/22397">multiple when condition</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">force_install :yes <span class="comment"># define in group_var/test</span></span><br><span class="line">when: <span class="string">&quot;(system_type is match(&#x27;your_key_word&#x27;) and (megaraid_version.rc != 0 or mpt3sas_ver.rc != 0)) or (system_ty pe is match(&#x27;your_key_word&#x27;) and force_install)&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Got-NIC-info"><a href="#Got-NIC-info" class="headerlink" title="Got NIC info"></a>Got NIC info</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">cat ../../host_vars/192.168.8.2</span><br><span class="line">network_bond_interfaces:</span><br><span class="line"> - device: bond0</span><br><span class="line">   address: 192.168.1.2</span><br><span class="line">   netmask: 225.255.225.0</span><br><span class="line">   gateway: 192.168.1.1</span><br><span class="line">   bootproto: static</span><br><span class="line">   bond_mode: 4</span><br><span class="line">   bond_miimon: 1000</span><br><span class="line">   bond_slaves: [enp1s0f0,enp1s0f1]</span><br><span class="line">network_ether_interfaces:</span><br><span class="line"> - device: eno1</span><br><span class="line">   bootproto: static</span><br><span class="line">   address: 192.168.1.20</span><br><span class="line">   netmask: 255.255.0.0</span><br><span class="line">   route:</span><br><span class="line">    - network: 192.168.200.0</span><br><span class="line">      netmask: 24</span><br><span class="line">      gateway: 192.168.200.1</span><br><span class="line">    - network: 192.168.100.0</span><br><span class="line">      netmask: 24</span><br><span class="line">      gateway: 192.168.100.1</span><br><span class="line"> - device: eno2</span><br><span class="line">   bootproto: static</span><br><span class="line">   address: 192.168.1.21</span><br><span class="line">   netmask: 255.255.0.0</span><br><span class="line">   route:</span><br><span class="line">    - network: 192.168.200.0</span><br><span class="line">      netmask: 24</span><br><span class="line">      gateway: 192.168.200.2</span><br><span class="line">    - network: 192.168.100.0</span><br><span class="line">      netmask: 24</span><br><span class="line">      gateway: 192.168.100.2</span><br><span class="line"></span><br><span class="line">- debug:</span><br><span class="line">    msg:</span><br><span class="line">    - &quot;&#123;&#123; network_bond_interfaces &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">- debug:</span><br><span class="line">    msg:</span><br><span class="line">    - &quot;&#123;&#123; ansible_os_family &#125;&#125;&quot;</span><br><span class="line">    - &quot;&#123;&#123; item.device &#125;&#125;&quot;</span><br><span class="line">    - &quot;&#123;&#123; item.address &#125;&#125;&quot;</span><br><span class="line">    - &quot;&#123;&#123; item.bond_slaves.0 &#125;&#125;&quot;</span><br><span class="line">    - &quot;&#123;&#123; item.bond_slaves.1 &#125;&#125;&quot;</span><br><span class="line">    - &quot;&#123;&#123; item.bond_slaves &#125;&#125;&quot;</span><br><span class="line">    - &quot;&#123;&#123; hostvars[inventory_hostname][&#x27;ansible_&#x27; + item.bond_slaves.0 ].macaddress &#125;&#125;&quot;</span><br><span class="line">  with_items:</span><br><span class="line">     - &quot;&#123;&#123; network_bond_interfaces &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;</span>: [</span><br><span class="line">        [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;192.168.1.2&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;bond_miimon&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">                <span class="attr">&quot;bond_mode&quot;</span>: <span class="number">4</span>,</span><br><span class="line">                <span class="attr">&quot;bond_slaves&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;enp1s0f0&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;enp1s0f1&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;bootproto&quot;</span>: <span class="string">&quot;static&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;device&quot;</span>: <span class="string">&quot;bond0&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;gateway&quot;</span>: <span class="string">&quot;192.168.1.1&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;netmask&quot;</span>: <span class="string">&quot;225.255.225.0&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [network : debug] ************************************************************************************************************************************************************************</span><br><span class="line">ok: [10.53.128.224] =&gt; (item=&#123;u&#x27;bond_miimon&#x27;: 1000, u&#x27;bond_slaves&#x27;: [u&#x27;enp1s0f0&#x27;, u&#x27;enp1s0f1&#x27;], u&#x27;bond_mode&#x27;: 4, u&#x27;netmask&#x27;: u&#x27;225.255.225.0&#x27;, u&#x27;bootproto&#x27;: u&#x27;static&#x27;, u&#x27;address&#x27;: u&#x27;192.168.1.2&#x27;, u&#x27;device&#x27;: u&#x27;bond0&#x27;, u&#x27;gateway&#x27;: u&#x27;192.168.1.1&#x27;&#125;) =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: [</span><br><span class="line">        &quot;RedHat&quot;,</span><br><span class="line">        &quot;bond0&quot;,</span><br><span class="line">        &quot;192.168.1.2&quot;,</span><br><span class="line">        &quot;enp1s0f0&quot;,</span><br><span class="line">        &quot;enp1s0f1&quot;,</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&quot;enp1s0f0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;enp1s0f1&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;3c:fd:fe:15:08:40&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## create bonding</span><br><span class="line">- name: Write configuration files for route configuration</span><br><span class="line">  template: src=route_&#123;&#123; ansible_os_family &#125;&#125;.j2 dest=&#123;&#123; net_path &#125;&#125;/route-&#123;&#123; item.device &#125;&#125;</span><br><span class="line">  with_items:</span><br><span class="line">     - &quot;&#123;&#123; network_bond_interfaces &#125;&#125;&quot;</span><br><span class="line">  when: network_bond_interfaces is defined and item.route is defined and ansible_os_family == &#x27;RedHat&#x27;</span><br><span class="line"></span><br><span class="line">- name: Create the network configuration file for slave in the bond devices</span><br><span class="line">  template: src=bond_slave_&#123;&#123; ansible_os_family &#125;&#125;.j2 dest=&#123;&#123; net_path &#125;&#125;/ifcfg-&#123;&#123; item.1 &#125;&#125;</span><br><span class="line">  with_subelements:</span><br><span class="line">   - &quot;&#123;&#123; network_bond_interfaces &#125;&#125;&quot;</span><br><span class="line">   - bond_slaves</span><br><span class="line">  when: network_bond_interfaces is defined</span><br><span class="line">  register: bond_port_result</span><br><span class="line"></span><br><span class="line">- debug: msg=&quot;&#123;&#123; bond_port_result &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- shell: ifdown bond_slave &#123;&#123; item.item.1 &#125;&#125;; ifup &#123;&#123; item.item.1 &#125;&#125;</span><br><span class="line">  with_items:</span><br><span class="line">    - &quot;&#123;&#123; bond_port_result.results &#125;&#125;&quot;</span><br><span class="line">  when: network_bond_interfaces is defined and bond_slaves is defined</span><br><span class="line">  register: if_slave</span><br><span class="line"></span><br><span class="line">- debug:</span><br><span class="line">    msg:</span><br><span class="line">    - &quot;&#123;&#123; item.route.1 &#125;&#125;&quot;</span><br><span class="line">  with_items:</span><br><span class="line">     - &quot;&#123;&#123; network_ether_interfaces &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line"> =&gt; (item=&#123;u&#x27;device&#x27;: u&#x27;eno1&#x27;, u&#x27;netmask&#x27;: u&#x27;255.255.0.0&#x27;, u&#x27;bootproto&#x27;: u&#x27;static&#x27;, u&#x27;route&#x27;: [&#123;u&#x27;netmask&#x27;: 24, u&#x27;network&#x27;: u&#x27;192.168.200.0&#x27;, u&#x27;gateway&#x27;: u&#x27;192.168.200.1&#x27;&#125;, &#123;u&#x27;netmask&#x27;: 24, u&#x27;network&#x27;: u&#x27;192.168.100.0&#x27;, u&#x27;gateway&#x27;: u&#x27;192.168.100.1&#x27;&#125;], u&#x27;address&#x27;: u&#x27;192.168.1.20&#x27;&#125;) =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gateway&quot;</span>: <span class="string">&quot;192.168.100.1&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;netmask&quot;</span>: <span class="number">24</span>,</span><br><span class="line">            <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;192.168.100.0&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.53.128.224] =&gt; (item=&#123;u&#x27;device&#x27;: u&#x27;eno2&#x27;, u&#x27;netmask&#x27;: u&#x27;255.255.0.0&#x27;, u&#x27;bootproto&#x27;: u&#x27;static&#x27;, u&#x27;route&#x27;: [&#123;u&#x27;netmask&#x27;: 24, u&#x27;network&#x27;: u&#x27;192.168.200.0&#x27;, u&#x27;gateway&#x27;: u&#x27;192.168.200.2&#x27;&#125;, &#123;u&#x27;netmask&#x27;: 24, u&#x27;network&#x27;: u&#x27;192.168.100.0&#x27;, u&#x27;gateway&#x27;: u&#x27;192.168.100.2&#x27;&#125;], u&#x27;address&#x27;: u&#x27;192.168.1.21&#x27;&#125;) =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gateway&quot;</span>: <span class="string">&quot;192.168.100.2&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;netmask&quot;</span>: <span class="number">24</span>,</span><br><span class="line">            <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;192.168.100.0&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nmcli loading config file from centos 8</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- name: loading slave</span><br><span class="line">  shell: nmcli connection load &#123;&#123; net_path &#125;&#125;/ifcfg-&#123;&#123; item.1 &#125;&#125;</span><br><span class="line">  with_subelements:</span><br><span class="line">   - &quot;&#123;&#123; network_bond_interfaces &#125;&#125;&quot;</span><br><span class="line">   - bond_slaves</span><br><span class="line">  when: ansible_distribution_major_version == &quot;8&quot;</span><br><span class="line"></span><br><span class="line">- name: loading master</span><br><span class="line">  shell: nmcli connection load &#123;&#123; net_path &#125;&#125;/ifcfg-&#123;&#123; item.device &#125;&#125;</span><br><span class="line">  with_items:</span><br><span class="line">     - &quot;&#123;&#123; network_bond_interfaces &#125;&#125;&quot;</span><br><span class="line">  when: ansible_distribution_major_version == &quot;8&quot;</span><br></pre></td></tr></table></figure><h3 id="Continue-run"><a href="#Continue-run" class="headerlink" title="Continue run"></a>Continue run</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook playbook.yml --start-at=<span class="string">&quot;install packages&quot;</span></span><br><span class="line">ansible-playbook playbook.yml --step <span class="comment">## every step will ask you</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Custom-install-data"><a href="#Custom-install-data" class="headerlink" title="Custom install data"></a>Custom install data</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">$ cat group_vars/all</span><br><span class="line"></span><br><span class="line">ieel_ver: testfs2_102</span><br><span class="line">intel_ieel:</span><br><span class="line">  ieel310:</span><br><span class="line">    testfs:</span><br><span class="line">      - ieel310/testfs-2.7.19.8-3.10.0_514.2.2.el7_testfs.x86_64.x86_64.rpm</span><br><span class="line">      - ieel310/testfs-modules-2.7.19.8-3.10.0_514.2.2.el7_testfs.x86_64.x86_64.rpm</span><br><span class="line">      - ieel310/testfs-debuginfo-2.7.19.8-3.10.0_514.2.2.el7_testfs.x86_64.x86_64.rpm</span><br><span class="line">      - ieel310/testfs-osd-ldiskfs-2.7.19.8-3.10.0_514.2.2.el7_testfs.x86_64.x86_64.rpm</span><br><span class="line">      - ieel310/testfs-osd-ldiskfs-mount-2.7.19.8-3.10.0_514.2.2.el7_testfs.x86_64.x86_64.rpm</span><br><span class="line">      - ieel310/testfs-osd-zfs-2.7.19.8-3.10.0_514.2.2.el7_testfs.x86_64.x86_64.rpm</span><br><span class="line">      - ieel310/testfs-osd-zfs-mount-2.7.19.8-3.10.0_514.2.2.el7_testfs.x86_64.x86_64.rpm</span><br><span class="line">      - ieel310/testfs-iokit-2.7.19.8-3.10.0_514.2.2.el7.x86_64.x86_64.rpm</span><br><span class="line">    zfs:</span><br><span class="line">      - ieel310/spl-0.6.5.7-1.el7.x86_64.rpm</span><br><span class="line">      - ieel310/spl-dkms-0.6.5.7-1.el7.noarch.rpm</span><br><span class="line">      - ieel310/zfs-0.6.5.7-1.el7.x86_64.rpm</span><br><span class="line">      - ieel310/libzpool2-0.6.5.7-1.el7.x86_64.rpm</span><br><span class="line">      - ieel310/libzfs2-0.6.5.7-1.el7.x86_64.rpm</span><br><span class="line">      - ieel310/libuutil1-0.6.5.7-1.el7.x86_64.rpm</span><br><span class="line">      - ieel310/libnvpair1-0.6.5.7-1.el7.x86_64.rpm</span><br><span class="line">    e2fsprogs:</span><br><span class="line">      - ieel310/e2fsprogs-1.42.13.wc5-7.el7.x86_64.rpm</span><br><span class="line">      - ieel310/e2fsprogs-libs-1.42.13.wc5-7.el7.x86_64.rpm</span><br><span class="line">      - ieel310/libcom_err-1.42.13.wc5-7.el7.x86_64.rpm</span><br><span class="line">      - ieel310/libss-1.42.13.wc5-7.el7.x86_64.rpm</span><br><span class="line">    kernel:</span><br><span class="line">      - ieel310/kernel-3.10.0-514.2.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - ieel310/kernel-debuginfo-3.10.0-514.2.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - ieel310/kernel-debuginfo-common-x86_64-3.10.0-514.2.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - ieel310/kernel-devel-3.10.0-514.2.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - ieel310/kernel-headers-3.10.0-514.2.2.el7_testfs.x86_64.rpm</span><br><span class="line">    dkms:</span><br><span class="line">      - ieel310/dkms-2.3-1.20161202gitde1dca9.el7.noarch.rpm</span><br><span class="line">      - ieel310/testfs-dkms-2.7.19.8-1.el7.noarch.rpm</span><br><span class="line">      - ieel310/zfs-dkms-0.6.5.7-1.el7.noarch.rpm</span><br><span class="line">  testfs2_102:</span><br><span class="line">    e2fsprogs:</span><br><span class="line">      - testfs2_102/e2fsprogs-1.42.13.wc6-7.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/e2fsprogs-libs-1.42.13.wc6-7.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/e2fsprogs-static-1.42.13.wc6-7.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/libcom_err-1.42.13.wc6-7.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/libss-1.42.13.wc6-7.el7.x86_64.rpm</span><br><span class="line">    testfs:</span><br><span class="line">      - testfs2_102/testfs-2.10.2-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/testfs-osd-zfs-mount-2.10.2-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/testfs-osd-ldiskfs-mount-2.10.2-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/kmod-testfs-osd-ldiskfs-2.10.2-1.el7.x86_64.rpm</span><br><span class="line">    zfs:</span><br><span class="line">      - testfs2_102/ksh-20120801-34.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/libnvpair1-0.7.3-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/libuutil1-0.7.3-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/libzfs2-0.7.3-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/libzpool2-0.7.3-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/zfs-0.7.3-1.el7.x86_64.rpm</span><br><span class="line">      - testfs2_102/spl-0.7.3-1.el7.x86_64.rpm</span><br><span class="line">    dkms:</span><br><span class="line">      - testfs2_102/testfs-dkms-2.10.2-1.el7.noarch.rpm</span><br><span class="line">      - testfs2_102/zfs-dkms-0.7.3-1.el7.noarch.rpm</span><br><span class="line">      - testfs2_102/dkms-2.3-5.20170523git8c3065c.el7.noarch.rpm</span><br><span class="line">      - testfs2_102/spl-dkms-0.7.3-1.el7.noarch.rpm</span><br><span class="line">    kernel:</span><br><span class="line">      - testfs2_102/kernel-3.10.0-693.5.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - testfs2_102/kernel-devel-3.10.0-693.5.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - testfs2_102/kernel-headers-3.10.0-693.5.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - testfs2_102/kernel-tools-3.10.0-693.5.2.el7_testfs.x86_64.rpm</span><br><span class="line">      - testfs2_102/kernel-tools-libs-3.10.0-693.5.2.el7_testfs.x86_64.rpm</span><br><span class="line">    sasdriver:</span><br><span class="line">      - testfs2_102/kmod-mpt3sas-26.00.00.00-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">- name: check testfs <span class="built_in">type</span></span><br><span class="line">  shell: bash -c <span class="string">&#x27;hostname | grep -Ei &quot;(mds|oss)&quot;&#x27;</span></span><br><span class="line">  register: testfs_type</span><br><span class="line">  ignore_errors: True</span><br><span class="line"></span><br><span class="line">- debug:</span><br><span class="line">   var: testfs_type.stdout</span><br><span class="line"></span><br><span class="line">- name: copy mds.conf to modprobe.d</span><br><span class="line">  copy: src=&#123;&#123; item &#125;&#125; dest=/etc/modprobe.d/testfs.conf</span><br><span class="line">  with_items:</span><br><span class="line">   - mds.conf</span><br><span class="line">  when: <span class="string">&#x27;&quot;mds&quot; in hostvars[inventory_hostname].testfs_type.stdout&#x27;</span></span><br><span class="line"></span><br><span class="line">- name: copy oss.conf to modprobe.d</span><br><span class="line">  copy: src=&#123;&#123; item &#125;&#125; dest=/etc/modprobe.d/testfs.conf</span><br><span class="line">  with_items:</span><br><span class="line">   - oss.conf</span><br><span class="line">  when: <span class="string">&#x27;&quot;oss&quot; in hostvars[inventory_hostname].testfs_type.stdout&#x27;</span></span><br><span class="line"></span><br><span class="line">- debug: var=intel_ieel.&#123;&#123; ieel_ver &#125;&#125;.kernel</span><br><span class="line"></span><br><span class="line">- name: Copy kernel packages</span><br><span class="line">  copy: src=&#123;&#123; item &#125;&#125; dest=&#123;&#123; templfs &#125;&#125;</span><br><span class="line">  with_items:</span><br><span class="line">   - <span class="string">&quot;&#123;&#123; intel_ieel[ieel_ver].kernel &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">- name: Install testfs kernel</span><br><span class="line">  shell: <span class="built_in">cd</span> &#123;&#123; templfs &#125;&#125; &amp;&amp; rpm -Uvh --force kernel-*.rpm &amp;&amp; sleep 5</span><br></pre></td></tr></table></figure><h3 id="localintall"><a href="#localintall" class="headerlink" title="localintall"></a>localintall</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- name: Copy dell racadm</span><br><span class="line">  copy: src=&#123;&#123; item &#125;&#125; dest=/dev/shm</span><br><span class="line">  with_items:</span><br><span class="line">   - dell_racadm/libsmbios-2.3.1-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/libsmbiosc++-2.3.1-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/smbios-utils-bin-2.3.1-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-argtable2-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-deng-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-deng-snmp-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-hapi-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-idrac7-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-idracadm7-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-idracadm-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-idrac-ivmcli-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-idrac-snmp-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-idrac-vmcli-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-isvc-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-isvc-snmp-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-omacs-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-omcommon-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-omilcore-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-racadm4-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-racadm5-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-rac-components-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line">   - dell_racadm/srvadmin-racdrsc-9.1.2-2965.12849.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">- name: find templfs all testfs releated rpm, using <span class="keyword">for</span> yum localinstall</span><br><span class="line">  find:</span><br><span class="line">    paths: <span class="string">&quot;/dev/shm&quot;</span></span><br><span class="line">    patterns: <span class="string">&#x27;*.rpm&#x27;</span></span><br><span class="line">  register: dellrpm</span><br><span class="line"></span><br><span class="line">- name: Install racadm rpm</span><br><span class="line">  yum:</span><br><span class="line">    name: <span class="string">&quot;&#123;&#123; dellrpm.files | map(attribute=&#x27;path&#x27;) | list &#125;&#125;&quot;</span></span><br><span class="line">    state: present</span><br></pre></td></tr></table></figure><h3 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##reboot</span></span><br><span class="line">- name: first restart server <span class="keyword">for</span> lutre kernel</span><br><span class="line">  shell: bash -c <span class="string">&#x27;(sleep 2 &amp;&amp; reboot -f)&#x27;</span></span><br><span class="line">  async: 1</span><br><span class="line">  poll: 0</span><br><span class="line"></span><br><span class="line">- name: waiting <span class="keyword">for</span> server to come back after reboot</span><br><span class="line">  local_action: wait_for host=&#123;&#123; inventory_hostname &#125;&#125; state=started timeout=600 delay=10 connect_timeout=600 port=22</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux system calls</title>
      <link href="2017/11/21/linux_calls/"/>
      <url>2017/11/21/linux_calls/</url>
      
        <content type="html"><![CDATA[<h3 id="Linux-system-calls"><a href="#Linux-system-calls" class="headerlink" title="Linux system calls"></a>Linux system calls</h3><p>/usr/include/asm-generic/errno.h<br>/usr/include/linux/syscalls.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="Get-these-names-from-syscalls-h"><a href="#Get-these-names-from-syscalls-h" class="headerlink" title="Get these names from syscalls.h"></a>Get these names from <a href="https://github.com/torvalds/linux/blob/master/include/linux/syscalls.h">syscalls.h</a></h4><a id="more"></a><h5 id="getaddrinfo"><a href="#getaddrinfo" class="headerlink" title="getaddrinfo"></a>getaddrinfo</h5><p>The getaddrinfo() and getnameinfo() functions are part of the POSIX standard application programming interface (API) for converting domain name system (DNS) hostnames and IP addresses between their human-readable text representations and structured binary formats for the operating systems networking API.</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/src/debug/glibc-2.17-c758a686/sysdeps/posix/getaddrinfo.c</span></span><br><span class="line"></span><br><span class="line">getaddrinfo (const char *name, const char *service,</span><br><span class="line">             const struct addrinfo *hints, struct addrinfo **pai)</span><br><span class="line">&#123;</span><br><span class="line">  int i = 0, last_i = 0;</span><br><span class="line">  int nresults = 0;</span><br><span class="line">  struct addrinfo *p = <span class="literal">NULL</span>;</span><br><span class="line">  struct gaih_service gaih_service, *pservice;</span><br><span class="line">  struct addrinfo local_hints;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name != <span class="literal">NULL</span> &amp;&amp; name[0] == <span class="string">&#x27;*&#x27;</span> &amp;&amp; name[1] == 0)</span><br><span class="line">    name = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (service != <span class="literal">NULL</span> &amp;&amp; service[0] == <span class="string">&#x27;*&#x27;</span> &amp;&amp; service[1] == 0)</span><br><span class="line">   <span class="built_in"> service </span>= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name == <span class="literal">NULL</span> &amp;&amp;<span class="built_in"> service </span>== <span class="literal">NULL</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">int getaddrinfo(const char *node,</span><br><span class="line">                const char *service,</span><br><span class="line">                const struct addrinfo *hints,</span><br><span class="line">                struct addrinfo **res);</span><br></pre></td></tr></table></figure><h4 id="Linux-error"><a href="#Linux-error" class="headerlink" title="Linux error"></a>Linux error</h4><p>/usr/include/asm-generic/errno.h</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;asm-generic/errno-base.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#defineEDEADLK35/* Resource deadlock would occur */</span></span><br><span class="line"><span class="comment">#defineENAMETOOLONG36/* File name too long */</span></span><br><span class="line"><span class="comment">#defineENOLCK37/* No record locks available */</span></span><br><span class="line"><span class="comment">#defineENOSYS38/* Function not implemented */</span></span><br><span class="line"><span class="comment">#defineENOTEMPTY39/* Directory not empty */</span></span><br><span class="line"><span class="comment">#defineELOOP40/* Too many symbolic links encountered */</span></span><br><span class="line"><span class="comment">#defineEWOULDBLOCKEAGAIN/* Operation would block */</span></span><br><span class="line"><span class="comment">#defineENOMSG42/* No message of desired type */</span></span><br><span class="line"><span class="comment">#defineEIDRM43/* Identifier removed */</span></span><br><span class="line"><span class="comment">#defineECHRNG44/* Channel number out of range */</span></span><br><span class="line"><span class="comment">#defineEL2NSYNC45/* Level 2 not synchronized */</span></span><br><span class="line"><span class="comment">#defineEL3HLT46/* Level 3 halted */</span></span><br><span class="line"><span class="comment">#defineEL3RST47/* Level 3 reset */</span></span><br><span class="line"><span class="comment">#defineELNRNG48/* Link number out of range */</span></span><br><span class="line"><span class="comment">#defineEUNATCH49/* Protocol driver not attached */</span></span><br><span class="line"><span class="comment">#defineENOCSI50/* No CSI structure available */</span></span><br><span class="line"><span class="comment">#defineEL2HLT51/* Level 2 halted */</span></span><br><span class="line"><span class="comment">#defineEBADE52/* Invalid exchange */</span></span><br><span class="line"><span class="comment">#defineEBADR53/* Invalid request descriptor */</span></span><br><span class="line"><span class="comment">#defineEXFULL54/* Exchange full */</span></span><br><span class="line"><span class="comment">#defineENOANO55/* No anode */</span></span><br><span class="line"><span class="comment">#defineEBADRQC56/* Invalid request code */</span></span><br><span class="line"><span class="comment">#defineEBADSLT57/* Invalid slot */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#defineEDEADLOCKEDEADLK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#defineEBFONT59/* Bad font file format */</span></span><br><span class="line"><span class="comment">#defineENOSTR60/* Device not a stream */</span></span><br><span class="line"><span class="comment">#defineENODATA61/* No data available */</span></span><br><span class="line"><span class="comment">#defineETIME62/* Timer expired */</span></span><br><span class="line"><span class="comment">#defineENOSR63/* Out of streams resources */</span></span><br><span class="line"><span class="comment">#defineENONET64/* Machine is not on the network */</span></span><br><span class="line"><span class="comment">#defineENOPKG65/* Package not installed */</span></span><br><span class="line"><span class="comment">#defineEREMOTE66/* Object is remote */</span></span><br><span class="line"><span class="comment">#defineENOLINK67/* Link has been severed */</span></span><br><span class="line"><span class="comment">#defineEADV68/* Advertise error */</span></span><br><span class="line"><span class="comment">#defineESRMNT69/* Srmount error */</span></span><br><span class="line"><span class="comment">#defineECOMM70/* Communication error on send */</span></span><br><span class="line"><span class="comment">#defineEPROTO71/* Protocol error */</span></span><br><span class="line"><span class="comment">#defineEMULTIHOP72/* Multihop attempted */</span></span><br><span class="line"><span class="comment">#defineEDOTDOT73/* RFS specific error */</span></span><br><span class="line"><span class="comment">#defineEBADMSG74/* Not a data message */</span></span><br><span class="line"><span class="comment">#defineEOVERFLOW75/* Value too large for defined data type */</span></span><br><span class="line"><span class="comment">#defineENOTUNIQ76/* Name not unique on network */</span></span><br><span class="line"><span class="comment">#defineEBADFD77/* File descriptor in bad state */</span></span><br><span class="line"><span class="comment">#defineEREMCHG78/* Remote address changed */</span></span><br><span class="line"><span class="comment">#defineELIBACC79/* Can not access a needed shared library */</span></span><br><span class="line"><span class="comment">#defineELIBBAD80/* Accessing a corrupted shared library */</span></span><br><span class="line"><span class="comment">#defineELIBSCN81/* .lib section in a.out corrupted */</span></span><br><span class="line"><span class="comment">#defineELIBMAX82/* Attempting to link in too many shared libraries */</span></span><br><span class="line"><span class="comment">#defineELIBEXEC83/* Cannot exec a shared library directly */</span></span><br><span class="line"><span class="comment">#defineEILSEQ84/* Illegal byte sequence */</span></span><br><span class="line"><span class="comment">#defineERESTART85/* Interrupted system call should be restarted */</span></span><br><span class="line"><span class="comment">#defineESTRPIPE86/* Streams pipe error */</span></span><br><span class="line"><span class="comment">#defineEUSERS87/* Too many users */</span></span><br><span class="line"><span class="comment">#defineENOTSOCK88/* Socket operation on non-socket */</span></span><br><span class="line"><span class="comment">#defineEDESTADDRREQ89/* Destination address required */</span></span><br><span class="line"><span class="comment">#defineEMSGSIZE90/* Message too long */</span></span><br><span class="line"><span class="comment">#defineEPROTOTYPE91/* Protocol wrong type for socket */</span></span><br><span class="line"><span class="comment">#defineENOPROTOOPT92/* Protocol not available */</span></span><br><span class="line"><span class="comment">#defineEPROTONOSUPPORT93/* Protocol not supported */</span></span><br><span class="line"><span class="comment">#defineESOCKTNOSUPPORT94/* Socket type not supported */</span></span><br><span class="line"><span class="comment">#defineEOPNOTSUPP95/* Operation not supported on transport endpoint */</span></span><br><span class="line"><span class="comment">#defineEPFNOSUPPORT96/* Protocol family not supported */</span></span><br><span class="line"><span class="comment">#defineEAFNOSUPPORT97/* Address family not supported by protocol */</span></span><br><span class="line"><span class="comment">#defineEADDRINUSE98/* Address already in use */</span></span><br><span class="line"><span class="comment">#defineEADDRNOTAVAIL99/* Cannot assign requested address */</span></span><br><span class="line"><span class="comment">#defineENETDOWN100/* Network is down */</span></span><br><span class="line"><span class="comment">#defineENETUNREACH101/* Network is unreachable */</span></span><br><span class="line"><span class="comment">#defineENETRESET102/* Network dropped connection because of reset */</span></span><br><span class="line"><span class="comment">#defineECONNABORTED103/* Software caused connection abort */</span></span><br><span class="line"><span class="comment">#defineECONNRESET104/* Connection reset by peer */</span></span><br><span class="line"><span class="comment">#defineENOBUFS105/* No buffer space available */</span></span><br><span class="line"><span class="comment">#defineEISCONN106/* Transport endpoint is already connected */</span></span><br><span class="line"><span class="comment">#defineENOTCONN107/* Transport endpoint is not connected */</span></span><br><span class="line"><span class="comment">#defineESHUTDOWN108/* Cannot send after transport endpoint shutdown */</span></span><br><span class="line"><span class="comment">#defineETOOMANYREFS109/* Too many references: cannot splice */</span></span><br><span class="line"><span class="comment">#defineETIMEDOUT110/* Connection timed out */</span></span><br><span class="line"><span class="comment">#defineECONNREFUSED111/* Connection refused */</span></span><br><span class="line"><span class="comment">#defineEHOSTDOWN112/* Host is down */</span></span><br><span class="line"><span class="comment">#defineEHOSTUNREACH113/* No route to host */</span></span><br><span class="line"><span class="comment">#defineEALREADY114/* Operation already in progress */</span></span><br><span class="line"><span class="comment">#defineEINPROGRESS115/* Operation now in progress */</span></span><br><span class="line"><span class="comment">#defineESTALE116/* Stale file handle */</span></span><br><span class="line"><span class="comment">#defineEUCLEAN117/* Structure needs cleaning */</span></span><br><span class="line"><span class="comment">#defineENOTNAM118/* Not a XENIX named type file */</span></span><br><span class="line"><span class="comment">#defineENAVAIL119/* No XENIX semaphores available */</span></span><br><span class="line"><span class="comment">#defineEISNAM120/* Is a named type file */</span></span><br><span class="line"><span class="comment">#defineEREMOTEIO121/* Remote I/O error */</span></span><br><span class="line"><span class="comment">#defineEDQUOT122/* Quota exceeded */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#defineENOMEDIUM123/* No medium found */</span></span><br><span class="line"><span class="comment">#defineEMEDIUMTYPE124/* Wrong medium type */</span></span><br><span class="line"><span class="comment">#defineECANCELED125/* Operation Canceled */</span></span><br><span class="line"><span class="comment">#defineENOKEY126/* Required key not available */</span></span><br><span class="line"><span class="comment">#defineEKEYEXPIRED127/* Key has expired */</span></span><br><span class="line"><span class="comment">#defineEKEYREVOKED128/* Key has been revoked */</span></span><br><span class="line"><span class="comment">#defineEKEYREJECTED129/* Key was rejected by service */</span></span><br><span class="line"></span><br><span class="line">/* <span class="keyword">for</span> robust mutexes */</span><br><span class="line"><span class="comment">#defineEOWNERDEAD130/* Owner died */</span></span><br><span class="line"><span class="comment">#defineENOTRECOVERABLE131/* State not recoverable */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define ERFKILL132/* Operation not possible due to RF-kill */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define EHWPOISON133/* Memory page has hardware error */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure><p>/usr/include/asm-generic/errno-base.h</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#defineEPERM 1/* Operation not permitted */</span></span><br><span class="line"><span class="comment">#defineENOENT 2/* No such file or directory */</span></span><br><span class="line"><span class="comment">#defineESRCH 3/* No such process */</span></span><br><span class="line"><span class="comment">#defineEINTR 4/* Interrupted system call */</span></span><br><span class="line"><span class="comment">#defineEIO 5/* I/O error */</span></span><br><span class="line"><span class="comment">#defineENXIO 6/* No such device or address */</span></span><br><span class="line"><span class="comment">#defineE2BIG 7/* Argument list too long */</span></span><br><span class="line"><span class="comment">#defineENOEXEC 8/* Exec format error */</span></span><br><span class="line"><span class="comment">#defineEBADF 9/* Bad file number */</span></span><br><span class="line"><span class="comment">#defineECHILD10/* No child processes */</span></span><br><span class="line"><span class="comment">#defineEAGAIN11/* Try again */</span></span><br><span class="line"><span class="comment">#defineENOMEM12/* Out of memory */</span></span><br><span class="line"><span class="comment">#defineEACCES13/* Permission denied */</span></span><br><span class="line"><span class="comment">#defineEFAULT14/* Bad address */</span></span><br><span class="line"><span class="comment">#defineENOTBLK15/* Block device required */</span></span><br><span class="line"><span class="comment">#defineEBUSY16/* Device or resource busy */</span></span><br><span class="line"><span class="comment">#defineEEXIST17/* File exists */</span></span><br><span class="line"><span class="comment">#defineEXDEV18/* Cross-device link */</span></span><br><span class="line"><span class="comment">#defineENODEV19/* No such device */</span></span><br><span class="line"><span class="comment">#defineENOTDIR20/* Not a directory */</span></span><br><span class="line"><span class="comment">#defineEISDIR21/* Is a directory */</span></span><br><span class="line"><span class="comment">#defineEINVAL22/* Invalid argument */</span></span><br><span class="line"><span class="comment">#defineENFILE23/* File table overflow */</span></span><br><span class="line"><span class="comment">#defineEMFILE24/* Too many open files */</span></span><br><span class="line"><span class="comment">#defineENOTTY25/* Not a typewriter */</span></span><br><span class="line"><span class="comment">#defineETXTBSY26/* Text file busy */</span></span><br><span class="line"><span class="comment">#defineEFBIG27/* File too large */</span></span><br><span class="line"><span class="comment">#defineENOSPC28/* No space left on device */</span></span><br><span class="line"><span class="comment">#defineESPIPE29/* Illegal seek */</span></span><br><span class="line"><span class="comment">#defineEROFS30/* Read-only file system */</span></span><br><span class="line"><span class="comment">#defineEMLINK31/* Too many links */</span></span><br><span class="line"><span class="comment">#defineEPIPE32/* Broken pipe */</span></span><br><span class="line"><span class="comment">#defineEDOM33/* Math argument out of domain of func */</span></span><br><span class="line"><span class="comment">#defineERANGE34/* Math result not representable */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> syscall </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dell command line in linux</title>
      <link href="2017/04/13/dell/"/>
      <url>2017/04/13/dell/</url>
      
        <content type="html"><![CDATA[<h3 id="SMcli"><a href="#SMcli" class="headerlink" title="SMcli"></a>SMcli</h3><h4 id="Discovery-devices"><a href="#Discovery-devices" class="headerlink" title="Discovery devices"></a>Discovery devices</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli -A</span><br></pre></td></tr></table></figure><h4 id="Got-serial-number"><a href="#Got-serial-number" class="headerlink" title="Got serial number"></a>Got serial number</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SMcli localhost -n <span class="variable">$yourstoragename</span>  -c <span class="string">&quot; show storagearray;&quot;</span> | grep -Ei <span class="string">&#x27;Chassis Serial Number|Part number|$serial_number&#x27;</span></span><br><span class="line">   Chassis Serial Number:                     SVC <span class="variable">$serial_number</span></span><br><span class="line">      RAID Controller Module DNS/Network name:   <span class="variable">$serial_number</span></span><br><span class="line">      RAID Controller Module DNS/Network name:   <span class="variable">$serial_number</span></span><br><span class="line">         Part number:                     SVC <span class="variable">$serial_number</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="Get-storage-system-name"><a href="#Get-storage-system-name" class="headerlink" title="Get storage-system-name"></a>Get storage-system-name</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-n means storage-system-name</span><br><span class="line">SMcli localhost</span><br></pre></td></tr></table></figure><h4 id="Get-storage-system-status"><a href="#Get-storage-system-status" class="headerlink" title="Get storage system status"></a>Get storage system status</h4><p>show ip address (ipaddr)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli  -n ControllerA  -c <span class="string">&quot; show storagearray healthstatus;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Show-all-info"><a href="#Show-all-info" class="headerlink" title="Show all info"></a>Show all info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SMcli localhost -n ControllerA -c <span class="string">&#x27;show storageArray profile;&#x27;</span></span><br><span class="line">SMcli  -n ControllerA  -c <span class="string">&quot;show allControllers  summary;&quot;</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">&quot;Show allVirtualDisks;&quot;</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">&quot;show AllPhysicalDisks summary;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### If no summary , it will output all details for each devices.</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">&quot;show allcontrollers;&quot;</span> <span class="comment">##NVRAM status, cache mirror</span></span><br><span class="line">SMcli  -n ControllerA  -c <span class="string">&quot;Show allphysicalDisks summary;&quot;</span></span><br><span class="line">SMcli  -n ControllerA  -c <span class="string">&quot;Show allphysicalDisks ;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Output-controller-log"><a href="#Output-controller-log" class="headerlink" title="Output controller log"></a>Output controller log</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli  -n ControllerA  -c <span class="string">&quot;save storageArray supportdata file=\&quot;/tmp/controller.log\&quot; force=true;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Reset-controller"><a href="#Reset-controller" class="headerlink" title="Reset controller"></a>Reset controller</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n  ControllerA -c <span class="string">&quot;reset controller 0;&quot;</span></span><br><span class="line">SMcli -n  ControllerA -c <span class="string">&quot;reset controller 1;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Blink-the-device"><a href="#Blink-the-device" class="headerlink" title="Blink the device"></a>Blink the device</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n ControllerA -c <span class="string">&quot;start physicalDisk [1,0,11] blink;&quot;</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">&quot;stop physicalDisk blink;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Get-battery-status"><a href="#Get-battery-status" class="headerlink" title="Get battery status"></a>Get battery status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n ControllerA -c <span class="string">&quot;show storageArray batteryage;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Get-battery-status-1"><a href="#Get-battery-status-1" class="headerlink" title="Get battery status"></a>Get battery status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n ControllerA -c <span class="string">&quot;show storageArray powerInfo;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Dump-all-logs"><a href="#Dump-all-logs" class="headerlink" title="Dump all logs"></a>Dump all logs</h4><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli localhost -n MD3460 -c <span class="string">&#x27;save storageArray allEvents file=&quot;</span>all_events.<span class="built_in">log</span><span class="string">&quot;;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="Enable-media-scan"><a href="#Enable-media-scan" class="headerlink" title="Enable media scan"></a>Enable media scan</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SMcli localhost -n MD3460 -c <span class="string">&quot;show storagearray;&quot;</span>  | grep <span class="string">&quot;frequency&quot;</span> -i</span><br><span class="line">   Media scan frequency:               1 days</span><br><span class="line">      Frequency:                         NA</span><br><span class="line"></span><br><span class="line">SMcli localhost -n MD3460 -c <span class="string">&quot;set storagearray mediaScanRate=1;&quot;</span> <span class="comment">#days, 1 means 1 day, max is 30 days ,defaults is 15 days</span></span><br><span class="line">SMcli localhost -n MD3460 -c <span class="string">&quot;set allVirtualDisks mediaScanEnabled=TRUE;&quot;</span> <span class="comment">#enable all VD media scan</span></span><br><span class="line">SMcli localhost -n MD3460 -c <span class="string">&quot;set allVirtualDisks consistencyCheckEnabled=False;&quot;</span> <span class="comment"># first time, don &#x27;t suggest enable consistency check</span></span><br></pre></td></tr></table></figure><h4 id="Important-check"><a href="#Important-check" class="headerlink" title="Important check"></a>Important check</h4><p><code>Because some of SAN dual controller create diff usable size cause data loss</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2018-10-20 SAN log</span></span><br><span class="line">$ cat storage-array-profile.txt | grep <span class="string">&quot;Usable capacity:         9,118.500&quot;</span> -c</span><br><span class="line">60</span><br><span class="line">$ cat storage-array-profile.txt | grep <span class="string">&quot;Usable capacity:         9,123.500&quot;</span> -c</span><br><span class="line">60</span><br><span class="line"></span><br><span class="line"><span class="comment"># it trigger the SAN bug cause dual controller lockdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># after re-import config, 2018-11-09 SAN log</span></span><br><span class="line">cat storage-array-profile.txt | grep <span class="string">&quot;Usable capacity:         9,118.500&quot;</span> -c</span><br><span class="line">120</span><br></pre></td></tr></table></figure><h3 id="shmcli"><a href="#shmcli" class="headerlink" title="shmcli"></a>shmcli</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/CentOS/RedHat Enterprise/g&#x27;</span> <span class="regexp">/etc/</span>redhat-release</span><br><span class="line">sed -i <span class="string">&#x27;s/CentOS/RedHat Enterprise/g&#x27;</span> <span class="regexp">/etc/</span>centos-release</span><br><span class="line">./ServerHardwareManager-<span class="number">2.1</span>.<span class="number">1</span>.r3f319ece-RHEL7-installer --mode unattended</span><br></pre></td></tr></table></figure><p>Because Dell MD1280 could not blink by sas2ircu</p><h4 id="Found-the-relationship-driver-and-JBOD"><a href="#Found-the-relationship-driver-and-JBOD" class="headerlink" title="Found the relationship driver and JBOD"></a>Found the relationship driver and JBOD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ shmcli list physical enclosures</span><br><span class="line"></span><br><span class="line">list physical enclosures - Executing <span class="built_in">command</span>..</span><br><span class="line">Encl<span class="comment">#            Name     Service Tag Encl Overall Sts              WWN   # Adapters Connected</span></span><br><span class="line">-----            ----     ----------- ----------------              ---   --------------------</span><br><span class="line">    0  EN-8435A-E6EBD     0002000                 OK 50050cc000000001                      1</span><br><span class="line">    1  EN-8435A-E6EBD     0001000                 OK 50050cc000000002                      1</span><br><span class="line"></span><br><span class="line">$ shmcli list drives </span><br><span class="line">WWN                OS Path   Vendor ProductId        Serial   Rev  Size   PredFail              Enclosure                     PPID</span><br><span class="line">5000cca2736726c7 /dev/sg10   HGSTHUH721010AL5200    2000000D  LS14 8.91TB          50050cc000000001 (EN-8435A-E6EBD)  TH007FPRHGT0087F678PA02</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can see /dev/sg10 is attach in 50050cc000000001(JBOD)</span></span><br><span class="line"><span class="comment"># WWN is 5000cca2736726c7 in first column</span></span><br><span class="line"></span><br><span class="line">$ shmcli list drives -verbose</span><br><span class="line"></span><br><span class="line"><span class="comment">#Got high await and util SAS dev</span></span><br><span class="line">[[ ! -f /dev/shm/shmcli_list_drivers ]] &amp;&amp; shmcli list drives -verbose &gt; /dev/shm/shmcli_list_drivers</span><br><span class="line">[[ ! -f /dev/shm/lsscsi.log ]] &amp;&amp; lsscsi -gi &gt; /dev/shm/lsscsi.log</span><br><span class="line">iostat -xm 2 14 | awk <span class="string">&#x27;NF==14 &amp;&amp; $1~/sd/&#123;if($NF&gt;80 &amp;&amp; $(NF-4)&gt;80) &#123;a[$1]++&#125;&#125; END&#123;for (i in a) &#123;print &quot;/dev/&quot;i,a[i]&#125;&#125;&#x27;</span> &gt; /dev/shm/high-lat-devs</span><br><span class="line"><span class="built_in">echo</span> OS-dev<span class="string">&quot;    &quot;</span>driver-dev<span class="string">&quot;   &quot;</span>dev-type<span class="string">&quot;    &quot;</span>serial<span class="string">&quot; &quot;</span>Firmware<span class="string">&quot; &quot;</span>size<span class="string">&quot;             &quot;</span>JBOD-NO<span class="string">&quot;             &quot;</span>Slot<span class="string">&quot;  &quot;</span>zpool</span><br><span class="line"><span class="built_in">cd</span> /dev/shm &amp;&amp; awk <span class="string">&#x27;NF==2 &#123;a[$1]=$2&#125;;NF==6 &amp;&amp; $0~/3500/&#123;b[$(NF-2)]=$(NF)&#125;; NF=18 &#123;c[$2]=$4&quot; &quot;$5&quot; &quot;$6&quot; &quot;$7&quot; &quot;$8&quot; &quot;$9&quot; &quot;$11&#125;;END&#123;for(i in a) &#123;res[b[i]]=i&#125;; for (i in res) &#123;print res[i],i,c[i]&#125;&#125; ;&#x27;</span> high-lat-devs lsscsi.log shmcli_list_drivers | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> zfspool=$(zdb -l $(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)1 | grep ost_); <span class="built_in">echo</span> -n <span class="variable">$line</span><span class="string">&quot; &quot;</span><span class="variable">$zfspool</span>; <span class="built_in">echo</span> ; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">OS-dev    driver-dev   dev-type    serial Firmware size             JBOD-NO             Slot  zpool</span><br><span class="line">/dev/sddt /dev/sg131 ST10000NM0256 ZA2839LZ TT54 8.91TB 50050cc11ac01694 (EN-8435A-E6EBD)  name: <span class="string">&#x27;ost_1&#x27;</span></span><br><span class="line">/dev/sddl /dev/sg123 ST10000NM0256 ZA27H764 TT54 8.91TB 50050cc11ac01694 (EN-8435A-E6EBD)  name: <span class="string">&#x27;ost_1&#x27;</span></span><br><span class="line">/dev/sddv /dev/sg133 ST10000NM0256 ZA27YFPB TT54 8.91TB 50050cc11ac01694 (EN-8435A-E6EBD)  name: <span class="string">&#x27;ost_1&#x27;</span></span><br><span class="line">/dev/sdde /dev/sg116 ST10000NM0256 ZA27YQLV TT54 8.91TB 50050cc11ac01694 (EN-8435A-E6EBD)  name: <span class="string">&#x27;ost_1&#x27;</span></span><br><span class="line">/dev/sddf /dev/sg117 ST10000NM0256 ZA27H83K TT54 8.91TB 50050cc11ac01694 (EN-8435A-E6EBD)  name: <span class="string">&#x27;ost_1&#x27;</span></span><br><span class="line">/dev/sddx /dev/sg136 ST10000NM0256 ZA2839NH TT54 8.91TB 50050cc11ac01694 (EN-8435A-E6EBD)  name: <span class="string">&#x27;ost_1&#x27;</span></span><br><span class="line">/dev/sddq /dev/sg128 ST10000NM0256 ZA2839VX TT54 8.91TB 50050cc11ac01694 (EN-8435A-E6EBD)  name: <span class="string">&#x27;ost_1&#x27;</span></span><br><span class="line"></span><br><span class="line">lsscsi -git  | grep sg10</span><br><span class="line">[17:0:8:0]   disk    sas:0x5000cca2736726c5          /dev/sdi   35000cca2736726c4  /dev/sg10</span><br></pre></td></tr></table></figure><h4 id="Blink-dev-led"><a href="#Blink-dev-led" class="headerlink" title="Blink dev led"></a>Blink dev led</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ shmcli blink drive -d = 5000cca2736726c7</span><br><span class="line">blink drive - Executing <span class="built_in">command</span>..</span><br><span class="line">Blink drive successful.</span><br><span class="line">blink drive - Command execution complete.</span><br><span class="line"></span><br><span class="line">$ shmcli list drive slots -a = 0 -enc = 0 -verbose | grep 2000000D -i</span><br><span class="line"><span class="comment"># -a = 0 first SAS HBA</span></span><br><span class="line"><span class="comment"># -enc enclosure number</span></span><br><span class="line">Enc Slot Drwr/Slot Status Vendor  ProductId       Serial   Size   Lnk   Rev Blnk? Logical Vols       SAS Connections</span><br><span class="line">65    1 / 23         OK    HGST   HUH721010AL5200 2000000D 8.91TB 6G,6G LS14 YES,  5000cca27330a695,      n/a</span><br><span class="line"><span class="comment"># you can see Blnk filed is YES</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#disable led</span></span><br><span class="line">$ shmcli blink drive -d = 5000cca2736726c7 -off</span><br></pre></td></tr></table></figure><h4 id="Get-JBOD-log"><a href="#Get-JBOD-log" class="headerlink" title="Get JBOD log"></a>Get JBOD log</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shmcli view <span class="built_in">log</span> -count=1000</span><br><span class="line"></span><br><span class="line">view <span class="built_in">log</span> - Executing <span class="built_in">command</span>..</span><br><span class="line">No valid <span class="built_in">log</span> files found.</span><br></pre></td></tr></table></figure><h4 id="Replace-dev"><a href="#Replace-dev" class="headerlink" title="Replace dev"></a>Replace dev</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">scsi 17:0:178:0: Direct-Access     HGST     HUH721010AL5200  LS03 PQ: 0 ANSI:</span> <span class="number">6</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">scsi 17:0:178:0: SSP:</span> <span class="string">handle(0x00c5),</span> <span class="string">sas_addr(0x5000cca266d6b0ce),</span> <span class="string">phy(12),</span> <span class="string">device_name(0x5000cca266d6b0cf)</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">scsi 17:0:178:0: SSP:</span> <span class="string">enclosure_logical_id(0x50050cc11ac01572),</span> <span class="string">slot(56)</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">scsi 17:0:178:0:</span> <span class="string">serial_number(7JKU27GC)</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">scsi 17:0:178:0:</span> <span class="string">qdepth(254),</span> <span class="string">tagged(1),</span> <span class="string">simple(0),</span> <span class="string">ordered(0),</span> <span class="string">scsi_level(7),</span> <span class="string">cmd_que(1)</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> <span class="string">Attached</span> <span class="string">scsi</span> <span class="string">generic</span> <span class="string">sg119</span> <span class="string">type</span> <span class="number">0</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> [<span class="string">sddh</span>] <span class="string">Enabling</span> <span class="string">DIF</span> <span class="string">Type</span> <span class="number">2</span> <span class="string">protection</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> [<span class="string">sddh</span>] <span class="attr">19134414848 512-byte logical blocks:</span> <span class="string">(9.79</span> <span class="string">TB/8.91</span> <span class="string">TiB)</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> [<span class="string">sddh</span>] <span class="number">4096</span><span class="string">-byte</span> <span class="string">physical</span> <span class="string">blocks</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> [<span class="string">sddh</span>] <span class="string">Write</span> <span class="string">Protect</span> <span class="string">is</span> <span class="string">off</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:02</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> [<span class="string">sddh</span>] <span class="attr">Mode Sense:</span> <span class="string">f7</span> <span class="number">00</span> <span class="number">10</span> <span class="number">08</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:03</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> [<span class="string">sddh</span>] <span class="attr">Write cache:</span> <span class="string">disabled,</span> <span class="attr">read cache:</span> <span class="string">enabled,</span> <span class="string">supports</span> <span class="string">DPO</span> <span class="string">and</span> <span class="string">FUA</span></span><br><span class="line">[<span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">16</span><span class="string">:14:03</span> <span class="number">2018</span>] <span class="attr">sd 17:0:178:0:</span> [<span class="string">sddh</span>] <span class="string">Attached</span> <span class="string">SCSI</span> <span class="string">disk</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">zpool</span> <span class="string">status</span> <span class="string">-x</span></span><br><span class="line">  <span class="attr">pool:</span> <span class="string">ost_85</span></span><br><span class="line"> <span class="attr">state:</span> <span class="string">DEGRADED</span></span><br><span class="line"><span class="attr">status:</span> <span class="string">One</span> <span class="string">or</span> <span class="string">more</span> <span class="string">devices</span> <span class="string">has</span> <span class="string">been</span> <span class="string">taken</span> <span class="string">offline</span> <span class="string">by</span> <span class="string">the</span> <span class="string">administrator.</span></span><br><span class="line"><span class="string">Sufficient</span> <span class="string">replicas</span> <span class="string">exist</span> <span class="string">for</span> <span class="string">the</span> <span class="string">pool</span> <span class="string">to</span> <span class="string">continue</span> <span class="string">functioning</span> <span class="string">in</span> <span class="string">a</span></span><br><span class="line"><span class="string">degraded</span> <span class="string">state.</span></span><br><span class="line"><span class="attr">action:</span> <span class="string">Online</span> <span class="string">the</span> <span class="string">device</span> <span class="string">using</span> <span class="string">&#x27;zpool online&#x27;</span> <span class="string">or</span> <span class="string">replace</span> <span class="string">the</span> <span class="string">device</span> <span class="string">with</span></span><br><span class="line"><span class="string">&#x27;zpool replace&#x27;</span><span class="string">.</span></span><br><span class="line">  <span class="attr">scan:</span> <span class="string">scrub</span> <span class="string">repaired</span> <span class="string">0B</span> <span class="string">in</span> <span class="string">0h1m</span> <span class="string">with</span> <span class="number">0</span> <span class="string">errors</span> <span class="string">on</span> <span class="string">Sat</span> <span class="string">Sep</span> <span class="number">29</span> <span class="number">12</span><span class="string">:01:22</span> <span class="number">2018</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                        <span class="string">STATE</span>     <span class="string">READ</span> <span class="string">WRITE</span> <span class="string">CKSUM</span></span><br><span class="line"><span class="string">ost_85</span>                      <span class="string">DEGRADED</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">  <span class="string">raidz3-0</span>                  <span class="string">DEGRADED</span>     <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">sddd</span>                    <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">sdde</span>                    <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">sddf</span>                    <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">sddg</span>                    <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">sddh</span>                    <span class="string">OFFLINE</span>      <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">sddi</span>                    <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670b2a3</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670cadb</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670cb6f</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670ae37</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670bdb3</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670b0db</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500956f033b</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a675adef</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a65b3f6b</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a663b6b7</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670b6a3</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a65a83d3</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a670b0eb</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a66ce193</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a6754c87</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">scsi-35000c500a6754373</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">errors:</span> <span class="literal">No</span> <span class="string">known</span> <span class="string">data</span> <span class="string">errors</span></span><br><span class="line"><span class="string">$</span> <span class="string">zpool</span> <span class="string">replace</span> <span class="string">ost_85</span> <span class="string">sddh</span></span><br></pre></td></tr></table></figure><h4 id="Online-upgrade-SAS-HDD-firmware"><a href="#Online-upgrade-SAS-HDD-firmware" class="headerlink" title="Online upgrade SAS HDD firmware"></a>Online upgrade SAS HDD firmware</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">$ zpool status -x</span><br><span class="line">  pool: tank</span><br><span class="line"> state: ONLINE</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line"><span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Sat Apr  6 11:14:31 2019</span><br><span class="line">56.6T scanned out of 143T at 131M/s, 192h27m to go</span><br><span class="line">3.14T resilvered, 39.52% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">NAME                        STATE     READ WRITE CKSUM</span><br><span class="line">tank                       ONLINE       0     0     0</span><br><span class="line">  raidz3-0                  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a675430f  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a6753f3f  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a6754a27  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a670c9f3  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a65b51eb  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a6755097  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a65b327f  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a675682f  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a67547f3  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a670cb23  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a670c7cf  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a67555db  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a670c717  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a65aa78f  ONLINE       0     0     0</span><br><span class="line">    sdfm                    ONLINE       0     0     0  (resilvering)</span><br><span class="line">    scsi-35000c500a675494f  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a65af82f  ONLINE       0     0     0</span><br><span class="line">    scsi-35000c500a6753f4b  ONLINE       0     0     0</span><br><span class="line"></span><br><span class="line">errors: No known data errors</span><br><span class="line"></span><br><span class="line">$ lsscsi -gi | grep sdfm</span><br><span class="line">[17:0:177:0] disk    SEAGATE  ST10000NM0256    TT54  /dev/sdfm  35000c500a73fd773  /dev/sg179</span><br><span class="line">   h == hostadapter id (first one being 0)</span><br><span class="line">   c == SCSI channel on hostadapter (first one being 0)</span><br><span class="line">   t == ID</span><br><span class="line">   l == LUN (first one being 0)</span><br><span class="line"></span><br><span class="line">$ shmcli list drives | grep sg179</span><br><span class="line">     5000c500a73fd770 /dev/sg179                SEAGATE                            ST10000NM0256            ZA29YQKE     TT54      8.91TB          50050cc11ac01694 (EN-8435A-E6EBD)  TH0YF87JSGT008AN006SA00</span><br><span class="line"></span><br><span class="line">$ shmcli info drive -d = 5000c500a73fd770</span><br><span class="line"></span><br><span class="line">info drive - Executing <span class="built_in">command</span>..</span><br><span class="line"></span><br><span class="line">Product Information :</span><br><span class="line">ProductId: ST10000NM0256</span><br><span class="line">Slot Number: 1</span><br><span class="line">Vendor: SEAGATE</span><br><span class="line">Size: 19134414847</span><br><span class="line">Serial: ZA29YQKE</span><br><span class="line">OS Path: /dev/sg179</span><br><span class="line">Date: 2018</span><br><span class="line">Primary Port WWN: 5000c500a73fd770</span><br><span class="line">Secondary Port WWN: 5000c500a73fd772</span><br><span class="line">Port SAS Addresses: 5000c500a73fd772, 0000000000000000</span><br><span class="line">Drive Supported: YES</span><br><span class="line">Rev: TT54</span><br><span class="line">Blinking?: NO</span><br><span class="line">Nominal Form Factor Height: 2540</span><br><span class="line">Nominal Form Factor Width: 3500</span><br><span class="line"></span><br><span class="line">Predicted Failure: NO</span><br><span class="line"></span><br><span class="line">Logical Volume Info: n.a.,n.a. ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Logical Drives Count: 0</span><br><span class="line"></span><br><span class="line">Device Speed Information :</span><br><span class="line">Link Speed (Primary): 6G</span><br><span class="line">Link Speed (Secondary): 6G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Enclosure Page 2 :</span><br><span class="line">Slot Status: OK</span><br><span class="line">ENCL BYPED A: OFF</span><br><span class="line">ENCL BYPED B: OFF</span><br><span class="line">IDENT: OFF</span><br><span class="line">FAULT REQSTED: OFF</span><br><span class="line">DEVICE OFF: OFF</span><br><span class="line">ENABLE BYP A: OFF</span><br><span class="line">ENABLE BYP A: OFF</span><br><span class="line">ENABLE BYP A: OFF</span><br><span class="line">BYP A ENABLE: OFF</span><br><span class="line">BYP B ENABLE: OFF</span><br><span class="line"></span><br><span class="line">info drive - Command execution complete.</span><br><span class="line"></span><br><span class="line">$ zpool offline tank sdfm</span><br><span class="line">$ shmcli update drive -d = 5000c500a73fd770 -file = ./Seagate_Tatsu_TT55.fwh</span><br><span class="line"></span><br><span class="line">update drive - Executing <span class="built_in">command</span>..</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA29YQKE) - File firmware version = TT55</span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA29YQKE) - Current drive firmware version = TT54</span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA29YQKE) - Sending firmware file to device.</span><br><span class="line">        (SEAGATE / ST10000NM0256 / ZA29YQKE) - Firmware successfully sent to drive.</span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA29YQKE) - After update drive firmware version = TT55</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Drive Update Statistics:</span><br><span class="line">Total Drives Attempted : 1</span><br><span class="line">Successful Drive update count : 1</span><br><span class="line">FW File transfer failures : 0</span><br><span class="line">FW Update failures despite successful FW file transfer   : 0</span><br><span class="line">Unsupported Drive count (Non-Dell Drives) : 0</span><br><span class="line">Drives Incompatible with Firmware File : 0</span><br><span class="line">Drives skipped because drive is same version : 0</span><br><span class="line">Drives skipped because drive is newer version : 0</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/block/sdfm/device/delete</span><br><span class="line"></span><br><span class="line">$ lspci | grep 3008</span><br><span class="line">b3:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span><br><span class="line"></span><br><span class="line">$ ll /sys/class/scsi_host/ | grep b3</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 11 17:01 host17 -&gt; ../../devices/pci0000:b2/0000:b2:00.0/0000:b3:00.0/host17/scsi_host/host17</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 0 177 0  &gt; /sys/class/scsi_host/host17/scan</span><br><span class="line"></span><br><span class="line">$ dmesg -T | tail</span><br><span class="line">[Thu Apr 11 15:24:32 2019] scsi 17:0:177:0: qdepth(254), tagged(1), simple(0), ordered(0), scsi_level(7), cmd_que(1)</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: Attached scsi generic sg179 <span class="built_in">type</span> 0</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: [sdfm] Enabling DIF Type 2 protection</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: [sdfm] 19134414848 512-byte logical blocks: (9.79 TB/8.91 TiB)</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: [sdfm] 4096-byte physical blocks</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: [sdfm] Write Protect is off</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: [sdfm] Mode Sense: d7 00 10 08</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: [sdfm] Write cache: enabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">[Thu Apr 11 15:24:32 2019]  sdfm: sdfm1 sdfm9</span><br><span class="line">[Thu Apr 11 15:24:32 2019] sd 17:0:177:0: [sdfm] Attached SCSI disk</span><br><span class="line">$ zpool online tank sdfm</span><br></pre></td></tr></table></figure><p><a href="https://topics-cdn.dell.com/pdf/software-tools_Administrator-Guide_en-us.pdf">reference</a></p><h3 id="Dell-EMC-OpenManage-Linux-Remote-Access-Utilities-v9-1-2"><a href="#Dell-EMC-OpenManage-Linux-Remote-Access-Utilities-v9-1-2" class="headerlink" title="Dell EMC OpenManage Linux Remote Access Utilities, v9.1.2"></a><a href="https://www.dell.com/support/home/us/en/04/drivers/driversdetails?driverid=f20vm">Dell EMC OpenManage Linux Remote Access Utilities, v9.1.2</a></h3><p><a href="https://downloads.dell.com/FOLDER05025571M/1/OM-MgmtStat-Dell-Web-LX-9.1.2-2965_A00.tar.gz?uid=38b7ca51-c5a7-476d-355c-5cbbbc9fa1e0&fn=OM-MgmtStat-Dell-Web-LX-9.1.2-2965_A00.tar.gz">Download</a></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">racadm supportassist accepteula</span><br><span class="line">racadm techsupreport collect -t SysInfo,TTYLog</span><br><span class="line">racadm techsupreport <span class="builtin-name">export</span> -f dell_tsr.zip</span><br><span class="line">SupportAssist collection exported successfully.</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable hyper threading</span></span><br><span class="line">$ racadm <span class="builtin-name">set</span> BIOS.ProcSettings.LogicalProc Disabled</span><br><span class="line">racadm <span class="builtin-name">get</span> BIOS.ProcSettings.LogicalProc</span><br><span class="line">[<span class="attribute">Key</span>=BIOS.Setup.1-1#ProcSettings]</span><br><span class="line"><span class="attribute">LogicalProc</span>=Enabled (Pending <span class="attribute">Value</span>=Disabled)</span><br><span class="line"></span><br><span class="line">$ racadm <span class="builtin-name">get</span> BIOS.ProcSettings.LogicalProc</span><br><span class="line">$ racadm jobqueue create BIOS.Setup.1-1 -r pwrcycle -s TIME_NOW -e TIME_NA</span><br><span class="line"><span class="built_in">..</span>.power cycle<span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line">$ racadm <span class="builtin-name">get</span> BIOS.ProcSettings.LogicalProc</span><br></pre></td></tr></table></figure><h4 id="upgrade-EMM-firmware"><a href="#upgrade-EMM-firmware" class="headerlink" title="upgrade EMM firmware"></a>upgrade EMM firmware</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ shmcli update emm -a = 0 -enc = 1 -emm = 1 -file = emm_canister_local_combined_non_disruptive_r2020.03.8.gff   </span><br><span class="line">-a  SAS Adapter index num</span><br><span class="line">-enc enclosure index num</span><br><span class="line">-emm EMM slot num</span><br></pre></td></tr></table></figure><p><a href="https://www.dell.com/support/manuals/us/en/04/integrated-dell-remote-access-cntrllr-8-with-lifecycle-controller-v2.00.00.00/racadm_idrac_pub-v1/techsupreport?guid=guid-6a1a7b81-683b-4e54-8ed7-b5d779213d07&lang=en-us">reference</a></p>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dell </tag>
            
            <tag> smcli </tag>
            
            <tag> racadm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kvm_tips</title>
      <link href="2017/03/09/kvm-command/"/>
      <url>2017/03/09/kvm-command/</url>
      
        <content type="html"><![CDATA[<h3 id="Two-guest-share-a-storage-device"><a href="#Two-guest-share-a-storage-device" class="headerlink" title="Two guest share a storage device"></a>Two guest share a storage device</h3><p>Qcow2 not support, raw is ok</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=share-storage.raw bs=1M count=0 seek=<span class="variable">$the_size</span></span><br><span class="line">bus=scsi</span><br><span class="line">cache=writethrough</span><br><span class="line"></span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span> cache=<span class="string">&#x27;writethrough&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/tank/test0.raw&#x27;</span>/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;sda&#x27;</span> bus=<span class="string">&#x27;scsi&#x27;</span>/&gt;</span><br><span class="line">      &lt;shareable/&gt;</span><br><span class="line">      &lt;serial&gt;0001&lt;/serial&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;drive&#x27;</span> controller=<span class="string">&#x27;0&#x27;</span> bus=<span class="string">&#x27;0&#x27;</span> target=<span class="string">&#x27;0&#x27;</span> unit=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span> cache=<span class="string">&#x27;writethrough&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/tank/test1.raw&#x27;</span>/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;sdb&#x27;</span> bus=<span class="string">&#x27;scsi&#x27;</span>/&gt;</span><br><span class="line">      &lt;shareable/&gt;</span><br><span class="line">      &lt;serial&gt;0002&lt;/serial&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;drive&#x27;</span> controller=<span class="string">&#x27;0&#x27;</span> bus=<span class="string">&#x27;0&#x27;</span> target=<span class="string">&#x27;0&#x27;</span> unit=<span class="string">&#x27;1&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">### Install</span></span><br><span class="line">```bash</span><br><span class="line">yum -y install qemu-kvm libvirt virt-install bridge-utils</span><br></pre></td></tr></table></figure><h3 id="KVM-Multipath"><a href="#KVM-Multipath" class="headerlink" title="KVM Multipath"></a>KVM Multipath</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/kvm/fileA.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;sda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;scsi&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">serial</span>&gt;</span>0002<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/kvm/fileA.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;sdb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;scsi&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">serial</span>&gt;</span>0002<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;drive&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">target</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Snapshot"><a href="#Snapshot" class="headerlink" title="Snapshot"></a>Snapshot</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list</span></span><br><span class="line">qemu-img snapshot -l /kvm/fileA.qcow2</span><br><span class="line">ID ...</span><br><span class="line">1 ...  </span><br><span class="line"></span><br><span class="line"><span class="comment"># create</span></span><br><span class="line">qemu-img snapshot -c first /kvm/fileA.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">qemu-img snapshot -a 1 /kvm/fileA.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Delete</span></span><br><span class="line">qemu-img snapshot -d 1 /kvm/fileA.qcow2</span><br></pre></td></tr></table></figure><h3 id="Create-convert-base-image"><a href="#Create-convert-base-image" class="headerlink" title="Create convert base image"></a>Create convert base image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qed vm1.qed 80G</span><br><span class="line">qemu-img convert -f vmdk -O raw centos7.vmdk centos7.img</span><br><span class="line"><span class="comment">#Base images</span></span><br><span class="line">qemu-img create -b centos6-base.qed -f  qed  centos6-tmp.qed</span><br><span class="line">qemu-img rebase  -u -b centos-6.qed ./kvm1.qed</span><br></pre></td></tr></table></figure><h3 id="Virt-manager-show-unreadable-code"><a href="#Virt-manager-show-unreadable-code" class="headerlink" title="Virt-manager show unreadable code"></a>Virt-manager show unreadable code</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install dejavu-sans-fonts</span><br><span class="line"><span class="comment"># if you need Chinese</span></span><br><span class="line">yum -y install ghostscript-chinese-zh_CN</span><br></pre></td></tr></table></figure><h3 id="NIC-performance"><a href="#NIC-performance" class="headerlink" title="NIC performance"></a>NIC performance</h3><p>If intel_iommu=on or amd_iommu=on works, you can try replacing them with iommu=pt or amd_iommu=pt. The pt option only enables IOMMU for devices used in passthrough and will provide better host performance. However, the option may not be supported on all hardware. Revert to previous option if the pt option doesnt work for your host.<br>If the passthrough fails because the hardware does not support interrupt remapping, you can consider enabling the allow_unsafe_interrupts option if the virtual machines are trusted. The allow_unsafe_interrupts is not enabled by default because enabling it potentially exposes the host to MSI attacks from virtual machines. To enable the option:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;intel_iommu=pt&#x27;</span></span><br><span class="line">$ vi /etc/modprobe.d</span><br><span class="line">options vfio_iommu_type1 allow_unsafe_interrupts=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># mellanox driver sr-iov</span></span><br><span class="line">options mlx4_core port_type_array=2,2 num_vfs=2 probe_vf=0 enable_64b_cqe_eqe=0  log_num_mgm_entry_size=-1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Virtualization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCP</title>
      <link href="2017/01/08/tcp/"/>
      <url>2017/01/08/tcp/</url>
      
        <content type="html"><![CDATA[<p><a href="/img/Tcp_state_diagram.png"></a></p><h4 id="TCP-timer"><a href="#TCP-timer" class="headerlink" title="TCP timer"></a><a href="http://blog.qiusuo.im/blog/2014/03/19/tcp-timeout/">TCP timer</a></h4><h5 id="RTT-three-types"><a href="#RTT-three-types" class="headerlink" title="RTT three types"></a><a href="https://www.geeksforgeeks.org/tcp-timers/">RTT three types</a></h5><p>Measured RTT(RTTm)  The measured round-trip time for a segment is the time required for the segment to reach the destination and be acknowledged, although the acknowledgment may include other segments.</p><p>Smoothed RTT(RTTs)  It is the weighted average of RTTm. RTTm is likely to change and its fluctuation is so high that a single measurement cannot be used to calculate RTO.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Initially -&gt; No value</span><br><span class="line">After the first measurement -&gt; RTTs=RTTm</span><br><span class="line">After each measurement -&gt; RTTs= (1-t)*RTTs + t*RTTm</span><br><span class="line">Note: t=1/8 (default <span class="keyword">if</span> not given)</span><br></pre></td></tr></table></figure><p>Deviated RTT(RTTd)  Most implementation do not use RTTs alone so RTT deviated is also calculated to find out RTO.</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Initially</span> -&gt; <span class="keyword">No</span> <span class="keyword">value</span></span><br><span class="line"><span class="keyword">After</span> the first measurement -&gt; RTTd=RTTm/<span class="number">2</span></span><br><span class="line"><span class="keyword">After</span> <span class="keyword">each</span> measurement -&gt; RTTd= (<span class="number">1</span>-k)*RTTd + k*(RTTm-RTTs)</span><br><span class="line">Note: k=<span class="number">1</span>/<span class="number">4</span> (<span class="keyword">default</span> <span class="keyword">if</span> <span class="keyword">not</span> given)</span><br></pre></td></tr></table></figure><h5 id="Retransmission-Timeout"><a href="#Retransmission-Timeout" class="headerlink" title="Retransmission Timeout"></a>Retransmission Timeout</h5><p>RTO calculation  The value of RTO is based on the smoothed round-trip time and its deviation. Most implementations use the following formula to calculate the RTO:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Initial value -&gt; Original (given <span class="keyword">in</span> question)</span><br><span class="line">After any measurement -&gt; <span class="attribute">RTO</span>=RTTs + 4*RTTd</span><br><span class="line"><span class="comment">#<span class="doctag">NOTE:</span> At every retransmission the value of RTO doubles. ( RTO(new) = RTO(before retransmission) *2 ) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## in linux</span></span><br><span class="line">tcp_retries1 (integer; default: 3; since Linux 2.2)</span><br><span class="line"></span><br><span class="line">The number of times TCP will attempt <span class="keyword">to</span> retransmit a packet on an established<span class="built_in"> connection </span>normally, without the extra effort of getting the<span class="built_in"> network </span>layers involved. Once we exceed this number of retransmits, we first have the<span class="built_in"> network </span>layer update the<span class="built_in"> route </span><span class="keyword">if</span> possible before each new retransmit. The<span class="built_in"> default </span>is the RFC specified minimum of 3.</span><br><span class="line"></span><br><span class="line">tcp_retries2 (integer; default: 15; since Linux 2.2)</span><br><span class="line"></span><br><span class="line">The maximum number of times a TCP packet is retransmitted <span class="keyword">in</span> established state before giving up. The<span class="built_in"> default </span>value is 15, which corresponds <span class="keyword">to</span> a duration of approximately between 13 <span class="keyword">to</span> 30 minutes, depending on the retransmission timeout. The RFC 1122 specified minimum limit of 100 seconds is typically deemed too short.</span><br></pre></td></tr></table></figure><h5 id="Delayed-ACK-Timer"><a href="#Delayed-ACK-Timer" class="headerlink" title="Delayed ACK Timer"></a>Delayed ACK Timer</h5><p>If reach the timeout, reply the ACK, if in the timeout range, it will wait data to transmit, 200 ms in Microsoft Windows by default</p><p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/reducing_the_tcp_delayed_ack_timeout">In real time system</a></p><ul><li>This mode is used at the start of a TCP connection so that the congestion window can grow quickly.</li><li>The acknowledgment (ACK) timeout interval (ATO) is set to tcp_ato_min, the minimum timeout value.</li><li>To change the default TCP ACK timeout value, write the required value in milliseconds to the /proc/sys/net/ipv4/tcp_ato_min file<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo <span class="number">4</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4/tcp_ato_min</span><br></pre></td></tr></table></figure></li></ul><p>Delayed ACK</p><ul><li>After the connection is established, TCP assumes this mode, in which ACKs for multiple received packets can be sent in a single packet.</li><li>ATO is set to tcp_delack_min to restart or reset the timer.</li><li>To change the default TCP Delayed ACK value, write the required value in milliseconds to the /proc/sys/net/ipv4/tcp_delack_min file:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 4 &gt; /proc/sys/net/ipv4/tcp_delack_min</span><br></pre></td></tr></table></figure>TCP switches between the two modes depending on the current congestion.<br>Some applications that send small network packets could experience latencies due to the TCP quick and delayed acknowledgment timeouts, which previously were 40 ms by default. That means small packets from an application that seldom sends information through the network could experience a delay up to 40 ms to receive the acknowledgment that a packet has been received by the other side. To minimize this issue, both tcp_ato_min and tcp_delack_min timeouts are now 4 ms by default.</li></ul><h5 id="Persist-Timer"><a href="#Persist-Timer" class="headerlink" title="Persist Timer"></a>Persist Timer</h5><p>When receive the zero window, stop to transmit data.<br>In tcp, just confirm data package, it s not confirm the ack (no data) package. if the B transmit the ack(no data) loss, the B is waitting to get some data from A(the ack loss, and it tell A that it s not the zero window ),but the A is waitting the data for update window size from B. It s the deadlock case.<br>When the A receive the zero window notice, the A will start a persist timer to send the ack in the time interval. the segment to detect TCP Zero Window</p><p>The RFC1122 suggest the window probe timer is RTO</p><h5 id="Keepalive-Timer"><a href="#Keepalive-Timer" class="headerlink" title="Keepalive Timer"></a>Keepalive Timer</h5><p>In the tcp_keepalive_intvl, the server will send the Probe Segment to make sure the other side is online ? if no respond, it will resend until timeout, if timeout that means the other side has crash.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tcp_keepalive_intvl (<span class="built_in">integer</span>; default: 75; since Linux 2.4)</span><br><span class="line">The number of seconds between TCP keep-alive probes.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_probes (<span class="built_in">integer</span>; default: 9; since Linux 2.2)</span><br><span class="line">The maximum number of TCP keep-alive probes to send before giving up and killing the connection <span class="keyword">if</span> no response is obtained from the other end.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_time (<span class="built_in">integer</span>; default: 7200; since Linux 2.2)</span><br><span class="line">The number of seconds a connection needs to be idle before TCP begins sending out keep-alive probes. Keep-alives are only sent when the SO_KEEPALIVE socket option is enabled. The default value is 7200 seconds (2 hours). An idle connection is terminated after approximately an additional 11 minutes (9 probes an interval of 75 seconds apart) when keep-alive is enabled.</span><br></pre></td></tr></table></figure><h5 id="FIN-WAIT-2-Timer"><a href="#FIN-WAIT-2-Timer" class="headerlink" title="FIN_WAIT_2 Timer"></a>FIN_WAIT_2 Timer</h5><p>The activer try to disable the tcp connection, send the FIN and get the ACK, the activer to convert the FIN_WAIT_1 to FIN_WAIT_2 and it could not send any data, just wait the FIN from the client. if the client down or dont send the FIN to the activer, same with Dos attack.<br>If timeout, give up the tcp connection.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcp_fin_timeout (<span class="built_in">integer</span>; default: 60; since Linux 2.2)</span><br><span class="line">This specifies how many seconds to <span class="built_in">wait</span> <span class="keyword">for</span> a final FIN packet before the socket is forcibly closed. This is strictly a violation of the TCP specification, but required to prevent denial-of-service attacks. In Linux 2.2, the default value was 180.</span><br></pre></td></tr></table></figure><h5 id="TIME-WAIT-Timer"><a href="#TIME-WAIT-Timer" class="headerlink" title="TIME_WAIT Timer"></a>TIME_WAIT Timer</h5><p>timeout = 2xMSL<br>Linux was net.ipv4.tcp_fin_timeout = 60</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCP_TIMEWAIT_LEN (60*HZ) <span class="comment">/* how long to wait to destroy TIME-WAIT</span></span></span><br><span class="line"><span class="meta"><span class="comment">                              * state, about 60 seconds     */</span></span></span><br></pre></td></tr></table></figure><p>the server(FIN_WAIT_2) receive the FIN from the client, after the server reply the ACK,the server will convert FIN_WAIT_2 to TIME_WAIT and start the TIME_WAIT timer<br>and the ack loss, when the client will retrans the FIN to the server. </p><ol><li><p>if the server not in TIME_WAIT, if the port re-use for another application, maybe the application will go to the wrong state. if the connection in the TIME_WAIT state, it s OK.<br>So the TIME_WAIT must be a long time enough, to avoid the wandering duplicates</p></li><li><p>because the ack package loss, if the activer has disable the A tcp connection, the client is waitting the ack. if the activer want create a new tcp connection to use the same port, the activer will send the SYN packet, the client is waitting the ack, the client will reply the RST cause the new connection interrupt </p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">When the persist timer expires, 1 byte of data is sent(segment 6). The receiving application has <span class="built_in">read</span> 256 bytes from the receivebuffer (at time 3.99), so the byte is accepted and acknowledged (segment 7).But the advertised window is still 0, since the receiver does not have room foreither one full-sized segment or one-half of its buffer. This is silly windowavoidance by the receiver.</span><br><span class="line"></span><br><span class="line">tcp_rcv_state_process</span><br><span class="line">    |--&gt;tcp_time_wait</span><br><span class="line">           |--&gt;inet_twsk_alloc</span><br><span class="line">           |      |--&gt;setup_pinned_timer(&amp;tw-&gt;tw_timer, tw_timer_handler,(unsigned long)tw);</span><br><span class="line">           |--&gt;__inet_twsk_schedule(tw, timeo, <span class="literal">false</span>);</span><br><span class="line">                  |--&gt;mod_timer(&amp;tw-&gt;tw_timer, jiffies + timeo);</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"><span class="comment"># TIME_WAIT port use the new tcp connection</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line"><span class="comment"># In some NAT/loading balancing env cause DROP the SYN packet and reply the RST</span></span><br><span class="line"><span class="comment"># remove from linux kernel 4.10</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_fin_timeout = 60</span><br><span class="line">net.ipv4.ip_local_port_range = 32768 60999</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000</span><br><span class="line"><span class="comment"># TIME_WAIT socket max number</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line"><span class="comment">##### MSL (Maximum Segment Lifetime)</span></span><br><span class="line">2MSL server/client send the close request <span class="keyword">in</span> the last ack(time <span class="built_in">wait</span> status), timewait = 2MSL ? after timeout ,send fin ? <span class="keyword">in</span> this time, the port could not be used.</span><br><span class="line"><span class="keyword">if</span> you <span class="built_in">set</span> SO_REUSEPORT, don <span class="string">&#x27;t to wait 2MSL to use the port </span></span><br><span class="line"><span class="string">        SO_REUSEPORT (since Linux 3.9)</span></span><br><span class="line"><span class="string">        Permits multiple AF_INET or AF_INET6 sockets to be bound to an identical socket address.  This option must be set on each socket (including the first socket) prior to calling bind(2) on the socket.  To prevent port hijacking, all of the processes binding to the same address must have the same effective UID.  This option can be employed with both TCP an UDP sockets.</span></span><br><span class="line"><span class="string">        the SO_REUSEPORT socket option support was implemented in a series of patches by Tom Herbert. The new socket option allows multiple sockets on the same host to bind to the same port, and is intended to improve the performance of multithreaded network server applications running on top of multicore systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tcp segment () + tcp datagram (data)</span></span><br><span class="line"><span class="string">TTL (time to live) in ip head</span></span><br><span class="line"><span class="string">MSL &gt; TTL ?</span></span><br><span class="line"><span class="string">RTT (round-trip time)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">URG: Urget pointer is valid</span></span><br><span class="line"><span class="string">SYN: </span></span><br><span class="line"><span class="string">FIN: </span></span><br><span class="line"><span class="string">ACK:</span></span><br><span class="line"><span class="string">PSH:</span></span><br><span class="line"><span class="string">RST:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RST+ACK</span></span><br><span class="line"><span class="string">only RST</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">packets per second (pps)</span></span><br><span class="line"><span class="string">bytes per second (bps)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;!-- more --&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### [tcp_fin_timeout and tcp_max_tw_buckets](https://access.redhat.com/solutions/41776)</span></span><br><span class="line"><span class="string">If you set too large value to tcp_fin_timeout, the system may become out of port, file-descripter and memory. If you set too small value, the system may leak delayed packets.</span></span><br><span class="line"><span class="string">If you set too large value to tcp_max_tw_buckets, the system may become out of port, file-descripter and memory. If you set too small value, the system may not communicate another host.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TCP(7)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       tcp_fin_timeout (integer; default: 60)</span></span><br><span class="line"><span class="string">              This  specifies  how many seconds to wait for a final FIN packet</span></span><br><span class="line"><span class="string">              before the socket is forcibly closed.  This is strictly a viola-</span></span><br><span class="line"><span class="string">              tion  of  the TCP specification, but required to prevent denial-</span></span><br><span class="line"><span class="string">              of-service attacks.  In Linux 2.2, the default value was 180.</span></span><br><span class="line"><span class="string">&lt;snip&gt;</span></span><br><span class="line"><span class="string">       tcp_max_tw_buckets (integer; default: see below)</span></span><br><span class="line"><span class="string">              The  maximum number of sockets in TIME_WAIT state allowed in the</span></span><br><span class="line"><span class="string">              system.  This limit exists only to prevent simple denial-of-ser-</span></span><br><span class="line"><span class="string">              vice  attacks.   The  default  value  of  NR_FILE*2  is adjusted</span></span><br><span class="line"><span class="string">              depending on the memory  in  the  system.   If  this  number  is</span></span><br><span class="line"><span class="string">              exceeded, the socket is closed and a warning is printed.</span></span><br><span class="line"><span class="string">&lt;snip&gt;</span></span><br><span class="line"><span class="string">       TCP_LINGER2</span></span><br><span class="line"><span class="string">              The  lifetime  of orphaned FIN_WAIT2 state sockets.  This option</span></span><br><span class="line"><span class="string">              can be used to override the system wide  sysctl  tcp_fin_timeout</span></span><br><span class="line"><span class="string">              on  this  socket.  This is not to be confused with the socket(7)</span></span><br><span class="line"><span class="string">              level option SO_LINGER.  This option should not be used in  code</span></span><br><span class="line"><span class="string">              intended to be portable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### tcpdump</span></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="string">tcpdump -n -i eth0 -A -x dst port 443 and greater 100</span></span><br></pre></td></tr></table></figure><h3 id="Linux-kernel"><a href="#Linux-kernel" class="headerlink" title="Linux kernel"></a>Linux kernel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">don<span class="string">&#x27;t cache ssthresh from previous connection</span></span><br><span class="line"><span class="string">Disable cache metrics so the initial conditions of the closed connections will not be saved to be used in near future connections:</span></span><br><span class="line"><span class="string">net.ipv4.tcp_no_metrics_save = 1</span></span><br><span class="line"><span class="string">&#x27;</span>1<span class="string">&#x27; means disable caching.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tcp_slow_start_after_idle = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">tcp_slow_start_after_idle (Boolean; default: enabled(1); since Linux 2.6.18),If enabled, provide RFC 2861 behavior and time out the congestion window after an idle period. An idle period is defined as the current RTO (retransmission timeout). If disabled, the congestion window will not be timed out after an idle period.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># Vendors settings live in /usr/lib/sysctl.d/.</span></span><br><span class="line"><span class="string"># To override a whole file, create a new file with the same in</span></span><br><span class="line"><span class="string"># /etc/sysctl.d/ and put new settings there. To override</span></span><br><span class="line"><span class="string"># only specific settings, add a file with a lexically later</span></span><br><span class="line"><span class="string"># name in /etc/sysctl.d/ and put new settings there.</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># For more information, see sysctl.conf(5) and sysctl.d(5).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># each socket will use some fd</span></span><br><span class="line"><span class="string">fs.file-max = 1048576 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># tcp short connection will cause a lot of TIME_WAIT</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 7000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># disable tcp source trace</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.accept_source_route = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 30 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#TIMEOUT socket re-use</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse= 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_timestamps = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 8388608</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 8388608</span></span><br><span class="line"><span class="string">net.core.somaxconn = 8388608</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># in our internal LAN, a lots of out of range and tcp retrans</span></span><br><span class="line"><span class="string">net.ipv4.tcp_sack = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.core.netdev_budget=600</span></span><br><span class="line"><span class="string">net.ipv4.tcp_low_latency = 1</span></span><br><span class="line"><span class="string"># socket buffer to 256MB</span></span><br><span class="line"><span class="string">net.core.rmem_max = 268435456</span></span><br><span class="line"><span class="string">net.core.wmem_max = 268435456</span></span><br><span class="line"><span class="string"># allow tcp ipv4 buffer auto-tuning up to 256MB</span></span><br><span class="line"><span class="string"># min,init,maxinum size</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 65536 134217728 268435456</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 65536 134217728 268435456</span></span><br><span class="line"><span class="string">net.ipv4.tcp_mem = 65536 134217728 268435456</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_adv_win_scale= 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_window_scaling = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.ipv4.tcp_mtu_probing= 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.core.default_qdisc = pfifo_fast</span></span><br><span class="line"><span class="string">net.ipv4.tcp_congestion_control = cubic</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kernel.numa_balancing=0</span></span><br><span class="line"><span class="string">net.ipv4.tcp_frto=1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_no_metrics_save = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_slow_start_after_idle = 0</span></span><br><span class="line"><span class="string">net.ipv4.tcp_mtu_probing = 1</span></span><br><span class="line"><span class="string">#net.ipv4.tcp_syn_retries = 8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># works best with &gt;= 500 client computers ##</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_interval = 3600</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_stale_time = 3600</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 8192</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 2048</span></span><br><span class="line"><span class="string"># Keep alive</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 60</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 7200</span></span><br><span class="line"><span class="string">#net.ipv4.tcp_syn_retries=8</span></span><br><span class="line"><span class="string">##net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">###net.ipv4.tcp_keepalive_probes = 25</span></span><br><span class="line"><span class="string">###net.ipv4.tcp_keepalive_time = 360</span></span><br></pre></td></tr></table></figure><h4 id="tcp-tw-reuse"><a href="#tcp-tw-reuse" class="headerlink" title="tcp_tw_reuse"></a><a href="https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux">tcp_tw_reuse</a></h4><p>NOTE: net.ipv4.tcp_tw_recycle has been removed from Linux4.12<br>Linux will randomize timestamp offsets for each connection, making this option completely broken, with or without NAT. It has been completely removed from Linux4.12.<br>The LAST-ACK state is handled in the exact same way as for net.ipv4.tcp_tw_recycle.</p><p>By enabling net.ipv4.tcp_tw_reuse, Linux will reuse an existing connection in the TIME-WAIT state for a new outgoing connection if the new timestamp is strictly bigger than the most recent timestamp recorded for the previous connection: an outgoing connection in the TIME-WAIT state can be reused after just one second.</p><p>   Allow to reuse TIME-WAIT sockets for new connections when it is safe from protocol viewpoint. Default value is 0. It should not be changed without advice/request of technical experts.<br>   The mere result of this lack of documentation is that we find numerous tuning guides advising to set both these settings to 1 to reduce the number of entries in the TIME-WAIT state. However, as stated by tcp(7) manual page, the net.ipv4.tcp_tw_recycle option is quite problematic for public-facing servers as it wont handle connections from two different computers behind the same NAT device, which is a problem hard to detect and waiting to bite you:<br>   Enable fast recycling of TIME-WAIT sockets. Enabling this option is not recommended since this causes problems when working with NAT (Network Address Translation).<br><img src="/img/tcp-state-diagram-v2.svg"></p><p><img src="/img/duplicate-segment.svg"><br>Due to a shortened TIME-WAIT state, a delayed TCP segment has been accepted in an unrelated connection.</p><p>The other purpose is to ensure the remote end has closed the connection. When the last ACK is lost, the remote end stays in the LAST-ACK state. Without the TIME-WAIT state, a connection could be reopened while the remote end still thinks the previous connection is valid. When it receives a SYN segment (and the sequence number matches), it will answer with a RST as it is not expecting such a segment. The new connection will be aborted with an error<br><img src="/img/last-ack.svg"><br>If the remote end stays in LAST-ACK state because the last ACK was lost, opening a new connection with the same quadruplet will not work.</p><p>RFC793 requires the TIME-WAIT state to last twice the time of the MSL. On Linux, this duration is not tunable and is defined in include/net/tcp.h as one minute:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define TCP_TIMEWAIT_LEN (60*HZ) /* how long to wait to destroy TIME-WAIT</span></span><br><span class="line">  * state, about 60 seconds*/</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ss -tan state time-wait</span><br></pre></td></tr></table></figure><p>A hash table of connections, named the TCP established hash table (despite containing connections in other states) is used to locate an existing connection, for example when receiving a new segment.</p><p>the TIME-WAIT connection in this table</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg | grep <span class="string">&quot;TCP established hash table&quot;</span></span><br><span class="line">[    1.041036] TCP established <span class="built_in">hash</span> table entries: 524288 (order: 10, 4194304 bytes)</span><br><span class="line">$ dmesg | grep <span class="string">&quot;TCP bind hash table&quot;</span></span><br><span class="line">[    1.041724] TCP <span class="built_in">bind</span> <span class="built_in">hash</span> table entries: 65536 (order: 8, 1048576 bytes)</span><br></pre></td></tr></table></figure><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slabtop -o | <span class="type">grep</span> -E &#x27;(^  OBJS|<span class="type">tw_sock_TCP</span>|<span class="type">tcp_bind_bucket</span>)&#x27;</span><br></pre></td></tr></table></figure><p>If the FIN segments are received in a timely manner, the local end socket will still be in the TIME-WAIT state and the expected ACK segments will be sent.</p><p>Once a new connection replaces the TIME-WAIT entry, the SYN segment of the new connection is ignored (thanks to the timestamps) and wont be answered by a RST but only by a retransmission of the FIN segment. The FIN segment will then be answered with a RST (because the local connection is in the SYN-SENT state) which will allow the transition out of the LAST-ACK state. The initial SYN segment will eventually be resent (after one second) because there was no answer and the connection will be established without apparent error, except a slight delay:<br><img src="/img/last-ack-reuse.svg"></p><h3 id="ethtool"><a href="#ethtool" class="headerlink" title="ethtool"></a><a href="https://voipmagazine.wordpress.com/tag/tcp_no_metrics_save/">ethtool</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -s p4p2 speed 1000 duplex full autoneg off</span><br><span class="line">$ grep ETHTOOL_OPTS /etc/sysconfig/network-scripts/ifcfg-p4p1</span><br><span class="line">ETHTOOL_OPTS=speed 1000 duplex full</span><br><span class="line">$ systemctl restart network</span><br><span class="line">$ ifconfig eth0 txqueuelen 3000 </span><br></pre></td></tr></table></figure><h3 id="SLE-and-SER-in-SACK-RFC2018"><a href="#SLE-and-SER-in-SACK-RFC2018" class="headerlink" title="SLE and SER in SACK(RFC2018)"></a>SLE and SER in SACK(RFC2018)</h3><p>tcpdump will show some packet show SLE=20480 SER=24576</p><p>SLE: Sequence Left Edge of already acknowledged data when Selective Acknowledgments are used<br>SRE: Sequence Right Edge of already acknowledged data when Selective Acknowledgments are used</p><p>When server send the package length from 1<del>24576, the client just return ack=$((seq+18736))<br>The client receive 18736 bytes, and recevice the out of order packets from 20480</del>24576 bytes, and just loss from 18737<del>20479 Bytes<br>The server don t need to retrans 20480 to 24576 bytes. if the system not enable sack, it will retrans from 18737</del>24576</p><h3 id="Spurious-retransmission-timeouts"><a href="#Spurious-retransmission-timeouts" class="headerlink" title="Spurious retransmission timeouts"></a>Spurious retransmission timeouts</h3><p>Because packets out of order or another issue trigger the packet RTO, but the packet was not loss, it s misjudging, that means Spurious retransmission timeouts.</p><p>Active F-RTO<br>net.ipv4.tcp_frto=2</p><h3 id="Thin-stream"><a href="#Thin-stream" class="headerlink" title="Thin-stream"></a><a href="https://nnc3.com/mags/LJ_1994-2014/LJ/219/11180.html">Thin-stream</a></h3><p>For latency env</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default eq 0</span></span><br><span class="line">sysctl -w net.ipv4.tcp_thin_linear_timeouts=1</span><br><span class="line">sysctl -w net.ipv4.tcp_thin_dupack=1</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /proc/sys/net/ipv4/tcp_thin_linear_timeouts</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /proc/sys/net/ipv4/tcp_thin_dupack</span><br></pre></td></tr></table></figure><h3 id="tcp-retrans"><a href="#tcp-retrans" class="headerlink" title="tcp retrans"></a><a href="http://perthcharles.github.io/2015/09/07/wiki-tcp-retries/">tcp retrans</a></h3><p>RTO(retransmission timeout)<br>RRT(round-trip time)<br>TCP keep the weight value SRTT(smoothed RRT)</p><p>The latest RRTS = (1-a) * ( last RTTS) + a * (the lastest RRT)<br>In RFC2988, a = 1/8<br>RTTD was the RTT deviation weight value<br>First get RTTD, RTTD value = RRT/2<br>Next the RTTD=(1-B)<em>(the last RTTD) + B(RTTS-the lastest RRT)<br>RFC B=1/4<br>RTO= RTTS + 4</em>RTTD<br>The RFC suggest if the message retrans, this RRT value will be drop<br>When the trigger tcp retrans, the latest RTO * 2 = the last RTO until the maximum</p><p>But RFC != the real implementation</p><p><a href="https://ms2008.github.io/2017/04/14/tcp-timeout/">tcp_syn_retries </a><br>net.ipv4.tcp_syn_retries retrans interval was [1,3,7,15,31]s </p><p>tcp_syn_retries2</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> tcp_retries2=<span class="number">15</span><span class="keyword">the</span> <span class="keyword">timeout</span> was <span class="number">924600</span>ms</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> If RTT <span class="keyword">is</span> tiny <span class="keyword">that</span> <span class="keyword">the</span> RTO init value was <span class="keyword">about</span> <span class="number">200</span>ms</span><br><span class="line">   The total <span class="keyword">timeout</span> was <span class="number">924600</span>mslooks like retrans <span class="number">15</span> <span class="keyword">times</span> cause <span class="keyword">over</span> <span class="keyword">the</span> <span class="keyword">timeout</span> value <span class="keyword">and</span> <span class="keyword">end</span> <span class="keyword">the</span> tcp stream</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> If RTT <span class="keyword">is</span> large,<span class="keyword">the</span> RTO calculate value was <span class="number">1000</span>ms</span><br><span class="line">   <span class="keyword">it</span> doesn&#x27; t need retrans <span class="number">15</span> <span class="keyword">times</span><span class="keyword">the</span> <span class="keyword">timeout</span> value will <span class="keyword">over</span> <span class="number">924600</span>ms.</span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">the</span> RTT=<span class="number">400</span>ms,<span class="keyword">set</span> tcp_retries2=<span class="number">10</span>, only <span class="number">3</span> <span class="keyword">times</span> <span class="keyword">the</span> tcp stream will <span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="tcp-retrans-1"><a href="#tcp-retrans-1" class="headerlink" title="tcp retrans"></a>tcp retrans</h3><p>There are 3 server in test env</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ numactl --physcpubind=2 iperf3 -c <span class="variable">$serverC</span> -P 1 -M 8960 -S 0x08 -t 36000 -p 5201 -l 512k</span><br><span class="line">Connecting to host 10.53.19.52, port 5201</span><br><span class="line">[  4] <span class="built_in">local</span> <span class="variable">$ServerB</span> port 58064 connected to <span class="variable">$ServerC</span> port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd</span><br><span class="line">[  4]   0.00-1.00   sec  1.15 GBytes  9.92 Gbits/sec    0    690 KBytes</span><br><span class="line">...</span><br><span class="line">[  4]  66.00-67.00  sec  1.15 GBytes  9.90 Gbits/sec    0    717 KBytes</span><br><span class="line">... always no retrans, cwnd increase slowly</span><br><span class="line">[  4] 189.00-190.00 sec  1.15 GBytes  9.89 Gbits/sec    0    725 KBytes</span><br><span class="line">...</span><br><span class="line">[  4] 418.00-419.00 sec  1.15 GBytes  9.89 Gbits/sec    0    909 KBytes</span><br><span class="line">...</span><br><span class="line">[  4] 4195.00-4196.00 sec  1.15 GBytes  9.90 Gbits/sec    0    909 KBytes</span><br><span class="line">[  4] 4196.00-4197.00 sec  1.15 GBytes  9.90 Gbits/sec    0    909 KBytes</span><br><span class="line">[  4] 4197.00-4198.00 sec  1.15 GBytes  9.89 Gbits/sec    0    909 KBytes</span><br><span class="line">[  4] 4198.00-4198.51 sec   606 MBytes  9.91 Gbits/sec    0    909 KBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-4198.51 sec  0.00 (null)s  9.90 Gbits/sec    6             sender</span><br><span class="line">[  4]   0.00-4198.51 sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line">iperf3: interrupt - the client has terminated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ numactl --physcpubind=2 iperf3 -c <span class="variable">$serverA</span> -P 1 -M 8960 -S 0x08 -t 36000 -p 5201 -l 512k</span><br><span class="line"></span><br><span class="line">[  4] 188.00-189.00 sec  1.15 GBytes  9.89 Gbits/sec   10   2.04 MBytes</span><br><span class="line">[  4] 189.00-190.00 sec  1.15 GBytes  9.87 Gbits/sec   14   1.97 MBytes</span><br><span class="line">[  4] 190.00-191.00 sec  1.15 GBytes  9.87 Gbits/sec   38   1.65 MBytes</span><br><span class="line">[  4] 191.00-192.00 sec  1.15 GBytes  9.89 Gbits/sec   18   1.59 MBytes</span><br><span class="line">[  4] 192.00-193.00 sec  1.15 GBytes  9.86 Gbits/sec   12   2.20 MBytes</span><br><span class="line">[  4] 193.00-194.00 sec  1.15 GBytes  9.90 Gbits/sec    8   2.01 MBytes</span><br><span class="line">[  4] 194.00-195.00 sec  1.15 GBytes  9.86 Gbits/sec    9   1.70 MBytes</span><br><span class="line">[  4] 195.00-196.00 sec  1.15 GBytes  9.87 Gbits/sec    8   2.26 MBytes</span><br><span class="line">[  4] 196.00-196.72 sec   851 MBytes  9.88 Gbits/sec    4   1.99 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-196.72 sec   226 GBytes  9.87 Gbits/sec  3776             sender</span><br><span class="line">[  4]   0.00-196.72 sec  0.00 Bytes  0.00 bits/sec                  receiver</span><br><span class="line">iperf3: interrupt - the client has terminated</span><br></pre></td></tr></table></figure><h4 id="Make-sure-retrans-type"><a href="#Make-sure-retrans-type" class="headerlink" title="Make sure retrans type"></a>Make sure retrans type</h4><p><a href="https://github.com/brendangregg/perf-tools">tcpretrans</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">$ nstat -rsz | grep -Ei <span class="string">&#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb&#x27;</span></span><br><span class="line">TcpExtTCPSackFailures           559232             0.0</span><br><span class="line">TcpExtTCPLossFailures           44575              0.0</span><br><span class="line">TcpExtTCPRenoRecoveryFail       0                  0.0</span><br><span class="line">TcpExtTCPSackRecoveryFail       400237             0.0</span><br><span class="line">TcpExtTCPSchedulerFailed        0                  0.0</span><br><span class="line">TcpExtTCPAbortFailed            3                  0.0</span><br><span class="line">TcpExtTCPSACKDiscard            0                  0.0</span><br><span class="line">TcpExtTCPBacklogDrop            0                  0.0</span><br><span class="line">TcpExtPFMemallocDrop            0                  0.0</span><br><span class="line">TcpExtTCPMinTTLDrop             0                  0.0</span><br><span class="line">TcpExtTCPDeferAcceptDrop        0                  0.0</span><br><span class="line">TcpExtTCPReqQFullDrop           0                  0.0</span><br><span class="line">TcpExtTCPRetransFail            631                0.0</span><br><span class="line">TcpExtTCPOFODrop                15819              0.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ netstat -s | grep -i retrans</span><br><span class="line">    36900 segments retransmited</span><br><span class="line">    TCPLostRetransmit: 135</span><br><span class="line">    36854 fast retransmits</span><br><span class="line">    32 forward retransmits</span><br><span class="line">    9 retransmits <span class="keyword">in</span> slow start</span><br><span class="line">    5 SACK retransmits failed</span><br><span class="line">$ netstat -s | grep -i retrans</span><br><span class="line">    36963 segments retransmited</span><br><span class="line">    TCPLostRetransmit: 135</span><br><span class="line">    36917 fast retransmits</span><br><span class="line">    32 forward retransmits</span><br><span class="line">    9 retransmits <span class="keyword">in</span> slow start</span><br><span class="line">    5 SACK retransmits failed</span><br><span class="line"></span><br><span class="line">17:18:03 0      10.53.19.2:40770     R&gt; 10.53.19.1:5201      ESTABLISHED</span><br><span class="line"> =&gt; tcp_retransmit_skb</span><br><span class="line"> =&gt; tcp_fastretrans_alert</span><br><span class="line"> =&gt; tcp_ack</span><br><span class="line"> =&gt; tcp_rcv_established</span><br><span class="line"> =&gt; tcp_v4_do_rcv</span><br><span class="line"> =&gt; tcp_v4_rcv</span><br><span class="line"> =&gt; ip_local_deliver_finish</span><br><span class="line"> =&gt; ip_local_deliver</span><br><span class="line"> =&gt; ip_rcv_finish</span><br><span class="line"> =&gt; ip_rcv</span><br><span class="line"> =&gt; __netif_receive_skb_core</span><br><span class="line"> =&gt; __netif_receive_skb</span><br><span class="line"> =&gt; netif_receive_skb_internal</span><br><span class="line"> =&gt; napi_gro_receive</span><br><span class="line"> =&gt; i40e_clean_rx_irq</span><br><span class="line"> =&gt; i40e_napi_poll</span><br><span class="line"> =&gt; net_rx_action</span><br><span class="line"> =&gt; __do_softirq</span><br><span class="line"> =&gt; call_softirq</span><br><span class="line"> =&gt; do_softirq</span><br><span class="line"> =&gt; irq_exit</span><br><span class="line"> =&gt; do_IRQ</span><br><span class="line"> =&gt; ret_from_intr</span><br><span class="line"> =&gt; cpuidle_enter_state</span><br><span class="line"> =&gt; cpuidle_idle_call</span><br><span class="line"> =&gt; arch_cpu_idle</span><br><span class="line"> =&gt; cpu_startup_entry</span><br><span class="line"> =&gt; start_secondary</span><br><span class="line"> =&gt; start_cpu</span><br><span class="line">17:18:03 11610  10.53.19.2:40770     R&gt; 10.53.19.1:5201      ESTABLISHED</span><br><span class="line"> =&gt; tcp_retransmit_skb</span><br><span class="line"> =&gt; tcp_fastretrans_alert</span><br><span class="line"> =&gt; tcp_ack</span><br><span class="line"> =&gt; tcp_rcv_established</span><br><span class="line"> =&gt; tcp_v4_do_rcv</span><br><span class="line"> =&gt; release_sock</span><br><span class="line"> =&gt; tcp_sendmsg</span><br><span class="line"> =&gt; inet_sendmsg</span><br><span class="line"> =&gt; sock_aio_write</span><br><span class="line"> =&gt; do_sync_write</span><br><span class="line"> =&gt; vfs_write</span><br><span class="line"> =&gt; SyS_write</span><br><span class="line"> =&gt; system_call_fastpath</span><br><span class="line"></span><br><span class="line">$ ps aux | grep 11610</span><br><span class="line">root     11610 11.9  0.0  10084  1524 pts/1    S+   17:15   0:28 iperf3 -c 10.53.19.1 -P 1 -M 8960 -S 0x08 -t 36000 -p 5201 -l 512k</span><br></pre></td></tr></table></figure><h4 id="Analysis-wireshark-log"><a href="#Analysis-wireshark-log" class="headerlink" title="Analysis wireshark log"></a>Analysis wireshark log</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ tshark -r first.pcapng <span class="string">&quot;tcp.analysis.retransmission&quot;</span></span><br><span class="line">no output</span><br><span class="line"></span><br><span class="line">$ tshark -r first.pcapng <span class="string">&quot;tcp.analysis.duplicate_ack&quot;</span></span><br><span class="line"></span><br><span class="line">21801 0.710632534   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#1] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794721 TSecr=61820560 SLE=777178578 SRE=777375434</span></span><br><span class="line">21804 0.710733730   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#2] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794721 TSecr=61820560 SLE=777178578 SRE=777500706</span></span><br><span class="line">21811 0.711034519   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#3] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=777867574</span></span><br><span class="line">21814 0.711153496   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#4] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778010742</span></span><br><span class="line">21816 0.711206308   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#5] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778082326</span></span><br><span class="line">21818 0.711259113   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#6] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778144962</span></span><br><span class="line">21820 0.711369837   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#7] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778279182</span></span><br><span class="line">21823 0.711477980   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#8] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778413402</span></span><br><span class="line">21826 0.711584396   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#9] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778547622</span></span><br><span class="line">21829 0.711695472   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#10] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778681842</span></span><br><span class="line">21831 0.711749935   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#11] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778753426</span></span><br><span class="line">21834 0.711911211   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#12] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=778950282</span></span><br><span class="line">21837 0.712018290   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#13] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779084502</span></span><br><span class="line">21839 0.712073239   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#14] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779147138</span></span><br><span class="line">21842 0.712182142   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#15] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779281358</span></span><br><span class="line">21844 0.712229813   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#16] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779317150</span></span><br><span class="line">21846 0.712343529   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#17] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779487162</span></span><br><span class="line">21848 0.712400110   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#18] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779549798</span></span><br><span class="line">21851 0.712507000   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799<span class="comment">#19] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794723 TSecr=61820560 SLE=777178578 SRE=779684018</span></span><br><span class="line">28272 1.007961111   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#1] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1144672938</span></span><br><span class="line">28276 1.008232476   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#2] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145012962</span></span><br><span class="line">28278 1.008288165   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#3] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145075598</span></span><br><span class="line">28284 1.008612213   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#4] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145478258</span></span><br><span class="line">28287 1.008719487   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#5] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795019 TSecr=61820858 SLE=1144493978 SRE=1145612478</span></span><br><span class="line">28290 1.008945676   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#6] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1145898814</span></span><br><span class="line">28292 1.008995223   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#7] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1145961450</span></span><br><span class="line">28294 1.009095692   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#8] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146077774</span></span><br><span class="line">28296 1.009144335   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#9] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146140410</span></span><br><span class="line">28298 1.009194590   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#10] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146203046</span></span><br><span class="line">28300 1.009296391   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#11] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146328318</span></span><br><span class="line">28303 1.009447610   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#12] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146516226</span></span><br><span class="line">28305 1.009498110   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#13] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146578862</span></span><br><span class="line">28307 1.009544808   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#14] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146632550</span></span><br><span class="line">28309 1.009647030   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#15] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795020 TSecr=61820858 SLE=1144493978 SRE=1146757822</span></span><br><span class="line">28312 1.009798430   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 28269<span class="comment">#16] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=1144476082 Win=18720768 Len=0 TSval=2597795021 TSecr=61820858 SLE=1144493978 SRE=1146945730</span></span><br></pre></td></tr></table></figure><p><img src="/img/tshark-1.png"><br><img src="/img/tshark-2.png"></p><p>TCP has this inherent mechanism of recovery. In tcp stream eq 8 of your trace there was a condition of retransmission generated due to timing but not because of drops. Here is the snippet of your trace.</p><p>Step-1)Server send a packet to client(Let us call it packet-A){Packet.no-150}</p><p>Step-2)Client acknowledged the packet (Let us call it ack-A){Packet.no-192}</p><p>Step-3)Somehow packet-A was retransmitted by Server.The reason might be the delay in receiving ack-A from client and ack timer got out and retransmission timer got kicked in.(Dup of Packet-A){Packet.no-194}</p><p>Step-4)Client generated a duplicate ack for the retransmitted packet.(Dup of ack-A){Packet.no-195}</p><p><a href="https://osqa-ask.wireshark.org/questions/21006/tcp-dup-acktcp-retransmission">https://osqa-ask.wireshark.org/questions/21006/tcp-dup-acktcp-retransmission</a></p><h3 id="tcpdump-802-3-header"><a href="#tcpdump-802-3-header" class="headerlink" title="tcpdump 802.3 header"></a><a href="https://support.f5.com/csp/article/K2289">tcpdump 802.3 header</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">LACP is handled by the switch fabric, therefore packets must be captured directly on the physical interface, <span class="keyword">for</span> example, 1.1, as opposed to the VLAN or 0.0.</span><br><span class="line"></span><br><span class="line">To capture only LACP packets, use the following syntax:</span><br><span class="line"></span><br><span class="line">tcpdump -ni &lt;interface&gt; -e ether proto 0x8809</span><br><span class="line"></span><br><span class="line">Note: The -e switch prints the link-level header on each line.</span><br><span class="line"></span><br><span class="line">For example, to capture LACP packets on interface 1.1 of a Link Aggregation Group (LAG), <span class="built_in">type</span> the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">tcpdump -ni 1.1 -e ether proto 0x8809</span><br><span class="line"></span><br><span class="line">The output appears similar to the following example:</span><br><span class="line"></span><br><span class="line">15:21:03.445333 00:50:56:92:2a:82 &gt; 01:80:c2:00:00:02, ethertype 802.1Q (0x8100), length 128: vlan 0, p 0, ethertype Slow Protocols, LACPv1, length: 110</span><br><span class="line"></span><br><span class="line">Ethernet header (basically IEEE 802.3)</span><br><span class="line"></span><br><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                         Preamble (8)                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                      Preamble cont.                           |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination address (6)                    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|   Destination address cont.   |         Source address (6)    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Source address cont.                       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|            Type (2)           | Pri |C|     802.1q tag        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| <span class="keyword">if</span> <span class="built_in">type</span>!=0x8100, prev. 2 bytes are part of this field  (46 -  |</span><br><span class="line">| 1500 bytes of data) ...                                       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Frame Check Sequence, FCS (4)              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">Note: Although the previous diagram correctly shows both Preamble and Frame Check Sequence, tcpdump does not include these <span class="keyword">in</span> the totals <span class="keyword">for</span> header bytes (presumably because the data is fixed, so there is no reason to match against it.) As a result, <span class="keyword">if</span> you are basing ether expressions on this chart, you must subtract 12 (as <span class="keyword">if</span> the Preamble and FCS sections <span class="keyword">do</span> not exist.)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">To view the SYN packets and the SYN and ACK packets, you would create the following filter that accepts either value <span class="keyword">for</span> the flag byte:</span><br><span class="line">tcpdump -ni internal <span class="string">&#x27;tcp[13] == 18&#x27;</span> or <span class="string">&#x27;tcp[13] == 2&#x27;</span></span><br><span class="line"></span><br><span class="line">You can also create a filter that looks <span class="keyword">for</span> the <span class="built_in">set</span> SYN bit and ignores the rest of the flags <span class="keyword">in</span> the header. You must <span class="built_in">set</span> the filter to perform a logic AND (&amp;) to remove all but the value of the SYN bit and <span class="keyword">then</span> <span class="built_in">test</span> it.</span><br><span class="line"></span><br><span class="line">For example, <span class="keyword">if</span> the TCP flags are 00010010 and the mask <span class="keyword">for</span> Syn is 00000010(2 <span class="keyword">in</span> binary) <span class="keyword">then</span> 00010010 + 00000010 = 00000010. You can <span class="keyword">then</span> <span class="built_in">test</span> the resulting value against the SYN flag, by setting the filter as follows:</span><br><span class="line">tcpdump -ni internal <span class="string">&#x27;tcp[13] &amp; 2 == 2&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> network </tag>
            
            <tag> tcp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>A copy about ZFS Internals(p1-p5)</title>
      <link href="2016/12/28/learn-zfs-internals-p1-p5/"/>
      <url>2016/12/28/learn-zfs-internals-p1-p5/</url>
      
        <content type="html"><![CDATA[<h3 id="ZFS-Internals"><a href="#ZFS-Internals" class="headerlink" title="ZFS Internals"></a><a href="http://www.eall.com.br/blog/?p=312">ZFS Internals</a></h3><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=disk0 bs=1M count=100</span><br><span class="line">104857600 bytes (105 MB) copied, 0.0582985 s, 1.8 GB/s</span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=disk1 bs=1M count=100</span><br><span class="line">104857600 bytes (105 MB) copied, 0.0587067 s, 1.8 GB/s</span><br><span class="line">$ zpool create test-pool /tank/<span class="built_in">test</span>/disk0  /tank/<span class="built_in">test</span>/disk1 </span><br><span class="line"></span><br><span class="line"><span class="comment"># I don &#x27;t know why only 128M could be used. loss a lot of capacity</span></span><br><span class="line">$ zpool list test-pool</span><br><span class="line">NAME        SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT</span><br><span class="line">test-pool   160M   244K   160M         -     1%     0%  1.00x  ONLINE  -</span><br><span class="line"></span><br><span class="line">$ zfs get compression test-pool</span><br><span class="line">NAME       PROPERTY     VALUE     SOURCE</span><br><span class="line">test-pool  compression  off       default</span><br><span class="line">$ zfs get recordsize test-pool</span><br><span class="line">NAME       PROPERTY    VALUE    SOURCE</span><br><span class="line">test-pool  recordsize  128K     default</span><br><span class="line"></span><br><span class="line">$ touch /test-pool/empty </span><br><span class="line">$ du -hs /test-pool/empty</span><br><span class="line">512/test-pool/empty</span><br><span class="line"></span><br><span class="line"><span class="comment"># ashift=0 ?</span></span><br><span class="line">test-pool  ashift    0       default</span><br><span class="line"></span><br><span class="line">$ rm -f testfile ;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..65535&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; testfile; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ ls -li</span><br><span class="line">7 -rw-r--r-- 1 root root 382106 12 28 12:45 testfile</span><br><span class="line"></span><br><span class="line">$ zdb -dddddddd test-pool/ 7</span><br><span class="line">Dataset test-pool [ZPL], ID 21, cr_txg 1, 404K, 7 objects, rootbp DVA[0]=&lt;0:16600:200&gt; DVA[1]=&lt;1:89200:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=77L/77P fill=7 cksum=b706a1be7:479be3ec2c2:e63cf120702c:1fa949c8882cfd</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">         7    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">dnode maxblkid: 2</span><br><span class="line">path/testfile</span><br><span class="line">uid     0</span><br><span class="line">gid     0</span><br><span class="line">atimeWed Dec 28 12:45:10 2016</span><br><span class="line">mtimeWed Dec 28 12:45:12 2016</span><br><span class="line">ctimeWed Dec 28 12:45:12 2016</span><br><span class="line">crtimeWed Dec 28 12:45:10 2016</span><br><span class="line">gen77</span><br><span class="line">mode100644</span><br><span class="line">size382106</span><br><span class="line">parent4</span><br><span class="line">links1</span><br><span class="line">pflags40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:2400:200 1:2400:200 4000L/200P F=3 B=77/77</span><br><span class="line">               0  L0 1:28000:20000 20000L/20000P F=1 B=77/77</span><br><span class="line">           20000  L0 1:48000:20000 20000L/20000P F=1 B=77/77</span><br><span class="line">           40000  L0 1:68000:20000 20000L/20000P F=1 B=77/77</span><br><span class="line"></span><br><span class="line">segment [0000000000000000, 0000000000060000) size  384K</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print strtonum(&quot;0x&quot;20000)&#125;&#x27;</span></span><br><span class="line">131072</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>0 0 L1  0:2400:200 1:2400:200 4000L/200P F=3 B=77/77</p><ul><li>L1 means two levels of indirection (number of block pointers which need to be traversed to arrive at this data)</li><li>0:2400:200 = disk0 , first raidz volume ?</li><li>the offset from the begining of the disk (2400)</li><li>and the size of the block (0x200 = 512 bytes)</li><li>0:2400 is the Data virtual Address 1 (dva1, Data virtual address )</li><li>F=3  is the fill count, and describes the number of non-zero block pointers under this block pointer</li><li>B=77/77 is the birth time, what is the same as the txg number</li></ul></li><li><p>0  L0 1:28000:20000 20000L/20000P F=1 B=77/77</p><ul><li>L0 is the block level that holds data (we can have up to six levels)</li><li>the fill count has a little different interpretation. Here the F= means if the block has data or not (0 or 1), what is different from the levels 1 and above, where it means how many non-zero block pointers under this block pointer. </li></ul></li></ul><p>Output first 128K of our file<br>16 bytes per line</p><p>-R poolname vdev:offset:size[:flags]</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;print strtonum(&quot;0x&quot;20000)&#125;&#x27;</span></span><br><span class="line">131072</span><br><span class="line"></span><br><span class="line">$ zdb -R test-pool/ 1:28000:20000 | head</span><br><span class="line">1:28000:20000</span><br><span class="line">          0 1 2 3 4 5 6 7   8 9 a b c d e f  0123456789abcdef</span><br><span class="line">000000:  0a330a320a310a30  0a370a360a350a34  0.1.2.3.4.5.6.7.</span><br><span class="line">000010:  310a30310a390a38  0a33310a32310a31  8.9.10.11.12.13.</span><br><span class="line">000020:  36310a35310a3431  310a38310a37310a  14.15.16.17.18.1</span><br><span class="line">000030:  0a31320a30320a39  34320a33320a3232  9.20.21.22.23.24</span><br><span class="line">000040:  320a36320a35320a  0a39320a38320a37  .25.26.27.28.29.</span><br><span class="line">000050:  32330a31330a3033  330a34330a33330a  30.31.32.33.34.3</span><br><span class="line">000060:  0a37330a36330a35  30340a39330a3833  5.36.37.38.39.40</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">$ zdb -R tank/<span class="built_in">test</span> 1:28000:20000:r | head</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line">$ zdb -R test-pool/ 1:28000:20000:r &gt; file1</span><br><span class="line">Found vdev: /tank/<span class="built_in">test</span>/disk1</span><br><span class="line">$ zdb -R test-pool/ 1:48000:20000:r &gt; file2</span><br><span class="line">Found vdev: /tank/<span class="built_in">test</span>/disk1</span><br><span class="line">$ zdb -R test-pool/ 1:68000:20000:r &gt; file3</span><br><span class="line">Found vdev: /tank/<span class="built_in">test</span>/disk1</span><br><span class="line"></span><br><span class="line">$ ls -lh</span><br><span class="line">-rw-r--r-- 1 root root 128K 12 28 12:51 file1</span><br><span class="line">-rw-r--r-- 1 root root 128K 12 28 12:53 file2</span><br><span class="line">-rw-r--r-- 1 root root 128K 12 28 12:53 file3</span><br><span class="line">-rw-r--r-- 1 root root 374K 12 28 12:45 testfile</span><br><span class="line"></span><br><span class="line">$ head -n 2 file1 </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">$ head -n 2 testfile </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">$ tail -n 2 file1</span><br><span class="line">23695</span><br><span class="line">23696</span><br><span class="line">$ head -n 2 file2</span><br><span class="line">23697</span><br><span class="line">23698</span><br><span class="line">$ tail -n 2 file2</span><br><span class="line">45541</span><br><span class="line">45$ head -n 2 file3</span><br><span class="line">542</span><br><span class="line">45543</span><br><span class="line">$ tail -n 2 file3</span><br><span class="line">65535</span><br><span class="line"></span><br><span class="line"><span class="comment"># why output single line ?</span></span><br><span class="line">$ tail -n 2 file3 | hexdump -C</span><br><span class="line">00000000  36 35 35 33 35 0a 00 00  00 00 00 00 00 00 00 00  |65535...........|</span><br><span class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00002b60  00 00 00 00 00 00 00 00  00 00 00 00              |............|</span><br><span class="line">00002b6c</span><br><span class="line">$ tail -n 2 testfile | hexdump -C</span><br><span class="line">00000000  36 35 35 33 34 0a 36 35  35 33 35 0a              |65534.65535.|</span><br><span class="line">0000000c</span><br><span class="line"></span><br><span class="line"><span class="comment">#delete zero last line in file3, you could get same md5sum</span></span><br><span class="line"></span><br><span class="line">$ md5sum  testfile </span><br><span class="line">43a1b3e2e25c9410daefdaa1d78678bf  testfile</span><br><span class="line">$ cat file1 file2 file3 | md5sum </span><br><span class="line">43a1b3e2e25c9410daefdaa1d78678bf  -</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Test-copy-on-write"><a href="#Test-copy-on-write" class="headerlink" title="Test copy on write"></a>Test copy on write</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ cp testfile testfile-1</span><br><span class="line">$ ls -i testfile-1 </span><br><span class="line">22 testfile-1</span><br><span class="line">$ zdb -dddddddd test-pool/ 22</span><br><span class="line">Dataset test-pool [ZPL], ID 21, cr_txg 1, 1.14M, 11 objects, rootbp DVA[0]=&lt;0:8e00:200&gt; DVA[1]=&lt;1:14e00:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=631L/631P fill=11 cksum=b211ccbf0:3ff67b6c728:bddd89c4f0bb:183789ced23226</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">        22    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">dnode maxblkid: 2</span><br><span class="line">path/testfile-1</span><br><span class="line">uid     0</span><br><span class="line">gid     0</span><br><span class="line">atimeWed Dec 28 13:31:22 2016</span><br><span class="line">mtimeWed Dec 28 13:31:22 2016</span><br><span class="line">ctimeWed Dec 28 13:31:22 2016</span><br><span class="line">crtimeWed Dec 28 13:31:22 2016</span><br><span class="line">gen631</span><br><span class="line">mode100644</span><br><span class="line">size382106</span><br><span class="line">parent4</span><br><span class="line">links1</span><br><span class="line">pflags40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:2600:200 1:2600:200 4000L/200P F=3 B=631/631</span><br><span class="line">               0  L0 1:adc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           20000  L0 1:cdc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           40000  L0 1:edc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line"></span><br><span class="line">segment [0000000000000000, 0000000000060000) size  384K</span><br><span class="line"></span><br><span class="line">$ </span><br><span class="line">$ <span class="built_in">echo</span> haha &gt;&gt; testfile-1 </span><br><span class="line">$ zdb -dddddddd test-pool/ 22</span><br><span class="line">Dataset test-pool [ZPL], ID 21, cr_txg 1, 1.14M, 11 objects, rootbp DVA[0]=&lt;0:5e00:200&gt; DVA[1]=&lt;1:6a00:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=637L/637P fill=11 cksum=bcaba3f58:44283babf90:cb3dd715909e:1a01d96e52cd6b</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">        22    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">dnode maxblkid: 2</span><br><span class="line">path/testfile-1</span><br><span class="line">uid     0</span><br><span class="line">gid     0</span><br><span class="line">atimeWed Dec 28 13:31:22 2016</span><br><span class="line">mtimeWed Dec 28 13:31:49 2016</span><br><span class="line">ctimeWed Dec 28 13:31:49 2016</span><br><span class="line">crtimeWed Dec 28 13:31:22 2016</span><br><span class="line">gen631</span><br><span class="line">mode100644</span><br><span class="line">size382111</span><br><span class="line">parent4</span><br><span class="line">links1</span><br><span class="line">pflags40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:5800:200 1:15400:200 4000L/200P F=3 B=637/637</span><br><span class="line">               0  L0 1:adc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           20000  L0 1:cdc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           40000  L0 0:7ca00:20000 20000L/20000P F=1 B=637/637 <span class="comment">### copy on write</span></span><br><span class="line"></span><br><span class="line">segment [0000000000000000, 0000000000060000) size  384K</span><br></pre></td></tr></table></figure><h3 id="Find-the-physical-address"><a href="#Find-the-physical-address" class="headerlink" title="Find the physical address"></a>Find the physical address</h3><p>Because there are some different with solaris zfs, it s not 4MiB in header.<br>I dd first 5MiB data from disk0.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0  of=/tmp/<span class="built_in">test</span> bs=1M count=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Found the data in disk0</span></span><br><span class="line">$ hexdump -C /tmp/<span class="built_in">test</span> | more</span><br><span class="line">00418fc0  13 00 00 00 00 00 00 80  00 00 00 00 00 00 2e 66  |...............f|</span><br><span class="line">00418fd0  69 6c 65 33 2e 73 77 70  00 00 00 00 00 00 00 00  |ile3.swp........|</span><br><span class="line">00418fe0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00419000  30 0a 31 0a 32 0a 33 0a  34 0a 35 0a 36 0a 37 0a  |0.1.2.3.4.5.6.7.|</span><br><span class="line">00419010  38 0a 39 0a 31 30 0a 31  31 0a 31 32 0a 31 33 0a  |8.9.10.11.12.13.|</span><br><span class="line">00419020  31 34 0a 31 35 0a 31 36  0a 31 37 0a 31 38 0a 31  |14.15.16.17.18.1|</span><br><span class="line">00419030  39 0a 32 30 0a 32 31 0a  32 32 0a 32 33 0a 32 34  |9.20.21.22.23.24|</span><br><span class="line">00419040  0a 32 35 0a 32 36 0a 32  37 0a 32 38 0a 32 39 0a  |.25.26.27.28.29.|</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print strtonum(&quot;0x&quot;419000)&#125;&#x27;</span></span><br><span class="line">4296704</span><br><span class="line">$ $ awk <span class="string">&#x27;BEGIN&#123;print strtonum(&quot;0x&quot;419000)/1024&#125;&#x27;</span></span><br><span class="line">4196</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print strtonum(&quot;0x&quot;28000)&#125;&#x27;</span></span><br><span class="line">163840</span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print strtonum(&quot;0x&quot;20000)&#125;&#x27;</span></span><br><span class="line">131072</span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print (4296704-163840)/1024&#125;&#x27;</span></span><br><span class="line">4036</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/test-1 bs=1k skip=4196 count=1</span><br><span class="line">$ head -n 2 /tmp/test-1 </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>which means the offset from the begining of the physical vdev (starting after the vdev labels, plus the boot block), 4036KiB total in openzfs on linux<br>4132864 = 3f100 ?</p><h3 id="Compare-with-ext3"><a href="#Compare-with-ext3" class="headerlink" title="Compare with ext3"></a>Compare with ext3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tank/<span class="built_in">test</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=disk2 bs=1M count=100</span><br><span class="line">104857600 bytes (105 MB) copied, 0.0600031 s, 1.7 GB/s</span><br><span class="line"></span><br><span class="line">$ mkfs.ext3 -b 4096 /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">mke2fs 1.41.12 (17-May-2010)</span><br><span class="line">/tank/<span class="built_in">test</span>/disk2 is not a block special device.</span><br><span class="line">Proceed anyway? (y,n) y</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">25600 inodes, 25600 blocks</span><br><span class="line">1280 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=29360128</span><br><span class="line">1 block group</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">25600 inodes per group</span><br><span class="line"></span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (1024 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">This filesystem will be automatically checked every 24 mounts or</span><br><span class="line">180 days, whichever comes first.  Use tune2fs -c or -i to override.</span><br><span class="line"></span><br><span class="line">$ mount disk2 /mnt -o loop</span><br><span class="line">$ df -h</span><br><span class="line">Filesystem        Size  Used Avail Use% Mounted on</span><br><span class="line">/tank/<span class="built_in">test</span>/disk2   97M  4.5M   88M   5% /mnt</span><br><span class="line"></span><br><span class="line">$ cp -a /test-pool/testfile ./</span><br><span class="line">$ filefrag -v /mnt/testfile </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">Filesystem cylinder groups is approximately 1</span><br><span class="line">File size of /mnt/testfile is 382109 (94 blocks, blocksize 4096)</span><br><span class="line"> ext logical physical expected length flags</span><br><span class="line">   0       0     1841              12 merged</span><br><span class="line">   1      12     1854     1853     82 merged,eof</span><br><span class="line">/mnt/testfile: 2 extents found, perfection would be 1 extent</span><br><span class="line"></span><br><span class="line">$ umount /mnt</span><br><span class="line">$ debugfs /tank/<span class="built_in">test</span>/disk2 </span><br><span class="line"> 1.41.12 (17-May-2010)</span><br><span class="line">debugfs:  stats</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          d6f9c3d7-e56b-433d-9830-69b15553029b</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision <span class="comment">#:    1 (dynamic)</span></span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype sparse_super large_file</span><br><span class="line">Filesystem flags:         signed_directory_hash </span><br><span class="line">Default mount options:    (none)</span><br><span class="line">Filesystem state:         clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS <span class="built_in">type</span>:       Linux</span><br><span class="line">Inode count:              25600</span><br><span class="line">Block count:              25600</span><br><span class="line">Reserved block count:     1280</span><br><span class="line">Free blocks:              23664</span><br><span class="line">Free inodes:              25588</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Reserved GDT blocks:      6</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         25600</span><br><span class="line">Inode blocks per group:   800</span><br><span class="line">Filesystem created:       Wed Dec 28 16:03:47 2016</span><br><span class="line">Last mount time:          Wed Dec 28 16:04:10 2016</span><br><span class="line">Last write time:          Wed Dec 28 16:04:52 2016</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      24</span><br><span class="line">Last checked:             Wed Dec 28 16:03:47 2016</span><br><span class="line">Check interval:           15552000 (6 months)</span><br><span class="line">Next check after:         Mon Jun 26 16:03:47 2017</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:          128</span><br><span class="line">Journal inode:            8</span><br><span class="line">Default directory <span class="built_in">hash</span>:   half_md4</span><br><span class="line">Directory Hash Seed:      58b4c828-2e74-4add-91bb-4007efd5187f</span><br><span class="line">Journal backup:           inode blocks</span><br><span class="line">Directories:              2</span><br><span class="line"> Group  0: block bitmap at 8, inode bitmap at 9, inode table at 10</span><br><span class="line">           23664 free blocks, 25588 free inodes, 2 used directories</span><br><span class="line"></span><br><span class="line">debugfs:  ls</span><br><span class="line"> 2  (12) .    2  (12) ..    11  (20) lost+found    12  (4052) testfile  </span><br><span class="line"></span><br><span class="line">debugfs:  show_inode_info testfile</span><br><span class="line">Inode: 12   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 933995507    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 382109</span><br><span class="line">File ACL: 0    Directory ACL: 0</span><br><span class="line">Links: 1   Blockcount: 760</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x58637206 -- Wed Dec 28 16:04:22 2016</span><br><span class="line">atime: 0x58637206 -- Wed Dec 28 16:04:22 2016</span><br><span class="line">mtime: 0x58637206 -- Wed Dec 28 16:04:22 2016</span><br><span class="line">BLOCKS:</span><br><span class="line">(0-11):1841-1852, (IND):1853, (12-93):1854-1935</span><br><span class="line">TOTAL: 95</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/file-1 bs=4K count=12 skip=1841</span><br><span class="line"></span><br><span class="line">$ head -n 2 /tmp/file-1 </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ tail -n 2 /tmp/file-1 </span><br><span class="line">10042</span><br><span class="line">1004</span><br><span class="line"></span><br><span class="line"><span class="variable">$if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/file-2 bs=4K count=82 skip=1854</span><br><span class="line">$ head -n 2 /tmp/file-2</span><br><span class="line">3</span><br><span class="line">10044</span><br><span class="line">$ tail -n 2 /tmp/file-2 </span><br><span class="line">12</span><br><span class="line">$ tail -n 3 /tmp/file-2 </span><br><span class="line">65535</span><br><span class="line">12 <span class="comment"># I have echo 12 &gt;&gt; to testfile.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete zero line(last line) in file2</span></span><br><span class="line">$ cat /tmp/file-1 /tmp/file-2 | md5sum </span><br><span class="line">48688f1bef04b9b59905409e9226ba65  -</span><br><span class="line">$ md5sum /mnt/testfile </span><br><span class="line">48688f1bef04b9b59905409e9226ba65  /mnt/testfile</span><br><span class="line"></span><br><span class="line"><span class="comment">#Modify file</span></span><br><span class="line"></span><br><span class="line">$ filefrag -v /mnt/testfile </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">Filesystem cylinder groups is approximately 1</span><br><span class="line">File size of /mnt/testfile is 382109 (94 blocks, blocksize 4096)</span><br><span class="line"> ext logical physical expected length flags</span><br><span class="line">   0       0     4104              12 merged</span><br><span class="line">   1      12     4117     4116     82 merged,eof</span><br><span class="line">/mnt/testfile: 2 extents found, perfection would be 1 extent</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/disk-2-1 bs=4k count=4105</span><br><span class="line">4105+0 records <span class="keyword">in</span></span><br><span class="line">4105+0 records out</span><br><span class="line">16814080 bytes (17 MB) copied, 0.161878 s, 104 MB/s</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br><span class="line">$ tail /tmp/disk-2-1 </span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line"></span><br><span class="line">1<span class="variable">$dd</span> <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/disk-2-2 bs=4k skip=4105 </span><br><span class="line">21495+0 records <span class="keyword">in</span></span><br><span class="line">21495+0 records out</span><br><span class="line">88043520 bytes (88 MB) copied, 0.66258 s, 133 MB/s</span><br><span class="line">$ head /tmp/disk-2-2 </span><br><span class="line">041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1111111111 &gt;&gt; /tmp/disk-2-1</span><br><span class="line"></span><br><span class="line">$ cat /tmp/disk-2-1 &gt; /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ du -hs /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">17M/tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ cat /tmp/disk-2-2 &gt;&gt; /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ du -hs /tank/<span class="built_in">test</span>/disk2 </span><br><span class="line">100M/tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ fsck /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">fsck from util-linux-ng 2.17.2</span><br><span class="line">e2fsck 1.41.12 (17-May-2010)</span><br><span class="line">/tank/<span class="built_in">test</span>/disk2: clean, 12/25600 files, 1936/25600 blocks</span><br><span class="line"></span><br><span class="line">$ mount /tank/<span class="built_in">test</span>/disk2 /mnt -o loop</span><br><span class="line"></span><br><span class="line">$ head -n 1042 /mnt/testfile | tail -n 2</span><br><span class="line">1040</span><br><span class="line">11111111111</span><br><span class="line"><span class="comment"># got it , file has changed.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Same-with-openzfs"><a href="#Same-with-openzfs" class="headerlink" title="Same with openzfs"></a>Same with openzfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">-bash-4.1<span class="comment"># zpool destroy test-pool</span></span><br><span class="line">$ zpool create test-pool /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ zpool create test-pool -o ashift=9 /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ rm -f testfile ;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..65535&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; testfile; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">0040f6a0  ff ff ff a6 50 00 00 00  00 00 00 00 00 00 00 00  |....P...........|</span><br><span class="line">0040f6b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0040f800  30 0a 31 0a 32 0a 33 0a  34 0a 35 0a 36 0a 37 0a  |0.1.2.3.4.5.6.7.|</span><br><span class="line">0040f810  38 0a 39 0a 31 30 0a 31  31 0a 31 32 0a 31 33 0a  |8.9.10.11.12.13.|</span><br><span class="line">0040f820  31 34 0a 31 35 0a 31 36  0a 31 37 0a 31 38 0a 31  |14.15.16.17.18.1|</span><br><span class="line">0040f830  39 0a 32 30 0a 32 31 0a  32 32 0a 32 33 0a 32 34  |9.20.21.22.23.24|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ls -li /test-pool/testfile </span><br><span class="line">7 -rw-r--r-- 1 root root 382106 12 28 17:31 /test-pool/testfile</span><br><span class="line"></span><br><span class="line">$ zdb -dddddd test-pool/ 7</span><br><span class="line">Dataset test-pool [ZPL], ID 21, cr_txg 1, 404K, 7 objects, rootbp DVA[0]=&lt;0:71c00:200&gt; DVA[1]=&lt;0:71e00:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=7L/7P fill=7 cksum=d25a82905:4fd05e01a15:f9b25d4668de:21890ed460fd11</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">         7    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">dnode maxblkid: 2</span><br><span class="line">path/testfile</span><br><span class="line">uid     0</span><br><span class="line">gid     0</span><br><span class="line">atimeWed Dec 28 17:31:11 2016</span><br><span class="line">mtimeWed Dec 28 17:31:13 2016</span><br><span class="line">ctimeWed Dec 28 17:31:13 2016</span><br><span class="line">crtimeWed Dec 28 17:31:11 2016</span><br><span class="line">gen7</span><br><span class="line">mode100644</span><br><span class="line">size382106</span><br><span class="line">parent4</span><br><span class="line">links1</span><br><span class="line">pflags40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:4800:200 0:4a00:200 4000L/200P F=3 B=7/7</span><br><span class="line">               0  L0 0:f800:20000 20000L/20000P F=1 B=7/7</span><br><span class="line">           20000  L0 0:2f800:20000 20000L/20000P F=1 B=7/7</span><br><span class="line">           40000  L0 0:4f800:20000 20000L/20000P F=1 B=7/7</span><br><span class="line"></span><br><span class="line">segment [0000000000000000, 0000000000060000) size  384K</span><br><span class="line"></span><br><span class="line">$ 40f800=4257792</span><br><span class="line">$ f800=63488</span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print (4257792-63488)/1024&#125;&#x27;</span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure><p>Header is 4MiB, and offset 63488 begin to write real data</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;print strtonum(&quot;0x40f800&quot;)/1024&#125;&#x27;</span></span><br><span class="line">4158</span><br><span class="line"></span><br><span class="line">$ zdb -R test-pool 0:f800:20000:r &gt; /tmp/file1</span><br><span class="line">-bash-4.1<span class="comment"># head /tmp/file1 </span></span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify /tmp/file1</span></span><br><span class="line">$ head -n 4 /tmp/file1</span><br><span class="line"><span class="comment">#0</span></span><br><span class="line"><span class="comment">#1</span></span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/disk0-1 bs=1k count=4158</span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/disk0-2 bs=1k skip=4158 count=1</span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/disk0-3 bs=1k skip=4159</span><br><span class="line"></span><br><span class="line">$ head /tmp/disk0-2 </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line">-bash-4.1<span class="comment"># tail /tmp/disk0-2 </span></span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">28</span><br><span class="line"></span><br><span class="line">$ ls -l /tmp/disk0-*</span><br><span class="line">-rw-r--r-- 1 root root   4257792 12 28 19:59 /tmp/disk0-1</span><br><span class="line">-rw-r--r-- 1 root root      1024 12 28 19:59 /tmp/disk0-2</span><br><span class="line">-rw-r--r-- 1 root root 100598784 12 28 20:03 /tmp/disk0-3</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify disk0-2</span></span><br><span class="line">$ vi /tmp/disk0-2 </span><br><span class="line">-bash-4.1<span class="comment"># head -n 2 /tmp/disk0-2 </span></span><br><span class="line"><span class="comment">#0</span></span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">$ cp /tmp/disk0-1 /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ cat /tmp/disk0-2 &gt;&gt; /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ cat /tmp/disk0-3 &gt;&gt; /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ zpool import -d /tank/<span class="built_in">test</span>/ test-pool</span><br><span class="line">cannot import <span class="string">&#x27;test-pool&#x27;</span>: I/O error</span><br><span class="line">Destroy and re-create the pool from</span><br><span class="line">a backup <span class="built_in">source</span>.</span><br><span class="line"></span><br><span class="line">$ zdb -l /tank/<span class="built_in">test</span>/disk0 </span><br><span class="line">zdb -l /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 0</span><br><span class="line">--------------------------------------------</span><br><span class="line">    version: 5000</span><br><span class="line">    name: <span class="string">&#x27;test-pool&#x27;</span></span><br><span class="line">    state: 0</span><br><span class="line">    txg: 1277</span><br><span class="line">    pool_guid: 2913619627256210242</span><br><span class="line">    errata: 0</span><br><span class="line">    hostname: <span class="string">&#x27;nas-57-11.local&#x27;</span></span><br><span class="line">    top_guid: 14729225611287826913</span><br><span class="line">    guid: 14729225611287826913</span><br><span class="line">    vdev_children: 1</span><br><span class="line">    vdev_tree:</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&#x27;file&#x27;</span></span><br><span class="line">        id: 0</span><br><span class="line">        guid: 14729225611287826913</span><br><span class="line">        path: <span class="string">&#x27;/tank/test/disk0&#x27;</span></span><br><span class="line">        metaslab_array: 35</span><br><span class="line">        metaslab_shift: 24</span><br><span class="line">        ashift: 9</span><br><span class="line">        asize: 100139008</span><br><span class="line">        is_log: 0</span><br><span class="line">        create_txg: 4</span><br><span class="line">    features_for_read:</span><br><span class="line">        com.delphix:hole_birth</span><br><span class="line">        com.delphix:embedded_data</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 1</span><br><span class="line">--------------------------------------------</span><br><span class="line">    version: 5000</span><br><span class="line">    name: <span class="string">&#x27;test-pool&#x27;</span></span><br><span class="line">    state: 0</span><br><span class="line">    txg: 1277</span><br><span class="line">    pool_guid: 2913619627256210242</span><br><span class="line">    errata: 0</span><br><span class="line">    hostname: <span class="string">&#x27;nas-57-11.local&#x27;</span></span><br><span class="line">    top_guid: 14729225611287826913</span><br><span class="line">    guid: 14729225611287826913</span><br><span class="line">    vdev_children: 1</span><br><span class="line">    vdev_tree:</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&#x27;file&#x27;</span></span><br><span class="line">        id: 0</span><br><span class="line">        guid: 14729225611287826913</span><br><span class="line">        path: <span class="string">&#x27;/tank/test/disk0&#x27;</span></span><br><span class="line">        metaslab_array: 35</span><br><span class="line">        metaslab_shift: 24</span><br><span class="line">        ashift: 9</span><br><span class="line">        asize: 100139008</span><br><span class="line">        is_log: 0</span><br><span class="line">        create_txg: 4</span><br><span class="line">    features_for_read:</span><br><span class="line">        com.delphix:hole_birth</span><br><span class="line">        com.delphix:embedded_data</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 2</span><br><span class="line">--------------------------------------------</span><br><span class="line">failed to unpack label 2</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 3</span><br><span class="line">--------------------------------------------</span><br><span class="line">failed to unpack label 3</span><br><span class="line"></span><br><span class="line"><span class="comment">## -F is too dangerous, Please add -n to make sure</span></span><br><span class="line">$ zpool import -N -o <span class="built_in">readonly</span>=on -f -d /tank/<span class="built_in">test</span>/ -F -T 1277</span><br><span class="line">   pool: test-pool</span><br><span class="line">     id: 2913619627256210242</span><br><span class="line">  state: FAULTED</span><br><span class="line"> status: The pool metadata is corrupted.</span><br><span class="line"> action: The pool cannot be imported due to damaged devices or data.</span><br><span class="line">The pool may be active on another system, but can be imported using</span><br><span class="line">the <span class="string">&#x27;-f&#x27;</span> flag.</span><br><span class="line">   see: http://zfsonlinux.org/msg/ZFS-8000-72</span><br><span class="line"> config:</span><br><span class="line"></span><br><span class="line">test-pool           FAULTED  corrupted data</span><br><span class="line">  /tank/<span class="built_in">test</span>/disk0  ONLINE</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Raidz-size"><a href="#Raidz-size" class="headerlink" title="Raidz size"></a><a href="http://blog.gjpvanwesten.nl/2014/08/part-iv-how-much-space-do-you-lose-with.html">Raidz size</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;print 128/7&#125;&#x27;</span></span><br><span class="line">18.2857</span><br><span class="line">awk <span class="string">&#x27;BEGIN&#123;print 18.2857/20&#125;&#x27;</span></span><br><span class="line">0.914285</span><br><span class="line">awk <span class="string">&#x27;BEGIN&#123;print 18.2857/18.5&#125;&#x27;</span></span><br><span class="line">0.988416</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sparse file data segment</title>
      <link href="2016/12/18/sparse/"/>
      <url>2016/12/18/sparse/</url>
      
        <content type="html"><![CDATA[<h3 id="Test-file"><a href="#Test-file" class="headerlink" title="Test file"></a>Test file</h3><p>ubuntu 16.04<br>ext4 file system</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ rm data-A</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1500&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; data-A ; <span class="keyword">done</span></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6394 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       0:    3464588..   3464588:      1:            </span><br><span class="line">   1:        1..       1:          0..         0:      1:    3464589: last,unknown_loc,delalloc,eof</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-1 bs=4096 count=1</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-2 bs=4096 count=1 skip=1</span><br><span class="line">$ head data-A-2</span><br><span class="line">1</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat data-A-1 data-A-2 | md5sum</span><br><span class="line">30ef7f11d29b8ad47542e97ed9d2a398  -</span><br><span class="line">$ cat data-A | md5sum</span><br><span class="line">30ef7f11d29b8ad47542e97ed9d2a398  -</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Test-sparse-file"><a href="#Test-sparse-file" class="headerlink" title="Test sparse file"></a>Test sparse file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">$ rm ./data-A;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1500&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; data-A ; <span class="keyword">done</span></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6393 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       1:          0..         1:      2:             last,unknown_loc,delalloc,eof</span><br><span class="line">data-A: 1 extent found</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=4096 count=0 seek=25 <span class="comment">#write 100K sparse file</span></span><br><span class="line">$ cat data-A &gt;&gt; <span class="built_in">test</span></span><br><span class="line">$ ls -lhs </span><br><span class="line">total 16K</span><br><span class="line">8.0K -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 6.3K 12 19 14:04 data-A</span><br><span class="line">8.0K -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 107K 12 19 14:06 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ df -h / </span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2       101G   35G   61G  37% /</span><br><span class="line"></span><br><span class="line">$ sudo dumpe2fs /dev/sda2 | grep -i <span class="string">&quot;Block size&quot;</span></span><br><span class="line">dumpe2fs 1.42.13 (17-May-2015)</span><br><span class="line">Block size:               4096</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6393 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       1:    3713508..   3713509:      2:             last,eof</span><br><span class="line">data-A: 1 extent found</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=test-1 bs=4096 count=1 skip=3713508</span><br><span class="line">$ head test-1 </span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line"></span><br><span class="line">$ tail test-1</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">104</span><br><span class="line"></span><br><span class="line">$ cat test-1 | md5sum</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  -</span><br><span class="line"></span><br><span class="line">$ filefrag -v <span class="built_in">test</span></span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span> is 108793 (27 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:       25..      26:    3713510..   3713511:      2:             last,eof</span><br><span class="line"><span class="built_in">test</span>: 1 extent found</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=test-s-1 bs=4096 count=1 skip=3713510</span><br><span class="line"></span><br><span class="line">$ md5sum <span class="built_in">test</span>-*</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  test-1</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  test-s-1</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=test-s-2 bs=4096 count=1 skip=3713511</span><br><span class="line"></span><br><span class="line"><span class="comment"># the checksum difference between test-s-2 and test</span></span><br><span class="line">$ hexdump test-s-2 | tail</span><br><span class="line">0000890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00008a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00008b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00008c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00008d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00008e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00008f0 3934 0a39 3531 3030 000a 0000 0000 0000</span><br><span class="line">0000900 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0001000</span><br><span class="line"></span><br><span class="line">$ hexdump <span class="built_in">test</span> | tail</span><br><span class="line">001a870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">001a880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">001a890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">001a8a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">001a8b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">001a8c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">001a8d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">001a8e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">001a8f0 3934 0a39 3531 3030 000a               </span><br><span class="line">001a8f9</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>There are some of zero fill in the file bottom.<br>astersik (*) !(means same as the line above)[<a href="http://superuser.com/questions/494245/what-does-an-asterisk-mean-in-hexdump-output]">http://superuser.com/questions/494245/what-does-an-asterisk-mean-in-hexdump-output]</a></p><h3 id="dd-update"><a href="#dd-update" class="headerlink" title="dd update"></a>dd update</h3><p>operate single byte</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-1Byte bs=1  count=1 ibs=1 obs=1</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-skip-1byte bs=1  skip=2 count=1 ibs=1 obs=1 iflag=count_bytes iflag=skip_bytes</span><br><span class="line"></span><br><span class="line">$ ls -ls | grep -i by</span><br><span class="line"></span><br><span class="line"><span class="comment">#first column is KiB , 4 is 4KiB</span></span><br><span class="line"><span class="comment">#sixth column is byte , 1 byte</span></span><br><span class="line"></span><br><span class="line">  4 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span>      1 12 19 15:23 data-A-1Byte</span><br><span class="line">  4 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span>      1 12 19 15:22 data-A-skip-1byte</span><br><span class="line"></span><br><span class="line">$ cat data-A-1Byte</span><br><span class="line">1 $ cat data-A-skip-1byte</span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">$ ls -ls <span class="built_in">test</span> data-A </span><br><span class="line">8 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span>   6393 12 19 14:54 data-A</span><br><span class="line">8 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 108793 12 19 15:30 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$  dd <span class="keyword">if</span>=<span class="built_in">test</span> of=test-data bs=1 count=6393 skip=102400 iflag=skip_bytes ibs=1 obs=1</span><br><span class="line">$ $ sha1sum   data-A test-data <span class="built_in">test</span></span><br><span class="line">8f8374832cb6536f580eef3b316ad08293a47617  data-A</span><br><span class="line">8f8374832cb6536f580eef3b316ad08293a47617  test-data</span><br><span class="line">03e31af4c89c9003ee0f43e49a65ad2e24367024  <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ hexdump data-A | tail</span><br><span class="line">0001870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">0001880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">0001890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00018a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00018b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00018c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00018d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00018e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00018f0 3934 0a39 3531 3030 000a               </span><br><span class="line">00018f9</span><br><span class="line">$ hexdump test-data | tail</span><br><span class="line">0001870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">0001880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">0001890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00018a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00018b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00018c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00018d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00018e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00018f0 3934 0a39 3531 3030 000a               </span><br><span class="line">00018f9</span><br><span class="line">$ hexdump <span class="built_in">test</span> | tail</span><br><span class="line">001a870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">001a880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">001a890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">001a8a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">001a8b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">001a8c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">001a8d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">001a8e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">001a8f0 3934 0a39 3531 3030 000a               </span><br><span class="line">001a8f9</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Expand-sparse-file"><a href="#Expand-sparse-file" class="headerlink" title="Expand sparse file"></a>Expand sparse file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ truncate -s +256 test_bak</span><br><span class="line">$ ls -ls  test_bak </span><br><span class="line">108 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 109049 12 19 16:36 test_bak</span><br><span class="line">$ ls -ls  <span class="built_in">test</span></span><br><span class="line">8 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 108793 12 19 15:30 <span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="number">109049</span>-<span class="number">108793</span>))</span><br><span class="line">256</span><br><span class="line"></span><br><span class="line"><span class="comment"># not sparse</span></span><br><span class="line"><span class="variable">$fallocate</span> -o 1M -l 1M 1M-file</span><br></pre></td></tr></table></figure><h3 id="About-fallocate"><a href="#About-fallocate" class="headerlink" title="About fallocate"></a>About <a href="https://pelican.craoc.fr/sparse-file.html">fallocate</a></h3><h4 id="collapse-range"><a href="#collapse-range" class="headerlink" title="collapse-range"></a>collapse-range</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">$ rm <span class="built_in">test</span>;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..60000&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; <span class="built_in">test</span>; <span class="keyword">done</span></span><br><span class="line">$ ls -ls <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 348896 12 19 17:03 <span class="built_in">test</span></span><br><span class="line">$ cp <span class="built_in">test</span> test2</span><br><span class="line">$ fallocate --collapse-range --offset 4096 --length 8192  test2 <span class="comment"># From 4096, delete length from 4096 delete 8192 length bytes</span></span><br><span class="line">$ dd <span class="keyword">if</span>=<span class="built_in">test</span> of=test-dd-4096-8192 bs=4096 count=2 skip=4096 iflag=skip_bytes <span class="comment"># make sure delete length</span></span><br><span class="line"></span><br><span class="line">head test-dd-4096-8192 </span><br><span class="line">041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line"></span><br><span class="line">$ tail test-dd-4096-8192</span><br><span class="line">2670</span><br><span class="line">2671</span><br><span class="line">2672</span><br><span class="line">2673</span><br><span class="line">2674</span><br><span class="line">2675</span><br><span class="line">2676</span><br><span class="line">2677</span><br><span class="line">2678</span><br><span class="line">267</span><br><span class="line"></span><br><span class="line">$ head -n 1045 test2 | tail</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">19   <span class="comment"># 1 041 and 267 9</span></span><br><span class="line">2680</span><br><span class="line">2681</span><br><span class="line">2682</span><br><span class="line"></span><br><span class="line"><span class="comment"># test in sparse file</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=test-sparse bs=1M count=0 seek=1</span><br><span class="line">$ ls -lsh</span><br><span class="line">total 344K</span><br><span class="line">344K -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 341K 12 19 17:03 <span class="built_in">test</span></span><br><span class="line">   0 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 1.0M 12 19 17:23 test-sparse</span><br><span class="line">$ cat <span class="built_in">test</span> &gt;&gt; test-sparse</span><br><span class="line">$ ls -ls</span><br><span class="line">total 688</span><br><span class="line">344 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span>  348896 12 19 17:03 <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 1397472 12 19 17:23 test-sparse</span><br><span class="line"></span><br><span class="line">$ fallocate --collapse-range --offset 4096 --length 8192 test-sparse </span><br><span class="line">$ ls -ls</span><br><span class="line">total 688</span><br><span class="line">344 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span>  348896 12 19 17:03 <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 1389280 12 19 17:24 test-sparse</span><br><span class="line"></span><br><span class="line">$ filefrag -v test-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of test-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      254..     341:    3803866..   3803953:     88:             last,eof</span><br><span class="line"></span><br><span class="line">$ filefrag -v test-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of test-sparse is 1389280 (340 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      252..     339:    3803866..   3803953:     88:             last,eof</span><br><span class="line">test-sparse: 1 extent found</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="zero-range"><a href="#zero-range" class="headerlink" title="zero-range"></a>zero-range</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ cp  <span class="built_in">test</span> test-sparse </span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=test-sparse bs=1M count=0 seek=1</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 0.000132755 s, 0.0 kB/s</span><br><span class="line">1d [<span class="built_in">test</span>:/tmp/<span class="built_in">test</span>/test2] 130 $ filefrag -v test-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of test-sparse is 1048576 (256 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       2:     589896..    589898:      3:             last,unwritten</span><br><span class="line">test-sparse: 1 extent found</span><br><span class="line">1d [<span class="built_in">test</span>:/tmp/<span class="built_in">test</span>/test2] $ cat <span class="built_in">test</span> &gt;&gt; test-sparse </span><br><span class="line">1d [<span class="built_in">test</span>:/tmp/<span class="built_in">test</span>/test2] $ filefrag -v test-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of test-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       2:     589896..    589898:      3:             unwritten</span><br><span class="line">   1:      256..     341:          0..        85:     86:     589899: last,unknown_loc,delalloc,eof</span><br><span class="line">test-sparse: 2 extents found</span><br><span class="line">$  head test-sparse </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line">$ fallocate --zero-range --offset 1048576 --length 128 test-sparse </span><br><span class="line">$ head test-sparse </span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line"></span><br><span class="line">$ fallocate --zero-range --offset 1048576 --length 348896  test-sparse</span><br><span class="line"><span class="comment"># clear all</span></span><br></pre></td></tr></table></figure><h4 id="punch-hole"><a href="#punch-hole" class="headerlink" title="punch-hole"></a>punch-hole</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="built_in">test</span> &gt;&gt; test-sparse </span><br><span class="line">$ filefrag -v test-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of test-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      256..     341:          0..        85:     86:             last,unknown_loc,delalloc,eof</span><br><span class="line">test-sparse: 1 extent found</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$cat</span> <span class="built_in">test</span> &gt;&gt; test-sparse </span><br><span class="line">$ ls -ls</span><br><span class="line">total 688</span><br><span class="line">344 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span>  348896 12 19 17:29 <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 1397472 12 19 17:53 test-sparse</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> ((4096*256)=1048576 ;((4096*84))=344064</span><br><span class="line"></span><br><span class="line"><span class="variable">$fallocate</span> --punch-hole --offset 1048576 --length 344064  test-sparse </span><br><span class="line">1d [<span class="built_in">test</span>:/tmp/<span class="built_in">test</span>/test2] $ filefrag -v test-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of test-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      340..     341:    3802396..   3802397:      2:             last,eof</span><br><span class="line">test-sparse: 1 extent found</span><br><span class="line"></span><br><span class="line">$ ls -ls test-sparse </span><br><span class="line">8 -rw-rw-r-- 1 <span class="built_in">test</span> <span class="built_in">test</span> 1397472 12 19 17:54 test-sparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># space has recycled</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sparse </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openzfs tips</title>
      <link href="2016/12/04/openzfs-tips/"/>
      <url>2016/12/04/openzfs-tips/</url>
      
        <content type="html"><![CDATA[<h3 id="Why-ZFS"><a href="#Why-ZFS" class="headerlink" title="Why ZFS"></a><a href="https://www.fujitsu.com/global/Images/ZFS%20Overview%20and%20Design%20Guide.pdf">Why ZFS</a></h3><ul><li>Transaction file system(Data consistency guaranteed)<ul><li>Manages writing of data with copy-on-write method</li><li>Does not overwrite original data</li><li>Commits or ignores sequential processing completely<ul><li>No data inconsistency</li></ul></li><li>Consistency check not required for the file system</li><li>Asynchronous writing to disks<ul><li>The system writes to the disk (I/O) after the end of sequential processing, so a check of the actual disk capacity (by a command such as df or du) may find that it is different.</li></ul></li></ul></li><li>End-to-end checksum(Invalid data detected Data self-corrected)<ul><li>Stores checksum of data block in its parent block</li><li>Restores data from redundant block when error is detected</li><li>Also detects and corrects logical inconsistencies (software bugs)</li><li>Data cannot be recovered when the data corruption range includes the checksum</li><li>The data and checksum are physically separated and read individually. The checksum itself can be recovered from the higher-level block.</li><li>ZFS not only detects the read errors caused by a disk fault, but also detects and corrects logical inconsistencies caused by a software bug</li><li>When read or written, invalid data is detected by the checksum. When invalid data is detected, if the system is in a redundant configuration (RAID 1 (mirroring), RAID-Z, RAID-Z2, or RAID-Z3), the data is automatically recovered (selfhealing)</li></ul></li></ul><h3 id="The-parameters"><a href="#The-parameters" class="headerlink" title="The parameters"></a>The parameters</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zpool create -f tank01 -O <span class="attribute">canmount</span>=on -O <span class="attribute">xattr</span>=sa -O <span class="attribute">acltype</span>=posixacl -o <span class="attribute">ashift</span>=12 -O <span class="attribute">recordsize</span>=32k -O <span class="attribute">secondarycache</span>=none -O <span class="attribute">logbias</span>=throughput -o <span class="attribute">multihost</span>=on -O <span class="attribute">autoreplace</span>=on raidz /dev/sd&#123;b<span class="built_in">..</span>d&#125;</span><br></pre></td></tr></table></figure><p>xattr=on stores extended attributes in hidden sub directories, which can require multiple lookups when accessing a file<br>xattr=sa, stores extended attributes in inodes, resulting in less IO requests when extended attributes are in use</p><p><a href="https://www.reddit.com/r/zfs/comments/azt8sz/logbiasthroughput_without_a_slog/eiilwoi">Logbias=throughput</a></p><ul><li>The throughout setting just means that during txg_sync, the blocks written to disk are assigned their Txn in place rather than being allocated fresh.on the assumption that youre writing big blocks that dont need to be aggregated by the SPA.    </li><li>Logbias=throughput with no SLOG will likely improve performance if your workload is lots of big block writes, which is a workload that usually isnt suffering from performance issues much in the first place.     </li><li>Logbias=throughput with no SLOG and small block writes will result in the most horrific fragmentation imaginable, which will penalize you both in the initial writes AND when you re read that data from metal later.     </li><li>Terminology note: logbias=throughput writes the blocks in indirect mode to the ZIL where the data is written to the pool and a pointer to the data is written to the ZIL.</li><li>zfs_immediate_write_sz: If a pool does not have a log device, data blocks equal to or larger than zfs_immediate_write_sz are treated as if the dataset being written to had the property setting logbias=throughput</li></ul><h3 id="the-old-optimize-with-lfs"><a href="#the-old-optimize-with-lfs" class="headerlink" title="the old optimize with lfs"></a><a href="http://wiki.lustre.org/images/4/48/ZFS-As-Backend-File-System_Paciucci.pdf">the old optimize with lfs</a></h3><p><code>There are some issue in this config that means the lustre engineers not make zfs struct clearly, their engineers don&#39;t know what is the ZFS</code></p><h3 id="Update-the-zfs-parameters-for-0-7-and-0-8"><a href="#Update-the-zfs-parameters-for-0-7-and-0-8" class="headerlink" title="Update the zfs parameters for 0.7 and 0.8"></a>Update the zfs parameters for 0.7 and 0.8</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/etc/udev/rules.d/50-zfs-udev.rules</span></span><br><span class="line"><span class="comment"># Reset some HDD vendor default value</span></span><br><span class="line"><span class="string">ACTION==&quot;add&quot;,</span> <span class="string">KERNEL==&quot;sd*[!0-9]&quot;,</span> <span class="string">RUN+=&quot;/bin/sh</span> <span class="string">-c</span> <span class="string">&#x27;sdparm -p ca -s WCE=1 /dev/%k &amp;&amp; sdparm -p bc -s EN_BMS=0 /dev/%k&#x27;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /etc/modprobe.d/zfs.conf</span></span><br><span class="line"><span class="string">options zfs zfs_multihost_history=300</span></span><br><span class="line"><span class="string">options zfs zfs_txg_history=300</span></span><br><span class="line"><span class="string">options zfs zfs_prefetch_disable=0  ## Good for HDD and sequential read/write; 0=prefetch enabled, 1=prefetch disabled</span></span><br><span class="line"><span class="string">options zfs metaslab_debug_unload=1</span></span><br><span class="line"><span class="string">options zfs zfs_multihost_history=300 ## /proc/spl/kstat/zfs/tank_0/multihost</span></span><br><span class="line"><span class="string">options zfs zfs_arc_max=49928994816 # eg: 64GB mem  ##echo $(awk &#x27;$0~/MemTotal/&#123;printf &quot;</span><span class="string">%.0f</span> <span class="string">\n&quot;,</span> <span class="string">$2*1024*0.75&#125;&#x27;</span> <span class="string">/proc/meminfo)</span> <span class="comment">#75%</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zio_dva_throttle_enabled=0</span> </span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_dirty_data_sync=1073741824</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_vdev_scheduler=deadline</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_dbgmsg_enable=1</span>  <span class="comment"># 0=do not log debug messages, 1=log debug messages, /proc/spl/kstat/zfs/dbgmsg</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zio_taskq_batch_pct=50</span> <span class="comment"># Depends your cpu core numbers and disable compression</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_multihost_fail_intervals=0</span> </span><br><span class="line"><span class="comment">## multihost write failures are ignored. The write failures are reported to the ZFS event daemon (zed) which can take action such as suspending the pool or offlining a device, and MMP will work under the pair node duplicate force import the zpool, and it may go to brain split although only a little chance.</span></span><br><span class="line"><span class="comment">#options zfs zfetch_max_distance=67108864 ## If there are many sequential read</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## if you want MMP go to suspend</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_multihost_fail_intervals=100</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_multihost_import_intervals=200</span> </span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_multihost_interval=6000</span></span><br><span class="line"><span class="comment"># Don&#x27;t allow fail_intervals larger than import_intervals</span></span><br><span class="line"><span class="comment"># When zfs_multihost_fail_intervals &gt; 0 then sequential multihost write failures will cause the pool to be  suspended. This occurs when zfs_multihost_fail_intervals * zfs_multihtank_interval milliseconds have passed since the last successful multihost write.  This guarantees the activity test will see multihost writes if the pool is imported.</span></span><br><span class="line"><span class="comment">#zfs_multihost_fail_intervals &gt;= zfs_multihost_import_intervals which could allow a pool to be imported on two nodes without any warnings.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Tuning for Scrubs and Resilvers http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_resilver_delay=0</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_scrub_delay=0</span></span><br><span class="line"><span class="comment">#Maximum number of scrub I/O per top-level vdev, by default 32. Increases zfs scrub speed. (at what cost, no idea), and it will impact the zpool performance for application</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_top_maxinflight=512</span></span><br><span class="line"><span class="comment">#zfs_scan_min_time_ms:Min millisecs to scrub per txg (int)</span></span><br><span class="line"><span class="comment">#resilver for five seconds per TXG</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">zfs_resilver_min_time_ms=5000</span></span><br><span class="line"><span class="comment">#The resilvers or scrub speed increase from 50MB/s to 800MB/s, increase a lot</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#l2arc_write_max</span></span><br><span class="line"><span class="comment">#If the cache devices can sustain the write workload, increasing the rate of cache device fill when workloads generate new data at a rate higher than l2arc_write_max can increase L2ARC hit rate</span></span><br><span class="line"><span class="comment"># Maximum number of bytes to be written to each cache device for each L2ARC feed thread interval</span></span><br><span class="line"><span class="comment"># tradeoff between write/read and durability of ssd (?)</span></span><br><span class="line"><span class="comment"># default : 8388608 Bytes</span></span><br><span class="line"><span class="comment"># setting here : 512 * 1024 * 1024 = 512MiB</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">l2arc_write_max=536870912</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># number of max device writes to precache, How far through the ARC lists to search for L2ARC cacheable content</span></span><br><span class="line"><span class="comment"># If the rate of change in the ARC is faster than the overall L2ARC feed rate, then increasing l2arc_headroom can increase L2ARC efficiency. Setting the value too large can cause the L2ARC feed thread to consume more CPU time looking for data to feed.</span></span><br><span class="line"><span class="comment"># default : 2</span></span><br><span class="line"><span class="string">options</span> <span class="string">zfs</span> <span class="string">l2arc_headroom=12</span></span><br></pre></td></tr></table></figure><h4 id="if-import-slow-because-some-slow-devices"><a href="#if-import-slow-because-some-slow-devices" class="headerlink" title="if import slow because some slow devices"></a>if import slow because some slow devices</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; zfs_multihost_fail_intervals</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; zfs_multihost_import_intervals</span><br><span class="line">$ zpool import -a</span><br></pre></td></tr></table></figure><p>zfs_vdev_scheduler not support mq-deadline<br>since ZFS has its own I/O scheduler, using a simple scheduler can result in more consistent performance<br>expected: noop, cfq, bfq, and deadline</p><p><a href="http://lfs.ornl.gov/ecosystem-2016/documents/tutorials/Stearman-LLNL-ZFS.pdf">Tutorial: How to install, tune and Monitor a ZFS based Lustre file system</a></p><h4 id="zfs-txg-timeout"><a href="#zfs-txg-timeout" class="headerlink" title="zfs_txg_timeout"></a>zfs_txg_timeout</h4><p>The last zfs_txg_history txg commits are available in /proc/spl/kstat/zfs/POOL_NAME/txgs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/spl/kstat/zfs/tank/txgs</span><br><span class="line">25 0 0x01 83 9296 11320470741 2382694537989353</span><br><span class="line">txg      birth            state ndirty       nread        nwritten     reads    writes   otime        qtime        wtime        stime</span><br><span class="line">13974499 2382281791630216 C     1949696      0            1433600      0        526      4999917952   44691        34328        382573295</span><br><span class="line">13974500 2382286791548168 C     1998848      0            1453056      0        552      5000003695   46223        44384        386415831</span><br><span class="line">13974501 2382291791551863 C     1458176      0            1245696      0        539      4999926718   45704        33119        386636075</span><br><span class="line">13974502 2382296791478581 C     950272       0            887296       0        492      4999981264   44784        34896        336542457</span><br><span class="line">13974503 2382301791459845 C     1146880      0            1244672      0        546      4999967135   67884        46074        346304560</span><br><span class="line">13974504 2382306791426980 C     4177920      0            2828288      0        600      4999946876   46380        45891        423776127</span><br></pre></td></tr></table></figure><h4 id="L2ARC-and-slog"><a href="#L2ARC-and-slog" class="headerlink" title="L2ARC and slog"></a>L2ARC and slog</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ arcstat.py -f <span class="string">&quot;time,read,hit%,hits,miss%,miss,arcsz,c&quot;</span> 1</span><br><span class="line"></span><br><span class="line">$ cat /proc/spl/kstat/zfs/arcstats</span><br><span class="line">$ arcstat.py 2</span><br><span class="line">$ arc_summary.py | grep <span class="string">&quot;L2 ARC Breakdown&quot;</span> -A 2</span><br><span class="line">L2 ARC Breakdown:                               846.25m</span><br><span class="line">        Hit Ratio:                      0.47%   3.98m</span><br><span class="line">        Miss Ratio:                     99.53%  842.27m</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="txg-timeout"><a href="#txg-timeout" class="headerlink" title="txg_timeout"></a>txg_timeout</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/module/zfs/parameters/zfs_txg_timeout</span><br><span class="line">5</span><br><span class="line"></span><br><span class="line">every 5s will <span class="keyword">do</span> transaction sync</span><br><span class="line"></span><br><span class="line">$ zdb -lu /dev/sdc1 | grep <span class="string">&quot;txg =&quot;</span> -c</span><br><span class="line">128</span><br><span class="line"></span><br><span class="line">128 x 5s= 640s</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 10 &gt;/sys/module/zfs/parameters/zfs_txg_timeout</span><br></pre></td></tr></table></figure><p>If in 640s, power off the server imported the zpool ASAP, reboot single server to check the zpool status.</p><h4 id="zpool-sync-mode"><a href="#zpool-sync-mode" class="headerlink" title="zpool sync mode"></a>zpool sync mode</h4><p>sync=standard : sync writes are written 2 times (first to LOG, second as normal write every ~5 seconds), async write are written only once (every ~5 seconds)<br>sync=always : sync writes and async writes are written 2 times (first to LOG, second as normal write every ~5 seconds).<br>sync=disabled : sync writes and async writes are written only once (every ~5 seconds)<br>Of course ZFS can flush it write cache between 5 second period but the biggest flush is every ~5 seconds.</p><h3 id="zpool-could-not-mount"><a href="#zpool-could-not-mount" class="headerlink" title="[zpool could not mount]"></a>[zpool could not mount]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ zpool <span class="built_in">set</span> cachefile=none tank</span><br><span class="line">$ zpool import -N -o cachefile=none -d /dev/disk/by-id tank01</span><br><span class="line">$ zfs mount -o ro tank01</span><br><span class="line"></span><br><span class="line">$ zpool import -Nm tank</span><br><span class="line"></span><br><span class="line"><span class="comment"># very dangerours, please backup all data</span></span><br><span class="line">$ zpool import -fFX -R /tmp/tank tank_11</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Security script</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Just check, not take action</span></span><br><span class="line">pool=<span class="string">&quot;tank&quot;</span></span><br><span class="line"><span class="comment">#find a vdev of pool</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line1</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  vdev=<span class="variable">$line1</span></span><br><span class="line">  zdb -lu <span class="variable">$vdev</span> |grep <span class="string">&quot;txg &quot;</span> |cut -d <span class="string">&quot; &quot;</span> -f 3 &gt; /tmp/txg</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&#x27;echo ----&#x27;</span><span class="variable">$line1</span><span class="string">&#x27;-----&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">read</span> LINE;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;echo zdb -e &#x27;</span><span class="variable">$pool</span><span class="string">&#x27; -d -t &#x27;</span><span class="variable">$LINE</span></span><br><span class="line">    <span class="built_in">echo</span> zdb -e <span class="variable">$pool</span> -d -t <span class="variable">$LINE</span></span><br><span class="line">  <span class="keyword">done</span> &lt; /tmp/txg</span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&#x27;echo ----&#x27;</span><span class="variable">$vdev</span><span class="string">&#x27;--finish-----&#x27;</span></span><br><span class="line"><span class="keyword">done</span> &lt; zpool_devs</span><br></pre></td></tr></table></figure><h4 id="Try-zpool-T-parameter"><a href="#Try-zpool-T-parameter" class="headerlink" title="Try zpool -T parameter"></a><a href="https://github.com/zfsonlinux/zfs/issues/2831">Try zpool -T parameter</a></h4><p>Youll need to make this one line change and rebuild the module. After which youll be able to use the -T option. This effectively disables the logic which prevents you from using uberblocks which are older than the label.</p><p>import from txg, like import snapshot timestamp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/module/zfs/vdev_label.c b/module/zfs/vdev_label.c</span><br><span class="line">index 1c2f00f..509e812 100644</span><br><span class="line">--- a/module/zfs/vdev_label.c</span><br><span class="line">+++ b/module/zfs/vdev_label.c</span><br><span class="line">@@ -471,7 +471,7 @@ retry:</span><br><span class="line">                        <span class="keyword">if</span> ((error || label_txg == 0) &amp;&amp; !config) &#123;</span><br><span class="line">                                config = label;</span><br><span class="line">                                <span class="built_in">break</span>;</span><br><span class="line">-                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (label_txg &lt;= txg &amp;&amp; label_txg &gt; best_txg) &#123;</span><br><span class="line">+                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (label_txg &gt; best_txg) &#123;</span><br><span class="line">                                best_txg = label_txg;</span><br><span class="line">                                nvlist_free(config);</span><br><span class="line">                                config = fnvlist_dup(label);</span><br></pre></td></tr></table></figure><h4 id="Add-skip-error-by-some-parameters-in-ZOL-0-8"><a href="#Add-skip-error-by-some-parameters-in-ZOL-0-8" class="headerlink" title="Add skip error by some parameters in ZOL 0.8"></a>Add skip error by some parameters in ZOL 0.8</h4><p>spa_load_verify_data<br>At the risk of data integrity, to speed extreme import of large pool<br>If this parameter is set to 0, the traversal skips non-metadata blocks. It can be toggled once the import has started to stop or start the traversal of non-metadata blocks.</p><p>spa_load_verify_metadata<br>At the risk of data integrity, to speed extreme import of large pool<br>If this parameter is set to 0, the traversal is not performed. It can be toggled once the import has started to stop or start the traversal</p><h4 id="zfs-vol"><a href="#zfs-vol" class="headerlink" title="zfs vol"></a>zfs vol</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zfs create -V 40T -o volblocksize=128k tank/zvol</span><br><span class="line">ls -l /dev/zvol/tank/zvol</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line"><span class="comment">### mount zfs</span></span><br><span class="line">```bash</span><br><span class="line">pool=tank</span><br><span class="line">zfs <span class="built_in">set</span> canmount=on <span class="variable">$pool</span></span><br><span class="line">zfs <span class="built_in">set</span> mountpoint=/mnt <span class="variable">$pool</span></span><br><span class="line">zfs mount <span class="variable">$pool</span></span><br><span class="line">rm -f /mnt/xxx/xxx/xxx</span><br><span class="line">zfs umount <span class="variable">$pool</span></span><br><span class="line">zfs <span class="built_in">set</span> canmount=off</span><br></pre></td></tr></table></figure><h3 id="zfs-event"><a href="#zfs-event" class="headerlink" title="zfs event"></a>zfs event</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zpool events -c <span class="comment"># clean events</span></span><br><span class="line">$ zpool import tank</span><br><span class="line">$ zpool events -v</span><br><span class="line">$ zpool events -v &gt; zpool_import_tank</span><br></pre></td></tr></table></figure><h3 id="Compression"><a href="#Compression" class="headerlink" title="Compression"></a>Compression</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> compression=lz4 tank</span><br><span class="line">zfs <span class="built_in">set</span> compression=gzip-9 tank</span><br></pre></td></tr></table></figure><h3 id="Xattr"><a href="#Xattr" class="headerlink" title="Xattr"></a>Xattr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> xattr=sa tank</span><br></pre></td></tr></table></figure><h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> acltype=posixacl tank/gentoo/home</span><br><span class="line">zfs get acltype tank/gentoo/home</span><br></pre></td></tr></table></figure><h3 id="Rmount"><a href="#Rmount" class="headerlink" title="Rmount"></a>Rmount</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> mountpoint=/var/lib/mysql tank/mysql</span><br><span class="line">zfs umount tank/mysql</span><br><span class="line">zfs mount tank/mysql</span><br></pre></td></tr></table></figure><h3 id="Zpool-rename"><a href="#Zpool-rename" class="headerlink" title="Zpool rename"></a>Zpool rename</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool <span class="built_in">export</span> app</span><br><span class="line">zpool import app apps</span><br></pre></td></tr></table></figure><h3 id="Detach-hdd-from-mirror"><a href="#Detach-hdd-from-mirror" class="headerlink" title="Detach hdd from mirror"></a>Detach hdd from mirror</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zpool detach tank sdz <span class="comment">#detach zda from mirror-17</span></span><br><span class="line">only sdal <span class="keyword">in</span> mirror-17, and mirror-17 is missing</span><br><span class="line"></span><br><span class="line">          mirror-16  ONLINE       0     0     0</span><br><span class="line">            sdai     ONLINE       0     0     0</span><br><span class="line">            sdaj     ONLINE       0     0     0</span><br><span class="line">          sdal       ONLINE       0     0     0</span><br><span class="line">          mirror-18  ONLINE       0     0     0</span><br><span class="line">            sdam     ONLINE       0     0     0</span><br><span class="line">            sdan     ONLINE       0     0     0</span><br></pre></td></tr></table></figure><h3 id="Attach-one-hdd-to-mirror"><a href="#Attach-one-hdd-to-mirror" class="headerlink" title="Attach one hdd to mirror"></a>Attach one hdd to mirror</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zpool attach tank sdal sdz</span><br><span class="line">          mirror-17  ONLINE       0     0     0</span><br><span class="line">            sdal     ONLINE       0     0     0</span><br><span class="line">            sdz      ONLINE       0     0     0  (resilvering)</span><br></pre></td></tr></table></figure><h3 id="sub-zpool"><a href="#sub-zpool" class="headerlink" title="sub zpool"></a>sub zpool</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs create tank/<span class="built_in">test</span></span><br></pre></td></tr></table></figure><h3 id="Quota"><a href="#Quota" class="headerlink" title="Quota"></a>Quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> quota=1024G tank/<span class="built_in">test</span></span><br><span class="line"><span class="comment"># disable</span></span><br><span class="line">zfs <span class="built_in">set</span> quota=none tank</span><br></pre></td></tr></table></figure><h3 id="user-quota"><a href="#user-quota" class="headerlink" title="user quota"></a>user quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> userquota@nagios=2G tank</span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/tank01/<span class="built_in">test</span>/nagios bs=1M</span><br><span class="line">dd: writing /tank/<span class="built_in">test</span>/nagios:Disk quota exceeded</span><br><span class="line"></span><br><span class="line"><span class="comment"># zfs get userquota@nagios</span></span><br><span class="line">NAME            PROPERTY          VALUE             SOURCE</span><br><span class="line">tank01          userquota@nagios  2G                <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># group</span></span><br><span class="line">zfs <span class="built_in">set</span> groupquota@staff=10G tank/staff/admins</span><br></pre></td></tr></table></figure><h3 id="Add-and-remove-hotspare"><a href="#Add-and-remove-hotspare" class="headerlink" title="Add and remove hotspare"></a>Add and remove hotspare</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool add tank spare c1t4d0 c1t5d0</span><br><span class="line">zpool remove tank c1t5d0</span><br></pre></td></tr></table></figure><h3 id="Clear-zfs-label"><a href="#Clear-zfs-label" class="headerlink" title="Clear zfs label"></a><a href="https://icesquare.com/wordpress/freebsdhow-to-remove-zfs-meta-data/">Clear zfs label</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zpool labelclear &#x2F;dev&#x2F;sdxxx</span><br><span class="line">or</span><br><span class="line">$ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;dev&#x2F;sdXX bs&#x3D;512 count&#x3D;10</span><br><span class="line">$ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;dev&#x2F;sdXX bs&#x3D;512 seek&#x3D;$(( $(blockdev --getsz &#x2F;dev&#x2F;sdXX) - 4096 ))</span><br></pre></td></tr></table></figure><h3 id="Auto-rebuild-in-0-7-x"><a href="#Auto-rebuild-in-0-7-x" class="headerlink" title="Auto rebuild in 0.7.x"></a>Auto rebuild in 0.7.x</h3><p><a href="https://github.com/zfsonlinux/zfs/issues/2449">Autoreplace not working</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool <span class="built_in">set</span> autoreplace=on tank</span><br></pre></td></tr></table></figure><h3 id="Show-status"><a href="#Show-status" class="headerlink" title="Show status"></a>Show status</h3><p>Mapping /dev/shm/zil_cache to loop0p1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/dev/shm/zil_cache bs=1M count=4096</span><br><span class="line">$ losetup -v -f /dev/shm/zil_cache</span><br><span class="line">$ losetup -a</span><br><span class="line">/dev/loop0: [0018]:55156303 (/dev/shm/zil_cache)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add zil by mirror</span></span><br><span class="line">$ zpool add tank <span class="built_in">log</span> mirror /dev/loop0p1 /dev/loop0p2, because it <span class="string">&#x27;s test file from /dev/shm</span></span><br><span class="line"><span class="string">$ zpool add tank log /dev/loop0p1</span></span><br><span class="line"><span class="string">$ zpool iostat -v 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pool                                            alloc   free   read  write   read  write</span></span><br><span class="line"><span class="string">----------------------------------------------  -----  -----  -----  -----  -----  -----</span></span><br><span class="line"><span class="string">tank                                            24.4G  1.30T      0  8.74K      0   575M</span></span><br><span class="line"><span class="string">  scsi-3600605b005811bf01db36f957f619f26-part1  24.4G  1.30T      0  5.50K      0   448M</span></span><br><span class="line"><span class="string">logs                                                -      -      -      -      -      -</span></span><br><span class="line"><span class="string">  loop0p1                                        102M  3.87G      0  3.23K      0   127M</span></span><br><span class="line"><span class="string">----------------------------------------------  -----  -----  -----  -----  -----  -----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ zpool iostat -r 1</span></span><br><span class="line"><span class="string">tank_7         sync_read    sync_write    async_read    async_write      scrub</span></span><br><span class="line"><span class="string">req_size      ind    agg    ind    agg    ind    agg    ind    agg    ind    agg</span></span><br><span class="line"><span class="string">----------  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----</span></span><br><span class="line"><span class="string">512             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">1K              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">2K              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">4K              0      0      8      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">8K              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">16K             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">32K             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">64K             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">128K           63      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">256K            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">512K            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">1M              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">2M              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">4M              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">8M              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">16M             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ zpool iostat -L -v -q 2</span></span><br><span class="line"><span class="string">              capacity     operations     bandwidth    syncq_read    syncq_write   asyncq_read  asyncq_write   scrubq_read   trimq_write</span></span><br><span class="line"><span class="string">pool        alloc   free   read  write   read  write   pend  activ   pend  activ   pend  activ   pend  activ   pend  activ   pend  activ</span></span><br><span class="line"><span class="string">----------  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----</span></span><br><span class="line"><span class="string">tank         161G  90.8T      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">  raidz2     161G  90.8T      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sda         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdb         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdc         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdd         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sde         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdf         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdg         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdi         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdk         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">    sdl         -      -      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">----------  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ zpool iostat -w 2</span></span><br><span class="line"><span class="string">tank         total_wait     disk_wait    syncq_wait    asyncq_wait</span></span><br><span class="line"><span class="string">latency      read  write   read  write   read  write   read  write  scrub   trim</span></span><br><span class="line"><span class="string">----------  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----</span></span><br><span class="line"><span class="string">1ns             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">3ns             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">7ns             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">15ns            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">31ns            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">63ns            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">127ns           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">255ns           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">511ns           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">1us             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">2us             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">4us             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">8us             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">16us            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">32us            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">65us            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">131us           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">262us           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">524us           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">1ms             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">2ms             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">4ms             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">8ms             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">16ms            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">33ms            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">67ms            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">134ms           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">268ms           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">536ms           0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">1s              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">2s              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">4s              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">8s              0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">17s             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">34s             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">68s             0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">137s            0      0      0      0      0      0      0      0      0      0</span></span><br><span class="line"><span class="string">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /proc/spl/kstat/zfs/tank_86/dmu_tx_assign</span></span><br><span class="line"><span class="string">75 1 0x01 41 1968 259828173343194 262983153792140</span></span><br><span class="line"><span class="string">name                            type data</span></span><br><span class="line"><span class="string">1 ns                            4    0</span></span><br><span class="line"><span class="string">2 ns                            4    0</span></span><br><span class="line"><span class="string">4 ns                            4    0</span></span><br><span class="line"><span class="string">8 ns                            4    0</span></span><br><span class="line"><span class="string">16 ns                           4    0</span></span><br><span class="line"><span class="string">32 ns                           4    0</span></span><br><span class="line"><span class="string">64 ns                           4    0</span></span><br><span class="line"><span class="string">128 ns                          4    40</span></span><br><span class="line"><span class="string">256 ns                          4    40</span></span><br><span class="line"><span class="string">512 ns                          4    6</span></span><br><span class="line"><span class="string">1024 ns                         4    1</span></span><br><span class="line"><span class="string">2048 ns                         4    0</span></span><br><span class="line"><span class="string">4096 ns                         4    0</span></span><br><span class="line"><span class="string">8192 ns                         4    0</span></span><br><span class="line"><span class="string">16384 ns                        4    0</span></span><br><span class="line"><span class="string">32768 ns                        4    0</span></span><br><span class="line"><span class="string">65536 ns                        4    5</span></span><br><span class="line"><span class="string">131072 ns                       4    105</span></span><br><span class="line"><span class="string">262144 ns                       4    331</span></span><br><span class="line"><span class="string">524288 ns                       4    419</span></span><br><span class="line"><span class="string">1048576 ns                      4    325</span></span><br><span class="line"><span class="string">2097152 ns                      4    338</span></span><br><span class="line"><span class="string">4194304 ns                      4    188</span></span><br><span class="line"><span class="string">8388608 ns                      4    65</span></span><br><span class="line"><span class="string">16777216 ns                     4    59</span></span><br><span class="line"><span class="string">33554432 ns                     4    47</span></span><br><span class="line"><span class="string">67108864 ns                     4    34</span></span><br><span class="line"><span class="string">134217728 ns                    4    60</span></span><br><span class="line"><span class="string">268435456 ns                    4    55</span></span><br><span class="line"><span class="string">536870912 ns                    4    65</span></span><br><span class="line"><span class="string">1073741824 ns                   4    94</span></span><br><span class="line"><span class="string">2147483648 ns                   4    56</span></span><br><span class="line"><span class="string">4294967296 ns                   4    271</span></span><br><span class="line"><span class="string">8589934592 ns                   4    3454</span></span><br><span class="line"><span class="string">17179869184 ns                  4    4687</span></span><br><span class="line"><span class="string">34359738368 ns                  4    1970</span></span><br><span class="line"><span class="string">68719476736 ns                  4    642</span></span><br><span class="line"><span class="string">137438953472 ns                 4    380</span></span><br><span class="line"><span class="string">274877906944 ns                 4    440</span></span><br><span class="line"><span class="string">549755813888 ns                 4    299</span></span><br><span class="line"><span class="string">1099511627776 ns                4    36</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ zpool iostat -v -y -l 2</span></span><br><span class="line"><span class="string">tank                           146T  13.8T  1.46K    345  49.0M   319K   24ms    2ms   24ms    1ms  741ns  627ns  610ns    1ms      -</span></span><br><span class="line"><span class="string">  raidz3                       146T  13.8T  1.46K    345  49.0M   319K   24ms    2ms   24ms    1ms  741ns  627ns  610ns    1ms      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a66cec97        -      -     88     18  2.76M  15.6K    8ms  840us    8ms  442us  664ns  474ns  758ns  407us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a670caef        -      -     93     18  2.93M  15.1K   68ms   11ms   68ms   10ms  919ns    1us  758ns  281us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a65a02fb        -      -     73     18  2.40M  14.8K   16ms  514us   16ms  335us  714ns  758ns  568ns  239us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a670bbc7        -      -     79     17  2.74M  13.8K   10ms  556us   10ms  334us  679ns  474ns  568ns  244us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a6754b03        -      -     70     20  2.36M  15.6K   26ms  679us   26ms  360us  766ns  474ns  758ns  329us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a675ae43        -      -     88     19  2.89M  15.1K   60ms    5ms   60ms    5ms  802ns  985ns  758ns  366us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a670c787        -      -     82     20  2.61M  16.8K   15ms  833us   15ms  468us  713ns  379ns  379ns  394us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a6754d7b        -      -     97     25  3.05M  43.9K    8ms   14ms    8ms    6ms  710ns  379ns  379ns    9ms      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a67540d7        -      -     74     19  2.50M  18.3K   23ms  796us   23ms  466us  727ns  474ns  379ns  371us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a675455b        -      -     83     19  2.79M  17.3K   32ms  687us   32ms  393us  760ns  474ns  758ns  315us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a670ca8f        -      -     71     19  2.38M  17.0K    9ms  771us    9ms  398us  644ns  474ns      -  361us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a65b55bb        -      -     89     18  2.84M  16.0K    8ms  909us    8ms  567us  779ns  682ns      -  329us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a65a7f57        -      -     82     20  2.60M  17.8K   32ms  527us   32ms  318us  744ns  695ns      -  289us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a65b2683        -      -     92     17  2.99M  15.3K   57ms  687us   57ms  443us  863ns    1us  758ns  242us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a675449f        -      -     74     16  2.55M  16.0K   11ms  625us   11ms  425us  633ns  474ns  379ns  257us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a670c30f        -      -     82     16  2.82M  15.6K    9ms  808us    9ms  539us  680ns  379ns  758ns  363us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a670af17        -      -     77     19  2.65M  17.5K    8ms  876us    8ms  458us  695ns  474ns  758ns  380us      -</span></span><br><span class="line"><span class="string">    scsi-35000c500a670c2ab        -      -     95     18  3.10M  17.8K   18ms  786us   18ms  498us  770ns  758ns  379ns  333us      -</span></span><br><span class="line"><span class="string">----------------------------  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----  -----</span></span><br></pre></td></tr></table></figure><h3 id="Custom-script-show-temperature"><a href="#Custom-script-show-temperature" class="headerlink" title="Custom script ,show temperature"></a>Custom script ,show temperature</h3><p>/etc/zfs/zpool.d</p><p>$  ZPOOL_SCRIPTS_AS_ROOT=1 zpool status -c temp<br>  pool: tank<br> state: ONLINE<br>  scan: scrub repaired 0B in 0 days 06:46:11 with 0 errors on Tue Oct 15 06:46:14 2019<br>config:</p><pre><code>    NAME        STATE     READ WRITE CKSUM  temp    tank        ONLINE       0     0     0      raidz2-0  ONLINE       0     0     0        sdc     ONLINE       0     0     0    27        sdd     ONLINE       0     0     0    28        sde     ONLINE       0     0     0    27        sdf     ONLINE       0     0     0    29        sdg     ONLINE       0     0     0    27        sdh     ONLINE       0     0     0    28    logs      mirror-1  ONLINE       0     0     0        sda3    ONLINE       0     0     0    24        sdb3    ONLINE       0     0     0    25    cache      sda4      ONLINE       0     0     0    24      sdb4      ONLINE       0     0     0    25</code></pre><p>errors: No known data errors</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### zdb</span><br><span class="line">```bash</span><br><span class="line">zdb -MM -P test_0</span><br><span class="line">        vdev          <span class="number">0</span>         metaslabs  <span class="number">116</span>          fragmentation <span class="number">88</span>%</span><br><span class="line">                          <span class="number">9</span>: <span class="number">31097798</span> ***********************</span><br><span class="line">                         <span class="number">10</span>: <span class="number">33383938</span> ************************</span><br><span class="line">                         <span class="number">11</span>: <span class="number">56520516</span> ****************************************</span><br><span class="line">                         <span class="number">12</span>: <span class="number">53907990</span> ***************************************</span><br><span class="line">                         <span class="number">13</span>: <span class="number">11130025</span> ********</span><br><span class="line">                         <span class="number">14</span>: <span class="number">4519568</span> ****</span><br><span class="line">                         <span class="number">15</span>: <span class="number">2751108</span> **</span><br><span class="line">                         <span class="number">16</span>: <span class="number">179324</span> *</span><br><span class="line">                         <span class="number">17</span>:   <span class="number">2534</span> *</span><br><span class="line">                         <span class="number">18</span>:    <span class="number">138</span> *</span><br><span class="line">                         <span class="number">19</span>:     <span class="number">16</span> *</span><br><span class="line">                         <span class="number">20</span>:      <span class="number">3</span> *</span><br><span class="line">                         <span class="number">21</span>:      <span class="number">2</span> *</span><br><span class="line">        pool test_0     fragmentation    <span class="number">88</span>%</span><br><span class="line">                          <span class="number">9</span>: <span class="number">31097798</span> ***********************</span><br><span class="line">                         <span class="number">10</span>: <span class="number">33383938</span> ************************</span><br><span class="line">                         <span class="number">11</span>: <span class="number">56520516</span> ****************************************</span><br><span class="line">                         <span class="number">12</span>: <span class="number">53907990</span> ***************************************</span><br><span class="line">                         <span class="number">13</span>: <span class="number">11130025</span> ********</span><br><span class="line">                         <span class="number">14</span>: <span class="number">4519568</span> ****</span><br><span class="line">                         <span class="number">15</span>: <span class="number">2751108</span> **</span><br><span class="line">                         <span class="number">16</span>: <span class="number">179324</span> *</span><br><span class="line">                         <span class="number">17</span>:   <span class="number">2534</span> *</span><br><span class="line">                         <span class="number">18</span>:    <span class="number">138</span> *</span><br><span class="line">                         <span class="number">19</span>:     <span class="number">16</span> *</span><br><span class="line">                         <span class="number">20</span>:      <span class="number">3</span> *</span><br><span class="line">                         <span class="number">21</span>:      <span class="number">2</span> *</span><br><span class="line"></span><br><span class="line">$ zdb -b test_0</span><br><span class="line"></span><br><span class="line">Traversing all blocks to verify nothing leaked ...</span><br><span class="line"></span><br><span class="line">loading space map <span class="keyword">for</span> vdev <span class="number">0</span> of <span class="number">1</span>, metaslab <span class="number">115</span> of <span class="number">116</span> ...</span><br><span class="line"><span class="number">39.0</span>G completed (<span class="number">1569</span>MB/s) estimated time remaining: <span class="number">0</span>hr <span class="number">30</span>min <span class="number">43</span>sec</span><br><span class="line"><span class="number">2.80</span>T completed ( <span class="number">553</span>MB/s) estimated time remaining: <span class="number">0</span>hr <span class="number">00</span>min <span class="number">00</span>sec</span><br><span class="line">        No leaks (block sum matches space maps exactly)</span><br><span class="line"></span><br><span class="line">        bp count:      <span class="number">1154215521</span></span><br><span class="line">        ganged count:           <span class="number">0</span></span><br><span class="line">        bp logical:    <span class="number">3028205925888</span>      avg:   <span class="number">2623</span></span><br><span class="line">        bp physical:   <span class="number">2695917303296</span>      avg:   <span class="number">2335</span>     compression:   <span class="number">1.12</span></span><br><span class="line">        bp allocated:  <span class="number">3076338462208</span>      avg:   <span class="number">2665</span>     compression:   <span class="number">0.98</span></span><br><span class="line">        bp deduped:             <span class="number">0</span>    <span class="built_in">ref</span>&gt;<span class="number">1</span>:      <span class="number">0</span>   deduplication:   <span class="number">1.00</span></span><br><span class="line">        SPA allocated: <span class="number">3076338462208</span>     used: <span class="number">77.18</span>%</span><br><span class="line"></span><br><span class="line">        additional, non-pointer bps of type <span class="number">0</span>:         <span class="number">40</span></span><br><span class="line">        Dittoed blocks on same vdev: <span class="number">590073873</span></span><br></pre></td></tr></table></figure><p>ZDB Get file info</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/tank/<span class="built_in">test</span>/1 bs=1M count=1</span><br><span class="line">zdb -vv -bbbb -O tank/<span class="built_in">test</span> test_1</span><br><span class="line">zdb -ddddd tank/<span class="built_in">test</span></span><br><span class="line">......</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L0 0:86bef7d8400:600 4000L/200P F=1 B=11629333/11629333</span><br><span class="line">            4000 L0 0:867fb11c400:1800 4000L/e00P F=1 B=11629333/11629333</span><br><span class="line"></span><br><span class="line">                segment [0000000000000000, 0000000000008000) size   32K</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">       256    2   128K   128K  1.00M     512     1M  100.00  ZFS plain file</span><br><span class="line">                                               168   bonus  System attributes</span><br><span class="line">        dnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED</span><br><span class="line">        dnode maxblkid: 7</span><br><span class="line">        path    /1</span><br><span class="line">        uid     0</span><br><span class="line">        gid     0</span><br><span class="line">        atime   Tue Dec 25 22:25:42 2018</span><br><span class="line">        mtime   Tue Dec 25 22:25:42 2018</span><br><span class="line">        ctime   Tue Dec 25 22:25:42 2018</span><br><span class="line">        crtime  Tue Dec 25 22:25:42 2018</span><br><span class="line">        gen     11630673</span><br><span class="line">        mode    100644</span><br><span class="line">        size    1048576</span><br><span class="line">        parent  34</span><br><span class="line">        links   1</span><br><span class="line">        pflags  40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:86d5203a600:c00 20000L/400P F=8 B=11630673/11630673</span><br><span class="line">               0  L0 0:86e648c9400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line">           20000  L0 0:86e648f9400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line">           40000  L0 0:86e64929400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line">           60000  L0 0:86e64959400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line">           80000  L0 0:86e64989400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line">           a0000  L0 0:86e649b9400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line">           c0000  L0 0:86e649e9400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line">           e0000  L0 0:86e64a19400:30000 20000L/20000P F=1 B=11630673/11630673</span><br><span class="line"></span><br><span class="line">                segment [0000000000000000, 0000000000100000) size    1M</span><br><span class="line"></span><br><span class="line">    Dnode slots:</span><br><span class="line">        Total used:             8</span><br><span class="line">        Max used:             256</span><br><span class="line">        Percent empty:  96.875000</span><br><span class="line"></span><br><span class="line">$ ls -l /tank/backup/test100/test.c</span><br><span class="line">-rw-r--r-- 1 root root 739 Mar  4 08:50 /tank/backup/test100/test.c</span><br><span class="line">$ zdb -vv -O tank/backup test100/test.c</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">   5526595    1   128K     1K     9K     512     1K  100.00  ZFS plain file</span><br><span class="line">                                               176   bonus  System attributes</span><br><span class="line">dnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED</span><br><span class="line">dnode maxblkid: 0</span><br><span class="line">uid     0</span><br><span class="line">gid     0</span><br><span class="line">atimeWed Mar  4 08:50:52 2020</span><br><span class="line">mtimeWed Mar  4 08:50:50 2020</span><br><span class="line">ctimeWed Mar  4 08:50:50 2020</span><br><span class="line">crtimeWed Mar  4 08:50:50 2020</span><br><span class="line">gen1668705</span><br><span class="line">mode100644</span><br><span class="line">size739</span><br><span class="line">parent43</span><br><span class="line">links1</span><br><span class="line">pflags840800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L0 0:328e967a2000:3000 400L/400P F=1 B=1668705/1668705</span><br><span class="line"></span><br><span class="line">segment [0000000000000000, 0000000000000400) size    1K</span><br><span class="line"></span><br><span class="line">zdb -vv -bbbb -O tank/backup test100/test.c</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">   5526595    1   128K     1K     9K     512     1K  100.00  ZFS plain file</span><br><span class="line">                                               176   bonus  System attributes</span><br><span class="line">dnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED</span><br><span class="line">dnode maxblkid: 0</span><br><span class="line">uid     0</span><br><span class="line">gid     0</span><br><span class="line">atimeWed Mar  4 08:50:52 2020</span><br><span class="line">mtimeWed Mar  4 08:50:50 2020</span><br><span class="line">ctimeWed Mar  4 08:50:50 2020</span><br><span class="line">crtimeWed Mar  4 08:50:50 2020</span><br><span class="line">gen1668705</span><br><span class="line">mode100644</span><br><span class="line">size739</span><br><span class="line">parent43</span><br><span class="line">links1</span><br><span class="line">pflags840800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L0 DVA[0]=&lt;0:328e967a2000:3000&gt; [L0 ZFS plain file] fletcher4 uncompressed unencrypted LE contiguous unique single size=400L/400P birth=1668705L/1668705P fill=1 cksum=36e170f019:231ac0e9e639:c8f24370cf5ff:340704ee1157fd0</span><br><span class="line"></span><br><span class="line">segment [0000000000000000, 0000000000000400) size    1K</span><br><span class="line"></span><br><span class="line"><span class="comment">## Got the data block</span></span><br><span class="line">$ zdb -R tank/backup 0:328e967a2000:3000</span><br><span class="line">Found vdev <span class="built_in">type</span>: raidz</span><br><span class="line"></span><br><span class="line">0:328e967a2000:3000</span><br><span class="line">          0 1 2 3 4 5 6 7   8 9 a b c d e f  0123456789abcdef</span><br><span class="line">000000:  23696e636c756465  203c737464696f2e  <span class="comment">#include &lt;stdio.</span></span><br><span class="line">000010:  683e0a23696e636c  756465203c737973  h&gt;.<span class="comment">#include &lt;sys</span></span><br><span class="line">000020:  2f73686d2e683e0a  23696e636c756465  /shm.h&gt;.<span class="comment">#include</span></span><br><span class="line">000030:  203c7379732f7374  61742e683e0a2369   &lt;sys/stat.h&gt;.<span class="comment">#i</span></span><br><span class="line">000040:  6e636c756465203c  7379732f6d6d616e  nclude &lt;sys/mman</span><br><span class="line">000050:  2e683e0a23696e63  6c756465203c6663  .h&gt;.<span class="comment">#include &lt;fc</span></span><br><span class="line">000060:  6e746c2e683e0a23  696e636c75646520  ntl.h&gt;.<span class="comment">#include</span></span><br><span class="line">000070:  3c7374646c69622e  683e0a23696e636c  &lt;stdlib.h&gt;.<span class="comment">#incl</span></span><br><span class="line">000080:  756465203c737472  696e672e683e0a23  ude &lt;string.h&gt;.<span class="comment">#</span></span><br><span class="line">000090:  696e636c75646520  3c756e697374642e  include &lt;unistd.</span><br><span class="line">0000a0:  683e0a0a696e7420  6d61696e28696e74  h&gt;..int main(int</span><br><span class="line">0000b0:  20617267632c2063  686172202a2a6172   argc, char **ar</span><br><span class="line">......</span><br><span class="line">002fd0:  0000000000000000  0000000000000000  ................</span><br><span class="line">002fe0:  0000000000000000  0000000000000000  ................</span><br><span class="line">002ff0:  0000000000000000  0000000000000000  ................</span><br></pre></td></tr></table></figure><p>0:86e648c9400:30000 20000L/20000P F=1 B=11630673/11630673<br>vdev:offset:size</p><p>vdev=0<br>offset=86e648c9400 (offset in logic disk ?)</p><p>20000L/20000P means size,  compressed size(2000L),the no compression file size(2000P)<br>0x2000=131072</p><p>B=11630673/11630673 means write operate transaction group</p><h3 id="performance-tuning"><a href="#performance-tuning" class="headerlink" title="performance tuning"></a>performance tuning</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># number of z_wr_iss processes tunable</span></span><br><span class="line">zio_taskq_batch_pct</span><br><span class="line">(The bad setting will casue the performance issue, Many thanks <span class="keyword">for</span> Javen <span class="string">&#x27;s help)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">core=1</span></span><br><span class="line"><span class="string">[[ $(grep MHz /proc/cpuinfo -c) -gt 8 ]] &amp;&amp; maxcpu=8 &amp;&amp; for i in $(pgrep &#x27;</span>z_wr_iss$<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">do</span></span><br><span class="line"><span class="string">   [[ $core -gt $maxcpu ]] &amp;&amp; core=0</span></span><br><span class="line"><span class="string">   taskset -p -c $core $i</span></span><br><span class="line"><span class="string">   ((core++))</span></span><br><span class="line"><span class="string">done</span></span><br></pre></td></tr></table></figure><h3 id="check-your-zpool-could-be-imported"><a href="#check-your-zpool-could-be-imported" class="headerlink" title="check your zpool could be imported"></a>check your zpool could be imported</h3><p>running it in another server(not import the pool), you can see can be import or can not be import<br>make sure the MMP was worked</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">$ zpool import</span><br><span class="line"></span><br><span class="line"><span class="comment">## export the zpool or you have antoher server connect this zpool</span></span><br><span class="line">$ zdb -ec <span class="variable">$poolname</span></span><br><span class="line">Traversing all blocks to verify metadata checksums and verify nothing leaked ...</span><br><span class="line"></span><br><span class="line">loading space map <span class="keyword">for</span> vdev 0 of 1, metaslab 1 of 139 ...</span><br><span class="line"></span><br><span class="line">$ zdb -ec -AAA <span class="variable">$poolname</span></span><br><span class="line"><span class="comment"># if there is &quot;assertion failure&quot;...</span></span><br><span class="line"><span class="comment"># -AAA could not abort</span></span><br><span class="line">Configuration <span class="keyword">for</span> import:</span><br><span class="line">        vdev_children: 1</span><br><span class="line">        version: 5000</span><br><span class="line">        pool_guid: 1548875728334022114</span><br><span class="line">        name: <span class="string">&#x27;mdt_0&#x27;</span></span><br><span class="line">        state: 0</span><br><span class="line">        hostid: 4281985155</span><br><span class="line">        hostname: <span class="string">&#x27;cngb-mds-m20-1&#x27;</span></span><br><span class="line">        vdev_tree:</span><br><span class="line">            <span class="built_in">type</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">            id: 0</span><br><span class="line">            guid: 1548875728334022114</span><br><span class="line">            children[0]:</span><br><span class="line">                <span class="built_in">type</span>: <span class="string">&#x27;raidz&#x27;</span></span><br><span class="line">                id: 0</span><br><span class="line">                guid: 1680148767042285697</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ zdb -e -AAA <span class="variable">$poolname</span> &gt; <span class="variable">$poolnam</span></span><br><span class="line">Configuration <span class="keyword">for</span> import:</span><br><span class="line">        vdev_children: 1</span><br><span class="line">        version: 5000</span><br><span class="line">        pool_guid: 1548875728334022114</span><br><span class="line">        name: <span class="string">&#x27;mdt_0&#x27;</span></span><br><span class="line">        state: 0</span><br><span class="line">        hostid: 4281985155</span><br><span class="line">        hostname: <span class="string">&#x27;cngb-mds-m20-1&#x27;</span></span><br><span class="line">        vdev_tree:</span><br><span class="line">            <span class="built_in">type</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">            id: 0</span><br><span class="line">            guid: 1548875728334022114</span><br><span class="line">            children[0]:</span><br><span class="line">                <span class="built_in">type</span>: <span class="string">&#x27;raidz&#x27;</span></span><br><span class="line">                id: 0</span><br><span class="line">                guid: 1680148767042285697</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ zdb -em -AAA <span class="variable">$poolname</span> <span class="comment"># to check metalab</span></span><br><span class="line">Metaslabs:</span><br><span class="line">        vdev          0</span><br><span class="line">        metaslabs   139   offset                spacemap          free</span><br><span class="line">        ---------------   -------------------   ---------------   -------------</span><br><span class="line">        metaslab      0   offset            0   spacemap     39   free    27.6G</span><br><span class="line">        metaslab      1   offset    800000000   spacemap     55   free    31.1G</span><br><span class="line">        metaslab      2   offset   1000000000   spacemap     58   free    30.3G</span><br><span class="line">        metaslab      3   offset   1800000000   spacemap     42   free    29.4G</span><br><span class="line">        metaslab      4   offset   2000000000   spacemap     45   free    28.3G</span><br><span class="line"></span><br><span class="line"><span class="comment">#metaslab check</span></span><br></pre></td></tr></table></figure><h3 id="zpool-status"><a href="#zpool-status" class="headerlink" title="zpool status"></a>zpool status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ zpool status -x -v</span><br><span class="line">$ zpool status -v</span><br><span class="line"></span><br><span class="line">errors: Permanent errors have been detected <span class="keyword">in</span> the following files:</span><br><span class="line"></span><br><span class="line">        tank/mdt_0:/oi.1/0x1:0x1fcc1:0x0</span><br><span class="line">        tank/mdt_0:/oi.1/0x1:0x1fcc5:0x0</span><br><span class="line">        tank/mdt_0:/oi.1/0x1:0x1fccc:0x0</span><br><span class="line">        tank/mdt_0:/oi.1/0x1:0x1fcc2:0x0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Disable-AVX512-for-scalable-Xeon-silver-and-gold-5xxx"><a href="#Disable-AVX512-for-scalable-Xeon-silver-and-gold-5xxx" class="headerlink" title="Disable AVX512 for scalable Xeon silver and gold 5xxx"></a>Disable AVX512 for scalable Xeon silver and gold 5xxx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gold 5115</span></span><br><span class="line">$ cat /proc/spl/kstat/zfs/fletcher_4_bench</span><br><span class="line">0 0 0x01 -1 0 43875755056 2388098231282525</span><br><span class="line">implementation   native         byteswap</span><br><span class="line">scalar           5097645469     4106654089</span><br><span class="line">superscalar      6876819423     5086086480</span><br><span class="line">superscalar4     5926587517     4946863265</span><br><span class="line">sse2             11659567916    6572225291</span><br><span class="line">ssse3            11660661610    10379355285</span><br><span class="line">avx2             17865482202    16120833783</span><br><span class="line">avx512f          24802818495    8841728748</span><br><span class="line">fastest          avx512f        avx2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> ssse3 &gt; /sys/module/zcommon/parameters/zfs_fletcher_4_impl</span><br><span class="line"><span class="built_in">echo</span> ssse3 &gt; /sys/module/zfs/parameters/zfs_vdev_raidz_impl</span><br></pre></td></tr></table></figure><p>Because I m wrong about when avx2 or avx512 called, The cpu will reduce the frequency and it will impact the others (no avx system call) at the same time</p><p><code>In some fio mix IO case, I can &#39;t beleive the avx2 lower than 4% than the ssse3, the CPU was 1x Xeon E2136 </code></p><p><a href="https://github.com/zfsonlinux/zfs/wiki/ZFS-on-Linux-Module-Parameters#zfs_vdev_raidz_impl">zfs_vdev_raidz_impl</a><br><a href="https://github.com/zfsonlinux/zfs/wiki/ZFS-on-Linux-Module-Parameters#zfs_fletcher_4_impl">zfs_fletcher_4_impl</a></p><p>or you could disable AVX by kernel parameter</p><h1 id="not-make-sure"><a href="#not-make-sure" class="headerlink" title="not make sure"></a>not make sure</h1><h3 id="Too-bad-about-zfs-dracut"><a href="#Too-bad-about-zfs-dracut" class="headerlink" title="Too bad about zfs-dracut"></a>Too bad about zfs-dracut</h3><p>In zfs old version 0.6.x, there is no multihost parameter.<br>When you upgrade to 0.7.x, it s not enable by default !!!  but you can see the mmp history is worked !!!<br>So if you zfs-dracut , maybe you will be brain-split, lsinitrd show hostid == 0 !!!<br>My version is 0.7.9-1</p><p>##not make sure<br>lsinitrd</p><p>Thanks Javen Wu save me again</p><p>You could unistall the package or remove it , zfs dracut is too dangerous for HA arch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql zfs-dracut-0.7.9-1.el7.x86_64</span><br><span class="line">/usr/lib/dracut/modules.d/02zfsexpandknowledge</span><br><span class="line">/usr/lib/dracut/modules.d/02zfsexpandknowledge/module-setup.sh</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs/export-zfs.sh</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs/module-setup.sh</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs/mount-zfs.sh</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs/parse-zfs.sh</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs/zfs-generator.sh</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs/zfs-lib.sh</span><br><span class="line">/usr/lib/dracut/modules.d/90zfs/zfs-needshutdown.sh</span><br><span class="line">/usr/share/doc/zfs-dracut-0.7.9</span><br><span class="line">/usr/share/doc/zfs-dracut-0.7.9/README.dracut.markdown</span><br></pre></td></tr></table></figure><h3 id="ZFS-0-7-x-MMP-cause-too-many-issues-the-ZFS-0-6-5-more-stable"><a href="#ZFS-0-7-x-MMP-cause-too-many-issues-the-ZFS-0-6-5-more-stable" class="headerlink" title="ZFS 0.7.x MMP cause too many issues, the ZFS 0.6.5 more stable"></a>ZFS 0.7.x MMP cause too many issues, the ZFS 0.6.5 more stable</h3><ul><li><a href="https://github.com/zfsonlinux/zfs/issues/7834">Performance impact</a></li><li><a href="https://github.com/zfsonlinux/zfs/issues/7731">Zpool import slow</a></li><li><a href="https://github.com/zfsonlinux/zfs/issues/7709">Disk fail cause zpool suspend</a><ul><li><a href="https://github.com/zfsonlinux/zfs/pull/8495">2</a></li></ul></li></ul><h3 id="Remove-slog"><a href="#Remove-slog" class="headerlink" title="Remove slog"></a>Remove slog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## slog device has been destroy, skip/bypass import slog</span></span><br><span class="line">$ zpool import -m -a -f</span><br><span class="line"></span><br><span class="line">$ zpool status -x</span><br><span class="line">  pool: tank</span><br><span class="line"> state: DEGRADED</span><br><span class="line">status: One or more devices could not be used because the label is missing or</span><br><span class="line">        invalid.  Sufficient replicas exist <span class="keyword">for</span> the pool to <span class="built_in">continue</span></span><br><span class="line">        functioning <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Replace the device using <span class="string">&#x27;zpool replace&#x27;</span>.</span><br><span class="line">   see: http://zfsonlinux.org/msg/ZFS-8000-4J</span><br><span class="line">  scan: scrub repaired 0B <span class="keyword">in</span> 0 days 06:46:11 with 0 errors on Mon Oct 14 18:46:14 2019</span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME                      STATE     READ WRITE CKSUM</span><br><span class="line">        tank                      DEGRADED     0     0     0</span><br><span class="line">          raidz2-0                ONLINE       0     0     0</span><br><span class="line">            sdc                   ONLINE       0     0     0</span><br><span class="line">            sdd                   ONLINE       0     0     0</span><br><span class="line">            sde                   ONLINE       0     0     0</span><br><span class="line">            sdf                   ONLINE       0     0     0</span><br><span class="line">            sdg                   ONLINE       0     0     0</span><br><span class="line">            sdh                   ONLINE       0     0     0</span><br><span class="line">        logs</span><br><span class="line">          mirror-1                UNAVAIL      0     0     0  insufficient replicas</span><br><span class="line">            13378777246457412929  UNAVAIL      0     0     0  was /dev/sda3</span><br><span class="line">            1725913437883392852   UNAVAIL      0     0     0  was /dev/sdb</span><br><span class="line"></span><br><span class="line">$ zpool remove tank mirror-1</span><br><span class="line">that ok</span><br></pre></td></tr></table></figure><h3 id="About-SMR-HDD"><a href="#About-SMR-HDD" class="headerlink" title="About SMR HDD"></a><a href="https://github.com/zfsonlinux/zfs/issues/4877">About SMR HDD</a></h3><p>Another thing you might try is to leave the block size set at 1M but increase the zfs_vdev_aggregation_limit to 16M. This way as long as your doing 1M aligned IO you should never write partial blocks and leave holes. ZFS will aggregate these 1M blocks in to larger 16M IOs to the disk.</p><p><a href="http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers/">zfs-performance-tuning-for-scrubs-and-resilvers</a><br><a href="https://forum.proxmox.com/threads/zfs-zil-log-txg_sync-causing-high-io-every-5-seconds-any-solution.24376/">zfs-zil-log-txg_sync-causing-high-io-every-5-seconds</a><br><a href="https://www.svennd.be/tuning-of-zfs-module/">tuning zfs module</a><br><a href="http://lfs.ornl.gov/ecosystem-2016/documents/tutorials/Stearman-LLNL-ZFS.pdf">Stearman-LLNL-ZFS</a><br><a href="http://fibrevillage.com/storage/171-zfs-on-linux-performance-tuning">171-zfs-on-linux-performance</a><br><a href="http://list.zfsonlinux.org/pipermail/zfs-discuss/2018-March/030666.html">Is the number of z_wr_iss processes tunable?</a><br><a href="https://www.beegfs.io/wiki/StorageServerTuning#hn_59ca4f8bbb_16">Tips and Recommendations for Storage Server Tuning</a></p><h3 id="About-silent-error"><a href="#About-silent-error" class="headerlink" title="About silent error"></a><a href="http://www.lieberbiber.de/2018/07/17/improving-data-safety-on-all-systems-using-zfs-and-btrfs/">About silent error</a></h3><p>Enterprise drives can store checksums in a separate space by using slightly larger on-disk blocks of 520 or 4104 bytes in size. The additional eight bytes can be accessed by the operating system using a feature called T10 Protection Information (T10-PI). On consumer drives the file system has to store the checksums with the rest of the data, slightly reducing the available space.</p><p>Even if you have just one drive, you now get to know immediately when the drive is acting up before something bad happens. The operating system signals read errors to the applications instead of passing corrupt data. The backup software doesnt overwrite the good backup. You dont end up with corrupted data on the second system when transferring data using that flaky USB drive.</p><p>Sun Microsystems invented ZFS as a modern file system with lots of features, among them checksumming for all data. It has its own storage layer, its own RAID level implementations and can perform all checks while the file system is mounted. It was open-sourced as part of OpenSolaris, but cannot be assimilated into the Linux kernel due to licensing constraints. Ubuntu is the only Linux distribution which ships a ready-made ZFSonLinux kernel module, with all other distribution things are more complicated. I recommend using ZFS if you can, but even I only use it in my Ubuntu-based NAS. It is also rather complicated to set up and was not designed for removable devices, making it less attractive for many use cases.</p><h4 id="ext4-xfs-hardware-raid"><a href="#ext4-xfs-hardware-raid" class="headerlink" title="ext4 xfs hardware raid"></a>ext4 xfs hardware raid</h4><p>Both ext4 and XFS were supposed to get checksums for both metadata and data blocks. xfsprogs have enabled metadata checksums by default for all new XFS file systems as of version 3.2.3 (released in May 2015). e2fsprogs didnt make metadata_csums the default before version 1.44.0 (released in March 2018).</p><p>Over the last twenty years Ive only seen one hardware RAID controller which could be forced into checking parities at every read. Software implementations like Linux md-raid and LVM can also not be forced to do so. All you can do is to schedule regular parity scans of the full array, <code>but if the data gets silently corrupted between two scans</code> youve been working with it for a while. Congratulations.</p><h3 id="Openzfs-with-slient-error"><a href="#Openzfs-with-slient-error" class="headerlink" title="Openzfs with slient error"></a><a href="https://jira.whamcloud.com/browse/LU-10472">Openzfs with slient error</a></h3><p>Under the end to end not means the data full link path. just avoid slient error</p><p>The T10-PI checks (end therefore end-to-end) only apply to ldiskfs, not ZFS, correct?<br>Correct, ZFS does not implement T10-PI support. There is the old design for integrated end-to-end checksums from the client, which would use a similar, but more sophisticated, checksum method as the current T10 mechanism.</p><h3 id="script-for-raidz"><a href="#script-for-raidz" class="headerlink" title="script for raidz"></a>script for raidz</h3><p>by sas port</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ index=4; lsscsi -tiv | grep <span class="string">&quot;host0\/port-0:1&quot;</span> -B 1 | grep -vEi <span class="string">&#x27;dir|process|enclo|\-\-&#x27;</span>  | awk -v idx=<span class="variable">$&#123;index&#125;</span>  <span class="string">&#x27;&#123;if(NR%19==1 || NR==1) &#123; print &quot; &quot;;printf &quot;zpool create -f tank_&quot;idx&quot; raidz3 -O canmount=on -O xattr=sa -O acltype=posixacl -o ashift=9 -o multihost=on &quot;$(NF-1)&quot; &quot;;idx++&#125; else &#123;printf $(NF-1)&quot; &quot;&#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Extend-single-device-become-a-mirror"><a href="#Extend-single-device-become-a-mirror" class="headerlink" title="Extend single device become a mirror"></a>Extend single device become a mirror</h3><p>scsi-35001173d028c8c08 not in the mirror, it s dangerous</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ zpool status</span><br><span class="line">  pool: mdt_0</span><br><span class="line"> state: ONLINE</span><br><span class="line">  scan: scrub repaired 0B <span class="keyword">in</span> 1h35m with 0 errors on Tue Oct  1 01:35:20 2019</span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">NAME                        STATE     READ WRITE CKSUM</span><br><span class="line">mdt_0                       ONLINE       0     0     0</span><br><span class="line">  mirror-0                  ONLINE       0     0     0</span><br><span class="line">    sdb                     ONLINE       0     0     0</span><br><span class="line">    sdc                     ONLINE       0     0     0</span><br><span class="line">  scsi-35001173d028c8c08    ONLINE       0     0     0</span><br><span class="line">  mirror-2                  ONLINE       0     0     0</span><br><span class="line">    scsi-35001173d028c8740  ONLINE       0     0     0</span><br><span class="line">    scsi-35001173d028cb334  ONLINE       0     0     0</span><br><span class="line"></span><br><span class="line">errors: No known data errors</span><br><span class="line">$ zpool attach -f mdt_0 scsi-35001173d028c8c08 /dev/sdh</span><br><span class="line">$ zpool status -x</span><br><span class="line">  pool: mdt_0</span><br><span class="line"> state: ONLINE</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line"><span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Sun Jan 19 12:46:57 2020</span><br><span class="line">176M scanned out of 465G at 29.3M/s, 4h30m to go</span><br><span class="line">58.8M resilvered, 0.04% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">NAME                        STATE     READ WRITE CKSUM</span><br><span class="line">mdt_0                       ONLINE       0     0     0</span><br><span class="line">  mirror-0                  ONLINE       0     0     0</span><br><span class="line">    sdb                     ONLINE       0     0     0</span><br><span class="line">    sdc                     ONLINE       0     0     0</span><br><span class="line">  mirror-1                  ONLINE       0     0     0</span><br><span class="line">    scsi-35001173d028c8c08  ONLINE       0     0     0</span><br><span class="line">    sdh                     ONLINE       0     0     0  (resilvering)</span><br><span class="line">  mirror-2                  ONLINE       0     0     0</span><br><span class="line">    scsi-35001173d028c8740  ONLINE       0     0     0</span><br><span class="line">    scsi-35001173d028cb334  ONLINE       0     0     0</span><br><span class="line"></span><br><span class="line">errors: No known data errors</span><br></pre></td></tr></table></figure><h3 id="Add-special-device"><a href="#Add-special-device" class="headerlink" title="Add special device"></a>Add special device</h3><p>special<br>A device dedicated solely for allocating various kinds of internal metadata, and optionally small file blocks. The redundancy of this device should match the redundancy of the other normal devices in the pool. If more than one special device is specified, then allocations are load-balanced between those devices.<br>For more information on special allocations, see the Sx Special Allocation Class section.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zpool add <span class="variable">$POOLNAME</span> special mirror <span class="variable">$TMPDIR</span>/zpool&#123;4,5&#125;.dat</span><br></pre></td></tr></table></figure><h3 id="zpool-replace"><a href="#zpool-replace" class="headerlink" title="zpool replace"></a>zpool replace</h3><p>Plug out the wrong device, and re-plugin the device, you can t replace it , just online it  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ zpool replace -f tank_82 6957378459605677274 sden</span><br><span class="line">invalid vdev specification</span><br><span class="line">the following errors must be manually repaired:</span><br><span class="line">/dev/sden1 is part of active pool <span class="string">&#x27;tank_82&#x27;</span></span><br><span class="line"></span><br><span class="line">$ zpool online tank_82 6957378459605677274</span><br></pre></td></tr></table></figure><h3 id="Online-upgrade-SAS-device-firmware"><a href="#Online-upgrade-SAS-device-firmware" class="headerlink" title="Online upgrade SAS device firmware"></a>Online upgrade SAS device firmware</h3><p>unzip Dell XXX.EXE firmware, you could got TT53.fwh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ zpool offline tank scsi-35000c500c3f5c9f2</span><br><span class="line">$ lsscsi -gis | grep 35000c500c3f5c9f2</span><br><span class="line">[6:0:76:0]   disk    SEAGATE  ST10000NM0256    TT53  /dev/sdbu  35000c500c3f5c9f2  /dev/sg76  9.79TB</span><br><span class="line"></span><br><span class="line">$ shmlic list drives -enc = xxxxx -verbose</span><br><span class="line">5000c50003c9cd9d /dev/sg76                 SEAGATE                            ST10000NM0256            XXXXXXX     TT55      8.91TB          50050cc1628e1043 (EN-8435A-E6EBD)  TH0YF87JSGT0087401M5A00          26   00 / 26   6G   2018    NO   5000c500dd9da3b8, 0000000000000000</span><br><span class="line"></span><br><span class="line">$ shmcli update drive -d = 5000c50003c9cd9d -file = ./TT54.fwh</span><br><span class="line"></span><br><span class="line">update drive - Executing <span class="built_in">command</span>..</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA27NCHH) - File firmware version = TT54</span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA27NCHH) - Current drive firmware version = TT53</span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA27NCHH) - Sending firmware file to device.</span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA27NCHH) - Firmware successfully sent to drive.</span><br><span class="line">(SEAGATE / ST10000NM0256 / ZA27NCHH) - After update drive firmware version = TT54</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Drive Update Statistics:</span><br><span class="line">Total Drives Attempted : 1</span><br><span class="line">Successful Drive update count : 1</span><br><span class="line">FW File transfer failures : 0</span><br><span class="line">FW Update failures despite successful FW file transfer   : 0</span><br><span class="line">Unsupported Drive count (Non-Dell Drives) : 0</span><br><span class="line">Drives Incompatible with Firmware File : 0</span><br><span class="line">Drives skipped because drive is same version : 0</span><br><span class="line">Drives skipped because drive is newer version : 0</span><br><span class="line"></span><br><span class="line">$ ls -l | grep -v ata</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 25 14:22 host6 -&gt; ../../devices/pci0000:b2/0000:b2:00.0/0000:b3:00.0/host6/scsi_host/host6</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/block/sdbu/device/delete</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;0 76 0&quot;</span> &gt;  /sys/class/scsi_host/host6/scan</span><br><span class="line">$ lsscsi -gis | grep 35000c500c3f5c9f2</span><br><span class="line">[6:0:76:0]   disk    SEAGATE  ST10000NM0256    TT54  /dev/sdbu  35000c500c3f5c9f2  /dev/sg76  9.79TB</span><br><span class="line">$ zpool online tank  scsi-35000c500c3f5c9f2</span><br></pre></td></tr></table></figure><h3 id="Custom-packages"><a href="#Custom-packages" class="headerlink" title="Custom packages"></a><a href="https://openzfs.github.io/openzfs-docs/Developer%20Rebackup/Custom%20Packages.html">Custom packages</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install epel-release gcc make autoconf automake libtool rpm-build dkms libtirpc-devel libblkid-devel libuuid-devel libudev-devel openssl-devel zlib-devel libaio-devel libattr-devel elfutils-libelf-devel kernel-devel-$(uname -r) python python2-devel python-setuptools python-cffi libffi-devel</span><br><span class="line"></span><br><span class="line">$ sudo dnf install gcc make autoconf automake libtool rpm-build kernel-rpm-macros dkms libtirpc-devel libblkid-devel libuuid-devel libudev-devel openssl-devel zlib-devel libaio-devel libattr-devel elfutils-libelf-devel kernel-devel-$(uname -r) python3 python3-devel python3-setuptools python3-cffi libffi-devel</span><br><span class="line"></span><br><span class="line"><span class="comment">### DKMS</span></span><br><span class="line">$ <span class="built_in">cd</span> zfs</span><br><span class="line">$ ./configure</span><br><span class="line">$ make -j1 rpm-utils rpm-dkms</span><br><span class="line">$ sudo yum localinstall *.$(uname -p).rpm *.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">### kmod</span></span><br><span class="line">$ <span class="built_in">cd</span> zfs</span><br><span class="line">$ ./configure</span><br><span class="line">$ make -j1 rpm-utils rpm-kmod</span><br><span class="line">$ sudo yum localinstall *.$(uname -p).rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">### kABI-tracking kmod</span></span><br><span class="line">$ <span class="built_in">cd</span> zfs</span><br><span class="line">$ ./configure --with-spec=redhat</span><br><span class="line">$ make -j1 rpm-utils rpm-kmod</span><br><span class="line">$ sudo yum localinstall *.$(uname -p).rpm</span><br></pre></td></tr></table></figure><h3 id="Backup-zpool"><a href="#Backup-zpool" class="headerlink" title="Backup zpool"></a>Backup zpool</h3><p><a href="https://github.com/openzfs/zfs/issues/8458">send recv slow issue</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">-L   Generate  a  stream <span class="built_in">which</span> may contain blocks larger than 128KB.  This flag has no effect <span class="keyword">if</span> the large_blocks pool feature is disabled, or <span class="keyword">if</span> the recordsize property of this filesystem has never been <span class="built_in">set</span> above 128KB.  The receiving system must have the large_blocks pool feature enabled as well.  See zpool-features(5) <span class="keyword">for</span> details on ZFS feature flags and the large_blocks feature.  </span><br><span class="line"></span><br><span class="line">A $ umount /lfs/test_mgt /lfs/test_mdt</span><br><span class="line">A $ zfs snapshot test0_mdt/test_mgt@20200529-1</span><br><span class="line">A $ zfs snapshot test0_mdt/test_mdt@20200529-1</span><br><span class="line">A $ zfs send -Rp test0_mdt/test_mdt@20200529-1 &gt; <span class="string">&quot;/nfshare/test0_mdt_test_mdt@20200529-1&quot;</span></span><br><span class="line">A $ zfs send -Rp test0_mdt/test_mgt@20200529-1 &gt; <span class="string">&quot;/nfshare/test0_mdt_test_mgt@20200529-1&quot;</span></span><br><span class="line"></span><br><span class="line">B $ zfs create test0_backup/test_mgt</span><br><span class="line">B $ zfs create test0_backup/test_mdt</span><br><span class="line">B $ zfs receive -F test0_backup/test_mgt &lt; test0_mdt_test_mgt@20200529-1</span><br><span class="line">B $ dd <span class="keyword">if</span>=test0_mdt_test_mdt\@20200529-1 bs=1M | zfs recv -F test0_backup/test_mdt</span><br><span class="line">577+1 records <span class="keyword">in</span></span><br><span class="line">577+1 records out</span><br><span class="line">605602396 bytes (606 MB) copied, 2340.37 s, 259 kB/s</span><br><span class="line"></span><br><span class="line">B $ mount.lfs test0_backup/test_mgt /lfs/test_mgt</span><br><span class="line">mount.lfs: test0_backup/test_mgt is configured <span class="keyword">for</span> failover but zpool does not have multihost enabled</span><br><span class="line">mount.lfs: test0_backup/test_mgt is configured <span class="keyword">for</span> failover but zpool does not have multihost enabled</span><br><span class="line">mount.lfs: test0_backup/test_mgt is configured <span class="keyword">for</span> failover but zpool does not have multihost enabled</span><br><span class="line">B $ mount.lfs test0_backup/test_mdt /lfs/test_mdt</span><br><span class="line">mount.lfs: test0_backup/test_mdt is configured <span class="keyword">for</span> failover but zpool does not have multihost enabled</span><br><span class="line">mount.lfs: test0_backup/test_mdt is configured <span class="keyword">for</span> failover but zpool does not have multihost enabled</span><br><span class="line">mount.lfs: test0_backup/test_mdt is configured <span class="keyword">for</span> failover but zpool does not have multihost enabled</span><br><span class="line"></span><br><span class="line">test0_backup/test_mgt      lfs    287G  2.8M  287G   1% /lfs/test_mgt</span><br><span class="line">test0_backup/test_mdt      lfs    287G  196M  287G   1% /lfs/test_mdt</span><br><span class="line"></span><br><span class="line"><span class="comment"># the server B create a snapshot, if not you could create it</span></span><br><span class="line">B $ zfs  list -t snapshot</span><br><span class="line">NAME                               USED  AVAIL  REFER  MOUNTPOINT</span><br><span class="line">test0_backup/test_mdt@20200529-1   488K      -   174M  -</span><br></pre></td></tr></table></figure><p>write new data from the client</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">B $ zfs snapshot test0_backup/<span class="symbol">test_mdt@</span><span class="number">20200529</span><span class="number">-2</span></span><br><span class="line">B $ zfs  list -t snapshot</span><br><span class="line">NAME                               USED  AVAIL  REFER  MOUNTPOINT</span><br><span class="line">test0_backup/<span class="symbol">test_mdt@</span><span class="number">20200529</span><span class="number">-1</span>   <span class="number">488</span>K      -   <span class="number">174</span>M  -</span><br><span class="line">test0_backup/<span class="symbol">test_mdt@</span><span class="number">20200529</span><span class="number">-2</span>     <span class="number">0</span>B      -   <span class="number">305</span>M  -</span><br><span class="line"></span><br><span class="line">B $ zfs send -p -i test0_backup/<span class="symbol">test_mdt@</span><span class="number">20200529</span><span class="number">-1</span> test0_backup/<span class="symbol">test_mdt@</span><span class="number">20200529</span><span class="number">-2</span> &gt; /nfshare/test0_mdt_test_mdt\@<span class="number">20200529</span>-<span class="keyword">from</span><span class="number">-1</span>-to<span class="number">-2</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">import</span> to server A</span><br><span class="line">A $ zfs receive -dF test0_mdt/test_mdt &lt; test0_mdt_test_mdt\@<span class="number">20200529</span>-<span class="keyword">from</span><span class="number">-1</span>-to<span class="number">-2</span></span><br><span class="line">A $ zfs list -t snapshot</span><br><span class="line">NAME                            USED  AVAIL  REFER  MOUNTPOINT</span><br><span class="line">test0_mdt/<span class="symbol">test_mdt@</span><span class="number">20200529</span><span class="number">-1</span>   <span class="number">498</span>K      -   <span class="number">174</span>M  -</span><br><span class="line">test0_mdt/<span class="symbol">test_mdt@</span><span class="number">20200529</span><span class="number">-2</span>     <span class="number">0</span>B      -   <span class="number">305</span>M  -</span><br><span class="line">test0_mdt/<span class="symbol">test_mgt@</span><span class="number">20200529</span><span class="number">-1</span>    <span class="number">62</span>K      -  <span class="number">2.72</span>M  -</span><br></pre></td></tr></table></figure><p>In the client, you could see the modified files</p><h4 id="Import-zpool-hang-single-dev-just-respond-very-slow-cause-all-zpool-command-hang"><a href="#Import-zpool-hang-single-dev-just-respond-very-slow-cause-all-zpool-command-hang" class="headerlink" title="Import zpool hang, single dev just respond very slow cause all zpool command hang"></a>Import zpool hang, single dev just respond very slow cause all zpool command hang</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/block/sddh/device/delete</span><br><span class="line"><span class="comment">### remove the dev, all has been imported</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## issue log</span></span><br><span class="line">$ lsscsi -git  | grep sg118</span><br><span class="line">[17:0:116:0] disk    sas:0x5000c500a65b61f1          /dev/sddh  35000c500a65b61f3  /dev/sg118</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: Attached scsi generic sg178 <span class="built_in">type</span> 0</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: [sdfm] Enabling DIF Type 2 protection</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: [sdfm] 19134414848 512-byte logical blocks: (9.79 TB/8.91 TiB)</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: [sdfm] 4096-byte physical blocks</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: [sdfm] Write Protect is off</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: [sdfm] Mode Sense: d7 00 10 08</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: [sdfm] Write cache: enabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">[Sun Sep 23 11:03:43 2018]  sdfm: sdfm1 sdfm9</span><br><span class="line">[Sun Sep 23 11:03:43 2018] sd 17:0:176:0: [sdfm] Attached SCSI disk</span><br><span class="line">[Sun Sep 23 11:03:44 2018] scsi 17:0:177:0: Attached scsi generic sg179 <span class="built_in">type</span> 3</span><br><span class="line">[Sun Sep 23 11:07:09 2018] sd 17:0:116:0: attempting task abort! scmd(ffff88100abf2f40)</span><br><span class="line">[Sun Sep 23 11:07:09 2018] sd 17:0:116:0: [sg118] CDB: Inquiry 12 01 dc 01 52 00</span><br><span class="line">[Sun Sep 23 11:07:09 2018] scsi target17:0:116: handle(0x0087), sas_address(0x5000c500a65b61f1), phy(34)</span><br><span class="line">[Sun Sep 23 11:07:09 2018] scsi target17:0:116: enclosure_logical_id(0x50050cc11ac01572), slot(56)</span><br><span class="line">[Sun Sep 23 11:07:09 2018] sd 17:0:116:0: task abort: SUCCESS scmd(ffff88100abf2f40)</span><br><span class="line">[Sun Sep 23 11:07:09 2018] sd 17:0:116:0: attempting task abort! scmd(ffff880fe9784ec0)</span><br><span class="line">[Sun Sep 23 11:07:09 2018] sd 17:0:116:0: [sg118] CDB: Inquiry 12 01 dc 01 52 00</span><br><span class="line">[Sun Sep 23 11:07:09 2018] scsi target17:0:116: handle(0x0087), sas_address(0x5000c500a65b61f1), phy(34)</span><br><span class="line">[Sun Sep 23 11:07:09 2018] scsi target17:0:116: enclosure_logical_id(0x50050cc11ac01572), slot(56)</span><br><span class="line">[Sun Sep 23 11:07:09 2018] sd 17:0:116:0: task abort: SUCCESS scmd(ffff880fe9784ec0)</span><br><span class="line">[Sun Sep 23 11:07:58 2018] INFO: task zpool:3155 blocked <span class="keyword">for</span> more than 120 seconds.</span><br><span class="line">[Sun Sep 23 11:07:58 2018] <span class="string">&quot;echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs&quot;</span> disables this message.</span><br><span class="line">[Sun Sep 23 11:07:58 2018] zpool           D ffffffffc0ade588     0  3155   3152 0x00000084</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffff881011267ce0 0000000000000082 ffff881025d0cf10 ffff881011267fd8</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffff881011267fd8 ffff881011267fd8 ffff881025d0cf10 ffffffffc0ade580</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffffffffc0ade584 ffff881025d0cf10 00000000ffffffff ffffffffc0ade588</span><br><span class="line">[Sun Sep 23 11:07:58 2018] Call Trace:</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816aa489&gt;] schedule_preempt_disabled+0x29/0x70</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816a83b7&gt;] __mutex_lock_slowpath+0xc7/0x1d0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816a77cf&gt;] mutex_lock+0x1f/0x2f</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc08d0744&gt;] spa_import+0x54/0x730 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc062cfc2&gt;] ? nvlist_lookup_common.part.71+0xa2/0xb0 [znvpair]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc090bc37&gt;] zfs_ioc_pool_import+0x147/0x160 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc0910846&gt;] zfsdev_ioctl+0x606/0x650 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff812151bd&gt;] do_vfs_ioctl+0x33d/0x540</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816b0091&gt;] ? __do_page_fault+0x171/0x450</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff81215461&gt;] SyS_ioctl+0xa1/0xc0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816b5089&gt;] system_call_fastpath+0x16/0x1b</span><br><span class="line">[Sun Sep 23 11:07:58 2018] INFO: task zpool:3157 blocked <span class="keyword">for</span> more than 120 seconds.</span><br><span class="line">[Sun Sep 23 11:07:58 2018] <span class="string">&quot;echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs&quot;</span> disables this message.</span><br><span class="line">[Sun Sep 23 11:07:58 2018] zpool           D ffffffffc0ade588     0  3157   3153 0x00000084</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffff881011283c60 0000000000000086 ffff88103b1fdee0 ffff881011283fd8</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffff881011283fd8 ffff881011283fd8 ffff88103b1fdee0 ffffffffc0ade580</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffffffffc0ade584 ffff88103b1fdee0 00000000ffffffff ffffffffc0ade588</span><br><span class="line">[Sun Sep 23 11:07:58 2018] Call Trace:</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816aa489&gt;] schedule_preempt_disabled+0x29/0x70</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816a83b7&gt;] __mutex_lock_slowpath+0xc7/0x1d0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816a77cf&gt;] mutex_lock+0x1f/0x2f</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc08cee41&gt;] spa_open_common+0x61/0x4d0 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff8118cb26&gt;] ? __alloc_pages_nodemask+0x176/0x420</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc08cf334&gt;] spa_get_stats+0x54/0x550 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc06021a0&gt;] ? spl_kmem_zalloc+0xc0/0x170 [spl]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff811ddbee&gt;] ? __kmalloc_node+0x27e/0x2b0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc090c019&gt;] zfs_ioc_pool_stats+0x39/0x90 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc0910846&gt;] zfsdev_ioctl+0x606/0x650 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff812151bd&gt;] do_vfs_ioctl+0x33d/0x540</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816b0091&gt;] ? __do_page_fault+0x171/0x450</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff81215461&gt;] SyS_ioctl+0xa1/0xc0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816b5089&gt;] system_call_fastpath+0x16/0x1b</span><br><span class="line">[Sun Sep 23 11:07:58 2018] INFO: task zpool:3159 blocked <span class="keyword">for</span> more than 120 seconds.</span><br><span class="line">[Sun Sep 23 11:07:58 2018] <span class="string">&quot;echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs&quot;</span> disables this message.</span><br><span class="line">[Sun Sep 23 11:07:58 2018] zpool           D ffffffffc0ade588     0  3159   3156 0x00000084</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffff88101128bc60 0000000000000086 ffff88102fb3af70 ffff88101128bfd8</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffff88101128bfd8 ffff88101128bfd8 ffff88102fb3af70 ffffffffc0ade580</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  ffffffffc0ade584 ffff88102fb3af70 00000000ffffffff ffffffffc0ade588</span><br><span class="line">[Sun Sep 23 11:07:58 2018] Call Trace:</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816aa489&gt;] schedule_preempt_disabled+0x29/0x70</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816a83b7&gt;] __mutex_lock_slowpath+0xc7/0x1d0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816a77cf&gt;] mutex_lock+0x1f/0x2f</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc08cee41&gt;] spa_open_common+0x61/0x4d0 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff8118cb26&gt;] ? __alloc_pages_nodemask+0x176/0x420</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc08cf334&gt;] spa_get_stats+0x54/0x550 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc06021a0&gt;] ? spl_kmem_zalloc+0xc0/0x170 [spl]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff811ddbee&gt;] ? __kmalloc_node+0x27e/0x2b0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc090c019&gt;] zfs_ioc_pool_stats+0x39/0x90 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffffc0910846&gt;] zfsdev_ioctl+0x606/0x650 [zfs]</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff812151bd&gt;] do_vfs_ioctl+0x33d/0x540</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816b0091&gt;] ? __do_page_fault+0x171/0x450</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff81215461&gt;] SyS_ioctl+0xa1/0xc0</span><br><span class="line">[Sun Sep 23 11:07:58 2018]  [&lt;ffffffff816b5089&gt;] system_call_fastpath+0x16/0x1b</span><br><span class="line">[Sun Sep 23 11:07:58 2018] INFO: task z_zvol:5492 blocked <span class="keyword">for</span> more than 120 seconds.</span><br></pre></td></tr></table></figure><h4 id="OpenZFS-multihost-writes-failed-about-Invalid-DWORD-count"><a href="#OpenZFS-multihost-writes-failed-about-Invalid-DWORD-count" class="headerlink" title="OpenZFS multihost writes failed (about Invalid DWORD count)"></a>OpenZFS multihost writes failed (about Invalid DWORD count)</h4><pre><code>Invalid DWORD count = 124Loss of DWORD synchronization = 31</code></pre><p><a href="//www.c0t0d0s0.org/archives/7601-Check-both-sides-or-Errors-on-the-SAN.html">The interesting part is the highlighted one. A massive increase in invalid tx word count. When you see an massively increased counter here, your HBA just received rubbish from the storage. I never saw a different reason for this than a problem between the interface to the optics on the HBA and the interface to the optics on the switch ranging from not properly seated transceivers to blatant cases of ignoring the minimum bending radius of the fibre optic cables.</a></p><p>Suggestions to the customer based on the rule check cheapest solution first:<br>reseat cables<br>reseat transceivers<br>use a new cable<br>use new transceivers </p><h3 id="Openzip-direct-IO"><a href="#Openzip-direct-IO" class="headerlink" title="Openzip direct IO"></a><a href="https://github.com/openzfs/zfs/pull/10018">Openzip direct IO</a></h3><p>directio &lt;off,on,strict,legacy&gt;<br>off - Do not accept O_DIRECT flag<br>on - Accept O_DIRECT flag and possibly bypass ARC<br>(will bypass base on directio_write/read_align SEE BELOW)<br>strict - Accept O_DIRECT flag and always bypass ARC<br>(may fail based on directio_write/read_align SEE BELOW)<br>legacy - Accept O_DIRECT flag and always use ARC</p><p>directio=standard | always | disabled<br>where standard means: if you request DIRECTIO, well do it directly if we think its a good idea (e.g. writes are recordsize-aligned), and otherwise well do the i/o non-directly (we wont fail it for poor alignment). This is the default.<br>always means act like DIRECTIO was always requested (may be actually direct or indirect depending on i/o alignment, wont fail for poor alignment).<br>disabled means act like DIRECTIO was never requested (which is the current behavior).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This means that DIRECTIO writes will be spread out among the vdevs using the old round-robin algorithm. This could potentially result <span class="keyword">in</span> poor performance due to allocating from the slowest / most fragmented vdev, and we could potentially make the vdevs even more imbalanced (at least <span class="keyword">in</span> terms of performance/fragmentation). @grwilson <span class="keyword">do</span> you have any thoughts on this? How big the impact could be, and potential ways to mitigate? Could we make this use the throttle?</span><br></pre></td></tr></table></figure><h3 id="Performance-tuning"><a href="#Performance-tuning" class="headerlink" title="Performance tuning"></a><a href="https://github.com/openzfs/zfs/issues/8381">Performance tuning</a></h3><p>zio_dva_throttle_enabled - Throttle block allocations in the ZIO pipeline<br>zfs_vdev_queue_depth_pct - Queue depth percentage for each top-level vdev<br>increase the default value for high throuhput system  or disable zio_dva_throttle_enabled</p><p>zfs_vdev_sync_read_max_active<br>zfetch_max_distance<br>zfs_vdev_max_active<br>zfs_commit_timeout_pct<br>controls the amount of time that a log (ZIL) write block (lwb) remains open when it isnt full and it has a thread waiting to commit to stable storage. The timeout is scaled based on a percentage of the last lwb latency to avoid significantly impacting the latency of each individual intent log transaction (itx).</p><p>zfs_prefetch_disable<br>primarycache</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yes I tried setting the primarycache to just metadata and disabling prefetching. Neither had any effect. Even <span class="keyword">if</span> we are not caching the <span class="keyword">in</span> ARC, the data is still being copied into a ZFS buffer. This is <span class="built_in">where</span> the copy penalty comes from</span><br><span class="line"> there is no reason to <span class="built_in">test</span> with Direct IO <span class="keyword">in</span> 0.8.2. Up to this point, with all 0.8.x releases, Direct IO support merely allows <span class="keyword">for</span> the O_DIRECT flag to be accepted. However, <span class="keyword">while</span> accepting the flag it just sends the reads/writes down the normal ZFS paths. This means a data copy is still made <span class="keyword">in</span> the ZFS software stack. </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>In general, smaller max_actives will lead to lower latency of synchronous operations.  Larger max_actives may lead to higher overall throughput, depending on underlying storage.<br>The ratio of the queues max_actives determines the balance of performance between reads, writes,  and  scrubs.<br>E.g., increasing zfs_vdev_scrub_max_active will cause the scrub or resilver to complete more quickly, but reads and writes to have higher latency and lower throughput.</p><p>Async Writes<br>The number of concurrent operations issued for the async write I/O class follows a piece-wise  linear  function defined by a few adjustable points.</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">       |<span class="string">              o---------</span>|<span class="string"> &lt;-- zfs_vdev_async_write_max_active</span></span><br><span class="line"><span class="string">  ^    </span>|<span class="string">             /^         </span>|</span><br><span class="line">  |<span class="string">    </span>|<span class="string">            / </span>|<span class="string">         </span>|</span><br><span class="line">active |<span class="string">           /  </span>|<span class="string">         </span>|</span><br><span class="line"> I/O   |<span class="string">          /   </span>|<span class="string">         </span>|</span><br><span class="line">count  |<span class="string">         /    </span>|<span class="string">         </span>|</span><br><span class="line">       |<span class="string">        /     </span>|<span class="string">         </span>|</span><br><span class="line">       |<span class="string">-------o      </span>|<span class="string">         </span>|<span class="string"> &lt;-- zfs_vdev_async_write_min_active</span></span><br><span class="line"><span class="string">      0</span>|<span class="string">_______^______</span>|<span class="string">_________</span>|</span><br><span class="line">       0%      |<span class="string">      </span>|<span class="string">       100% of zfs_dirty_data_max</span></span><br><span class="line"><span class="string">               </span>|<span class="string">      </span>|</span><br><span class="line">               |<span class="string">      -- zfs_vdev_async_write_active_max_dirty_percent</span></span><br><span class="line"><span class="string">               --------- zfs_vdev_async_write_active_min_dirty_percent</span></span><br></pre></td></tr></table></figure><p>Until  the  amount  of  dirty  data exceeds a minimum percentage of the dirty data allowed in the pool, the I/O scheduler will limit the number of concurrent operations to the minimum. As that threshold is crossed, the num-ber  of  concurrent  operations issued increases linearly to the maximum at the specified maximum percentage of the dirty data allowed in the pool.</p><p>Ideally, the amount of dirty data on a busy pool  will  stay  in  the  sloped  part  of  the  function  between zfs_vdev_async_write_active_min_dirty_percent  and zfs_vdev_async_write_active_max_dirty_percent. If it exceeds the maximum percentage, this indicates that the rate of incoming data is greater than the rate that the backend storage can handle. In this case, we must further throttle incoming writes, as described in the next section.</p><p>The minimum time for a transaction to take is calculated as:<br>           min_time = zfs_delay_scale * (dirty - min) / (max - dirty)<br>           min_time is then capped at 100 milliseconds.</p><p>The  delay has two degrees of freedom that can be adjusted via tunables.  The percentage of dirty data at which we  start  to  delay  is  defined  by  zfs_delay_min_dirty_percent.  This  should  typically  be  at  or  above zfs_vdev_async_write_active_max_dirty_percent  so  that  we only start to delay after writing at full speed has failed to keep up with the incoming write rate.<br>The scale of the curve is defined by  zfs_delay_scale.  Roughly speaking, this variable determines the amount of delay at the midpoint of the curve.</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat zfs_vdev_async_write_active_min_dirty_percent zfs_vdev_async_write_active_max_dirty_percent zfs_delay_min_dirty_percent zfs_delay_scale</span><br><span class="line"><span class="number">30</span></span><br><span class="line"><span class="number">60</span></span><br><span class="line"><span class="number">60</span></span><br><span class="line"><span class="number">500000</span></span><br><span class="line"></span><br><span class="line">$ cat zfs_dirty_data_max</span><br><span class="line"><span class="number">4294967296</span></span><br></pre></td></tr></table></figure><p>note  that since the delay is added to the outstanding time remaining on the most recent transaction, the delay is effectively the inverse of IOPS.  Here the midpoint of 500us translates to 2000 IOPS. The shape of the curve was chosen such that small changes in the amount of accumulated dirty data in the first 3/4 of the curve yield relatively small differences in the amount of delay.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">delay</span><br><span class="line">100ms +-------------------------------------------------------------++</span><br><span class="line">      +                                                              +</span><br><span class="line">      |                                                              |</span><br><span class="line">      +                                                             *+</span><br><span class="line"> 10ms +                                                             *+</span><br><span class="line">      +                                                           ** +</span><br><span class="line">      |                                              (midpoint)  **  |</span><br><span class="line">      +                                                  |     **    +</span><br><span class="line">  1ms +                                                  v ****      +</span><br><span class="line">      +             zfs_delay_scale ----------&gt;        *****         +</span><br><span class="line">      |                                             ****             |</span><br><span class="line">      +                                          ****                +</span><br><span class="line">100us +                                        **                    +</span><br><span class="line">      +                                       *                      +</span><br><span class="line">      |                                      *                       |</span><br><span class="line">      +                                     *                        +</span><br><span class="line"> 10us +                                     *                        +</span><br><span class="line">      +                                                              +</span><br><span class="line">      |                                                              |</span><br><span class="line">      +                                                              +</span><br><span class="line">      +--------------------------------------------------------------+</span><br><span class="line">      0%                    &lt;- zfs_dirty_data_max -&gt;               100%</span><br></pre></td></tr></table></figure><p>Note here that only as the amount of dirty data approaches its limit does the delay start to increase  rapidly. The  goal  of  a  properly  tuned  system should be to keep the amount of dirty data out of that range by first ensuring that the appropriate limits are set for the I/O scheduler to reach optimal throughput on  the  backend storage, and then by changing the value of zfs_delay_scale to increase the steepness of the curve.</p><p>set spl_taskq_thread_dynamic to 0<br>This will disable all of the dynamic task queues and statistically allocate the threads.</p><p>Test case:<br>10 x SAS/SATA mix HDD in single raidz2 zpool, 32 x rsync copy data from another dir in this zpool </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">              capacity     operations     bandwidth</span><br><span class="line">pool        alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank        47.4T  41.7T  1.06K    398  24.5M  17.9M</span><br><span class="line">tank        47.4T  41.7T  9.01K  7.96K   193M   158M</span><br><span class="line">tank        47.4T  41.7T  9.77K  8.08K   182M   162M</span><br><span class="line">tank        47.4T  41.7T  7.88K  6.32K   178M   195M</span><br><span class="line">tank        47.4T  41.7T  7.36K  6.70K   175M   152M</span><br><span class="line">tank        47.4T  41.7T  8.05K  6.81K   155M   140M</span><br><span class="line">tank        47.4T  41.7T  9.16K  9.10K   166M   182M</span><br><span class="line">tank        47.4T  41.7T  5.97K  4.30K   187M   402M</span><br><span class="line">tank        47.4T  41.7T  8.24K    739   210M   365M</span><br><span class="line">tank        47.4T  41.7T  10.8K  14.0K   180M   254M</span><br><span class="line">tank        47.4T  41.7T  9.93K  7.43K   205M   163M</span><br><span class="line">tank        47.4T  41.7T  8.97K  7.35K   181M   150M</span><br><span class="line">tank        47.4T  41.7T  9.05K  7.52K   169M   159M</span><br><span class="line">tank        47.4T  41.7T  9.34K  8.06K   160M   160M</span><br><span class="line">tank        47.4T  41.7T  8.98K  8.34K   161M   168M</span><br><span class="line">tank        47.4T  41.7T  8.85K  8.29K   182M   177M</span><br><span class="line">tank        47.4T  41.7T  9.03K  9.27K   188M   188M</span><br><span class="line">tank        47.4T  41.7T  8.35K  9.36K   209M   206M</span><br><span class="line">tank        47.4T  41.7T  7.71K  9.22K   165M   229M</span><br><span class="line">tank        47.4T  41.7T  3.89K  7.69K  93.9M   158M</span><br><span class="line">tank        47.4T  41.7T  3.48K  6.78K  56.1M   127M</span><br><span class="line">tank        47.4T  41.7T  6.49K  15.5K   105M   288M</span><br><span class="line">tank        47.4T  41.7T  10.0K  8.16K   162M   202M</span><br><span class="line">tank        47.4T  41.7T  10.2K  8.77K   171M   175M</span><br><span class="line">tank        47.4T  41.7T  10.2K  7.86K   168M   169M</span><br><span class="line">tank        47.4T  41.7T  9.84K  7.74K   163M   155M</span><br><span class="line">tank        47.4T  41.7T  7.48K  6.02K   177M   208M</span><br><span class="line">tank        47.4T  41.7T  9.54K  6.80K   169M   140M</span><br><span class="line">tank        47.4T  41.7T  10.0K  8.44K   171M   190M</span><br><span class="line">tank        47.4T  41.7T  9.56K  7.94K   168M   167M</span><br><span class="line">tank        47.4T  41.7T  9.52K  7.69K   168M   155M</span><br><span class="line">tank        47.4T  41.7T  8.13K  10.5K   139M   225M</span><br><span class="line">tank        47.4T  41.7T  5.04K  11.0K  80.8M   215M</span><br><span class="line">tank        47.4T  41.7T  3.24K  8.40K  58.7M   149M</span><br><span class="line">tank        47.4T  41.7T  6.61K  11.6K   128M   244M</span><br><span class="line">tank        47.4T  41.7T  8.39K  6.01K   157M   169M</span><br><span class="line">tank        47.4T  41.7T  9.09K  7.57K   149M   160M</span><br><span class="line">tank        47.4T  41.7T  7.62K  6.03K   151M   123M</span><br><span class="line">tank        47.4T  41.7T  9.06K  9.47K   159M   209M</span><br><span class="line">tank        47.4T  41.7T  10.3K  8.52K   186M   198M</span><br><span class="line">tank        47.4T  41.7T  10.1K  8.27K   182M   177M</span><br><span class="line">tank        47.4T  41.7T  8.11K  7.67K   165M   187M</span><br></pre></td></tr></table></figure><p>Read and write are slow, all stack show the read is slow, looks like the zfs parameter was wrong (not default).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># after modify the zfs parameter, increase the read and write throughput </span></span><br><span class="line">$ cat zfs_vdev_async_read_max_active zfs_vdev_async_read_min_active zfs_vdev_async_write_active_max_dirty_percent zfs_vdev_async_write_active_min_dirty_percent zfs_vdev_async_write_max_active zfs_vdev_async_write_min_active</span><br><span class="line">20</span><br><span class="line">2</span><br><span class="line">120</span><br><span class="line">60</span><br><span class="line">10</span><br><span class="line">1</span><br><span class="line">$ <span class="built_in">echo</span> 8589934592 &gt; zfs_dirty_data_max</span><br><span class="line">tank        47.7T  41.4T  2.84K  1.12K   525M  1.02G</span><br><span class="line">tank        47.7T  41.4T  6.32K     23  1023M  23.1M</span><br><span class="line">tank        47.7T  41.4T  6.20K    140   920M  8.98M</span><br><span class="line">tank        47.7T  41.3T  2.76K  1.64K   242M  1.44G</span><br><span class="line">tank        47.7T  41.3T  5.71K    939   471M   785M</span><br><span class="line">tank        47.7T  41.3T  5.03K    470   777M   297M</span><br><span class="line">tank        47.7T  41.3T  3.51K  1.14K   445M  1.05G</span><br><span class="line">tank        47.7T  41.3T  6.19K     88   991M  1.42M</span><br><span class="line">tank        47.8T  41.3T    959  1.70K   193M  1.60G</span><br><span class="line">tank        47.8T  41.3T  5.72K    228   930M  58.1M</span><br><span class="line">tank        47.8T  41.3T  2.15K  1.33K   301M  1.12G</span><br><span class="line">tank        47.8T  41.3T  5.90K    316   895M   237M</span><br><span class="line">tank        47.8T  41.3T  3.48K  1.04K   439M   834M</span><br><span class="line">tank        47.8T  41.3T  3.83K    927   606M   860M</span><br><span class="line">tank        47.8T  41.3T  5.15K    397   822M   214M</span><br><span class="line">tank        47.8T  41.3T  3.02K  1.17K   446M  1.05G</span><br><span class="line">tank        47.8T  41.3T  5.99K    243   940M  71.8M</span><br><span class="line">tank        47.8T  41.3T  2.57K  1.32K   312M  1.21G</span><br><span class="line">tank        47.8T  41.3T  4.48K    765   746M   522M</span><br><span class="line">tank        47.8T  41.3T  4.90K    781   642M   551M</span><br><span class="line">tank        47.8T  41.3T  2.94K  1.17K   487M  1.04G</span><br><span class="line">tank        47.8T  41.3T  6.25K    242   889M  51.1M</span><br><span class="line">              capacity     operations     bandwidth</span><br><span class="line">pool        alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank        47.8T  41.3T  2.96K  1.20K   373M  1.01G</span><br><span class="line">tank        47.8T  41.3T  5.10K    761   694M   656M</span><br><span class="line">tank        47.8T  41.3T  6.78K    610   571M   415M</span><br><span class="line">tank        47.8T  41.3T  4.46K    787   649M   663M</span><br><span class="line">tank        47.8T  41.3T  5.47K    500   670M   410M</span><br><span class="line">tank        47.8T  41.3T  3.48K  1.00K   500M   783M</span><br><span class="line">tank        47.8T  41.3T  3.82K    856   493M   660M</span><br><span class="line">tank        47.8T  41.3T  3.71K  1.08K   515M   997M</span><br><span class="line">tank        47.8T  41.3T  5.93K    247   826M  73.9M</span><br><span class="line">tank        47.8T  41.3T  3.34K  1.21K   465M  1.05G</span><br><span class="line">tank        47.8T  41.3T  5.26K    608   748M   422M</span><br><span class="line">tank        47.8T  41.3T  5.70K    834   509M   652M</span><br><span class="line">tank        47.8T  41.3T  3.62K    875   622M   814M</span><br><span class="line">tank        47.8T  41.3T  6.32K    439   758M   258M</span><br><span class="line">tank        47.8T  41.3T  2.89K  1.32K   409M  1.05G</span><br><span class="line">tank        47.8T  41.3T  5.86K    609   792M   455M</span><br><span class="line">tank        47.8T  41.3T  4.62K    834   565M   619M</span><br><span class="line">tank        47.8T  41.3T  3.34K  1.17K   480M  1.05G</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable single SATA driver write cache /dev/sdl cause the big fluctuation</span></span><br><span class="line">              capacity     operations     bandwidth</span><br><span class="line">pool        alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank        47.4T  41.7T  19.5K    503   430M   485M</span><br><span class="line">tank        47.4T  41.7T  22.1K    571   440M   572M</span><br><span class="line">tank        47.4T  41.7T  22.5K    534   424M   533M</span><br><span class="line">tank        47.4T  41.7T  6.02K  1.18K   250M  1.18G</span><br><span class="line">tank        47.4T  41.7T  10.2K     64   777M  64.2M</span><br><span class="line">tank        47.4T  41.7T  15.2K    468   336M   117M</span><br><span class="line">tank        47.4T  41.7T  3.86K  1.63K   229M  1.49G</span><br><span class="line">tank        47.4T  41.7T    576  1.85K  56.5M  1.84G</span><br><span class="line">tank        47.4T  41.7T  6.56K    334   537M   324M</span><br><span class="line">tank        47.4T  41.7T  9.41K      6   997M  6.50M</span><br><span class="line">tank        47.4T  41.7T  8.39K      7   976M  6.88M</span><br><span class="line">tank        47.4T  41.7T  2.08K     73  79.4M  68.6M</span><br><span class="line">tank        47.4T  41.7T     12     81  63.9K  76.8M</span><br><span class="line">tank        47.4T  41.7T     16    105  65.9K  68.3M</span><br><span class="line">tank        47.4T  41.7T  2.35K  1.74K   196M  1.36G</span><br><span class="line">tank        47.4T  41.7T  2.49K  1.48K   229M  1.46G</span><br><span class="line">tank        47.4T  41.7T  7.59K     16   834M  16.0M</span><br><span class="line">tank        47.4T  41.7T  8.46K      7  1009M  7.50M</span><br><span class="line">tank        47.4T  41.7T  8.80K      6   985M  6.49M</span><br><span class="line">tank        47.4T  41.7T  5.65K    168   119M   166M</span><br><span class="line">tank        47.4T  41.7T  12.2K    862   386M   429M</span><br><span class="line">tank        47.4T  41.7T  1.19K  1.91K   109M  1.75G</span><br><span class="line">tank        47.4T  41.7T  3.19K  1.43K   219M  1.42G</span><br><span class="line">tank        47.4T  41.7T  8.27K     20  1.01G  16.1M</span><br><span class="line">tank        47.4T  41.7T  6.76K     23   833M  18.6M</span><br><span class="line">tank        47.4T  41.7T  8.90K     17   841M  17.5M</span><br><span class="line">tank        47.4T  41.7T  8.28K    144   141M   136M</span><br><span class="line">tank        47.4T  41.7T  5.96K  1.30K   283M   749M</span><br><span class="line">tank        47.4T  41.7T    522  1.84K  65.3M  1.83G</span><br><span class="line">tank        47.4T  41.7T  6.07K    804   575M   802M</span><br><span class="line">tank        47.4T  41.7T  7.62K     23   865M  18.6M</span><br><span class="line">tank        47.4T  41.7T  8.69K     19   983M  15.1M</span><br><span class="line">tank        47.4T  41.7T  8.97K     41   456M  40.1M</span><br><span class="line">tank        47.4T  41.7T  8.46K    145   145M   146M</span><br><span class="line">tank        47.4T  41.7T  3.44K  1.75K   151M  1.35G</span><br><span class="line">tank        47.4T  41.7T  1.82K  1.70K   170M  1.64G</span><br><span class="line">tank        47.4T  41.7T  8.81K    357   799M   345M</span><br><span class="line">tank        47.4T  41.7T  7.30K      6  1009M  6.50M</span><br><span class="line">tank        47.4T  41.7T  7.28K     15   918M  15.4M</span><br><span class="line">tank        47.4T  41.7T      0     76      0  75.3M</span><br><span class="line">tank        47.4T  41.7T      0     74      0  74.4M</span><br><span class="line">tank        47.4T  41.6T  2.04K    715   134M   479M</span><br><span class="line">tank        47.4T  41.6T  2.53K  2.00K   213M  1.62G</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           0.40    0.00    2.68   33.36    0.00   63.56</span><br><span class="line"></span><br><span class="line">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">sdk              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sdj              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sda             17.50   35.50      0.77      0.64     0.00     0.00   0.00   0.00   10.00    0.89   0.19    44.80    18.42   0.55   2.90</span><br><span class="line">sdb             22.50   35.00      0.75      0.46     0.00     0.00   0.00   0.00    9.24    0.44   0.20    34.22    13.60   0.50   2.90</span><br><span class="line">sdc             11.00   39.50      0.29      5.06     0.00     0.00   0.00   0.00    7.82    1.59   0.13    26.55   131.14   0.57   2.90</span><br><span class="line">sdi             13.00   37.00      0.29      2.22     0.00     0.00   0.00   0.00   13.00    1.62   0.19    22.62    61.51   0.54   2.70</span><br><span class="line">sdd              9.00   35.00      0.09      3.42     0.00     0.00   0.00   0.00   15.17    1.96   0.19     9.78    99.94   0.60   2.65</span><br><span class="line">sde             20.50   27.50      0.82      0.80     0.00     0.00   0.00   0.00   11.39    0.44   0.22    40.78    29.67   0.54   2.60</span><br><span class="line">sdf             11.50   31.00      0.25      2.91     0.00     0.00   0.00   0.00    8.61    2.16   0.15    22.61    96.13   0.60   2.55</span><br><span class="line">sdl             15.50   91.00      0.48     60.62     0.00     0.00   0.00   0.00   16.84    9.32   1.05    32.00   682.18   1.14  12.15</span><br><span class="line">sdh             21.50   31.00      0.76      1.36     0.00     0.00   0.00   0.00   13.35    0.66   0.29    36.09    45.03   0.55   2.90</span><br><span class="line">sdg             25.00   30.50      0.89      2.49     0.00     0.00   0.00   0.00    9.46    1.02   0.24    36.40    83.48   0.54   3.00</span><br><span class="line">sdm              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">dm-0             0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           2.78    0.00   22.16   34.62    0.00   40.43</span><br><span class="line"></span><br><span class="line">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">sdk              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sdj              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sda            103.00  175.50     15.76    166.59     1.00     0.00   0.96   0.00   93.70   13.54  11.90   156.68   972.02   0.97  26.95</span><br><span class="line">sdb            133.00  200.00     11.86    191.28     0.00     0.00   0.00   0.00   40.64   11.66   7.58    91.31   979.35   0.97  32.35</span><br><span class="line">sdc             69.00  193.00     10.81    184.69     0.00     0.00   0.00   0.00   36.62   12.47   4.81   160.41   979.92   1.04  27.35</span><br><span class="line">sdi            126.50  182.00     12.86    173.52     0.00     0.00   0.00   0.00   34.08   11.80   6.33   104.08   976.29   0.94  29.10</span><br><span class="line">sdd             46.50  212.50      9.22    203.81     0.50     0.00   1.06   0.00   55.43   12.06   5.02   203.01   982.12   1.08  28.05</span><br><span class="line">sde            108.50  200.00     13.44    191.41     0.00     0.00   0.00   0.00   88.51   12.70  11.99   126.86   980.04   0.96  29.65</span><br><span class="line">sdf             60.00  183.00     16.95    174.79     0.00     0.00   0.00   0.00  190.78   14.18  13.93   289.20   978.05   1.05  25.40</span><br><span class="line">sdl            318.00   81.00     15.86     78.46     0.00     0.00   0.00   0.00   14.41   28.66   6.72    51.07   991.93   0.64  25.50</span><br><span class="line">sdh             84.00  195.50     15.35    186.86     0.50     0.00   0.59   0.00  101.49   15.28  11.38   187.10   978.74   1.03  28.75</span><br><span class="line">sdg            101.00  188.00     16.51    178.72     0.00     0.00   0.00   0.00   94.24   12.07  11.64   167.35   973.45   0.97  28.15</span><br><span class="line">sdm              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">dm-0             0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           2.75    0.00    8.39   33.43    0.00   55.44</span><br><span class="line"></span><br><span class="line">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">sdk              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sdj              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sda             45.50  175.50      9.07    175.20     0.00     0.00   0.00   0.00  270.60    5.63  13.19   204.22  1022.27   1.17  25.75</span><br><span class="line">sdb            213.50  151.00     18.24    150.69     0.00     0.00   0.00   0.00  103.23    5.52  22.70    87.48  1021.88   0.79  28.95</span><br><span class="line">sdc            166.00  153.00     20.72    152.69     0.00     0.00   0.00   0.00  147.93    5.14  25.19   127.82  1021.93   0.89  28.30</span><br><span class="line">sdi             73.00  167.00     17.27    166.70     0.00     0.00   0.00   0.00  337.95    6.20  25.59   242.25  1022.13   1.10  26.50</span><br><span class="line">sdd            252.00  135.50     22.37    135.19     0.00     0.00   0.00   0.00  126.91    4.75  32.45    90.91  1021.67   0.77  30.00</span><br><span class="line">sde            237.50  150.50     17.07    150.20     0.50     0.00   0.21   0.00   90.04    5.19  21.98    73.58  1021.93   0.75  29.20</span><br><span class="line">sdf            166.00  165.00     14.48    164.69     0.00     0.00   0.00   0.00   70.75    5.56  12.51    89.31  1022.10   0.87  28.85</span><br><span class="line">sdl            406.50   71.00     12.26     64.25     0.00     0.00   0.00   0.00    7.77   17.15   4.17    30.88   926.68   0.61  29.05</span><br><span class="line">sdh            184.50  154.50     15.33    154.20     0.00     0.00   0.00   0.00  110.93    4.73  21.05    85.07  1021.99   0.84  28.35</span><br><span class="line">sdg            213.50  161.50     14.12    161.20     0.00     0.00   0.00   0.00   38.15    5.54   8.87    67.71  1022.12   0.82  30.80</span><br><span class="line">sdm              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">dm-0             0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">          19.37    0.00   14.28   22.80    0.00   43.55</span><br><span class="line"></span><br><span class="line">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">sdk              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sdj              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">sda            421.50    0.00    107.24      0.00     0.00     0.00   0.00   0.00   39.27    0.00  16.34   260.53     0.00   0.60  25.10</span><br><span class="line">sdb            951.50    0.00    100.31      0.00     2.00     0.00   0.21   0.00   16.06    0.00  14.81   107.96     0.00   0.40  37.95</span><br><span class="line">sdc            880.00    0.00    100.63      0.00     0.50     0.00   0.06   0.00   17.46    0.00  14.93   117.09     0.00   0.41  35.90</span><br><span class="line">sdi            685.00    0.00    102.45      0.00     1.50     0.00   0.22   0.00   22.36    0.00  14.98   153.15     0.00   0.48  32.85</span><br><span class="line">sdd            858.50    0.00     99.32      0.00     0.00     0.00   0.00   0.00   17.24    0.00  14.39   118.46     0.00   0.42  35.75</span><br><span class="line">sde           1141.50    0.00     97.46      0.00     1.00     0.00   0.09   0.00   13.10    0.00  14.39    87.43     0.00   0.36  41.45</span><br><span class="line">sdf            894.50    0.00     98.18      0.00     0.50     0.00   0.06   0.00   17.11    0.00  14.86   112.39     0.00   0.39  34.70</span><br><span class="line">sdl            457.50   13.00    102.66     13.01     1.50     0.00   0.33   0.00   34.66  142.23  17.48   229.78  1024.77   0.55  26.10</span><br><span class="line">sdh           1070.50    0.00     98.14      0.00     0.50     0.00   0.05   0.00   14.03    0.00  14.50    93.88     0.00   0.38  40.25</span><br><span class="line">sdg           1014.50    0.00     98.00      0.00     0.50     0.00   0.05   0.00   14.45    0.00  14.16    98.92     0.00   0.40  40.40</span><br><span class="line">sdm              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line">dm-0             0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1000 iops</span></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print 1/1000&#125;&#x27;</span></span><br><span class="line">0.001</span><br><span class="line">$ <span class="built_in">echo</span> 1000000 &gt; zfs_delay_scale</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="A-bit-of-throught-about-the-read-performance-not-balaning-in-a-single-raidz-zpool"><a href="#A-bit-of-throught-about-the-read-performance-not-balaning-in-a-single-raidz-zpool" class="headerlink" title="A bit of throught about the read performance not balaning in a single raidz zpool"></a>A bit of throught about the read performance not balaning in a single raidz zpool</h3><ul><li>In a stripe, each device store the data in diff location(cylinder,track,sector)<ul><li>After you remove file in zfs, the fragment and free space in diff location</li></ul></li><li>In the raidz zpool, Noone could guarantee all read and write the same cylinder,track,sector at the same time</li><li>zfs read data not contains the parity data, when it trigger the scrub, it will read all HDDs</li><li>zfs stripe is dynamic, some tiny stripes not across the all HDD. some of small IO will cause the IO not balancing</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">zpool import -f -o  cachefile=none -o <span class="built_in">readonly</span>=on tank_61</span><br><span class="line">cannot import <span class="string">&#x27;tank_61&#x27;</span>: I/O error Destroy and re-create the pool from a backup <span class="built_in">source</span>.</span><br><span class="line"></span><br><span class="line">------------------------oh shit--------------------</span><br><span class="line"></span><br><span class="line">zpool import show </span><br><span class="line"></span><br><span class="line">     pool: tank_61</span><br><span class="line">     id: 15498746923132605816</span><br><span class="line">  state: FAULTED</span><br><span class="line"> status: The pool metadata is corrupted.</span><br><span class="line"> action: The pool cannot be imported due to damaged devices or data.</span><br><span class="line">        The pool may be active on another system, but can be imported using</span><br><span class="line">        the <span class="string">&#x27;-f&#x27;</span> flag.</span><br><span class="line">   see: http://zfsonlinux.org/msg/ZFS-8000-72</span><br><span class="line"> config:        tank_61                      FAULTED  corrupted data</span><br><span class="line">          raidz3-0                  ONLINE</span><br><span class="line">            sddd                    ONLINE</span><br><span class="line">            sdde                    ONLINE</span><br><span class="line">            sddf                    ONLINE</span><br><span class="line">            sddg                    ONLINE</span><br><span class="line">            sddh                    ONLINE</span><br><span class="line">            sddi                    ONLINE</span><br><span class="line">            scsi-35000c500a66c86f7  ONLINE</span><br><span class="line">            scsi-35000c500a675b907  ONLINE</span><br><span class="line">            scsi-35000c500a665afe7  ONLINE</span><br><span class="line">            scsi-35000c500a670c7a3  ONLINE</span><br><span class="line">            scsi-35000c500a66d665f  ONLINE</span><br><span class="line">            scsi-35000c500a65a86b7  ONLINE</span><br><span class="line">            scsi-35000c500a664a617  ONLINE</span><br><span class="line">            scsi-35000c500a665b353  ONLINE</span><br><span class="line">            scsi-35000c500a670c9fb  ONLINE</span><br><span class="line">            scsi-35000c500a670b10f  ONLINE</span><br><span class="line">            scsi-35000c500a65a9027  ONLINE</span><br><span class="line">            scsi-35000c500a65a02af  ONLINE</span><br><span class="line">            scsi-35000c500a670b213  ONLINE</span><br><span class="line">            scsi-35000c500a670b157  ONLINE</span><br><span class="line">            scsi-35000c500a665b1b3  ONLINE</span><br><span class="line">            scsi-35000c500a670c5fb  ONLINE</span><br><span class="line"></span><br><span class="line">$ zpool import -f -o  cachefile=none -F -n tank_61</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">1</span><br><span class="line">$ zdb -e tank_61 </span><br><span class="line">Configuration <span class="keyword">for</span> import:</span><br><span class="line">        vdev_children: 1</span><br><span class="line">        version: 5000</span><br><span class="line">        pool_guid: 15498746923132605816</span><br><span class="line">        name: <span class="string">&#x27;tank_61&#x27;</span></span><br><span class="line">        state: 0</span><br><span class="line">        hostid: 3219179115</span><br><span class="line">        hostname: <span class="string">&#x27;cngb-oss-c25-4.cngb.sz.hpc&#x27;</span></span><br><span class="line">        vdev_tree:</span><br><span class="line">            <span class="built_in">type</span>: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">            id: 0</span><br><span class="line">            guid: 15498746923132605816</span><br><span class="line">            children[0]:</span><br><span class="line">                <span class="built_in">type</span>: <span class="string">&#x27;raidz&#x27;</span></span><br><span class="line">                id: 0</span><br><span class="line">                guid: 18120440563767675975</span><br><span class="line">                nparity: 3</span><br><span class="line">                metaslab_array: 65</span><br><span class="line">                metaslab_shift: 40</span><br><span class="line">                ashift: 9</span><br><span class="line">                asize: 215529714352128</span><br><span class="line">                is_log: 0</span><br><span class="line">                create_txg: 4</span><br><span class="line">                children[0]:</span><br><span class="line">                    <span class="built_in">type</span>: <span class="string">&#x27;disk&#x27;</span></span><br><span class="line">                    id: 0</span><br><span class="line">                    guid: 691489041564037318</span><br><span class="line">                    whole_disk: 1</span><br><span class="line">                    DTL: 277</span><br><span class="line">                    create_txg: 4</span><br><span class="line">                    path: <span class="string">&#x27;/dev/sddd1&#x27;</span></span><br><span class="line">                    devid: <span class="string">&#x27;scsi-35000c500a670b7bf-part1&#x27;</span></span><br><span class="line">                    phys_path: <span class="string">&#x27;pci-0000:b3:00.0-sas-0x5000c500a670b7bd-lun-0&#x27;</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"> children[20]:</span><br><span class="line">                    <span class="built_in">type</span>: <span class="string">&#x27;disk&#x27;</span></span><br><span class="line">                    id: 20</span><br><span class="line">                    guid: 3278057294213455851</span><br><span class="line">                    whole_disk: 1</span><br><span class="line">                    DTL: 257</span><br><span class="line">                    create_txg: 4</span><br><span class="line">                    path: <span class="string">&#x27;/dev/disk/by-id/scsi-35000c500a665b1b3-part1&#x27;</span></span><br><span class="line">                    devid: <span class="string">&#x27;scsi-35000c500a665b1b3-part1&#x27;</span></span><br><span class="line">                    phys_path: <span class="string">&#x27;pci-0000:b3:00.0-sas-0x5000c500a665b1b1-lun-0&#x27;</span></span><br><span class="line">                children[21]:</span><br><span class="line">                    <span class="built_in">type</span>: <span class="string">&#x27;disk&#x27;</span></span><br><span class="line">                    id: 21</span><br><span class="line">                    guid: 10749955888611927037</span><br><span class="line">                    whole_disk: 1</span><br><span class="line">                    DTL: 256</span><br><span class="line">                    create_txg: 4</span><br><span class="line">                    path: <span class="string">&#x27;/dev/disk/by-id/scsi-35000c500a670c5fb-part1&#x27;</span></span><br><span class="line">                    devid: <span class="string">&#x27;scsi-35000c500a670c5fb-part1&#x27;</span></span><br><span class="line">                    phys_path: <span class="string">&#x27;pci-0000:b3:00.0-sas-0x5000c500a670c5f9-lun-0&#x27;</span></span><br><span class="line">        rewind-policy:</span><br><span class="line">            rewind-request-txg: 18446744073709551615</span><br><span class="line">            rewind-request: 2</span><br><span class="line">zdb: can<span class="string">&#x27;t open &#x27;</span>tank_61<span class="string">&#x27;: Input/output error</span></span><br></pre></td></tr></table></figure><p>Try it one by one</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">scsi-35000c500a665afe7</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">mos</span> [<span class="string">META</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">0</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">4</span><span class="string">,</span> <span class="string">509M,</span> <span class="number">284</span> <span class="string">objects</span></span><br><span class="line"></span><br><span class="line">    <span class="string">Object</span>  <span class="string">lvl</span>   <span class="string">iblk</span>   <span class="string">dblk</span>  <span class="string">dsize</span>  <span class="string">dnsize</span>  <span class="string">lsize</span>   <span class="string">%full</span>  <span class="string">type</span></span><br><span class="line">         <span class="number">0</span>    <span class="number">2</span>   <span class="string">128K</span>    <span class="string">16K</span>   <span class="string">736K</span>     <span class="number">512</span>   <span class="string">592K</span>   <span class="number">23.99</span>  <span class="string">DMU</span> <span class="string">dnode</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">sddi</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span> </span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1274825</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">mos</span> [<span class="string">META</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">0</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">4</span><span class="string">,</span> <span class="string">492M,</span> <span class="number">284</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61/tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">155</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1744</span><span class="string">,</span> <span class="number">59.</span><span class="string">3T,</span> <span class="number">662232</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">51</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1</span><span class="string">,</span> <span class="number">68.</span><span class="string">1K,</span> <span class="number">6</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_blocks</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">1</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_dnode</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">sha512</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">skein</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">edonr</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">userobj_accounting</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">2</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">----sddh--finish-----</span></span><br><span class="line"><span class="string">----sddi-----</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414018</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414019</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414020</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414021</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414022</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414023</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414025</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1274813</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">mos</span> [<span class="string">META</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">0</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">4</span><span class="string">,</span> <span class="string">492M,</span> <span class="number">284</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61/tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">155</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1744</span><span class="string">,</span> <span class="number">59.</span><span class="string">3T,</span> <span class="number">662232</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">51</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1</span><span class="string">,</span> <span class="number">68.</span><span class="string">1K,</span> <span class="number">6</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_blocks</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">1</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_dnode</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">sha512</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">skein</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">edonr</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">userobj_accounting</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">2</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1274814</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">mos</span> [<span class="string">META</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">0</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">4</span><span class="string">,</span> <span class="string">492M,</span> <span class="number">284</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61/tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">155</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1744</span><span class="string">,</span> <span class="number">59.</span><span class="string">3T,</span> <span class="number">662232</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">51</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1</span><span class="string">,</span> <span class="number">68.</span><span class="string">1K,</span> <span class="number">6</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_blocks</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">1</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_dnode</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">sha512</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">skein</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">edonr</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">userobj_accounting</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">2</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1414007</span></span><br><span class="line"><span class="attr">zdb:</span> <span class="string">can&#x27;t</span> <span class="string">open</span> <span class="attr">&#x27;tank_61&#x27;:</span> <span class="string">Input/output</span> <span class="string">error</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line"></span><br><span class="line"><span class="string">----sddi--finish-----</span></span><br><span class="line"><span class="string">----scsi-35000c500a66c86f7-----</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1274826</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">mos</span> [<span class="string">META</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">0</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">4</span><span class="string">,</span> <span class="string">492M,</span> <span class="number">284</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61/tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">155</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1744</span><span class="string">,</span> <span class="number">59.</span><span class="string">3T,</span> <span class="number">662232</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">51</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1</span><span class="string">,</span> <span class="number">68.</span><span class="string">1K,</span> <span class="number">6</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_blocks</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">1</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_dnode</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">sha512</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">skein</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">edonr</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">userobj_accounting</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">2</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">zdb</span> <span class="string">-e</span> <span class="string">tank_61</span> <span class="string">-d</span> <span class="string">-t</span> <span class="number">1274827</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">mos</span> [<span class="string">META</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">0</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">4</span><span class="string">,</span> <span class="string">492M,</span> <span class="number">284</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61/tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">155</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1744</span><span class="string">,</span> <span class="number">59.</span><span class="string">3T,</span> <span class="number">662232</span> <span class="string">objects</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">mos</span> [<span class="string">META</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">0</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">4</span><span class="string">,</span> <span class="string">492M,</span> <span class="number">284</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61/tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">155</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1744</span><span class="string">,</span> <span class="number">59.</span><span class="string">3T,</span> <span class="number">662232</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Dataset</span> <span class="string">tank_61</span> [<span class="string">ZPL</span>]<span class="string">,</span> <span class="string">ID</span> <span class="number">51</span><span class="string">,</span> <span class="string">cr_txg</span> <span class="number">1</span><span class="string">,</span> <span class="number">68.</span><span class="string">1K,</span> <span class="number">6</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_blocks</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">1</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">large_dnode</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">sha512</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">skein</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">edonr</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">0</span> <span class="string">is</span> <span class="string">correct</span></span><br><span class="line"><span class="string">Verified</span> <span class="string">userobj_accounting</span> <span class="string">feature</span> <span class="string">refcount</span> <span class="string">of</span> <span class="number">2</span> <span class="string">is</span> <span class="string">correct</span> </span><br></pre></td></tr></table></figure><p>Only sddi show input/output error<br>This is the <a href="https://github.com/zfsonlinux/zfs/issues/7184">zfs bug</a>, the easy way is use zdb -lu /dev/sd(all zpool devices), you could compare txg number, single device has the wrong txg number with the others. </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">diff</span> <span class="string">sdcu</span> <span class="string">sdcv</span> <span class="comment"># it &#x27;s ok</span></span><br><span class="line"><span class="string">$</span> <span class="string">diff</span> <span class="string">sdcu</span> <span class="string">sddi</span> <span class="comment"># found the wrong device</span></span><br><span class="line"><span class="number">25</span><span class="string">,37c25,37</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674112</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2673986</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674114</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674115</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674116</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674117</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674118</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674119</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674120</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674121</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674122</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674123</span></span><br><span class="line"><span class="string">&lt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">2674124</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727315</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727443</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727317</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727318</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727319</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727320</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727321</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727322</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727323</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727324</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727325</span></span><br><span class="line"><span class="string">&gt;</span>       <span class="string">txg</span> <span class="string">=</span> <span class="number">7727453</span></span><br><span class="line"></span><br><span class="line"><span class="string">echo</span> <span class="number">1</span> <span class="string">&gt;</span> <span class="string">/sys/class/block/sddi/device/delete</span></span><br></pre></td></tr></table></figure><p>After ban the sddi, the zpool could be importedwipe the sweat, wipe the sweat<br>The issue because this device (sddi) has been in two diff zpool(server A and server B) at the same time</p><h3 id="Error-ICRC-ABRT-at-LBA-in-SATA-device"><a href="#Error-ICRC-ABRT-at-LBA-in-SATA-device" class="headerlink" title="Error: ICRC, ABRT at LBA in SATA device"></a>Error: ICRC, ABRT at LBA in SATA device</h3><p>zfs show a lot of cksum errors<br>fix it by upgrade IO expander firmware</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Error 17 occurred at disk power-on lifetime: 1903 hours (79 days + 7 hours)</span><br><span class="line">  When the <span class="built_in">command</span> that caused the error occurred, the device was doing SMART Offline or Self-test.</span><br><span class="line"></span><br><span class="line">  After <span class="built_in">command</span> completion occurred, registers were:</span><br><span class="line">  ER ST SC SN CL CH DH</span><br><span class="line">  -- -- -- -- -- -- --</span><br><span class="line">  84 41 00 00 00 00 00  Error: ICRC, ABRT at LBA = 0x00000000 = 0</span><br><span class="line"></span><br><span class="line">  Commands leading to the <span class="built_in">command</span> that caused the error were:</span><br><span class="line">  CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name</span><br><span class="line">  -- -- -- -- -- -- -- --  ----------------  --------------------</span><br><span class="line">  61 05 10 b2 8e 78 40 00  23d+05:55:53.717  WRITE FPDMA QUEUED</span><br><span class="line">  61 01 38 b1 8e 78 40 00  23d+05:55:53.716  WRITE FPDMA QUEUED</span><br><span class="line">  61 01 30 d9 8e 78 40 00  23d+05:55:53.716  WRITE FPDMA QUEUED</span><br><span class="line">  61 01 28 d8 8e 78 40 00  23d+05:55:53.716  WRITE FPDMA QUEUED</span><br><span class="line">  61 0a 20 68 ac 53 40 00  23d+05:55:53.715  WRITE FPDMA QUEUED</span><br><span class="line"></span><br><span class="line">  pool: tank</span><br><span class="line"> state: ONLINE</span><br><span class="line">status: One or more devices has experienced an unrecoverable error.  An</span><br><span class="line">        attempt was made to correct the error.  Applications are unaffected.</span><br><span class="line">action: Determine <span class="keyword">if</span> the device needs to be replaced, and clear the errors</span><br><span class="line">        using <span class="string">&#x27;zpool clear&#x27;</span> or replace the device with <span class="string">&#x27;zpool replace&#x27;</span>.</span><br><span class="line">   see: http://zfsonlinux.org/msg/ZFS-8000-9P</span><br><span class="line">  scan: scrub repaired 55.5K <span class="keyword">in</span> 11h11m with 0 errors on Mon Mar 18 09:57:08 2019</span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME        STATE     READ WRITE CKSUM</span><br><span class="line">        tank        ONLINE       0     0     0</span><br><span class="line">          raidz3-0  ONLINE       0     0     0</span><br><span class="line">            sdh     ONLINE       0     0    51</span><br><span class="line">            sdi     ONLINE       0     0    13</span><br><span class="line">            sdj     ONLINE       0     0    19</span><br><span class="line">            sdk     ONLINE       0     0    10</span><br><span class="line">            sdl     ONLINE       0     0    28</span><br><span class="line">            sdm     ONLINE       0     0    39</span><br><span class="line">            sdn     ONLINE       0     0    70</span><br><span class="line">            sdo     ONLINE       0     0    25</span><br></pre></td></tr></table></figure><h3 id="MMP-mmp-timeout-calculate"><a href="#MMP-mmp-timeout-calculate" class="headerlink" title="MMP(mmp) timeout calculate"></a>MMP(mmp) timeout calculate</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">multihost = on</span><br><span class="line">       <span class="keyword">while</span> (!mmp-&gt;mmp_thread_exiting) &#123;</span><br><span class="line">                uint64_t mmp_fail_intervals = zfs_multihost_fail_intervals; <span class="comment"># default = 5</span></span><br><span class="line"></span><br><span class="line">        hrtime_t max_fail_ns = zfs_multihost_fail_intervals *</span><br><span class="line">            MSEC2NSEC(MAX(zfs_multihost_interval, MMP_MIN_INTERVAL));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((mmp_interval * mmp_fail_intervals) &lt; max_fail_ns) &#123;</span><br><span class="line">                        max_fail_ns = ((31 * max_fail_ns) + (mmp_interval *</span><br><span class="line">                            mmp_fail_intervals)) / 32;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        max_fail_ns = mmp_interval * mmp_fail_intervals; <span class="comment">### there is no 43 seconds</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((!last_spa_multihost &amp;&amp; multihost) ||</span><br><span class="line">                    (last_spa_suspended &amp;&amp; !suspended)) &#123;</span><br><span class="line">                        mutex_enter(&amp;mmp-&gt;mmp_io_lock);</span><br><span class="line">                        mmp-&gt;mmp_last_write = gethrtime();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                max_fail_ns= 5 * 5000</span><br><span class="line">                                        5                  on</span><br><span class="line">                <span class="keyword">if</span> (!suspended &amp;&amp; mmp_fail_intervals &amp;&amp; multihost &amp;&amp;</span><br><span class="line">                    (gethrtime() - mmp-&gt;mmp_last_write) &gt; max_fail_ns) &#123;</span><br><span class="line">                        cmn_err(CE_WARN, <span class="string">&quot;MMP writes to pool &#x27;%s&#x27; have not &quot;</span></span><br><span class="line">                            <span class="string">&quot;succeeded in over %llus; suspending pool&quot;</span>,</span><br><span class="line">                            spa_name(spa),</span><br><span class="line">                            NSEC2SEC(gethrtime() - mmp-&gt;mmp_last_write));</span><br><span class="line">                        zio_suspend(spa, NULL, ZIO_SUSPEND_MMP);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">[Wed May 20 11:27:44 2020] scsi target13:0:10: _scsih_tm_display_info: handle(0x0015), sas_address(0x5000cca251b4462e), phy(37)</span><br><span class="line">[Wed May 20 11:27:44 2020] scsi target13:0:10: enclosurelogical id(0x500304800928dc3f), slot(10)</span><br><span class="line">[Wed May 20 11:27:44 2020] scsi target13:0:10: enclosure level(0x0000), connector name(     )</span><br><span class="line">[Wed May 20 11:27:44 2020] sd 13:0:10:0: task abort: SUCCESS scmd(ffff99cb3306a300)</span><br><span class="line">[Wed May 20 11:27:44 2020] sd 13:0:10:0: [sdff] tag<span class="comment">#2 FAILED Result: hostbyte=DID_TIME_OUT driverbyte=DRIVER_OK</span></span><br><span class="line">[Wed May 20 11:27:44 2020] sd 13:0:10:0: [sdff] tag<span class="comment">#2 CDB: Read(16) 88 00 00 00 00 04 6a 25 dc 13 00 00 00 01 00 00</span></span><br><span class="line">[Wed May 20 11:27:44 2020] blk_update_request: I/O error, dev sdff, sector 18960735251</span><br><span class="line">[Wed May 20 11:27:44 2020] WARNING: MMP writes to pool <span class="string">&#x27;tank_64&#x27;</span> have not succeeded <span class="keyword">in</span> over 43s; suspending pool</span><br><span class="line">[Wed May 20 11:27:44 2020] WARNING: Pool <span class="string">&#x27;tank_64&#x27;</span> has encountered an uncorrectable I/O failure and has been suspended.</span><br><span class="line"></span><br><span class="line">$ mmp_interval=9000;mmp_fail_interval=5</span><br><span class="line">$ <span class="built_in">echo</span> $(($((<span class="number">31</span>*$((mmp_interval*mmp_fail_interval))+((mmp_interval*mmp_fail_interva))))/32))</span><br><span class="line">43593</span><br></pre></td></tr></table></figure><h3 id="Error-handler"><a href="#Error-handler" class="headerlink" title="Error handler"></a>Error handler</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[1:0:1:0]    enclosu DellEMC  Array584EMM      5258  -          -  /dev/sg1        -</span><br><span class="line"></span><br><span class="line"><span class="comment">### log show: ## log show all JBOD block devices are block, after a short time, all block device were unblock</span></span><br><span class="line">mpt3sas_cm0: log_info(0x30030101): originator(IOP), code(0x03), sub_code(0x0101)</span><br><span class="line">mpt3sas_cm0: log_info(0x30030101): originator(IOP), code(0x03), sub_code(0x0101)</span><br><span class="line">ses 1:0:1:0: _scsih_block_io_device skip device_block <span class="keyword">for</span> SES handle(0x006b)</span><br><span class="line">sd 1:0:0:0: device_block, handle(0x006c)</span><br><span class="line">sd 1:0:2:0: device_block, handle(0x006d)</span><br></pre></td></tr></table></figure><h3 id="zdb-dump-zpool"><a href="#zdb-dump-zpool" class="headerlink" title="zdb dump zpool"></a>zdb dump zpool</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">-F      Attempt to make an unreadable pool readable by trying progressively older transactions.</span><br><span class="line">-X      Attempt <span class="string">&quot;extreme&quot;</span> transaction rewind, that is attempt the same recovery as -F but <span class="built_in">read</span> transactions otherwise deemed too old.</span><br><span class="line"></span><br><span class="line">$ zdb -c -e -G tank</span><br><span class="line"></span><br><span class="line">Traversing all blocks to verify metadata checksums and verify nothing leaked ...</span><br><span class="line"></span><br><span class="line">loading concrete vdev 0, metaslab 3492 of 3493 ...</span><br><span class="line"></span><br><span class="line">No leaks (block sum matches space maps exactly)</span><br><span class="line"></span><br><span class="line">bp count:                    71</span><br><span class="line">ganged count:                 0</span><br><span class="line">bp logical:             1236480      avg:  17415</span><br><span class="line">bp physical:             137728      avg:   1939     compression:   8.98</span><br><span class="line">bp allocated:           1253376      avg:  17653     compression:   0.99</span><br><span class="line">bp deduped:                   0    ref&gt;1:      0   deduplication:   1.00</span><br><span class="line">Normal class:           1253376     used:  0.00%</span><br><span class="line"></span><br><span class="line">additional, non-pointer bps of <span class="built_in">type</span> 0:         34</span><br><span class="line">Dittoed blocks on same vdev: 37</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZFS_DBGMSG(zdb) START:</span><br><span class="line">spa.c:5490:spa_import(): spa_import: importing tank</span><br><span class="line">spa_misc.c:408:spa_load_note(): spa_load(tank, config trusted): LOADING</span><br><span class="line">vdev.c:125:vdev_dbgmsg(): disk vdev <span class="string">&#x27;/dev/sdb1&#x27;</span>: best uberblock found <span class="keyword">for</span> spa tank. txg 26</span><br><span class="line">spa_misc.c:408:spa_load_note(): spa_load(tank, config untrusted): using uberblock with txg=26</span><br><span class="line">spa_misc.c:408:spa_load_note(): spa_load(tank, config trusted): LOADED</span><br><span class="line">spa.c:7592:spa_async_request(): spa=tank async request task=32</span><br><span class="line">ZFS_DBGMSG(zdb) END</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zfs </tag>
            
            <tag> scsi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>proxychains and kcptun</title>
      <link href="2016/09/04/kcptun/"/>
      <url>2016/09/04/kcptun/</url>
      
        <content type="html"><![CDATA[<h3 id="Server-Parameters"><a href="#Server-Parameters" class="headerlink" title="Server Parameters"></a>Server Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/bash nobody -c <span class="string">&#x27;./server_linux_amd64 -l &quot;vps_ip:kcptun_port&quot; -t &quot;serer_ip:shadowsocks_port&quot; -key yourkeyfile -mode fast2 --crypt aes-128 --datashard 10 --parityshard 3&#x27;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Client-Parameters"><a href="#Client-Parameters" class="headerlink" title="Client Parameters"></a>Client Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./client_linux_amd64 -r <span class="string">&quot;vps_ip:kcptun_port&quot;</span> -l <span class="string">&quot;:kcptun_client_port&quot;</span> -key yourkeyfile -mode fast2 --crypt aes-128 --datashard 10 --parityshard 3</span><br></pre></td></tr></table></figure><h3 id="Modify-shadowsocks-config"><a href="#Modify-shadowsocks-config" class="headerlink" title="Modify shadowsocks config"></a>Modify shadowsocks config</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;server&quot;:&quot;127.0.0.1&quot;,</span><br><span class="line">&quot;server_port&quot;:kcptun_client_port,</span><br></pre></td></tr></table></figure><p>Browser proxy setting no changed (local port of shadowsocks client)</p><h3 id="Some-of-issues"><a href="#Some-of-issues" class="headerlink" title="Some of issues"></a>Some of issues</h3><p>There is no localhost/127.0.0.1 in openvz envirnoment, you need replace it by ip address</p><h3 id="Start-dropbox-by-proxy"><a href="#Start-dropbox-by-proxy" class="headerlink" title="Start dropbox by proxy"></a>Start dropbox by proxy</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 ~/.dropbox-dist/dropboxd &amp;</span><br><span class="line"></span><br><span class="line">cat /etc/proxychains.conf</span><br><span class="line">strict_chain</span><br><span class="line">proxy_dns </span><br><span class="line">remote_dns_subnet 224</span><br><span class="line">tcp_read_time_out 15000</span><br><span class="line">tcp_connect_time_out 8000</span><br><span class="line">localnet 127.0.0.0/255.0.0.0</span><br><span class="line">quiet_mode</span><br><span class="line"></span><br><span class="line">[ProxyList]</span><br><span class="line">socks5  127.0.0.1 your_porxy_port_number</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> proxy </tag>
            
            <tag> kcptun </tag>
            
            <tag> proxychains </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The block device</title>
      <link href="2016/08/10/block_device/"/>
      <url>2016/08/10/block_device/</url>
      
        <content type="html"><![CDATA[<h3 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h3><h4 id="Why-use-4K-device"><a href="#Why-use-4K-device" class="headerlink" title="Why use 4K device"></a>Why use 4K device</h4><ul><li>4-KB native (4Kn) HDDs<pre><code>  * The 4Kn HDD directly maps 4-KB logical sectors (or blocks) to the 4-KB physical sectors.</code></pre></li><li>512-byte emulation (512e) HDDs<pre><code>  * The 512e HDD transparently translates 512-byte logical block I/O requests into 4-KB physical sector operations. Each physical sector contains eight logical blocks.</code></pre></li></ul><a id="more"></a><p><a href="https://www.thomas-krenn.com/en/wiki/Advanced_Sector_Format_of_Block_Devices">512e Read Operations</a><br>Read operations are very simple compared to write operations:<br>The host would like to read a 512-byte block.<br>The controller loads the complete 4KB sector containing the requested 512-byte block.<br>The controller extracts the data from the 512-byte block and delivers it in the corresponding format to the host.</p><p>512e Write operations use the read-modify-write method:<br>The host would like to write a 512-byte block.<br>The controller selects a suitable 4KB sector and loads it completely. (read)<br>The controller modifies 512 bytes in the 4KB sector. (modify)<br>The controller writes the modified 4KB sector to the hard drive. (write)</p><p>Compatibility<br>In order to keep performance constant, it is necessary that partitions on 512e hard drives be properly aligned (see also Partition Alignment) so that a 4KB sector contains exactly eight 512-byte blocks. Newer operating systems already correctly align the partitions (Windows &gt; Vista SP1; Linux &gt; 2.6.31 (fdisk &gt; 1.2.3))[1]. With the correct alignment, write operations can be optimally cached by the hard drive controller, which optimizes performance.</p><p>In <a href="https://lwn.net/Articles/322777">This</a>, more details and add new one,the preamble</p><ul><li>Synchronization/Data Address Mark (Sync/DAM)<pre><code>  * The Sync/DAM field indicates the beginning of the sector and identifies the sectors number, location, and status.</code></pre></li><li>User data<pre><code>  * The User data field contains actual stored data.</code></pre></li><li>Error correcting code (ECC)<pre><code>  * The ECC field contains error-correcting code that is used to recover user data that mightbe damaged during the read or write operation.</code></pre></li><li>Gap<pre><code>  * The Gap field is used to separate sectors from each other.</code></pre></li><li>Physical sector<pre><code>  * Physical sector is the minimum amount of data that the HDD can read from or write to the physical media in a single I/O operation. For Advanced Format HDDs, the physical sector size is 4 KB.</code></pre></li><li>Logical sector<pre><code>  * Logical sector is the addressable logical block, which is the minimum amount of data that the HDD can address. This amount is also the minimum amount of data that the host system can deliver to or request from the HDD in a single I/O operation. Advanced Format HDDs support 512-bytes and 4-KB logical sector sizes.</code></pre></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------</span><br><span class="line">|P|D|  Data Bytes(512/4096Bytes  | ECC |G|</span><br><span class="line">------------------------------------------</span><br><span class="line">P= Preamble</span><br><span class="line">D= Data sync mark</span><br><span class="line">ECC= Error Correcting Code</span><br><span class="line">G= Inter Sector Gap</span><br></pre></td></tr></table></figure><p>I think the OS kernel could not recognise ECC/G/P/D and no need to know them, maybe driver will know them. it s the hardware design<br>In hardware that means there is ECC to check hardware read/write signals.</p><p>long-data-sector (512,520,528,4096,4112,4160,4224) will show size in logic sector</p><h4 id="mpt3sas-driver-install"><a href="#mpt3sas-driver-install" class="headerlink" title="mpt3sas driver install"></a>mpt3sas driver install</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#compile to local</span></span><br><span class="line">$ make -j4 CONFIG_DEBUG_INFO=<span class="number">1</span> -C <span class="regexp">/lib/m</span>odules<span class="regexp">/$(uname -r)/</span>build M=<span class="regexp">/lsi-9300-8e/m</span>pt3sas</span><br><span class="line"></span><br><span class="line"><span class="comment">#compile to local kernel </span></span><br><span class="line">$ make -j4 CONFIG_DEBUG_INFO=<span class="number">1</span> -C <span class="regexp">/lib/m</span>odules<span class="regexp">/$(uname -r)/</span>build M=<span class="regexp">/lsi-9300-8e/m</span>pt3sas modules_install</span><br></pre></td></tr></table></figure><h5 id="Driver-Build-Instructions"><a href="#Driver-Build-Instructions" class="headerlink" title="Driver Build Instructions"></a><a href="//docs.broadcom.com/docs-and-downloads/host-bus-adapters/host-bus-adapters-common-files/README_FOR_LinuxMPT_SAS2_RHEL5_SLES10_P9-zip.pdf">Driver Build Instructions</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">The following examples show how to configure and build the LSI Fusion-MPT driver(s) as</span><br><span class="line">kernel modules. In this example the driver version is (01.255.06.00-1). Here is the procedure</span><br><span class="line">to build the drivers out of kernel tree:</span><br><span class="line"> Extract the packaging from Linux system:</span><br><span class="line"> <span class="comment"># tar -zxvf mpt2sas-release.tar.gz</span></span><br><span class="line"> <span class="comment"># tar -zxvf mpt2sas-01.255.06.00.tar.gz</span></span><br><span class="line"> <span class="comment"># cd mpt2sas</span></span><br><span class="line"> <span class="comment"># ./compile</span></span><br><span class="line"> <span class="comment"># ./load</span></span><br><span class="line">Alternatively, here is the procedure to build driver <span class="keyword">in</span> kernel tree</span><br><span class="line">1. From the /usr/src/linux directory, ensure a clean kernel <span class="built_in">source</span> tree by executing the</span><br><span class="line">following <span class="built_in">command</span>:</span><br><span class="line"> <span class="comment"># make mrproper</span></span><br><span class="line">2. From the /usr/src/linux directory, run the normal kernel configuration routine:</span><br><span class="line"> <span class="comment"># make oldconfig</span></span><br><span class="line"> or:</span><br><span class="line"> <span class="comment"># make config</span></span><br><span class="line"> or:</span><br><span class="line"> <span class="comment"># make menuconfig</span></span><br><span class="line"> or:</span><br><span class="line"> <span class="comment"># make xconfig</span></span><br><span class="line">3. Here are the directions <span class="keyword">for</span> finding the entry <span class="keyword">in</span> menuconfig ncurses display</span><br><span class="line"> Device Drivers ---&gt;</span><br><span class="line"> SCSI device support ---&gt;</span><br><span class="line"> SCSI low-level drivers ---&gt;</span><br><span class="line"> &lt;M&gt; LSI MPT Fusion SAS 2.0 Device Driver</span><br><span class="line"> (128) LSI MPT Fusion Max number of SG Entries (16 - 128) (NEW)</span><br><span class="line"> [*] LSI MPT Fusion logging facility</span><br><span class="line"> On the sub menu, select the <span class="string">&quot;LSI MPT Fusion SAS 2.0 Device Driver&quot;</span> line,</span><br><span class="line"> and <span class="keyword">then</span> enter <span class="string">&quot;m&quot;</span> to configure <span class="keyword">for</span> building this support as a module.</span><br><span class="line"> (Alternatively, you can enter <span class="string">&quot;y&quot;</span> to have this support built</span><br><span class="line"> into the kernel.)</span><br><span class="line"> NOTES:</span><br><span class="line"> o CONFIG_SCSI_MPT2SAS_MAX_SGE: This option allows you to specify the</span><br><span class="line"> maximum number of scatter-gather entries per I/O. The driver default</span><br><span class="line"> is 128, <span class="built_in">which</span> matches MAX_HW_SEGMENTS. However, it may decreased</span><br><span class="line"> down to 16. Decreasing this parameter will reduce memory requirements</span><br><span class="line"> on a per controller instance.</span><br><span class="line"> o CONFIG_SCSI_MPT2SAS_LOGGING: This turns on a logging facility.</span><br><span class="line">4. Save the kernel configuration changes. Follow any post configuration instructions, and <span class="keyword">do</span></span><br><span class="line">everything needed on your platform to rebuild the kernel. This typically includes:</span><br><span class="line"></span><br><span class="line"> <span class="comment"># make dep</span></span><br><span class="line"> and:</span><br><span class="line"> <span class="comment"># make bzImage # varies on non-Intel platforms</span></span><br><span class="line">5. Rebuild the kernel modules:</span><br><span class="line"> <span class="comment"># make modules</span></span><br><span class="line">6. Optionally, (and potentially dangerous!), <span class="keyword">do</span> everything needed on your platform to install a</span><br><span class="line">newly built kernel. (possibly temporarily, <span class="keyword">for</span> sanity testing)</span><br><span class="line"> Be careful with this step, and be sure you know what you<span class="string">&#x27;re doing!</span></span><br><span class="line"><span class="string"> It is easy to wipe out a good/stable kernel from this point forward</span></span><br><span class="line"><span class="string"> in the procedure!</span></span><br><span class="line"><span class="string">7. (Re)Install newly compiled kernel modules:</span></span><br><span class="line"><span class="string"> # make modules_install</span></span><br><span class="line"><span class="string"> The output from the last step should look something like this:</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/block</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/net</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/ipv4</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/scsi</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/fs</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/fs</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/cdrom</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/video</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/net</span></span><br><span class="line"><span class="string"> Installing modules under /lib/modules/2.6.30/misc</span></span><br><span class="line"><span class="string">8. Update your /boot sector with the new System.map and bzImage, re-create your ramdisk</span></span><br><span class="line"><span class="string">image (refer to your vendor literature), and update your boot manager--i.e., lilo.conf,</span></span><br><span class="line"><span class="string">grub.conf. If you are using lilo, you must run lilo -v prior to reboot.</span></span><br><span class="line"><span class="string">9. Shut down the system:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> Example:</span></span><br><span class="line"><span class="string"> # shutdown -r now</span></span><br><span class="line"><span class="string"> and then reboot with the newly built Linux kernel</span></span><br></pre></td></tr></table></figure><h4 id="Qlogic-driver-setting"><a href="#Qlogic-driver-setting" class="headerlink" title="Qlogic driver setting"></a>Qlogic driver setting</h4><p>Adpater reset time e.g. Qlogic reset time<br>echo options qla2xxx ql2xextended_error_logging=1 qlport_down_retry=10 ql2xloginretrycount=10 &gt;&gt;  /etc/modprobe.d/qlogic.conf<br>Multipath check_timeout  (reduce to 10 seconds from default 60 seconds)</p><p>Set the max_segments for HBA driver<br>| HBA       | Module Parameter|<br>||::|<br>| LSI       |  max_sgl_entries|<br>| Emulex    |  lpfc_sg_seg_cnt|<br>| ib_srp    |  cmd_sg_entries |<br>| Brocade   |  bfa_io_max_sge |</p><p>Set max_hw_sectors_kb for HBA driver<br>| HBA       | Module Parameter|<br>||::|<br>| LSI       |  max_sectors    |<br>| ib_srp    |  max_sect       |<br>| Brocade   |  max_xfer_size  |</p><p>mpt3sas<br>max_sectors:max sectors, range 64 to 32767  default=32767 (ushort)</p><h4 id="SAN-controller-setting-MD3460"><a href="#SAN-controller-setting-MD3460" class="headerlink" title="SAN controller setting MD3460"></a>SAN controller setting MD3460</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RAID 6               8+2</span><br><span class="line">segment              128K</span><br><span class="line">cache block size     32K</span><br><span class="line">cache flush          90%</span><br><span class="line">Write cache mirror   enabled</span><br><span class="line">Read cache           disabled</span><br></pre></td></tr></table></figure><h3 id="rebuild-feature"><a href="#rebuild-feature" class="headerlink" title="rebuild feature"></a>rebuild feature</h3><p>In May 2012, with 3.5-inch hard drive capacities reaching 4TB, the T10 working group approved including Rebuild Assist in the SCSI SBC-3 specification. In August 2013, the SATA-IO committee adopted TPR-045 (Rebuild Assist) as part of the SATA 3.2 specification.) so with a Rebuild Assist supported RAID controller: can copy good data from a failing drive to a new drive and only need to rebuild the bad portion, supposably resulting in quicker rebuild times</p><p>Dell PERC not recommand enable it, because it will cause data loss.</p><h3 id="Linux-setting"><a href="#Linux-setting" class="headerlink" title="Linux setting"></a>Linux setting</h3><h4 id="block-driver"><a href="#block-driver" class="headerlink" title="block driver"></a>block driver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ $ cat /sys/block/sdX/device/state</span><br><span class="line">running</span><br><span class="line"></span><br><span class="line">$ cat /sys/block/sdz/device/queue_depth</span><br><span class="line">254</span><br><span class="line"></span><br><span class="line">$ cat /sys/block/sda/queue/nomerges </span><br><span class="line"><span class="comment">#set nomerges to 0 for HDDs or to 1 for SSDs</span></span><br><span class="line"></span><br><span class="line">$ cat /sys/block/sdd/queue/add_random </span><br><span class="line"><span class="comment">#The default value is 1. Set add_random=0 for SSDs because random entropy pool does not optimize SSD performance</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check scsi state</span></span><br><span class="line">$ cat /sys/block/sdX/device/state</span><br><span class="line">running</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 30 &gt; /sys/block/sdX/device/timeout</span><br><span class="line"><span class="comment"># I don &#x27;t think set the value too long</span></span><br><span class="line"></span><br><span class="line">$ cat /etc/udev/rules.d/50-udev.rules</span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, SUBSYSTEM==<span class="string">&quot;scsi&quot;</span> , SYSFS&#123;<span class="built_in">type</span>&#125;==<span class="string">&quot;0|7|14&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 30 &gt; /sys/block/%k/device/timeout&#x27;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">### another exapmle</span></span><br><span class="line">KERNEL==<span class="string">&quot;sdc5&quot;</span>, OWNER=<span class="string">&quot;student&quot;</span>, GROUP=<span class="string">&quot;student&quot;</span>, MODE=<span class="string">&quot;0600&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sd*&quot;</span>, SYSFS==<span class="string">&quot;4317210A2880EF89&quot;</span>, SYMLINK+=<span class="string">&quot;fedora%n&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, RUN=<span class="string">&quot;/usr/bin/wall  SCSI DEVICE ADDED&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;remove&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, RUN=<span class="string">&quot;/usr/bin/wall SCSI DEVICE REMOVED&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, SYMLINK=<span class="string">&quot;scsi%n&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;remove&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, SYMLINK=<span class="string">&quot;scsi%n&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, SYSFS&#123;vendor&#125;==<span class="string">&quot;WDC WD32&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 128 &gt; /sys/block/%k/queue/max_sectors_kb&#x27;&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, SYSFS&#123;vendor&#125;==<span class="string">&quot;WDC WD32&quot;</span>, RUN+=<span class="string">&quot;/usr/bin/wall /sys/block/%k/queue/max_sectors_kb set to 128&quot;</span></span><br></pre></td></tr></table></figure><p>KERNELS - match against the kernel name for the device, or the kernel name for any of the parent devices<br>SUBSYSTEMS - match against the subsystem of the device, or the subsystem of any of the parent devices<br>DRIVERS - match against the name of the driver backing the device, or the name of the driver backing any of the parent devices<br>ATTRS - match a sysfs attribute of the device, or a sysfs attribute of any of the parent devices</p><p>udevadm info -a -p $(udevadm info -q path -n /dev/sda)</p><p>About <a href="https://library.netapp.com/ecmdocs/ECMP1196980/html/GUID-A055B184-0876-4376-9C75-35FE8C9BE832.html#:~:text=Queue%20depth%20is%20the%20number,depth%20equates%20to%20better%20performance.">queue_depth</a><br>Note: To estimate the queue depth needed to achieve a certain I/O per second throughput, use this formula.<br>Needed queue depth = (Number of I/O per second) x (Response time)<br>For example, if you need 40,000 I/O per second with a response time of 3 milliseconds, the needed queue depth = 40,000 x (.003) = 120.</p><h4 id="block-driver-2"><a href="#block-driver-2" class="headerlink" title="block driver 2"></a><a href="https://library.netapp.com/ecmdocs/ECMP12404601/html/GUID-436F7286-AD26-4A8D-A2D1-2BC8B5CFC023.html">block driver 2</a></h4><p><a href="https://access.redhat.com/solutions/43861">redhat doc</a></p><ul><li>max_hw_sectors_kb (RO) - This parameter sets the maximum number of kilobytes that the hardware allows for request.<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ubuntu 18.04 server, sas 10TB 512e HDD</span></span><br><span class="line">$ cat <span class="regexp">/sys/</span>block<span class="regexp">/sda/</span>queue/max_hw_sectors_kb </span><br><span class="line"><span class="number">16383</span></span><br></pre></td></tr></table></figure></li></ul><p>max_sectors_kb = avgrq-sz(iostat)</p><ul><li><p><a href="https://access.redhat.com/solutions/2150101">max_sectors_kb</a> (RW) - This parameter sets the maximum number of kilobytes that the block layer allows for a file system request. The value of this parameter must be less than or equal to the maximum size allowed by the hardware. The kernel also places an upper bound on this value with the BLK_DEF_MAX_SECTORS macro. This value varies from distribution to distribution, for example, it is 1024 on RHEL 6.3, 2048 on SLES 11 SP2.</p><pre><code>  * This specifies the maximum I/O size that the host will issue to the target storage. linxu 4.1x default value was 1280, Typically it is 512KiB (512 Bytes,1024 sectors, 4KN, 1024 sectors means 4096KiB)</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/sda/queue/max_sectors_kb </span><br><span class="line">1280</span><br></pre></td></tr></table></figure></li><li><p>max_segments (RO) - This parameter enables low level driver to set an upper limit on the number of hardware data segments in a request. In the HBA drivers, this is also known as sg_tablesize.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/sda/queue/max_segments</span><br><span class="line">128</span><br></pre></td></tr></table></figure></li><li><p>max_segment_size (RO) - This parameter enables low level driver to set an upper limit on the size of each data segment in an I/O request in bytes. If clustering is enabled on the low level driver it is set to 65536 or it is set to system PAGE_SIZE by default, which is typically 4K. The maximum I/O size is determined by the following:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/sda/queue/max_segment_size </span><br><span class="line">65536</span><br></pre></td></tr></table></figure><p>MAX_IO_SIZE_KB = MIN(max_sectors_kb, (max_segment_size * max_segments)/1024)<br>1280 KB       = MIN(1280, (65536*128)/1024) = MIN(1280, 8192)</p></li></ul><p>In this command, PAGE_SIZE is architecture independent. It is 4096 for x86_64.</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">or</span> you could <span class="keyword">set</span> it <span class="keyword">from</span> <span class="number">1280</span> to <span class="number">8192</span></span><br><span class="line">$ echo <span class="number">8192</span> &gt; max_sectors_kb</span><br></pre></td></tr></table></figure><ul><li><p>physical_block_size</p><ul><li>Smallest internal unit on which the device can operate<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4KN HDD, there is no 512n in the large capacity HDD</span></span><br><span class="line">$ cat /sys/block/sdj/queue/physical_block_size</span><br><span class="line">4096</span><br></pre></td></tr></table></figure></li></ul></li><li><p>logical_block_size</p><ul><li>Used externally to address a location on the device<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4KN</span></span><br><span class="line">$ cat /sys/block/sdj/queue/logical_block_size</span><br><span class="line">4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 512e</span></span><br><span class="line">$ cat /sys/block/sdi/queue/logical_block_size</span><br><span class="line">512</span><br></pre></td></tr></table></figure></li></ul></li><li><p>alignment_offset</p><ul><li>The number of bytes that the beginning of the Linux block device (partition/MD/LVM device) is offset from the underlying physical alignment<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/sdj/alignment_offset</span><br><span class="line">0</span><br></pre></td></tr></table></figure></li></ul></li><li><p>minimum_io_size</p><ul><li>The devices preferred minimum unit for random I/O</li><li>The minimum_io_size and optimal_io_size values for /dev/sdX devices are retrieved by the kernel by inquiring the storage vendor-provided I/O Limits within the device VPD pages.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/sdj/queue/minimum_io_size</span><br><span class="line">4096</span><br></pre></td></tr></table></figure></li></ul></li><li><p><a href="http://fibrevillage.com/storage/563-storage-i-o-alignment-and-size">optimal_io_size</a></p><ul><li>The devices preferred unit for streaming I/O<ul><li>Only one layer in the I/O stack should adjust for a non-zero alignment_offset; once a layer adjusts accordingly, it will export a device with an alignment_offset of zero. </li><li>A striped Device Mapper (DM) device created with LVM must export a minimum_io_size and optimal_io_size relative to the stripe count (number of disks) and user-provided chunk size.<br>Note<br>Red Hat Enterprise Linux 7 cannot distinguish between devices that dont provide I/O hints and those that do so with alignment_offset= 0 and optimal _io_size= 0 . Such a device might be a single SAS 4K device; as such, at worst 1MB of space is lost at the start of the disk.</li></ul></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/sdj/queue/optimal_io_size</span><br><span class="line">0</span><br></pre></td></tr></table></figure><p>If wanting to change the optimal_io_size on a dm(multipath) device add parameter max_sectors_kb to the /etc/multipath.conf file for the specific storage array (and change the underlying sd devices using an udev rule).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># I don &#x27;t know why only zero in [1] and [2] location</span></span><br><span class="line"></span><br><span class="line">$ sg_inq -p 0xb0 /dev/sdacn</span><br><span class="line">VPD INQUIRY: Block limits page (SBC)</span><br><span class="line">  Optimal transfer length granularity: 1 blocks   &lt;&lt; [1] block-size x this field = minimal_io_size, block-size defined <span class="keyword">in</span> READCAP <span class="built_in">command</span> below.</span><br><span class="line">  Maximum transfer length: 8192 blocks</span><br><span class="line">  Optimal transfer length: 8192 blocks            &lt;&lt; [2] block-size x this field = optimal_io_size</span><br><span class="line">  Maximum prefetch, xdread, xdwrite transfer length: 0 blocks</span><br><span class="line"></span><br><span class="line">$ sg_readcap -16 /dev/sdacn</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=0, p_type=0, p_i_exponent=0</span><br><span class="line">   Thin provisioning: tpe=0, tprz=0</span><br><span class="line">   Last logical block address=4194303 (0x3fffff), Number of logical blocks=4194304</span><br><span class="line">   Logical block length=512 bytes                &lt;&lt; [3] this is block size (length), multiplier <span class="keyword">for</span> above fields.</span><br><span class="line">   Logical blocks per physical block exponent=0</span><br><span class="line">   Lowest aligned logical block address=0</span><br><span class="line">Hence:</span><br><span class="line">   Device size: 2147483648 bytes, 2048.0 MiB, 2.15 GB</span><br><span class="line"></span><br><span class="line">$ grep -v <span class="string">&quot;zz&quot;</span> /sys/block/sdacn/queue/*io_size</span><br><span class="line">/sys/block/sdacn/queue/minimum_io_size:512       &lt;&lt; [1] 1 block     x [3] 512-bytes/block =     512 bytes.</span><br><span class="line">/sys/block/sdacn/queue/optimal_io_size:4194304   &lt;&lt; [2] 8192 blocks x [3] 512-bytes/block = 4194034 bytes.</span><br></pre></td></tr></table></figure><p>This does hint to the fact that it is possible to see different optimal_io_size for the same LUN across different access paths. This can happen (from storage controller configuration issues, manual changes (echo) or a trigger of udev rules), which could cause an exceptionally high optimal_io_size for the dm(multipath) device or paths which will not function. If this is seen, and the sg_readcap and sg_inq is lining up with what is in /sys, it is likely due to a storage controller configuration issue, and the systems SAN vendor should be contacted for analysis. Below is an example of what this would look like, noting that 4278190080 is the LCM (least common multiple) of 4177920 and 16777216</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ multipath -ll disk1</span><br><span class="line">disk1 (wwid_entry_omitted) dm-108 3PARdata,VV</span><br><span class="line">size=80G features=<span class="string">&#x27;1 queue_if_no_path&#x27;</span> hwhandler=<span class="string">&#x27;1 alua&#x27;</span> wp=rw</span><br><span class="line">`-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=1 status=active</span><br><span class="line">  |- 0:0:0:152 sdcg 69:64   active ready running</span><br><span class="line">  |- 1:0:0:152 sdjc 8:352   active ready running</span><br><span class="line">  |- 0:0:1:152 sdfr 130:208 active ready running</span><br><span class="line">  `- 1:0:1:152 sdmn 69:496  active ready running</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> dm-108 sdcg sdjc sdfr sdmn ; <span class="keyword">do</span> cat /sys/block/<span class="variable">$i</span>/queue/optimal_io_size ; <span class="keyword">done</span></span><br><span class="line">4278190080     &lt;&lt; LCM of 16777216 and 4177920</span><br><span class="line">16777216       &lt;&lt; Optimal transfer length: 32768 blocks x Logical block length=512 bytes</span><br><span class="line">16777216       &lt;&lt; Optimal transfer length: 32768 blocks x Logical block length=512 bytes</span><br><span class="line">4177920        &lt;&lt; Optimal transfer length: 8160 blocks x Logical block length=512 bytes</span><br><span class="line">4177920        &lt;&lt; Optimal transfer length: 8160 blocks x Logical block length=512 bytes</span><br></pre></td></tr></table></figure><h5 id="parted-alignment"><a href="#parted-alignment" class="headerlink" title="parted alignment"></a>parted alignment</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ parted /dev/sdX <span class="string">&#x27;unit s print&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Is the partition align ?</span></span><br><span class="line">$ parted /dev/sdX align-check optimal 1</span><br><span class="line">1 aligned</span><br><span class="line"></span><br><span class="line"><span class="comment">#auto align</span></span><br><span class="line">$ parted -a optimal /dev/sdX mkpart primary 0% xxTB</span><br><span class="line"><span class="comment"># cylinder,none,minimal,optimal</span></span><br></pre></td></tr></table></figure><p>GUID Partition Table Scheme<br><img src="/img/GUID_Partition_Table_Scheme.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">LBA0 prrotective MBR</span><br><span class="line">-------------</span><br><span class="line">LBA1 Primary GPT header</span><br><span class="line">-------------</span><br><span class="line">LBA2 Entry1|Entry2|Entry3|Entry4</span><br><span class="line">-------------</span><br><span class="line">LBA3 Entries 5-128</span><br><span class="line">------------</span><br><span class="line">LBA34  Partirion1,2..</span><br><span class="line">LBA-34 remaining Partitions</span><br><span class="line">------------</span><br><span class="line">LBA-33  Entry1|Entry2|entry3|Entry4</span><br><span class="line">------------</span><br><span class="line">LBA-2   Entries 5-128</span><br><span class="line">------------</span><br><span class="line">LBA-1   Secondary GPT Header</span><br><span class="line">----</span><br></pre></td></tr></table></figure><h5 id="Hot-plugin-the-scsi-device"><a href="#Hot-plugin-the-scsi-device" class="headerlink" title="Hot plugin the scsi device"></a>Hot plugin the scsi device</h5><p>What is h c t l<br>          h == hostadapter id (first one being 0)<br>          c == SCSI channel on hostadapter (first one being 0)<br>          t == ID (target)<br>          l == LUN (first one being 0)<br>Generic SCSI devices can also be accessed via the bsg driver in Linux. By default, the bsg drivers device node names  are  of  the  form /dev/bsg/H:C:T:L.  So,  for example, the SCSI device shown by this utility on a line starting with the tuple 6:0:1:2 could be accessed via the bsg driver with the /dev/bsg/6:0:1:2 device node name.</p><h5 id="Add-the-scsi-device"><a href="#Add-the-scsi-device" class="headerlink" title="Add the scsi device"></a>Add the scsi device</h5><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;- - -&quot;</span> &gt; /sys/<span class="keyword">class</span>/<span class="symbol">scsi_host</span>/<span class="symbol">host</span>&lt;<span class="symbol">h</span>&gt;/<span class="symbol">scan</span></span><br><span class="line"><span class="symbol">echo</span> &quot;<span class="symbol">c</span> <span class="symbol">t</span> <span class="symbol">l</span>&quot; &gt;  /<span class="symbol">sys</span>/<span class="symbol">class</span>/<span class="symbol">scsi_host</span>/<span class="symbol">host</span>&lt;<span class="symbol">h</span>&gt;/<span class="symbol">scan</span></span><br></pre></td></tr></table></figure><h5 id="Refresh-the-scsi-device"><a href="#Refresh-the-scsi-device" class="headerlink" title="Refresh the scsi device"></a>Refresh the scsi device</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/block/sdau/device/rescan</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/scsi_device/h:c:t:l/device/rescan</span><br></pre></td></tr></table></figure><h5 id="Remove-the-scsi-device"><a href="#Remove-the-scsi-device" class="headerlink" title="Remove the scsi device"></a>Remove the scsi device</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/scsi_device/h:c:t:l/device/delete</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/block/&lt;dev&gt;/device/delete</span><br></pre></td></tr></table></figure><h4 id="IO-schdule"><a href="#IO-schdule" class="headerlink" title="IO schdule"></a>IO schdule</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">schdule = deadline</span><br><span class="line">nr_request = 1024</span><br><span class="line">max_sector_kb = 1024</span><br><span class="line">read_ahead_kb = 8192</span><br><span class="line">rq_affinity = 2</span><br><span class="line"><span class="comment"># For storage configurations that need to maximize distribution of completion processing setting this option to &#x27;2&#x27; forces the completion to run on the requesting cpu (bypassing the &quot;group&quot; aggregation logic).</span></span><br><span class="line"></span><br><span class="line">vm.dirty_ratio = 40</span><br><span class="line"><span class="comment"># dirty_ratio     &quot;Dirty&quot; memory is that waiting to be written to disk. dirty_ratio is the number of memory pages at which a process will start writing out dirty data, expressed as a percentage out of the total free and reclaimable pages. A default of 20 is reasonable. Increase to 40 to improve throughput, decrease it to 5 to 10 to improve latency, even lower on systems with a lot of memory.</span></span><br><span class="line"></span><br><span class="line">vm.dirty_background_ratio = 20</span><br><span class="line"><span class="comment"># dirty_background_ratio  Similar, but this is the number of memory pages at which the kernel background flusher thread will start writing out dirty data, expressed as a percentage out of the total free and reclaimable pages. Set this lower than dirty_ratio, dirty_ratio/2 makes sense and is what the kernel does by default. This page shows that dirty_ratio has the greater effect. Tune dirty_ratio for performance, then set dirty_background_ratio to half that value.</span></span><br><span class="line"></span><br><span class="line">vm.vfs_cache_pressure = 50</span><br><span class="line">This sets the <span class="string">&quot;pressure&quot;</span> or the importance the kernel places upon reclaiming memory used <span class="keyword">for</span> caching directory and inode objects. The default of 100 or relative <span class="string">&quot;fair&quot;</span> is appropriate <span class="keyword">for</span> compute servers. Set to lower than 100 <span class="keyword">for</span> file servers on <span class="built_in">which</span> the cache should be a priority. Set higher, maybe 500 to 1000, <span class="keyword">for</span> interactive systems.</span><br><span class="line"></span><br><span class="line">overcommit_memory       Allows <span class="keyword">for</span> poorly designed programs <span class="built_in">which</span> malloc() huge amounts of memory <span class="string">&quot;just in case&quot;</span> but never really use it. Set this to 0 (disabled) unless you really need it.</span><br></pre></td></tr></table></figure><h4 id="deadline-parameters"><a href="#deadline-parameters" class="headerlink" title="deadline parameters"></a><a href="https://cromwell-intl.com/open-source/performance-tuning/disks.html">deadline parameters</a></h4><p>fifo_batch      Number of read or write operations to issue in one batch.  Lower values may further reduce latency. Higher values can increase throughput on rotating mechanical disks, but at the cost of worse latency. You selected the deadline scheduler to limit latency, so you probably dont want to increase this, at least not by very much.</p><p>read_expire     Number of milliseconds within which a read request should be served. Reduce this from the default of 500 to 100 on a system with interactive users.</p><p>rite_expire     Number of milliseconds within which a write request should be served.<br>Leave at default of 5000, let write operations be done asynchronously in the background unless your specialized application uses many synchronous writes.</p><p>writes_starved  Number read batches that can be processed before handling a write batch. Increase this from default of 2 to give higher priority to read operations.</p><p>nr_requests     Maximum number of read and write requests that can be queued at one time before the next process requesting a read or write is put to sleep. Default value of 128 means 128 read requests and 128 write requests can be queued at once. Larger values may increase throughput for workloads writing many small files, smaller values increase throughput with larger I/O operations. You could decrease this if you are using latency-sensitive applications, but then you shouldnt be using NOOP if latency is sensitive!</p><p>read_ahead_kb   Number of kilobytes the kernel will read ahead during a sequential read operation. 128 kbytes by default, if the disk is used with LVM the device mapper may benefit from a higher value. If your workload does a lot of large streaming reads, larger values may improve performance.</p><p>max_sectors_kb  Maximum allowed size of an I/O request in kilobytes, which must be within these bounds:<br>Min value = max(1, logical_block_size/1024)<br>Max value = max_hw_sectors_kb</p><p>rotational      Should be 0 (no) for solid-state disks, but some do not correctly report their status to the kernel. If incorrectly set to 1 for an SSD, set it to 0 to disable unneeded scheduler logic meant to reduce number of seeks.</p><h3 id="scsi-driver-error-handaling-EH"><a href="#scsi-driver-error-handaling-EH" class="headerlink" title="scsi_driver error handaling (EH)"></a>scsi_driver error handaling (EH)</h3><p>scsi driver error Handaling (EH) timeout  eh_timeout (from default 10 second to 5 seconds)<br>HBA reset time - eh_deadline (from disable/0 to 5 seconds, default was off)</p><p>The SCSI error handling (EH) mechanism attempts to perform error recovery on failed SCSI devices. The SCSI host object eh_deadline parameter enables you to configure the maximum amount of time for the recovery. After the configured time expires, SCSI EH stops and resets the entire host bus adapter (HBA).</p><h3 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a><a href="https://stackoverflow.com/questions/4458183/how-the-util-of-iostat-is-computed">iostat</a></h3><p>%util = blkio.ticks / deltams * 100%</p><p>deltams is the time elapsed since last snapshot in ms. It uses CPU stats from /proc/stat presumably because it gives better results than to rely on system time, but I dont know for sure. (Side note: for some reason the times are divided by HZ, while the documentation states its in USER_HZ, I dont understand that.)<br>blkio.ticks is # of milliseconds spent doing I/Os, from /proc/diskstats docs:</p><p>Field  9  # of I/Os currently in progress<br>  The only field that should go to zero. Incremented as requests are<br>  given to appropriate struct request_queue and decremented as they finish.<br>Field 10  # of milliseconds spent doing I/Os<br>  This field increases so long as field 9 is nonzero.</p><p>struct ext_disk_stats *xds<br>xds-&gt;util</p><p>Hypothesis:<br>Simple understand about util% =  IO time/the time(the clock) , if IO time &gt;= the time, the utils = 100%(in 1s), else, that means some times there is no IO ops in this second<br>Why no ops in this sec ? maybe something hang, maybe just no any IO loading</p><p>In SAS arch, there are multiple lane/phy in it, if single lane/phy has full IO loading, the util% will reach 100%<br>Yes the device could be parallel, there are a lot of lane/phy are free, but the single lane or phy has full. I think the util% was right</p><ol><li>The single path(resource) was full (nvme,sas ssd)</li><li>If the block device s performance is infinity,  All of CPU/Mem/NIC speed behind it. the bottle-neck not in the block device. some of syscall cause the util%=100% too</li><li>Could the util% show the device are busy ? That right, util% is not enough, Could the iostat show the device are busy ? Yes, it can<br>You can watch the await and util%, you could know the device busy or free. it s so easy</li></ol><p>iostat was not correct, it just show the wrong value. That s alarmist for iostat ,and it s so funny</p><p>This guy analyzed the code, but it s not enough, he was not understand the iostat output.<br>The <a href="https://bean-li.github.io/dive-into-iostat/">example</a> is good.</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ID</span>      Time    Ops                                  in_flight  stamp   stamp_delta           io_ticks            time_in_queue</span><br><span class="line"><span class="attribute">0</span>       <span class="number">100</span>     new request in the queue                <span class="number">0</span>       <span class="number">0</span>       no need caculate          <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line"><span class="attribute">1</span>       <span class="number">100</span>.<span class="number">10</span>  another request go to the queue         <span class="number">1</span>       <span class="number">100</span>     <span class="number">100</span>.<span class="number">10</span>-<span class="number">100</span> = <span class="number">0</span>.<span class="number">1</span>        <span class="number">0</span>.<span class="number">1</span>                 <span class="number">0</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">2</span>       <span class="number">101</span>.<span class="number">20</span>  finish the first request                <span class="number">2</span>       <span class="number">100</span>.<span class="number">10</span>  <span class="number">101</span>.<span class="number">20</span>-<span class="number">100</span>.<span class="number">10</span> = <span class="number">1</span>.<span class="number">1</span>     <span class="number">1</span>.<span class="number">2</span>(<span class="number">1</span>.<span class="number">1</span>+<span class="number">0</span>.<span class="number">1</span>)        <span class="number">0</span>.<span class="number">1</span>+<span class="number">1</span>.<span class="number">1</span>*<span class="number">2</span> (total <span class="number">2</span>x io requests) = <span class="number">2</span>.<span class="number">3</span></span><br><span class="line"><span class="attribute">3</span>       <span class="number">103</span>.<span class="number">60</span>  finish the second request               <span class="number">1</span>       <span class="number">101</span>.<span class="number">20</span>  <span class="number">103</span>.<span class="number">60</span>-<span class="number">101</span>.<span class="number">20</span> = <span class="number">2</span>.<span class="number">4</span>     <span class="number">3</span>.<span class="number">6</span>                 <span class="number">2</span>.<span class="number">3</span>+<span class="number">2</span>.<span class="number">4</span>*<span class="number">1</span>=<span class="number">4</span>.<span class="number">7</span></span><br><span class="line"><span class="attribute">4</span>       <span class="number">153</span>.<span class="number">60</span>  The third request go to the queue       <span class="number">0</span>       <span class="number">103</span>.<span class="number">60</span>  no need caculate        <span class="number">3</span>.<span class="number">6</span>                 <span class="number">4</span>.<span class="number">7</span></span><br><span class="line"><span class="attribute">5</span>       <span class="number">153</span>.<span class="number">90</span>  Finish the third request                <span class="number">1</span>       <span class="number">153</span>.<span class="number">60</span>  <span class="number">153</span>.<span class="number">90</span> - <span class="number">153</span>.<span class="number">60</span> = <span class="number">0</span>.<span class="number">3</span>   <span class="number">3</span>.<span class="number">9</span>                 <span class="number">4</span>.<span class="number">7</span>+<span class="number">0</span>.<span class="number">3</span> * <span class="number">1</span>= <span class="number">5</span></span><br></pre></td></tr></table></figure><p>In 53.9s, All io requests in 3.9s, the other times has no any IO in the queue.<br>io_ticks  &gt; util %<br>time_in_queue &gt; avgqu-sz</p><h3 id="Re-import-LVM"><a href="#Re-import-LVM" class="headerlink" title="Re-import LVM"></a>Re-import LVM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ storcli64 /call/fall show</span><br><span class="line">$ storcli64 /c0/fall import</span><br><span class="line">$ vgscan</span><br><span class="line"> Reading all physical volumes.  This may take a <span class="keyword">while</span>...</span><br><span class="line">  Found volume group <span class="string">&quot;xx&quot;</span> using metadata <span class="built_in">type</span> lvm2</span><br><span class="line">$ vgchange -ay</span><br><span class="line">  1 logical volume(s) <span class="keyword">in</span> volume group <span class="string">&quot;xx&quot;</span> now active</span><br><span class="line">$ lvs</span><br><span class="line">xx_lv  xx_vg -wi-a-----  1t</span><br><span class="line">$ lvdisplay</span><br></pre></td></tr></table></figure><h3 id="Advance-reformat-4Kn-SCSI-devs-to-512-Bytes-sector"><a href="#Advance-reformat-4Kn-SCSI-devs-to-512-Bytes-sector" class="headerlink" title="Advance reformat 4Kn SCSI devs to 512 Bytes sector"></a>Advance reformat 4Kn SCSI devs to 512 Bytes sector</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl -a -d scsi /dev/sdd</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH728080AL4200</span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   4096 bytes</span><br><span class="line"></span><br><span class="line">$ smartctl -a -d scsi /dev/sdc</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH728080AL4200</span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br></pre></td></tr></table></figure><p>Update: If you have a lot of drives to format, it may take a long time with sg_format as it wait until it finished before doing the next one (with a while loop I mean). Useful tip is to use the -e flag with sg_format then monitor operations with sg_turs -p but it may hang you tty as well.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/class/block/sdc/queue/hw_sector_size</span><br><span class="line">4096</span><br><span class="line"></span><br><span class="line">$ sg_format --format --size=512 /dev/sdc</span><br><span class="line">HGST      HUH728080AL4200   A7J0   peripheral_type: disk [0x0]</span><br><span class="line">&lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">Mode Sense (block descriptor) data, prior to changes:</span><br><span class="line">  Number of blocks=1953506646 [0x74702556]</span><br><span class="line">  Block size=4096 [0x1000]</span><br><span class="line"></span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 10 seconds</span><br><span class="line">    ALL data on /dev/sdc will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 5 seconds</span><br><span class="line">    ALL data on /dev/sdc will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line"></span><br><span class="line">Format has started</span><br><span class="line">FORMAT Complete</span><br><span class="line"></span><br><span class="line">$ sg_turs -v /dev/sdb</span><br><span class="line">   <span class="built_in">test</span> unit ready cdb: 00 00 00 00 00 00</span><br><span class="line">   <span class="built_in">test</span> unit ready:  Descriptor format, current;  Sense key: Not Ready Additional sense: Logical unit not ready, format <span class="keyword">in</span> progress</span><br><span class="line">   Descriptor <span class="built_in">type</span>: Information    00 00 00 00 00 00 00 00 00 00</span><br><span class="line">   Descriptor <span class="built_in">type</span>: Command specific    0x0000000000000000</span><br><span class="line">   device not ready</span><br><span class="line"></span><br><span class="line">$ sg_inq -v /dev/sdb</span><br><span class="line"><span class="comment"># it will show the process of percent</span></span><br><span class="line"></span><br><span class="line">$ cat /sys/class/block/sdc/queue/hw_sector_size</span><br><span class="line">512</span><br></pre></td></tr></table></figure><h4 id="intel-nvme-switch-to-AF"><a href="#intel-nvme-switch-to-AF" class="headerlink" title="intel nvme switch to AF"></a>intel nvme switch to AF</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#change 512 Bytes to 4096 Bytes</span></span><br><span class="line">$ nvme format -b 4096 /dev/nvme0n1</span><br><span class="line"></span><br><span class="line">$ isdct start -intelssd 0 Function=NVMEFormat LBAForma=3 SecureEraseSetting=0 ProtectionInformation=0 MetaDataSetting=0</span><br></pre></td></tr></table></figure><h4 id="SATA-only-support-512-and-4096-Bytes"><a href="#SATA-only-support-512-and-4096-Bytes" class="headerlink" title="SATA only support 512 and 4096 Bytes"></a>SATA only support 512 and 4096 Bytes</h4><h4 id="long-data-sector"><a href="#long-data-sector" class="headerlink" title="long-data-sector"></a>long-data-sector</h4><p>From vendor spec, only SAS device support this feature<br>You could format the driver logic sector to 4096,4112,4116,4224KB or 512,520 Bytes<br>SATA device only support 4096 or 512</p><p>You could get the logic sector size(4096,4112,4224), the size could be read from driver</p><h5 id="T10-DIF-PI"><a href="#T10-DIF-PI" class="headerlink" title="T10 DIF/PI"></a><a href="https://www.seagate.com/files/staticfiles/docs/pdf/whitepaper/safeguarding-data-from-corruption-technology-paper-tp621us.pdf">T10 DIF/PI</a></h5><p>T10 DIF/PI for avoid data corruption from some device no CRC/ECC product, so it check the data consistency from the source to the destination</p><p>The user data in ecc memory(512B) &gt; SAS HBA/iscsi driver(520B) -&gt; SAS IO expander/or some very complicated network contains HBA or the others -&gt; Storage medium(520)<br>Because the hardware just check from input or output port from itself</p><p>The risk of corrupted data falling through the inherent cracks in this protection methodology is significant, and the havoc such undetected, silent data corruption could wreak (lost or inaccurate data, significant downtime) is substantial</p><h5 id="About-DIF-520-Bytes"><a href="#About-DIF-520-Bytes" class="headerlink" title="About DIF 520 Bytes"></a><a href="https://lwn.net/Articles/280023/">About DIF 520 Bytes</a></h5><p>SCSI drives can usually be reformatted to 520-byte sectors, yielding 8 extra bytes per sector.  These 8 bytes have traditionally been used by RAID controllers to store internal protection information.</p><p>DIF (Data Integrity Field) is an extension to the SCSI Block Commands that standardizes the format of the 8 extra bytes and defines ways to interact with the contents at the protocol level.  We refer to the extra information as integrity metadata or IMD.<br>Each 8-byte DIF tuple is split into three chunks:<br>        * a 16-bit guard tag containing a CRC of the 512-byte data portion of the sector.<br>        * a 16-bit application tag which is up for grabs.<br>        * a 32-bit reference tag which contains an incrementing counter for each sector.  For DIF Type 1 it also needs to match the physical LBA on the drive.<br>There are three types of DIF defined: Type 1, Type 2, and Type 3.  My patches are Type 1 only, although Type 3 devices should work.  Type 2 depends on 32-byte CDBs and is in progress.<br>Since the DIF tuple format is standardized, both initiators and targets (as well as potentially transport switches in-between) to verify the integrity of the data going over the bus.<br>When writing, the HBA will DMA 512-byte sectors from host memory, generate the matching integrity metadata and send out 520-byte sectors on the wire.  The disk will verify the integrity of the data before committing it to stable storage<br>When reading, the drive will send 520-byte sectors to the HBA.  The HBA will verify the data integrity and DMA 512-byte sectors to host memory.<br>IOW, DIF provides means for added integrity protection between HBA and disk</p><ul><li><a href="https://www.seagate.com/files/staticfiles/docs/pdf/whitepaper/safeguarding-data-from-corruption-technology-paper-tp621us.pdf">type 0</a><ul><li>Describes a drive that is not formatted with PI information bytes. This allows for legacy support in non-PI systems.</li></ul></li><li>type 1<ul><li>Provides support of PI protection using 10- and 16-byte commands. The RDPROTECT and WRTPROTECT bits allow for checking control through the CDB. Eight bytes of Protection Information are transmitted at sector boundaries across the interface if RDPROTECT and WRTPROTECT bits are non-zero values. Type I does not allow the use of 32-byte commands.</li></ul></li><li>type 2<ul><li>Provides checking control and additional expected fields within the 32-byte CDBs. Eight bytes of Protection Information are transmitted at sector boundaries across the interface if RDPROTECT and WRTPROTECT bits are non-zero values. Type II does allow the use of 10- and 16-byte commands with zero values in the RDPROTECT and WRTPROTECT fields. The drive will generate a dummy (for example, 0xFFFF) eight bytes of Protection Information in the media, but these eight bytes will not be transferred to the host during read.</li></ul></li><li>type 3<ul><li>seagate not support type 3</li></ul></li></ul><p>The T10-PI standard is an extension of the existing T10 SCSI Block Commands specification; covering communication between SCSI controllers and storage devices, Protection Information (PI) adds an extra eight bytes of information to the 512-byte sectors typical of enterprise hard drives. Increasing sector size to 520 bytes, these eight bytes of metadata consist of guard (GRD), application (APP) and reference (REF) tags that are used to verify the 512 bytes of data in the sector </p><p>512 bytes of data<br>GRD 16-bit guard tag(crc of 512 byte data portion) 512-514 Bytes<br>APP 16-bit application tag 514-516 Bytes (application custom)<br>REF 32-bit reference tag 516-519 Bytes (For protect Misdirected Writes)<br>    Misdirected Write: the ture write LAB was not match with the write LBA target</p><p>DIF=512+8, DIF need apply a 520 bytes buffer<br>DIX=512B*8 (data buffer), 8x8Bytes(pi buffer), two parts</p><p>A device that supports protection information (i.e. supports one or more protection types of 1 or higher) sets the PROTECT bit in its standard INQUIRY response. It  also  sets the  SPT  field  in the EXTENDED INQUIRY VPD page response to indicate which protection types it supports. The current protection type of a disk can be found in the P_TYPE and PROT_EN fields in the response of a READ CAPACITY (16) command (e.g. with the sg_readcap long utility).</p><p>type 0: No checking but target device must generate on WRITE<br>type 1: GUARD + REF checking (LBA)<br>type 2: GUARD + REF checking (Extended Indirect LBA)<br>        READ(32)/WRITE(32) only<br>type 3: GUARD tag</p><p>Protection Information is intended as a standardized approach to system level LRC traditionally provided by systems using 520 byte formatted LBAs. Drives formatted with PI information provide the same, common LBA count (i.e. same capacity point) as non-PI formatted drives. Sequential performance of a PI drive will be reduced by approximately 1.56% due to the extra overhead of PI being transferred from the media that is not calculated as part of the data transferred to the host. To determine the full transfer rate of a PI drive, transfers should be calculated by adding the 8 extra bytes of PI to the transferred LBA length, i.e. 512 + 8 = 520. PI formatted drives are physically formatted to 520 byte sectors that store 512 bytes<br>of customer data with 8 bytes of Protection Information appended to it. The advantage of PI is that the Protection Information bits can be managed at the HBA and HBA driver level. Allowing a system that typically does not support 520 LBA formats to integrate this level of protection. Protection Information is valid with any supported LBA size. 512 LBA size is used here as common example.</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">520</span>-Bytes Sector on Protection Information Disk Drive</span><br><span class="line"><span class="number">512</span>-Bytes  +  <span class="number">8</span> Bytes (metadata)</span><br><span class="line"><span class="number">512</span>-Bytes = User data</span><br><span class="line"><span class="number">8</span> Bytes = End-to-End Check = <span class="number">2</span> Bytes(logical block guard, CRC) + <span class="number">2</span> Bytes(logical block application guard) + <span class="number">4</span> Bytes(logical block <span class="built_in">ref</span>erence tag)</span><br><span class="line"></span><br><span class="line">#smart  info </span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH721212AL5200</span><br><span class="line">Revision:             NS05</span><br><span class="line">Compliance:           SPC<span class="number">-4</span></span><br><span class="line">User Capacity:        <span class="number">11</span>,<span class="number">756</span>,<span class="number">399</span>,<span class="number">230</span>,<span class="number">976</span> bytes [<span class="number">11.7</span> TB]</span><br><span class="line">Logical block size:   <span class="number">512</span> bytes</span><br><span class="line">Physical block size:  <span class="number">4096</span> bytes</span><br><span class="line">Formatted with type <span class="number">2</span> protection</span><br><span class="line"><span class="number">8</span> bytes of protection information per logical block</span><br><span class="line">LU <span class="keyword">is</span> fully provisioned</span><br><span class="line">Rotation Rate:        <span class="number">7200</span> rpm</span><br><span class="line"></span><br><span class="line">#type <span class="number">2</span> ,<span class="number">512</span> example</span><br><span class="line">$ sg_readcap -l /dev/sdj</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=<span class="number">1</span>, p_type=<span class="number">1</span>, p_i_exponent=<span class="number">0</span> [type <span class="number">2</span> protection]</span><br><span class="line">   Logical block provisioning: lbpme=<span class="number">0</span>, lbprz=<span class="number">0</span></span><br><span class="line">   Last logical block address=<span class="number">19134414847</span> (<span class="number">0x4747fffff</span>), Number of logical blocks=<span class="number">19134414848</span></span><br><span class="line">   Logical block length=<span class="number">512</span> bytes</span><br><span class="line">   Logical blocks per physical block exponent=<span class="number">3</span></span><br><span class="line">   Lowest aligned logical block address=<span class="number">0</span></span><br><span class="line">Hence:</span><br><span class="line">   Device size: <span class="number">9796820402176</span> bytes, <span class="number">9342976.0</span> MiB, <span class="number">9796.82</span> GB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#type <span class="number">0</span>, <span class="number">4</span>K example</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=<span class="number">0</span>, p_type=<span class="number">0</span>, p_i_exponent=<span class="number">0</span></span><br><span class="line">   Logical block provisioning: lbpme=<span class="number">0</span>, lbprz=<span class="number">0</span></span><br><span class="line">   Last LBA=<span class="number">2441609215</span> (<span class="number">0x9187ffff</span>), Number of logical blocks=<span class="number">2441609216</span></span><br><span class="line">   Logical block length=<span class="number">4096</span> bytes</span><br><span class="line">   Logical blocks per physical block exponent=<span class="number">0</span></span><br><span class="line">   Lowest aligned LBA=<span class="number">0</span></span><br><span class="line">Hence:</span><br><span class="line">   Device size: <span class="number">10000831348736</span> bytes, <span class="number">9537536.0</span> MiB, <span class="number">10000.83</span> GB, <span class="number">10.00</span> TB</span><br><span class="line"></span><br><span class="line">$ sg_readcap -<span class="number">-16</span> -b /dev/sdj</span><br><span class="line"><span class="number">0x474800000</span> <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line"><span class="number">10</span>TB models with PI bytes</span><br><span class="line">Sector   Dec           hex          <span class="number">10</span>TB models w/o PI bytes</span><br><span class="line"><span class="number">512</span> <span class="number">19</span>,<span class="number">134</span>,<span class="number">414</span>,<span class="number">848</span> <span class="number">474800000</span>        <span class="number">19</span>,<span class="number">532</span>,<span class="number">873</span>,<span class="number">728</span> <span class="number">48</span>C400000 (<span class="number">10000831348736</span> = <span class="number">19</span>,<span class="number">532</span>,<span class="number">873</span>,<span class="number">728</span> * <span class="number">512</span> = SATA <span class="number">10</span>TB raw size)</span><br><span class="line"><span class="number">520</span> <span class="number">18</span>,<span class="number">845</span>,<span class="number">007</span>,<span class="number">872</span> <span class="number">463400000</span>        <span class="number">19</span>,<span class="number">134</span>,<span class="number">414</span>,<span class="number">848</span> <span class="number">474800000</span></span><br><span class="line"><span class="number">524</span> <span class="number">18</span>,<span class="number">704</span>,<span class="number">498</span>,<span class="number">688</span> <span class="number">45</span>AE00000        <span class="number">18</span>,<span class="number">989</span>,<span class="number">711</span>,<span class="number">360</span> <span class="number">46</span>BE00000</span><br><span class="line"><span class="number">528</span> <span class="number">18</span>,<span class="number">563</span>,<span class="number">989</span>,<span class="number">504</span> <span class="number">452800000</span>        <span class="number">18</span>,<span class="number">845</span>,<span class="number">007</span>,<span class="number">872</span> <span class="number">463400000</span></span><br><span class="line"><span class="number">4096</span> <span class="number">2</span>,<span class="number">424</span>,<span class="number">569</span>,<span class="number">856</span> <span class="number">90840000</span>         <span class="number">2</span>,<span class="number">441</span>,<span class="number">609</span>,<span class="number">216</span> <span class="number">91880000</span> (<span class="number">10000831348736</span> = <span class="number">2</span>,<span class="number">441</span>,<span class="number">609</span>,<span class="number">216</span> * <span class="number">4096</span> = SATA <span class="number">10</span>TB raw size)</span><br><span class="line"><span class="number">4160</span> <span class="number">2</span>,<span class="number">387</span>,<span class="number">345</span>,<span class="number">408</span> <span class="number">8E4</span>C0000         <span class="number">2</span>,<span class="number">391</span>,<span class="number">801</span>,<span class="number">856</span> <span class="number">8E900000</span></span><br><span class="line"><span class="number">4192</span> <span class="number">2</span>,<span class="number">368</span>,<span class="number">995</span>,<span class="number">328</span> <span class="number">8</span>D340000         <span class="number">2</span>,<span class="number">373</span>,<span class="number">713</span>,<span class="number">920</span> <span class="number">8</span>D7C0000 <span class="number">1</span></span><br><span class="line"><span class="number">4224</span> <span class="number">2</span>,<span class="number">351</span>,<span class="number">169</span>,<span class="number">536</span> <span class="number">8</span>C240000         <span class="number">2</span>,<span class="number">355</span>,<span class="number">625</span>,<span class="number">984</span> <span class="number">8</span>C680000</span><br><span class="line"></span><br><span class="line"># models with PI bytes, the page only show <span class="number">512</span> <span class="keyword">or</span> <span class="number">4096</span> bytes, the extra space overhead hide <span class="keyword">in</span> HDD</span><br><span class="line"># modlls w/o PI bytes, smartctl could <span class="keyword">get</span> <span class="number">520</span>,<span class="number">524</span>,<span class="number">4160</span>,<span class="number">4192</span>,<span class="number">4224</span> <span class="keyword">from</span> logic sector bytes</span><br></pre></td></tr></table></figure><h5 id="T10-DIX-and-PI"><a href="#T10-DIX-and-PI" class="headerlink" title="T10 DIX and PI"></a><a href="https://sp.ts.fujitsu.com/dmsp/Publications/public/dx_s3_Oracle_Linux_T10_PI_E16G_en.pdf">T10 DIX and PI</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|--------------Server----------------|                  |-------Storage system----|</span><br><span class="line">Application -&gt; OS -&gt; IO controller/HBA -&gt; SAN/Switch -&gt; Controller/switch -&gt; Driver</span><br><span class="line">|--------------DIX------------||----------------------PI--------------------------| </span><br></pre></td></tr></table></figure><p>DIX end at HBA input ( add extra 8 Bytes for protect in every level )<br>PI start at HBA output ( add extra 8 Bytes for protect in every level )<br>DIX + PI means end to end data protection<br>In some case, maybe you just support T10 PI and not DIX support</p><h3 id="Security-erasing"><a href="#Security-erasing" class="headerlink" title="Security erasing"></a>Security erasing</h3><p>SAS</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sg_format --format /dev/sdx</span><br></pre></td></tr></table></figure><p>SATA</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hdparm --user-master u --security-set-pass password /dev/sdx</span><br></pre></td></tr></table></figure><p>NVME<br><a href="https://nvmexpress.org/wp-content/uploads/NVM-Express-1_4-2019.06.10-Ratified.pdf">for more info</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ nvme list</span><br><span class="line">Node             SN                   Model                                    Namespace Usage                      Format           FW Rev</span><br><span class="line">---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------</span><br><span class="line">/dev/nvme0n1     xxxxxxxxxxxxxxx      INTEL SSDPED1K375GA                      1         375.08  GB / 375.08  GB    512   B +  0 B   E2010324</span><br><span class="line"></span><br><span class="line">$ nvme id-ctrl -H  /dev/nvme0n1 | grep format -i</span><br><span class="line">  [1:1] : 0x1   Format NVM Supported</span><br><span class="line">  [0:0] : 0     Admin Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line">  [0:0] : 0     Format Applies to Single Namespace(s)</span><br><span class="line">  [0:0] : 0     NVM Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line"></span><br><span class="line">$ --lbaf</span><br><span class="line">LBA Format: This field specifies the LBA format to apply to the NVM media. This corresponds to the LBA formats indicated <span class="keyword">in</span> the Identify Namespace <span class="built_in">command</span>. Defaults to 0.</span><br><span class="line"></span><br><span class="line">$ nvme format /dev/nvme0n1 --ses=1 -pi 1</span><br><span class="line"><span class="comment"># ses</span></span><br><span class="line"><span class="comment">#Format namespace 1 with user data secure erase settings and protection information</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0 (default) means No secure erase operation requested</span></span><br><span class="line"><span class="comment">#1 User Data Erase: All user data shall be erased, contents of the user data after the erase is indeterminate (e.g., the user data may be zero filled, one filled, etc). The controller may perform a cryptographic erase when a User Data Erase is requested if all user data is encrypted. </span></span><br><span class="line"><span class="comment">#2 Cryptographic Erase: All user data shall be erased cryptographically. This is accomplished by deleting the encryption key.</span></span><br><span class="line"><span class="comment">#3-7 Reserved</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pi </span></span><br><span class="line"><span class="comment"># 0 default, not enabled</span></span><br><span class="line"><span class="comment"># 1,type 1</span></span><br><span class="line"><span class="comment"># 2,type 2 </span></span><br><span class="line"><span class="comment"># 3,type 3</span></span><br><span class="line"><span class="comment"># 4-7 Reserved</span></span><br><span class="line"></span><br><span class="line">$ nvme id-ns /dev/nvme1n1 | grep LBA</span><br><span class="line">LBA Format  0 : Metadata Size: 0   bytes - Data Size: 512 bytes - Relative Performance: 0x1 Better</span><br><span class="line">LBA Format  1 : Metadata Size: 8   bytes - Data Size: 512 bytes - Relative Performance: 0x3 Degraded</span><br><span class="line">LBA Format  2 : Metadata Size: 0   bytes - Data Size: 4096 bytes - Relative Performance: 0 Best  (<span class="keyword">in</span> use)</span><br><span class="line">LBA Format  3 : Metadata Size: 8   bytes - Data Size: 4096 bytes - Relative Performance: 0x2 Good</span><br><span class="line"></span><br><span class="line">$ nvme format /dev/nvme1n1 -l 2</span><br></pre></td></tr></table></figure><h3 id="Enable-the-blk-mq-and-scsi-mq"><a href="#Enable-the-blk-mq-and-scsi-mq" class="headerlink" title="Enable the blk_mq and scsi_mq"></a>Enable the blk_mq and scsi_mq</h3><p>scsi-mq:specify scsi_mod.use_blk_mq=y<br>blk-mq infrastructure if the dm_mod.use_blk_mq=y</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y&#x27;</span></span><br><span class="line">$ reboot</span><br><span class="line">$ cat  /sys/block/dm-X/dm/use_blk_mq</span><br><span class="line">$ tree /sys/class/block/sdl/mq /sys/class/block/dm-0/mq</span><br></pre></td></tr></table></figure><h3 id="lsscsi"><a href="#lsscsi" class="headerlink" title="lsscsi"></a>lsscsi</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">$ lsscsi -t | grep sdio</span><br><span class="line">[4:1:8:0]   disk    sas:0x5000c657afc33e1d          /dev/sdio</span><br><span class="line"></span><br><span class="line">$ lsscsi -t -L 4:1:8:0</span><br><span class="line">[4:1:8:0]   disk    sas:0x5000c657afc33e1d          /dev/sdio</span><br><span class="line">  transport=sas</span><br><span class="line">  vendor=HGST</span><br><span class="line">  model=HUH721010AL5200</span><br><span class="line">  bay_identifier=7</span><br><span class="line">  enclosure_device:Slot07</span><br><span class="line">  enclosure_identifier=0x50030103403449ca</span><br><span class="line">  initiator_port_protocols=none</span><br><span class="line">  initiator_response_timeout=1744</span><br><span class="line">  I_T_nexus_loss_timeout=1744</span><br><span class="line">  phy_identifier=33</span><br><span class="line">  ready_led_meaning=0</span><br><span class="line">  sas_address=0x5000c657afc33e1d</span><br><span class="line">  target_port_protocols=ssp</span><br><span class="line">  tlr_enabled=0</span><br><span class="line">  tlr_supported=0</span><br><span class="line"></span><br><span class="line">$ lsscsi -gis | grep sdio</span><br><span class="line">[4:1:8:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdio  35000c657afc33e1c  /dev/sg180  10.0TB</span><br><span class="line"></span><br><span class="line">$ lsblk -o NAME,MODEL,SERIAL,SIZE,STATE,TYPE,WWN --nodeps | grep sdio</span><br><span class="line">sdio HUH721010AL5200  5000c657afc33e1c                   9.1T running disk 0x5000c657afc33e1c</span><br><span class="line"></span><br><span class="line">$ $ lsscsi -t -H</span><br><span class="line">[0]    megaraid_sas</span><br><span class="line">[10]    ahci          sata:</span><br><span class="line">[11]    ahci          sata:</span><br><span class="line">[12]    mpt3sas       sas:0x500605b00bfa0982</span><br><span class="line">[13]    mpt3sas       sas:0x500605b00acf0542</span><br><span class="line">[14]    mpt3sas       sas:0x500605b00bfac033</span><br><span class="line"></span><br><span class="line">$ lsscsi -tiv</span><br><span class="line">[0:0:7:0]    disk    sas:0x500056b3787358c7          /dev/sdh   -</span><br><span class="line">  dir: /sys/bus/scsi/devices/0:0:7:0  [/sys/devices/pci0000:ae/0000:ae:00.0/0000:af:00.0/host0/port-0:0/expander-0:0/port-0:0:7/end_device-0:0:7/target0:0:7/0:0:7:0]</span><br><span class="line">[0:0:8:0]    disk    sas:0x500056b3787358c8          /dev/sdi   -</span><br><span class="line">  dir: /sys/bus/scsi/devices/0:0:8:0  [/sys/devices/pci0000:ae/0000:ae:00.0/0000:af:00.0/host0/port-0:0/expander-0:0/port-0:0:8/end_device-0:0:8/target0:0:8/0:0:8:0]</span><br><span class="line">[0:0:9:0]    disk    sas:0x5000cca26c1b8631          /dev/sdj   35000cca26c1b8630</span><br><span class="line"></span><br><span class="line"><span class="comment"># get single port</span></span><br><span class="line">[1:0:0:0]    disk    sas:0x5000cca26fae54a6          /dev/sda   35000cca26fae54a4  11.7TB</span><br><span class="line">  dir: /sys/bus/scsi/devices/1:0:0:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:0/expander-1:1/port-1:1:0/end_device-1:1:0/target1:0:0/1:0:0:0]</span><br><span class="line">[1:0:1:0]    enclosu sas:0x500c0ff00b40aa3e          -          -       -</span><br><span class="line">  dir: /sys/bus/scsi/devices/1:0:1:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:4/end_device-1:0:4/target1:0:1/1:0:1:0]</span><br><span class="line">[1:0:2:0]    disk    sas:0x5000cca26fabd8c2          /dev/sdb   35000cca26fabd8c0  11.7TB</span><br><span class="line">  dir: /sys/bus/scsi/devices/1:0:2:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:0/expander-1:1/port-1:1:1/end_device-1:1:1/target1:0:2/1:0:2:0]</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">[1:0:87:0]   disk    sas:0x5000cca26fbac14e          /dev/sdcf  35000cca26fbac14c  11.7TB</span><br><span class="line">  dir: /sys/bus/scsi/devices/1:0:87:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:3/expander-1:4/port-1:4:27/end_device-1:4:27/target1:0:87/1:0:87:0]</span><br><span class="line">[1:0:88:0]   process sas:0x500c0ff5f12425fe          -          -       -</span><br><span class="line">  dir: /sys/bus/scsi/devices/1:0:88:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:3/expander-1:4/port-1:4:28/end_device-1:4:28/target1:0:88/1:0:88:0]</span><br><span class="line"></span><br><span class="line">$ grep 11.7 /tmp/tmp</span><br><span class="line">[1:0:0:0]    disk    sas:0x5000cca26fae54a6          /dev/sda   35000cca26fae54a4  11.7TB</span><br><span class="line">[1:0:2:0]    disk    sas:0x5000cca26fabd8c2          /dev/sdb   35000cca26fabd8c0  11.7TB</span><br><span class="line">[1:0:3:0]    disk    sas:0x5000cca26fb405d2          /dev/sdc   35000cca26fb405d0  11.7TB</span><br><span class="line">[1:0:4:0]    disk    sas:0x5000cca26fb99436          /dev/sdd   35000cca26fb99434  11.7TB</span><br><span class="line">[1:0:5:0]    disk    sas:0x5000cca26fbac11a          /dev/sde   35000cca26fbac118  11.7TB</span><br><span class="line">[1:0:6:0]    disk    sas:0x5000cca26fbac962          /dev/sdf   35000cca26fbac960  11.7TB</span><br><span class="line">[1:0:7:0]    disk    sas:0x5000cca26fb5c9b2          /dev/sdg   35000cca26fb5c9b0  11.7TB</span><br><span class="line">[1:0:8:0]    disk    sas:0x5000cca26fad67be          /dev/sdh   35000cca26fad67bc  11.7TB</span><br><span class="line">[1:0:9:0]    disk    sas:0x5000cca26fb7d912          /dev/sdi   35000cca26fb7d910  11.7TB</span><br><span class="line">[1:0:10:0]   disk    sas:0x5000cca26fbacac2          /dev/sdj   35000cca26fbacac0  11.7TB</span><br><span class="line">[1:0:11:0]   disk    sas:0x5000cca26fbac81a          /dev/sdk   35000cca26fbac818  11.7TB</span><br><span class="line">.......</span><br><span class="line">[1:0:78:0]   disk    sas:0x5000cca26fa140aa          /dev/sdbw  35000cca26fa140a8  11.7TB</span><br><span class="line">[1:0:79:0]   disk    sas:0x5000cca26fbac816          /dev/sdbx  35000cca26fbac814  11.7TB</span><br><span class="line">[1:0:80:0]   disk    sas:0x5000cca26fb99fba          /dev/sdby  35000cca26fb99fb8  11.7TB</span><br><span class="line">[1:0:81:0]   disk    sas:0x5000cca26faa42da          /dev/sdbz  35000cca26faa42d8  11.7TB</span><br><span class="line">[1:0:82:0]   disk    sas:0x5000cca26fad6776          /dev/sdca  35000cca26fad6774  11.7TB</span><br><span class="line">[1:0:83:0]   disk    sas:0x5000cca26fa46c8e          /dev/sdcb  35000cca26fa46c8c  11.7TB</span><br><span class="line">[1:0:84:0]   disk    sas:0x5000cca26fbab7a6          /dev/sdcc  35000cca26fbab7a4  11.7TB</span><br><span class="line">[1:0:85:0]   disk    sas:0x5000cca26fbab7e2          /dev/sdcd  35000cca26fbab7e0  11.7TB</span><br><span class="line">[1:0:86:0]   disk    sas:0x5000cca26fb5ca42          /dev/sdce  35000cca26fb5ca40  11.7TB</span><br><span class="line">[1:0:87:0]   disk    sas:0x5000cca26fbac14e          /dev/sdcf  35000cca26fbac14c  11.7TB</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="udevinfo"><a href="#udevinfo" class="headerlink" title="udevinfo"></a><a href="https://sites.google.com/site/itmyshare/system-admin-tips-and-tools/udevadm---useage-examples">udevinfo</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ udevadm info --query=property --name /dev/sdd</span><br><span class="line">$ udevadm info --query=path --name /dev/sdd</span><br><span class="line">$ udevadm info --query=symlink --name /dev/sdd</span><br><span class="line">$ udevadm info --a --name=/dev/sdd</span><br><span class="line">$ udevadm info --attribute-walk --name /dev/sdd</span><br><span class="line"></span><br><span class="line">$ udevadm info -a -p $(udevadm info -q path -n /dev/sda)</span><br><span class="line">$ udevadm info -a -p /sys/class/net/eth0</span><br><span class="line">$ udevadm info -q path -n /dev/sda1</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger, remember to have --dry-run option if you run it on production node.</span></span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=scsi_host</span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=scsi_disk</span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=scsi_tape</span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=fc_host </span><br><span class="line"></span><br><span class="line"><span class="comment"># This option only waits for events triggered by the same command to finish</span></span><br><span class="line">$ udevadm settle</span><br><span class="line"></span><br><span class="line"><span class="comment"># control </span></span><br><span class="line">$ udevadm control --reload-rules</span><br><span class="line">$ --log-priority=&lt;level&gt;   <span class="built_in">set</span> the udev <span class="built_in">log</span> level <span class="keyword">for</span> the daemon</span><br><span class="line"></span><br><span class="line"><span class="comment"># monitor</span></span><br><span class="line">$ udevadm monitor --<span class="built_in">help</span></span><br><span class="line">Usage: udevadm monitor [--property] [--kernel] [--udev] [--<span class="built_in">help</span>]</span><br><span class="line">  --property                    <span class="built_in">print</span> the event properties</span><br><span class="line">  --kernel                      <span class="built_in">print</span> kernel uevents</span><br><span class="line">  --udev                        <span class="built_in">print</span> udev events</span><br><span class="line">  --subsystem-match=&lt;subsystem&gt; filter events</span><br><span class="line">  --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># test</span></span><br><span class="line">$ udevadm <span class="built_in">test</span> /block/sdd</span><br><span class="line"></span><br><span class="line"><span class="comment">### show block info</span></span><br><span class="line">$ hwinfo --block</span><br><span class="line">$ udevadm info -a -n /dev/sda</span><br><span class="line">$ lshw -class storage</span><br><span class="line">$ lsblk -o NAME,MODEL,SERIAL,SIZE,STATE,TYPE,WWN --nodeps</span><br></pre></td></tr></table></figure><h3 id="Flush-cache-data"><a href="#Flush-cache-data" class="headerlink" title="Flush cache data"></a>Flush cache data</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## flush fs buff</span></span><br><span class="line">$ sync</span><br><span class="line"></span><br><span class="line"><span class="comment"># Flush fs buff</span></span><br><span class="line">$ blockdev --flushbufs /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#or for zfs</span></span><br><span class="line">$ zpool <span class="built_in">export</span> your_pool</span><br><span class="line"></span><br><span class="line"><span class="comment"># Flush the SAS dev buff</span></span><br><span class="line">$ sdparm --<span class="built_in">command</span>=sync /dev/sdxx</span><br><span class="line"><span class="comment">#spindown the device</span></span><br><span class="line">$ sdparm --<span class="built_in">command</span>=stop /dev/sdxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Flush the SATA dev buff</span></span><br><span class="line">$ hdparm -F /dev/sdxx</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 <span class="built_in">set</span> flushwriteverify=on</span><br><span class="line">$ storcli64 /c0 show flushwriteverify</span><br><span class="line">$ storcli64 /c0 flushcache</span><br><span class="line">Description = Adapter and/or disk caches flushed successfully.</span><br></pre></td></tr></table></figure><h3 id="dev-info"><a href="#dev-info" class="headerlink" title="dev info"></a><a href="https://www.ibm.com/support/knowledgecenter/en/linuxonibm/com.ibm.linux.z.lgdd/lgdd_t_fcp_wrk_actinfo.html">dev info</a></h3><p>/sys/class/scsi_device/<device_name>/device/<attribute></p><p>ioerr_cnt       The number of SCSI commands that completed with an error.<br>scsi_level      The SCSI revision level, received from inquiry data.</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">access_denied   Flag that indicates whether access <span class="keyword">to</span> the device is restricted by the FCP channel.The value is 1 <span class="keyword">if</span> access is denied <span class="keyword">and</span> 0 <span class="keyword">if</span> access is permitted.<span class="keyword">If</span> access is denied <span class="keyword">to</span> your Linux instance, confirm that your SCSI devices are configured as intended. Also, be sure that you really want <span class="keyword">to</span> share a SCSI device. <span class="keyword">For</span> shared access <span class="keyword">to</span> a SCSI device, preferably use NPIV). You might also use different FCP channels <span class="keyword">or</span> target ports.</span><br><span class="line">access_shared   This attribute is obsolete. The value is always 0.</span><br><span class="line">access_readonly This attribute is obsolete. The value is always 0.</span><br><span class="line">ked     Flag that indicates whether the device is <span class="keyword">in</span> blocked state (0 <span class="keyword">or</span> 1).</span><br><span class="line">iocounterbits   The number of bits used <span class="keyword">for</span> I/O counters.</span><br><span class="line">iodone_cnt      The number of completed <span class="keyword">or</span> rejected SCSI commands.</span><br><span class="line">ioerr_cnt       The number of SCSI commands that completed with an error.</span><br><span class="line">iorequest_cnt   The number of issued SCSI commands.</span><br><span class="line">queue_type      The<span class="built_in"> type </span>of<span class="built_in"> queue </span><span class="keyword">for</span> the SCSI device. The value can be one of the following:</span><br><span class="line">                none</span><br><span class="line">                simple</span><br><span class="line">                ordered</span><br><span class="line">model   The model of the SCSI device, received <span class="keyword">from</span> inquiry data.</span><br><span class="line">rev     The revision of the SCSI device, received <span class="keyword">from</span> inquiry data.</span><br><span class="line">scsi_level      The SCSI revision level, received <span class="keyword">from</span> inquiry data.</span><br><span class="line">type    The<span class="built_in"> type </span>of the SCSI device, received <span class="keyword">from</span> inquiry data.</span><br><span class="line">vendor  The vendor of the SCSI device, received <span class="keyword">from</span> inquiry data.</span><br><span class="line">fcp_lun The LUN of the SCSI device <span class="keyword">in</span> 64-bit format.</span><br><span class="line">hba_id  The bus ID of the SCSI device.</span><br><span class="line">wwpn    The WWPN of the remote port.</span><br><span class="line">zfcp_access_denied      Flag that indicates whether access <span class="keyword">to</span> the device is restricted by the FCP channel.The value is 1 <span class="keyword">if</span> access is denied <span class="keyword">and</span> 0 <span class="keyword">if</span> access is permitted. <span class="keyword">If</span> access is denied <span class="keyword">to</span> your Linux instance, confirm that your SCSI devices are configured as intended. Also, be sure that you really want <span class="keyword">to</span> share a SCSI device. <span class="keyword">For</span> shared access <span class="keyword">to</span> a SCSI device, preferably use NPIV). You might also use different FCP channels <span class="keyword">or</span> target ports.</span><br><span class="line">zfcp_in_recovery        Shows <span class="keyword">if</span> unit is <span class="keyword">in</span> recovery (0 <span class="keyword">or</span> 1).Shows <span class="keyword">if</span> unit is <span class="keyword">in</span> recovery (2 <span class="keyword">or</span> 1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### Encrypt block device</span></span><br><span class="line"><span class="comment">#### *Input password*     </span></span><br><span class="line"><span class="keyword">or</span> you can <span class="keyword">not</span> use openssl          </span><br><span class="line">``` bash</span><br><span class="line">cryptsetup luksFormat --cipher aes-xts-plain64 --key-size 512 --hash sha256 /dev/vdb     </span><br><span class="line">WARNING!     </span><br><span class="line">========     </span><br><span class="line">This will overwrite data on /dev/vdb irrevocably.     </span><br><span class="line">     </span><br><span class="line">Are you sure? (Type uppercase <span class="literal">yes</span>): <span class="literal">YES</span>      </span><br><span class="line">Enter passphrase:      </span><br><span class="line">Verify passphrase:      </span><br></pre></td></tr></table></figure><h4 id="mapper-test-device"><a href="#mapper-test-device" class="headerlink" title="mapper test device"></a><em>mapper test device</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksOpen /dev/vdb <span class="built_in">test</span>     </span><br><span class="line">Enter passphrase <span class="keyword">for</span> /dev/vdb:     </span><br><span class="line">``` </span><br><span class="line">or     </span><br><span class="line">``` bash</span><br><span class="line"><span class="built_in">cd</span> /dev/shm     </span><br><span class="line">openssl rand 128 -hex -out ./key     </span><br><span class="line">openssl aes-256-cbc -<span class="keyword">in</span> ./key -out key.enc     </span><br><span class="line"></span><br><span class="line">Verifying - enter aes-256-cbc encryption password:</span><br><span class="line">openssl aes-256-cbc -d -<span class="keyword">in</span> ./key.enc | cryptsetup [--allow-discards] --key-file=- luksOpen /dev/vdb <span class="built_in">test</span>     </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">If you have a SSD, you may want to use --allow-discards. It creates an information leak but it enhances your SSDs lifetime.     </span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">mkfs.ext4 /dev/mapper/<span class="built_in">test</span>     </span><br><span class="line">cryptsetup luksDump /dev/vdb     </span><br><span class="line">     </span><br><span class="line">``` bash     </span><br><span class="line">LUKS header information <span class="keyword">for</span> /dev/vdb     </span><br><span class="line">Key Slot 0: ENABLED     </span><br><span class="line">Iterations:         80604     </span><br><span class="line">Salt:               c4 c0 08 9c 77 ef 57 a5 d2 62 f4 94 03 56 24 7a      </span><br><span class="line">                      86 0c f4 c6 06 6f 9e 01 80 <span class="built_in">fc</span> 0f 1d 3b a9 59 87      </span><br><span class="line">Key material offset:8     </span><br><span class="line">AF stripes:            4000     </span><br><span class="line">Key Slot 1: DISABLED     </span><br></pre></td></tr></table></figure><h4 id="Add-remove-key"><a href="#Add-remove-key" class="headerlink" title="Add/remove key"></a><em>Add/remove key</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksAddKey --key-slot 1 /dev/vdb     </span><br><span class="line">cryptsetup luksRemoveKey /dev/vdb     </span><br></pre></td></tr></table></figure><h4 id="Back-restore-header"><a href="#Back-restore-header" class="headerlink" title="Back/restore header"></a><em>Back/restore header</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksHeaderBackup /dev/vdb --header-backup-file /root/vdb-header-backup     </span><br><span class="line">cryptsetup luksHeaderRestore /dev/vdb --header-backup-file /root/vdb-header-backup     </span><br></pre></td></tr></table></figure><h4 id="is-luks-partition"><a href="#is-luks-partition" class="headerlink" title="is luks partition"></a><em>is luks partition</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup -v isLuks /dev/vdb     </span><br></pre></td></tr></table></figure><h4 id="Clean-luks-partition"><a href="#Clean-luks-partition" class="headerlink" title="Clean luks partition"></a><em>Clean luks partition</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 3145728 /dev/zero &gt; /dev/vdb;sync     </span><br></pre></td></tr></table></figure><p>The default LUKS header (with only one key-slot enabled) takes 1052672 bytes, what is slightly more than 1 MiB. Having 2 key-slots enabled this would extend the header almost twice (key-slots * stripes * keysize + offset bytes). Therefore overwriting the first 3 MiB would do the job for us </p><h3 id="Why-Trim"><a href="#Why-Trim" class="headerlink" title="Why Trim"></a><a href="https://en.wikipedia.org/wiki/Trim_(computing)">Why Trim</a></h3><p>The Trim command is designed to enable the operating system to notify the SSD which pages no longer contain valid data due to erases either by the user or operating system itself. During a delete operation, the OS will mark the sectors as free for new data and send a Trim command to the SSD to mark them as not containing valid data. After that the SSD knows not to preserve the contents of the block when writing a page, resulting in less write amplification with fewer writes to the flash, higher write speed, and increased drive life.<br>Different SSDs implement the Trim command somewhat differently, so performance can vary.<br><img src="http://images.anandtech.com/reviews/storage/Intel/34nmSSD/Review/garbagecollection.png"></p><h4 id="Openzfs-on-linux"><a href="#Openzfs-on-linux" class="headerlink" title="Openzfs on linux"></a>Openzfs on linux</h4><p><a href="https://github.com/zfsonlinux/zfs/pull/1016">not support trim funtion</a><br><a href="http://list.zfsonlinux.org/pipermail/zfs-discuss/2016-January/024437.html">expect to get a upgrade this year that will add TRIM support</a></p><h4 id="Trim-patch-for-ZOL"><a href="#Trim-patch-for-ZOL" class="headerlink" title="Trim patch for ZOL"></a>Trim patch for ZOL</h4><p><a href="https://github.com/zfsonlinux/zfs/pull/924">DO NOT APPLY THIS PATCH IF YOU CARE ABOUT YOUR DATA</a></p><h4 id="Mdadm"><a href="#Mdadm" class="headerlink" title="Mdadm"></a>Mdadm</h4><p><a href="http://kernelnewbies.org/Linux_3.7#head-2fd9b183a4623d96e69ed24f88e0eb83217fa8df">Since version 3.7 of the Linux kernel mainline, md supports TRIM operations for the underlying solid-state drives (SSDs), for linear, RAID 0, RAID 1, RAID 5 and RAID 10 layouts</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/6.5_Release_Notes/">CentOS 6.5 The mdadm tool now supports the TRIM commands for RAID0, RAID1, and RAID10.</a></p><h4 id="LSI-Check-Interoperability-and-Compatibility"><a href="#LSI-Check-Interoperability-and-Compatibility" class="headerlink" title="LSI Check Interoperability and Compatibility"></a><a href="http://www.avagotech.com/support/interop-compatibility">LSI Check Interoperability and Compatibility</a></h4><p><a href="http://docs.avagotech.com/docs-and-downloads/raid-controllers/MegaRAID_SAS_Gen3CompatibilityList.pdf">MegaRAID SAS Gen3 Compatibility List</a><br><a href="http://docs.avagotech.com/docs-and-downloads/raid-controllers/raid-controllers-common-files/iMR_SAS_Gen3CompatibilityList.pdf">iMR SAS Gen3 Compatibility List</a><br><a href="http://www.media-clone.net/v/vspfiles/downloads/LSI_6Gb_SAS_SATA_HBA_Compatibility_List.pdf">LSI_6Gb_SAS_SATA_HBA Compatibility List</a><br>Just Compatibility, trim support not clean</p><h4 id="HP-Raid-support"><a href="#HP-Raid-support" class="headerlink" title="HP Raid support"></a>HP Raid support</h4><p><a href="http://h20195.www2.hp.com/V2/GetPDF.aspx/4AA5-8637ENW">Is TRIM supported when using RAID with SSDs?</a><br><img src="/img/hp-trim-support.png"><br>Raid 1,10,0 could be support<br>Raid 1E,5,6 has not support</p><h3 id="Re-assign-bad-block"><a href="#Re-assign-bad-block" class="headerlink" title="Re-assign bad block"></a><a href="https://www.smartmontools.org/wiki/BadBlockHowto">Re-assign bad block</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dmesg error</span></span><br><span class="line"> sd 13:0:10:0: attempting task abort! scmd(ffff88bdf0eb8000)</span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#22 CDB: Read(16) 88 00 00 00 00 04 16 2b fa 66 00 00 00 6c 00 00</span></span><br><span class="line"> scsi target13:0:10: _scsih_tm_display_info: handle(0x0015), sas_address(0x5000cca251b4462e), phy(37)</span><br><span class="line"> scsi target13:0:10: enclosurelogical id(0x500304800928dc3f), slot(10)</span><br><span class="line"> scsi target13:0:10: enclosure level(0x0000), connector name(     )</span><br><span class="line"> sd 13:0:10:0: task abort: SUCCESS scmd(ffff88bdf0eb8000)</span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#22 FAILED Result: hostbyte=DID_TIME_OUT driverbyte=DRIVER_OK</span></span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#22 CDB: Read(16) 88 00 00 00 00 04 16 2b fa 66 00 00 00 6c 00 00</span></span><br><span class="line"> blk_update_request: I/O error, dev sdff, sector 17551850086</span><br><span class="line"> sd 13:0:10:0: attempting task abort! scmd(ffff88b39ff33800)</span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#21 CDB: Read(16) 88 00 00 00 00 04 16 2b f9 78 00 00 00 ee 00 00</span></span><br><span class="line"> scsi target13:0:10: _scsih_tm_display_info: handle(0x0015), sas_address(0x5000cca251b4462e), phy(37)</span><br><span class="line"> scsi target13:0:10: enclosurelogical id(0x500304800928dc3f), slot(10)</span><br><span class="line"> scsi target13:0:10: enclosure level(0x0000), connector name(     )</span><br><span class="line"> sd 13:0:10:0: task abort: SUCCESS scmd(ffff88b39ff33800)</span><br><span class="line"></span><br><span class="line">$ smartctl -t long /dev/sdff</span><br><span class="line"></span><br><span class="line"><span class="comment">### after test</span></span><br><span class="line">smartctl -l selftest /dev/sdb</span><br><span class="line">smartctl version 5.37 [i686-pc-linux-gnu] Copyright (C) 2002-6 Bruce Allen</span><br><span class="line">Home page is http://smartmontools.sourceforge.net/</span><br><span class="line">SMART Self-test <span class="built_in">log</span></span><br><span class="line">Num  Test              Status            segment  LifeTime  LBA_first_err [SK ASC ASQ]</span><br><span class="line">     Description                         number   (hours)</span><br><span class="line"><span class="comment"># 1  Background long   Failed in segment      -     354           1193046 [0x3 0x11 0x0]</span></span><br><span class="line"><span class="comment"># 2  Background short  Completed              -     323                 - [-   -    -]</span></span><br><span class="line"><span class="comment"># 3  Background short  Completed              -     194                 - [-   -    -]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#That means sometimes the connection quality was bad</span></span><br><span class="line">$ sg_verify --lba=1193046 /dev/sdff</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">0x123456=1193046</span><br><span class="line"></span><br><span class="line"><span class="comment">#The link case</span></span><br><span class="line">$ sg_verify --lba=1193046 /dev/sdb</span><br><span class="line">verify (10):  Fixed format, current;  Sense key: Medium Error</span><br><span class="line"> Additional sense: Unrecovered <span class="built_in">read</span> error</span><br><span class="line">  Info fld=0x123456 [1193046]</span><br><span class="line">  Field replaceable unit code: 228</span><br><span class="line">  Actual retry count: 0x008b</span><br><span class="line">medium or hardware error, reported lba=0x123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now the GLIST length is checked before the block reassignment:</span></span><br><span class="line"></span><br><span class="line">$ sg_reassign --grown /dev/sdb</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 0</span><br><span class="line"><span class="comment"># And now for the actual reassignment followed by another check of the GLIST length:</span></span><br><span class="line"></span><br><span class="line">$ sg_reassign --address=1193046 /dev/sdb</span><br><span class="line"></span><br><span class="line">$ sg_reassign --grown /dev/sdb</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 1</span><br><span class="line"><span class="comment"># The GLIST length has grown by one as expected. If the disk was unable to recover any data, then the &quot;new&quot; block at lba 0x123456 has vendor specific data in it. The sg_reassign utility can also do bulk reassigns, see man sg_reassign for more information.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The dd command could be used to read the contents of the &quot;new&quot; block:</span></span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdb iflag=direct skip=1193046 of=blk.img bs=512 count=1</span><br><span class="line"><span class="comment"># and a hex editor [11] used to view and potentially change the blk.img file. An altered blk.img file (or /dev/zero) could be written back with:</span></span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=blk.img of=/dev/sdb seek=1193046 oflag=direct bs=512 count=1</span><br><span class="line"><span class="comment"># More work may be needed at the file system level, especially if the reassigned block held critical file system information such as a superblock or a directory.</span></span><br></pre></td></tr></table></figure><h3 id="linux-block-integrity"><a href="#linux-block-integrity" class="headerlink" title="linux block integrity"></a>linux block integrity</h3><p>config BLK_DEV_INTEGRITY</p><p><a href="https://www.redhat.com/zh/blog/what-bit-rot-and-how-can-i-detect-it-rhel">Regarding support status: dm-integrity is not labeled as TechPreview, it is supported. Heavy stacks of RAID1 on top, with mdadm or LVM-raid, are not yet widely tested or recommended for production</a></p><p>Issues, </p><ul><li>reformat, it s a long time for 10TB+ HDD</li><li>performance impact</li></ul><p>dm-integrity</p><ul><li>Emulates per-sector metadata</li><li>Optionally standalone mode (CRC32)</li></ul><p>Because the T13/ATA External Path Protection has <a href="https://www.spinics.net/lists/raid/msg41308.html">dead</a><br>I can t see any support from raid/HBA vendor<br>I found linux community support the block integrity, linux kernel need to &gt;= 4.12</p><h4 id="test"><a href="#test" class="headerlink" title="test"></a>test</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=rawfile bs=1M count=128</span><br><span class="line">$ MYLOOP=$(losetup -f --show rawfile)</span><br><span class="line">$ integritysetup format <span class="variable">$MYLOOP</span> -I crc32</span><br><span class="line">$ integritysetup open <span class="variable">$MYLOOP</span> mydata -I crc32</span><br><span class="line">$ mkfs.xfs /dev/mapper/mydata</span><br><span class="line">$ mount /dev/mapper/mydata /mnt</span><br><span class="line">$ yes &gt;/mnt/infile</span><br><span class="line">$ md5sum /mnt/infile </span><br><span class="line">13e14c50aaf2054d987663ed31b5f786  /mnt/infile</span><br><span class="line">$ umount /mnt/</span><br><span class="line">$ losetup -d <span class="variable">$MYLOOP</span></span><br><span class="line">$ integritysetup close mydata</span><br><span class="line">$ dd <span class="keyword">if</span>=rawfile bs=1 count=10 skip=$((<span class="number">50</span>*<span class="number">1024</span>*<span class="number">1024</span>)) 2&gt;/dev/null|hexdump -vC</span><br><span class="line">00000000  79 0a 79 0a 79 0a 79 0a  79 0a |y.y.y.y.y.|</span><br><span class="line">0000000a</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;x&#x27;</span> | dd of=rawfile bs=1 count=1 seek=$((<span class="number">50</span>*<span class="number">1024</span>*<span class="number">1024</span>)) conv=notrunc</span><br><span class="line">$ dd <span class="keyword">if</span>=rawfile bs=1 count=10 skip=$((<span class="number">50</span>*<span class="number">1024</span>*<span class="number">1024</span>)) 2&gt;/dev/null|hexdump -vC</span><br><span class="line">00000000  78 0a 79 0a 79 0a 79 0a  79 0a |x.y.y.y.y.|</span><br><span class="line">0000000a</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can see the log in demsg</span></span><br><span class="line">[Thu Jan 23 12:56:07 2020] device-mapper: integrity: Checksum failed at sector 0x18468</span><br><span class="line"></span><br><span class="line">$ integritysetup status mydata</span><br><span class="line">/dev/mapper/mydata is active and is <span class="keyword">in</span> use.</span><br><span class="line">  <span class="built_in">type</span>:    INTEGRITY</span><br><span class="line">  tag size: 4</span><br><span class="line">  integrity: crc32c</span><br><span class="line">  device:  /dev/loop0</span><br><span class="line">  loop:    /root/rawfile</span><br><span class="line">  sector size:  512 bytes</span><br><span class="line">  interleave sectors: 32768</span><br><span class="line">  size:    258152 sectors</span><br><span class="line">  mode:    <span class="built_in">read</span>/write</span><br><span class="line">  failures: 10</span><br><span class="line">  journal size: 991232 bytes</span><br><span class="line">  journal watermark: 50%</span><br><span class="line">  journal commit time: 10000 ms</span><br><span class="line"></span><br><span class="line">$  md5sum /mnt/*</span><br><span class="line">md5sum: /mnt/infile: Input/output error <span class="comment">## error file could not be read</span></span><br><span class="line">e7eee6d6c29d2f78bbd28e14df457dc7  /mnt/testfile</span><br></pre></td></tr></table></figure><p>Tech preview in CentOS 8<br>Regarding support status: dm-integrity is not labeled as TechPreview, it is supported. Heavy stacks of RAID1 on top, with mdadm or LVM-raid, are not yet widely tested or recommended for production.</p><p><a href="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/DMIntegrity">For more DMIntegrity</a></p><h3 id="Seagate-HDD-smart-issue"><a href="#Seagate-HDD-smart-issue" class="headerlink" title="Seagate HDD smart issue"></a>Seagate HDD smart issue</h3><h4 id="Seagate-SATA"><a href="#Seagate-SATA" class="headerlink" title="Seagate SATA"></a>Seagate SATA</h4><p>There are a lot of error in seagate sata smart, but the selftest process is OK, no return any error</p><p><a href="//www.users.on.net/~fzabkar/HDD/Seagate_SER_RRER_HEC.html">The raw value of each SMART attribute occupies 48 bits. Seagates Seek Error Rate attribute consists of two parts  a 16-bit count of seek errors in the uppermost 4 nibbles, and a 32-bit count of seeks in the lowermost 8 nibbles. In order to see these data, we will need a SMART utility that reports all 48 bits, preferably in hexadecimal. Two such utilities are HD Sentinel and HDDScan.</a></p><p>normalised SER = -10 log (lifetime seek errors / lifetime seeks)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7 Seek_Error_Rate         0x000f 072 060 030 Pre-fail Always      -       17262017054</span><br></pre></td></tr></table></figure><p>Error Recovery Usage Rate<br><a href="http://www.users.on.net/~fzabkar/HDD/Seagate_SER_RRER_HEC.html">The raw values of the RRER and HER attributes represent a sector count, not an error count. This figure rolls over to 0 once the count reaches about 250 million. I suspect that the drive records the total number of errors in each block of 250 million sectors, and then recalculates the normalised values of each attribute accordingly. This means that RRER and HER would be updated according to a rolling average rather than on a lifetime basis. Im almost certain that the normalised values are also logarithmic, but Im not sure how they are calculated. The above figure of 250 million sectors applies to the 7200.11 and DiamondMax 22 models, but may not apply to all.</a></p><p>In fact the document mentions (but does not discuss) 5 different error recovery schemes:</p><p>HARD = multiple retries invoked and failed<br>FIRM = multiple retries invoked<br>SOFT = 5 retries invoked<br>OTF = 1 retry invoked (On The Fly)<br>RAW = OTF ECC invoked</p><p>On The Fly means that errored data is corrected using the ECC bytes, without an additional access of the platters.<br>Based on the abovementioned Error Recovery Usage Rate formula, I now postulate that the normalised value of the Raw Read Error Rate attribute could be calculated as follows:<br>normalised RRER = -10 log (number of errored sectors / total bits transferred)<br>The total number of bits is </p><p>That why after smart test will not show any error.</p><h4 id="seagate-SAS-device"><a href="#seagate-SAS-device" class="headerlink" title="seagate SAS device"></a>seagate SAS device</h4><p>SAS device has the same issue.</p><p>In seagate document Rapid Increase in ECC on-the-Fly<br>Background<br>Per Seagate SCSI Commands Reference Manual, Rev D: Log page 03h, parameter code 0000: Errors corrected without substantial delay. Error correction was applied to get perfect data (a.k.a., ECC on-the-fly). Without Substantial Delay means the correction did not postpone reading of later sectors (e.g., a revolution was not lost). The counter is incremented once for each logical block that requires correction. Two different blocks corrected during the same command are counted as two events.</p><p>Root Cause<br>ECC on-the-fly is necessary for HDDs to function properly at current areal densities. Seagate HDDs will report an increasing value in this counter as part of normal operation. Seagate reports the counter value in accordance with the SCSI specification for informational purposes only; the SCSI specification does not require manufacturers to support the counter (T10/BSR INCITS 513 Revision 36h, pg564). Rate of ECC on the fly can vary based on drive model, drive capacity, areal density, disk speed, and environmental factors. Competitors may not support this parameter because the specification says that it is optional, or the arithmetic is different. It is common industry practice to use on-the-fly correction in order to ensure optimal drive operation. Disparity is caused because competitor does not define an accessible counter for this parameter.</p><p>Solution<br>Seagate recommends that customers do not compare values of the log attribute for Seagate brand HDDs to competitors drives. Increasing values are part of normal operation of high areal density HDDs. There are no performance concerns related to high values in this counter, and the counter does not indicate any concerns related to reliability or data retention.</p><h4 id="plugin-out-the-device"><a href="#plugin-out-the-device" class="headerlink" title="plugin out the device"></a>plugin out the device</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] killing request</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] FAILED Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] CDB: Write(16) 8a 00 00 00 00 04 8c 3f fd fe 00 00 00 02 00 00</span><br><span class="line">[Thu Jul  9 11:05:08 2020] blk_update_request: I/O error, dev sdcz, sector 19532873214</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] Synchronizing SCSI cache</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] Synchronize Cache(10) failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK</span><br></pre></td></tr></table></figure><h3 id="SMR-device"><a href="#SMR-device" class="headerlink" title="SMR device"></a>SMR device</h3><p>f2fs support zoned block device<br>for zoned block device</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ dmzadm format /dev/sdb</span><br><span class="line">$ dmsetup create dmz-sdb</span><br><span class="line">$ ls -l /dev/mapper/dmz-sdb</span><br></pre></td></tr></table></figure><h3 id="NVME"><a href="#NVME" class="headerlink" title="NVME"></a>NVME</h3><ul><li>NAND P/E Cycles = amount of program / erase cycles NAND can do before wearing out<pre><code>  - WAF = NAND writes / host writes</code></pre></li><li>TBW or PBW  amount of host writes to SSD before wearing out<pre><code>  - TBW = drive capacity * cycles / WAF</code></pre></li><li>DWPD (drive writes per day): amount of data you can write to device each day of the warranty (typically 5 years) without wearing out<pre><code>  - DWPD = TBW/365/5/drive capacity</code></pre></li></ul><ol><li>Create partition smaller than total user capacity of SSD</li><li>Limit max LBA of drive through vendor specific tools</li><li>Create a namespace smaller than total user capacity</li><li>Limit application use to smaller LBA range</li></ol><p><a href="https://events.static.linuxfound.org/sites/events/files/slides/lemoal-nvme-polling-vault-2017-final_0.pdf">nvme hybird polling</a><br>I/O models</p><ul><li><p>IRQ vs polling</p><pre><code>  - NVM is coming ! Is this relevant ?  - Linux implementation</code></pre></li><li><p>Block Layer and NVMe driver</p><pre><code>  - Evaluation Results  - Classic polling vs Hybrid polling  - Impact of process scheduling  - Comparison with user level drivers</code></pre></li><li><p>Implemented by blk_mq_poll</p><pre><code>  - block-mq enabled devices only  - Device queue flagged with poll enabled          - Can be controlled through sysfs          - Enabled by default for devices supporting it, e.g. NVMe</code></pre></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To enable it, you echo 1 to /sys/block/&lt;dev&gt;/queue/io_poll.</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt;  /sys/block/nvme0n1/queue/io_poll</span><br><span class="line">$ cat  /sys/block/nvme0n1/queue/io_poll</span><br><span class="line">1</span><br></pre></td></tr></table></figure><ul><li>Polling is tried for any block I/O belonging to a high-priority I/O context (IOCB_HIPRI)</li><li>IRQs are NOT disabled<pre><code>  - ISR is still executed as the device signals completions  - But ISR sees a completion slot already processed</code></pre></li></ul><p>6us average latency with IRQ, 4.5us with polling</p><ul><li>25% lower latency with polling</li><li>166 KIOPS vs 222 KIOPS</li><li><code>But 100% load on the polling CPU</code></li><li>Only 32% CPU load with IRQ model</li></ul><p>Adaptive hybrid polling gives the same average latency of 4.5us as classic polling</p><ul><li>But with only 58% CPU load</li><li>32% with IRQ model</li><li>Fixed time polling allows controlling the CPU vs latency trade-off</li><li>IRQ like average latency and CPU load for high polling delay</li><li>Better use the IRQ model</li><li>Lower CPU loads with a small average latency degradation achieved with intermediate polling delay</li></ul><p><code>If I use NVME, if you have the top CPU, you could enable the polling, if not , irq is the better choice</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/nvme0n1/queue/io_poll_delay</span><br><span class="line">-1</span><br><span class="line"><span class="comment"># -1 class polling (default)</span></span><br><span class="line"><span class="comment"># 0 means adaptive hybird polling</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/block/nvme0n1/queue/io_poll_delay</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|&lt;------------------------Application</span> <span class="string">Perecived</span> <span class="string">I/O</span> <span class="string">latency---------------------------------&gt;|</span></span><br><span class="line"><span class="string">IRQ</span>      <span class="string">syscall</span>  <span class="string">BIO_stack</span>  <span class="string">Device_driver</span>  <span class="string">CS</span>             <span class="string">sleep</span>            <span class="string">CS</span>  <span class="string">BIO_stack</span></span><br><span class="line">                                                                            <span class="string">|</span> <span class="string">(wake)</span></span><br><span class="line">                                                               <span class="string">CS</span> <span class="string">ISR</span> <span class="string">-------</span></span><br><span class="line">                                                               <span class="string">|(IRQ)</span></span><br><span class="line">                                    <span class="string">command</span> <span class="string">execution-----------</span></span><br><span class="line"></span><br><span class="line"><span class="string">Polling</span>  <span class="string">syscall</span>  <span class="string">BIO_stack</span>  <span class="string">Device_driver</span>    <span class="string">Are</span> <span class="string">you</span> <span class="string">done</span> <span class="string">?</span>    <span class="string">BIO_stack&lt;-------Gain-------&gt;|</span></span><br><span class="line">                                                 <span class="string">|</span></span><br><span class="line">                                           <span class="string">command</span> <span class="string">execution</span></span><br><span class="line"></span><br><span class="line"><span class="string">Hybrid</span>   <span class="string">syscall</span>  <span class="string">BIO_stack</span>  <span class="string">Device_driver</span>  <span class="string">cs</span> <span class="string">sleep</span> <span class="string">cs</span>  <span class="string">done?</span>  <span class="string">BIO_stack&lt;-------Gain-------&gt;|</span></span><br><span class="line">                                                     <span class="string">|(wake)|</span></span><br><span class="line">                                      <span class="string">Timer</span> <span class="string">IRQ</span> <span class="string">--&gt;</span> <span class="string">ISR</span>     <span class="string">|</span></span><br><span class="line">                                                     <span class="string">command</span> <span class="string">execution</span></span><br></pre></td></tr></table></figure><h4 id="Software-optimization"><a href="#Software-optimization" class="headerlink" title="Software optimization"></a>Software optimization</h4><ul><li>System call (VFS)<pre><code>  - Optimizations introduced with kernel 4.10</code></pre></li><li>BIO stack<pre><code>  - blk-mq already very efficient</code></pre></li><li>Device driver<pre><code>  - NVMe driver submission and completion paths are very short</code></pre></li></ul><p><a href="https://metebalci.com/blog/a-quick-tour-of-nvm-express-nvme/">Im copy the article, just read it</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">$ nvme --smart-log /dev/nvme0</span><br><span class="line">Smart Log <span class="keyword">for</span> NVME device:nvme0 namespace-id:ffffffff</span><br><span class="line">critical_warning                    : 0</span><br><span class="line">temperature                         : 35 C</span><br><span class="line">available_spare                     : 100%</span><br><span class="line">available_spare_threshold           : 0%</span><br><span class="line">percentage_used                     : 0%</span><br><span class="line">data_units_read                     : 320,346,034</span><br><span class="line">data_units_written                  : 441,545,307</span><br><span class="line">host_read_commands                  : 16,537,842,223</span><br><span class="line">host_write_commands                 : 19,148,305,649</span><br><span class="line">controller_busy_time                : 3,505</span><br><span class="line">power_cycles                        : 50</span><br><span class="line">power_on_hours                      : 16,079</span><br><span class="line">unsafe_shutdowns                    : 33</span><br><span class="line">media_errors                        : 0</span><br><span class="line">num_err_log_entries                 : 0</span><br><span class="line">Warning Temperature Time            : 0</span><br><span class="line">Critical Composite Temperature Time : 0</span><br><span class="line">Thermal Management T1 Trans Count   : 0</span><br><span class="line">Thermal Management T2 Trans Count   : 0</span><br><span class="line">Thermal Management T1 Total Time    : 0</span><br><span class="line">Thermal Management T2 Total Time    : 0</span><br><span class="line"></span><br><span class="line">nvme error-log /dev/nvme0</span><br><span class="line">Error Log Entries <span class="keyword">for</span> device:nvme0 entries:64</span><br><span class="line">.................</span><br><span class="line"> Entry[ 0]</span><br><span class="line">.................</span><br><span class="line">error_count  : 0</span><br><span class="line">sqid         : 0</span><br><span class="line">cmdid        : 0</span><br><span class="line">status_field : 0(SUCCESS: The <span class="built_in">command</span> completed successfully)</span><br><span class="line">parm_err_loc : 0</span><br><span class="line">lba          : 0</span><br><span class="line">nsid         : 0</span><br><span class="line">vs           : 0</span><br><span class="line">cs           : 0</span><br><span class="line">.................</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Entry[63]</span><br><span class="line">.................</span><br><span class="line">error_count  : 0</span><br><span class="line">sqid         : 0</span><br><span class="line">cmdid        : 0</span><br><span class="line">status_field : 0(SUCCESS: The <span class="built_in">command</span> completed successfully)</span><br><span class="line">parm_err_loc : 0</span><br><span class="line">lba          : 0</span><br><span class="line">nsid         : 0</span><br><span class="line">vs           : 0</span><br><span class="line">cs           : 0</span><br><span class="line">.................</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ nvme get-log /dev/nvme0 --log-id=2 --log-len=512</span><br><span class="line">Device:nvme0 log-id:2 namespace-id:0xffffffff</span><br><span class="line">       0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span><br><span class="line">0000: 00 33 01 64 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;.3.d............&quot;</span></span><br><span class="line">0010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;................&quot;</span></span><br><span class="line">0020: b2 17 18 13 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;................&quot;</span></span><br><span class="line">0030: 5b 72 51 1a 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;[rQ.............&quot;</span></span><br><span class="line">0040: 2f 72 bb d9 03 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;/r..............&quot;</span></span><br><span class="line">0050: f1 f4 53 75 04 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;..Su............&quot;</span></span><br><span class="line">0060: b1 0d 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;................&quot;</span></span><br><span class="line">0070: 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;2...............&quot;</span></span><br><span class="line">0080: cf 3e 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;.&gt;..............&quot;</span></span><br><span class="line">0090: 21 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 <span class="string">&quot;!...............&quot;</span></span><br><span class="line"></span><br><span class="line">$ nvme list</span><br><span class="line">Node             SN                   Model                                    Namespace Usage                      Format           FW Rev</span><br><span class="line">---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------</span><br><span class="line">/dev/nvme0n1     PHKS00000000000000   INTEL SSDPED1K375GA                      1         375.08  GB / 375.08  GB      4 KiB +  0 B   E2010435</span><br><span class="line"></span><br><span class="line">$ nvme list-ns /dev/nvme0n1</span><br><span class="line">NVMe Status:INVALID_NS: The namespace or the format of that namespace is invalid(400b) NSID:0</span><br><span class="line"></span><br><span class="line">$ nvme fw-download /dev/nvme0n1 -f &lt;fw binary&gt;</span><br><span class="line">$ nvme fw-commit /dev/nvme0n1 -s 1 -a 1</span><br><span class="line">$ nvme reset /dev/nvme0</span><br><span class="line"></span><br><span class="line"><span class="comment">#secure format</span></span><br><span class="line">$ nvme format /dev/nvme0 s 1</span><br><span class="line">SES = 0 results <span class="keyword">in</span> drive being formatted and trimmed</span><br><span class="line">SES = 1 <span class="keyword">for</span> Block Erase  low level block erase on media (physically erase NAND blocks, or overwrite with 0 on SCM)</span><br><span class="line">SES = 2 <span class="keyword">for</span> Crypto Erase - change media encryption key</span><br><span class="line">-l <span class="keyword">for</span> LBA format, find capabilities <span class="keyword">in</span> NVMe identify controller -t timeout <span class="keyword">for</span> devices that will take a long time</span><br><span class="line">-p <span class="keyword">for</span> protection information with variable sector size</span><br><span class="line"></span><br><span class="line"><span class="comment">## for more info</span></span><br><span class="line">Format NVM, <span class="built_in">command</span> dword 10</span><br><span class="line"></span><br><span class="line">Sanitize (not widely supported yet)</span><br><span class="line">$ nvme sanitize</span><br><span class="line">* Block Erase  low level block erase on media (physically erase NAND blocks)</span><br><span class="line">* Crypto Erase - change media encryption key</span><br><span class="line">* Overwrite  overwrite with data patterns (not good or recommended <span class="keyword">for</span> NAND based SSDs due to endurance)</span><br></pre></td></tr></table></figure><h4 id="create-mdraid-for-nvme-ssd"><a href="#create-mdraid-for-nvme-ssd" class="headerlink" title="create mdraid for nvme ssd"></a>create mdraid for nvme ssd</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line">$ mdadm -C /dev/md0 /dev/nvme[0-3]n1 n 4 e imsm</span><br><span class="line">$ mdadm -C /dev/md0 /dev/nvme[0-3]n1 n 4 e imsm</span><br><span class="line"></span><br><span class="line"><span class="comment">## I/O polling mode was introduced with linux 4.4, in polling mode the cpu continuously checks if the I/O command completed</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/block/nvme0n1/queue/io_poll</span><br><span class="line">bash: <span class="built_in">echo</span>: write error: Invalid argument</span><br><span class="line"></span><br><span class="line"><span class="comment">## Hybird polling mode was introduced in linux kenrel 4.10, hybrid polling mode improvded QD1 performance closer to that of polling mode performance, but with lower cpu utilizaion</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/block/nvme0n1/queue/io_poll_delay</span><br><span class="line">0=hybrid, 1 = always poll( default )</span><br><span class="line"></span><br><span class="line">block-mq enabled devices only</span><br><span class="line">Device queue flagged with poll enabled</span><br><span class="line"></span><br><span class="line">CPU frequency    &gt;  3.0GHz</span><br><span class="line">Hyper threading     <span class="built_in">disable</span></span><br><span class="line">EIST(Enhanced intel speed step technology)    disabled</span><br><span class="line">intel Turbo mode    <span class="built_in">disable</span></span><br><span class="line">C-states            <span class="built_in">disable</span></span><br><span class="line">P-states            <span class="built_in">disable</span></span><br><span class="line">CPU Governor(os)    performance mode</span><br><span class="line">IRQ balancing(os)   disabled</span><br><span class="line">SMP Affinity        <span class="built_in">set</span> interrupts to run <span class="keyword">in</span> the proper CPU cores</span><br><span class="line">I/O polling or Hybrid mode    Enabled</span><br><span class="line">Linux flow of <span class="built_in">command</span> execution on NVME SSDs</span><br><span class="line">User app requestion IO -&gt; kernel processes IO request and sends to device driver -&gt; device driver processes the requests(create SQ entry, rings doorbell register) -&gt; device processes the requests(<span class="built_in">read</span> sq entry, processes IO, create cq entry, signals MSI-x to host) -&gt; kernel call device driver to handle the completion -&gt; device driver ack, that the entry <span class="keyword">in</span> CQ has been processed</span><br><span class="line"></span><br><span class="line">IO execution <span class="keyword">in</span> SPDK</span><br><span class="line">User app requestion IO -&gt; SPDK userspace device driver process the requests(create SQ entry, rings doorbell register) -&gt; device processes the requestion(<span class="built_in">read</span> sq entry, processes IO, create cq entry) -&gt; user application polls SPDK <span class="keyword">for</span> IO completion -&gt; spdk call user application completion callback when IO is complete</span><br><span class="line"></span><br><span class="line">cat /proc/version /proc/cpuinfo /proc/meminfo /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">lspci -v</span><br><span class="line">nvme list</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable IRQ balance</span></span><br><span class="line"><span class="built_in">set</span> SMP affinity</span><br><span class="line">systemctl stop irqbalance</span><br><span class="line">folders=/proc/irq/*</span><br><span class="line"><span class="keyword">for</span> folder <span class="keyword">in</span> <span class="variable">$folders</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  files=<span class="string">&quot;<span class="variable">$folder</span>/*&quot;</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$files</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">     <span class="keyword">if</span> [[ <span class="variable">$file</span> == *<span class="string">&quot;nvme&quot;</span>* ]]</span><br><span class="line">     <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$file</span></span><br><span class="line">        contents=$(cat <span class="variable">$folder</span>/affinity_hint)</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$contents</span> &gt; <span class="variable">$folder</span>/smp_affinity</span><br><span class="line">        cat <span class="variable">$folder</span>/smp_affinity</span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ nvme id-ctrl -H /dev/nvme0n1</span><br><span class="line">NVME Identify Controller:</span><br><span class="line">vid       : 0x8086                  <span class="comment"># vid is PCI Vendor ID (so Samsung in this case), 0x144d as in the lspci output.</span></span><br><span class="line">ssvid     : 0x8086                  <span class="comment"># ssvid is PCI Subsystem Vendor ID</span></span><br><span class="line">sn        : PHK000000000000000</span><br><span class="line">mn        : INTEL SSDPED1K375GA</span><br><span class="line">fr        : E2010435</span><br><span class="line">rab       : 0</span><br><span class="line">ieee      : 5cd2e4</span><br><span class="line">cmic      : 0                       <span class="comment"># the Controller Multi-Path I/O and Namespace Sharing Capabilities.</span></span><br><span class="line">  [3:3] : 0     ANA not supported</span><br><span class="line">  [2:2] : 0     PCI</span><br><span class="line">  [1:1] : 0     Single Controller</span><br><span class="line">  [0:0] : 0     Single Port</span><br><span class="line"></span><br><span class="line">mdts      : 5                       <span class="comment"># mdts is Maximum Data Transfer Size.</span></span><br><span class="line">                                    <span class="comment"># It is reported as a power of two and in units of minimum memory page size. mdts=5 here</span></span><br><span class="line">                                    <span class="comment"># so 2 = 32. We will see the minimum memory page size (MPSMIN) as 4K below. So MDTS is 32 * 4K = 128K.</span></span><br><span class="line">cntlid    : 0</span><br><span class="line">ver       : 0</span><br><span class="line">rtd3r     : 0</span><br><span class="line">rtd3e     : 0</span><br><span class="line">oaes      :</span><br><span class="line">  [9:9] : 0     Firmware Activation Notices Not Supported</span><br><span class="line">  [8:8] : 0     Namespace Attribute Changed Event Not Supported</span><br><span class="line"></span><br><span class="line">ctratt    : 0</span><br><span class="line">  [5:5] : 0     Predictable Latency Mode Not Supported</span><br><span class="line">  [4:4] : 0     Endurance Groups Not Supported</span><br><span class="line">  [3:3] : 0     Read Recovery Levels Not Supported</span><br><span class="line">  [2:2] : 0     NVM Sets Not Supported</span><br><span class="line">  [1:1] : 0     Non-Operational Power State Permissive Not Supported</span><br><span class="line">  [0:0] : 0     128-bit Host Identifier Not Supported</span><br><span class="line"></span><br><span class="line">rrls      : 0</span><br><span class="line">oacs      : 0x7                    <span class="comment"># Optional Admin Command Support</span></span><br><span class="line">  [8:8] : 0     Doorbell Buffer Config Not Supported</span><br><span class="line">  [7:7] : 0     Virtualization Management Not Supported</span><br><span class="line">  [6:6] : 0     NVMe-MI Send and Receive Not Supported</span><br><span class="line">  [5:5] : 0     Directives Not Supported</span><br><span class="line">  [4:4] : 0     Device Self-test Not Supported</span><br><span class="line">  [3:3] : 0     NS Management and Attachment Not Supported</span><br><span class="line">  [2:2] : 0x1   FW Commit and Download Supported</span><br><span class="line">  [1:1] : 0x1   Format NVM Supported</span><br><span class="line">  [0:0] : 0x1   Security Send and Receive Supported</span><br><span class="line"></span><br><span class="line">acl       : 3</span><br><span class="line">aerl      : 3</span><br><span class="line">frmw      : 0x2                    <span class="comment"># firmware update</span></span><br><span class="line">  [4:4] : 0     Firmware Activate Without Reset Not Supported</span><br><span class="line">  [3:1] : 0x1   Number of Firmware Slots</span><br><span class="line">  [0:0] : 0     Firmware Slot 1 Read/Write</span><br><span class="line"></span><br><span class="line">lpa       : 0x2</span><br><span class="line">  [3:3] : 0     Telemetry host/controller initiated <span class="built_in">log</span> page Not Suporrted</span><br><span class="line">  [2:2] : 0     Extended data <span class="keyword">for</span> Get Log Page Not Supported</span><br><span class="line">  [1:1] : 0x1   Command Effects Log Page Supported</span><br><span class="line">  [0:0] : 0     SMART/Health Log Page per NS Not Supported</span><br><span class="line"></span><br><span class="line">elpe      : 63</span><br><span class="line">npss      : 0</span><br><span class="line">avscc     : 0</span><br><span class="line">  [0:0] : 0     Admin Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line"></span><br><span class="line">apsta     : 0</span><br><span class="line">  [0:0] : 0     Autonomous Power State Transitions Not Supported</span><br><span class="line"></span><br><span class="line">wctemp    : 0</span><br><span class="line">cctemp    : 0</span><br><span class="line">mtfa      : 0</span><br><span class="line">hmpre     : 0</span><br><span class="line">hmmin     : 0</span><br><span class="line">tnvmcap   : 0                      <span class="comment"># Total NVM Capacity and it is an optional field. As it is reported as zero, it is not supported.</span></span><br><span class="line">unvmcap   : 0</span><br><span class="line">rpmbs     : 0</span><br><span class="line"> [31:24]: 0     Access Size</span><br><span class="line"> [23:16]: 0     Total Size</span><br><span class="line">  [5:3] : 0     Authentication Method</span><br><span class="line">  [2:0] : 0     Number of RPMB Units</span><br><span class="line"></span><br><span class="line">edstt     : 0</span><br><span class="line">dsto      : 0</span><br><span class="line">fwug      : 0</span><br><span class="line">kas       : 0</span><br><span class="line">hctma     : 0</span><br><span class="line">  [0:0] : 0     Host Controlled Thermal Management Not Supported</span><br><span class="line"></span><br><span class="line">mntmt     : 0</span><br><span class="line">mxtmt     : 0</span><br><span class="line">sanicap   : 0</span><br><span class="line">  [2:2] : 0     Overwrite Sanitize Operation Not Supported</span><br><span class="line">  [1:1] : 0     Block Erase Sanitize Operation Not Supported</span><br><span class="line">  [0:0] : 0     Crypto Erase Sanitize Operation Not Supported</span><br><span class="line"></span><br><span class="line">hmminds   : 0</span><br><span class="line">hmmaxd    : 0</span><br><span class="line">nsetidmax : 0</span><br><span class="line">anatt     : 0</span><br><span class="line">anacap    : 0</span><br><span class="line">  [7:7] : 0     Non-zero group ID Not Supported</span><br><span class="line">  [6:6] : 0     Group ID does not change</span><br><span class="line">  [4:4] : 0     ANA Change state Not Supported</span><br><span class="line">  [2:2] : 0     ANA Inaccessible state Not Supported</span><br><span class="line">  [1:1] : 0     ANA Non-optimized state Not Supported</span><br><span class="line">  [0:0] : 0     ANA Optimized state Not Supported</span><br><span class="line"></span><br><span class="line">anagrpmax : 0</span><br><span class="line">nanagrpid : 0</span><br><span class="line">sqes      : 0x66   <span class="comment"># (Maximum and Required) Submission Queue Entry (SQE) Size.</span></span><br><span class="line">                   <span class="comment"># It is expected to be 64 but with proprietary extensions it can be modified. The value is 0x66 here.</span></span><br><span class="line">  [7:4] : 0x6   Max SQ Entry Size (64)</span><br><span class="line">  [3:0] : 0x6   Min SQ Entry Size (64)</span><br><span class="line"></span><br><span class="line">cqes      : 0x44   <span class="comment"># (Maximum and Required) Completion Queue Entry (CQE) Size. Similar to calculation of SQE size,</span></span><br><span class="line">                   <span class="comment"># its value is 0x44 here, so both maximum and required completion queue entry size is 2=16 bytes.</span></span><br><span class="line">  [7:4] : 0x4   Max CQ Entry Size (16)</span><br><span class="line">  [3:0] : 0x4   Min CQ Entry Size (16)</span><br><span class="line"></span><br><span class="line">maxcmd    : 0</span><br><span class="line">nn        : 1      <span class="comment"># (Maximum) Number of Namespaces supported by the controller. Although theoretical maximum is high, here it is 1,</span></span><br><span class="line">                   <span class="comment"># so only one namespace is possible.</span></span><br><span class="line">oncs      : 0x6    <span class="comment"># is Optional NVM Command Support</span></span><br><span class="line">  [7:7] : 0     Virtualization Management Not Supported</span><br><span class="line">  [6:6] : 0     Timestamp Not Supported</span><br><span class="line">  [5:5] : 0     Reservations Not Supported</span><br><span class="line">  [4:4] : 0     Save and Select Not Supported</span><br><span class="line">  [3:3] : 0     Write Zeroes Not Supported</span><br><span class="line">  [2:2] : 0x1   Data Set Management Supported</span><br><span class="line">  [1:1] : 0x1   Write Uncorrectable Supported</span><br><span class="line">  [0:0] : 0     Compare Not Supported</span><br><span class="line"></span><br><span class="line">fuses     : 0</span><br><span class="line">  [0:0] : 0     Fused Compare and Write Not Supported</span><br><span class="line"></span><br><span class="line">fna       : 0x4</span><br><span class="line">  [2:2] : 0x1   Crypto Erase Supported as part of Secure Erase</span><br><span class="line">  [1:1] : 0     Crypto Erase Applies to Single Namespace(s)</span><br><span class="line">  [0:0] : 0     Format Applies to Single Namespace(s)</span><br><span class="line"></span><br><span class="line">vwc       : 0</span><br><span class="line">  [0:0] : 0     Volatile Write Cache Not Present</span><br><span class="line"></span><br><span class="line">awun      : 0</span><br><span class="line">awupf     : 0</span><br><span class="line">nvscc     : 0</span><br><span class="line">  [0:0] : 0     NVM Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line"></span><br><span class="line">nwpc      : 0</span><br><span class="line">  [2:2] : 0     Permanent Write Protect Not Supported</span><br><span class="line">  [1:1] : 0     Write Protect Until Power Supply Not Supported</span><br><span class="line">  [0:0] : 0     No Write Protect and Write Protect Namespace Not Supported</span><br><span class="line"></span><br><span class="line">acwu      : 0</span><br><span class="line">sgls      : 0</span><br><span class="line"> [1:0]  : 0     Scatter-Gather Lists Not Supported</span><br><span class="line"></span><br><span class="line">mnan      : 0</span><br><span class="line">subnqn    :</span><br><span class="line">ioccsz    : 0</span><br><span class="line">iorcsz    : 0</span><br><span class="line">icdoff    : 0</span><br><span class="line">ctrattr   : 0</span><br><span class="line">  [0:0] : 0     Dynamic Controller Model</span><br><span class="line"></span><br><span class="line">msdbd     : 0</span><br><span class="line">ps    0 : mp:18.00W operational enlat:0 exlat:0 rrt:0 rrl:0</span><br><span class="line">          rwt:0 rwl:0 idle_power:- active_power:-</span><br></pre></td></tr></table></figure><p>sending Identify List Namespaces</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">$ nvme list-ns /dev/nvme0 <span class="string">&quot;</span></span><br><span class="line"><span class="string">[   0]:0x1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#optane</span></span><br><span class="line"><span class="string">$ nvme list-ns /dev/nvme0</span></span><br><span class="line"><span class="string">NVMe Status:INVALID_NS: The namespace or the format of that namespace is invalid(400b) NSID:0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ nvme id-ns /dev/nvme0 --namespace-id=0x1</span></span><br><span class="line"><span class="string">NVME Identify Namespace 1:</span></span><br><span class="line"><span class="string">nsze    : 0x5754b9a  # Namespace Size (NSZE). Indicates the number of logical blocks, 0x5754b9a = 91573146</span></span><br><span class="line"><span class="string">                     # lsblk -b show nvme0n1     259:0    0  375083606016  0 disk    91573146*4096=375083606016</span></span><br><span class="line"><span class="string">ncap    : 0x5754b9a  # The maximum number of logical blocks allocated to the namespace. </span></span><br><span class="line"><span class="string">                     # If there is a thin provisioning (if disk space is allocated on demand), </span></span><br><span class="line"><span class="string">                     # this value can be less than NSZE. Here, it is not the case so its value is same as NSZE.</span></span><br><span class="line"><span class="string">nuse    : 0x5754b9aa # nuse, Namespace Utilization (NUSE). The current number of logical blocks allocated to the namespace. </span></span><br><span class="line"><span class="string">                     # If there is a thin provisioning (if disk space is allocated on demand), this value can be less than NSZE. </span></span><br><span class="line"><span class="string">                     # Here, it is not the case so its value is same as NSZE.</span></span><br><span class="line"><span class="string">nsfeat  : 0          #  Namespace Features (NSFEAT)</span></span><br><span class="line"><span class="string">                     # Bit 3 = 0, NGUID and EUI64 values may be reused by the controller after this namespace is deleted.</span></span><br><span class="line"><span class="string">                     # Bit 2 = 0, the controller does not support the Deallocated or Unwritten Logical Block error.</span></span><br><span class="line"><span class="string">                     # Bit 1 = 0, AWUN, AWUPF and ACWU fields should be used instead of NAWUN, NAWUPF, NACWU.</span></span><br><span class="line"><span class="string">                     # Bit 0 = 0, meaning the namespace does not support Thin Provisioning.</span></span><br><span class="line"><span class="string">nlbaf   : 6          # Number of LBA Formats (NLBAF). Indicates the number of supported LBA data size and metadata size </span></span><br><span class="line"><span class="string">                     # combinations supported by the namespace. </span></span><br><span class="line"><span class="string">                     # If It is a zero based value and its value here is 0, so there is only 1 format supported.</span></span><br><span class="line"><span class="string">flbas   : 0x3        # Formatted LBA Size (FLBAS). Indicates the LBA data size and metadata size combination </span></span><br><span class="line"><span class="string">                     # Bits 3:0 indicates one of the 16 supported LBA Formats indicated in this data structure. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     #LBA Format fields:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     #ms, Metadata Size (MS). Since its value is 0, metadata is not supported.</span></span><br><span class="line"><span class="string">                     #ds, LBA Data Size (LBADS). It is reported in terms of a power of two, so LBA data size is 2 = 512 bytes.</span></span><br><span class="line"><span class="string">                     #rp, Releative Performance (RP). Indicates the relative performance of this format to other formats. </span></span><br><span class="line"><span class="string">                     # Value of 0 indicates it is the best performance. </span></span><br><span class="line"><span class="string">                     # It does not make much sense here because we have only one LBA Format supported.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mc      : 0x1</span></span><br><span class="line"><span class="string">dpc     : 0x11</span></span><br><span class="line"><span class="string">dps     : 0          # End-to-end Data Protection Type Settings (DPS), T10 PI</span></span><br><span class="line"><span class="string">                     # Bit 3 if set to 1 indicates that the protection information, </span></span><br><span class="line"><span class="string">                     # if enabled, is transferred as the first eight bytes of metadata. </span></span><br><span class="line"><span class="string">                     # Bit 3 if cleared to 0 indicates that the protection information, </span></span><br><span class="line"><span class="string">                     # if enabled, is transferred as the last eight bytes of metadata.</span></span><br><span class="line"><span class="string">                     # 000b Protection information is not enabled</span></span><br><span class="line"><span class="string">                     # 001b Protection information is enabled, Type 1</span></span><br><span class="line"><span class="string">                     # 010b Protection information is enabled, Type 2</span></span><br><span class="line"><span class="string">                     # 011b Protection information is enabled, Type 3</span></span><br><span class="line"><span class="string">                     # 100b  111b Reserved</span></span><br><span class="line"><span class="string">nmic    : 0</span></span><br><span class="line"><span class="string">rescap  : 0</span></span><br><span class="line"><span class="string">fpi     : 0</span></span><br><span class="line"><span class="string">dlfeat  : 0</span></span><br><span class="line"><span class="string">nawun   : 0</span></span><br><span class="line"><span class="string">nawupf  : 0</span></span><br><span class="line"><span class="string">nacwu   : 0</span></span><br><span class="line"><span class="string">nabsn   : 0</span></span><br><span class="line"><span class="string">nabo    : 0</span></span><br><span class="line"><span class="string">nabspf  : 0</span></span><br><span class="line"><span class="string">noiob   : 0</span></span><br><span class="line"><span class="string">nvmcap  : 0</span></span><br><span class="line"><span class="string">nsattr: 0</span></span><br><span class="line"><span class="string">nvmsetid: 0</span></span><br><span class="line"><span class="string">anagrpid: 0</span></span><br><span class="line"><span class="string">endgid  : 0</span></span><br><span class="line"><span class="string">nguid   : 00000000000000000000000000000000</span></span><br><span class="line"><span class="string">eui64   : 5cd2e4e419330100</span></span><br><span class="line"><span class="string">lbaf  0 : ms:0   lbads:9  rp:0x2</span></span><br><span class="line"><span class="string">lbaf  1 : ms:8   lbads:9  rp:0x2</span></span><br><span class="line"><span class="string">lbaf  2 : ms:16  lbads:9  rp:0x2</span></span><br><span class="line"><span class="string">lbaf  3 : ms:0   lbads:12 rp:0 (in use)</span></span><br><span class="line"><span class="string">lbaf  4 : ms:8   lbads:12 rp:0</span></span><br><span class="line"><span class="string">lbaf  5 : ms:64  lbads:12 rp:0</span></span><br><span class="line"><span class="string">lbaf  6 : ms:128 lbads:12 rp:0</span></span><br></pre></td></tr></table></figure><p><a href="https://nvmexpress.org/wp-content/uploads/NVM_Express_Revision_1.3.pdf">nvme_express_revision</a><br>nvme admin command </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">VMe Admin Commands</span><br><span class="line">Here are the NVMe admin commands with opcodes:</span><br><span class="line">Create and Delete I/O Submission Queue (01h, 00h)</span><br><span class="line">Get Log Page (02h)</span><br><span class="line">Create and Delete I/O Completion Queue (05h, 04h)</span><br><span class="line">Identify (06h)</span><br><span class="line">Abort (08h)</span><br><span class="line">Get and Set Features (0Ah, 09h)</span><br><span class="line">Asynchronous Event Request (0Ch)</span><br><span class="line">Namespace Management (0Dh)</span><br><span class="line">Firmware Commit and Image Download (10h, 11h)</span><br><span class="line">Device Self-test (14h)</span><br><span class="line">Namespace Attachment (15h)</span><br><span class="line">Keep Alive (18h)</span><br><span class="line">Directive Send and Receive (19h, 1Ah)</span><br><span class="line">Virtualization Management (1Ch)</span><br><span class="line">NVMe-MI Send and Receive (1Dh, 1Eh)</span><br><span class="line">Doorbell Buffer Config (7Ch)</span><br><span class="line">Format NVM (80h)</span><br><span class="line">Security Send and Receive (81h, 82h)</span><br><span class="line">Sanitize (84h)</span><br><span class="line"></span><br><span class="line">$ nvme admin-passthru /dev/nvme0 --opcode=0x06 --cdw10=0x0001 --data-len=4096 -r -d -s</span><br><span class="line">opcode       : 06</span><br><span class="line">flags        : 00</span><br><span class="line">rsvd1        : 0000</span><br><span class="line">nsid         : 00000000</span><br><span class="line">cdw2         : 00000000</span><br><span class="line">cdw3         : 00000000</span><br><span class="line">data_len     : 00001000</span><br><span class="line">metadata_len : 00000000</span><br><span class="line">addr         : 563223139000</span><br><span class="line">metadata     : 0</span><br><span class="line">cdw10        : 00000001</span><br><span class="line">cdw11        : 00000000</span><br><span class="line">cdw12        : 00000000</span><br><span class="line">cdw13        : 00000000</span><br><span class="line">cdw14        : 00000000</span><br><span class="line">cdw15        : 00000000</span><br><span class="line">timeout_ms   : 00000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># NVM command</span></span><br><span class="line"><span class="comment"># NVM comands should only be sent if controller is ready (indicated by Controller Status register CSTS.RDY) and after I/O submission and completion queue have been created.</span></span><br><span class="line">Flush (00h)</span><br><span class="line">Write and Read (01h, 02h)</span><br><span class="line">Write Uncorrectable (04h)</span><br><span class="line">Compare (05h)</span><br><span class="line">Write Zeroes (08h)</span><br><span class="line">Dataset Management (09h)</span><br><span class="line">Reservation Register and Report (0Dh, 0Eh)</span><br><span class="line">Reservation Acquire and Release (11h, 15h)</span><br><span class="line"></span><br><span class="line">$ nvme show-regs -H /dev/nvme0</span><br><span class="line"><span class="built_in">cap</span>     : 2004010fff</span><br><span class="line">Memory Page Size Maximum      (MPSMAX): 4096 bytes</span><br><span class="line">Memory Page Size Minimum      (MPSMIN): 4096 bytes</span><br><span class="line">Boot Partition Support           (BPS): No</span><br><span class="line">Command Sets Supported           (CSS): NVM <span class="built_in">command</span> <span class="built_in">set</span> is supported</span><br><span class="line">NVM Subsystem Reset Supported  (NSSRS): No</span><br><span class="line">Doorbell Stride                (DSTRD): 4 bytes</span><br><span class="line">Timeout                           (TO): 2000 ms</span><br><span class="line">Arbitration Mechanism Supported  (AMS): Weighted Round Robin with Urgent Priority Class is not supported</span><br><span class="line">Contiguous Queues Required       (CQR): Yes</span><br><span class="line">Maximum Queue Entries Supported (MQES): 4096  <span class="comment">### Bytes</span></span><br><span class="line"></span><br><span class="line">version : 10000</span><br><span class="line">NVMe specification 1.0</span><br><span class="line"></span><br><span class="line">cc      : 460001</span><br><span class="line">I/O Completion Queue Entry Size (IOCQES): 16 bytes</span><br><span class="line">I/O Submission Queue Entry Size (IOSQES): 64 bytes</span><br><span class="line">Shutdown Notification              (SHN): No notification; no effect</span><br><span class="line">Arbitration Mechanism Selected     (AMS): Round Robin</span><br><span class="line">Memory Page Size                   (MPS): 4096 bytes</span><br><span class="line">I/O Command Sets Selected          (CSS): NVM Command Set</span><br><span class="line">Enable                              (EN): Yes</span><br><span class="line"></span><br><span class="line">csts    : 1</span><br><span class="line">Processing Paused               (PP): No</span><br><span class="line">NVM Subsystem Reset Occurred (NSSRO): No</span><br><span class="line">Shutdown Status               (SHST): Normal operation (no shutdown has been requested)</span><br><span class="line">Controller Fatal Status        (CFS): False</span><br><span class="line">Ready                          (RDY): Yes</span><br><span class="line"></span><br><span class="line">nssr    : 0</span><br><span class="line">NVM Subsystem Reset Control (NSSRC): 0</span><br><span class="line"></span><br><span class="line">intms   : 0</span><br><span class="line">Interrupt Vector Mask Set (IVMS): 0</span><br><span class="line"></span><br><span class="line">intmc   : 0</span><br><span class="line">Interrupt Vector Mask Clear (IVMC): 0</span><br><span class="line"></span><br><span class="line">aqa     : 1f001f</span><br><span class="line">Admin Completion Queue Size (ACQS): 32</span><br><span class="line">Admin Submission Queue Size (ASQS): 32</span><br><span class="line"></span><br><span class="line">asq     : 10255f9000</span><br><span class="line">Admin Submission Queue Base (ASQB): 10255f9000</span><br><span class="line"></span><br><span class="line">acq     : 10255f8000</span><br><span class="line">Admin Completion Queue Base (ACQB): 10255f8000</span><br><span class="line"></span><br><span class="line">cmbloc  : 0</span><br><span class="line">Controller Memory Buffer feature is not supported</span><br><span class="line"></span><br><span class="line">cmbsz   : 0</span><br><span class="line">Controller Memory Buffer feature is not supported</span><br><span class="line"></span><br><span class="line">bpinfo  : 0</span><br><span class="line">Boot Partition feature is not supported</span><br><span class="line"></span><br><span class="line">bprsel  : 0</span><br><span class="line">Boot Partition feature is not supported</span><br><span class="line"></span><br><span class="line">bpmbl   : 0</span><br><span class="line">Boot Partition feature is not supported</span><br></pre></td></tr></table></figure><h4 id="Read-data-from-the-device"><a href="#Read-data-from-the-device" class="headerlink" title="Read data from the device"></a>Read data from the device</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/nvme0n1 of=lba.0.dd bs=512 count=1</span><br><span class="line">$ nvme <span class="built_in">read</span> /dev/nvme0n1 --start-block=0 --block-count=0 --data-size=512 --data=lba.0.read</span><br><span class="line">$ nvme io-passthru /dev/nvme0 --opcode=0x02 --namespace-id=0x1 --data-len=512 --<span class="built_in">read</span> --cdw10=0 --cdw11=0 --cdw12=0 -b &gt; lba.0.io</span><br><span class="line">nvme: malloc.c:2392: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)<span class="string">&#x27; failed.</span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> block </tag>
            
            <tag> scsi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fault ratio</title>
      <link href="2016/07/20/fault_ratio/"/>
      <url>2016/07/20/fault_ratio/</url>
      
        <content type="html"><![CDATA[<h3 id="calculate-fault-ratio"><a href="#calculate-fault-ratio" class="headerlink" title="calculate fault ratio"></a>calculate fault ratio</h3><p>First year failure four HDD at the same time,single HDD fault rate 0.01<br>Third year failure four HDD at the same time,single HDD fault rate 0.03<br>Fifth year failure four HDD at the same time,single HDD fault rate 0.05</p><p>In third year, Raidz3 broken four HDD at the same time<br>$ awk BEGIN{printf %.12f\n, 1-(480/(365*24/0.03)+0.03)^4}<br>0.999998997334</p><p>Real MTBF<br>$ awk BEGIN{printf %.10f\n, 365*24/0.03}<br>292000.0000000000</p><h3 id="AFR"><a href="#AFR" class="headerlink" title="AFR"></a>AFR</h3><p><a href="https://documents.westerndigital.com/content/dam/doc-library/en_us/assets/public/western-digital/product/data-center-drives/ultrastar-dc-hc500-series/data-sheet-ultrastar-dc-hc510.pdf">https://documents.westerndigital.com/content/dam/doc-library/en_us/assets/public/western-digital/product/data-center-drives/ultrastar-dc-hc500-series/data-sheet-ultrastar-dc-hc510.pdf</a><br>2.5M hours MTBF and 0.35% AFR(Annualized Failure Rate),<br>356x24=8760<br>$ awk BEGIN{printf %.2f\n, 8760/0.004}<br>2190000.00<br>$ awk BEGIN{printf %.2f\n, 8760/0.035}<br>2502857.14</p><h3 id="Nonrecoverable-Read-Errors-URE-per-Bits-Read"><a href="#Nonrecoverable-Read-Errors-URE-per-Bits-Read" class="headerlink" title="Nonrecoverable Read Errors(URE) per Bits Read"></a>Nonrecoverable Read Errors(URE) per Bits Read</h3><p>1 byte per 10E15 (Enterprise 7.2k HDD 10E15=1000000000000000)</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1e12</span>*<span class="number">8</span> bytes = <span class="number">1</span> (TB)</span><br><span class="line">(<span class="number">1e15</span>)/(<span class="number">1e12</span>*<span class="number">8</span>)=<span class="number">125</span> (TB)</span><br></pre></td></tr></table></figure><p>1 byte per 10E14 (Desktop 5.9k/7.2k HDD)</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1e14</span>)/(<span class="number">1e12</span>*<span class="number">8</span>)=<span class="number">12.5</span> (TB)</span><br></pre></td></tr></table></figure><p>1 byte per 10E17 (Enterprise SSD)<br>1 byte per 10E16 (Desktop SSD/SAS 15k HDD)</p>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ratio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spec</title>
      <link href="2016/06/16/spec/"/>
      <url>2016/06/16/spec/</url>
      
        <content type="html"><![CDATA[<h3 id="Intel-Cascade-Lake-CPU-suffix"><a href="#Intel-Cascade-Lake-CPU-suffix" class="headerlink" title="Intel Cascade Lake CPU suffix"></a>Intel Cascade Lake CPU suffix</h3><p>F suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package<br>L suffix indicates the SKU is a large memory (4.5 TiB) tier SKU<br>M suffix indicates the SKU is a medium memory (2 TiB) tier SKU<br>N suffix indicates the SKU is a networking-specialized model<br>S suffix indicates the SKU is a search application-specialized model<br>T suffix indicates that SKU has an extended lifetime (10 year use) guarantees and NEBS-friendly packing specification<br>U suffix indicates the SKU is a single-socket model (even if part of the Xeon Gold family that normally supports up two 4-way SMP)<br>V suffix indicates the SKU targets the VM density value market<br>Y suffix indicates the SKU has Speed Select Technology (SST)<br>R suffix indicates the SKU is a refresh model( add cores or frequency)</p><h3 id="Device-parameters"><a href="#Device-parameters" class="headerlink" title="Device parameters"></a><a href="https://www.seagate.com/www-content/surveillance-center/files/Understanding-Reliability-Metrics.pdf">Device parameters</a></h3><h4 id="MTBF-Mean-Time-Between-Failure"><a href="#MTBF-Mean-Time-Between-Failure" class="headerlink" title="(MTBF) Mean Time Between Failure"></a>(MTBF) Mean Time Between Failure</h4><p>MTBF, however, can be subject to misinterpretation. For example, an HDD might carry a 1M-hour MTBF, causing some customers to erroneously assume that the drive should be able to run 24 hours a day for a century or more. Obviously, this is theoretical.</p><p>MTBF is actually reached by dividing the total time a population of samples is under observation by the number of failures. If you have 1000 drives running for 1000 hours each, and five of them fail (10001000/5 ), youve then derived a 200K-hour MTBF. Because MTBF is typically calculated during an HDDs useful life, consider a graph of failure rate over time, starting when a population of HDDs rolls off of the manufacturing line. </p><h4 id="AFR-Annualized-Failure-Rate"><a href="#AFR-Annualized-Failure-Rate" class="headerlink" title="(AFR) Annualized Failure Rate"></a>(AFR) Annualized Failure Rate</h4><p>Recently, Seagate began offering AFR specs on some drives in addition to conventional MTBF ratings. Although the two metrics are similar, AFR is a percentage estimate of the products that will likely fail due to a defect over a 1-year period. The subtle distinction lies in a switch from averages to percentages. MTBF is based on probabilities; AFR relies on HDD return numbers and analyses for its estimates. AFRs dont include HDDs returned without issues, those subjected to excessive shock or HDDs that were mishandled. Seagate expects AFR to help facilitate better service plans and spare unit strategies.<br>Remember: AFR, as with any reliability metric, makes specific assumptions about how many hours an HDD is running per year, endured motor start/stop cycles, and internal temperature, all of which affect reliability. But AFR doesnt necessarily help you get to the bottom of which HDD is right for your application. Enter the annualized workload rate (WRL).</p><h4 id="WRL-Workload-Rate-Limit"><a href="#WRL-Workload-Rate-Limit" class="headerlink" title="(WRL) Workload Rate Limit"></a>(WRL) Workload Rate Limit</h4><p>Seagate specifies a WRLthat is, the maximum read/write workload (also in terabytes per year) a given HDD is designed to accommodate. Enterprise-class drives feature a WRL of 300TB to 550TB/year. Specialty-tuned drives, including NAS, archive, video and surveillance families, are rated for 180TB/year; Seagates client portfolio (desktop and laptop HDDs) has a workload rate limit of 55TB/year, which is still a formidable amount of data within the client market segment.</p><p>Consider environmental conditions in your reliability projections. An insufficiently-cooled storage device, even operating under its WRL, will experience a higher failure rate than those at or under manufacturer specifications. Similarly, using a desktop HDD in a highly active chassis with significant vibration levels can also take a toll on the performance and reliability of the drive.</p><p><a href="https://www.seagate.com/support/kb/annualized-workload-rate-005902en/">Annualized Workload Rate</a> = (Lifetime Writes + Lifetime Reads) * (8760 / Lifetime Power On Hours)<br>8760 are the number of hours in a year.  The Workload Rate becomes an annualized average expressed as TB/year.</p><p>Enterprise                300~550TB/year<br>NAS/archive/surveillance  180TB/year<br>desktop/laptop            55TB/year</p><h3 id="PCI-PCI-X-speed"><a href="#PCI-PCI-X-speed" class="headerlink" title="PCI/PCI-X speed"></a>PCI/PCI-X speed</h3><table><thead><tr><th>Bus and frequency</th><th>32 bit transfer rate</th><th>64 bit Transfer rate</th></tr></thead><tbody><tr><td>33-MHz PCI</td><td>1064Mb/s</td><td>2128Mb/s</td></tr><tr><td>66-MHz PCI</td><td>2128Mb/s</td><td>4256Mb/s</td></tr><tr><td>100-MHz PCI-X</td><td>Not applicable</td><td>6400Mb/s</td></tr><tr><td>133-MHz PCI-X</td><td>Not applicable</td><td>8192Mb/s</td></tr></tbody></table><table><thead><tr><th>PCIE</th><th>Encoded</th><th>transmit rate</th><th>code</th></tr></thead><tbody><tr><td>Gen 1 x1</td><td>0.25GB/s</td><td>2.5GT</td><td>8/10b</td></tr><tr><td>Gen 2 x1</td><td>0.5GB/s</td><td>5GT/s</td><td>8/10b</td></tr><tr><td>Gen 3 x1</td><td>0.9846GB/s</td><td>8GT/s</td><td>128/130b</td></tr><tr><td>Gen 4 x1</td><td>1.969GB/s</td><td>16GT/s</td><td>128/130b</td></tr></tbody></table><p>Eg: 16GT/s * 128/130/8 = 1.96923GB/s</p><table><thead><tr><th>SAS3 performance</th><th>bandwidth GBps</th></tr></thead><tbody><tr><td>SAS3 64 x read raw single SAS port</td><td>4</td></tr><tr><td>SAS3 64 x write raw single SAS port</td><td>3.9</td></tr><tr><td>SAS3 64 x rw 1:1 raw single SAS port</td><td>1.9/1.9</td></tr><tr><td>SAS3 64 x rw 1:1 raw dual SAS port</td><td>3.63/3.62</td></tr></tbody></table><p>single LSI 9300-8e SAS port(4e) with 84 x 3.5inch NLSAS HDD<br>Not enough SSD for test iops </p><a id="more"></a><h3 id="Hardware-index"><a href="#Hardware-index" class="headerlink" title="Hardware index"></a>Hardware index</h3><h4 id="JBOD"><a href="#JBOD" class="headerlink" title="JBOD"></a>JBOD</h4><table><thead><tr><th>Model</th><th>H</th><th>H(mm)</th><th>W</th><th>Depth</th><th>Fans</th><th>3.5 slot</th><th>power(w)</th><th>Weight(max)</th><th>Single Interface</th><th>Voltage</th></tr></thead><tbody><tr><td>946ED-R2KJBOD</td><td>4U</td><td>178</td><td>447</td><td>906</td><td>4+1</td><td>90</td><td>4x1000</td><td>102.06kg</td><td>4xSAS3 SFF-8644a</td><td></td></tr><tr><td>HGST data60</td><td>4U</td><td>175</td><td>424</td><td>938</td><td>N+1</td><td>60</td><td>2x1650</td><td>89.81 kg</td><td>2xSAS3 SFF-8436/8644</td><td>200-240VAC</td></tr><tr><td>Dell MD1280</td><td>5U</td><td>223</td><td>483</td><td>975</td><td>N+1</td><td>84</td><td>2x2200</td><td>130.1 kg</td><td>3xSAS2 SFF-8088</td><td></td></tr><tr><td>Dell ME484</td><td>5U</td><td>223</td><td>483</td><td>975</td><td>N+1</td><td>84</td><td>2x2200</td><td>130.1 kg</td><td>3xSAS3 SFF-8644</td><td>200-240VAC</td></tr><tr><td>WD data102</td><td>4U</td><td>175</td><td>447</td><td>1047</td><td>N+1</td><td>102</td><td>2x1600</td><td>118.8 kg</td><td>4xSAS3 SFF-8644</td><td>200-240VAC</td></tr><tr><td>AIC J4108-01</td><td>4U</td><td>176</td><td>434</td><td>1050</td><td>8+1</td><td>108</td><td>2x2000</td><td>unknow</td><td>4xSAS3 SFF-8644</td><td>200-240VAC</td></tr></tbody></table><p>WD data 102 max of 1197mm (dual CMA and SAS cable)</p><table><thead><tr><th>Model</th><th>Humidity</th><th>Random Vibration</th><th>Sinusoidal Vibration</th><th>Temperature Range</th></tr></thead><tbody><tr><td>946ED-R2KJBOD</td><td>8%-90%</td><td></td><td></td><td>5C-35C(air)40C (helium)</td></tr><tr><td>HGST JBOD 4U60</td><td>8%-80%</td><td>0.25Grms 5-10Hz</td><td>0.05 g, 10-300Hz</td><td>5C-35C(air)40C (helium)</td></tr><tr><td>Dell MD1280</td><td>10%-80%</td><td></td><td>1.04 g,2-200Hz(max)</td><td>5C-35C(air)40C (helium)</td></tr><tr><td>Dell ME484</td><td>10%-80%</td><td></td><td>1.04 g,2-200Hz(max)</td><td>5C-35C(air)40C (helium)</td></tr><tr><td>WD data102</td><td>5%-85%</td><td></td><td></td><td>5C-35C(air)40C (helium)</td></tr><tr><td>AIC J4108-01</td><td>20%-80%</td><td></td><td></td><td>0C-35C(air)</td></tr></tbody></table><h4 id="Raid"><a href="#Raid" class="headerlink" title="Raid"></a>Raid</h4><table><thead><tr><th>RAID</th><th>SAS chip</th><th>dell</th><th>Cache</th><th>SAS</th><th>SAS port</th></tr></thead><tbody><tr><td>9380-8e</td><td>LSI 3108</td><td>H830</td><td>4GB</td><td>2x4x12G</td><td>SFF-8644</td></tr><tr><td>9361-8i</td><td>LSI 3108</td><td>H730</td><td>1-2G</td><td>2x4x12G</td><td>SFF-8643</td></tr><tr><td>9341-8i</td><td>LSI 3008</td><td>H330</td><td>1GB</td><td>2x4x12G</td><td>SFF-8643</td></tr><tr><td>9260-8i</td><td>LSI 2108</td><td>none</td><td>0.5G</td><td>2x4x6G</td><td>SFF-8087</td></tr><tr><td>9260-8i</td><td>LSI 2208</td><td>H710</td><td>1GB</td><td>2x4x6G</td><td>SFF-8087</td></tr><tr><td>9286-8e</td><td>LSI 2208</td><td>H810</td><td>1GB</td><td>2x4x6G</td><td>SFF-8088</td></tr><tr><td>HP P244br</td><td>PMC</td><td></td><td>1GB</td><td>2x1x12G</td><td>SFF-8643</td></tr><tr><td>HP P440ar</td><td>PMC</td><td></td><td>2GB</td><td>2x4x12G</td><td>SFF-8643</td></tr><tr><td>HP P440</td><td>PMC</td><td></td><td>2GB</td><td>1x8x12G</td><td>SFF-8643</td></tr><tr><td>P431-8e</td><td>PMC</td><td></td><td>4GB</td><td>2x4x12G</td><td>SFF-8644</td></tr><tr><td>HP P441</td><td>PMC</td><td></td><td>4GB</td><td>2x4x12G</td><td>SFF-8643</td></tr><tr><td>P741m-8e</td><td>PMC</td><td></td><td>4GB</td><td>2x4x12G</td><td>SFF-8644</td></tr><tr><td>P841-8e</td><td>PMC</td><td></td><td>4GB</td><td>4x4x12G</td><td>SFF-8644</td></tr><tr><td>9480-8i8e</td><td>LSI 3516</td><td>H840</td><td>4GB</td><td>4x4x12G</td><td>2xSFF-8643/2x8444</td></tr><tr><td>9460-8i</td><td>LSI 3508</td><td>H740</td><td>4GB</td><td>2x4x12G</td><td>2xSFF-8643</td></tr></tbody></table><p>LSI RAID controller has no PCIE Gen3 x16</p><h4 id="LSI-Fusion-MPT"><a href="#LSI-Fusion-MPT" class="headerlink" title="LSI Fusion-MPT"></a>LSI Fusion-MPT</h4><table><thead><tr><th>SAS chip</th><th>dell</th><th>LSI</th><th>SAS</th><th>SAS port</th><th>Power</th><th>PCIE</th></tr></thead><tbody><tr><td>LSI 3008</td><td>HBA12i</td><td>9311-8i</td><td>3</td><td>SFF8643</td><td>14.5W</td><td>G3x8</td></tr><tr><td>LSI 3008</td><td>HBA12e</td><td>9300-8e</td><td>3</td><td>SFF8644</td><td>14.5W</td><td>G3x8</td></tr><tr><td>LSI 3216</td><td></td><td>9305-16e</td><td>3</td><td>SFF8644</td><td>13w</td><td>G3x8</td></tr><tr><td>LSI3008x2</td><td></td><td>9302-16e</td><td>3</td><td>SFF8644</td><td>30W</td><td>G3x8</td></tr><tr><td>LSI 3224</td><td></td><td>9305-24i</td><td>3</td><td>SFF8643</td><td>16.2w</td><td>G3x8</td></tr><tr><td>LSI 3224</td><td></td><td>9305-24i</td><td>3</td><td>SFF8643</td><td>16.2w</td><td>G3x8</td></tr><tr><td>LSI 2008</td><td>HBA6i</td><td>9211-8i</td><td>2</td><td>SFF8087</td><td>7w</td><td>G2x8</td></tr><tr><td>LSI 2308</td><td>none</td><td>9207-8e</td><td>2</td><td>SFF8088</td><td>9.8w</td><td>G3x8</td></tr><tr><td>LSI2008x2</td><td>none</td><td>9202-16e</td><td>2</td><td>SFF8088</td><td>9.8w</td><td>G2x8</td></tr><tr><td>LSI2008x2</td><td>HBA6e</td><td>9200-8e</td><td>2</td><td>SFF8088</td><td></td><td>G2x8</td></tr><tr><td>LSI 3616W</td><td>16i/e</td><td>9405W</td><td>4</td><td>SFF8643/44</td><td>14.0w</td><td>G3x16</td></tr><tr><td>PMC</td><td></td><td>HP H220-8i</td><td>2</td><td>SFF8087</td><td></td><td></td></tr><tr><td>PMC</td><td></td><td>HP H221-8e</td><td>2</td><td>SFF8087</td><td></td><td></td></tr><tr><td>PMC</td><td></td><td>HP H240-8i</td><td>3</td><td>SFF8643</td><td></td><td></td></tr><tr><td>PMC</td><td></td><td>H240br-8i</td><td>3</td><td>SFF8643</td><td></td><td></td></tr><tr><td>PMC</td><td></td><td>H240br-8i</td><td>3</td><td>SFF8643</td><td></td><td></td></tr><tr><td>PMC</td><td></td><td>H241-8e</td><td>3</td><td>SFF8644</td><td></td><td></td></tr></tbody></table><h4 id="LSI-ARM-arch-SAS-SATA-NVME"><a href="#LSI-ARM-arch-SAS-SATA-NVME" class="headerlink" title="LSI ARM arch, SAS, SATA, NVME"></a>LSI ARM arch, SAS, SATA, NVME</h4><table><thead><tr><th>SAS chip</th><th>PCIE lanes</th><th>PCIE BW</th><th>SAS BW</th><th>CPU</th><th>PCIE devices</th></tr></thead><tbody><tr><td>LSI 3416</td><td>x8 G3</td><td>16GBps</td><td>19.2GBps</td><td>ARM A15 1.2G</td><td>16</td></tr><tr><td>LSI 3408</td><td>x8 G3</td><td>8GBps</td><td>9.6GBps</td><td>ARM A15 1.2G</td><td>16</td></tr><tr><td>LSI 3616W</td><td>x16 G3</td><td>16GBps</td><td>19.2GBps</td><td>ARM A15 1.2G</td><td>16</td></tr></tbody></table><ul><li>SFF-8639<ul><li>PCIE Gen3 1,2,4 lanes<ul><li>3.938 GB/s (PCIE G3 x4)</li></ul></li></ul></li><li>SFF-8644 <ul><li>Does signle SAS cable and single port could over PCIE x4 bandwidth ?<ul><li>Yes, 3.9X GB/s, single SAS port only PCIE x4 </li></ul></li></ul></li></ul><h4 id="NVME-SAS-SSD"><a href="#NVME-SAS-SSD" class="headerlink" title="NVME/SAS SSD"></a>NVME/SAS SSD</h4><p>DWPD deps JESD219 random Workloads</p><table><thead><tr><th>Model</th><th>SIZE(TB)</th><th>DWPD (5y)</th><th>Nand</th><th>R/W(GB/s)</th><th>4K ios(k)</th><th>interface</th><th>UBER</th><th>MTBF</th><th>FIO ext4 4K OPS(k)</th></tr></thead><tbody><tr><td>SD Optimus MAX</td><td>4</td><td>0.5</td><td>19nm emlc</td><td>0.4 0.4</td><td>85 11</td><td>6Gbps SAS</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>Lightning Eco GII</td><td>1.6</td><td>3</td><td>15nm emlc</td><td>0.98 0.6</td><td>195 81</td><td>12Gbps SAS</td><td>10^18</td><td>2.5M</td><td></td></tr><tr><td>Lightning Ultra GII</td><td>0.8</td><td>25</td><td>15nm emlc</td><td>0.98 0.74</td><td>199 115</td><td>12Gbps SAS</td><td>10^19</td><td>2.5M</td><td></td></tr><tr><td>Ultrastar SSD1600MR</td><td>1.9</td><td>2.6</td><td>emlc</td><td>1 0.7</td><td>130 30</td><td>12Gbps SAS</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>Ultrastar SS200</td><td>0.48-7.6</td><td>1</td><td>15nm emlc</td><td>1.8 1</td><td>250 37</td><td>12Gbps SAS</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>Ultrastar SS200</td><td>0.4-6.4</td><td>3</td><td>15nm emlc</td><td>1.8 1</td><td>250 86</td><td>12Gbps SAS</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>HGST s842</td><td>2</td><td>14-40</td><td>emlc</td><td>0.53 0.38</td><td>84 28</td><td>6Gbps SAS</td><td></td><td>2M</td><td></td></tr><tr><td>1200.2 ST3840FM0003</td><td>3.8</td><td>3</td><td>15nm emlc</td><td>1.1 0.77</td><td>180 30</td><td>12Gbps SAS</td><td>10^17</td><td>2M</td><td></td></tr><tr><td>Samsung PM1635</td><td>1.6</td><td>3</td><td>TLC</td><td>0.94 0.79</td><td>190 50</td><td>12Gbps SAS</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>WD DC SS540</td><td>0.8T-6.4T</td><td>1-3</td><td>TLC</td><td>2.1 2.1</td><td>470 240</td><td>wide port12G</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>WD DC SS530</td><td>0.4T-3.2T</td><td>1-10</td><td>TLC</td><td>2.1 2.1</td><td>470 320</td><td>wide port12G</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>WD SN200</td><td>1T-7T</td><td>1-3</td><td>MLC 15nm</td><td>6.1 2.2</td><td>1200 200</td><td>AIC U.2</td><td>10^17</td><td>2M</td><td></td></tr><tr><td>Intel DC P4510</td><td>1T-15T</td><td>?</td><td>TLC</td><td>3.1 3.1</td><td>583 131</td><td>AIC U.2</td><td>10^17</td><td>2M</td><td></td></tr><tr><td>Intel DC P4610</td><td>1T-15T</td><td>3.15</td><td>64xTLC</td><td>3.2 3.2</td><td>651 219</td><td>AIC U.2</td><td>10^17</td><td>2M</td><td></td></tr><tr><td>Intel DC P4501</td><td>0.5-4T</td><td>0.68</td><td>TLC</td><td>3.1 0.8</td><td>361 46.7</td><td>AIC U.2</td><td>10^17</td><td>2M</td><td></td></tr><tr><td>Intel D5 P4320</td><td>7T</td><td>0.19</td><td>QLC</td><td>3.2 1</td><td>427 36</td><td>AIC U.2</td><td>10^17</td><td>2M</td><td></td></tr><tr><td>KIOXIA(toshiba) CD</td><td>0.9-7.6</td><td>less 1</td><td>BiCS TLC</td><td>3.1 1.98</td><td>550 50</td><td>AIC U.2</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>KIOXIA PM5-V</td><td>0.4-6.4</td><td>3</td><td>BiCS TLC</td><td>2.1 2.1</td><td>385 120</td><td>wide port12G</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>KIOXIA CM5-R</td><td>0.9-15</td><td>1</td><td>BiCS TLC</td><td>3.3 3</td><td>590 35</td><td>AIC U.2</td><td>10^17</td><td>2.5M</td><td></td></tr><tr><td>Dell Mircon 5100 Pro</td><td>0.48</td><td>1</td><td>3D eTLC</td><td>0.54 0.25~0.52</td><td>78<del>93 26</del>43</td><td>6Gbps SATA</td><td></td><td>2M</td><td>set WCE not work 77.3 64.1 31.3/31.3</td></tr><tr><td>Intel P4500</td><td>1</td><td>0.75</td><td>3D TLC</td><td>3.2 0.6</td><td>279.5 30.5</td><td>AIC U.2</td><td>10^17</td><td>2M</td><td>VWC=0 292  162  102/102</td></tr><tr><td>HUSMM1616ASS204</td><td>1.6</td><td>3</td><td>MLC</td><td>1.1 0.76</td><td>130 100</td><td>12Gbps SAS</td><td>10^17</td><td>2M</td><td>WCE=0 139  107  60.7/60.7</td></tr></tbody></table><p>[global]<br>rw=randrw/randread/randwrite<br>ioengine=posixaio<br>norandommap=1<br>iodepth=16<br>size=4G<br>numjobs=32<br>group_reporting<br>refill_buffers<br>exitall<br>time_based<br>runtime=3600<br>direct=1<br>bssplit=4K/100<br>group_reporting<br>nrfiles=128<br>[rw]<br>directory=/mnt</p><ul><li>Port<ul><li>The Port contains one or more PHYs, Group of PHYs having same SAS Address</li><li>Narrow Port<pre><code>* If there is only one PHY in the Port</code></pre></li><li>SAS Wide Ports/multi link<pre><code>* Inherent in the SAS architecture is the concept of wide ports, where multiple links can be aggregated to allow multiple simultaneous paths between one or more hosts and a device. The current SAS drive connector defines two ports for the drive. As a design choice, current HDDs do not support wide port, only dual port, where each port has a different SAS address that prevents configuration as a wide port.* If there are more than one PHY in the Port,SAS Device contains one or more ports,Connections are made between PHYs but addressed to Ports.</code></pre></li></ul></li></ul><p>Accepted proposals for SAS-3 (12Gb/s) allow the number of ports on the drive to be increased to four, all of which could connect to the same domain or in pairs to different domains. A very limited number of SSDs can support wide port in addition to dual port on a two-port device</p><p><a href="https://www.snia.org/sites/default/files/SDC15_presentations/networking/Kuticipal-McSorley_SCSI_Standards_Technology_Final.pdf">SAS cable</a></p><table><thead><tr><th>Supported SAS3</th><th>Passive Cu</th><th>Active Cu</th><th>Optical</th></tr></thead><tbody><tr><td>Max distance</td><td>&lt;6m</td><td>&lt;20m</td><td>&gt;100m</td></tr><tr><td>Connectors</td><td>mini-sas/QSFP</td><td>mini-sas/QSFP</td><td>Mini-SAS/QSFP</td></tr><tr><td>Cable oruting</td><td>poor</td><td>poor</td><td>good</td></tr><tr><td>Cost</td><td>base</td><td>base+</td><td>base+</td></tr></tbody></table><p>A passive twinax cable carries a signal over short lengths (5m or under) of copper with no additional components to boost signal.<br>While an active copper cable contains electrical components in the connectors that boost signal levels. This makes active copper cables a little more expensive than passive copper cables; </p><ul><li>Multilink SAS<ul><li>SFF-8640 4 ports<pre><code> * 2 x 2 ports 48Gb/s each, total = 96Gb/s * 1 x 4 port 96Gb/s * 4 x 1 ports 24Gb/s each, total = 96Gb/s</code></pre></li><li>SFF-8630 4 ports<pre><code> * 2 x 2 ports 48Gb/s each, total = 48Gb/s * 1 x 4 port 48Gb/s * 4 x 1 ports 12Gb/s each, total = 48Gb/s</code></pre></li></ul></li><li>Multi-Function<ul><li>SFF-8638 4 ports<pre><code> * 2 x 2 ports 48Gb/s each, total = 96Gb/s * 1 x 4 port 96Gb/s           * 4 x 1 ports 24Gb/s each, total = 96Gb/s</code></pre></li><li>SFF-8639 4 ports<pre><code> * 2 x 2 ports 48Gb/s each, total = 48Gb/s * 1 x 4 port 48Gb/s  * 4 x 1 ports 12gb/s each, total = 48Gb/s</code></pre></li></ul></li><li>Standard Dual port<pre><code>* SFF-8681      * 2 x 1 ports 24 Gb/s each, total = 48Gb/s      * 1 x 2 port 48 Gb/s* SFF-8680      * 2 x 1 ports 12Gb/s each, total 24 Gb/s      * 1 x 2 ports 24Gb/s* SFF-8482      * 2 x 1 ports 3Gb/s each, total 6Gb/s      * 1 x 1 port 3Gb/s</code></pre></li></ul><h4 id="SATA-SSD"><a href="#SATA-SSD" class="headerlink" title="SATA SSD"></a>SATA SSD</h4><p>DWPD deps JESD219 random Workloads</p><table><thead><tr><th>Model</th><th>SIZE(TB)</th><th>DWPD (5y)</th><th>Nand</th><th>R/W(GB/s)</th><th>ios(k)</th><th>interface</th><th>UBER</th><th>MTBF</th></tr></thead><tbody><tr><td>CloudSpeed Eco GenII</td><td>1.92</td><td>0.6</td><td>15nm emlc</td><td>0.53,0.46</td><td>75,14</td><td>6Gbps</td><td>10^18</td><td>2M</td></tr><tr><td>CloudSpeed Ultra GenII</td><td>1.6</td><td>1.8</td><td>15nm emlc</td><td>0.53,0.46</td><td>76,32</td><td>6Gbps</td><td>10^18</td><td>2M</td></tr><tr><td>Intel DC s3100</td><td>1</td><td>0.06</td><td>16nm tlc</td><td>0.50,0.11</td><td>59,3.9</td><td>6Gbps</td><td>10^16</td><td>1.6M</td></tr><tr><td>Intel DC s3510</td><td>1.6</td><td>0.35</td><td>16nm emlc</td><td>0.50,0.43</td><td>65,15</td><td>6Gbps</td><td>10^17</td><td>2M</td></tr><tr><td>Intel DC s3520</td><td>1.6</td><td>0.35</td><td>16 3d emlc</td><td>0.45,0.38</td><td>67,17</td><td>6Gbps</td><td>10^17</td><td>2M</td></tr><tr><td>Intel DC s3610</td><td>1.6</td><td>3</td><td>20nm emlc</td><td>0.55,0.5</td><td>84,27</td><td>6Gbps</td><td>10^17</td><td>2M</td></tr><tr><td>Samsung PM863</td><td>3.8</td><td>0.78</td><td>3d TLC</td><td>0.55,0.5</td><td>99,18</td><td>6Gbps</td><td></td><td></td></tr><tr><td>Samsung SM863</td><td>3.8</td><td>3.5</td><td>3d MLC</td><td>0.52,0.48</td><td>97,29</td><td>6Gbps</td><td></td><td></td></tr><tr><td>intel D3 S4510</td><td>7.68</td><td>1.86</td><td>3d TLC</td><td>0.55,0.51</td><td>89,21</td><td>6Gbps</td><td>10^17</td><td>2M</td></tr><tr><td>WD S210</td><td>1.92</td><td>0.1</td><td>3d TLC</td><td>0.55,0.51</td><td>89,21</td><td>6Gbps</td><td>10^17</td><td>2M</td></tr><tr><td>intel D3 S4610</td><td>1.92</td><td>3.1</td><td>3d TLC</td><td>0.55,0.51</td><td>90,35</td><td>6Gbps</td><td>10^17</td><td>2M</td></tr><tr><td>KIOXIA(toshiba)HK6-R</td><td>0.4-7.68</td><td>1</td><td>BiCS TLC</td><td>0.55,0.53</td><td>84,24</td><td>SATA 3.3</td><td>10^17</td><td>2M</td></tr></tbody></table><p><a href="https://www.snia.org/sff/specifications2">SFF TA TWG Specifications</a></p><h3 id="DMI-3-0"><a href="#DMI-3-0" class="headerlink" title="DMI 3.0"></a>DMI 3.0</h3><p><img src="/img/Dt9p6.jpg"><br>DMI 2.0 2 GB/s<br>DMI 3.0 3.93 GB/s<br>SATA SSD 500MB/s x 4/8 = 2000/4000MB/s<br><a href="http://electronics.stackexchange.com/questions/219440/why-do-cpus-typically-connect-to-only-one-bus/219446">reference</a></p><h3 id="NIC"><a href="#NIC" class="headerlink" title="NIC"></a>NIC</h3><h4 id="10GbE"><a href="#10GbE" class="headerlink" title="10GbE"></a><a href="http://www.missioncriticalmagazine.com/ext/resources/MC/Home/Files/PDFs/WP_Blade_Ethernet_Cabling.pdf">10GbE</a></h4><p><img src="/img/sfp-10bt-1.png"><br><img src="/img/sfp-10bt-2.png"></p><h3 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h3><h4 id="NVME-Interface-reference"><a href="#NVME-Interface-reference" class="headerlink" title="NVME Interface reference"></a><a href="http://www.nvmexpress.org/wp-content/uploads/NVMe_Infrastructure_final1.pdf">NVME Interface reference</a></h4><p><a href="http://www.snia.org/sites/default/education/tutorials/2012/fall/solid/AnilVasudeva_NVMe_NextGen_SSD%20Interface-r1-nc1.pdf">NVME interface</a></p><p><img src="/img/nvme-1.png"><br><img src="/img/nvme-2.png"><br><img src="/img/nvme-3.png"><br><img src="/img/nvme-4.png"><br><img src="/img/nvme-5.png"><br><img src="/img/nvme-6.png"><br><img src="/img/nvme-7.png"><br><img src="/img/nvme-8.png"><br><img src="/img/nvme-9.png"><br><img src="/img/nvme-10.png"><br><img src="/img/nvme-11.png"></p><h4 id="supermicro-benchmark"><a href="#supermicro-benchmark" class="headerlink" title="supermicro benchmark"></a><a href="https://www.supermicro.com/white_paper/white_paper_NVMe.pdf">supermicro benchmark</a></h4><p><img src="/img/nvme-12.png"></p><h4 id="Risks-of-unexpected-power-loss-on-solid-state-drives"><a href="#Risks-of-unexpected-power-loss-on-solid-state-drives" class="headerlink" title="Risks of unexpected power loss on solid state drives"></a><a href="http://www8.hp.com/h20195/v2/GetPDF.aspx/4AA6-1470ENW.pdf">Risks of unexpected power loss on solid state drives</a></h4><p>Each time data is accessed or modified on the SSD, metadata is modified pertaining to the state of the data. This information allows for the storage controller to choose what data should be in the drives volatile cache at any given moment as well as the ability to implement techniques which increase performance and endurance</p><p>The drive then translates the LBA to the Physical Block Address (PBA) by way a flash translation table (FTL). The FTL is stored in cache and it is the responsibility of the controller to flush this table to non-volatile memory at times it deems appropriate or during a clean shutdown. The metadata associated with each page of data written also has information that can be used to rebuild the FTL if it is lost, but this rebuild takes time at the next power-on. If both the FTL and metadata are corrupted due to a sudden power loss event, the data stored on the SSD can become lost or even worse, the SSD, as a whole, can become inaccessible</p><p>Turning drive cache off<br>Pros: Data integrity is preserved in the event of a sudden power loss.<br>Cons: Dramatic decrease in read and write performance.<br>Increased writes to NAND resulting in lower write endurance and decreased drive life. FTL data is still stored in the volatile cache, which leaves it at risk</p><p>Capacitor hold-up circuitry<br>Pros: Data integrity is preserved in the event of a sudden power loss.<br>Cons: Increased cost due to inclusion of additional circuitry including capacitors. Additional board space is required.</p><h4 id="Dell-Solid-State-Drive-FAQ"><a href="#Dell-Solid-State-Drive-FAQ" class="headerlink" title="Dell Solid-State-Drive-FAQ"></a><a href="http://www.dell.com/downloads/global/products/pvaul/en/Solid-State-Drive-FAQ-us.pdf">Dell Solid-State-Drive-FAQ</a></h4><h3 id="Enterprise-HDD"><a href="#Enterprise-HDD" class="headerlink" title="Enterprise HDD"></a>Enterprise HDD</h3><h4 id="Rotational-Speed-10K15K"><a href="#Rotational-Speed-10K15K" class="headerlink" title="Rotational Speed 10K15K"></a>Rotational Speed 10K15K</h4><p>Error Rate (non-recoverable, bits read)  1 sector per 10E16<br> Mean Time Between Failures (MTBF, hours)   &lt;2M<br>Availability (hrs/day x days/wk)  24x7</p><h4 id="Rotational-Speed-7200"><a href="#Rotational-Speed-7200" class="headerlink" title="Rotational Speed 7200"></a>Rotational Speed 7200</h4><p>Error Rate (non-recoverable, bits read)  1 sector per 10E15<br>Mean Time Between Failures (MTBF, hours)  &gt;1.2M<br>Availability (hrs/day x days/wk)  24x7</p><p><img src="/img/hdd-spec.png"><br>there are 3 differents sector size in seagate product<br><img src="/img/sector-size.png"></p><h3 id="SATA-all-parameters"><a href="#SATA-all-parameters" class="headerlink" title="SATA all parameters"></a>SATA all parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl --identify  /dev/sdb</span><br><span class="line">smartctl 6.6 2017-11-05 r4594 [x86_64-linux-4.18.0-80.11.2.el8_0.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-17, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">=== ATA IDENTIFY DATA ===</span><br><span class="line">Word     Bit     Value   Description</span><br><span class="line"></span><br><span class="line">   0      -     0x045a   General configuration</span><br><span class="line">   0     14:8     0x04   Vendor specific [RET-3]</span><br><span class="line">   0      6          1   Not removable controller and/or device [OBS-6]</span><br><span class="line">   0      5:3      0x3   Vendor specific [RET-3]</span><br><span class="line">   0      1          1   Vendor specific [RET-3]</span><br><span class="line"></span><br><span class="line">   1      -     0x3fff   Cylinders [OBS-6]</span><br><span class="line"></span><br><span class="line">   2      -     0xc837   Specific configuration (0x37c8/738c/8c73/c837)</span><br><span class="line"></span><br><span class="line">   3      -     0x0010   Heads [OBS-6]</span><br><span class="line"></span><br><span class="line">   6      -     0x003f   Sectors per track [OBS-6]</span><br><span class="line"></span><br><span class="line">  10-19   -     .        Serial number (String)</span><br><span class="line">  10-13   .     0x2020:2020:2020:2020  <span class="string">&quot;        &quot;</span></span><br><span class="line">  14-17   .     0x2020:2020:3254:4b42  <span class="string">&quot;    2TKB&quot;</span></span><br><span class="line">  18-19   .     0x3645:4a44            <span class="string">&quot;6EJD&quot;</span></span><br><span class="line"></span><br><span class="line">  20      -     0x0003   Vendor specific [RET-3]</span><br><span class="line"></span><br><span class="line">  22      -     0x0038   Vendor specific bytes on READ/WRITE LONG [OBS-4]</span><br><span class="line"></span><br><span class="line">  23-26   -     .        Firmware revision (String)</span><br><span class="line">  23-26   .     0x4c48:4445:4c54:3134  <span class="string">&quot;LHDELT14&quot;</span></span><br><span class="line"></span><br><span class="line">  27-46   -     .        Model number (String)</span><br><span class="line">  27-30   .     0x4847:5354:2048:5548  <span class="string">&quot;HGST HUH&quot;</span></span><br><span class="line">  31-34   .     0x3732:3130:3130:414c  <span class="string">&quot;721010AL&quot;</span></span><br><span class="line">  35-38   .     0x4536:3030:2020:2020  <span class="string">&quot;E600    &quot;</span></span><br><span class="line">  39-42   .     0x2020:2020:2020:2020  <span class="string">&quot;        &quot;</span></span><br><span class="line">  43-46   .     0x2020:2020:2020:2020  <span class="string">&quot;        &quot;</span></span><br><span class="line"></span><br><span class="line">  47      -     0x8010   READ/WRITE MULTIPLE support</span><br><span class="line">  47     15:8     0x80   Must be <span class="built_in">set</span> to 0x80</span><br><span class="line">  47      7:0     0x10   Maximum sectors per DRQ on READ/WRITE MULTIPLE</span><br><span class="line"></span><br><span class="line">  48      -     0x4000   Trusted Computing feature <span class="built_in">set</span> options</span><br><span class="line">  48     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"></span><br><span class="line">  49      -     0x2f00   Capabilities</span><br><span class="line">  49     13          1   Standard standby timer values supported</span><br><span class="line">  49     11          1   IORDY supported</span><br><span class="line">  49     10          1   IORDY may be disabled</span><br><span class="line">  49      9          1   LBA supported</span><br><span class="line">  49      8          1   DMA supported</span><br><span class="line"></span><br><span class="line">  50      -     0x4000   Capabilities</span><br><span class="line">  50     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"></span><br><span class="line">  51      -     0x0200   PIO data transfer mode [OBS-5]</span><br><span class="line"></span><br><span class="line">  52      -     0x0200   Single Word DMA data transfer mode [OBS-3]</span><br><span class="line"></span><br><span class="line">  53      -     0x0007   Field validity / Free-fall Control</span><br><span class="line">  53      2          1   Word 88 (Ultra DMA modes) is valid</span><br><span class="line">  53      1          1   Words 64-70 (PIO modes) are valid</span><br><span class="line">  53      0          1   Words 54-58 (CHS) are valid [OBS-6]</span><br><span class="line"></span><br><span class="line">  54      -     0x3fff   Current cylinders [OBS-6]</span><br><span class="line"></span><br><span class="line">  55      -     0x0010   Current heads [OBS-6]</span><br><span class="line"></span><br><span class="line">  56      -     0x003f   Current sectors per track [OBS-6]</span><br><span class="line"></span><br><span class="line">  57-58   -     .        Current capacity <span class="keyword">in</span> sectors (DWord) [OBS-6]</span><br><span class="line">  57-58   .     0xfc10:00fb  (16514064)</span><br><span class="line"></span><br><span class="line">  59      -     0x7100   Sanitize Device - READ/WRITE MULTIPLE support</span><br><span class="line">  59     14          1   OVERWRITE EXT supported</span><br><span class="line">  59     13          1   CRYPTO SCRAMBLE EXT supported</span><br><span class="line">  59     12          1   Sanitize Device feature <span class="built_in">set</span> supported</span><br><span class="line">  59      8          1   Bits 7:0 are valid [OBS-ACS-4]</span><br><span class="line"></span><br><span class="line">  60-61   -     .        User addressable sectors <span class="keyword">for</span> 28-bit commands (DWord)</span><br><span class="line">  60-61   .     0xffff:0fff  (268435455)</span><br><span class="line"></span><br><span class="line">  63      -     0x0007   Multiword DMA modes</span><br><span class="line">  63      2          1   Multiword DMA mode 2 and below supported</span><br><span class="line">  63      1          1   Multiword DMA mode 1 and below supported</span><br><span class="line">  63      0          1   Multiword DMA mode 0 supported</span><br><span class="line"></span><br><span class="line">  64      -     0x0003   PIO modes</span><br><span class="line">  64      1          1   PIO mode 4 supported</span><br><span class="line">  64      0          1   PIO mode 3 supported</span><br><span class="line"></span><br><span class="line">  65      -     0x0078   Minimum Multiword DMA cycle time per word <span class="keyword">in</span> ns</span><br><span class="line"></span><br><span class="line">  66      -     0x0078   Recommended Multiword DMA cycle time <span class="keyword">in</span> ns</span><br><span class="line"></span><br><span class="line">  67      -     0x0078   Minimum PIO cycle time without flow control <span class="keyword">in</span> ns</span><br><span class="line"></span><br><span class="line">  68      -     0x0078   Minimum PIO cycle time with IORDY flow control <span class="keyword">in</span> ns</span><br><span class="line"></span><br><span class="line">  69      -     0x0c18   Additional support</span><br><span class="line">  69     11          1   READ BUFFER DMA supported</span><br><span class="line">  69     10          1   WRITE BUFFER DMA supported</span><br><span class="line">  69      4          1   Device encrypts all user data</span><br><span class="line">  69      3          1   Extended number of user addressable sectors supported</span><br><span class="line"></span><br><span class="line">  75      -     0x001f   Queue depth</span><br><span class="line">  75      4:0     0x1f   Maximum queue depth - 1</span><br><span class="line"></span><br><span class="line">  76      -     0x950e   Serial ATA capabilities</span><br><span class="line">  76     15          1   READ LOG DMA EXT as equiv to READ LOG EXT supported</span><br><span class="line">  76     12          1   NCQ priority information supported</span><br><span class="line">  76     10          1   Phy Event Counters supported</span><br><span class="line">  76      8          1   NCQ feature <span class="built_in">set</span> supported</span><br><span class="line">  76      3          1   SATA Gen3 signaling speed (6.0 Gb/s) supported</span><br><span class="line">  76      2          1   SATA Gen2 signaling speed (3.0 Gb/s) supported</span><br><span class="line">  76      1          1   SATA Gen1 signaling speed (1.5 Gb/s) supported</span><br><span class="line"></span><br><span class="line">  77      -     0x0076   Serial ATA additional capabilities</span><br><span class="line">  77      6          1   RECEIVE/SEND FPDMA QUEUED supported</span><br><span class="line">  77      5          1   NCQ Queue Management supported</span><br><span class="line">  77      4          1   NCQ Streaming supported</span><br><span class="line">  77      3:1      0x3   Current Serial ATA signal speed</span><br><span class="line"></span><br><span class="line">  78      -     0x04d4   Serial ATA features supported</span><br><span class="line">  78     10          1   Reserved <span class="keyword">for</span> Serial ATA</span><br><span class="line">  78      7          1   NCQ Autosense supported</span><br><span class="line">  78      6          1   Software Settings Preservation supported</span><br><span class="line">  78      4          1   In-order data delivery supported</span><br><span class="line">  78      2          1   DMA Setup auto-activation supported</span><br><span class="line"></span><br><span class="line">  79      -     0x0044   Serial ATA features enabled</span><br><span class="line">  79      6          1   Software Settings Preservation enabled</span><br><span class="line">  79      2          1   DMA Setup auto-activation enabled</span><br><span class="line"></span><br><span class="line">  80      -     0x03fc   Major version number</span><br><span class="line">  80      9          1   ACS-2 supported</span><br><span class="line">  80      8          1   ATA8-ACS supported</span><br><span class="line">  80      7          1   ATA/ATAPI-7 supported [OBS-ACS-4]</span><br><span class="line">  80      6          1   ATA/ATAPI-6 supported [OBS-ACS-4]</span><br><span class="line">  80      5          1   ATA/ATAPI-5 supported [OBS-ACS-4]</span><br><span class="line">  80      4          1   ATA/ATAPI-4 supported [OBS-8]</span><br><span class="line">  80      3          1   ATA-3 supported [OBS-7]</span><br><span class="line">  80      2          1   ATA-2 supported [OBS-6]</span><br><span class="line"></span><br><span class="line">  81      -     0x0029   Minor version number</span><br><span class="line"></span><br><span class="line">  82      -     0x746b   Commands and feature sets supported</span><br><span class="line">  82     14          1   NOP supported</span><br><span class="line">  82     13          1   READ BUFFER supported</span><br><span class="line">  82     12          1   WRITE BUFFER supported</span><br><span class="line">  82     10          1   HPA feature <span class="built_in">set</span> supported [OBS-ACS-3]</span><br><span class="line">  82      6          1   Read look-ahead supported</span><br><span class="line">  82      5          1   Volatile write cache supported</span><br><span class="line">  82      3          1   Power Management feature <span class="built_in">set</span> supported</span><br><span class="line">  82      1          1   Security feature <span class="built_in">set</span> supported</span><br><span class="line">  82      0          1   SMART feature <span class="built_in">set</span> supported</span><br><span class="line"></span><br><span class="line">  83      -     0x7d69   Commands and feature sets supported</span><br><span class="line">  83     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line">  83     13          1   FLUSH CACHE EXT supported</span><br><span class="line">  83     12          1   FLUSH CACHE supported</span><br><span class="line">  83     11          1   DCO feature <span class="built_in">set</span> supported [OBS-ACS-3]</span><br><span class="line">  83     10          1   48-bit Address feature <span class="built_in">set</span> supported</span><br><span class="line">  83      8          1   SET MAX security extension supported [OBS-ACS-3]</span><br><span class="line">  83      6          1   SET FEATURES subcommand required to spin-up</span><br><span class="line">  83      5          1   PUIS feature <span class="built_in">set</span> supported</span><br><span class="line">  83      3          1   APM feature <span class="built_in">set</span> supported</span><br><span class="line">  83      0          1   DOWNLOAD MICROCODE supported</span><br><span class="line"></span><br><span class="line">  84      -     0x6773   Commands and feature sets supported</span><br><span class="line">  84     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line">  84     13          1   IDLE IMMEDIATE with UNLOAD feature supported</span><br><span class="line">  84     10          1   URG bit <span class="keyword">for</span> WRITE STREAM (DMA) EXT supported [OBS-8]</span><br><span class="line">  84      9          1   URG bit <span class="keyword">for</span> READ STREAM (DMA) EXT supported [OBS-8]</span><br><span class="line">  84      8          1   64-bit World Wide Name supported</span><br><span class="line">  84      6          1   WRITE DMA/MULTIPLE FUA EXT supported</span><br><span class="line">  84      5          1   GPL feature <span class="built_in">set</span> supported</span><br><span class="line">  84      4          1   Streaming feature <span class="built_in">set</span> supported</span><br><span class="line">  84      1          1   SMART self-test supported</span><br><span class="line">  84      0          1   SMART error logging supported</span><br><span class="line"></span><br><span class="line">  85      -     0x7469   Commands and feature sets supported or enabled</span><br><span class="line">  85     14          1   NOP supported</span><br><span class="line">  85     13          1   READ BUFFER supported</span><br><span class="line">  85     12          1   WRITE BUFFER supported</span><br><span class="line">  85     10          1   HPA feature <span class="built_in">set</span> supported [OBS-ACS-3]</span><br><span class="line">  85      6          1   Read look-ahead enabled</span><br><span class="line">  85      5          1   Write cache enabled</span><br><span class="line">  85      3          1   Power Management feature <span class="built_in">set</span> supported</span><br><span class="line">  85      0          1   SMART feature <span class="built_in">set</span> enabled</span><br><span class="line"></span><br><span class="line">  86      -     0xbc41   Commands and feature sets supported or enabled</span><br><span class="line">  86     15          1   Words 119-120 are valid</span><br><span class="line">  86     13          1   FLUSH CACHE EXT supported</span><br><span class="line">  86     12          1   FLUSH CACHE supported</span><br><span class="line">  86     11          1   DCO feature <span class="built_in">set</span> supported [OBS-ACS-3]</span><br><span class="line">  86     10          1   48-bit Address features <span class="built_in">set</span> supported</span><br><span class="line">  86      6          1   SET FEATURES subcommand required to spin-up</span><br><span class="line">  86      0          1   DOWNLOAD MICROCODE supported</span><br><span class="line"></span><br><span class="line">  87      -     0x6773   Commands and feature sets supported or enabled</span><br><span class="line">  87     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line">  87     13          1   IDLE IMMEDIATE with UNLOAD FEATURE supported</span><br><span class="line">  87     10          1   URG bit <span class="keyword">for</span> WRITE STREAM (DMA) EXT supported [OBS-8]</span><br><span class="line">  87      9          1   URG bit <span class="keyword">for</span> READ STREAM (DMA) EXT supported [OBS-8]</span><br><span class="line">  87      8          1   64-bit World Wide Name supported</span><br><span class="line">  87      6          1   WRITE DMA/MULTIPLE FUA EXT supported</span><br><span class="line">  87      5          1   GPL feature <span class="built_in">set</span> supported</span><br><span class="line">  87      4          1   Valid CONFIGURE STREAM has been executed [OBS-8]</span><br><span class="line">  87      1          1   SMART self-test supported</span><br><span class="line">  87      0          1   SMART error logging supported</span><br><span class="line"></span><br><span class="line">  88      -     0x407f   Ultra DMA modes</span><br><span class="line">  88     14          1   Ultra DMA mode 6 selected</span><br><span class="line">  88      6          1   Ultra DMA mode 6 and below supported</span><br><span class="line">  88      5          1   Ultra DMA mode 5 and below supported</span><br><span class="line">  88      4          1   Ultra DMA mode 4 and below supported</span><br><span class="line">  88      3          1   Ultra DMA mode 3 and below supported</span><br><span class="line">  88      2          1   Ultra DMA mode 2 and below supported</span><br><span class="line">  88      1          1   Ultra DMA mode 1 and below supported</span><br><span class="line">  88      0          1   Ultra DMA mode 0 supported</span><br><span class="line"></span><br><span class="line">  89      -     0x81d7   SECURITY ERASE UNIT time</span><br><span class="line">  89     15          1   Bits 14:8 of value are valid</span><br><span class="line">  89     14:0   0x01d7   SECURITY ERASE UNIT time value</span><br><span class="line"></span><br><span class="line">  91      -     0x00fe   Current APM level</span><br><span class="line">  91      7:0     0xfe   Current APM level value</span><br><span class="line"></span><br><span class="line">  92      -     0xfffe   Master Password Identifier</span><br><span class="line"></span><br><span class="line">  95      -     0x0008   Stream Minimum Request Size</span><br><span class="line"></span><br><span class="line">  96      -     0x00ca   Streaming Transfer Time - DMA</span><br><span class="line"></span><br><span class="line">  97      -     0x00f9   Streaming Access Latency - DMA and PIO</span><br><span class="line"></span><br><span class="line">  98-99   -     .        Streaming Performance Granularity (DWord)</span><br><span class="line">  98-99   .     0x2710:0000  (10000)</span><br><span class="line"></span><br><span class="line"> 100-103  -     .        User addressable sectors <span class="keyword">for</span> 48-bit commands (QWord)</span><br><span class="line"> 100-103  .     0x0000:8c40:0004:0000  (19532873728)</span><br><span class="line"></span><br><span class="line"> 104      -     0x00ca   Streaming Transfer Time - PIO</span><br><span class="line"></span><br><span class="line"> 106      -     0x6003   Physical sector size / logical sector size</span><br><span class="line"> 106     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"> 106     13          1   Multiple logical sectors per physical sector</span><br><span class="line"> 106      3:0      0x3   2^X logical sectors per physical sector</span><br><span class="line"></span><br><span class="line"> 107      -     0x5a87   Inter-seek delay <span class="keyword">for</span> ISO 7779 acoustic testing</span><br><span class="line"></span><br><span class="line"> 108-111  -     .        World Wide Name</span><br><span class="line"> 108-111  .     0x5000:cca2:6aef:5ec1</span><br><span class="line"></span><br><span class="line"> 119      -     0x40dc   Commands and feature sets supported</span><br><span class="line"> 119     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"> 119      7          1   Extended Power Conditions feature <span class="built_in">set</span> supported</span><br><span class="line"> 119      6          1   Sense Data Reporting feature <span class="built_in">set</span> supported</span><br><span class="line"> 119      4          1   DOWNLOAD MICROCODE with mode 3 supported</span><br><span class="line"> 119      3          1   READ/WRITE LOG DMA EXT supported</span><br><span class="line"> 119      2          1   WRITE UNCORRECTABLE EXT supported</span><br><span class="line"></span><br><span class="line"> 120      -     0x409c   Commands and feature sets supported or enabled</span><br><span class="line"> 120     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"> 120      7          1   Extended Power Conditions feature <span class="built_in">set</span> enabled</span><br><span class="line"> 120      4          1   DOWNLOAD MICROCODE with mode 3 supported</span><br><span class="line"> 120      3          1   READ/WRITE LOG DMA EXT supported</span><br><span class="line"> 120      2          1   WRITE UNCORRECTABLE EXT supported</span><br><span class="line"></span><br><span class="line"> 128      -     0x0001   Security status</span><br><span class="line"> 128      0          1   Security supported</span><br><span class="line"></span><br><span class="line"> 129-159  -     .        Vendor specific</span><br><span class="line"> 129-132  .     0x000b:0000:0000:0000</span><br><span class="line"> 133-136  .     0x0000:0000:0000:0000</span><br><span class="line"> 137-140  .     0x0000:0000:0000:0000</span><br><span class="line"> 141-144  .     0x0000:0000:0000:0000</span><br><span class="line"> 145-148  .     0x0000:0000:0000:0000</span><br><span class="line"> 149-152  .     0x0000:0000:0008:4445</span><br><span class="line"> 153-156  .     0x0000:0000:0000:0000</span><br><span class="line"> 157-159  .     0x0000:0000:0000</span><br><span class="line"></span><br><span class="line"> 168      -     0x0002   Form factor</span><br><span class="line"> 168      3:0      0x2   Nominal form factor: -, 5.25, 3.5, 2.5, 1.8, ...</span><br><span class="line"></span><br><span class="line"> 170-173  -     .        Additional product identifier (String)</span><br><span class="line"> 170-173  .     0x4445:4c4c:2874:6d29  <span class="string">&quot;DELL(tm)&quot;</span></span><br><span class="line"></span><br><span class="line"> 206      -     0x003d   SCT Command Transport</span><br><span class="line"> 206      5          1   SCT Data Tables supported</span><br><span class="line"> 206      4          1   SCT Feature Control supported</span><br><span class="line"> 206      3          1   SCT Error Recovery Control supported</span><br><span class="line"> 206      2          1   SCT Write Same supported</span><br><span class="line"> 206      0          1   SCT Command Transport supported</span><br><span class="line"></span><br><span class="line"> 209      -     0x4000   Alignment of logical sectors</span><br><span class="line"> 209     15:14     0x1   Must be <span class="built_in">set</span> to 0x1</span><br><span class="line"></span><br><span class="line"> 217      -     0x1c20   Nominal media rotation rate</span><br><span class="line"></span><br><span class="line"> 222      -     0x10ff   Transport major version number</span><br><span class="line"> 222     15:12     0x1   Transport: 0x0 = Parallel, 0x1 = Serial, 0xe = PCIe</span><br><span class="line"> 222      7          1   Reserved    | SATA 3.2</span><br><span class="line"> 222      6          1   Reserved    | SATA 3.1</span><br><span class="line"> 222      5          1   Reserved    | SATA 3.0</span><br><span class="line"> 222      4          1   Reserved    | SATA 2.6</span><br><span class="line"> 222      3          1   Reserved    | SATA 2.5</span><br><span class="line"> 222      2          1   Reserved    | SATA II: Extensions</span><br><span class="line"> 222      1          1   ATA/ATAPI-7 | SATA 1.0a</span><br><span class="line"> 222      0          1   ATA8-APT    | ATA8-AST</span><br><span class="line"></span><br><span class="line"> 223      -     0x0021   Transport minor version number</span><br><span class="line"></span><br><span class="line"> 230-233  -     .        Extended number of user addressable sectors (QWord)</span><br><span class="line"> 230-233  .     0x0000:8c40:0004:0000  (19532873728)</span><br><span class="line"></span><br><span class="line"> 234      -     0x0001   Minimum blocks per DOWNLOAD MICROCODE mode 3 <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line"> 255      -     0x26a5   Integrity word</span><br><span class="line"> 255     15:8     0x26   Checksum</span><br><span class="line"> 255      7:0     0xa5   Signature</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpu </tag>
            
            <tag> scsi </tag>
            
            <tag> bus </tag>
            
            <tag> nvme </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awk tips</title>
      <link href="2016/04/04/awk/"/>
      <url>2016/04/04/awk/</url>
      
        <content type="html"><![CDATA[<h3 id="replace-square-brackets"><a href="#replace-square-brackets" class="headerlink" title="replace square brackets"></a>replace square brackets</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;[<span class="string">12:3:5:8</span>]&quot; | awk -F: &#x27;&#123;gsub(&quot;[][]&quot;,&quot;&quot;); print $1&#125;&#x27;</span><br></pre></td></tr></table></figure><h3 id="match-bash-variable"><a href="#match-bash-variable" class="headerlink" title="match bash variable"></a>match bash variable</h3><p>awk -v slot_var=$slot {if($0~/Slot.*$slot_var/)</p><h3 id="Set-awk-env"><a href="#Set-awk-env" class="headerlink" title="Set awk env"></a>Set awk env</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWKBUFSIZE=$((<span class="number">1024</span>*<span class="number">1024</span>)) </span><br><span class="line"><span class="comment">#you could strace</span></span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;B2000712/17B2000712.TPM2.data\t34&quot;</span>..., 1048576) = 1048576</span><br></pre></td></tr></table></figure><h3 id="write-file-in-awk"><a href="#write-file-in-awk" class="headerlink" title="write file in awk"></a>write file in awk</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ awk <span class="string">&#x27;&#123;print $2 &gt;&quot;text.out&quot;&#125;&#x27;</span> text.txt</span><br></pre></td></tr></table></figure><h3 id="Sort-array-by-awk"><a href="#Sort-array-by-awk" class="headerlink" title="Sort array by awk"></a>Sort array by awk</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">file</span></span><br><span class="line"><span class="string">port</span> <span class="number">12</span></span><br><span class="line"><span class="string">zest</span> <span class="number">2</span></span><br><span class="line"><span class="string">status</span> <span class="number">4</span></span><br><span class="line"><span class="string">flash</span> <span class="number">4</span></span><br><span class="line"><span class="string">hero</span> <span class="number">3</span></span><br><span class="line"><span class="string">awk</span> <span class="number">3</span></span><br><span class="line"><span class="string">innovation</span> <span class="number">10</span></span><br><span class="line"><span class="string">test</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="Sort-index-descend"><a href="#Sort-index-descend" class="headerlink" title="Sort index (descend)"></a>Sort index (descend)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/awk -f</span><br><span class="line">&#123; </span><br><span class="line">a[$<span class="number">1</span>]=$<span class="number">2</span>; </span><br><span class="line">        PROCINFO[<span class="string">&quot;sorted_in&quot;</span>] = <span class="string">&quot;@ind_str_desc&quot;</span></span><br><span class="line">&#125; </span><br><span class="line">END &#123;</span><br><span class="line"><span class="keyword">for</span> (i in a) &#123;</span><br><span class="line"><span class="built_in">print</span> i, a[i]</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>output</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/tmp/awkscript</span> <span class="string">file</span></span><br><span class="line"><span class="string">zest</span> <span class="number">2</span></span><br><span class="line"><span class="string">test</span> <span class="number">1</span></span><br><span class="line"><span class="string">status</span> <span class="number">4</span></span><br><span class="line"><span class="string">port</span> <span class="number">12</span></span><br><span class="line"><span class="string">innovation</span> <span class="number">10</span></span><br><span class="line"><span class="string">hero</span> <span class="number">3</span></span><br><span class="line"><span class="string">flash</span> <span class="number">4</span></span><br><span class="line"><span class="string">awk</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><h4 id="Sort-value-ascend"><a href="#Sort-value-ascend" class="headerlink" title="Sort value (ascend)"></a>Sort value (ascend)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/awk -f</span><br><span class="line">&#123; </span><br><span class="line">a[$<span class="number">1</span>]=$<span class="number">2</span></span><br><span class="line">PROCINFO[<span class="string">&quot;sorted_in&quot;</span>] = <span class="string">&quot;@val_num_asc&quot;</span></span><br><span class="line">&#125; </span><br><span class="line">END &#123;</span><br><span class="line"><span class="keyword">for</span> (i in a) &#123;</span><br><span class="line"><span class="built_in">print</span> i, a[i]</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>output</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/tmp/awkscript</span> <span class="string">file</span></span><br><span class="line"><span class="string">test</span> <span class="number">1</span></span><br><span class="line"><span class="string">zest</span> <span class="number">2</span></span><br><span class="line"><span class="string">hero</span> <span class="number">3</span></span><br><span class="line"><span class="string">awk</span> <span class="number">3</span></span><br><span class="line"><span class="string">flash</span> <span class="number">4</span></span><br><span class="line"><span class="string">status</span> <span class="number">4</span></span><br><span class="line"><span class="string">innovation</span> <span class="number">10</span></span><br><span class="line"><span class="string">port</span> <span class="number">12</span></span><br></pre></td></tr></table></figure><p>@unsorted<br>Array elements are processed in arbitrary order, which is the default awk behavior.</p><p>@ind_str_asc<br>Order by indices in ascending order compared as strings; this is the most basic sort. (Internally, array indices are always strings, so with a[2*5] = 1 the index is 10 rather than numeric 10.)</p><p>@ind_num_asc<br>Order by indices in ascending order but force them to be treated as numbers in the process. Any index with a non-numeric value will end up positioned as if it were zero.</p><p>@val_type_asc<br>Order by element values in ascending order (rather than by indices). Ordering is by the type assigned to the element (see Typing and Comparison). All numeric values come before all string values, which in turn come before all subarrays. (Subarrays have not been described yet; see Arrays of Arrays.)</p><p>@val_str_asc<br>Order by element values in ascending order (rather than by indices). Scalar values are compared as strings. Subarrays, if present, come out last.</p><p>@val_num_asc<br>Order by element values in ascending order (rather than by indices). Scalar values are compared as numbers. Subarrays, if present, come out last. When numeric values are equal, the string values are used to provide an ordering: this guarantees consistent results across different versions of the C qsort() function,42 which gawk uses internally to perform the sorting.</p><p>@ind_str_desc<br>Like @ind_str_asc, but the string indices are ordered from high to low.</p><p>@ind_num_desc<br>Like @ind_num_asc, but the numeric indices are ordered from high to low.</p><p>@val_type_desc<br>Like @val_type_asc, but the element values, based on type, are ordered from high to low. Subarrays, if present, come out first.</p><p>@val_str_desc<br>Like @val_str_asc, but the element values, treated as strings, are ordered from high to low. Subarrays, if present, come out first.</p><p>@val_num_desc<br>Like @val_num_asc, but the element values, treated as numbers, are ordered from high to low. Subarrays, if present, come out first.</p><h4 id="Found-2-files-diff"><a href="#Found-2-files-diff" class="headerlink" title="Found 2 files diff"></a>Found 2 files diff</h4><p>Because grep -wvf need too many memory</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;NR==FNR&#123;a[$0]=$0&#125;; NR&gt;FNR&#123;b[$0]=$0&#125; END&#123;for (i in a) &#123;if(a[i]!=b[i]) &#123;print i&#125;&#125;&#125;&#x27;</span>  file1 file2</span><br></pre></td></tr></table></figure><h4 id="match-ip-addr"><a href="#match-ip-addr" class="headerlink" title="match ip addr"></a>match ip addr</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$0</span>~/[0-9]&#123;1,3&#125;.[0-9]&#123;1,3&#125;.[0-9]&#123;1,3&#125;.[0-9]&#123;1,3&#125;/</span><br></pre></td></tr></table></figure><p><a href="https://www.gnu.org/software/gawk/manual/html_node/Controlling-Scanning.html">gawk reference</a><br><a href="http://stackoverflow.com/questions/5342782/sort-associative-array-with-awk">stackoverflow reference</a></p>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> awk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Blktrace</title>
      <link href="2016/04/01/blktrace/"/>
      <url>2016/04/01/blktrace/</url>
      
        <content type="html"><![CDATA[<p>OS version :CentOS 7.2<br>It s a good tool for trace hot block in your block device</p><a id="more"></a><h3 id="Trace-your-IO-operation"><a href="#Trace-your-IO-operation" class="headerlink" title="Trace your IO operation"></a>Trace your IO operation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install blktrace</span><br><span class="line">$ mount -t debugfs debugfs /sys/kernel/debug</span><br><span class="line"></span><br><span class="line">$ mount  | grep sdb1</span><br><span class="line">/dev/sdb1 on /<span class="built_in">local</span>/sdb <span class="built_in">type</span> ext4 (rw,noatime,stripe=128,data=ordered)</span><br><span class="line"></span><br><span class="line"><span class="comment"># With Ordered Mode, journal commits are deferred until the data blocks get written to disk. This guarantees that any blocks in the file will be data written by the application, avoiding a possibility of a security breach</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The path mapping to /dev/sdb1</span></span><br><span class="line">$ <span class="built_in">echo</span> 234 &gt; 234</span><br><span class="line"></span><br><span class="line">Sometimes ,the data is not write to block first</span><br><span class="line">$  cat /tmp/blktrace  | grep A</span><br><span class="line">  8,16   6        1     0.000000000  3487  A   W 276480 + 8 &lt;- (8,17) <span class="string">&quot;274432&quot;</span></span><br><span class="line">  8,16   6       10     0.000224890 21268  A FWFS 1422142464 + 8 &lt;- (8,17) 1422140416</span><br><span class="line">  8,16   8        1     0.000070650 21268  A  WS 1422142416 + 8 &lt;- (8,17) 1422140368</span><br><span class="line">  8,16   8        5     0.000075917 21268  A  WS 1422142424 + 8 &lt;- (8,17) 1422140376</span><br><span class="line">  8,16   8        8     0.000078252 21268  A  WS 1422142432 + 8 &lt;- (8,17) 1422140384</span><br><span class="line">  8,16   8       11     0.000079337 21268  A  WS 1422142440 + 8 &lt;- (8,17) 1422140392</span><br><span class="line">  8,16   8       14     0.000080280 21268  A  WS 1422142448 + 8 &lt;- (8,17) 1422140400</span><br><span class="line">  8,16   8       17     0.000081320 21268  A  WS 1422142456 + 8 &lt;- (8,17) 1422140408</span><br><span class="line">  8,16   8       23     5.007945786  3487  A  WM 2056 + 8 &lt;- (8,17) 8</span><br><span class="line">  8,16   8       27     5.007958153  3487  A  WM 11616 + 8 &lt;- (8,17) 9568</span><br><span class="line">  8,16   8       30     5.007961458  3487  A  WM 11736 + 8 &lt;- (8,17) 9688</span><br><span class="line">  8,16   8       33     5.007964866  3487  A  WM 11864 + 8 &lt;- (8,17) 9816</span><br><span class="line">  8,16   8       36     5.007967773  3487  A  WM 77400 + 8 &lt;- (8,17) 75352</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">&quot;icheck <span class="subst">$((274432/8)</span>)&quot;</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">BlockInode number</span><br><span class="line">3430415</span><br><span class="line"></span><br><span class="line">$ ls -li</span><br><span class="line">15 -rw-r--r-- 1 root root     4 Apr 1 04:44 234</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">&quot;ncheck 15&quot;</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">InodePathname</span><br><span class="line">15//234</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">&quot;icheck <span class="subst">$((1422140416/8)</span>)&quot;</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">BlockInode number</span><br><span class="line">1777675528</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">&quot;ncheck 8&quot;</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">InodePathname</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#Journal_.28jbd2.29">The journal inode is typically inode 8. The first 68 bytes of the journal inode are replicated in the ext4 superblock. The journal itself is normal (but hidden) file within the filesystem. The file usually consumes an entire block group, though mke2fs tries to put it in the middle of the disk</a></p><h3 id="Another-example-full-ouput"><a href="#Another-example-full-ouput" class="headerlink" title="Another example full ouput"></a>Another example full ouput</h3><p>Here is output of my home PC (ubuntu 15.10)<br>Only write small file (dd if=/dev/zero of=/mnt/test bs=512 count=2)</p><h4 id="oflag-sync"><a href="#oflag-sync" class="headerlink" title="oflag=sync"></a>oflag=sync</h4><p>write journal, and then write data, hdd return, not wait a second</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>      <span class="number">159</span>   <span class="number">689.878265367</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454552</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452504</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">160</span>   <span class="number">689.878266393</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454552</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">161</span>   <span class="number">689.878268169</span>  <span class="number">8177  </span><span class="string">G</span>  <span class="string">WS</span> <span class="number">155454552</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">162</span>   <span class="number">689.878268655</span>  <span class="number">8177  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>      <span class="number">163</span>   <span class="number">689.878269447</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454560</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452512</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">164</span>   <span class="number">689.878269657</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454560</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">165</span>   <span class="number">689.878270524</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454560</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>      <span class="number">166</span>   <span class="number">689.878271142</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454568</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452520</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">167</span>   <span class="number">689.878271349</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454568</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">168</span>   <span class="number">689.878271577</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454568</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>      <span class="number">169</span>   <span class="number">689.878272006</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454576</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452528</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">170</span>   <span class="number">689.878272213</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454576</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">171</span>   <span class="number">689.878272441</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454576</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>      <span class="number">172</span>   <span class="number">689.878272828</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454584</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452536</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">173</span>   <span class="number">689.878273026</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454584</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">174</span>   <span class="number">689.878273248</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454584</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>      <span class="number">175</span>   <span class="number">689.878273587</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454592</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452544</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">176</span>   <span class="number">689.878273791</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454592</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">177</span>   <span class="number">689.878274019</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454592</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">178</span>   <span class="number">689.878274829</span>  <span class="number">8177  </span><span class="string">I</span>  <span class="string">WS</span> <span class="number">155454552</span> <span class="string">+</span> <span class="number">48</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">179</span>   <span class="number">689.878275333</span>  <span class="number">8177  </span><span class="string">U</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>] <span class="number">1</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">180</span>   <span class="number">689.878275999</span>  <span class="number">8177  </span><span class="string">D</span>  <span class="string">WS</span> <span class="number">155454552</span> <span class="string">+</span> <span class="number">48</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">181</span>   <span class="number">689.878535778</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155454552</span> <span class="string">+</span> <span class="number">48</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>      <span class="number">182</span>   <span class="number">689.878551480</span>  <span class="number">8177  </span><span class="string">A</span> <span class="string">FWFS</span> <span class="number">155454600</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452552</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">183</span>   <span class="number">689.878551816</span>  <span class="number">8177  </span><span class="string">Q</span> <span class="string">FWFS</span> <span class="number">155454600</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">184</span>   <span class="number">689.878552509</span>  <span class="number">8177  </span><span class="string">G</span> <span class="string">FWFS</span> <span class="number">155454600</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">185</span>   <span class="number">689.878553118</span>  <span class="number">8177  </span><span class="string">I</span> <span class="string">FWFS</span> <span class="number">155454600</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>      <span class="number">194</span>   <span class="number">689.878014170</span>  <span class="number">9030  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">276520</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">274472</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">195</span>   <span class="number">689.878016897</span>  <span class="number">9030  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">276520</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">dd</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">196</span>   <span class="number">689.878020143</span>  <span class="number">9030  </span><span class="string">G</span>  <span class="string">WS</span> <span class="number">276520</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">dd</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">197</span>   <span class="number">689.878021181</span>  <span class="number">9030  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">dd</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">198</span>   <span class="number">689.878022921</span>  <span class="number">9030  </span><span class="string">I</span>  <span class="string">WS</span> <span class="number">276520</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">dd</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">199</span>   <span class="number">689.878023761</span>  <span class="number">9030  </span><span class="string">U</span>   <span class="string">N</span> [<span class="string">dd</span>] <span class="number">1</span></span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">200</span>   <span class="number">689.878025114</span>  <span class="number">9030  </span><span class="string">D</span>  <span class="string">WS</span> <span class="number">276520</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">dd</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">201</span>   <span class="number">689.878227087</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">276520</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">235</span>   <span class="number">689.929054795</span>     <span class="number">0</span>  <span class="string">D</span>  <span class="string">WS</span> <span class="number">155454600</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">swapper/2</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">236</span>   <span class="number">689.953664402</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155454600</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>      <span class="number">186</span>   <span class="number">689.929232481</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155454600</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">42</span>   <span class="number">716.440898596</span>  <span class="number">7824  </span><span class="string">G</span>   <span class="string">N</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">43</span>   <span class="number">716.440899622</span>  <span class="number">7824  </span><span class="string">I</span>   <span class="string">N</span> <span class="number">0</span> <span class="string">(00</span> <span class="string">..)</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">44</span>   <span class="number">716.440900483</span>  <span class="number">7824  </span><span class="string">D</span>   <span class="string">N</span> <span class="number">0</span> <span class="string">(00</span> <span class="string">..)</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line"><span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">45</span>   <span class="number">716.440915785</span>     <span class="number">3</span>  <span class="string">C</span>   <span class="string">N</span> <span class="string">(00</span> <span class="string">..)</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure><h4 id="oflag-direct"><a href="#oflag-direct" class="headerlink" title="oflag=direct"></a>oflag=direct</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">write</span> <span class="string">data</span> <span class="string">first</span> <span class="string">&quot;278560&quot;</span></span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">0</span>       <span class="number">71</span>   <span class="number">924.643982410</span>  <span class="number">9092  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">280608</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="string">&quot;278560&quot;</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">72</span>   <span class="number">924.643984999</span>  <span class="number">9092  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">280608</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">dd</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">73</span>   <span class="number">924.643988437</span>  <span class="number">9092  </span><span class="string">G</span>  <span class="string">WS</span> <span class="number">280608</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">dd</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">74</span>   <span class="number">924.643989544</span>  <span class="number">9092  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">dd</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">75</span>   <span class="number">924.643991242</span>  <span class="number">9092  </span><span class="string">I</span>  <span class="string">WS</span> <span class="number">280608</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">dd</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">76</span>   <span class="number">924.643992202</span>  <span class="number">9092 </span><span class="string">UT</span>   <span class="string">N</span> [<span class="string">dd</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">77</span>   <span class="number">924.644003671</span>   <span class="number">113</span>  <span class="string">D</span>  <span class="string">WS</span> <span class="number">280608</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/0:1H</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">78</span>   <span class="number">924.644187239</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">280608</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="string">wait</span> <span class="number">5</span> <span class="string">seconds</span> <span class="string">...</span> <span class="string">because</span> <span class="string">commit</span> <span class="string">=</span> <span class="number">5</span> <span class="string">(default</span> <span class="string">value)</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">216</span>   <span class="number">929.750636556</span>     <span class="number">0</span>  <span class="string">D</span>  <span class="string">WS</span> <span class="number">155454648</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">swapper/2</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">1</span>      <span class="number">300</span>   <span class="number">929.725647290</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454608</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452560</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">301</span>   <span class="number">929.725648586</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454608</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">302</span>   <span class="number">929.725651343</span>  <span class="number">8177  </span><span class="string">G</span>  <span class="string">WS</span> <span class="number">155454608</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">303</span>   <span class="number">929.725651976</span>  <span class="number">8177  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">1</span>      <span class="number">304</span>   <span class="number">929.725653017</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454616</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452568</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">305</span>   <span class="number">929.725653281</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454616</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">306</span>   <span class="number">929.725654121</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454616</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">1</span>      <span class="number">307</span>   <span class="number">929.725655039</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454624</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452576</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">308</span>   <span class="number">929.725655246</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454624</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">309</span>   <span class="number">929.725655474</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454624</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">1</span>      <span class="number">310</span>   <span class="number">929.725655948</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454632</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452584</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">311</span>   <span class="number">929.725656326</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454632</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">312</span>   <span class="number">929.725656644</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454632</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">1</span>      <span class="number">313</span>   <span class="number">929.725657046</span>  <span class="number">8177  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155454640</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452592</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">314</span>   <span class="number">929.725657247</span>  <span class="number">8177  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155454640</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">315</span>   <span class="number">929.725657469</span>  <span class="number">8177  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155454640</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">316</span>   <span class="number">929.725658477</span>  <span class="number">8177  </span><span class="string">I</span>  <span class="string">WS</span> <span class="number">155454608</span> <span class="string">+</span> <span class="number">40</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">317</span>   <span class="number">929.725659326</span>  <span class="number">8177  </span><span class="string">U</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">318</span>   <span class="number">929.725660286</span>  <span class="number">8177  </span><span class="string">D</span>  <span class="string">WS</span> <span class="number">155454608</span> <span class="string">+</span> <span class="number">40</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">319</span>   <span class="number">929.725919352</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155454608</span> <span class="string">+</span> <span class="number">40</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">1</span>      <span class="number">320</span>   <span class="number">929.725936739</span>  <span class="number">8177  </span><span class="string">A</span> <span class="string">FWFS</span> <span class="number">155454648</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155452600</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">321</span>   <span class="number">929.725937087</span>  <span class="number">8177  </span><span class="string">Q</span> <span class="string">FWFS</span> <span class="number">155454648</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">322</span>   <span class="number">929.725937786</span>  <span class="number">8177  </span><span class="string">G</span> <span class="string">FWFS</span> <span class="number">155454648</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">323</span>   <span class="number">929.725938398</span>  <span class="number">8177  </span><span class="string">I</span> <span class="string">FWFS</span> <span class="number">155454648</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>      <span class="number">324</span>   <span class="number">929.750809777</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155454648</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>      <span class="number">217</span>   <span class="number">929.759034117</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155454648</span> [<span class="number">0</span>]</span><br><span class="line"><span class="string">wait</span> <span class="string">15s</span> <span class="string">or</span> <span class="string">20s</span> <span class="string">...</span> <span class="string">Does</span> <span class="string">it</span> <span class="string">dirty_expire_centisecs</span> <span class="string">=</span> <span class="number">1500</span> <span class="string">?</span></span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">0</span>       <span class="number">79</span>   <span class="number">954.641636276</span>  <span class="number">8780  </span><span class="string">A</span>   <span class="string">W</span> <span class="number">2048</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">0</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">80</span>   <span class="number">954.641637644</span>  <span class="number">8780  </span><span class="string">Q</span>   <span class="string">W</span> <span class="number">2048</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">81</span>   <span class="number">954.641641085</span>  <span class="number">8780  </span><span class="string">G</span>   <span class="string">W</span> <span class="number">2048</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">82</span>   <span class="number">954.641642087</span>  <span class="number">8780  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">0</span>       <span class="number">83</span>   <span class="number">954.641644262</span>  <span class="number">8780  </span><span class="string">A</span>  <span class="string">WM</span> <span class="number">2056</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">8</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">84</span>   <span class="number">954.641644472</span>  <span class="number">8780  </span><span class="string">Q</span>  <span class="string">WM</span> <span class="number">2056</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">85</span>   <span class="number">954.641645486</span>  <span class="number">8780  </span><span class="string">M</span>  <span class="string">WM</span> <span class="number">2056</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">0</span>       <span class="number">86</span>   <span class="number">954.641647064</span>  <span class="number">8780  </span><span class="string">A</span>  <span class="string">WM</span> <span class="number">10256</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">8208</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">87</span>   <span class="number">954.641647274</span>  <span class="number">8780  </span><span class="string">Q</span>  <span class="string">WM</span> <span class="number">10256</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">88</span>   <span class="number">954.641648009</span>  <span class="number">8780  </span><span class="string">G</span>  <span class="string">WM</span> <span class="number">10256</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">0</span>       <span class="number">89</span>   <span class="number">954.641649608</span>  <span class="number">8780  </span><span class="string">A</span>  <span class="string">WM</span> <span class="number">10504</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">8456</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">90</span>   <span class="number">954.641649809</span>  <span class="number">8780  </span><span class="string">Q</span>  <span class="string">WM</span> <span class="number">10504</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">91</span>   <span class="number">954.641650430</span>  <span class="number">8780  </span><span class="string">G</span>  <span class="string">WM</span> <span class="number">10504</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">92</span>   <span class="number">954.641652170</span>  <span class="number">8780  </span><span class="string">I</span>   <span class="string">W</span> <span class="number">2048</span> <span class="string">+</span> <span class="number">16</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">93</span>   <span class="number">954.641652974</span>  <span class="number">8780  </span><span class="string">I</span>  <span class="string">WM</span> <span class="number">10256</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">94</span>   <span class="number">954.641653406</span>  <span class="number">8780  </span><span class="string">I</span>  <span class="string">WM</span> <span class="number">10504</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">95</span>   <span class="number">954.641653775</span>  <span class="number">8780  </span><span class="string">U</span>   <span class="string">N</span> [<span class="string">kworker/u8:1</span>] <span class="number">3</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">96</span>   <span class="number">954.641655053</span>  <span class="number">8780  </span><span class="string">D</span>   <span class="string">W</span> <span class="number">2048</span> <span class="string">+</span> <span class="number">16</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">97</span>   <span class="number">954.641708392</span>  <span class="number">8780  </span><span class="string">D</span>  <span class="string">WM</span> <span class="number">10256</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">98</span>   <span class="number">954.641895755</span>     <span class="number">0</span>  <span class="string">C</span>   <span class="string">W</span> <span class="number">2048</span> <span class="string">+</span> <span class="number">16</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>       <span class="number">99</span>   <span class="number">954.641947709</span>     <span class="number">0</span>  <span class="string">D</span>  <span class="string">WM</span> <span class="number">10504</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">swapper/2</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>      <span class="number">100</span>   <span class="number">954.642066976</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WM</span> <span class="number">10256</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>      <span class="number">101</span>   <span class="number">954.642239705</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WM</span> <span class="number">10504</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure><h4 id="no-oflag"><a href="#no-oflag" class="headerlink" title="no oflag"></a>no oflag</h4><p>There are a lot of different wait time in this situation<br>Because this situation is the most complex</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">wait</span> <span class="string">5s..</span></span><br><span class="line"> <span class="number">8</span><span class="string">,33</span>   <span class="number">1</span>       <span class="number">29</span>    <span class="number">82.996414180</span>     <span class="number">0</span>  <span class="string">D</span>  <span class="string">WS</span> <span class="number">155453784</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">swapper/1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">51</span>    <span class="number">82.975991741</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453736</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451688</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">52</span>    <span class="number">82.975993076</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453736</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">53</span>    <span class="number">82.975997048</span>  <span class="number">9859  </span><span class="string">G</span>  <span class="string">WS</span> <span class="number">155453736</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">54</span>    <span class="number">82.975998182</span>  <span class="number">9859  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">55</span>    <span class="number">82.975999169</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453744</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451696</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">56</span>    <span class="number">82.975999367</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453744</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">57</span>    <span class="number">82.976000324</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453744</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">58</span>    <span class="number">82.976000804</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453752</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451704</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">59</span>    <span class="number">82.976001005</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453752</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">60</span>    <span class="number">82.976001239</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453752</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">61</span>    <span class="number">82.976001674</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453760</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451712</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">62</span>    <span class="number">82.976001872</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453760</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">63</span>    <span class="number">82.976002097</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453760</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">64</span>    <span class="number">82.976002487</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453768</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451720</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">65</span>    <span class="number">82.976002688</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453768</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">66</span>    <span class="number">82.976002913</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453768</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">67</span>    <span class="number">82.976003279</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453776</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451728</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">68</span>    <span class="number">82.976003474</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453776</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">69</span>    <span class="number">82.976003696</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453776</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">70</span>    <span class="number">82.976004914</span>  <span class="number">9859  </span><span class="string">I</span>  <span class="string">WS</span> <span class="number">155453736</span> <span class="string">+</span> <span class="number">48</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">71</span>    <span class="number">82.976005793</span>  <span class="number">9859  </span><span class="string">U</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">72</span>    <span class="number">82.976006999</span>  <span class="number">9859  </span><span class="string">D</span>  <span class="string">WS</span> <span class="number">155453736</span> <span class="string">+</span> <span class="number">48</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">73</span>    <span class="number">82.976309138</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155453736</span> <span class="string">+</span> <span class="number">48</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">74</span>    <span class="number">82.976328284</span>  <span class="number">9859  </span><span class="string">A</span> <span class="string">FWFS</span> <span class="number">155453784</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451736</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">75</span>    <span class="number">82.976328662</span>  <span class="number">9859  </span><span class="string">Q</span> <span class="string">FWFS</span> <span class="number">155453784</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">76</span>    <span class="number">82.976329421</span>  <span class="number">9859  </span><span class="string">G</span> <span class="string">FWFS</span> <span class="number">155453784</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">77</span>    <span class="number">82.976330021</span>  <span class="number">9859  </span><span class="string">I</span> <span class="string">FWFS</span> <span class="number">155453784</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">78</span>    <span class="number">82.996586831</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155453784</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>        <span class="number">3</span>    <span class="number">83.004773614</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155453784</span> [<span class="number">0</span>]</span><br><span class="line"><span class="string">wait</span> <span class="string">8s</span></span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">3</span>       <span class="number">79</span>    <span class="number">92.668012660</span>  <span class="number">9646  </span><span class="string">A</span>   <span class="string">W</span> <span class="number">272424</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">270376</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">80</span>    <span class="number">92.668014142</span>  <span class="number">9646  </span><span class="string">Q</span>   <span class="string">W</span> <span class="number">272424</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">81</span>    <span class="number">92.668017571</span>  <span class="number">9646  </span><span class="string">G</span>   <span class="string">W</span> <span class="number">272424</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">82</span>    <span class="number">92.668018489</span>  <span class="number">9646  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">83</span>    <span class="number">92.668021330</span>  <span class="number">9646  </span><span class="string">I</span>   <span class="string">W</span> <span class="number">272424</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">84</span>    <span class="number">92.668022206</span>  <span class="number">9646  </span><span class="string">U</span>   <span class="string">N</span> [<span class="string">kworker/u8:0</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">85</span>    <span class="number">92.668023601</span>  <span class="number">9646  </span><span class="string">D</span>   <span class="string">W</span> <span class="number">272424</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">kworker/u8:0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">3</span>       <span class="number">86</span>    <span class="number">92.668207032</span>     <span class="number">0</span>  <span class="string">C</span>   <span class="string">W</span> <span class="number">272424</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="string">wait</span> <span class="string">5s</span></span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>       <span class="number">23</span>    <span class="number">97.967994525</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453792</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451744</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">24</span>    <span class="number">97.967996184</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453792</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">25</span>    <span class="number">97.967999937</span>  <span class="number">9859  </span><span class="string">G</span>  <span class="string">WS</span> <span class="number">155453792</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">26</span>    <span class="number">97.968001062</span>  <span class="number">9859  </span><span class="string">P</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>       <span class="number">27</span>    <span class="number">97.968002124</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453800</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451752</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">28</span>    <span class="number">97.968002415</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453800</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">29</span>    <span class="number">97.968003315</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453800</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>       <span class="number">30</span>    <span class="number">97.968003888</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453808</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451760</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">31</span>    <span class="number">97.968004092</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453808</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">32</span>    <span class="number">97.968004323</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453808</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>       <span class="number">33</span>    <span class="number">97.968004722</span>  <span class="number">9859  </span><span class="string">A</span>  <span class="string">WS</span> <span class="number">155453816</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451768</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">34</span>    <span class="number">97.968004923</span>  <span class="number">9859  </span><span class="string">Q</span>  <span class="string">WS</span> <span class="number">155453816</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">35</span>    <span class="number">97.968005148</span>  <span class="number">9859  </span><span class="string">M</span>  <span class="string">WS</span> <span class="number">155453816</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">36</span>    <span class="number">97.968006597</span>  <span class="number">9859  </span><span class="string">I</span>  <span class="string">WS</span> <span class="number">155453792</span> <span class="string">+</span> <span class="number">32</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">37</span>    <span class="number">97.968007347</span>  <span class="number">9859  </span><span class="string">U</span>   <span class="string">N</span> [<span class="string">jbd2/sdc1-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">38</span>    <span class="number">97.968008571</span>  <span class="number">9859  </span><span class="string">D</span>  <span class="string">WS</span> <span class="number">155453792</span> <span class="string">+</span> <span class="number">32</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">39</span>    <span class="number">97.968260397</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155453792</span> <span class="string">+</span> <span class="number">32</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,32</span>   <span class="number">2</span>       <span class="number">40</span>    <span class="number">97.968278433</span>  <span class="number">9859  </span><span class="string">A</span> <span class="string">FWFS</span> <span class="number">155453824</span> <span class="string">+</span> <span class="number">8</span> <span class="string">&lt;-</span> <span class="string">(8,33)</span> <span class="number">155451776</span></span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">41</span>    <span class="number">97.968278814</span>  <span class="number">9859  </span><span class="string">Q</span> <span class="string">FWFS</span> <span class="number">155453824</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">42</span>    <span class="number">97.968279507</span>  <span class="number">9859  </span><span class="string">G</span> <span class="string">FWFS</span> <span class="number">155453824</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">43</span>    <span class="number">97.968280119</span>  <span class="number">9859  </span><span class="string">I</span> <span class="string">FWFS</span> <span class="number">155453824</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">jbd2/sdc1-8</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>        <span class="number">4</span>    <span class="number">97.987635609</span>     <span class="number">0</span>  <span class="string">D</span>  <span class="string">WS</span> <span class="number">155453824</span> <span class="string">+</span> <span class="number">8</span> [<span class="string">swapper/1</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">0</span>        <span class="number">5</span>    <span class="number">97.996024470</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155453824</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span><span class="string">,33</span>   <span class="number">2</span>       <span class="number">44</span>    <span class="number">97.987810139</span>     <span class="number">0</span>  <span class="string">C</span>  <span class="string">WS</span> <span class="number">155453824</span> <span class="string">+</span> <span class="number">8</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure><h3 id="btt-show-IO-status"><a href="#btt-show-IO-status" class="headerlink" title="btt show IO status"></a>btt show IO status</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ blktrace -w <span class="number">120</span> -d /dev/sdb</span><br><span class="line">$ blkparse -<span class="selector-tag">i</span> sdb -d blkparse.out</span><br><span class="line">$ btt -<span class="selector-tag">i</span> blkparse.out</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Q2Q  time between requests sent to the block layer<br>Q2G  time from a block I/O is queued to the time it gets a request allocated for it<br>G2I  time from a request is allocated to the time it is Inserted into the devices queue<br>Q2M  time from a block I/O is queued to the time it gets merged with an existing request<br>I2D  time from a request is inserted into the devices queue to the time it is actually issued to the device<br>M2D  time from a block I/O is merged with an exiting request until the request is issued to the device<br>D2C  service time of the request by the device<br>Q2C  total time spent in the block layer for request<br>Q2I  time it takes to process an I/O prior to it being inserted or merged onto a request queue  Includes split, and remap time<br>I2D  time the I/O is idle on the request queue<br>D2C  time the I/O is active in the driver and on the device<br>Q2I + I2D + D2C = Q2C<br>Q2C: Total processing time of the I/O </p><table><thead><tr><th align="center">Action</th><th align="center">Linux block tracepoints</th><th align="center">Kernel trace function</th><th align="center">perf impact</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">Q</td><td align="center">block:block_bio_queue</td><td align="center">trace_block_bio_queue</td><td align="center">Neutral</td><td align="center">Intent to queue a bio on a given reqeust_queue. No real requests exists yet.</td></tr><tr><td align="center">B</td><td align="center">block:block_bio_bounce</td><td align="center">trace_block_bio_bounce</td><td align="center">Negative</td><td align="center">Pages in bio has copied to bounce buffer to avoid hardware (DMA) limits.</td></tr><tr><td align="center">X</td><td align="center">block:block_split</td><td align="center">trace_block_split</td><td align="center">Negative</td><td align="center">Split a bio with smaller pieces due to underlying block devices limits.</td></tr><tr><td align="center">M</td><td align="center">block:block_bio_backmerge</td><td align="center">trace_block_bio_backmerge</td><td align="center">Positive</td><td align="center">A previously inserted request exists that ends on the boundary of where this bio begins, so IO scheduler merges them.</td></tr><tr><td align="center">F</td><td align="center">block:block_bio_frontmerge</td><td align="center">trace_block_bio_frontmerge</td><td align="center">Positive</td><td align="center">Same as the back merge, except this i/o ends where a previously inserted requests starts.</td></tr><tr><td align="center">S</td><td align="center">block:block_sleeprq</td><td align="center">trace_block_sleeprq</td><td align="center">Negative</td><td align="center">No available request structures were available (eg. memory pressure), so the issuer has to wait for one to be freed.</td></tr><tr><td align="center">G</td><td align="center">block:block_getrq</td><td align="center">trace_block_getrq</td><td align="center">Neutral</td><td align="center">Allocated a free request struct successfully.</td></tr><tr><td align="center">P</td><td align="center">block:block_plug</td><td align="center">trace_block_plug</td><td align="center">Positive</td><td align="center">I/O isnt immediately dispatched to request_queue, instead it is held back by current process IO plug list.</td></tr><tr><td align="center">I</td><td align="center">block:block_rq_insert</td><td align="center">trace_block_rq_insert</td><td align="center">Neutral</td><td align="center">A request is sent to the IO scheduler internal queue and later service by the driver.</td></tr><tr><td align="center">U</td><td align="center">block:block_unplug</td><td align="center">trace_block_unplug</td><td align="center">Positive</td><td align="center">Flush queued IO request to device request_queue, could be triggered by timeout or intentionally function call.</td></tr><tr><td align="center">A</td><td align="center">block:block_rq_remap</td><td align="center">trace_block_rq_remap</td><td align="center">Neutral</td><td align="center">Only used by stackable devices, for example, DM(Device Mapper) and raid driver.</td></tr><tr><td align="center">D</td><td align="center">block:block_rq_issue</td><td align="center">trace_block_rq_issue</td><td align="center">Neutral</td><td align="center">Device driver code is picking up the request</td></tr><tr><td align="center">C</td><td align="center">block:block_rq_complete</td><td align="center">trace_block_rq_complete</td><td align="center">Neutral</td><td align="center">A previously issued request has been completed. The output will detail the sector and size of that request.</td></tr></tbody></table><h3 id="An-issue-in-product-env"><a href="#An-issue-in-product-env" class="headerlink" title="An issue in product env"></a>An issue in product env</h3><h4 id="HDD-type"><a href="#HDD-type" class="headerlink" title="HDD type"></a>HDD type</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[xx:0:xx:0]  disk    HGST     HUH721010AL5200  LS14  /dev/sda  35000xxxxxxx  /dev/sgxx</span><br><span class="line">[xx:0:xx:0] disk    SEAGATE  ST10000NM0256    TT54  /dev/sdf  35000xxxxxxx  /dev/sgxxx</span><br></pre></td></tr></table></figure><p>blktrace trace the hdd (300s)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ blkparse -i ./sdf.blktrace.* &gt; seagate.log <span class="comment">#all cores </span></span><br><span class="line">$ blkparse -i ./sda.blktrace.* &gt; hgst.log <span class="comment">#all cores</span></span><br></pre></td></tr></table></figure><p>Use bash filter and find the large latency (this line time - previous line time &gt; 0.3 sec)</p><h5 id="Seagate-48-x-events-large-than-0-3-sec-21-x-events-large-than-0-5-sec"><a href="#Seagate-48-x-events-large-than-0-3-sec-21-x-events-large-than-0-5-sec" class="headerlink" title="Seagate, 48 x events large than 0.3 sec, 21 x events large than 0.5 sec"></a>Seagate, 48 x events large than 0.3 sec, 21 x events large than 0.5 sec</h5><p>Each thrid line to fourth line was the time gap<br>You can see the seagate HDD take a lot time on <code>D</code> state (20/21)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line">130,96   1    30785   243.393714438 48181  D   W 2558 + 2 [z_null_iss]</span><br><span class="line">130,96   1    30785   243.393714438 48181  D   W 2558 + 2 [z_null_iss]</span><br><span class="line">130,96   1    30785   243.393714438 48181  D   W 2558 + 2 [z_null_iss]</span><br><span class="line">130,96   1    30786   244.172414757     0  C WFS 0 [0]</span><br><span class="line">130,96   1    30786   244.172414757     0  C WFS 0 [0]</span><br><span class="line">130,96   1    30786   244.172414757     0  C WFS 0 [0]</span><br><span class="line">130,96   1    30786   244.172414757     0  C WFS 0 [0]</span><br><span class="line">130,96   1    30786   244.172414757     0  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   7    21451   146.872758186 87622  D   R 3653650721 + 108 [ll_ost_io03_018]</span><br><span class="line">130,96   7    21451   146.872758186 87622  D   R 3653650721 + 108 [ll_ost_io03_018]</span><br><span class="line">130,96   7    21451   146.872758186 87622  D   R 3653650721 + 108 [ll_ost_io03_018]</span><br><span class="line">130,96   3     4118   147.891160758 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     4118   147.891160758 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     4118   147.891160758 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     4118   147.891160758 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     4118   147.891160758 147577  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   2    24674   151.329670175 87569  D   R 7951802600 + 108 [(null)]</span><br><span class="line">130,96   2    24674   151.329670175 87569  D   R 7951802600 + 108 [(null)]</span><br><span class="line">130,96   2    24674   151.329670175 87569  D   R 7951802600 + 108 [(null)]</span><br><span class="line">130,96   8    22359   152.182596231     0  C WFS 0 [0]</span><br><span class="line">130,96   8    22359   152.182596231     0  C WFS 0 [0]</span><br><span class="line">130,96   8    22359   152.182596231     0  C WFS 0 [0]</span><br><span class="line">130,96   8    22359   152.182596231     0  C WFS 0 [0]</span><br><span class="line">130,96   8    22359   152.182596231     0  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   7    42796   298.142050420 87614  D   R 238031446 + 57 [ll_ost_io03_010]</span><br><span class="line">130,96   7    42796   298.142050420 87614  D   R 238031446 + 57 [ll_ost_io03_010]</span><br><span class="line">130,96   7    42796   298.142050420 87614  D   R 238031446 + 57 [ll_ost_io03_010]</span><br><span class="line">130,96   6    44523   299.349878100 143105  A   R 8685501173 + 1 &lt;- (130,97) 8685499125</span><br><span class="line">130,96   6    44523   299.349878100 143105  A   R 8685501173 + 1 &lt;- (130,97) 8685499125</span><br><span class="line">130,96   6    44523   299.349878100 143105  A   R 8685501173 + 1 &lt;- (130,97) 8685499125</span><br><span class="line">130,96   6    44523   299.349878100 143105  A   R 8685501173 + 1 &lt;- (130,97) 8685499125</span><br><span class="line">130,96   6    44523   299.349878100 143105  A   R 8685501173 + 1 &lt;- (130,97) 8685499125</span><br><span class="line">-----------</span><br><span class="line">130,96   4    34640   258.373105569 87591  D   R 5692654937 + 107 [ll_ost_io02_012]</span><br><span class="line">130,96   4    34640   258.373105569 87591  D   R 5692654937 + 107 [ll_ost_io02_012]</span><br><span class="line">130,96   4    34640   258.373105569 87591  D   R 5692654937 + 107 [ll_ost_io02_012]</span><br><span class="line">130,96   3     8379   259.499369944 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     8379   259.499369944 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     8379   259.499369944 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     8379   259.499369944 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     8379   259.499369944 147577  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   7    10985    63.488838666 87612  D   R 4322237860 + 27 [ll_ost_io03_008]</span><br><span class="line">130,96   7    10985    63.488838666 87612  D   R 4322237860 + 27 [ll_ost_io03_008]</span><br><span class="line">130,96   7    10985    63.488838666 87612  D   R 4322237860 + 27 [ll_ost_io03_008]</span><br><span class="line">130,96   3     1588    64.629129776 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     1588    64.629129776 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     1588    64.629129776 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     1588    64.629129776 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     1588    64.629129776 147577  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   7    23974   168.433788254 87471  D   R 2396376651 + 1 [(null)]</span><br><span class="line">130,96   7    23974   168.433788254 87471  D   R 2396376651 + 1 [(null)]</span><br><span class="line">130,96   7    23974   168.433788254 87471  D   R 2396376651 + 1 [(null)]</span><br><span class="line">130,96   1    20892   169.038841432     0  C WFS 0 [0]</span><br><span class="line">130,96   1    20892   169.038841432     0  C WFS 0 [0]</span><br><span class="line">130,96   1    20892   169.038841432     0  C WFS 0 [0]</span><br><span class="line">130,96   1    20892   169.038841432     0  C WFS 0 [0]</span><br><span class="line">130,96   1    20892   169.038841432     0  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   4    12146    96.379377128 87459  D   R 2348295332 + 1 [ll_ost02_015]</span><br><span class="line">130,96   4    12146    96.379377128 87459  D   R 2348295332 + 1 [ll_ost02_015]</span><br><span class="line">130,96   4    12146    96.379377128 87459  D   R 2348295332 + 1 [ll_ost02_015]</span><br><span class="line">130,96   8    16151    97.599999764     0  C WFS 0 [0]</span><br><span class="line">130,96   8    16151    97.599999764     0  C WFS 0 [0]</span><br><span class="line">130,96   8    16151    97.599999764     0  C WFS 0 [0]</span><br><span class="line">130,96   8    16151    97.599999764     0  C WFS 0 [0]</span><br><span class="line">130,96   8    16151    97.599999764     0  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   2    30441   173.328465157 87440  D   R 12542347594 + 1 [ll_ost01_021]</span><br><span class="line">130,96   2    30441   173.328465157 87440  D   R 12542347594 + 1 [ll_ost01_021]</span><br><span class="line">130,96   2    30441   173.328465157 87440  D   R 12542347594 + 1 [ll_ost01_021]</span><br><span class="line">130,96   7    24702   174.198459367 87478  A   R 12542314008 + 1 &lt;- (130,97) 12542311960</span><br><span class="line">130,96   7    24702   174.198459367 87478  A   R 12542314008 + 1 &lt;- (130,97) 12542311960</span><br><span class="line">130,96   7    24702   174.198459367 87478  A   R 12542314008 + 1 &lt;- (130,97) 12542311960</span><br><span class="line">130,96   7    24702   174.198459367 87478  A   R 12542314008 + 1 &lt;- (130,97) 12542311960</span><br><span class="line">130,96   7    24702   174.198459367 87478  A   R 12542314008 + 1 &lt;- (130,97) 12542311960</span><br><span class="line">-----------</span><br><span class="line">130,96   9    21343   135.990110875 87499  D   R 2440029371 + 1 [ll_ost04_005]</span><br><span class="line">130,96   9    21343   135.990110875 87499  D   R 2440029371 + 1 [ll_ost04_005]</span><br><span class="line">130,96   9    21343   135.990110875 87499  D   R 2440029371 + 1 [ll_ost04_005]</span><br><span class="line">130,96   8    20658   136.660377131     0  C WFS 0 [0]</span><br><span class="line">130,96   8    20658   136.660377131     0  C WFS 0 [0]</span><br><span class="line">130,96   8    20658   136.660377131     0  C WFS 0 [0]</span><br><span class="line">130,96   8    20658   136.660377131     0  C WFS 0 [0]</span><br><span class="line">130,96   8    20658   136.660377131     0  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   2    29657   167.263124418 87572  D   R 202932463 + 1 [ll_ost_io01_018]</span><br><span class="line">130,96   2    29657   167.263124418 87572  D   R 202932463 + 1 [ll_ost_io01_018]</span><br><span class="line">130,96   2    29657   167.263124418 87572  D   R 202932463 + 1 [ll_ost_io01_018]</span><br><span class="line">130,96   8    27412   167.765932347 87635  A   R 2348335413 + 1 &lt;- (130,97) 2348333365</span><br><span class="line">130,96   8    27412   167.765932347 87635  A   R 2348335413 + 1 &lt;- (130,97) 2348333365</span><br><span class="line">130,96   8    27412   167.765932347 87635  A   R 2348335413 + 1 &lt;- (130,97) 2348333365</span><br><span class="line">130,96   8    27412   167.765932347 87635  A   R 2348335413 + 1 &lt;- (130,97) 2348333365</span><br><span class="line">130,96   8    27412   167.765932347 87635  A   R 2348335413 + 1 &lt;- (130,97) 2348333365</span><br><span class="line">-----------</span><br><span class="line">130,96   1    13367   105.267420719 87531  D   R 7297704406 + 1 [ll_ost_io00_002]</span><br><span class="line">130,96   1    13367   105.267420719 87531  D   R 7297704406 + 1 [ll_ost_io00_002]</span><br><span class="line">130,96   1    13367   105.267420719 87531  D   R 7297704406 + 1 [ll_ost_io00_002]</span><br><span class="line">130,96   5    14469   106.509161772 330815  A   R 8197231910 + 1 &lt;- (130,97) 8197229862</span><br><span class="line">130,96   5    14469   106.509161772 330815  A   R 8197231910 + 1 &lt;- (130,97) 8197229862</span><br><span class="line">130,96   5    14469   106.509161772 330815  A   R 8197231910 + 1 &lt;- (130,97) 8197229862</span><br><span class="line">130,96   5    14469   106.509161772 330815  A   R 8197231910 + 1 &lt;- (130,97) 8197229862</span><br><span class="line">130,96   5    14469   106.509161772 330815  A   R 8197231910 + 1 &lt;- (130,97) 8197229862</span><br><span class="line">-----------</span><br><span class="line">130,96   2    21063   125.333146677 87556  D   R 18083827177 + 108 [ll_ost_io01_002]</span><br><span class="line">130,96   2    21063   125.333146677 87556  D   R 18083827177 + 108 [ll_ost_io01_002]</span><br><span class="line">130,96   2    21063   125.333146677 87556  D   R 18083827177 + 108 [ll_ost_io01_002]</span><br><span class="line">130,96   8    19879   126.221509126     0  C WFS 0 [0]</span><br><span class="line">130,96   8    19879   126.221509126     0  C WFS 0 [0]</span><br><span class="line">130,96   8    19879   126.221509126     0  C WFS 0 [0]</span><br><span class="line">130,96   8    19879   126.221509126     0  C WFS 0 [0]</span><br><span class="line">130,96   8    19879   126.221509126     0  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   6    15582    76.139188726 87626  D   R 2731293969 + 108 [ll_ost_io03_022]</span><br><span class="line">130,96   6    15582    76.139188726 87626  D   R 2731293969 + 108 [ll_ost_io03_022]</span><br><span class="line">130,96   6    15582    76.139188726 87626  D   R 2731293969 + 108 [ll_ost_io03_022]</span><br><span class="line">130,96   2    12415    76.979764136 305834  A   R 8297163033 + 1 &lt;- (130,97) 8297160985</span><br><span class="line">130,96   2    12415    76.979764136 305834  A   R 8297163033 + 1 &lt;- (130,97) 8297160985</span><br><span class="line">130,96   2    12415    76.979764136 305834  A   R 8297163033 + 1 &lt;- (130,97) 8297160985</span><br><span class="line">130,96   2    12415    76.979764136 305834  A   R 8297163033 + 1 &lt;- (130,97) 8297160985</span><br><span class="line">130,96   2    12415    76.979764136 305834  A   R 8297163033 + 1 &lt;- (130,97) 8297160985</span><br><span class="line">-----------</span><br><span class="line">130,96   7    13739    79.656890279 457428  D   R 13469591398 + 1 [(null)]</span><br><span class="line">130,96   7    13739    79.656890279 457428  D   R 13469591398 + 1 [(null)]</span><br><span class="line">130,96   7    13739    79.656890279 457428  D   R 13469591398 + 1 [(null)]</span><br><span class="line">130,96   3     2319    80.627393322 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     2319    80.627393322 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     2319    80.627393322 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     2319    80.627393322 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     2319    80.627393322 147577  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   0    15067   106.524627207 29874  D   R 13469658516 + 1 [ldlm_cn00_005]</span><br><span class="line">130,96   0    15067   106.524627207 29874  D   R 13469658516 + 1 [ldlm_cn00_005]</span><br><span class="line">130,96   0    15067   106.524627207 29874  D   R 13469658516 + 1 [ldlm_cn00_005]</span><br><span class="line">130,96   3     3267   107.181625266 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     3267   107.181625266 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     3267   107.181625266 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     3267   107.181625266 147577  C WFS 0 [0]</span><br><span class="line">130,96   3     3267   107.181625266 147577  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   8     3541    38.430448215 457407  D   R 586171870 + 1 [ldlm_cn04_024]</span><br><span class="line">130,96   8     3541    38.430448215 457407  D   R 586171870 + 1 [ldlm_cn04_024]</span><br><span class="line">130,96   8     3541    38.430448215 457407  D   R 586171870 + 1 [ldlm_cn04_024]</span><br><span class="line">130,96   0     4386    39.269007164 87397  A   R 1046172465 + 1 &lt;- (130,97) 1046170417</span><br><span class="line">130,96   0     4386    39.269007164 87397  A   R 1046172465 + 1 &lt;- (130,97) 1046170417</span><br><span class="line">130,96   0     4386    39.269007164 87397  A   R 1046172465 + 1 &lt;- (130,97) 1046170417</span><br><span class="line">130,96   0     4386    39.269007164 87397  A   R 1046172465 + 1 &lt;- (130,97) 1046170417</span><br><span class="line">130,96   0     4386    39.269007164 87397  A   R 1046172465 + 1 &lt;- (130,97) 1046170417</span><br><span class="line">-----------</span><br><span class="line">130,96   7    27703   188.205101648 87604  D   R 2692316814 + 108 [ll_ost_io03_000]</span><br><span class="line">130,96   7    27703   188.205101648 87604  D   R 2692316814 + 108 [ll_ost_io03_000]</span><br><span class="line">130,96   7    27703   188.205101648 87604  D   R 2692316814 + 108 [ll_ost_io03_000]</span><br><span class="line">130,96   2    33558   188.979973248 87573  A   R 17705125164 + 65 &lt;- (130,97) 17705123116</span><br><span class="line">130,96   2    33558   188.979973248 87573  A   R 17705125164 + 65 &lt;- (130,97) 17705123116</span><br><span class="line">130,96   2    33558   188.979973248 87573  A   R 17705125164 + 65 &lt;- (130,97) 17705123116</span><br><span class="line">130,96   2    33558   188.979973248 87573  A   R 17705125164 + 65 &lt;- (130,97) 17705123116</span><br><span class="line">130,96   2    33558   188.979973248 87573  A   R 17705125164 + 65 &lt;- (130,97) 17705123116</span><br><span class="line">-----------</span><br><span class="line">130,96   4    26011   201.210286506 87459  D   R 97772242 + 1 [ll_ost02_015]</span><br><span class="line">130,96   4    26011   201.210286506 87459  D   R 97772242 + 1 [ll_ost02_015]</span><br><span class="line">130,96   4    26011   201.210286506 87459  D   R 97772242 + 1 [ll_ost02_015]</span><br><span class="line">130,96   9    36273   201.771686892 87643  A   R 12330321320 + 1 &lt;- (130,97) 12330319272</span><br><span class="line">130,96   9    36273   201.771686892 87643  A   R 12330321320 + 1 &lt;- (130,97) 12330319272</span><br><span class="line">130,96   9    36273   201.771686892 87643  A   R 12330321320 + 1 &lt;- (130,97) 12330319272</span><br><span class="line">130,96   9    36273   201.771686892 87643  A   R 12330321320 + 1 &lt;- (130,97) 12330319272</span><br><span class="line">130,96   9    36273   201.771686892 87643  A   R 12330321320 + 1 &lt;- (130,97) 12330319272</span><br><span class="line">-----------</span><br><span class="line">130,96   3     8444   268.378619275 134465  D   R 8401718297 + 1 [(null)]</span><br><span class="line">130,96   3     8444   268.378619275 134465  D   R 8401718297 + 1 [(null)]</span><br><span class="line">130,96   3     8444   268.378619275 134465  D   R 8401718297 + 1 [(null)]</span><br><span class="line">130,96   3     8445   269.281722565     0  C WFS 0 [0]</span><br><span class="line">130,96   3     8445   269.281722565     0  C WFS 0 [0]</span><br><span class="line">130,96   3     8445   269.281722565     0  C WFS 0 [0]</span><br><span class="line">130,96   3     8445   269.281722565     0  C WFS 0 [0]</span><br><span class="line">130,96   3     8445   269.281722565     0  C WFS 0 [0]</span><br><span class="line">-----------</span><br><span class="line">130,96   5    11416    77.274186510     0  C   R 252370465 + 108 [0]</span><br><span class="line">130,96   5    11416    77.274186510     0  C   R 252370465 + 108 [0]</span><br><span class="line">130,96   5    11416    77.274186510     0  C   R 252370465 + 108 [0]</span><br><span class="line">130,96   6    15587    77.884666101 87482  A   R 2439660871 + 1 &lt;- (130,97) 2439658823</span><br><span class="line">130,96   6    15587    77.884666101 87482  A   R 2439660871 + 1 &lt;- (130,97) 2439658823</span><br><span class="line">130,96   6    15587    77.884666101 87482  A   R 2439660871 + 1 &lt;- (130,97) 2439658823</span><br><span class="line">130,96   6    15587    77.884666101 87482  A   R 2439660871 + 1 &lt;- (130,97) 2439658823</span><br><span class="line">130,96   6    15587    77.884666101 87482  A   R 2439660871 + 1 &lt;- (130,97) 2439658823</span><br><span class="line">-----------</span><br><span class="line"></span><br><span class="line">time: Mon Oct 21 23:08:23 2019</span><br><span class="line">device: 130,96</span><br><span class="line">sizes <span class="built_in">read</span> (bytes): num 1096, min 512, max 110592, sum 20191744, squ 1021486301184, avg 18423.1, var 592601547.4</span><br><span class="line">sizes write (bytes): num 321, min 512, max 8704, sum 403968, squ 1082392576, avg 1258.5, var 1788199.6</span><br><span class="line">d2c <span class="built_in">read</span> (usec): num 1096, min 22, max 535417, sum 16771224, squ 3855920584028, avg 15302.2, var 3284018033.1</span><br><span class="line">d2c write (usec): num 321, min 129, max 9612, sum 274340, squ 420667492, avg 854.6, var 580078.1</span><br><span class="line">throughput <span class="built_in">read</span> (bytes/msec): num 1096, min 0, max 286507, sum 21616665, squ 2869043959869, avg 19723.2, var 2228734860.6</span><br><span class="line">throughput write (bytes/msec): num 321, min 121, max 24615, sum 640919, squ 3427566995, avg 1996.6, var 6691237.9</span><br><span class="line">sizes histogram (bytes):</span><br><span class="line">            0:     0         1024:   862         2048:    65         4096:    49</span><br><span class="line">         8192:    27        16384:     8        32768:   111        65536:   289</span><br><span class="line">       131072:     6       262144:     0       524288:     0      1048576:     0</span><br><span class="line">      2097152:     0      4194304:     0      8388608:     0    &gt; 8388608:     0</span><br><span class="line">d2c histogram (usec):</span><br><span class="line">            0:     0            8:     0           16:     0           32:     5</span><br><span class="line">           64:    32          128:   310          256:    97          512:   152</span><br><span class="line">         1024:   230         2048:    72         4096:    36         8192:    83</span><br><span class="line">        16384:   187        32768:   141        65536:    43       131072:     7</span><br><span class="line">       262144:     6       524288:    14      1048576:     2      2097152:     0</span><br><span class="line">      4194304:     0      8388608:     0     16777216:     0     33554432:     0</span><br><span class="line">    &gt;33554432:     0</span><br><span class="line">bidirectional requests: 0</span><br></pre></td></tr></table></figure><h5 id="HGST-18-x-events-large-than-0-3-sec-2-x-events-large-than-0-5-sec"><a href="#HGST-18-x-events-large-than-0-3-sec-2-x-events-large-than-0-5-sec" class="headerlink" title="HGST, 18 x events large than 0.3 sec, 2 x events large than 0.5 sec"></a>HGST, 18 x events large than 0.3 sec, 2 x events large than 0.5 sec</h5><p>Each thrid line to fourth line was the time gap<br>HGST has no any <code>D</code> state<br>Compare with seagate, the HGST HDD has the heavy loading and the lower latency</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####### Seagate, lower throughput , higher latency</span></span><br><span class="line">sizes <span class="built_in">read</span> (bytes): num 1096, avg 18423.1, var 592601547.4</span><br><span class="line">sizes write (bytes): num 321, avg 1258.5, var 1788199.6</span><br><span class="line">d2c <span class="built_in">read</span> (usec): num 1096, avg 15302.2, var 3284018033.1</span><br><span class="line">d2c write (usec): num 321, avg 854.6, var 580078.1</span><br><span class="line">throughput <span class="built_in">read</span> (bytes/msec): num 1096, avg 19723.2, var 2228734860.6</span><br><span class="line">throughput write (bytes/msec): num 321, avg 1996.6, var 6691237.9</span><br><span class="line"></span><br><span class="line"><span class="comment">#### Not catch the seagate latency amplification cause HBA reset target timeout</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####### HGST, high throughput, lower latency</span></span><br><span class="line">sizes <span class="built_in">read</span> (bytes): num 891, avg 25486.8, var 909076980.5</span><br><span class="line">sizes write (bytes): num 410, avg 1471.1, var 2609550.7</span><br><span class="line">d2c <span class="built_in">read</span> (usec): num 891, avg 7784.6, var 104030708.2</span><br><span class="line">d2c write (usec): num 410, avg 724.4, var 294981.5</span><br><span class="line">throughput <span class="built_in">read</span> (bytes/msec): num 891, avg 21770.0, var 3369213962.2</span><br><span class="line">throughput write (bytes/msec): num 410, avg 2352.0, var 7309135.3</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> 67,32   8     4930    47.221385251     0  C   R 10370810785 + 1 [0]</span><br><span class="line"> 67,32   8     4930    47.221385251     0  C   R 10370810785 + 1 [0]</span><br><span class="line"> 67,32   8     4930    47.221385251     0  C   R 10370810785 + 1 [0]</span><br><span class="line"> 67,32   1     5221    47.807455951 426452  A   W 2558 + 2 &lt;- (67,33) 510</span><br><span class="line"> 67,32   1     5221    47.807455951 426452  A   W 2558 + 2 &lt;- (67,33) 510</span><br><span class="line"> 67,32   1     5221    47.807455951 426452  A   W 2558 + 2 &lt;- (67,33) 510</span><br><span class="line"> 67,32   1     5221    47.807455951 426452  A   W 2558 + 2 &lt;- (67,33) 510</span><br><span class="line"> 67,32   1     5221    47.807455951 426452  A   W 2558 + 2 &lt;- (67,33) 510</span><br><span class="line">-----------</span><br><span class="line"> 67,32   2     6027    42.377903266     0  C   R 10161719801 + 1 [0]</span><br><span class="line"> 67,32   2     6027    42.377903266     0  C   R 10161719801 + 1 [0]</span><br><span class="line"> 67,32   2     6027    42.377903266     0  C   R 10161719801 + 1 [0]</span><br><span class="line"> 67,32   9     5567    42.898599350 264810  A   R 10376179688 + 1 &lt;- (67,33) 10376177640</span><br><span class="line"> 67,32   9     5567    42.898599350 264810  A   R 10376179688 + 1 &lt;- (67,33) 10376177640</span><br><span class="line"> 67,32   9     5567    42.898599350 264810  A   R 10376179688 + 1 &lt;- (67,33) 10376177640</span><br><span class="line"> 67,32   9     5567    42.898599350 264810  A   R 10376179688 + 1 &lt;- (67,33) 10376177640</span><br><span class="line"> 67,32   9     5567    42.898599350 264810  A   R 10376179688 + 1 &lt;- (67,33) 10376177640</span><br><span class="line">-----------</span><br><span class="line"></span><br><span class="line">$ blktrace /dev/sda -a issue -a complete -w 300  -o - | blkiomon -I 10 -h -</span><br><span class="line">...</span><br><span class="line">time: Mon Oct 21 23:05:42 2019</span><br><span class="line">device: 67,32</span><br><span class="line">sizes <span class="built_in">read</span> (bytes): num 891, min 512, max 70144, sum 22708736, squ 1388760530944, avg 25486.8, var 909076980.5</span><br><span class="line">sizes write (bytes): num 410, min 512, max 10240, sum 603136, squ 1957167104, avg 1471.1, var 2609550.7</span><br><span class="line">d2c <span class="built_in">read</span> (usec): num 891, min 55, max 60463, sum 6936092, squ 146686167138, avg 7784.6, var 104030708.2</span><br><span class="line">d2c write (usec): num 410, min 138, max 5287, sum 297023, squ 336119659, avg 724.4, var 294981.5</span><br><span class="line">throughput <span class="built_in">read</span> (bytes/msec): num 891, min 8, max 461139, sum 19397094, squ 3424244899216, avg 21770.0, var 3369213962.2</span><br><span class="line">throughput write (bytes/msec): num 410, min 96, max 22905, sum 964309, squ 5264774385, avg 2352.0, var 7309135.3</span><br><span class="line">sizes histogram (bytes):</span><br><span class="line">            0:     0         1024:   715         2048:    84         4096:    65</span><br><span class="line">         8192:    32        16384:    33        32768:    10        65536:   121</span><br><span class="line">       131072:   241       262144:     0       524288:     0      1048576:     0</span><br><span class="line">      2097152:     0      4194304:     0      8388608:     0    &gt; 8388608:     0</span><br><span class="line">d2c histogram (usec):</span><br><span class="line">            0:     0            8:     0           16:     0           32:     0</span><br><span class="line">           64:     1          128:    18          256:   122          512:   276</span><br><span class="line">         1024:   327         2048:    57         4096:    33         8192:   121</span><br><span class="line">        16384:   217        32768:   105        65536:    24       131072:     0</span><br><span class="line">       262144:     0       524288:     0      1048576:     0      2097152:     0</span><br><span class="line">      4194304:     0      8388608:     0     16777216:     0     33554432:     0</span><br><span class="line">    &gt;33554432:     0</span><br><span class="line">bidirectional requests: 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="Get-the-imgs"><a href="#Get-the-imgs" class="headerlink" title="Get the imgs"></a><a href="https://tunnelix.com/debugging-disk-issues-with-blktrace-blkparse-btrace-and-btt-in-linux-environment/">Get the imgs</a></h4><p><a href="https://www.bbsmax.com/A/E35p1lEAdv/">blktrace</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ seekwatcher -t sda<span class="selector-class">.blktrace</span>.<span class="number">0</span> -o seek.png</span><br><span class="line">$ seekwatcher -t sda<span class="selector-class">.blktrace</span>.<span class="number">0</span> -o seekmoving<span class="selector-class">.mpg</span> --movie</span><br></pre></td></tr></table></figure><p><a href="https://ext4.wiki.kernel.org/index.php/Ext3_Data%3DOrdered_vs_Data%3DWriteback_mode">ext4 reference</a><br><a href="http://rick_stone.leanote.com/post/ext4%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%881%EF%BC%89%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B">ext4 reference</a></p>]]></content>
      
      
      <categories>
          
          <category> Scripts </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
            <tag> trace </tag>
            
            <tag> block </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>High availability test</title>
      <link href="2016/03/22/ha/"/>
      <url>2016/03/22/ha/</url>
      
        <content type="html"><![CDATA[<h3 id="pcs"><a href="#pcs" class="headerlink" title="pcs"></a>pcs</h3><h4 id="CentOS-7-Initialization"><a href="#CentOS-7-Initialization" class="headerlink" title="CentOS 7 Initialization"></a>CentOS 7 Initialization</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ scp /etc/hosts nodeA:/etc/ </span><br><span class="line">$ scp /etc/hosts nodeB:/etc/ </span><br><span class="line"></span><br><span class="line">$ yum -y install pacemaker corosync fence-agents-all fence-agents-virsh fence-virt pacemaker-remote pcs</span><br><span class="line">$ <span class="built_in">echo</span> hacluster | passwd --stdin hacluster</span><br><span class="line">$ systemctl <span class="built_in">enable</span> pcsd.service</span><br><span class="line">$ systemctl start pcsd.service</span><br><span class="line">$ systemctl is-active pcsd.service</span><br><span class="line">$ pcs cluster auth node01 node02 .</span><br><span class="line">$ pcs cluster setup --start --name ha-kvm node01 node02 </span><br><span class="line">$ pcs cluster <span class="built_in">enable</span> --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 nodes cluster need to disable quorum</span></span><br><span class="line">$ pcs property <span class="built_in">set</span> stonith-enabled=ture</span><br><span class="line">$ pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="Create-fence"><a href="#Create-fence" class="headerlink" title="Create fence"></a>Create fence</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pcs stonith create NodeB-fencing fence_ipmilan pcmk_host_list=<span class="string">&quot;NodeB&quot;</span> ipaddr=<span class="string">&quot;192.xx.xx.xx&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 op monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># search fence device metadata</span></span><br><span class="line">$ stonith_admin -M -a fence_ipmilan</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fence the node</span></span><br><span class="line">$ stonith_admin --reboot nodename </span><br></pre></td></tr></table></figure><p><a href="http://clusterlabs.org/wiki/Configure_Multiple_Fencing_Devices_Using_pcs">config fence level</a></p><h4 id="Create-resource"><a href="#Create-resource" class="headerlink" title="Create resource"></a>Create resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># VIP</span></span><br><span class="line">$ pcs resource create ClusterIP ocf:heartbeat:IPaddr2 ip=<span class="string">&quot;192.xx.xx.xx&quot;</span> cidr_netmask=32 nic=eth0 op monitor interval=30s</span><br><span class="line"></span><br><span class="line"><span class="comment"># kvm</span></span><br><span class="line">$ pcs resource create vm01 VirtualDomain hypervisor=<span class="string">&quot;qemu:///system&quot;</span> config=<span class="string">&quot;/xx/xx/vm01.xml&quot;</span>  meta remote-node=<span class="string">&quot;vm01&quot;</span>a</span><br><span class="line"></span><br><span class="line"><span class="comment"># filesystem</span></span><br><span class="line">$ pcs resource create Lustre-mgs ocf:heartbeat:Filesystem device=<span class="string">&quot;/dev/sdb1&quot;</span> directory=<span class="string">&quot;/mnt&quot;</span> fstype=<span class="string">&quot;ext4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NFS</span></span><br><span class="line">$ pcs resource create WebFS ocf:heartbeat:Filesystem device=<span class="string">&quot;192.xx.xx.xx:/mysqldata&quot;</span> directory=<span class="string">&quot;/var/lib/mysql&quot;</span> fstype=<span class="string">&quot;nfs&quot;</span> options=<span class="string">&quot;-o username=your_name,password=your_password&quot;</span> op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># iscsi</span></span><br><span class="line">$ pcs resource create WebData ocf:heartbeat:iscsi portal=<span class="string">&quot;ip.xx.xx.xx&quot;</span> target=<span class="string">&quot;iqn.2008-08.com.starwindsoftware:&quot;</span> op monitor depth=<span class="string">&quot;0&quot;</span> timeout=<span class="string">&quot;30&quot;</span> interval=<span class="string">&quot;120&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Resource-group"><a href="#Resource-group" class="headerlink" title="Resource group"></a>Resource group</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$  pcs resource group add group_name resource_01 resource_02 ...</span><br><span class="line">$  pcs resource group remove group_name resource_01 resource_02 ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># resource1 run on the same machine as resource2</span></span><br><span class="line">$ pcs constraint colocation add myresource1 with myresource2 score=INFINITY</span><br><span class="line"><span class="comment"># myresource1 cannot run on the same machine as myresource2</span></span><br><span class="line">$ pcs constraint colocation add myresource1 with myresource2 score=-INFINITY</span><br><span class="line"><span class="comment"># Remove colocation constraints</span></span><br><span class="line">$  pcs constraint colocation remove &lt;<span class="built_in">source</span> resource id&gt; &lt;target resource id&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Resource priorities</span></span><br><span class="line">$ pcs constraint order resource1 <span class="keyword">then</span> resource2</span><br><span class="line">$ pcs constraint order remove  resource1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Node priorities, the resource prefers run on ServerA , the resource could fail over to ServerB</span></span><br><span class="line">$ pcs constraint location resource_id prefers ServerA=200</span><br><span class="line">$ pcs constraint location resource_id prefers ServerB=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># List all current location, order and colocation constraints</span></span><br><span class="line">$ pcs constraint --full</span><br></pre></td></tr></table></figure><h4 id="Backup-Restore-config"><a href="#Backup-Restore-config" class="headerlink" title="Backup/Restore config"></a>Backup/Restore config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exprot config</span></span><br><span class="line">$ pcs cluster cib filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># import config</span></span><br><span class="line">$ pcs cluster cib-push filename</span><br></pre></td></tr></table></figure><h4 id="Show-config"><a href="#Show-config" class="headerlink" title="Show config"></a>Show config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pcs config show</span><br><span class="line">$ pcs stonith show stonith-name</span><br><span class="line">$ pcs resource show resource-name</span><br></pre></td></tr></table></figure><h4 id="get-default-value"><a href="#get-default-value" class="headerlink" title="get default value"></a>get default value</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource defaults</span><br><span class="line"></span><br><span class="line">$ pcs resource defaults migration-threshold=5</span><br><span class="line">$ pcs resource defaults failure-timeout=240s</span><br><span class="line"></span><br><span class="line"><span class="comment"># not switch resource</span></span><br><span class="line">$ pcs resource defaults resource-stickiness=100</span><br><span class="line"></span><br><span class="line"><span class="comment"># resource timeout</span></span><br><span class="line">$ pcs resource op defaults timeout=240s</span><br><span class="line"></span><br><span class="line">$ pcs property <span class="built_in">set</span> stonith-action=reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete</span></span><br><span class="line">$ pcs resource defaults timeouts=</span><br></pre></td></tr></table></figure><h4 id="Switch-and-delete-resource"><a href="#Switch-and-delete-resource" class="headerlink" title="Switch and delete resource"></a>Switch and delete resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource move resource_name HostnameB</span><br><span class="line">$ pcs resource delete resource_name</span><br></pre></td></tr></table></figure><h4 id="Get-status"><a href="#Get-status" class="headerlink" title="Get status"></a>Get status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pcs status </span><br><span class="line">$ pcs status cluster</span><br><span class="line">$ pcs status corosync</span><br><span class="line">$ pcs cluster stop [nodename]  </span><br><span class="line">$ pcs cluster start --all</span><br><span class="line">$ pcs cluster standby nodename</span><br></pre></td></tr></table></figure><h4 id="Clean-info"><a href="#Clean-info" class="headerlink" title="Clean info"></a>Clean info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clean all error messages and error counts</span></span><br><span class="line">$ pcs resource cleanup resource_id</span><br><span class="line">$ pcs stonith cleanup fence_name</span><br></pre></td></tr></table></figure><p><a href="http://clusterlabs.org/wiki/Configure_Multiple_Fencing_Devices_Using_pcs">reference</a></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="pacemaker"><a href="#pacemaker" class="headerlink" title="pacemaker"></a>pacemaker</h3><h4 id="clear-all-pacemaker-config"><a href="#clear-all-pacemaker-config" class="headerlink" title="clear all pacemaker config"></a>clear all pacemaker config</h4><p>Delete conf files from all nodes and restart services.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rm -f /var/lib/pacemaker/cib/*</span><br><span class="line">$ systemctl stop pacemaker</span><br><span class="line">$ systemctl stop corosync</span><br><span class="line">$ systemctl start corosync</span><br><span class="line">$ systemctl start pacemaker</span><br></pre></td></tr></table></figure><h3 id="corosync"><a href="#corosync" class="headerlink" title="corosync"></a>corosync</h3><h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ corosync-cfgtool -s </span><br><span class="line">Printing ring status.</span><br><span class="line">Local node ID 2</span><br><span class="line">RING ID 0</span><br><span class="line">id= 10.xx.xx.xx</span><br><span class="line">status= ring 0 active with no faults</span><br><span class="line">RING ID 1</span><br><span class="line">id= 172.xx.xx.xx</span><br><span class="line">status= ring 1 active with no faults</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ corosync-quorumtool -siH</span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Tue Mar 22 04:07:15 2016</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000002</span><br><span class="line">Ring ID:          656</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2</span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000001          1 10.x.x.x</span><br><span class="line">0x00000003          1 10.x.x.x</span><br><span class="line">0x00000002          1 10.x.x.x (<span class="built_in">local</span>)</span><br></pre></td></tr></table></figure><h4 id="3-x-CentOS-7-corosync-conf"><a href="#3-x-CentOS-7-corosync-conf" class="headerlink" title="3 x CentOS 7 corosync.conf"></a>3 x CentOS 7 corosync.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">totem</span> &#123;</span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">secauth:</span> <span class="string">off</span></span><br><span class="line">    <span class="string">rrp_mode:active</span></span><br><span class="line">    <span class="attr">cluster_name:</span> <span class="string">ha-kvm</span></span><br><span class="line">    <span class="attr">transport:</span> <span class="string">udpu</span></span><br><span class="line">    <span class="attr">token:</span> <span class="number">17000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">nodelist</span> &#123;</span><br><span class="line">  <span class="string">node</span> &#123;</span><br><span class="line">        <span class="attr">ring0_addr:</span> <span class="string">nic0.serverA.xx.xx</span></span><br><span class="line">        <span class="attr">ring1_addr:</span> <span class="string">nic1.serverA.xx.xx</span></span><br><span class="line">        <span class="attr">nodeid:</span> <span class="number">1</span></span><br><span class="line">       &#125;</span><br><span class="line">  <span class="string">node</span> &#123;</span><br><span class="line">        <span class="attr">ring0_addr:</span> <span class="string">nic0.serverB.xx.xx</span></span><br><span class="line">        <span class="attr">ring1_addr:</span> <span class="string">nic1.serverB.xx.xx</span></span><br><span class="line">        <span class="attr">nodeid:</span> <span class="number">2</span></span><br><span class="line">       &#125;</span><br><span class="line">  <span class="string">node</span> &#123;</span><br><span class="line">        <span class="attr">ring0_addr:</span> <span class="string">nic0.serverC.xx.xx</span></span><br><span class="line">        <span class="attr">ring1_addr:</span> <span class="string">nic1.serverC.xx.xx</span></span><br><span class="line">        <span class="attr">nodeid:</span> <span class="number">3</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">quorum</span> &#123;</span><br><span class="line">    <span class="attr">provider:</span> <span class="string">corosync_votequorum</span></span><br><span class="line">    <span class="attr">expected_votes:</span> <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">logging</span> &#123;</span><br><span class="line">        <span class="attr">fileline:</span> <span class="string">off</span></span><br><span class="line">        <span class="attr">to_logfile:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">to_syslog:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">logfile:</span> <span class="string">/var/log/cluster/corosync.log</span></span><br><span class="line">        <span class="attr">timestamp:</span> <span class="string">on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-x-CentOS6-corosync-conf"><a href="#2-x-CentOS6-corosync-conf" class="headerlink" title="2 x CentOS6 corosync.conf"></a>2 x CentOS6 corosync.conf</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Please read the corosync.conf.5 manual page</span><br><span class="line">compatibility: xxxx</span><br><span class="line"></span><br><span class="line">totem &#123;</span><br><span class="line">version: <span class="number">2</span></span><br><span class="line">secauth: off</span><br><span class="line">interface &#123;</span><br><span class="line">member &#123;</span><br><span class="line">memberaddr: nic0.serverA.xx.xx</span><br><span class="line">&#125;</span><br><span class="line">member &#123;</span><br><span class="line">memberaddr: nic0.serverB.xx.xx</span><br><span class="line">&#125;</span><br><span class="line">ringnumber: <span class="number">0</span></span><br><span class="line">bindnetaddr: nic0.xx.xx.xx</span><br><span class="line">mcastport: <span class="number">5406</span></span><br><span class="line">ttl: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">interface &#123;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: nic1.serverA.xx.xx</span><br><span class="line">                &#125;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: nic1.serverB.xx.xx</span><br><span class="line">                &#125;</span><br><span class="line">                ringnumber: <span class="number">1</span></span><br><span class="line">                bindnetaddr: nic1.xx.xx.xx</span><br><span class="line">                mcastport: <span class="number">5406</span></span><br><span class="line">                ttl: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">transport: udpu</span><br><span class="line">token: <span class="number">17000</span></span><br><span class="line">rrp_mode: passive</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">fileline: off</span><br><span class="line">to_logfile: yes</span><br><span class="line">to_syslog: yes</span><br><span class="line">debug: on</span><br><span class="line">logfile: <span class="regexp">/var/</span>log/cluster/corosync.log</span><br><span class="line">debug: off</span><br><span class="line">timestamp: on</span><br><span class="line">logger_subsys &#123;</span><br><span class="line">subsys: AMF</span><br><span class="line">debug: off</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="http://qiita.com/tukiyo3/items/3f8b99be73798df857fd">config refence</a></p><h3 id="Create-volume-for-test-env"><a href="#Create-volume-for-test-env" class="headerlink" title="Create volume for test env"></a>Create volume for test env</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gluster volume create test_vol disperse-data 4 redundancy 2 transport tcp server1:/gluster1/glusterfs server1:/gluster2/glusterfs server2:/var/glusterfs/ server3:/var/glusterfs server4:/tank/glusterfs server5:/tank/glusterfs/ force</span><br><span class="line">gluster volume start test_vol</span><br><span class="line">gluster volume <span class="built_in">set</span> test_vol features.cache-invalidation on</span><br></pre></td></tr></table></figure><h3 id="glusterfs-in-ha"><a href="#glusterfs-in-ha" class="headerlink" title="glusterfs in ha"></a>glusterfs in ha</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pcs cluster auth 10.xx.xx.10 10.xx.xx.11 -u hacluster</span><br><span class="line">systemctl start pcsd</span><br><span class="line">pcs cluster setup --name NFS_Server 10.xx.xx.10,192.xx.xx.10 10.xx.xx.11,192.xx.xx.11 --transport udp --rrpmode passive --token 7000 --addr0 10.xx.xx.0 --addr1 192.xx.xx.0 --force</span><br><span class="line">sed -i <span class="string">&#x27;s/transport: udp/transport: udpu/g&#x27;</span> /etc/corosync/corosync.conf</span><br><span class="line">pcs cluster start 10.xx.xx.10</span><br><span class="line">pcs cluster start 10.xx.xx.11</span><br><span class="line">pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-enabled=<span class="literal">false</span></span><br><span class="line">pcs resource create virtual_ip1 ocf:heartbeat:IPaddr2 ip=10.xx.xx.10 cidr_netmask=24 op monitor interval=30s --group nfsgroup</span><br><span class="line">pcs resource create glusterfs-mount ocf:heartbeat:Filesystem device=10.xx.xx.10:/test_vol directory=/glusterfs fstype=glusterfs --group nfsgroup</span><br><span class="line">pcs resource create nfs-daemon ocf:heartbeat:nfsserver nfs_shared_infodir=/glusterfs/nfsinfo nfs_no_notify=<span class="literal">true</span> --group nfsgroup</span><br><span class="line">pcs resource create nfs-root ocf:heartbeat:exportfs clientspec=10.0.0.0/255.0.0.0 options=rw,no_root_squash directory=/glusterfs fsid=0 --group nfsgroup</span><br><span class="line">pcs resource create virtual_ip2 ocf:heartbeat:IPaddr2 ip=10.xx.xx.11 cidr_netmask=24 op monitor interval=30s --group dc_nfs</span><br><span class="line">pcs resource create dc-glusterfs ocf:heartbeat:Filesystem device=10.xx.xx.11:/test_vol directory=/sources fstype=glusterfs --group dc_nfs</span><br><span class="line">pcs resource create dc-nfs-daemon ocf:heartbeat:nfsserver nfs_shared_infodir=/glusterfs/nfsinfo nfs_no_notify=<span class="literal">true</span> --group dc_nfs</span><br><span class="line">pcs resource create dc-nfs-root ocf:heartbeat:exportfs clientspec=10.0.0.0/255.0.0.0 options=rw,no_root_squash directory=/sources fsid=1 --group dc_nfs</span><br></pre></td></tr></table></figure><h3 id="heal-and-split-brain"><a href="#heal-and-split-brain" class="headerlink" title="heal and split-brain"></a><a href="http://staged-gluster-docs.readthedocs.io/en/release3.7.0beta1/Features/heal-info-and-split-brain-resolution/">heal and split-brain</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gluster volume heal test_vol info</span><br><span class="line">gluster volume heal test_vol info split-brain</span><br></pre></td></tr></table></figure><h3 id="Just-for-test-not-in-my-production-environment-it-is-incomplete"><a href="#Just-for-test-not-in-my-production-environment-it-is-incomplete" class="headerlink" title="Just for test , not in my production environment, it is incomplete"></a>Just for test , not in my production environment, it is incomplete</h3><ul><li>3 nodes linux HA replace 2 nodes</li><li>fence kvm</li></ul><h3 id="Physical-node-OS"><a href="#Physical-node-OS" class="headerlink" title="Physical node OS"></a>Physical node OS</h3><ul><li>CentOS Linux release 7.1.1503 (Core) </li><li>3.10.0-229.14.1.el7.x86_64</li></ul><h3 id="Virtual-machine-OS"><a href="#Virtual-machine-OS" class="headerlink" title="Virtual machine OS"></a>Virtual machine OS</h3><p>*CentOS release 6.7 (Final)</p><ul><li>2.6.32-504.30.3.el6_lustre.x86_64</li><li>Not support SR-IOV</li><li>Virtaul disk cache set to none</li></ul><h3 id="Create-linux-HA-3-x-physical-server"><a href="#Create-linux-HA-3-x-physical-server" class="headerlink" title="Create linux HA ,3 x physical server"></a>Create linux HA ,3 x physical server</h3><p>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.xx.xx.1 node01<br>10.xx.xx.2 node02<br>10.xx.xx.3 node03</p><h3 id="Share-strorages"><a href="#Share-strorages" class="headerlink" title="Share strorages"></a>Share strorages</h3><p>NFS/Lustre</p><h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install pacemaker corosync fence-agents-all fence-agents-virsh \</span></span><br><span class="line">  fence-virt pacemaker-remote pcs fence-virtd resource-agents \</span><br><span class="line">  fence-virtd-libvirt fence-virtd-multicast</span><br></pre></td></tr></table></figure><h3 id="Setup-physical-server"><a href="#Setup-physical-server" class="headerlink" title="Setup physical server"></a>Setup physical server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo hacluster | passwd --stdin hacluster</span></span><br><span class="line"><span class="comment"># systemctl enable pcsd.service</span></span><br><span class="line"><span class="comment"># systemctl start pcsd.service</span></span><br><span class="line"><span class="comment"># systemctl is-active pcsd.service</span></span><br><span class="line"><span class="comment"># pcs cluster auth node01 node02 node03 ##input hacluster password for auth</span></span><br><span class="line"><span class="comment"># pcs cluster setup --start --name ha-kvm node01 node02 node03</span></span><br><span class="line"><span class="comment"># pcs property set no-quorum-policy=stop</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>4.1.2 Option no-quorum-policy</p><p>This global option defines what to do when a cluster partition does not have quorum (no majority of nodes is part of the partition).</p><p>Allowed values are:</p><p>ignore<br>The quorum state does not influence the cluster behavior; resource management is continued.</p><p>This setting is useful for the following scenarios:</p><p>Two-node clusters: Since a single node failure would always result in a loss of majority, usually you want the cluster to carry on regardless. Resource integrity is ensured using fencing, which also prevents split brain scenarios.</p><p>Resource-driven clusters: For local clusters with redundant communication channels, a split brain scenario only has a certain probability. Thus, a loss of communication with a node most likely indicates that the node has crashed, and that the surviving nodes should recover and start serving the resources again.</p><p>If no-quorum-policy is set to ignore, a 4-node cluster can sustain concurrent failure of three nodes before service is lost. With the other settings, it would lose quorum after concurrent failure of two nodes.</p><p>freeze<br>If quorum is lost, the cluster partition freezes. Resource management is continued: running resources are not stopped (but possibly restarted in response to monitor events), but no further resources are started within the affected partition.</p><p>This setting is recommended for clusters where certain resources depend on communication with other nodes (for example, OCFS2 mounts). In this case, the default setting no-quorum-policy=stop is not useful, as it would lead to the following scenario: Stopping those resources would not be possible while the peer nodes are unreachable. Instead, an attempt to stop them would eventually time out and cause a stop failure, triggering escalated recovery and fencing.</p><p>stop (default value)<br>If quorum is lost, all resources in the affected cluster partition are stopped in an orderly fashion.</p><p>suicide<br>If quorum is lost, all nodes in the affected cluster partition are fenced.</p><h3 id="Setting-etc-corosync-corosync-conf-for-every-node"><a href="#Setting-etc-corosync-corosync-conf-for-every-node" class="headerlink" title="Setting /etc/corosync/corosync.conf for every node"></a>Setting /etc/corosync/corosync.conf for every node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">totem &#123;</span><br><span class="line">    version: 2</span><br><span class="line">    secauth: off</span><br><span class="line">    rrp_mode:active</span><br><span class="line">    cluster_name: ha-kvm</span><br><span class="line">    transport: udpu</span><br><span class="line">    token: 17000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist &#123;</span><br><span class="line">  node &#123;</span><br><span class="line">ring0_addr: 10.xx.xx.1</span><br><span class="line">        ring1_addr: 172.xx.xx.1</span><br><span class="line">        nodeid: 1</span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line">        ring0_addr: 10.xx.xx.3</span><br><span class="line">        ring1_addr: 172.xx.xx.3</span><br><span class="line">        nodeid: 2</span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line">        ring0_addr: 10.xx.xx.2</span><br><span class="line">        ring1_addr: 172.xx.xx.2</span><br><span class="line">        nodeid: 3</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line">    provider: corosync_votequorum</span><br><span class="line">    expected_votes: 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        fileline: off</span><br><span class="line">        to_logfile: yes</span><br><span class="line">        to_syslog: yes</span><br><span class="line">        logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</span><br><span class="line">        timestamp: on</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Restart-corosync-service-in-each-node"><a href="#Restart-corosync-service-in-each-node" class="headerlink" title="Restart corosync service in each node"></a>Restart corosync service in each node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl restart corosync</span></span><br></pre></td></tr></table></figure><h3 id="Create-stonith-for-physical-server"><a href="#Create-stonith-for-physical-server" class="headerlink" title="Create stonith for physical server"></a>Create stonith for physical server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create node01-fencing fence_ipmilan pcmk_host_list=&quot;nod01 node02 node03&quot; \</span></span><br><span class="line">ipaddr=<span class="string">&quot;node1_ipmi_ipaddr&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node02-fencing fence_ipmilan pcmk_host_list=&quot;nod01 node02 node03&quot; \</span></span><br><span class="line"> ipaddr=<span class="string">&quot;node2_ipmi_ipaddr&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node03-fencing fence_ipmilan pcmk_host_list=&quot;nod01 node02 node03&quot; \</span></span><br><span class="line">ipaddr=<span class="string">&quot;node3_ipmi_ipaddr&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 op \</span><br><span class="line">monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs property set stonith-enabled=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: ha-kvm</span><br><span class="line">Last updated: Wed Nov 11 16:42:46 2015</span><br><span class="line">Last change: Wed Nov 11 02:48:26 2015 by root via crm_resource on node01</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: node01 (version 1.1.13-a14efad) - partition with quorum</span><br><span class="line">3 nodes and 5 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ node02 node03 node01 ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> node01-fencing(stonith:fence_ipmilan):Started node02</span><br><span class="line"> node03-fencing(stonith:fence_ipmilan):Started node01</span><br><span class="line"> node02-fencing(stonith:fence_ipmilan):Started node03</span><br><span class="line"></span><br><span class="line">PCSD Status:</span><br><span class="line">  node03: Online</span><br><span class="line">  node01: Online</span><br><span class="line">  node02: Online</span><br><span class="line"></span><br><span class="line">Daemon Status:</span><br><span class="line">  corosync: active/enabled</span><br><span class="line">  pacemaker: active/enabled</span><br><span class="line">  pcsd: active/enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Get-quorum-info"><a href="#Get-quorum-info" class="headerlink" title="Get quorum info"></a>Get quorum info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># corosync-quorumtool -siH</span></span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Thu Nov 12 04:49:31 2015</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000002</span><br><span class="line">Ring ID:          260</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2  </span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000003          1 10.0.0.80</span><br><span class="line">0x00000001          1 10.0.10.97</span><br><span class="line">0x00000002          1 10.0.10.106 (<span class="built_in">local</span>)</span><br></pre></td></tr></table></figure><h3 id="Install-kvm"><a href="#Install-kvm" class="headerlink" title="Install kvm"></a>Install kvm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install qemu-kvm libcacard qemu-kvm-common libvirt</span></span><br></pre></td></tr></table></figure><h3 id="Create-HA-resource-for-kvm"><a href="#Create-HA-resource-for-kvm" class="headerlink" title="Create HA resource for kvm"></a>Create HA resource for kvm</h3><p>Delete cpu model in your xml file for prevent virsh start faild.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;custom&#x27;</span> <span class="attr">match</span>=<span class="string">&#x27;exact&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">&#x27;allow&#x27;</span>&gt;</span>SandyBridge<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;custom&#x27;</span> <span class="attr">match</span>=<span class="string">&#x27;exact&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">&#x27;allow&#x27;</span>&gt;</span>Westmere<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs resource create mds-01 VirtualDomain hypervisor=&quot;qemu:///system&quot; \</span></span><br><span class="line">config=<span class="string">&quot;/xxx/mds01.xml&quot;</span>  meta remote-node=<span class="string">&quot;mds-01&quot;</span></span><br><span class="line"><span class="comment"># pcs resource create mds-02 VirtualDomain hypervisor=&quot;qemu:///system&quot; \</span></span><br><span class="line">config=<span class="string">&quot;/xxx/mds02.xml&quot;</span>  meta remote-node=<span class="string">&quot;mds-02&quot;</span></span><br></pre></td></tr></table></figure><p>###Configure the pysical node for stonith</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install fence-virt fence-virtd fence-virtd-multicast fence-virtd-libvirt</span></span><br><span class="line"><span class="comment"># fence_virtd -c</span></span><br><span class="line">Accept all the defaults except <span class="keyword">for</span> the items listed below, and the multicast IP and TCP port <span class="keyword">if</span> you selected non-default ones:</span><br><span class="line">Setting a preferred interface causes fence_virtd to listen only</span><br><span class="line"> on that interface.  Normally, it listens on all interfaces.</span><br><span class="line"> In environments <span class="built_in">where</span> the virtual machines are using the host</span><br><span class="line"> machine as a gateway, this *must* be <span class="built_in">set</span> (typically to virbr0).</span><br><span class="line"> Set to <span class="string">&#x27;none&#x27;</span> <span class="keyword">for</span> no interface.</span><br><span class="line"> </span><br><span class="line"> Interface [none]: br1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You can accept the default (none) <span class="keyword">if</span> the guests have IPs on the <span class="built_in">local</span> LAN. Here, we assume they <span class="keyword">do</span> not.</span><br><span class="line">Key File [none]: /etc/cluster/fence_xvm.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This ensures only machines with the same key can initiate fencing requests.</span><br><span class="line">At the end, it will ask</span><br><span class="line">Replace /etc/fence_virt.conf with the above [y/N]? y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Say yes.</span><br><span class="line">You should end up with a configuration like this <span class="keyword">in</span> /etc/fence_virt.conf:</span><br><span class="line">backends &#123;</span><br><span class="line">         libvirt &#123;</span><br><span class="line">                 uri = <span class="string">&quot;qemu:///system&quot;</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> listeners &#123;</span><br><span class="line">         multicast &#123;</span><br><span class="line">                 key_file = <span class="string">&quot;/etc/cluster/fence_xvm.key&quot;</span>;</span><br><span class="line">                 interface = <span class="string">&quot;virbr0&quot;</span>;</span><br><span class="line">                 port = <span class="string">&quot;1229&quot;</span>;</span><br><span class="line">                 address = <span class="string">&quot;225.0.0.12&quot;</span>;</span><br><span class="line">                 family = <span class="string">&quot;ipv4&quot;</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> fence_virtd &#123;</span><br><span class="line">         backend = <span class="string">&quot;libvirt&quot;</span>;</span><br><span class="line">         listener = <span class="string">&quot;multicast&quot;</span>;</span><br><span class="line">         module_path = <span class="string">&quot;/usr/lib64/fence-virt&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /etc/cluster</span></span><br><span class="line"><span class="comment"># dd if=/dev/urandom bs=4k count=1 of=/etc/cluster/fence_xvm.key</span></span><br><span class="line"><span class="comment"># chmod 0600 /etc/cluster/fence_xvm.key</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Required changes to the address value on both nodes</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    (on node1)</span><br><span class="line">    address = <span class="string">&quot;225.0.1.12&quot;</span>;</span><br><span class="line"></span><br><span class="line">    (on node2)</span><br><span class="line">    address = <span class="string">&quot;225.0.2.12&quot;</span>;</span><br><span class="line"></span><br><span class="line">    (on node3)</span><br><span class="line">    address = <span class="string">&quot;225.0.3.12&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># fence_virtd  #start the daemon</span></span><br><span class="line"><span class="comment"># fence_xvm -o list</span></span><br><span class="line">iml-01               e95b2343-7d31-410d-1398-25c98daaaabd on</span><br><span class="line">manager-kvm          24fa85e3-6cc0-4e1e-b8b5-cdd78aca1eff on</span><br><span class="line">mds-02               e95e6534-7a29-419b-9919-22d8cad8ef4d on</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Configure-the-virtual-machine-for-stonith"><a href="#Configure-the-virtual-machine-for-stonith" class="headerlink" title="Configure the virtual machine for stonith"></a>Configure the virtual machine for stonith</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install fence-virt fence-virtd</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/cluster</span></span><br><span class="line">Copy the shared key from the physical host to vm:/etc/cluster/fence_xvm.key</span><br></pre></td></tr></table></figure><h3 id="Create-stonith-resource-for-vm"><a href="#Create-stonith-resource-for-vm" class="headerlink" title="Create stonith resource for vm"></a>Create stonith resource for vm</h3><p>Because I do not know which vm would be running in one physical node. Because there are three physical server,<br>so I create three vm fencing for one vm.</p><p>I setup a corosync with pacemaker two node cluster for mds-01 and mds-02</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-1 fence_xvm pcmk_host_list=&quot;mds-01 mds-02&quot; action=&quot;reboot&quot; \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.1.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-2 fence_xvm pcmk_host_list=&quot;mds-01 mds-02&quot; action=&quot;reboot&quot; \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.2.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-3 fence_xvm pcmk_host_list=&quot;mds-01 mds-02&quot; action=&quot;reboot&quot; \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.3.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-1 fence_xvm pcmk_host_list=&quot;mds-01 mds-02&quot; action=&quot;reboot&quot; \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.1.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-2 fence_xvm pcmk_host_list=&quot;mds-01 mds-02&quot; action=&quot;reboot&quot; \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.2.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-3 fence_xvm pcmk_host_list=&quot;mds-01 mds-02&quot; action=&quot;reboot&quot; \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.3.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: </span><br><span class="line">Last updated: Thu Nov 12 08:36:34 2015</span><br><span class="line">Last change: Thu Nov 12 08:34:47 2015</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: mds-01 - partition with quorum</span><br><span class="line">Version: 1.1.11-97629de</span><br><span class="line">2 Nodes configured, 2 expected votes</span><br><span class="line">6 Resources configured</span><br><span class="line">Online: [ mds-01 mds-02 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> xvmfence_mds-01-1(stonith:fence_xvm):Started mds-01 </span><br><span class="line"> xvmfence_mds-01-2(stonith:fence_xvm):Started mds-02 </span><br><span class="line"> xvmfence_mds-01-3(stonith:fence_xvm):Started mds-01 </span><br><span class="line"> xvmfence_mds-02-1(stonith:fence_xvm):Started mds-02 </span><br><span class="line"> xvmfence_mds-02-2(stonith:fence_xvm):Started mds-01 </span><br><span class="line"> xvmfence_mds-02-3(stonith:fence_xvm):Started mds-02 </span><br><span class="line"></span><br><span class="line"><span class="comment"># Settting level for clsuter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs stonith level add 1 mds-01 xvmfence_mds-01-1</span></span><br><span class="line"><span class="comment"># pcs stonith level add 2 mds-01 xvmfence_mds-01-2</span></span><br><span class="line"><span class="comment"># pcs stonith level add 3 mds-01 xvmfence_mds-01-3</span></span><br><span class="line"><span class="comment"># pcs stonith level add 1 mds-01 xvmfence_mds-02-1</span></span><br><span class="line"><span class="comment"># pcs stonith level add 2 mds-01 xvmfence_mds-02-2</span></span><br><span class="line"><span class="comment"># pcs stonith level add 3 mds-01 xvmfence_mds-02-3</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Test-vm-stonith"><a href="#Test-vm-stonith" class="headerlink" title="Test vm stonith"></a>Test vm stonith</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.3.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: ON  (It means mds-01 running <span class="keyword">in</span> node3)</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.1.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.2.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line"></span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.1.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: ON  (It means mds-02 running <span class="keyword">in</span> node1)</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.2.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.3.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line"></span><br><span class="line">fence mds-02</span><br><span class="line">[root@mds-01 ~]<span class="comment"># pcs stonith fence mds-02</span></span><br><span class="line">Node: mds-02 fenced</span><br><span class="line">[root@mds-02 ~]<span class="comment"># Write failed: Broken pipe</span></span><br><span class="line"></span><br><span class="line">fence mds-01</span><br><span class="line">[root@mds-02 ~]<span class="comment"># pcs stonith fence mds-01</span></span><br><span class="line">Node: mds-01 fenced</span><br><span class="line">[root@mds-01 ~]<span class="comment"># Write failed: Broken pipe</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>There is one Mellanox ConnectX-3 adapter could not work well in my test environment.<br>I checked config again and again until I upgrded the driver, it could work well.<br>Third time to waste my time in Mellanox ethernet adapter, until now I dont think its a good choice.</p><p>Reference<br><a href="http://clusterlabs.org/wiki/Guest_Fencing">http://clusterlabs.org/wiki/Guest_Fencing</a><br><a href="https://access.redhat.com/solutions/293183">https://access.redhat.com/solutions/293183</a><br><a href="https://access.redhat.com/solutions/917833">https://access.redhat.com/solutions/917833</a><br><a href="https://alteeve.ca/w/Fencing_KVM_Virtual_Servers#Configuring_fence_xvm">https://alteeve.ca/w/Fencing_KVM_Virtual_Servers#Configuring_fence_xvm</a><br><a href="http://people.redhat.com/ccaulfie/docs/Votequorum_Intro.pdf">http://people.redhat.com/ccaulfie/docs/Votequorum_Intro.pdf</a><br><a href="https://www.ibm.com/developerworks/community/blogs/mhhaque/entry/configure_two_node_highly_available_cluster_using_kvm_fencing_on_rhel7?lang=en">https://www.ibm.com/developerworks/community/blogs/mhhaque/entry/configure_two_node_highly_available_cluster_using_kvm_fencing_on_rhel7?lang=en</a><br><a href="https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_config_basics_global.html?view=print">https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_config_basics_global.html?view=print</a></p><h3 id="Physical-node-OS-1"><a href="#Physical-node-OS-1" class="headerlink" title="Physical node OS"></a>Physical node OS</h3><ul><li>CentOS Linux release 7.3<br><img src="/img/test-arch.png"></li></ul><h2 id="Create-linux-HA-3-x-physical-server-1"><a href="#Create-linux-HA-3-x-physical-server-1" class="headerlink" title="Create linux HA ,3 x physical server"></a>Create linux HA ,3 x physical server</h2><p>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.xx.xx.130 node01<br>192.xx.xx.131 node02<br>192.xx.xx.132 node03</p><h3 id="Share-strorages-1"><a href="#Share-strorages-1" class="headerlink" title="Share strorages"></a>Share strorages</h3><p>NFS/Lustre</p><h3 id="Setup-HA-cluster"><a href="#Setup-HA-cluster" class="headerlink" title="Setup HA cluster"></a>Setup HA cluster</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install pacemaker corosync fence-agents-all fence-agents-virsh \</span></span><br><span class="line">  fence-virt pacemaker-remote pcs fence-virtd resource-agents \</span><br><span class="line">  fence-virtd-libvirt fence-virtd-multicast</span><br></pre></td></tr></table></figure><h3 id="3-nodes-glusterfs-config"><a href="#3-nodes-glusterfs-config" class="headerlink" title="3 nodes glusterfs config"></a>3 nodes glusterfs config</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zpool create tank -O canmount=on -o ashift=9 -o cachefile=none -O xattr=sa -O compression=lz4 -O acltype=posixacl raidz2 /dev/sd&#123;c..h&#125;</span><br><span class="line">$ zpool add tank cache /dev/sda4 /dev/sdb4</span><br><span class="line">$ zpool add tank <span class="built_in">log</span> mirror /dev/sda3 /dev/sdb3</span><br><span class="line">$ gluster volume create ec-test disperse-data 2 redundancy 1  transport tcp node1:/tank/glusterfs node2:/tank/glusterfs node3:/tank/glusterfs force</span><br></pre></td></tr></table></figure><h4 id="Setup-physical-server-1"><a href="#Setup-physical-server-1" class="headerlink" title="Setup physical server"></a>Setup physical server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> hacluster | passwd --stdin hacluster</span><br><span class="line">$ systemctl <span class="built_in">enable</span> pcsd.service</span><br><span class="line">$ systemctl <span class="built_in">disable</span> corosync.service pcaemaker.service</span><br><span class="line">$ systemctl stop corosync.service pcaemaker.service</span><br><span class="line">$ systemctl start pcsd.service</span><br><span class="line">$ systemctl is-active pcsd.service</span><br><span class="line">$ pcs cluster auth node01 node02 node03 <span class="comment">##input hacluster password for auth</span></span><br><span class="line">$ pcs cluster setup --name ha-cluster node01,172.29.xx.xx node02,172.92.xx.xx node03,172.29.xx.xx --transport udpu --rrpmode passive --token 17000 --addr0 172.29.xx.0 --addr1 192.168.101.0 </span><br><span class="line">$ pcs cluster setup --start --name ha-cluster node01 node02 node03</span><br><span class="line"><span class="comment">## pcs property set no-quorum-policy=stop #don&#x27;t need to stop</span></span><br></pre></td></tr></table></figure><p>4.1.2 Option no-quorum-policy</p><p>This global option defines what to do when a cluster partition does not have quorum (no majority of nodes is part of the partition).</p><p>Allowed values are:</p><p>ignore<br>The quorum state does not influence the cluster behavior; resource management is continued.</p><p>This setting is useful for the following scenarios:</p><p>Two-node clusters: Since a single node failure would always result in a loss of majority, usually you want the cluster to carry on regardless. Resource integrity is ensured using fencing, which also prevents split brain scenarios.</p><p>Resource-driven clusters: For local clusters with redundant communication channels, a split brain scenario only has a certain probability. Thus, a loss of communication with a node most likely indicates that the node has crashed, and that the surviving nodes should recover and start serving the resources again.</p><p>If no-quorum-policy is set to ignore, a 4-node cluster can sustain concurrent failure of three nodes before service is lost. With the other settings, it would lose quorum after concurrent failure of two nodes.</p><p>freeze<br>If quorum is lost, the cluster partition freezes. Resource management is continued: running resources are not stopped (but possibly restarted in response to monitor events), but no further resources are started within the affected partition.</p><p>This setting is recommended for clusters where certain resources depend on communication with other nodes (for example, OCFS2 mounts). In this case, the default setting no-quorum-policy=stop is not useful, as it would lead to the following scenario: Stopping those resources would not be possible while the peer nodes are unreachable. Instead, an attempt to stop them would eventually time out and cause a stop failure, triggering escalated recovery and fencing.</p><p>stop (default value)<br>If quorum is lost, all resources in the affected cluster partition are stopped in an orderly fashion.</p><p>suicide<br>If quorum is lost, all nodes in the affected cluster partition are fenced.</p><h4 id="Setting-etc-corosync-corosync-conf-for-every-node-1"><a href="#Setting-etc-corosync-corosync-conf-for-every-node-1" class="headerlink" title="Setting /etc/corosync/corosync.conf for every node"></a>Setting /etc/corosync/corosync.conf for every node</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">totem &#123;</span><br><span class="line">    version: 2</span><br><span class="line">    secauth: off</span><br><span class="line">    cluster_name: homer-test</span><br><span class="line">    transport: udpu</span><br><span class="line">    rrp_mode: passive</span><br><span class="line">    token: 17000</span><br><span class="line"></span><br><span class="line">    interface &#123;</span><br><span class="line">        ringnumber: 0</span><br><span class="line">        bindnetaddr: 192.168.xx.0</span><br><span class="line">        mcastaddr: 239.255.1.1</span><br><span class="line">        mcastport: 5405</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    interface &#123;</span><br><span class="line">        ringnumber: 1</span><br><span class="line">        bindnetaddr: 172.29.xx.0</span><br><span class="line">        mcastaddr: 239.255.2.1</span><br><span class="line">        mcastport: 5405</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: bgi-sz1-homer-test73</span><br><span class="line">        ring1_addr: 172.29.xx.xx</span><br><span class="line">        nodeid: 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: bgi-sz1-homer-test74</span><br><span class="line">        ring1_addr: 172.29.xx.xx</span><br><span class="line">        nodeid: 2</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: bgi-sz1-homer-test76</span><br><span class="line">        ring1_addr: 172.29.xx.xx</span><br><span class="line">        nodeid: 3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line">    provider: corosync_votequorum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">    to_logfile: yes</span><br><span class="line">    logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</span><br><span class="line">    to_syslog: yes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Start-cluster"><a href="#Start-cluster" class="headerlink" title="Start cluster"></a>Start cluster</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ pcs cluster start --all</span><br><span class="line">$ corosync-cfgtool -s</span><br><span class="line">Printing ring status.</span><br><span class="line">Local node ID 1</span><br><span class="line">RING ID 0</span><br><span class="line">id= 192.168.xx.130</span><br><span class="line">status= ring 0 active with no faults</span><br><span class="line">RING ID 1</span><br><span class="line">id= 172.29.xx.73</span><br><span class="line">status= ring 1 active with no faults</span><br></pre></td></tr></table></figure><h4 id="Create-stonith-for-physical-server-1"><a href="#Create-stonith-for-physical-server-1" class="headerlink" title="Create stonith for physical server"></a>Create stonith for physical server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create node01-fencing fence_ipmilan pcmk_host_list=&quot;nod01&quot; \</span></span><br><span class="line">ipaddr=<span class="string">&quot;node1_ipmi_ipaddr&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node02-fencing fence_ipmilan pcmk_host_list=&quot;node02&quot; \</span></span><br><span class="line"> ipaddr=<span class="string">&quot;node2_ipmi_ipaddr&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node03-fencing fence_ipmilan pcmk_host_list=&quot;node03&quot; \</span></span><br><span class="line">ipaddr=<span class="string">&quot;node3_ipmi_ipaddr&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 op \</span><br><span class="line">monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs property set stonith-enabled=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: ha-cluster</span><br><span class="line">...</span><br><span class="line">Online: [ node02 node03 node01 ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> node01-fencing(stonith:fence_ipmilan):Started node02</span><br><span class="line"> node03-fencing(stonith:fence_ipmilan):Started node01</span><br><span class="line"> node02-fencing(stonith:fence_ipmilan):Started node03</span><br><span class="line"></span><br><span class="line">PCSD Status:</span><br><span class="line">  node03: Online</span><br><span class="line">  node01: Online</span><br><span class="line">  node02: Online</span><br><span class="line"></span><br><span class="line">Daemon Status:</span><br><span class="line">  corosync: active/disabled</span><br><span class="line">  pacemaker: active/disabled</span><br><span class="line">  pcsd: active/enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Get-quorum-info-1"><a href="#Get-quorum-info-1" class="headerlink" title="Get quorum info"></a>Get quorum info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ corosync-quorumtool</span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Mon Mar 13 22:08:01 2017</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000001</span><br><span class="line">Ring ID:          1/568</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2  </span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000001          1 192.168.xx.130 (<span class="built_in">local</span>)</span><br><span class="line">0x00000002          1 192.168.xx.131</span><br><span class="line">0x00000003          1 192.168.xx.132</span><br><span class="line"></span><br><span class="line">$ </span><br><span class="line"></span><br><span class="line">$  corosync-cmapctl|grep members</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(192.168.xx.130) r(1) ip(172.29.xx.73) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.status (str) = joined</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.ip (str) = r(0) ip(192.168.xx.131) r(1) ip(172.29.xx.74) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.status (str) = joined</span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.ip (str) = r(0) ip(192.168.xx.132) r(1) ip(172.29.xx.76) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.status (str) = joined</span><br></pre></td></tr></table></figure><h4 id="backup-and-restore-configuration"><a href="#backup-and-restore-configuration" class="headerlink" title="backup and restore configuration"></a>backup and restore configuration</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pcs cluster cib &gt; xx.xml</span><br><span class="line">$ pcs cluster cib-push xx.xml</span><br><span class="line"></span><br><span class="line">$ pcs config</span><br></pre></td></tr></table></figure><h4 id="Create-resources"><a href="#Create-resources" class="headerlink" title="Create resources"></a>Create resources</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource create VirtualIP1 ocf:heartbeat:IPaddr2 ip=10.0.0.77 cidr_netmask=8 nic=br0 op monitor interval=60s</span><br><span class="line">$ pcs constraint location VirtualIP prefers bgi-sz1-homer-test73=0</span><br><span class="line"></span><br><span class="line">$ pcs resource create ansible-kvm VirtualDomain hypervisor=<span class="string">&quot;qemu:///system&quot;</span> config=<span class="string">&quot;/export/glusterfs/vms/kvm/xml/ansible-kvm.xml&quot;</span> migration_transport=ssh op start timeout=<span class="string">&quot;60s&quot;</span> op stop timeout=<span class="string">&quot;60s&quot;</span> op monitor  timeout=<span class="string">&quot;30&quot;</span> interval=<span class="string">&quot;20&quot;</span>  meta allow-migrate=<span class="string">&quot;true&quot;</span> op migrate_from interval=<span class="string">&quot;0&quot;</span> timeout=<span class="string">&quot;120s&quot;</span> op migrate_to interval=<span class="string">&quot;0&quot;</span> timeout=<span class="string">&quot;120&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if you want add to group, add --group xxx</span></span><br><span class="line">$ pcs resource create ansible-kvm VirtualDomain hypervisor=<span class="string">&quot;qemu:///system&quot;</span> config=<span class="string">&quot;/export/glusterfs/vms/kvm/xml/ansible-kvm.xml&quot;</span> migration_transport=ssh op start timeout=<span class="string">&quot;60s&quot;</span> op stop timeout=<span class="string">&quot;60s&quot;</span> op monitor  timeout=<span class="string">&quot;30&quot;</span> interval=<span class="string">&quot;20&quot;</span>  meta allow-migrate=<span class="string">&quot;true&quot;</span> op migrate_from interval=<span class="string">&quot;0&quot;</span> timeout=<span class="string">&quot;120s&quot;</span> op migrate_to interval=<span class="string">&quot;0&quot;</span> timeout=<span class="string">&quot;120&quot;</span> --group GROUP-A</span><br><span class="line"></span><br><span class="line"><span class="comment"># http</span></span><br><span class="line"><span class="comment"># pcs resource create webres apache configfile=&quot;/etc/httpd/conf/httpd.conf&quot; statusurl=&quot;http://127.0.0.1/server-status&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Create-the-resource-group"><a href="#Create-the-resource-group" class="headerlink" title="Create the resource group"></a>Create the resource group</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource group add GROUP-A resource-1 resource-2 resource-3</span><br></pre></td></tr></table></figure><h4 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crm_mon</span><br><span class="line">pcs status nodes</span><br></pre></td></tr></table></figure><h4 id="Standby-and-maintance"><a href="#Standby-and-maintance" class="headerlink" title="Standby and maintance"></a>Standby and maintance</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pcs cluster standby</span><br><span class="line">pcs cluster unstandby</span><br><span class="line">pcs cluster stop</span><br><span class="line">pcs cluster stop --all</span><br><span class="line"></span><br><span class="line"><span class="comment">#BAN&quot; the resource group  in which you would like to stop the cluster services</span></span><br><span class="line">pcs resource ban resource-name node-name</span><br><span class="line"></span><br><span class="line"><span class="comment">#maintenance</span></span><br><span class="line">pcs property <span class="built_in">set</span> maintenance-mode=<span class="literal">true</span></span><br><span class="line">pcs property <span class="built_in">set</span> maintenance-mode=flase </span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Resource-constraint"><a href="#Resource-constraint" class="headerlink" title="Resource constraint"></a>Resource constraint</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ pcs constraint</span><br><span class="line">Location Constraints:</span><br><span class="line">  Resource: VirtualIP</span><br><span class="line">    Enabled on: bgi-sz1-homer-test73 (score:0)</span><br><span class="line">  Resource: VirtualIP2</span><br><span class="line">    Enabled on: bgi-sz1-homer-test74 (score:0)</span><br><span class="line">  Resource: VirtualIP3</span><br><span class="line">    Enabled on: bgi-sz1-homer-test76 (score:0)</span><br><span class="line">Ordering Constraints:</span><br><span class="line">Colocation Constraints:</span><br><span class="line">Ticket Constraints:</span><br><span class="line"></span><br><span class="line">$ pcs constraint location resource-name prefers nodename=50</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using location constraint, you can also avoid specific node to run a particular resource</span></span><br><span class="line">$ pcs constraint location resource-name avoids nodename=50</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Resource-order"><a href="#Resource-order" class="headerlink" title="Resource order"></a>Resource order</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create</span></span><br><span class="line">$ pcs constraint order resource1 <span class="keyword">then</span> resource2</span><br><span class="line">$ pcs constraint order resource2 <span class="keyword">then</span> resource3</span><br><span class="line">$ pcs constraint</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove</span></span><br><span class="line">$ pcs constraint order --full</span><br><span class="line">$ pcs constraint order remove resource1 id_output</span><br><span class="line"></span><br><span class="line"><span class="comment"># example</span></span><br><span class="line"></span><br><span class="line">$ pcs constraint order VirtualIP1 <span class="keyword">then</span> manager-kvm</span><br><span class="line">Adding VirtualIP1 manager-kvm (kind: Mandatory) (Options: first-action=start then-action=start)</span><br><span class="line">$ pcs constraint</span><br><span class="line">Location Constraints:</span><br><span class="line">  Resource: VirtualIP</span><br><span class="line">    Enabled on: bgi-sz1-homer-test73 (score:0)</span><br><span class="line">  Resource: VirtualIP2</span><br><span class="line">    Enabled on: bgi-sz1-homer-test74 (score:0)</span><br><span class="line">  Resource: VirtualIP3</span><br><span class="line">    Enabled on: bgi-sz1-homer-test76 (score:0)</span><br><span class="line">Ordering Constraints:</span><br><span class="line">  start VirtualIP1 <span class="keyword">then</span> start manager-kvm (kind:Mandatory)</span><br><span class="line">Colocation Constraints:</span><br><span class="line">Ticket Constraints:</span><br><span class="line"></span><br><span class="line">$ pcs constraint order --full</span><br><span class="line">Ordering Constraints:</span><br><span class="line">  start VirtualIP1 <span class="keyword">then</span> start manager-kvm (kind:Mandatory) (id:order-VirtualIP1-manager-kvm-mandatory)</span><br><span class="line"></span><br><span class="line"><span class="comment">#input id</span></span><br><span class="line">$ pcs constraint order remove VirtualIP1 order-VirtualIP1-manager-kvm-mandatory</span><br><span class="line">$ pcs constraint order --full</span><br><span class="line">Ordering Constraints:</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Resource-migration"><a href="#Resource-migration" class="headerlink" title="Resource migration"></a>Resource migration</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource update resource-name meta migration-threshold=<span class="string">&quot;2&quot;</span></span><br><span class="line">or </span><br><span class="line">$ pcs resource defaults migration-threshold=2</span><br><span class="line"></span><br><span class="line">$ pcs resource update resource-name meta failure-timeout=60s</span><br><span class="line">$ pcs resource show resource-name</span><br><span class="line"><span class="comment"># show fail-count</span></span><br><span class="line">$ pcs resource failcount show</span><br><span class="line">or</span><br><span class="line">$ crm_failcount -r resource-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># reset the fail-counts </span></span><br><span class="line">$ pcs resource failcount reset resource-name node-name</span><br><span class="line">or </span><br><span class="line">$ pcs resource cleanup resource-name</span><br><span class="line">$ pcs resource failcount show  resource-name</span><br></pre></td></tr></table></figure><h4 id="Not-move-resource-back"><a href="#Not-move-resource-back" class="headerlink" title="Not move resource back"></a>Not move resource back</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource defaults resource-stickiness=100</span><br><span class="line">$ pcs resource defaults</span><br></pre></td></tr></table></figure><h4 id="Colocation-constraint"><a href="#Colocation-constraint" class="headerlink" title="Colocation constraint"></a>Colocation constraint</h4><p>A colocation constraint determines that the location of one resource depends on the location of another resource</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pcs constraint colocation add resource1 resource2 INFINITY</span><br><span class="line">$ pcs constraint colocation add resource1 with resource2 INFINITY</span><br><span class="line"><span class="comment">#remove</span></span><br><span class="line">$ pcs constraint --full</span><br><span class="line"></span><br><span class="line">$ pcs constraint colocation remove resource1</span><br></pre></td></tr></table></figure><h4 id="Resource-location"><a href="#Resource-location" class="headerlink" title="Resource location"></a>Resource location</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ pcs constraint location resource-name prefers node1</span><br><span class="line">$ pcs constraint location resource-name avoids node1</span><br><span class="line">$ pcs constraint --full</span><br><span class="line">$ pcs constraint location remove location-resource-name</span><br><span class="line">$ pcs constraint location resource-name prefers node1=INFINITY</span><br><span class="line">$ crm_simulate -sL <span class="comment"># get resource score</span></span><br><span class="line"><span class="comment"># Resource pefer node1,node2,node3</span></span><br><span class="line">pcs constraint location resource-name prefers node1=200</span><br><span class="line">pcs constraint location resource-name prefers node2=100</span><br><span class="line">pcs constraint location resource-name prefers node3=0</span><br></pre></td></tr></table></figure><h4 id="Update-resource-config"><a href="#Update-resource-config" class="headerlink" title="Update resource config"></a>Update resource config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource update ansible-kvm config=/opt/lustresz/DAS_NFS/vms/HA-kvm/homerl/config/ansible-kvm.xml </span><br></pre></td></tr></table></figure><h4 id="Manage-resource"><a href="#Manage-resource" class="headerlink" title="Manage resource"></a>Manage resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource <span class="built_in">disable</span> resource-name    </span><br><span class="line">$ pcs resource <span class="built_in">enable</span> resource-name    </span><br><span class="line">$ pcs resource failcount show resource-name </span><br><span class="line">$ pcs resource failcount reset resource-name</span><br><span class="line">$ pcs resource cleanup resource-name</span><br></pre></td></tr></table></figure><h4 id="Clear-error-output"><a href="#Clear-error-output" class="headerlink" title="Clear error output"></a>Clear error output</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource cleanup</span><br></pre></td></tr></table></figure><h4 id="Check-cluster-status"><a href="#Check-cluster-status" class="headerlink" title="Check cluster status"></a>Check cluster status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crm_verify -L -V</span><br></pre></td></tr></table></figure><h3 id="Destroy-cluster"><a href="#Destroy-cluster" class="headerlink" title="Destroy cluster"></a>Destroy cluster</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pcs cluster destroy --all</span><br><span class="line"></span><br><span class="line"><span class="comment">#or </span></span><br><span class="line">systemctl stop pacemaker corosync</span><br><span class="line">rm -f /var/<span class="class"><span class="keyword">lib</span>/<span class="title">pacemaker</span>/<span class="title">cib</span>/*</span></span><br></pre></td></tr></table></figure><p>Reference<br><a href="http://www.unixarena.com/2016/01/rhel-7-pacemaker-define-the-resource-behaviour.html">RHEL 7  Pacemaker</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/s1-multistateresource-HAAR.html">High_Availability_Add-On_Reference</a></p>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> test </tag>
            
            <tag> ha </tag>
            
            <tag> virt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Replace HDD for openzfs</title>
      <link href="2015/12/04/openzfs-replace/"/>
      <url>2015/12/04/openzfs-replace/</url>
      
        <content type="html"><![CDATA[<h3 id="Replace-HDD-when-raidz-has-degraded"><a href="#Replace-HDD-when-raidz-has-degraded" class="headerlink" title="Replace HDD when raidz has degraded"></a>Replace HDD when raidz has degraded</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$  zpool replace tank -f sdar</span><br><span class="line">$  zpool status</span><br><span class="line">  pool: tank</span><br><span class="line"> state: DEGRADED</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line">        <span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:45:26 2015</span><br><span class="line">    91.6M scanned out of 66.9T at 9.16M/s, (scan is slow, no estimated time)</span><br><span class="line">    3.94M resilvered, 0.00% <span class="keyword">done</span></span><br><span class="line">......</span><br><span class="line">          raidz2-3                  DEGRADED     0     0     0</span><br><span class="line">            sdal                    ONLINE       0     0     0</span><br><span class="line">            sdam                    ONLINE       1    90     0</span><br><span class="line">            sdan                    ONLINE       0     0     0</span><br><span class="line">            sdao                    ONLINE       0     0     0</span><br><span class="line">            sdap                    ONLINE       0     0     0</span><br><span class="line">            sdaq                    ONLINE       0     0     0</span><br><span class="line">            replacing-6             UNAVAIL      0     0     0</span><br><span class="line">              old                   UNAVAIL    101     0     0</span><br><span class="line">              sdar                  ONLINE       0     0     0  (resilvering)</span><br><span class="line">            sdas                    ONLINE       0     0     0</span><br><span class="line">            sdat                    ONLINE       0     0     0</span><br><span class="line">            sdau                    ONLINE       0     0     0</span><br><span class="line">            sdav                    ONLINE       0     0     0</span><br><span class="line">        spares</span><br><span class="line">          scsi-35000c50021387d97    AVAIL</span><br><span class="line">          sdak                      AVAIL</span><br><span class="line">          sdaw                      AVAIL</span><br></pre></td></tr></table></figure><h3 id="Replace-broken-HDD-and-insert-a-new-HDD-to-JBOD-enclosure"><a href="#Replace-broken-HDD-and-insert-a-new-HDD-to-JBOD-enclosure" class="headerlink" title="Replace broken HDD, and insert a new HDD to JBOD enclosure"></a>Replace broken HDD, and insert a new HDD to JBOD enclosure</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">$ zpool status</span><br><span class="line">  pool: tank</span><br><span class="line"> state: DEGRADED</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line">        <span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:45:26 2015</span><br><span class="line">    90.5G scanned out of 66.9T at 232M/s, 83h45m to go</span><br><span class="line">    4.09G resilvered, 0.13% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME                        STATE     READ WRITE CKSUM</span><br><span class="line">        tank                        DEGRADED     0     0     0</span><br><span class="line">          raidz2-0                  DEGRADED     0     0     0</span><br><span class="line">            scsi-35000c500212bff8b  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bed8f  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c24d7  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c1bdb  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212b9a0b  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c50034d625f7  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500575f9a87  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212baaeb  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bdcd3  UNAVAIL     33     0     0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ls /dev/disk/by-id/scsi-35000c500212bdcd3</span><br><span class="line">ls: cannot access /dev/disk/by-id/scsi-35000c500212bdcd3: No such file or directory</span><br><span class="line"></span><br><span class="line">$ zpool replace tank scsi-35000c500212bdcd3</span><br><span class="line">cannot open <span class="string">&#x27;scsi-35000c500212bdcd3&#x27;</span>: no such device <span class="keyword">in</span> /dev</span><br><span class="line">must be a full path or shorthand device name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ dmesg</span><br><span class="line">.....</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Spinning up disk....................ready</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] 3907029168 512-byte logical blocks: (2.00 TB/1.81 TiB)</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Write Protect is off</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Write cache: enabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sdk: unknown partition table</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Attached SCSI disk</span><br><span class="line"></span><br><span class="line"><span class="comment">#new hdd is sdk</span></span><br><span class="line">$ zpool add tank spare sdk</span><br><span class="line">        spares</span><br><span class="line">          scsi-35000c50021387d97    AVAIL</span><br><span class="line">          sdak                      AVAIL</span><br><span class="line">          sdaw                      AVAIL</span><br><span class="line">          sdk                       AVAIL</span><br><span class="line"></span><br><span class="line">$ zpool replace tank scsi-35000c500212bdcd3 sdk</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:57:53 2015</span><br><span class="line">    141M scanned out of 66.9T at 7.83M/s, (scan is slow, no estimated time)</span><br><span class="line">    8.72M resilvered, 0.00% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME                          STATE     READ WRITE CKSUM</span><br><span class="line">        tank                          DEGRADED     0     0     0</span><br><span class="line">          raidz2-0                    DEGRADED     0     0     0</span><br><span class="line">            scsi-35000c500212bff8b    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bed8f    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c24d7    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c1bdb    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212b9a0b    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c50034d625f7    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500575f9a87    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212baaeb    ONLINE       0     0     0</span><br><span class="line">            spare-8                   UNAVAIL      0     0     0</span><br><span class="line">              scsi-35000c500212bdcd3  UNAVAIL     33     0     0</span><br><span class="line">              sdk                     ONLINE       0     0     0  (resilvering)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Well done, its worked.</p><p>remove the UNAVAIL device</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zpool detach tank scsi-35000c500212bdcd3</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Online dropbox with socks5 proxy (command line)</title>
      <link href="2015/12/01/dropbox/"/>
      <url>2015/12/01/dropbox/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.dropboxforum.com/hc/en-us/community/posts/204324076-Drop-manual-proxy-setting-not-working-">Manual proxy setting not working</a><br>I have the same problem. </p><a id="more"></a><p>Linux Distribution: <a href="http://pinguyos.com/">PinguyOS</a> base ubuntu 14.04.3 LTS</p><p>Try</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=socks5://username:passwd@socks5_proxy_ip:port</span><br></pre></td></tr></table></figure><p>Its not work too. Maybe need to Add </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=<span class="string">&quot;socks5://username:passwd@socks5_proxy_ip:port&quot;</span></span><br></pre></td></tr></table></figure><p>Forward socks proxy to http</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo aptitude install privoxy</span><br><span class="line"></span><br><span class="line">$ cat /etc/privoxy/config</span><br><span class="line">...</span><br><span class="line">listen-address 127.0.0.1:1081</span><br><span class="line">forward-socks5 / 127.0.0.1:1080 .</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ sudo /etc/init.d/privoxy start</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Try again</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> http_proxy=<span class="string">&quot;http://127.0.0.1:1081&quot;</span></span><br><span class="line">$ ~/.dropbox-dist/dropboxd</span><br><span class="line">or </span><br><span class="line">$ dropbox start -i</span><br></pre></td></tr></table></figure><p>Nice, Its worked<br><img src="/img/dropbox_online.png"> </p><h3 id="proxychains"><a href="#proxychains" class="headerlink" title="proxychains"></a>proxychains</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep proxychains4 | grep -v grep | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="built_in">kill</span></span><br><span class="line">pkill dropbox</span><br><span class="line">proxychains4 caja-dropbox start -i &amp;</span><br><span class="line"></span><br><span class="line">cat /etc/proxychains.conf</span><br><span class="line">strict_chain</span><br><span class="line">proxy_dns</span><br><span class="line">remote_dns_subnet 224</span><br><span class="line">tcp_read_time_out 15000</span><br><span class="line">tcp_connect_time_out 8000</span><br><span class="line">[ProxyList]</span><br><span class="line">socks5 127.0.0.1 <span class="variable">$your_socks5_port</span></span><br></pre></td></tr></table></figure><h3 id="OpenJDK-javaws-socks-proxy"><a href="#OpenJDK-javaws-socks-proxy" class="headerlink" title="OpenJDK javaws socks proxy"></a><a href="http://palimpsest.minivi.com/java/web-start/socks/">OpenJDK javaws socks proxy</a></h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~/.config/icedtea-web/deployment.properties:</span><br><span class="line"></span><br><span class="line">deployment.proxy.socks.<span class="attribute">port</span>=10443</span><br><span class="line">deployment.proxy.<span class="attribute">same</span>=<span class="literal">true</span></span><br><span class="line">deployment.proxy.socks.<span class="attribute">host</span>=localhost</span><br><span class="line">deployment.proxy.<span class="attribute">type</span>=1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> privoxy </tag>
            
            <tag> proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Recover openzfs partition table</title>
      <link href="2015/11/20/recovery-zfs-partition-table/"/>
      <url>2015/11/20/recovery-zfs-partition-table/</url>
      
        <content type="html"><![CDATA[<h3 id="backup-partition-table"><a href="#backup-partition-table" class="headerlink" title="backup partition table"></a>backup partition table</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MBR</span></span><br><span class="line">sfdisk -d /dev/sda &gt; /tmp/sda.bak</span><br><span class="line">sfdisk /dev/sda &lt; /tmp/sda.bak</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/sda of=/dev/sdb bs=512 count=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># GPT</span></span><br><span class="line">sgdisk --backup=table /dev/sda</span><br><span class="line">sgdisk --load-backup=table /dev/sdb</span><br><span class="line">sgdisk -G /dev/sdb</span><br><span class="line"></span><br><span class="line">B=$(parted -ms /dev/sda <span class="built_in">print</span> |tail -1|cut -b1)</span><br><span class="line">A=$((<span class="number">128</span>*B)+<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">dd if=/dev/sda of=GPT_TABLE bs=<span class="number">1</span> count=<span class="variable">$A</span></span><br><span class="line">dd if=GPT_TABLE of=/dev/sdb</span><br><span class="line">partprobe /dev/sdb</span><br></pre></td></tr></table></figure><p>Backup is very important</p><h3 id="Damage-command"><a href="#Damage-command" class="headerlink" title="Damage command"></a>Damage command</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">950  parted /dev/sdb rm 1</span><br><span class="line">951  df -h</span><br><span class="line">952  zpool status</span><br><span class="line">953  zpool destroy tank</span><br><span class="line">954  yum remove $(rpm -qa | grepzfs)</span><br><span class="line">955 parted -a cylinder /dev/sdb mkpart primary 0 100%</span><br><span class="line"><span class="comment"># same parted commmand with created</span></span><br></pre></td></tr></table></figure><p>zpool -D improt failed, </p><h3 id="Found-uberblock-tag-label"><a href="#Found-uberblock-tag-label" class="headerlink" title="Found uberblock tag label"></a>Found uberblock tag label</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dd if=/dev/sdb1 of=label-2m bs=1M count=2</span></span><br></pre></td></tr></table></figure><p>The begin address is 011bc00-128KB, and after 256KB is the uberblock<br>You can use zdb -l 256KB-file, you could get zpool info<br>zfs magic number is 0cb1 ba00<br><img src="/img/uberblock_tag.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># awk &#x27;BEGIN&#123;printf &quot;%x&quot;,0x011bc00-0x0020000&quot;\n&quot;&#125;&#x27;</span></span><br><span class="line">fbc00</span><br><span class="line"><span class="comment"># awk &#x27;BEGIN&#123;printf &quot;%x&quot;,0x011bc00+0x0020000&quot;\n&quot;&#125;&#x27;</span></span><br><span class="line">13bc00</span><br></pre></td></tr></table></figure><p>The address is from fbc00 to 13bc00</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;print (strtonum(&quot;0xfbc00&quot;))/1024&#125;&#x27;</span></span><br><span class="line">1007</span><br></pre></td></tr></table></figure><p>The begin address in 1007K of the disk (sdb1)</p><h3 id="Create-a-new-zpool-in-another-disk"><a href="#Create-a-new-zpool-in-another-disk" class="headerlink" title="Create a new zpool in another disk"></a>Create a new zpool in another disk</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parted -a cylinder /dev/sdd mkpart primary 0 100%a</span></span><br><span class="line"><span class="comment"># zpool create tank /dev/sdd1</span></span><br><span class="line"><span class="comment"># dd if=/dev/sdd1 of=label-sdd bs=1M count=2</span></span><br></pre></td></tr></table></figure><p><img src="/img/uberblock_tag2.png"><br>The tag at 0021000, and there are nothing in previous part except zero</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dd if=/dev/zero of=/dev/sdc1 bs=4k count=1</span></span><br><span class="line"><span class="comment"># dd if=/dev/sdb1 of=/dev/sdc1 bs=512 skip=2014 #offset 1007KB</span></span><br></pre></td></tr></table></figure><p>You can use zdb get infomation from sdc1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">version: 5000</span><br><span class="line">name: <span class="string">&#x27;tank&#x27;</span></span><br><span class="line">state: 2</span><br><span class="line">txg: 1256237</span><br><span class="line">pool_guid: 10281825564445304044</span><br><span class="line">errata: 0</span><br><span class="line">hostname: <span class="string">&#x27;nas-56-11.local&#x27;</span></span><br><span class="line">top_guid: 8832263634429449792</span><br><span class="line">guid: 8832263634429449792</span><br><span class="line">vdev_children: 1</span><br><span class="line">vdev_tree:</span><br><span class="line">    <span class="built_in">type</span>: <span class="string">&#x27;disk&#x27;</span></span><br><span class="line">    id: 0</span><br><span class="line">    guid: 8832263634429449792</span><br><span class="line">    path: <span class="string">&#x27;/dev/sdb1&#x27;</span></span><br><span class="line">    whole_disk: 1</span><br><span class="line">    metaslab_array: 33</span><br><span class="line">    metaslab_shift: 37</span><br><span class="line">    ashift: 12</span><br><span class="line">    asize: 17990975750144</span><br><span class="line">    is_log: 0</span><br><span class="line">    create_txg: 4</span><br></pre></td></tr></table></figure><p>When you dd complete. Use zpool -D import tank import the loss pool.<br>The disk is a hardraid , There are 17TB important data in it. It really scared the heck out of me.<br>Really Thank Javen Wu very much, Because your help these data could be recovery.</p><h3 id="About-partition-table"><a href="#About-partition-table" class="headerlink" title="About partition table"></a><a href="https://unix.stackexchange.com/questions/103919/how-do-i-find-the-offset-of-an-ext4-filesystem">About partition table</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Starting at (512-byte) sector 63. This was the tradition <span class="keyword">for</span> a very long time, and worked until someone came up with 4K disks...</span><br><span class="line">Starting at (512-byte) sector 2048. This is the new tradition, to accommodate 4K disks.</span><br><span class="line">A bonus option! Sarting at sector 56. This is what happens <span class="keyword">if</span> someone moves the 63-start partition to make it align with a 4K sector.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zfs </tag>
            
            <tag> gpt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Deploy Lfs and OpenZFS</title>
      <link href="2015/11/06/deploy_lfs_and_zfs/"/>
      <url>2015/11/06/deploy_lfs_and_zfs/</url>
      
        <content type="html"><![CDATA[<h2 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h2><h3 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h3><ul><li>2 x SuperMicro SSG-6028R-E1CR12N (Xeon 2650 v3 8*16G)</li><li>1 x 2U JBOD (216be26-r920lpb) 14 x ST600MP0005 + 2x ST200FM0002 </li><li>2 x LSI Syncro CS 9286-8e (installed in MDS)</li></ul><h3 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h3><ul><li>4 x SuperMicro SSG-6028R-E1CR12N (Xeon 2630v3 8*8G)</li><li>4 x JBOD (SC847DE26-R2K02JBOD, installed 74 x ST6000NM0034) </li><li>8 x LSI SAS2308 (installed in OSS)</li></ul><h2 id="Software"><a href="#Software" class="headerlink" title="Software"></a>Software</h2><ul><li>OS: CentOS 6.6 x64 2.6.32-504.30.3.el6_lfs.x86_64</li><li>Lfs: 2.5.37.7 (Intel ieel 2.3)</li><li>OpenZFS: 0.6.4-1</li></ul><a id="more"></a><h3 id="LSI-syncro-Architecture"><a href="#LSI-syncro-Architecture" class="headerlink" title="LSI syncro Architecture"></a>LSI syncro Architecture</h3><p><img src="/img/mds.png"></p><h3 id="MDS-Architecture"><a href="#MDS-Architecture" class="headerlink" title="MDS Architecture"></a>MDS Architecture</h3><p><img src="/img/mds-1.png"></p><h3 id="OSS-Architecture"><a href="#OSS-Architecture" class="headerlink" title="OSS Architecture"></a>OSS Architecture</h3><p><img src="/img/oss.png"></p><h2 id="The-Installation-Process"><a href="#The-Installation-Process" class="headerlink" title="The Installation Process"></a>The Installation Process</h2><h3 id="Configure-LSI-syncro-for-MDS"><a href="#Configure-LSI-syncro-for-MDS" class="headerlink" title="Configure LSI syncro for MDS"></a>Configure LSI syncro for MDS</h3><p><img src="/img/config_syncro.png"></p><p>/opt/MegaRAID/storcli/storcli64 /c1 show all</p><p>High Availability :</p><p>Topology Type = Server Storage Cluster<br>Domain Id = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>Peer Controller Status = Active<br>Maximum Controller Nodes = 2<br>Incompatible Details = None</p><h3 id="Install-rpms-for-MDS"><a href="#Install-rpms-for-MDS" class="headerlink" title="Install rpms for MDS"></a>Install rpms for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh dracut-004-388.el6.noarch.rpm dracut-kernel-004-388.el6.noarch.rpm</span><br><span class="line">rpm -ivh e2fsprogs-1.42.12.wc1-7.el6.x86_64.rpm e2fsprogs-1.42.12.wc1-bundle.tar.gz e2fsprogs libs-1.42.12.wc1-7.el6.x86_64.rpm libcom_err-1.42.12.wc1-7.el6.x86_64.rpm libss-1.42.12.wc1-7.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh kernel-2.6.32-504.30.3.el6_lfs.x86_64.rpm kernel-devel-2.6.32-504.30.3.el6_lfs.x86_64.rpm kernel-firmware-2.6.32-504.30.3.el6_lfs.x86_64.rpm kernel-headers-2.6.32-504.30.3.el6_lfs.x86_64.rpm lfs-modules-2.5.37.7-2.6.32_504.30.3.el6_lfs.x86_64.x86_64.rpm lfs-2.5.37.7-2.6.32_504.30.3.el6_lfs.x86_64.x86_64.rpm lfs-osd-ldiskfs-2.5.37.7-2.6.32_504.30.3.el6_lfs.x86_64.x86_64.rpm lfs-osd-ldiskfs-mount-2.5.37.7-2.6.32_504.30.3.el6_lfs.x86_64.x86_64.rpm</span><br></pre></td></tr></table></figure><h3 id="Configuration-file-for-MDS"><a href="#Configuration-file-for-MDS" class="headerlink" title="Configuration file for MDS"></a>Configuration file for MDS</h3><p>disable selinux and iptables</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">&quot;options lnet networks=tcp(bond0)&quot;</span> &gt; /etc/modprobe.d/lnet.conf</span><br><span class="line">bond0 is data transfer network device</span><br><span class="line"></span><br><span class="line">pvcreate /dev/sdb</span><br><span class="line">vgcreate mds_data /dev/sdb</span><br><span class="line">lvcreate -l 2%VG -n mgt_lv mds_data</span><br><span class="line">lvcreate -l 98%VG -n mdt_lv mds_data</span><br></pre></td></tr></table></figure><p>If you want deactivate it , you can use vgchange -cn volume group</p><h3 id="Exclude-os-volume-group"><a href="#Exclude-os-volume-group" class="headerlink" title="Exclude os volume group"></a>Exclude os volume group</h3><p>edit /etc/lvm/lvm.conf in mds1 </p><figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">volume_list</span> =<span class="meta"> [ &quot;vg_mds1&quot;, &quot;@MDS-11-1&quot; ]</span></span><br><span class="line"><span class="attribute">locking_type</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dracut -f </span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h3 id="Create-Lfs-file-system-for-MDS"><a href="#Create-Lfs-file-system-for-MDS" class="headerlink" title="Create Lfs file system for MDS"></a>Create Lfs file system for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkfs.lfs --reformat --mgs --servicenode=10.x.x.1@tcp --servicenode=10.x.x.2@tcp /dev/mapper/mds_data-mgt_lv</span><br><span class="line"></span><br><span class="line">mkfs.lfs --reformat --mdt --fsname=lfswh --index=0 --mgsnode=10.xx.xx.1@tcp --mgsnode=10.xx.xx.2@tcp  --servicenode=10.x.x.1@tcp --servicenode=10.x.x.2@tcp  /dev/mapper/mds_data-mdt_lv</span><br></pre></td></tr></table></figure><p>You can mount the device where you want</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/dev/mapper/mds_data-mdt_lv  lfs  2.5T  328M  2.3T   1% /lfs/mdt</span><br><span class="line">/dev/mapper/mds_data-mgt_lv  lfs  66G   54M   63G   1% /lfs/mgt</span><br></pre></td></tr></table></figure><h3 id="Prepare-create-HA-cluster"><a href="#Prepare-create-HA-cluster" class="headerlink" title="Prepare create HA cluster"></a>Prepare create HA cluster</h3><p>MDS1  eth0 192.xx.xx.1 (ipmi)<br>      eth1 192.168.1.1 (heartbeat)<br>      eth4 10.xx.xx.1  (production data)</p><p>MDS2  eth0 192.xx.xx.2<br>      eth1 192.168.1.2<br>      eth4 10.xx.xx.2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pacemaker corosync pcs fence-agents resource-agents</span><br></pre></td></tr></table></figure><p>config corosync.conf to /etc/corosync/</p><h3 id="corosync-conf-j2-ansible"><a href="#corosync-conf-j2-ansible" class="headerlink" title="corosync.conf.j2 (ansible)"></a>corosync.conf.j2 (ansible)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#Please read the corosync.conf<span class="number">.5</span> manual page</span><br><span class="line">compatibility: whitetank</span><br><span class="line"></span><br><span class="line">totem &#123;</span><br><span class="line">version: <span class="number">2</span></span><br><span class="line">secauth: off</span><br><span class="line">interface &#123;</span><br><span class="line">member &#123;</span><br><span class="line">memberaddr: &#123;&#123; nicA1 &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">member &#123;</span><br><span class="line">memberaddr: &#123;&#123; nicB1 &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">ringnumber: <span class="number">0</span></span><br><span class="line">bindnetaddr: &#123;&#123; bind1 &#125;&#125;</span><br><span class="line">mcastport: <span class="number">5406</span></span><br><span class="line">ttl: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">interface &#123;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: &#123;&#123; nicA2 &#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: &#123;&#123; nicB2 &#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ringnumber: <span class="number">1</span></span><br><span class="line">                bindnetaddr: &#123;&#123; bind2 &#125;&#125;</span><br><span class="line">                mcastport: <span class="number">5406</span></span><br><span class="line">                ttl: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">transport: udpu</span><br><span class="line">token: <span class="number">17000</span></span><br><span class="line">rrp_mode: passive</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">fileline: off</span><br><span class="line">to_logfile: yes</span><br><span class="line">to_syslog: yes</span><br><span class="line">debug: on</span><br><span class="line">logfile: /var/<span class="built_in">log</span>/cluster/corosync.<span class="built_in">log</span></span><br><span class="line">debug: off</span><br><span class="line">timestamp: on</span><br><span class="line">logger_subsys &#123;</span><br><span class="line">subsys: AMF</span><br><span class="line">debug: off</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="etc-corosync-service-d-pacemaker"><a href="#etc-corosync-service-d-pacemaker" class="headerlink" title="/etc/corosync/service.d/pacemaker"></a>/etc/corosync/service.d/pacemaker</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service &#123;</span><br><span class="line">        # Load the Pacemaker Cluster Resource Manager</span><br><span class="line">        name: pacemaker</span><br><span class="line">        ver:  <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="etc-hosts"><a href="#etc-hosts" class="headerlink" title="/etc/hosts"></a>/etc/hosts</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>   <span class="string">localhost</span> <span class="string">localhost.localdomain</span> <span class="string">localhost4</span> <span class="string">localhost4.localdomain4</span></span><br><span class="line"><span class="string">:1</span>         <span class="string">localhost</span> <span class="string">localhost.localdomain</span> <span class="string">localhost6</span> <span class="string">localhost6.localdomain6</span></span><br><span class="line"><span class="number">10.</span><span class="string">xx.xx.1</span>  <span class="string">MDS-11-1</span></span><br><span class="line"><span class="number">10.</span><span class="string">xx.xx.2</span>  <span class="string">MDS-11-2</span></span><br><span class="line"><span class="number">10.</span><span class="string">xx.xx.4</span>  <span class="string">OSS-11-4</span></span><br><span class="line"><span class="number">10.</span><span class="string">xx.xx.5</span>  <span class="string">OSS-11-5</span></span><br><span class="line"><span class="number">10.</span><span class="string">xx.xx.6</span>  <span class="string">OSS-11-6</span></span><br><span class="line"><span class="number">10.</span><span class="string">xx.xx.7</span>  <span class="string">OSS-11-7</span></span><br><span class="line"><span class="number">192.</span><span class="string">xx.xx.1</span> <span class="string">MDS-11-1.ipmi</span></span><br><span class="line"><span class="number">192.</span><span class="string">xx.xx.2</span> <span class="string">MDS-11-2.ipmi</span></span><br><span class="line"><span class="number">192.</span><span class="string">xx.xx.4</span> <span class="string">OSS-11-4.ipmi</span></span><br><span class="line"><span class="number">192.</span><span class="string">xx.xx.5</span> <span class="string">OSS-11-5.ipmi</span></span><br><span class="line"><span class="number">192.</span><span class="string">xx.xx.6</span> <span class="string">OSS-11-6.ipmi</span></span><br><span class="line"><span class="number">192.</span><span class="string">xx.xx.7</span> <span class="string">OSS-11-7.ipmi</span></span><br></pre></td></tr></table></figure><p>If you need install IML, keep the same with your HOSTNAME environment variable and dns resolve.</p><h3 id="Synchronizing-time-for-each-server"><a href="#Synchronizing-time-for-each-server" class="headerlink" title="Synchronizing time for each server"></a>Synchronizing time for each server</h3><p>go to <a href="http://www.pool.ntp.org/en/#top">http://www.pool.ntp.org/en/#top</a></p><h3 id="Enable-service"><a href="#Enable-service" class="headerlink" title="Enable service"></a>Enable service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/corosync start</span><br><span class="line">/etc/init.d/pacemaker restart</span><br><span class="line">/etc/init.d/pcsd start</span><br><span class="line">chkconfig --level 35 corosync on</span><br><span class="line">chkconfig --level 35 pacemaker on</span><br><span class="line">chkconfig --level 35 pcsd on</span><br></pre></td></tr></table></figure><h3 id="Create-HA-cluster-for-MDS"><a href="#Create-HA-cluster-for-MDS" class="headerlink" title="Create HA cluster for MDS"></a>Create HA cluster for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">pcs stonith create mds-11-1-fencing fence_ipmilan pcmk_host_list=<span class="string">&quot;OSS-11-4.local&quot;</span> ipaddr=<span class="string">&quot;192.xx.xx.1&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 op monitor interval=60s</span><br><span class="line">pcs stonith create mds-11-2-fencing fence_ipmilan pcmk_host_list=<span class="string">&quot;OSS-11-4.local&quot;</span> ipaddr=<span class="string">&quot;192.xx.xx.2&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 op monitor interval=60s</span><br><span class="line"></span><br><span class="line">pcs resource create Lfs_mgt ocf:heartbeat:Filesystem device=<span class="string">&quot;/dev/mapper/mds_data-mgt_lv&quot;</span> directory=<span class="string">&quot;/lfs/mgt&quot;</span> fstype=<span class="string">&quot;lfs&quot;</span></span><br><span class="line">pcs resource create Lfs_mdt ocf:heartbeat:Filesystem device=<span class="string">&quot;/dev/mapper/mds_data-mdt_lv&quot;</span> directory=<span class="string">&quot;/lfs/mdt&quot;</span> fstype=<span class="string">&quot;lfs&quot;</span></span><br><span class="line"></span><br><span class="line">pcs resource create mds_lv ocf:heartbeat:LVM volgrpname=mds_data exclusive=<span class="literal">true</span></span><br><span class="line">pcs constraint order mds_lv <span class="keyword">then</span> Lfs_mgt</span><br><span class="line">pcs constraint colocation add Lfs_mgt with mds_lv</span><br><span class="line">pcs constraint order mds_lv <span class="keyword">then</span> Lfs_mdt</span><br><span class="line">pcs constraint colocation add Lfs_mdt with mds_lv</span><br><span class="line"></span><br><span class="line">pcs resource update Lfs_mgt op start interval=0 timeout=300</span><br><span class="line">pcs resource update Lfs_mgt op stop interval=0 timeout=300</span><br><span class="line">pcs resource update Lfs_mgt op monitor interval=5</span><br><span class="line">pcs resource update mds_lv op start interval=0 timeout=300</span><br><span class="line">pcs resource update mds_lv op stop interval=0 timeout=300</span><br><span class="line">pcs resource update mds_lv op monitor interval=5</span><br><span class="line">pcs resource update Lfs_mdt op start interval=0 timeout=300</span><br><span class="line">pcs resource update Lfs_mdt op stop interval=0 timeout=300</span><br><span class="line">pcs resource update Lfs_mdt op monitor interval=5 timeout=60</span><br><span class="line">pcs resource meta Lfs_mgt migration-threshold=5</span><br><span class="line">pcs resource meta Lfs_mdt migration-threshold=5</span><br><span class="line">pcs resource meta mds_lv migration-threshold=5</span><br><span class="line">pcs resource meta Lfs_mdt failure-timeout=120</span><br><span class="line">pcs resource meta Lfs_mgt failure-timeout=120</span><br><span class="line">pcs resource meta mds_lv failure-timeout=120</span><br></pre></td></tr></table></figure><h4 id="pcs-default-setting"><a href="#pcs-default-setting" class="headerlink" title="pcs default setting"></a>pcs default setting</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pcs resource defaults migration-threshold=5</span><br><span class="line"><span class="comment">#pcs resource defaults resource-stickiness=100 # 100means not switch service</span></span><br><span class="line">pcs resource op defaults timeout=360s</span><br><span class="line">pcs resource defaults failure-timeout=360s</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-action=reboot</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="delete-default-value"><a href="#delete-default-value" class="headerlink" title="delete default value"></a>delete default value</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource defaults timouts=    <span class="comment">#not set any value</span></span><br></pre></td></tr></table></figure><h4 id="pcs-status"><a href="#pcs-status" class="headerlink" title="pcs status"></a>pcs status</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cluster name:</span> </span><br><span class="line"><span class="attr">Stack:</span> <span class="string">classic</span> <span class="string">openais</span> <span class="string">(with</span> <span class="string">plugin)</span></span><br><span class="line"><span class="attr">Current DC:</span> <span class="string">MDS-11-2.local</span> <span class="bullet">-</span> <span class="string">partition</span> <span class="string">with</span> <span class="string">quorum</span></span><br><span class="line"><span class="attr">Version:</span> <span class="number">1.1</span><span class="number">.11</span><span class="string">-97629de</span></span><br><span class="line"><span class="number">2</span> <span class="string">Nodes</span> <span class="string">configured,</span> <span class="number">2</span> <span class="string">expected</span> <span class="string">votes</span></span><br><span class="line"><span class="number">4</span> <span class="string">Resources</span> <span class="string">configured</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Online:</span> [ <span class="string">MDS-11-1.local</span> <span class="string">MDS-11-2.local</span> ]</span><br><span class="line"></span><br><span class="line"><span class="attr">Full list of resources:</span></span><br><span class="line"></span><br><span class="line"> <span class="string">mds-11-1-fencing</span> <span class="string">(stonith:fence_ipmilan):</span> <span class="string">Started</span> <span class="string">MDS-11-2.local</span> </span><br><span class="line"> <span class="string">mds-11-2-fencing</span> <span class="string">(stonith:fence_ipmilan):</span> <span class="string">Started</span> <span class="string">MDS-11-2.local</span> </span><br><span class="line"> <span class="string">Lfs_mgt</span> <span class="string">(ocf::heartbeat:Filesystem):</span> <span class="string">Started</span> <span class="string">MDS-11-2.local</span> </span><br><span class="line"> <span class="string">Lfs_mdt</span> <span class="string">(ocf::heartbeat:Filesystem):</span> <span class="string">Started</span> <span class="string">MDS-11-1.local</span> </span><br></pre></td></tr></table></figure><h3 id="About-OSS"><a href="#About-OSS" class="headerlink" title="About OSS"></a>About OSS</h3><p>OSS don t like MDS, it s base openzfs not ldiskfs.<br>OSS need be do 5.1 ~ 5.5 like MDS except 5.2, here is different setting</p><h3 id="Initialization-OpenZFS"><a href="#Initialization-OpenZFS" class="headerlink" title="Initialization OpenZFS"></a>Initialization OpenZFS</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rpm</span> <span class="string">-ivh</span> <span class="string">e2fsprogs-1.42.12.wc1-7.el6.x86_64.rpm</span> <span class="string">e2fsprogs-1.42.12.wc1-bundle.tar.gz</span> <span class="string">e2fsprogs</span> <span class="string">libs-1.42.12.wc1-7.el6.x86_64.rpm</span> <span class="string">libcom_err-1.42.12.wc1-7.el6.x86_64.rpm</span> <span class="string">libss-1.42.12.wc1-7.el6.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="string">rpm</span> <span class="string">-ivh</span> <span class="string">dracut-004-388.el6.noarch.rpm</span> <span class="string">dracut-kernel-004-388.el6.noarch.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="string">rpm</span> <span class="string">-ivh</span> <span class="string">kernel-2.6.32-504.30.3.el6_lfs.x86_64.rpm</span> <span class="string">kernel-devel-2.6.32-504.30.3.el6_lfs.x86_64.rpm</span> <span class="string">kernel-firmware-2.6.32-504.30.3.el6_lfs.x86_64.rpm</span> <span class="string">kernel-headers-2.6.32-504.30.3.el6_lfs.x86_64.rpm</span></span><br></pre></td></tr></table></figure><h3 id="Setting-lnet"><a href="#Setting-lnet" class="headerlink" title="Setting lnet"></a>Setting lnet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">&quot;options lnet networks=tcp(bond0)&quot;</span> &gt; /etc/modprobe.d/lnet.conf</span><br></pre></td></tr></table></figure><h3 id="Limit-zfs-memory-useage-half-memory-to-avoid-OOM-killer"><a href="#Limit-zfs-memory-useage-half-memory-to-avoid-OOM-killer" class="headerlink" title="Limit zfs memory useage(half memory) ,to avoid OOM killer"></a>Limit zfs memory useage(half memory) ,to avoid OOM killer</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">awk</span> <span class="string">&#x27;$0~/MemTotal/ &#123;print &quot;options zfs zfs_arc_max=&quot;$2*1024/2&#125;&#x27;</span> <span class="string">/proc/meminfo</span> <span class="string">&gt;</span> <span class="string">/etc/modprobe.d/zfs.conf</span></span><br></pre></td></tr></table></figure><p>33720700928 = 32GB</p><h3 id="Setting-multipath-SAS-HDD-JBOD"><a href="#Setting-multipath-SAS-HDD-JBOD" class="headerlink" title="Setting multipath (SAS HDD, JBOD)"></a>Setting multipath (SAS HDD, JBOD)</h3><h4 id="etc-multipath-conf"><a href="#etc-multipath-conf" class="headerlink" title="/etc/multipath.conf"></a>/etc/multipath.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">defaults</span> &#123;</span><br><span class="line"><span class="string">polling_interval</span>  <span class="number">10</span></span><br><span class="line"><span class="string">path_selector</span>  <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"><span class="string">path_grouping_policy</span> <span class="string">failover</span></span><br><span class="line"><span class="string">prio</span>   <span class="string">const</span></span><br><span class="line"><span class="string">path_checker</span>  <span class="string">directio</span></span><br><span class="line"><span class="string">rr_min_io</span>  <span class="number">1000</span></span><br><span class="line"><span class="string">max_fds</span>   <span class="number">10240</span></span><br><span class="line"><span class="string">rr_weight</span>  <span class="string">priorities</span></span><br><span class="line"><span class="string">failback</span>  <span class="string">immediate</span></span><br><span class="line"><span class="string">no_path_retry</span>  <span class="string">fail</span></span><br><span class="line"><span class="string">user_friendly_names</span> <span class="literal">no</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">blacklist</span> &#123;</span><br><span class="line">        <span class="string">wwid</span> <span class="string">3600304801b1326001d0b4e480378fac8</span> <span class="comment">##root partition</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you use Dell MD34xx/NetAPP E27xx,Some of LSI chip in your Raid controller<br>You should change some in multipath.conf</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">defaults &#123;</span><br><span class="line"> polling_interval  <span class="number">10</span></span><br><span class="line"> path_selector  <span class="string">&quot;round-robin 0&quot;</span></span><br><span class="line"> path_grouping_policy group_by_prio</span><br><span class="line"> prio   rdac</span><br><span class="line"> path_checker  rdac</span><br><span class="line"> rr_min_io  <span class="number">1000</span></span><br><span class="line"> max_fds    <span class="number">10240</span></span><br><span class="line"> rr_weight  priorities</span><br><span class="line"> failback  immediate</span><br><span class="line"> no_path_retry  <span class="number">30</span></span><br><span class="line"> user_friendly_names no</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h3><h3 id="Install-OpenZFS"><a href="#Install-OpenZFS" class="headerlink" title="Install OpenZFS"></a>Install OpenZFS</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rpm</span> <span class="string">-ivh</span> <span class="string">spl-0.6.4.1-1.el6.src.rpm</span> <span class="string">zfs-0.6.4.1-1.el6.src.rpm</span></span><br><span class="line"><span class="string">rpmbuild</span> <span class="string">-bb</span> <span class="string">-v</span> <span class="string">spl.spec</span></span><br><span class="line"><span class="string">rpmbuild</span> <span class="string">-bb</span> <span class="string">-v</span> <span class="string">zfs.spec</span></span><br><span class="line"><span class="string">rpm</span> <span class="string">-ivh</span> <span class="string">spl-0.6.4.1-1.el6.x86_64.rpm</span> <span class="string">spl-dkms-0.6.4.1-1.el6.noarch.rpm</span> <span class="string">zfs-dkms-0.6.4.1-1.el6.noarch.rpm</span> <span class="string">zfs-0.6.4.1-1.el6.x86_64.rpm</span> <span class="string">libzpool2-0.6.4.1-1.el6.x86_64.rpm</span> <span class="string">libnvpair1-0.6.4.1-1.el6.x86_64.rpm</span> <span class="string">libuutil1-0.6.4.1-1.el6.x86_64.rpm</span> <span class="string">libzfs2-0.6.4.1-1.el6.x86_64.rpm</span> <span class="string">zfs-dracut-0.6.4.1-1.el6.x86_64.rpm</span></span><br></pre></td></tr></table></figure><h4 id="Alias-HDD-name-etc-zfs-vdev-id-conf"><a href="#Alias-HDD-name-etc-zfs-vdev-id-conf" class="headerlink" title="Alias HDD name /etc/zfs/vdev_id.conf"></a>Alias HDD name /etc/zfs/vdev_id.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">multipath</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="string">alias</span> <span class="string">hdd-0-2-0</span> <span class="string">/dev/disk/by-id/dm-uuid-mpath-35000c50062a54f23</span></span><br><span class="line"><span class="string">alias</span> <span class="string">hdd-0-2-1</span> <span class="string">/dev/disk/by-id/dm-uuid-mpath-35000c500630fde27</span></span><br><span class="line"><span class="string">alias</span> <span class="string">hdd-0-2-2</span> <span class="string">/dev/disk/by-id/dm-uuid-mpath-35000c50062d67aa7</span></span><br><span class="line"><span class="string">alias</span> <span class="string">hdd-0-2-3</span> <span class="string">/dev/disk/by-id/dm-uuid-mpath-35000c50062db08ff</span></span><br><span class="line"><span class="string">.......</span></span><br><span class="line"><span class="string">alias</span> <span class="string">hdd-1-5-15</span> <span class="string">/dev/disk/by-id/dm-uuid-mpath-35000c50062fdd8cf</span></span><br></pre></td></tr></table></figure><h4 id="Create-zpool"><a href="#Create-zpool" class="headerlink" title="Create zpool"></a>Create zpool</h4><p>If you care performance ,don t use ashift=9, In my case ,capacity is very important.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool create -f ost-0 -o cachefile=none -o ashift=9 raidz3 hdd-0-2-0 hdd-0-2-1 hdd-0-2-2 hdd-0-2-3 hdd-0-2-4 hdd-0-2-5 hdd-0-2-6 hdd-0-2-7 hdd-0-2-8 hdd-0-2-9 hdd-2-10 hdd-2-11 spare hdd-0-3-15 hdd-0-5-15</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h4 id="create-ost"><a href="#create-ost" class="headerlink" title="create ost"></a>create ost</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">zpool</span> <span class="string">status</span> <span class="string">ost-11</span></span><br><span class="line">  <span class="attr">pool:</span> <span class="string">ost-11</span></span><br><span class="line"> <span class="attr">state:</span> <span class="string">ONLINE</span></span><br><span class="line">  <span class="attr">scan:</span> <span class="string">resilvered</span> <span class="string">710K</span> <span class="string">in</span> <span class="string">0h0m</span> <span class="string">with</span> <span class="number">0</span> <span class="string">errors</span> <span class="string">on</span> <span class="string">Thu</span> <span class="string">Aug</span> <span class="number">20</span> <span class="number">14</span><span class="string">:12:35</span> <span class="number">2015</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>            <span class="string">STATE</span>     <span class="string">READ</span> <span class="string">WRITE</span> <span class="string">CKSUM</span></span><br><span class="line"><span class="string">ost-11</span>          <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">  <span class="string">raidz3-0</span>      <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-1</span>   <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-2</span>   <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-3</span>   <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-5</span>   <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-6</span>   <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-7</span>   <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-9</span>   <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-10</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-11</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-12</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-13</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    <span class="string">hdd-1-5-14</span>  <span class="string">ONLINE</span>       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line"><span class="string">spares</span></span><br><span class="line">  <span class="string">hdd-1-3-15</span>    <span class="string">AVAIL</span>   </span><br><span class="line">  <span class="string">hdd-1-5-15</span>    <span class="string">AVAIL</span>  </span><br></pre></td></tr></table></figure><h4 id="Enable-ZFS-features"><a href="#Enable-ZFS-features" class="headerlink" title="Enable ZFS features"></a>Enable ZFS features</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    zfs <span class="built_in">set</span> acltype=posixacl ost-<span class="variable">$i</span>; </span><br><span class="line">    zfs <span class="built_in">set</span> compression=lz4 ost-<span class="variable">$i</span>; </span><br><span class="line">    zfs <span class="built_in">set</span> xattr=sa ost-<span class="variable">$i</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="Format-zfs"><a href="#Format-zfs" class="headerlink" title="Format zfs"></a>Format zfs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mkfs.lfs --reformat --ost --backfstype=zfs --fsname=lfswh --index=<span class="variable">$i</span> --mgsnode=10.xx.xx.1@tcp --mgsnode=10.xx.xx.2@tcp  --servicenode=10.x.x.4@tcp --servicenode=10.x.x.5@tcp</span></span><br><span class="line"><span class="string">ost-<span class="variable">$i</span>/ost-<span class="variable">$i</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="Create-HA-cluster"><a href="#Create-HA-cluster" class="headerlink" title="Create HA cluster"></a>Create HA cluster</h4><p>/etc/corosync/corosync.conf<br>/etc/corosync/service.d/pacemaker<br>same with config MDS</p><p>Copy hearbeat script to all member of the cluster node<br>Get the file <a href="https://github.com/skiselkov/stmf-ha/blob/master/heartbeat/ZFS">https://github.com/skiselkov/stmf-ha/blob/master/heartbeat/ZFS</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /usr/lib/ocf/resource.d/heartbeat/ZFS </span><br><span class="line">chmod 755 /usr/lib/ocf/resource.d/heartbeat/Lfs-ZFS</span><br></pre></td></tr></table></figure><p>It  s written by Paciucci Gabriele (intel)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Lfs-ZFS </span></span><br><span class="line"><span class="comment">#      Description: Manages a Lfs target on a shared storage medium.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># usage: ./Lfs-ZFS &#123;start|stop|status|monitor|validate-all|meta-data&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      OCF parameters are as below:</span></span><br><span class="line"><span class="comment">#        OCF_RESKEY_vdev</span></span><br><span class="line"><span class="comment">#OCF_RESKEY_mountpoint</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># OCF_RESKEY_vdev : name of the target the script should operate on</span></span><br><span class="line"><span class="comment"># OCF_RESKEY_mountpoint : name of the target the script should operate on</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;OCF_FUNCTIONS_DIR=$&#123;OCF_ROOT&#125;</span>/resource.d/heartbeat&#125;</span><br><span class="line">. <span class="variable">$&#123;OCF_FUNCTIONS_DIR&#125;</span>/.ocf-shellfuncs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;usage: <span class="variable">$0</span> &#123;start|stop|status|monitor|meta-data&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">meta_data</span></span>() &#123;</span><br><span class="line">    cat &lt;&lt;END</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE resource-agent SYSTEM <span class="string">&quot;ra-api-1.dtd&quot;</span>&gt;</span><br><span class="line">&lt;resource-agent name=<span class="string">&quot;Lfs-ZFS&quot;</span>&gt;</span><br><span class="line">&lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">&lt;longdesc lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">Resource script <span class="keyword">for</span> a Lfs ZFS Target.</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line"></span><br><span class="line">&lt;shortdesc lang=<span class="string">&quot;en&quot;</span>&gt;Manages Lfs ZFS Targets&lt;/shortdesc&gt;</span><br><span class="line"></span><br><span class="line">&lt;parameters&gt;</span><br><span class="line">&lt;parameter name=<span class="string">&quot;vdev&quot;</span> required=<span class="string">&quot;1&quot;</span>&gt;</span><br><span class="line">&lt;longdesc lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">The name of the ZFS vdev.</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line">&lt;shortdesc lang=<span class="string">&quot;en&quot;</span>&gt;vdev&lt;/shortdesc&gt;</span><br><span class="line">&lt;content <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span> default=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">&lt;/parameter&gt;</span><br><span class="line"></span><br><span class="line">&lt;parameter name=<span class="string">&quot;mountpoint&quot;</span> required=<span class="string">&quot;1&quot;</span>&gt;</span><br><span class="line">&lt;longdesc lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">The mount point <span class="keyword">for</span> the target</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line">&lt;shortdesc lang=<span class="string">&quot;en&quot;</span>&gt;mountpoint&lt;/shortdesc&gt;</span><br><span class="line">&lt;content <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span> default=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">&lt;/parameter&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/parameters&gt;</span><br><span class="line"></span><br><span class="line">&lt;actions&gt;</span><br><span class="line">&lt;action name=<span class="string">&quot;start&quot;</span> timeout=<span class="string">&quot;60&quot;</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">&quot;stop&quot;</span> timeout=<span class="string">&quot;60&quot;</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">&quot;notify&quot;</span> timeout=<span class="string">&quot;60&quot;</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">&quot;monitor&quot;</span> depth=<span class="string">&quot;0&quot;</span> timeout=<span class="string">&quot;40&quot;</span> interval=<span class="string">&quot;20&quot;</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">&quot;validate-all&quot;</span> timeout=<span class="string">&quot;5&quot;</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">&quot;meta-data&quot;</span> timeout=<span class="string">&quot;5&quot;</span> /&gt;</span><br><span class="line">&lt;/actions&gt;</span><br><span class="line">&lt;/resource-agent&gt;</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_start</span></span>() &#123;</span><br><span class="line">    <span class="comment"># See if the device is already mounted.</span></span><br><span class="line">    <span class="keyword">if</span> Target_status &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        ocf_log info <span class="string">&quot;Target <span class="variable">$TARGET</span> is already started.&quot;</span></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this is not necessary, mount should start modules </span></span><br><span class="line"><span class="comment">#    if ! grep -e &#x27;lfs$&#x27; /proc/filesystems &gt;/dev/null; then</span></span><br><span class="line"><span class="comment">#        ocf_log err &quot;Couldn&#x27;t find the lfs module in /proc/filesystems&quot;</span></span><br><span class="line"><span class="comment">#        return $OCF_ERR_ARGS</span></span><br><span class="line"><span class="comment">#    fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># start the target</span></span><br><span class="line"><span class="comment">#    if ! chroma-agent mount_target --uuid $TARGET; then</span></span><br><span class="line">    <span class="keyword">if</span> ! mount -t lfs <span class="variable">$TARGET</span> <span class="variable">$MOUNT_POINT</span>; <span class="keyword">then</span></span><br><span class="line">        ocf_log err <span class="string">&quot;Couldn&#x27;t start target <span class="variable">$TARGET</span>&quot;</span></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$OCF_ERR_GENERIC</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_notify</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_stop</span></span>() &#123;</span><br><span class="line">    <span class="comment"># started already?</span></span><br><span class="line">    Target_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ $? -eq <span class="variable">$OCF_NOT_RUNNING</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># woo!  nothing to do.</span></span><br><span class="line">        rc=<span class="variable">$OCF_SUCCESS</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"><span class="comment">#        chroma-agent unmount_target --uuid $TARGET</span></span><br><span class="line">        umount <span class="variable">$MOUNT_POINT</span> </span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$rc</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_status</span></span>() &#123;</span><br><span class="line">    <span class="comment"># call the agent to see if it&#x27;s running</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#    if chroma-agent target_running --uuid $TARGET &gt;/dev/null 2&gt;&amp;1; then</span></span><br><span class="line">    <span class="keyword">if</span> cat /proc/mounts |grep <span class="variable">$MOUNT_POINT</span> &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        rc=<span class="variable">$OCF_SUCCESS</span></span><br><span class="line">        msg=<span class="string">&quot;<span class="variable">$TARGET</span> is started (running)&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        rc=<span class="variable">$OCF_NOT_RUNNING</span></span><br><span class="line">        msg=<span class="string">&quot;<span class="variable">$TARGET</span> is stopped&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$OP</span>&quot;</span> = <span class="string">&quot;status&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        ocf_log info <span class="string">&quot;<span class="variable">$msg</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$rc</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_validate_all</span></span>() &#123;</span><br><span class="line"><span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 1 ]; <span class="keyword">then</span></span><br><span class="line">    usage</span><br><span class="line">    <span class="built_in">exit</span> <span class="variable">$OCF_ERR_ARGS</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">TARGET=<span class="variable">$OCF_RESKEY_vdev</span></span><br><span class="line">MOUNT_POINT=<span class="variable">$OCF_RESKEY_mountpoint</span></span><br><span class="line">OP=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These operations do not require instance parameters</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$OP</span> <span class="keyword">in</span></span><br><span class="line">meta-data)    meta_data</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">              ;;</span><br><span class="line">usage)        usage</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">              ;;</span><br><span class="line">status)       Target_status</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">monitor)      Target_status</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">validate-all) Target_validate_all</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">stop)         Target_stop</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">start)        Target_start</span><br><span class="line">              ;;</span><br><span class="line">*)            usage</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_ERR_UNIMPLEMENTED</span></span><br><span class="line">              ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure><h4 id="Configuration-HA"><a href="#Configuration-HA" class="headerlink" title="Configuration HA"></a>Configuration HA</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  pcs resource create ost-<span class="variable">$i</span> ocf:heartbeat:ZFS  pool=ost-<span class="variable">$i</span></span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op start interval=0 timeout=360</span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op stop interval=0 timeout=360</span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op monitor interval=5 timeout=60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"> <span class="keyword">do</span></span><br><span class="line">    mkdir /lfs_ost<span class="variable">$i</span></span><br><span class="line">    pcs resource create lfs_ost<span class="variable">$i</span> ocf:heartbeat:Lfs-ZFS vdev=<span class="string">&quot;ost-<span class="variable">$i</span>/ost-<span class="variable">$i</span>&quot;</span> mountpoint=<span class="string">&quot;/lfs_ost<span class="variable">$i</span>&quot;</span></span><br><span class="line"> pcs resource update lfs_ost<span class="variable">$i</span> op start interval=0 timeout=360</span><br><span class="line"> pcs resource update lfs_ost<span class="variable">$i</span> op stop interval=0 timeout=360</span><br><span class="line"> pcs resource update lfs_ost<span class="variable">$i</span> op  monitor interval=5 timeout=60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">pcs constraint order ost-<span class="variable">$i</span> <span class="keyword">then</span> lfs_ost<span class="variable">$i</span></span><br><span class="line">pcs constraint colocation add lfs_ost<span class="variable">$i</span> with ost-<span class="variable">$i</span></span><br><span class="line">pcs resource meta ost-<span class="variable">$i</span> migration-threshold=5</span><br><span class="line">pcs resource meta lfs_ost<span class="variable">$i</span> migration-threshold=5</span><br><span class="line">pcs resource meta ost-<span class="variable">$i</span> failure-timeout=360</span><br><span class="line">pcs resource meta lfs_ost<span class="variable">$i</span> failure-timeout=360</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">pcs stonith create oss-11-4-fencing fence_ipmilan pcmk_host_list=<span class="string">&quot;OSS-11-4.local&quot;</span> ipaddr=<span class="string">&quot;192.xx.xx.4&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 op monitor interval=60s</span><br><span class="line">pcs stonith create oss-11-5-fencing fence_ipmilan pcmk_host_list=<span class="string">&quot;OSS-11-4.local&quot;</span> ipaddr=<span class="string">&quot;192.xx.xx.5&quot;</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_wait=4 op monitor interval=60s</span><br></pre></td></tr></table></figure><h3 id="pcs-status-1"><a href="#pcs-status-1" class="headerlink" title="pcs status"></a>pcs status</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Cluster <span class="symbol">name:</span> </span><br><span class="line">Last <span class="symbol">updated:</span> Tue Aug <span class="number">25 15</span><span class="symbol">:</span><span class="number">36:31</span> <span class="number">2015</span></span><br><span class="line">Last <span class="symbol">change:</span> Thu Aug <span class="number">20 15</span><span class="symbol">:</span><span class="number">44:16</span> <span class="number">2015</span></span><br><span class="line"><span class="symbol">Stack:</span> classic openais (<span class="keyword">with</span> plugin)</span><br><span class="line">Current <span class="symbol">DC:</span> OSS<span class="number">-11-4</span>.local - partition <span class="keyword">with</span> quorum</span><br><span class="line"><span class="symbol">Version:</span> <span class="number">1.1</span>.<span class="number">11-97629</span>de</span><br><span class="line"><span class="number">2</span> Nodes configured, <span class="number">2</span> expected votes</span><br><span class="line"><span class="number">26</span> Resources configured</span><br><span class="line"></span><br><span class="line"><span class="symbol">Online:</span> [ OSS<span class="number">-11-4</span>.local OSS<span class="number">-11-5</span>.local ]</span><br><span class="line"></span><br><span class="line">Full list of <span class="symbol">resources:</span></span><br><span class="line"></span><br><span class="line"> oss<span class="number">-11-4</span>-fencing (<span class="symbol">stonith:</span>fence_ipmilan): Started OSS<span class="number">-11-4</span>.local </span><br><span class="line"> oss<span class="number">-11-5</span>-fencing (<span class="symbol">stonith:</span>fence_ipmilan): Started OSS<span class="number">-11-5</span>.local </span><br><span class="line"> ost-0 (ocf::<span class="symbol">heartbeat:</span>ZFS): Started OSS<span class="number">-11-4</span>.local </span><br><span class="line"> ost<span class="number">-1</span> (ocf::<span class="symbol">heartbeat:</span>ZFS): Started OSS<span class="number">-11-5</span>.local </span><br><span class="line"> ost<span class="number">-2</span> (ocf::<span class="symbol">heartbeat:</span>ZFS): Started OSS<span class="number">-11-4</span>.local </span><br><span class="line"> ost<span class="number">-3</span> (ocf::<span class="symbol">heartbeat:</span>ZFS): Started OSS<span class="number">-11-5</span>.local </span><br><span class="line">..</span><br><span class="line"> lfs_ost7 (ocf::<span class="symbol">heartbeat:</span>Lfs-ZFS): Started OSS<span class="number">-11-5</span>.local </span><br><span class="line"> lfs_ost8 (ocf::<span class="symbol">heartbeat:</span>Lfs-ZFS): Started OSS<span class="number">-11-4</span>.local </span><br><span class="line"> lfs_ost9 (ocf::<span class="symbol">heartbeat:</span>Lfs-ZFS): Started OSS<span class="number">-11-5</span>.local </span><br><span class="line"> lfs_ost10 (ocf::<span class="symbol">heartbeat:</span>Lfs-ZFS): Started OSS<span class="number">-11-4</span>.local </span><br><span class="line"> lfs_ost11 (ocf::<span class="symbol">heartbeat:</span>Lfs-ZFS): Started OSS<span class="number">-11-5</span>.local </span><br></pre></td></tr></table></figure><h4 id="Destroy-cluster"><a href="#Destroy-cluster" class="headerlink" title="Destroy cluster"></a>Destroy cluster</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource destroy --all</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$ rm -f /var/lib/pacemaker/cib</span><br></pre></td></tr></table></figure><h4 id="Update-pacemaker-host"><a href="#Update-pacemaker-host" class="headerlink" title="Update pacemaker host"></a>Update pacemaker host</h4><p>Because if you set ip addr in pcmk_host_list, it will not work.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource update fence_cngb-mds-m20-1 pcmk_host_list=cngb-mds-m20-1</span><br></pre></td></tr></table></figure><h4 id="Standby-node"><a href="#Standby-node" class="headerlink" title="Standby node"></a>Standby node</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pcs cluster standby node | --all</span><br><span class="line">pcs cluster unstandby node | --all</span><br></pre></td></tr></table></figure><p>Reference</p><p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/DM_Multipath/">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/DM_Multipath/</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/index.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/index.html</a><br><a href="https://github.com/zfsonlinux/zfs/labels/Bug">https://github.com/zfsonlinux/zfs/labels/Bug</a><br><a href="https://github.com/skiselkov/stmf-ha">https://github.com/skiselkov/stmf-ha</a><br><a href="https://github.com/zfsonlinux/pkg-zfs/wiki/Ubuntu-ZFS-mountall-FAQ-and-troubleshooting">https://github.com/zfsonlinux/pkg-zfs/wiki/Ubuntu-ZFS-mountall-FAQ-and-troubleshooting</a><br><a href="http://linux-ha.996297.n3.nabble.com/custom-script-status-td14629.html">http://linux-ha.996297.n3.nabble.com/custom-script-status-td14629.html</a><br><a href="https://www.youtube.com/watch?v=2XQ3Kvtd-sw">https://www.youtube.com/watch?v=2XQ3Kvtd-sw</a><br><a href="http://open-zfs.org/wiki/Main_Page">http://open-zfs.org/wiki/Main_Page</a><br><a href="http://irvingpop.github.io/blog/2015/03/01/redhat7-clustering-experiments/">http://irvingpop.github.io/blog/2015/03/01/redhat7-clustering-experiments/</a></p>]]></content>
      
      
      <categories>
          
          <category> Storage </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zfs </tag>
            
            <tag> lfs </tag>
            
            <tag> ha </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
