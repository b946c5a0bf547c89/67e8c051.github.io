<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Linux debug | 无常无相无功;不动不破不空</title><meta name="keywords" content="debug,trace"><meta name="author" content="Homer"><meta name="copyright" content="Homer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Mem mapping in Linux1234$ gdb -p $pidor$ pmap -x $pid$ pmap -XX $pid  kernel parameter(kptr_restrict)123456为 0 时, 未作任何处理, 直接输出, 这样对所有用户都没有限制.为 1 时, 中断上下文则不允许输出, 否则则校验了用户的权限.为 2 时, 将指针直接置 NULL, 这样所有用户都">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux debug">
<meta property="og:url" content="http://yoursite.com/2020/12/08/debug/index.html">
<meta property="og:site_name" content="无常无相无功;不动不破不空">
<meta property="og:description" content="Mem mapping in Linux1234$ gdb -p $pidor$ pmap -x $pid$ pmap -XX $pid  kernel parameter(kptr_restrict)123456为 0 时, 未作任何处理, 直接输出, 这样对所有用户都没有限制.为 1 时, 中断上下文则不允许输出, 否则则校验了用户的权限.为 2 时, 将指针直接置 NULL, 这样所有用户都">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png">
<meta property="article:published_time" content="2020-12-08T14:35:34.000Z">
<meta property="article:modified_time" content="2021-12-27T02:54:33.000Z">
<meta property="article:author" content="Homer">
<meta property="article:tag" content="debug">
<meta property="article:tag" content="trace">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><link rel="shortcut icon" href="/img/stout-shield.png"><link rel="canonical" href="http://yoursite.com/2020/12/08/debug/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-12-27 10:54:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="无常无相无功;不动不破不空" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/fighting-spiri-logot.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mem-mapping-in-Linux"><span class="toc-number">1.</span> <span class="toc-text">Mem mapping in Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kernel-parameter-kptr-restrict"><span class="toc-number">2.</span> <span class="toc-text">kernel parameter(kptr_restrict)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-debuginfo"><span class="toc-number">3.</span> <span class="toc-text">CentOS debuginfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-kernel-tracepoints"><span class="toc-number">4.</span> <span class="toc-text">Linux kernel tracepoints</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-kprobe"><span class="toc-number">5.</span> <span class="toc-text">Linux kprobe</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#compile-the-kprobe-sample-codes-in-centos-7"><span class="toc-number">5.1.</span> <span class="toc-text">compile the kprobe sample codes in centos 7</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Inject-function-example"><span class="toc-number"></span> <span class="toc-text">Inject function example</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#linux-3-10-0-1127-el7-arch-x86-include-asm-calling-h"><span class="toc-number">1.</span> <span class="toc-text">linux-3.10.0-1127.el7&#x2F;arch&#x2F;x86&#x2F;include&#x2F;asm&#x2F;calling.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#user-and-kernel-space-parameters-in-regs"><span class="toc-number">2.</span> <span class="toc-text">user and kernel space parameters in regs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux-3-10-0-1127-el7-include-linux-fs-h"><span class="toc-number">3.</span> <span class="toc-text">linux-3.10.0-1127.el7&#x2F;include&#x2F;linux&#x2F;fs.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example2"><span class="toc-number">4.</span> <span class="toc-text">example2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-same-result-use-perf"><span class="toc-number"></span> <span class="toc-text">The same result use perf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Crash"><span class="toc-number"></span> <span class="toc-text">Crash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cp-stack-interrupt-by-nfs"><span class="toc-number">1.</span> <span class="toc-text">cp stack interrupt by nfs</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fault-injection"><span class="toc-number"></span> <span class="toc-text">Fault-injection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#debug-example1"><span class="toc-number">1.</span> <span class="toc-text">debug example1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#debug-example1-1"><span class="toc-number">1.1.</span> <span class="toc-text">debug example1-1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-stack-work-flow"><span class="toc-number"></span> <span class="toc-text">The stack work flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#show-pr-debug-the-small-write-amplification-with-linux-soft-raid5"><span class="toc-number"></span> <span class="toc-text">show pr_debug, the small write amplification with linux soft raid5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kprobe-example"><span class="toc-number"></span> <span class="toc-text">kprobe example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stap-show-all-local-parameters-could-be-print"><span class="toc-number"></span> <span class="toc-text">stap show all local parameters could be print</span></a></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">无常无相无功;不动不破不空</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Linux debug</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-12-08T14:35:34.000Z" title="Created 2020-12-08 22:35:34">2020-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-12-27T02:54:33.000Z" title="Updated 2021-12-27 10:54:33">2021-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Scripts/">Scripts</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h4 id="Mem-mapping-in-Linux"><a href="#Mem-mapping-in-Linux" class="headerlink" title="Mem mapping in Linux"></a>Mem mapping in Linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -p <span class="variable">$pid</span></span><br><span class="line">or</span><br><span class="line">$ pmap -x <span class="variable">$pid</span></span><br><span class="line">$ pmap -XX <span class="variable">$pid</span></span><br></pre></td></tr></table></figure>

<h4 id="kernel-parameter-kptr-restrict"><a href="#kernel-parameter-kptr-restrict" class="headerlink" title="kernel parameter(kptr_restrict)"></a>kernel parameter(kptr_restrict)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">为</span> <span class="number">0</span> <span class="string">时,</span> <span class="string">未作任何处理,</span> <span class="string">直接输出,</span> <span class="string">这样对所有用户都没有限制.</span></span><br><span class="line"><span class="string">为</span> <span class="number">1</span> <span class="string">时,</span> <span class="string">中断上下文则不允许输出,</span> <span class="string">否则则校验了用户的权限.</span></span><br><span class="line"><span class="string">为</span> <span class="number">2</span> <span class="string">时,</span> <span class="string">将指针直接置</span> <span class="literal">NULL</span><span class="string">,</span> <span class="string">这样所有用户都只能看到全</span> <span class="number">0</span><span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">限制</span> <span class="string">%p</span> <span class="string">的输出,</span> <span class="string">不再输出实际的地址,</span> <span class="string">而是输出一个散列化的地址.</span></span><br><span class="line"><span class="string">想要在</span> <span class="string">crash</span> <span class="string">等流程输出实际地址时,</span> <span class="string">则使用</span> <span class="string">%px</span> <span class="string">输出内核符号的实际地址.</span></span><br></pre></td></tr></table></figure>

<h4 id="CentOS-debuginfo"><a href="#CentOS-debuginfo" class="headerlink" title="CentOS debuginfo"></a>CentOS debuginfo</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#bpftrace </span></span><br><span class="line"><span class="attribute">https</span>://repos.baslab.org/bpftools/x<span class="number">86</span>_<span class="number">64</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#souce</span></span><br><span class="line"><span class="attribute">https</span>://vault.centos.org/<span class="number">7</span>.<span class="number">9</span>.<span class="number">2009</span>/updates/Source/SPackages/</span><br><span class="line"></span><br><span class="line"><span class="comment">#debuginfo</span></span><br><span class="line"><span class="attribute">http</span>://debuginfo.centos.org/<span class="number">7</span>/x<span class="number">86</span>_<span class="number">64</span>/kernel-debuginfo-<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">1160</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>.rpm</span><br><span class="line"><span class="attribute">http</span>://debuginfo.centos.org/<span class="number">7</span>/x<span class="number">86</span>_<span class="number">64</span>/kernel-debuginfo-<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">1160</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>.rpm</span><br></pre></td></tr></table></figure>

<h4 id="Linux-kernel-tracepoints"><a href="#Linux-kernel-tracepoints" class="headerlink" title="Linux kernel tracepoints"></a>Linux kernel tracepoints</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">file path: ./include/trace/define_trace.h</span><br><span class="line"></span><br><span class="line">$ ls /sys/kernel/debug/tracing/events</span><br><span class="line">block             <span class="built_in">enable</span>      gpio          iommu        libata   mpx   pagemap  ras           scsi      task      workqueue</span><br><span class="line">bridge            exceptions  header_event  irq          mce      napi  percpu   raw_syscalls  signal    timer     writeback</span><br><span class="line">compaction        filelock    header_page   irq_vectors  mdio     net   power    rcu           skb       ucsi      xen</span><br><span class="line">context_tracking  filemap     hyperv        kmem         mei      nfs   printk   regmap        sock      udp       xfs</span><br><span class="line">dma_fence         fs_dax      i2c           kvm          migrate  nfs4  qdisc    rpm           sunrpc    vmscan    xhci-hcd</span><br><span class="line">drm               ftrace      intel_ish     kvmmmu       module   oom   random   <span class="built_in">sched</span>         syscalls  vsyscall</span><br><span class="line"></span><br><span class="line">$ ls /sys/kernel/debug/tracing/events/syscalls</span><br><span class="line"><span class="built_in">enable</span>                       sys_enter_name_to_handle_at       sys_exit_accept             sys_exit_newfstat</span><br><span class="line">filter                       sys_enter_nanosleep               sys_exit_accept4            sys_exit_newfstatat</span><br><span class="line">sys_enter_accept             sys_enter_newfstat                sys_exit_access             sys_exit_newlstat</span><br><span class="line">sys_enter_accept4            sys_enter_newfstatat              sys_exit_acct               sys_exit_newstat</span><br><span class="line">sys_enter_access             sys_enter_newlstat                sys_exit_add_key            sys_exit_newuname</span><br><span class="line">sys_enter_acct               sys_enter_newstat                 sys_exit_adjtimex           sys_exit_open</span><br><span class="line">sys_enter_add_key            sys_enter_newuname                sys_exit_alarm              sys_exit_openat</span><br><span class="line">sys_enter_adjtimex           sys_enter_open                    sys_exit_bind               sys_exit_open_by_handle_at</span><br><span class="line">...</span><br><span class="line"><span class="comment"># all /proc/kallsyms symbol could add in kprobe</span></span><br><span class="line">$ cat /proc/kallsyms</span><br><span class="line"></span><br><span class="line">system.map = $(nm vmlinux)</span><br><span class="line">/proc/kallsysms = system.map + loaded modules<span class="string">&#x27;s kallsyms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -l | grep sys_enter_nanosleep</span></span><br><span class="line"><span class="string">tracepoint:syscalls:sys_enter_nanosleep</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -lv &#x27;</span>t:syscalls:sys_enter_openat<span class="string">&#x27;</span></span><br><span class="line"><span class="string">tracepoint:syscalls:sys_enter_openat</span></span><br><span class="line"><span class="string">    int nr;</span></span><br><span class="line"><span class="string">    int dfd;</span></span><br><span class="line"><span class="string">    const char * filename;</span></span><br><span class="line"><span class="string">    int flags;</span></span><br><span class="line"><span class="string">    umode_t mode;</span></span><br><span class="line"><span class="string">asmlinkage long sys_openat(int dfd, const char __user *filename, int flags,</span></span><br><span class="line"><span class="string">			   umode_t mode);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -lv &#x27;</span>t:k:tcp_sendmsg<span class="string">&#x27;</span></span><br><span class="line"><span class="string"># not output</span></span><br><span class="line"><span class="string">int tcp_sendmsg(struct sock *sk, struct msghdr *msg, size_t size);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## work in ubuntu 20.04</span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/kprobe_events</span></span><br><span class="line"><span class="string">p:kprobes/tcp_sendmsg tcp_sendmsg dst=+0(%di):x32 dport=+12(%di):x16 src=+4(%di):x32 sport=+14(%di):x16 size=%dx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/events/kprobes/tcp_sendmsg/format</span></span><br><span class="line"><span class="string">name: tcp_sendmsg</span></span><br><span class="line"><span class="string">ID: 1734</span></span><br><span class="line"><span class="string">format:</span></span><br><span class="line"><span class="string">	field:unsigned short common_type;	offset:0;	size:2;	signed:0;</span></span><br><span class="line"><span class="string">	field:unsigned char common_flags;	offset:2;	size:1;	signed:0;</span></span><br><span class="line"><span class="string">	field:unsigned char common_preempt_count;	offset:3;	size:1;	signed:0;</span></span><br><span class="line"><span class="string">	field:int common_pid;	offset:4;	size:4;	signed:1;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	field:unsigned long __probe_ip;	offset:8;	size:8;	signed:0;</span></span><br><span class="line"><span class="string">	field:u32 dst;	offset:16;	size:4;	signed:0;</span></span><br><span class="line"><span class="string">	field:u16 dport;	offset:20;	size:2;	signed:0;</span></span><br><span class="line"><span class="string">	field:u32 src;	offset:22;	size:4;	signed:0;</span></span><br><span class="line"><span class="string">	field:u16 sport;	offset:26;	size:2;	signed:0;</span></span><br><span class="line"><span class="string">	field:u64 size;	offset:28;	size:8;	signed:0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print fmt: &quot;(%lx) dst=0x%x dport=0x%x src=0x%x sport=0x%x size=0x%Lx&quot;, REC-&gt;__probe_ip, REC-&gt;dst, REC-&gt;dport, REC-&gt;src, REC-&gt;sport, REC-&gt;size</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## tracepoint specific</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">asmlinkage long sys_openat(int dfd, const char __user *filename, int flags,</span></span><br><span class="line"><span class="string">			   umode_t mode);</span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_openat/format</span></span><br><span class="line"><span class="string">name: sys_enter_openat</span></span><br><span class="line"><span class="string">ID: 495</span></span><br><span class="line"><span class="string">format:</span></span><br><span class="line"><span class="string">	field:unsigned short common_type;	offset:0;	size:2;	signed:0;</span></span><br><span class="line"><span class="string">	field:unsigned char common_flags;	offset:2;	size:1;	signed:0;</span></span><br><span class="line"><span class="string">	field:unsigned char common_preempt_count;	offset:3;	size:1;	signed:0;</span></span><br><span class="line"><span class="string">	field:int common_pid;	offset:4;	size:4;	signed:1;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	field:int nr;	offset:8;	size:4;	signed:1;</span></span><br><span class="line"><span class="string">	field:int dfd;	offset:16;	size:8;	signed:0;</span></span><br><span class="line"><span class="string">	field:const char * filename;	offset:24;	size:8;	signed:0;</span></span><br><span class="line"><span class="string">	field:int flags;	offset:32;	size:8;	signed:0;</span></span><br><span class="line"><span class="string">	field:umode_t mode;	offset:40;	size:8;	signed:0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print fmt: &quot;dfd: 0x%08lx, filename: 0x%08lx, flags: 0x%08lx, mode: 0x%08lx&quot;, ((unsigned long)(REC-&gt;dfd)), ((unsigned long)(REC-&gt;filename)), ((unsigned long)(REC-&gt;flags)), ((unsigned long)(REC-&gt;mode))</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h4 id="Linux-kprobe"><a href="#Linux-kprobe" class="headerlink" title="Linux kprobe"></a>Linux kprobe</h4><p>And you could get the kprobe demo source code from linux kernel source</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/kernel/debug/kprobes/enabled</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment"># The same results</span></span><br><span class="line">$ cat /sys/kernel/debug/tracing/available_filter_functions</span><br><span class="line">$ bpftrace -l kprobe:*</span><br><span class="line"></span><br><span class="line">$ bpftrace -l kprobe:*nfs42*</span><br><span class="line">kprobe:nfs42_clone_file_range</span><br><span class="line">kprobe:nfs42_fallocate</span><br><span class="line">kprobe:_nfs42_proc_fallocate</span><br><span class="line">kprobe:nfs42_proc_fallocate</span><br><span class="line">kprobe:_nfs42_proc_clone</span><br><span class="line">kprobe:_nfs42_proc_llseek</span><br><span class="line">kprobe:nfs42_layoutstat_prepare</span><br><span class="line">kprobe:nfs42_layoutstat_release</span><br><span class="line">kprobe:nfs42_layoutstat_done</span><br><span class="line">kprobe:nfs42_proc_allocate</span><br><span class="line">kprobe:nfs42_proc_deallocate</span><br><span class="line">kprobe:nfs42_proc_copy</span><br><span class="line">kprobe:nfs42_proc_llseek</span><br><span class="line">kprobe:nfs42_proc_layoutstats_generic</span><br><span class="line">probe:nfs42_proc_clone</span><br><span class="line"></span><br><span class="line">$ bpftrace -l kprobe:sys_unlinkat</span><br><span class="line">kprobe:SyS_unlinkat</span><br><span class="line"></span><br><span class="line">$ cat /proc/kallsyms</span><br><span class="line"><span class="comment"># add kprobe for all symbols from /proc/kallsyms</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/kallsyms | grep do_sys_open</span><br><span class="line">ffffffff8b44bec0 T do_sys_open</span><br><span class="line"></span><br><span class="line">$ nm /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux |grep do_fork</span><br><span class="line">ffffffff8109acc0 T do_fork</span><br><span class="line">ffffffff81cf62e0 d do_fork_test</span><br><span class="line">$ cat /proc/kallsyms |grep do_fork</span><br><span class="line">ffffffff8d69acc0 T do_fork</span><br><span class="line">ffffffff8e2f62e0 d do_fork_test</span><br><span class="line"></span><br><span class="line"><span class="comment">## it could assigning the register data</span></span><br><span class="line">$ cat /sys/kernel/debug/kprobes/enabled</span><br><span class="line">1</span><br><span class="line">$ cat /proc/sys/debug/kprobes-optimization</span><br><span class="line">1</span><br><span class="line">/sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events <span class="comment">#the return value is number</span></span><br><span class="line"></span><br><span class="line">$ cat /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line"></span><br><span class="line">name: myprobe</span><br><span class="line">ID: 1662</span><br><span class="line">format:</span><br><span class="line">	field:unsigned short common_type;	offset:0;	size:2;	signed:0;</span><br><span class="line">	field:unsigned char common_flags;	offset:2;	size:1;	signed:0;</span><br><span class="line">	field:unsigned char common_preempt_count;	offset:3;	size:1;	signed:0;</span><br><span class="line">	field:int common_pid;	offset:4;	size:4;	signed:1;</span><br><span class="line"></span><br><span class="line">	field:unsigned long __probe_ip;	offset:8;	size:8;	signed:0;</span><br><span class="line">	field:u64 dfd;	offset:16;	size:8;	signed:0;</span><br><span class="line">	field:u64 filename;	offset:24;	size:8;	signed:0;</span><br><span class="line">	field:u64 flags;	offset:32;	size:8;	signed:0;</span><br><span class="line">	field:u64 mode;	offset:40;	size:8;	signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> fmt: <span class="string">&quot;(%lx) dfd=0x%Lx filename=0x%Lx flags=0x%Lx mode=0x%Lx&quot;</span>, REC-&gt;__probe_ip, REC-&gt;dfd, REC-&gt;filename, REC-&gt;flags, REC-&gt;mode</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myprobe getname +0($retval):string&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events <span class="comment">#the return value is string</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line">$ cat /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 61/61   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">             cat-13819 [015] d... 280432.427059: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x88000 flags=0x4150 mode=0xffffffff</span><br><span class="line">             cat-13819 [015] d... 280432.427069: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x88000 flags=0x4150 mode=0xffffffff</span><br><span class="line">             irqbalance-2106  [019] d... 280436.335586: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x8000 flags=0x1b6 mode=0xffffffff</span><br><span class="line">             irqbalance-2106  [019] d... 280436.337937: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x8000 flags=0x1b6 mode=0xffffffff</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line">$ <span class="built_in">echo</span> -:myprobe &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="comment"># clear all</span></span><br><span class="line">$ <span class="built_in">echo</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/local/sbin/ply</span></span><br><span class="line">kprobe:sys_unlinkat / !strcmp(execname, <span class="string">&quot;rm&quot;</span>) /</span><br><span class="line">&#123;</span><br><span class="line">   t[pid] =  walltime;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;pid: %d %s\n&quot;</span>, pid, str(arg1) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:sys_unlinkat / !strcmp(execname, <span class="string">&quot;rm&quot;</span>) /</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sys_unlinkat take time: %lld ns\n&quot;</span>, walltime - t[pid] );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="compile-the-kprobe-sample-codes-in-centos-7"><a href="#compile-the-kprobe-sample-codes-in-centos-7" class="headerlink" title="compile the kprobe sample codes in centos 7"></a>compile the kprobe sample codes in centos 7</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> linux-3.10.0-1127.el7/samples/kprobes</span><br><span class="line">$ ls</span><br><span class="line">jprobe_example.c  kprobe_example.c  kretprobe_example.c</span><br><span class="line"></span><br><span class="line"><span class="comment">## work with kretprobe_example.c</span></span><br><span class="line">$ cat Makefile</span><br><span class="line">obj-m := kretprobe_example.o</span><br><span class="line">KERNEL := /lib/modules/`uname -r`/build</span><br><span class="line">all:</span><br><span class="line">	make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` modules</span><br><span class="line">install:</span><br><span class="line">	make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` modules_install</span><br><span class="line">	depmod -A</span><br><span class="line">clean:</span><br><span class="line">	make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` clean</span><br><span class="line"></span><br><span class="line">$ make </span><br><span class="line">$ ls</span><br><span class="line">jprobe_example.c  kretprobe_example.c   kretprobe_example.mod.c  kretprobe_example.o  modules.order</span><br><span class="line">kprobe_example.c  kretprobe_example.ko  kretprobe_example.mod.o  Makefile             Module.symvers</span><br><span class="line"></span><br><span class="line">$ insmod ./kretprobe_example.ko</span><br><span class="line"></span><br><span class="line">$ dmesg -T</span><br><span class="line">[Tue Dec 15 02:27:50 2020] do_fork returned 5570 and took 30141 ns to execute</span><br><span class="line">[Tue Dec 15 02:27:51 2020] do_fork returned 5571 and took 131646 ns to execute</span><br><span class="line"></span><br><span class="line">$ lsmod | grep kret</span><br><span class="line">kretprobe_example      12696  0</span><br><span class="line">$ rmmod kretprobe_example</span><br><span class="line">$ lsmod | grep kret</span><br><span class="line">$ dmesg -T</span><br><span class="line">[Tue Dec 15 02:30:23 2020] kretprobe at ffffffff8d69acc0 unregistered</span><br><span class="line">[Tue Dec 15 02:30:23 2020] Missed probing 0 instances of do_fork</span><br></pre></td></tr></table></figure>

<ul>
<li>linux-3.10.0-1127.el7/include/linux/sysctl.h<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">struct ctl_table</span><br><span class="line">&#123;</span><br><span class="line">        const char *procname;           /* Text ID <span class="keyword">for</span> /proc/sys, or zero */</span><br><span class="line">        void *data;                     </span><br><span class="line">        int maxlen;</span><br><span class="line">        umode_t mode;                   </span><br><span class="line">        struct ctl_table *child;        /* Deprecated */</span><br><span class="line">        proc_handler *proc_handler;     /* Callback <span class="keyword">for</span> text formatting */</span><br><span class="line">        struct ctl_table_poll *poll;</span><br><span class="line">        void *extra1;</span><br><span class="line">        void *extra2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//mode,access permission</span><br><span class="line">//porc_dointvec, one or more int array[]</span><br><span class="line">//proc_dostring, <span class="built_in">read</span> and write stirng</span><br><span class="line">//proc_dointvec_minmax, the int value range from min to max</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Inject-function-example"><a href="#Inject-function-example" class="headerlink" title="Inject function example"></a>Inject function example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">$ uname -r</span><br><span class="line">3.10.0-1127.el7.x86_64</span><br><span class="line">$ bpftrace -V</span><br><span class="line">bpftrace v0.11.0-118-gf543-dirty</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;k:xs_tcp_send_request &#123;printf(&quot;override PID %d\n&quot;, pid);override(-5); &#125;&#x27;</span> --unsafe</span><br><span class="line">$ vi linux-3.10.0-1127.el7/net/sunrpc/xprtsock.c</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * xs_tcp_send_request - write an RPC request to a TCP socket</span><br><span class="line"> * @task: address of RPC task that manages the state of an RPC request</span><br><span class="line"> *</span><br><span class="line"> * Return values:</span><br><span class="line"> *        0:    The request has been sent</span><br><span class="line"> *   EAGAIN:    The socket was blocked, please call again later to</span><br><span class="line"> *              complete the request</span><br><span class="line"> * ENOTCONN:    Caller needs to invoke connect logic <span class="keyword">then</span> call again</span><br><span class="line"> *    other:    Some other error occurred, the request was not sent</span><br><span class="line"> *</span><br><span class="line"> * XXX: In the <span class="keyword">case</span> of soft timeouts, should we eventually give up</span><br><span class="line"> *      <span class="keyword">if</span> sendmsg is not able to make progress?</span><br><span class="line"> */</span><br><span class="line">static int xs_tcp_send_request(struct rpc_task *task)</span><br><span class="line">....</span><br><span class="line">        <span class="built_in">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe xs_tcp_send_request $retval&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/kprobes/myretprobe/format</span><br><span class="line">name: myretprobe</span><br><span class="line">ID: 1660</span><br><span class="line">format:</span><br><span class="line">	field:unsigned short common_type;	offset:0;	size:2;	signed:0;</span><br><span class="line">	field:unsigned char common_flags;	offset:2;	size:1;	signed:0;</span><br><span class="line">	field:unsigned char common_preempt_count;	offset:3;	size:1;	signed:0;</span><br><span class="line">	field:int common_pid;	offset:4;	size:4;	signed:1;</span><br><span class="line"></span><br><span class="line">	field:unsigned long __probe_func;	offset:8;	size:8;	signed:0;</span><br><span class="line">	field:unsigned long __probe_ret_ip;	offset:16;	size:8;	signed:0;</span><br><span class="line">	field:u64 arg1;	offset:24;	size:8;	signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> fmt: <span class="string">&quot;(%lx &lt;- %lx) arg1=0x%Lx&quot;</span>, REC-&gt;__probe_func, REC-&gt;__probe_ret_ip, REC-&gt;arg1</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/<span class="built_in">enable</span></span><br><span class="line">$ cat /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 24/24   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">  kworker/u433:0-18077 [017] d... 281350.965310: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">           &lt;...&gt;-170470 [008] d... 281350.968731: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">  kworker/u433:0-18077 [021] d... 281356.021502: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">           &lt;...&gt;-170470 [008] d... 281356.024915: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decimal from signed 2&#x27;s complement: 0xfffffffffffffffb = -5</span></span><br><span class="line"><span class="comment"># How to calculate ?</span></span><br><span class="line"><span class="comment"># 5 = 0000,0101</span></span><br><span class="line"><span class="comment"># Get complement: 1111,1010</span></span><br><span class="line"><span class="comment"># Add 1: 1111,1011</span></span><br><span class="line"><span class="comment">#         f , b</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/<span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">$ grep <span class="string">&quot;struct rpc_task &#123;&quot;</span> linux-3.10.0-1127.el7/include/linux/sunrpc/sched.h -A 50</span><br><span class="line">struct rpc_task &#123;</span><br><span class="line">	atomic_t		tk_count;	/* Reference count */</span><br><span class="line">	int			tk_status;	/* result of last operation */</span><br><span class="line">	struct list_head	tk_task;	/* global list of tasks */</span><br></pre></td></tr></table></figure>
<p>Because it ‘s the kernel module from sunrpc.ko, not in vmlinux, try to loading the kernel module</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc</span><br><span class="line">$ cp sunrpc.ko.xz sunrpc-1.ko.xz</span><br><span class="line">$ xd -d sunrpc-1.ko.xz</span><br><span class="line">$ mv sunrpc-1.ko sunrpc.ko</span><br><span class="line"></span><br><span class="line">$ cat /sys/module/sunrpc/sections/.text</span><br><span class="line">0xffffffffc0bf9000</span><br><span class="line"></span><br><span class="line">$ add-symbol-file /lib/modules/3.10.0-1127.el7.x86_64/extra/qlgc-fastlinq/qede.ko 0xffffffffc022b000</span><br><span class="line"></span><br><span class="line">$ gdb /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line">$ add-symbol-file /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0bf9000</span><br><span class="line">$ add-symbol-file /usr/lib/modules/3.10.0-957.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0396000</span><br><span class="line">(gdb) list xs_tcp_send_request</span><br><span class="line">655	 *</span><br><span class="line">656	 * XXX: In the <span class="keyword">case</span> of soft timeouts, should we eventually give up</span><br><span class="line">657	 *	<span class="keyword">if</span> sendmsg is not able to make progress?</span><br><span class="line">658	 */</span><br><span class="line">659	static int xs_tcp_send_request(struct rpc_task *task)</span><br><span class="line">660	&#123;</span><br><span class="line">661		struct rpc_rqst *req = task-&gt;tk_rqstp;</span><br><span class="line">662		struct rpc_xprt *xprt = req-&gt;rq_xprt;</span><br><span class="line">663		struct sock_xprt *transport = container_of(xprt, struct sock_xprt, xprt);</span><br><span class="line">664		struct xdr_buf *xdr = &amp;req-&gt;rq_snd_buf;</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_count</span><br><span class="line"><span class="variable">$1</span> = 0</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_timeout</span><br><span class="line"><span class="variable">$3</span> = 40</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_runstate</span><br><span class="line"><span class="variable">$4</span> = 48</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_msg</span><br><span class="line"><span class="variable">$6</span> = 120</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_start</span><br><span class="line"><span class="variable">$5</span> = 200</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe xs_tcp_send_request count=+0(%di):u32 run_sta=+48(%di):u32 tk_msg=+120(%di):x64&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/<span class="built_in">enable</span></span><br><span class="line">$ cat trace</span><br><span class="line">           &lt;...&gt;-81155 [020] d... 95057.395523: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bbb</span><br><span class="line">           &lt;...&gt;-81155 [010] d... 95057.395638: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bbb</span><br><span class="line">.....</span><br><span class="line">           &lt;...&gt;-81165 [008] d... 95063.283924: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bab</span><br><span class="line">           &lt;...&gt;-81165 [008] d... 95063.283973: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) count=0x0 run_sta=0x0 tk_msg=0xc0bfafb0ffff8bab</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_client</span><br><span class="line"><span class="variable">$17</span> = 168</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_client-&gt;cl_metrics-&gt;om_ops</span><br><span class="line"><span class="variable">$18</span> = 8</span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct rpc_task *)0)-&gt;tk_client-&gt;cl_metrics-&gt;om_ntrans</span><br><span class="line"><span class="variable">$19</span> = 16</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe xs_tcp_send_request count=+0(%di):u32 run_sta=+48(%di):u32 pid=+208(%di):u32&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">$ cat trace </span><br><span class="line">           &lt;...&gt;-88620 [001] d... 103530.318261: myprobe: (xs_tcp_send_request+0x0/0x230 [sunrpc]) count=0x2 run_sta=0x5 pid=0x15a2c</span><br><span class="line">           &lt;...&gt;-88620 [001] d... 103530.354814: myprobe: (xs_tcp_send_request+0x0/0x230 [sunrpc]) count=0x2 run_sta=0x5 pid=0x15a2c</span><br><span class="line">           &lt;...&gt;-88469 [004] d... 103587.916562: myprobe: (xs_tcp_send_request+0x0/0x230 [sunrpc]) count=0x1 run_sta=0x5 pid=0xe5</span><br><span class="line"></span><br><span class="line">0xe5=229</span><br><span class="line">root        229  0.0  0.0      0     0 ?        S    Dec19   0:00 [kworker/2:1]</span><br></pre></td></tr></table></figure>

<h4 id="linux-3-10-0-1127-el7-arch-x86-include-asm-calling-h"><a href="#linux-3-10-0-1127-el7-arch-x86-include-asm-calling-h" class="headerlink" title="linux-3.10.0-1127.el7/arch/x86/include/asm/calling.h"></a>linux-3.10.0-1127.el7/arch/x86/include/asm/calling.h</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">x86 function call convention, <span class="number">64</span>-bit:</span><br><span class="line">-------------------------------------</span><br><span class="line"> arguments           |  callee-saved      | extra caller-saved | <span class="keyword">return</span></span><br><span class="line">[callee-clobbered]   |                    | [callee-clobbered] |</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">rdi rsi rdx rcx r8<span class="number">-9</span> | rbx rbp [*] r12<span class="number">-15</span> | r10<span class="number">-11</span>             | rax, rdx [**]</span><br><span class="line"></span><br><span class="line">( rsp is obviously invariant across normal function calls. (gcc can &#x27;merge&#x27;</span><br><span class="line">  functions when it sees tail-call optimization possibilities) rflags is</span><br><span class="line">  clobbered. Leftover arguments are passed over the <span class="built_in">stack</span> frame.)</span><br><span class="line"></span><br><span class="line">[*]  In the frame-pointers <span class="keyword">case</span> rbp is fixed to the <span class="built_in">stack</span> frame.</span><br><span class="line"></span><br><span class="line">[**] <span class="keyword">for</span> <span class="class"><span class="keyword">struct</span> <span class="title">return</span> <span class="title">values</span> <span class="title">wider</span> <span class="title">than</span> 64 <span class="title">bits</span> <span class="title">the</span> <span class="title">return</span> <span class="title">convention</span> <span class="title">is</span> <span class="title">a</span></span></span><br><span class="line"><span class="class">     <span class="title">bit</span> <span class="title">more</span> <span class="title">complex</span>:</span> up to <span class="number">128</span> bits width we <span class="keyword">return</span> small structures</span><br><span class="line">     straight in rax, rdx. For structures larger than that (<span class="number">3</span> words <span class="keyword">or</span></span><br><span class="line">     larger) the caller <span class="built_in">puts</span> a pointer to an on-<span class="built_in">stack</span> <span class="keyword">return</span> struct</span><br><span class="line">     [allocated in the caller<span class="number">&#x27;</span>s <span class="built_in">stack</span> frame] into the first argument - i.e.</span><br><span class="line">     into rdi. All other arguments shift up by one in <span class="keyword">this</span> <span class="keyword">case</span>.</span><br><span class="line">     Fortunately <span class="keyword">this</span> <span class="keyword">case</span> is rare in the kernel.</span><br></pre></td></tr></table></figure>

<h4 id="user-and-kernel-space-parameters-in-regs"><a href="#user-and-kernel-space-parameters-in-regs" class="headerlink" title="user and kernel space parameters in regs"></a>user and kernel space parameters in regs</h4><p>linux-3.10.0-1127.el7/arch/x86/include/asm/ptrace.h<br><a target="_blank" rel="noopener" href="https://uclibc.org/docs/psABI-x86_64.pdf">psABI-x86_64.pdf</a><br>page 125   </p>
<ul>
<li>User-level applications use as integer registers for passing the sequence %rdi, %rsi, %rdx, %rcx, %r8 and %r9</li>
<li>The kernel interface uses %rdi, %rsi, %rdx, %r10, %r8 and %r9</li>
<li>A system-call is done via the syscall instruction. The kernel destroys registers %rcx and %r11</li>
<li>The number of the syscall has to be passed in register %rax</li>
<li>System-calls are limited to six arguments, no argument is passed directly on the stack</li>
<li>Returning from the syscall, register %rax contains the result of the system-call. A value in the range between -4095 and -1 indicates an error, it is -errno</li>
<li>Only values of class INTEGER or class MEMORY are passed to the kernel</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// x86_64</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> bp;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> bx;</span><br><span class="line"><span class="comment">/* arguments: non interrupts/non tracing syscalls only save up to here*/</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r10; </span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r9; <span class="comment">// mapped to arg[5], if arg[5] is the float number, the r9 will not save it</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> r8; <span class="comment">// mapped to arg[4]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ax;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> cx; <span class="comment">// mapped to arg[3]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> dx; <span class="comment">// mapped to arg[2]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> si; <span class="comment">// mapped to arg[1]</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> di; <span class="comment">// mapped to arg[0] first parameters</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_ax;</span><br><span class="line"><span class="comment">/* end of arguments */</span></span><br><span class="line"><span class="comment">/* cpu exception frame or undefined */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ip;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> sp;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">##<span class="meta"># linux/arch/x86/entry/common.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">		<span class="keyword">if</span> (arch == AUDIT_ARCH_X86_64) &#123;</span><br><span class="line">			sd.args[<span class="number">0</span>] = regs-&gt;di;</span><br><span class="line">			sd.args[<span class="number">1</span>] = regs-&gt;si;</span><br><span class="line">			sd.args[<span class="number">2</span>] = regs-&gt;dx;</span><br><span class="line">			sd.args[<span class="number">3</span>] = regs-&gt;r10;</span><br><span class="line">			sd.args[<span class="number">4</span>] = regs-&gt;r8;</span><br><span class="line">			sd.args[<span class="number">5</span>] = regs-&gt;r9;</span><br><span class="line">		&#125; <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">		&#123;</span><br><span class="line">			sd.args[<span class="number">0</span>] = regs-&gt;bx;</span><br><span class="line">			sd.args[<span class="number">1</span>] = regs-&gt;cx;</span><br><span class="line">			sd.args[<span class="number">2</span>] = regs-&gt;dx;</span><br><span class="line">			sd.args[<span class="number">3</span>] = regs-&gt;si;</span><br><span class="line">			sd.args[<span class="number">4</span>] = regs-&gt;di;</span><br><span class="line">			sd.args[<span class="number">5</span>] = regs-&gt;bp;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/smith9527/p/11437647.html">reference</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Rin netif_receive_skb_core linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7</span><br><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/net/core/dev.c:<span class="number">4237</span>:<span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb_core(struct sk_buff *skb, <span class="keyword">bool</span> pfmemalloc)</span><br><span class="line"></span><br><span class="line">$ crash /usr/lib/debug/usr/lib/modules/<span class="number">3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/vmlinux</span><br><span class="line">crash&gt; dis -l __netif_receive_skb_core</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4238</span></span><br><span class="line"><span class="number">0xffffffff9d0534f0</span> &lt;__netif_receive_skb_core&gt;:  nopl   <span class="number">0x0</span>(%rax,%rax,<span class="number">1</span>) [FTRACE NOP]</span><br><span class="line"><span class="number">0xffffffff9d0534f5</span> &lt;__netif_receive_skb_core+<span class="number">5</span>&gt;:        push   %rbp</span><br><span class="line"><span class="number">0xffffffff9d0534f6</span> &lt;__netif_receive_skb_core+<span class="number">6</span>&gt;:        mov    %rsp,%rbp</span><br><span class="line"><span class="number">0xffffffff9d0534f9</span> &lt;__netif_receive_skb_core+<span class="number">9</span>&gt;:        push   %r15</span><br><span class="line"><span class="number">0xffffffff9d0534fb</span> &lt;__netif_receive_skb_core+<span class="number">11</span>&gt;:       push   %r14</span><br><span class="line"><span class="number">0xffffffff9d0534fd</span> &lt;__netif_receive_skb_core+<span class="number">13</span>&gt;:       push   %r13</span><br><span class="line"><span class="number">0xffffffff9d0534ff</span> &lt;__netif_receive_skb_core+<span class="number">15</span>&gt;:       push   %r12</span><br><span class="line"><span class="number">0xffffffff9d053501</span> &lt;__netif_receive_skb_core+<span class="number">17</span>&gt;:       mov    %rdi,%r12  &lt;-------------- first parameter, arg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xffffffff9d053504</span> &lt;__netif_receive_skb_core+<span class="number">20</span>&gt;:       push   %rbx</span><br><span class="line"><span class="number">0xffffffff9d053505</span> &lt;__netif_receive_skb_core+<span class="number">21</span>&gt;:       <span class="keyword">and</span>    $<span class="number">0xfffffffffffffff0</span>,%rsp</span><br><span class="line"><span class="number">0xffffffff9d053509</span> &lt;__netif_receive_skb_core+<span class="number">25</span>&gt;:       sub    $<span class="number">0x38</span>,%rsp</span><br><span class="line"><span class="number">0xffffffff9d05350d</span> &lt;__netif_receive_skb_core+<span class="number">29</span>&gt;:       mov    %rdi,<span class="number">0x10</span>(%rsp)</span><br><span class="line"><span class="number">0xffffffff9d053512</span> &lt;__netif_receive_skb_core+<span class="number">34</span>&gt;:       mov    %sil,<span class="number">0x8</span>(%rsp)</span><br><span class="line"><span class="number">0xffffffff9d053517</span> &lt;__netif_receive_skb_core+<span class="number">39</span>&gt;:       mov    %gs:<span class="number">0x28</span>,%rax</span><br><span class="line"><span class="number">0xffffffff9d053520</span> &lt;__netif_receive_skb_core+<span class="number">48</span>&gt;:       mov    %rax,<span class="number">0x30</span>(%rsp)</span><br><span class="line"><span class="number">0xffffffff9d053525</span> &lt;__netif_receive_skb_core+<span class="number">53</span>&gt;:       <span class="keyword">xor</span>    %eax,%eax</span><br><span class="line"><span class="number">0xffffffff9d053527</span> &lt;__netif_receive_skb_core+<span class="number">55</span>&gt;:       jmpq   <span class="number">0xffffffff9d0539d8</span> &lt;__netif_receive_skb_core+<span class="number">1256</span>&gt;</span><br><span class="line"><span class="number">0xffffffff9d05352c</span> &lt;__netif_receive_skb_core+<span class="number">60</span>&gt;:       nopl   <span class="number">0x0</span>(%rax,%rax,<span class="number">1</span>)</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2262</span></span><br><span class="line"><span class="number">0xffffffff9d053531</span> &lt;__netif_receive_skb_core+<span class="number">65</span>&gt;:       mov    <span class="number">0xe8</span>(%r12),%rax</span><br><span class="line"><span class="number">0xffffffff9d053539</span> &lt;__netif_receive_skb_core+<span class="number">73</span>&gt;:       sub    <span class="number">0xe0</span>(%r12),%rax</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4253</span></span><br><span class="line"><span class="number">0xffffffff9d053541</span> &lt;__netif_receive_skb_core+<span class="number">81</span>&gt;:       cmpw   $<span class="number">0xffff</span>,<span class="number">0xc0</span>(%r12)</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4250</span></span><br><span class="line"><span class="number">0xffffffff9d05354b</span> &lt;__netif_receive_skb_core+<span class="number">91</span>&gt;:       mov    <span class="number">0x20</span>(%r12),%r14</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2262</span></span><br><span class="line"><span class="number">0xffffffff9d053550</span> &lt;__netif_receive_skb_core+<span class="number">96</span>&gt;:       mov    %ax,<span class="number">0xc2</span>(%r12)</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4253</span></span><br><span class="line"><span class="number">0xffffffff9d053559</span> &lt;__netif_receive_skb_core+<span class="number">105</span>&gt;:      je     <span class="number">0xffffffff9d053cd0</span> &lt;__netif_receive_skb_core+<span class="number">2016</span>&gt;</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2174</span></span><br><span class="line"><span class="number">0xffffffff9d05355f</span> &lt;__netif_receive_skb_core+<span class="number">111</span>&gt;:      sub    <span class="number">0xc4</span>(%r12),%ax</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/net/core/dev.c: <span class="number">4243</span></span><br><span class="line"><span class="number">0xffffffff9d053568</span> &lt;__netif_receive_skb_core+<span class="number">120</span>&gt;:      mov    $<span class="number">0x1</span>,%r15d</span><br><span class="line">/usr/src/debug/kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7.x86_64/include/linux/skbuff.h: <span class="number">2174</span></span><br></pre></td></tr></table></figure>

<h4 id="linux-3-10-0-1127-el7-include-linux-fs-h"><a href="#linux-3-10-0-1127-el7-include-linux-fs-h" class="headerlink" title="linux-3.10.0-1127.el7/include/linux/fs.h"></a>linux-3.10.0-1127.el7/include/linux/fs.h</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="keyword">long</span> do_sys_open(<span class="keyword">int</span> dfd, <span class="keyword">const</span> <span class="keyword">char</span> __user *filename, <span class="keyword">int</span> flags,</span><br><span class="line">                        umode_t mode);</span><br><span class="line">$ cd /sys/kernel/debug/tracing</span><br><span class="line">$ echo <span class="string">&#x27;p:open do_sys_open file=%si&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; events/kprobes/open/enable</span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># _-----=&gt; irqs-off</span></span><br><span class="line"><span class="meta"># / _----=&gt; need-resched</span></span><br><span class="line"><span class="meta"># | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="meta"># || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="meta"># ||| / delay</span></span><br><span class="line"><span class="meta"># TASK-PID CPU# |||| TIMESTAMP FUNCTION</span></span><br><span class="line"><span class="meta"># | | | |||| | |</span></span><br><span class="line"> ls<span class="number">-13261</span> [<span class="number">005</span>] ..<span class="number">.1</span> <span class="number">104673.170507</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x250</span>) file=<span class="number">0x562bbf8fe790</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># +0(%reg):string - Makes %reg into an address that string can use</span></span><br><span class="line">$ echo <span class="string">&#x27;p:open do_sys_open file=+0(%si):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ echo <span class="string">&#x27;p:kprobes/open do_sys_open file=+0($arg2):string&#x27;</span> &gt; kprobe_events # has the same results </span><br><span class="line">$ echo <span class="number">1</span> &gt; /sys/kernel/debug/tracing/events/kprobes/open/enable</span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># entries-in-buffer/entries-written: 447/447   #P:24</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="meta">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="meta">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="meta">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="meta">#                            ||| /     delay</span></span><br><span class="line"><span class="meta">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="meta">#              | |       |   ||||       |         |</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.631212</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/interrupts&quot;</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.632541</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/stat&quot;</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.632692</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/irq/25/smp_affinity&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">### function events not work in centos 7.8 and ubuntu 20.04</span></span><br><span class="line">$ cd /sys/kernel/tracing/events</span><br><span class="line">$ echo <span class="string">&#x27;do_sys_open(NULL, string file)&#x27;</span> &gt; function_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; events/functions/do_sys_open/enable</span><br><span class="line">$ ls &gt; /dev/<span class="literal">null</span></span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># _-----=&gt; irqs-off</span></span><br><span class="line"><span class="meta"># / _----=&gt; need-resched</span></span><br><span class="line"><span class="meta"># | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="meta"># || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="meta"># ||| / delay</span></span><br><span class="line"><span class="meta"># TASK-PID CPU# |||| TIMESTAMP FUNCTION</span></span><br><span class="line"><span class="meta"># | | | |||| | |</span></span><br><span class="line"> ls<span class="number">-822</span> [<span class="number">002</span>] ..<span class="number">.2</span> <span class="number">534.996438</span>: do_syscall_64-&gt;do_sys_open(file=/dev/<span class="literal">null</span>)</span><br><span class="line"> ls<span class="number">-822</span> [<span class="number">002</span>] ..<span class="number">.2</span> <span class="number">535.002703</span>: do_syscall_64-&gt;do_sys_open(file=/etc/ld.so.cache)</span><br></pre></td></tr></table></figure>

<h4 id="example2"><a href="#example2" class="headerlink" title="example2"></a><a target="_blank" rel="noopener" href="https://events19.linuxfoundation.org/wp-content/uploads/2017/12/oss-eu-2018-fun-with-dynamic-trace-events_steven-rostedt.pdf">example2</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">(gdb) li ip_rcv</span><br><span class="line">378</span><br><span class="line">379	/*</span><br><span class="line">380	 * 	Main IP Receive routine.</span><br><span class="line">381	 */</span><br><span class="line">382	int ip_rcv(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *orig_dev)</span><br><span class="line">383	&#123;</span><br><span class="line">384		const struct iphdr *iph;</span><br><span class="line">385		u32 len;</span><br><span class="line">386</span><br><span class="line">387		/* When the interface is <span class="keyword">in</span> promisc. mode, drop all the crap</span><br><span class="line">(gdb) ptype struct net_device</span><br><span class="line"><span class="built_in">type</span> = struct net_device &#123;</span><br><span class="line">    char name[16];</span><br><span class="line">    struct hlist_node name_hlist;</span><br><span class="line">    char *ifalias;</span><br><span class="line">...</span><br><span class="line">    unsigned char perm_addr[32];</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">### not work in centos 7.8, ubuntu is ok</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:net ip_rcv dev=$arg2 name=+0($arg2):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ cat kprobe_events</span><br><span class="line">p:kprobes/net ip_rcv dev=<span class="variable">$arg2</span> name=+0(<span class="variable">$arg2</span>):string</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; events/kprobes/<span class="built_in">enable</span></span><br><span class="line">$ cat trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 460/460   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">          &lt;idle&gt;-0       [002] ..s. 201549.228307: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579520: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579534: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579542: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct net_device *)0)-&gt;perm_addr</span><br><span class="line"><span class="variable">$1</span> = 598</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:net ip_rcv name=+0($arg2):string a1=+598($arg2):x8 a2=+599($arg2):x8 a3=+600($arg2):x8 a4=+601($arg2):x8 a5=+602($arg2):x8 a6=+603($arg2):x8&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ head -n 15 trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 84/84   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">          &lt;idle&gt;-0       [021] ..s. 202995.512725: net: (ip_rcv+0x0/0xd0) name=<span class="string">&quot;br0&quot;</span> a1=0x0 a2=0x0 a3=0x0 a4=0x0 a5=0x0 a6=0x0</span><br><span class="line">           &lt;...&gt;-207344  [003] ..s. 202995.750896: net: (ip_rcv+0x0/0xd0) name=<span class="string">&quot;eno3&quot;</span> a1=0x18 a2=0x66 a3=0xda a4=0x91 a5=0x97 a6=0x9</span><br><span class="line"><span class="comment">#eno3 ether 18:66:da:91:97:09, looks like br0 no mac addr</span></span><br><span class="line"></span><br><span class="line">(gdb) li vfs_read</span><br><span class="line">446	&#125;</span><br><span class="line">447</span><br><span class="line">448	EXPORT_SYMBOL(do_sync_read);</span><br><span class="line">449</span><br><span class="line">450	ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">451	&#123;</span><br><span class="line">452		ssize_t ret;</span><br><span class="line">453</span><br><span class="line">454		<span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">455			<span class="built_in">return</span> -EBADF;</span><br><span class="line">(gdb)  ptype struct file</span><br><span class="line"><span class="built_in">type</span> = struct file &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct list_head fu_list;</span><br><span class="line">        struct callback_head fu_rcuhead;</span><br><span class="line">    &#125; f_u;</span><br><span class="line">    struct path f_path;</span><br><span class="line">    struct inode *f_inode;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct inode</span><br><span class="line"><span class="built_in">type</span> = struct inode &#123;</span><br><span class="line">    umode_t i_mode;</span><br><span class="line">    unsigned short i_opflags;</span><br><span class="line">    kuid_t i_uid;</span><br><span class="line">    kgid_t i_gid;</span><br><span class="line">    unsigned int i_flags;</span><br><span class="line">    struct posix_acl *i_acl;</span><br><span class="line">    struct posix_acl *i_default_acl;</span><br><span class="line">    const struct inode_operations *i_op;</span><br><span class="line">    struct super_block *i_sb;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct super_block</span><br><span class="line"><span class="built_in">type</span> = struct super_block &#123;</span><br><span class="line">    struct list_head s_list;</span><br><span class="line">    dev_t s_dev;</span><br><span class="line">    unsigned char s_blocksize_bits;</span><br><span class="line">    unsigned long s_blocksize;</span><br><span class="line">    loff_t s_maxbytes;</span><br><span class="line">    struct file_system_type *s_type;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct file_system_type</span><br><span class="line"><span class="built_in">type</span> = struct file_system_type &#123;</span><br><span class="line">    const char *name;</span><br><span class="line"></span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct file *)0)-&gt;f_inode</span><br><span class="line"><span class="variable">$1</span> = 32</span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct inode *)0)-&gt;i_sb</span><br><span class="line"><span class="variable">$2</span> = 40</span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct super_block *)0)-&gt;s_type</span><br><span class="line"><span class="variable">$3</span> = 40</span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct file_system_type *)0)-&gt;name</span><br><span class="line"><span class="variable">$4</span> = 0</span><br><span class="line"></span><br><span class="line"><span class="comment">### not support centos 7.8</span></span><br><span class="line">$ <span class="built_in">cd</span> /sys/kernel/debug/tracing</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; events/kprobes/<span class="built_in">enable</span></span><br><span class="line">$ cat trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 37/37   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">           &lt;...&gt;-520179  [018] .... 206923.224377: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devtmpfs&quot;</span></span><br><span class="line">           &lt;...&gt;-520179  [018] .... 206924.886880: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;sockfs&quot;</span></span><br><span class="line">           &lt;...&gt;-520240  [001] .... 206924.887006: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devpts&quot;</span></span><br><span class="line">           &lt;...&gt;-520240  [001] .... 206924.887022: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devpts&quot;</span></span><br><span class="line">           &lt;...&gt;-520240  [001] .... 206924.887029: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devpts&quot;</span></span><br><span class="line">           &lt;...&gt;-520179  [018] .... 206924.887110: myprobe: (vfs_read+0x0/0x160) name=<span class="string">&quot;devtmpfs&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="The-same-result-use-perf"><a href="#The-same-result-use-perf" class="headerlink" title="The same result use perf"></a>The same result use perf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## The server installed debug-info</span></span><br><span class="line">$ perf probe -L vfs_read:0+10</span><br><span class="line">&lt;vfs_read@/usr/src/debug/kernel-3.10.0-1127.el7/linux-3.10.0-1127.el7.x86_64/fs/read_write.c:0&gt;</span><br><span class="line">      0  ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">      1  &#123;</span><br><span class="line">                ssize_t ret;</span><br><span class="line"></span><br><span class="line">      4         <span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">      5                 <span class="built_in">return</span> -EBADF;</span><br><span class="line">      6         <span class="keyword">if</span> (!file-&gt;f_op || (!file-&gt;f_op-&gt;<span class="built_in">read</span> &amp;&amp; !file-&gt;f_op-&gt;aio_read))</span><br><span class="line">      7                 <span class="built_in">return</span> -EINVAL;</span><br><span class="line">      8         <span class="keyword">if</span> (unlikely(!access_ok(VERIFY_WRITE, buf, count)))</span><br><span class="line">      9                 <span class="built_in">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">$ perf probe <span class="string">&#x27;vfs_read file-&gt;f_inode file-&gt;f_inode-&gt;i_sb file-&gt;f_inode-&gt;i_sb-&gt;s_type file-&gt;f_inode-&gt;i_sb-&gt;s_type-&gt;name:string&#x27;</span></span><br><span class="line"><span class="comment">### echo &#x27;p:myprobe vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27; &gt; kprobe_events</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR sleep 1</span><br><span class="line">$ perf report </span><br><span class="line">  33.33%  (ffffffff87a4cf20) f_inode=0xffff8e7e363aaa80 i_sb=0xffff8e8037bda800 s_type=0xffffffffc0430500 name=<span class="string">&quot;xfs&quot;</span></span><br><span class="line">  22.22%  (ffffffff87a4cf20) f_inode=0xffff8e803b86a060 i_sb=0xffff8e7f7c923000 s_type=0xffffffff884b1be0 name=<span class="string">&quot;anon_inodefs&quot;</span></span><br><span class="line">  22.22%  (ffffffff87a4cf20) f_inode=0xffff8e803bbec8c0 i_sb=0xffff8e8037bda800 s_type=0xffffffffc0430500 name=<span class="string">&quot;xfs&quot;</span></span><br><span class="line">....</span><br><span class="line">$ perf probe -d vfs_read</span><br><span class="line">Removed event: probe:vfs_read</span><br><span class="line"></span><br><span class="line"><span class="comment">#### not support centos 7.8, work on ubuntu 20.04</span></span><br><span class="line">$ perf probe <span class="string">&#x27;vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27;</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR sleep 1</span><br><span class="line">$ perf report</span><br><span class="line">  85.71%  (ffffffff8badefd0) name=<span class="string">&quot;ext4&quot;</span></span><br><span class="line">   7.14%  (ffffffff8badefd0) name=<span class="string">&quot;proc&quot;</span></span><br><span class="line">   7.14%  (ffffffff8badefd0) name=<span class="string">&quot;tmpfs&quot;</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR sleep 1</span><br><span class="line">$ perf probe -d vfs_read</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### another example  https://docs.windriver.com/bundle/Wind_River_Linux_Tutorial_Kernel_Debugging_with_ftrace_and_kprobes_LTS_19/page/mmo1403548860893.html</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:doforkprobe _do_fork clone_flags=%ax stack_start=%dx regs=%cx parent_tidptr=+4($stack) child_tidptr=+8($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:fork_retprobe _do_fork $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:dentry_openprobe dentry_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br></pre></td></tr></table></figure>

<h3 id="Crash"><a href="#Crash" class="headerlink" title="Crash"></a>Crash</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">crash /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line"></span><br><span class="line">crash 7.2.3-10.el7</span><br><span class="line">Copyright (C) 2002-2017  Red Hat, Inc.</span><br><span class="line">Copyright (C) 2004, 2005, 2006, 2010  IBM Corporation</span><br><span class="line">Copyright (C) 1999-2006  Hewlett-Packard Co</span><br><span class="line">Copyright (C) 2005, 2006, 2011, 2012  Fujitsu Limited</span><br><span class="line">Copyright (C) 2006, 2007  VA Linux Systems Japan K.K.</span><br><span class="line">Copyright (C) 2005, 2011  NEC Corporation</span><br><span class="line">Copyright (C) 1999, 2002, 2007  Silicon Graphics, Inc.</span><br><span class="line">Copyright (C) 1999, 2000, 2001, 2002  Mission Critical Linux, Inc.</span><br><span class="line">This program is free software, covered by the GNU General Public License,</span><br><span class="line">and you are welcome to change it and/or distribute copies of it under</span><br><span class="line">certain conditions.  Enter <span class="string">&quot;help copying&quot;</span> to see the conditions.</span><br><span class="line">This program has absolutely no warranty.  Enter <span class="string">&quot;help warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">GNU gdb (GDB) 7.6</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-unknown-linux-gnu&quot;</span>...</span><br><span class="line"></span><br><span class="line">WARNING: kernel relocated [104MB]: patching 87167 gdb minimal_symbol values</span><br><span class="line"></span><br><span class="line">please <span class="built_in">wait</span>... (patching 87167 gdb minimal_symbol values)</span><br><span class="line">      KERNEL: /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line">    DUMPFILE: /dev/crash</span><br><span class="line">        CPUS: 4</span><br><span class="line">        DATE: Sun Dec 20 10:11:56 2020</span><br><span class="line">      UPTIME: 3 days, 07:23:40</span><br><span class="line">LOAD AVERAGE: 0.22, 0.07, 0.06</span><br><span class="line">       TASKS: 156</span><br><span class="line">    NODENAME: centos7-test</span><br><span class="line">     RELEASE: 3.10.0-1127.el7.x86_64</span><br><span class="line">     VERSION: <span class="comment">#1 SMP Tue Mar 31 23:36:51 UTC 2020</span></span><br><span class="line">     MACHINE: x86_64  (2394 Mhz)</span><br><span class="line">      MEMORY: 8.1 GB</span><br><span class="line">         PID: 10155</span><br><span class="line">     COMMAND: <span class="string">&quot;crash&quot;</span></span><br><span class="line">        TASK: ffff8e8038748000  [THREAD_INFO: ffff8e7eb7154000]</span><br><span class="line">         CPU: 1</span><br><span class="line">       STATE: TASK_RUNNING (ACTIVE)</span><br><span class="line"></span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; *buffer_head</span><br><span class="line">struct buffer_head &#123;</span><br><span class="line">    unsigned long b_state;</span><br><span class="line">    struct buffer_head *b_this_page;</span><br><span class="line">    struct page *b_page;</span><br><span class="line">    sector_t b_blocknr;</span><br><span class="line">    size_t b_size;</span><br><span class="line">    char *b_data;</span><br><span class="line">    struct block_device *b_bdev;</span><br><span class="line">    bh_end_io_t *b_end_io;</span><br><span class="line">    void *b_private;</span><br><span class="line">    struct list_head b_assoc_buffers;</span><br><span class="line">    struct address_space *b_assoc_map;</span><br><span class="line">    atomic_t b_count;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 104</span><br><span class="line">crash&gt; struct cpu</span><br><span class="line">struct cpu &#123;</span><br><span class="line">    int node_id;</span><br><span class="line">    int hotpluggable;</span><br><span class="line">    struct device dev;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 680</span><br><span class="line">crash&gt; struct sym jiffies</span><br><span class="line">struct: invalid data structure reference: sym</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; sym jiffies</span><br><span class="line">ffffffff8856c000 (D) jiffies</span><br><span class="line">crash&gt;</span><br><span class="line">crash&gt; files</span><br><span class="line">PID: 10155  TASK: ffff8e8038748000  CPU: 3   COMMAND: <span class="string">&quot;crash&quot;</span></span><br><span class="line">ROOT: /    CWD: /root</span><br><span class="line"> FD       FILE            DENTRY           INODE       TYPE PATH</span><br><span class="line">  0 ffff8e803b102b00 ffff8e7ea61bb480 ffff8e7ea61b5bc0 CHR  /dev/pts/0</span><br><span class="line">  1 ffff8e803b102b00 ffff8e7ea61bb480 ffff8e7ea61b5bc0 CHR  /dev/pts/0</span><br><span class="line">  2 ffff8e803b102b00 ffff8e7ea61bb480 ffff8e7ea61b5bc0 CHR  /dev/pts/0</span><br><span class="line">  3 ffff8e7e364f2f00 ffff8e7f7f827240 ffff8e8044570850 CHR  /dev/null</span><br><span class="line">  4 ffff8e803684e100 ffff8e7f7f834180 ffff8e8038ab9ae8 CHR  /dev/crash</span><br><span class="line">  5 ffff8e803684ec00 ffff8e800c25d180 ffff8e800c2d9400 REG  /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line">  6 ffff8e803aa2ac00 ffff8e800c3e6480 ffff8e800c37a9a0 FIFO</span><br><span class="line">  7 ffff8e803aa2a800 ffff8e800c3e6480 ffff8e800c37a9a0 FIFO</span><br><span class="line">  8 ffff8e803b102500 ffff8e800ead1300 ffff8e80029917c0 REG  /tmp/tmpfpagMdU</span><br><span class="line"> 10 ffff8e80445c4000 ffff8e7ea6199180 ffff8e800c37b090 FIFO</span><br><span class="line">crash&gt; struct dentry.d_inode,d_name ffff8e800ead1300</span><br><span class="line">  d_inode = 0xffff8e80029917c0</span><br><span class="line">  d_name = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">hash</span> = 1385601899,</span><br><span class="line">        len = 10</span><br><span class="line">      &#125;,</span><br><span class="line">      hash_len = 44335274859</span><br><span class="line">    &#125;,</span><br><span class="line">    name = 0xffff8e800ead1338 <span class="string">&quot;tmpfpagMdU&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">crash&gt;  rd -8 0xffff8e800ead1338 20</span><br><span class="line">ffff8e800ead1338:  74 6d 70 66 70 61 67 4d 64 55 00 63 74 00 0a 0a   tmpfpagMdU.ct...</span><br><span class="line">ffff8e800ead1348:  0a 0a 0a 0a</span><br><span class="line"></span><br><span class="line">crash&gt; mod -s sunrpc /lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line">     MODULE       NAME                            SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0b51300  sunrpc                        358543  /lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line"></span><br><span class="line">crash&gt; dmesg</span><br><span class="line">...</span><br><span class="line">[&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">crash&gt; add-symbol-file/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0bf9000</span><br><span class="line">add symbol table from file <span class="string">&quot;/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko&quot;</span> at</span><br><span class="line">        .text_addr = 0xffffffffc0bf9000</span><br><span class="line">Reading symbols from /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko...Reading symbols from /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko.debug...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">crash&gt; gdb list *xprt_transmit+0x6c</span><br><span class="line">0xffffffffc0bff38c is <span class="keyword">in</span> xprt_transmit (net/sunrpc/xprt.c:1024).</span><br><span class="line">1019                    &#125;</span><br><span class="line">1020            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!req-&gt;rq_bytes_sent)</span><br><span class="line">1021                    <span class="built_in">return</span>;</span><br><span class="line">1022</span><br><span class="line">1023            connect_cookie = xprt-&gt;connect_cookie;</span><br><span class="line">1024            status = xprt-&gt;ops-&gt;send_request(task);</span><br><span class="line">1025            trace_xprt_transmit(xprt, req-&gt;rq_xid, status);</span><br><span class="line">1026            <span class="keyword">if</span> (status != 0) &#123;</span><br><span class="line">1027                    task-&gt;tk_status = status;</span><br><span class="line">1028                    <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">crash&gt; dis -r xprt_transmit+0x6c</span><br><span class="line">0xffffffffc0b9c320 &lt;xprt_transmit&gt;:     nopl   0x0(%rax,%rax,1) [FTRACE NOP]</span><br><span class="line">0xffffffffc0b9c325 &lt;xprt_transmit+5&gt;:   push   %rbp</span><br><span class="line">0xffffffffc0b9c326 &lt;xprt_transmit+6&gt;:   mov    %rsp,%rbp</span><br><span class="line">0xffffffffc0b9c329 &lt;xprt_transmit+9&gt;:   push   %r15</span><br><span class="line">0xffffffffc0b9c32b &lt;xprt_transmit+11&gt;:  push   %r14</span><br><span class="line">0xffffffffc0b9c32d &lt;xprt_transmit+13&gt;:  mov    %rdi,%r14</span><br><span class="line">0xffffffffc0b9c330 &lt;xprt_transmit+16&gt;:  push   %r13</span><br><span class="line">0xffffffffc0b9c332 &lt;xprt_transmit+18&gt;:  push   %r12</span><br><span class="line">0xffffffffc0b9c334 &lt;xprt_transmit+20&gt;:  push   %rbx</span><br><span class="line">0xffffffffc0b9c335 &lt;xprt_transmit+21&gt;:  sub    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">0xffffffffc0b9c339 &lt;xprt_transmit+25&gt;:  testb  <span class="variable">$0x1</span>,0x38f0c(%rip)        <span class="comment"># 0xffffffffc0bd524c</span></span><br><span class="line">0xffffffffc0b9c340 &lt;xprt_transmit+32&gt;:  mov    0xb8(%rdi),%r12</span><br><span class="line">0xffffffffc0b9c347 &lt;xprt_transmit+39&gt;:  mov    (%r12),%r15</span><br><span class="line">0xffffffffc0b9c34b &lt;xprt_transmit+43&gt;:  jne    0xffffffffc0b9c63a &lt;xprt_transmit+794&gt;</span><br><span class="line">0xffffffffc0b9c351 &lt;xprt_transmit+49&gt;:  cmpq   <span class="variable">$0x0</span>,0xf0(%r12)</span><br><span class="line">0xffffffffc0b9c35a &lt;xprt_transmit+58&gt;:  jne    0xffffffffc0b9c3b8 &lt;xprt_transmit+152&gt;</span><br><span class="line">0xffffffffc0b9c35c &lt;xprt_transmit+60&gt;:  lea    0xb8(%r12),%rbx</span><br><span class="line">0xffffffffc0b9c364 &lt;xprt_transmit+68&gt;:  cmp    0xb8(%r12),%rbx</span><br><span class="line">0xffffffffc0b9c36c &lt;xprt_transmit+76&gt;:  je     0xffffffffc0b9c510 &lt;xprt_transmit+496&gt;</span><br><span class="line">0xffffffffc0b9c372 &lt;xprt_transmit+82&gt;:  mov    0x440(%r15),%eax</span><br><span class="line">0xffffffffc0b9c379 &lt;xprt_transmit+89&gt;:  mov    %r14,%rdi</span><br><span class="line">0xffffffffc0b9c37c &lt;xprt_transmit+92&gt;:  mov    %eax,-0x30(%rbp)</span><br><span class="line">0xffffffffc0b9c37f &lt;xprt_transmit+95&gt;:  mov    0x8(%r15),%rax</span><br><span class="line">0xffffffffc0b9c383 &lt;xprt_transmit+99&gt;:  mov    0x50(%rax),%rax</span><br><span class="line">0xffffffffc0b9c387 &lt;xprt_transmit+103&gt;: callq  0xffffffffa5f96410 &lt;__x86_indirect_thunk_rax&gt;</span><br><span class="line">0xffffffffc0b9c38c &lt;xprt_transmit+108&gt;: mov    %eax,%ebx</span><br><span class="line"></span><br><span class="line">crash&gt; sym 0xffffffffc0b9c510</span><br><span class="line">ffffffffc0b9c510 (t) xprt_transmit+496 [sunrpc]</span><br><span class="line"></span><br><span class="line">crash&gt; whatis xprt_transmit</span><br><span class="line">void xprt_transmit(struct rpc_task *);</span><br><span class="line"></span><br><span class="line">crash&gt; whatis __x86_indirect_thunk_rax</span><br><span class="line">&lt;text variable, no debug info&gt; __x86_indirect_thunk_rax;</span><br></pre></td></tr></table></figure>

<p>——— re-run</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line">[Wed Dec 23 22:03:22 2020] Modules linked <span class="keyword">in</span>: rpcsec_gss_krb5 auth_rpcgss nfsv4 dns_resolver nfs lockd grace fscache dell_rbu bonding sunrpc iTCO_wdt iTCO_vendor_support mxm_wmi dcdbas vfat fat sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr joydev lpc_ich sg mei_me mei ipmi_si ipmi_devintf ipmi_msghandler wmi acpi_power_meter binfmt_misc ip_tables xfs sr_mod cdrom sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm bnx2x ahci drm mpt3sas crct10dif_pclmul crct10dif_common crc32c_intel libahci megaraid_sas mdio libata raid_class ptp drm_panel_orientation_quirks scsi_transport_sas pps_core libcrc32c</span><br><span class="line">[Wed Dec 23 22:03:22 2020] CPU: 6 PID: 70273 Comm: kworker/u434:1 Kdump: loaded Tainted: G             L ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Wed Dec 23 22:03:22 2020] Hardware name: Dell Inc. PowerEdge R630/0CNCJW, BIOS 2.11.0 11/02/2019</span><br><span class="line">[Wed Dec 23 22:03:22 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RIP: 0010:[&lt;ffffffffc0b97de0&gt;]  [&lt;ffffffffc0b97de0&gt;] call_transmit+0x0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RSP: 0018:ffff8ebe1e183da8  EFLAGS: 00000282</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RAX: 0000000000000005 RBX: ffff8ebe1e183d38 RCX: 00000000ffffffe0</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RDX: ffff8ebe3155b05c RSI: ffff8ebe1e183cb0 RDI: ffff8ece3a176100</span><br><span class="line">[Wed Dec 23 22:03:22 2020] RBP: ffff8ebe1e183e08 R08: ffff8ebe3af63b08 R09: 0000000000000001</span><br><span class="line">[Wed Dec 23 22:03:22 2020] R10: ffff8ebe1e183d00 R11: ffff8ebe1e183c88 R12: 0000000000000010</span><br><span class="line">[Wed Dec 23 22:03:22 2020] R13: ffffffffa5c6911b R14: ffff8ebe3155b084 R15: ffff8ece3a176100</span><br><span class="line">[Wed Dec 23 22:03:22 2020] FS:  0000000000000000(0000) GS:ffff8ebe3e2c0000(0000) knlGS:0000000000000000</span><br><span class="line">[Wed Dec 23 22:03:22 2020] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[Wed Dec 23 22:03:22 2020] CR2: 00007f9186d4dc70 CR3: 000000028aa10000 CR4: 00000000001607e0</span><br><span class="line">[Wed Dec 23 22:03:22 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffc0ba51c9&gt;] ? __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:03:22 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:22 2020] Code: 00 48 c7 c7 60 57 bc c0 48 8b b0 90 05 00 00 31 c0 e8 8d 18 7e e5 41 b8 f3 ff ff ff e9 ee fa ff ff 66 2e 0f 1f 84 00 00 00 00 00 &lt;0f&gt; 1f 44 00 00 55 f6 05 5f d4 03 00 02 48 89 e5 41 56 41 55 41</span><br><span class="line">[Wed Dec 23 22:03:50 2020] NMI watchdog: BUG: soft lockup - CPU<span class="comment">#6 stuck for 22s! [kworker/u434:1:70273]</span></span><br><span class="line">[Wed Dec 23 22:03:50 2020] Modules linked <span class="keyword">in</span>: rpcsec_gss_krb5 auth_rpcgss nfsv4 dns_resolver nfs lockd grace fscache dell_rbu bonding sunrpc iTCO_wdt iTCO_vendor_support mxm_wmi dcdbas vfat fat sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr joydev lpc_ich sg mei_me mei ipmi_si ipmi_devintf ipmi_msghandler wmi acpi_power_meter binfmt_misc ip_tables xfs sr_mod cdrom sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm bnx2x ahci drm mpt3sas crct10dif_pclmul crct10dif_common crc32c_intel libahci megaraid_sas mdio libata raid_class ptp drm_panel_orientation_quirks scsi_transport_sas pps_core libcrc32c</span><br><span class="line">[Wed Dec 23 22:03:50 2020] CPU: 6 PID: 70273 Comm: kworker/u434:1 Kdump: loaded Tainted: G             L ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Wed Dec 23 22:03:50 2020] Hardware name: Dell Inc. PowerEdge R630/0CNCJW, BIOS 2.11.0 11/02/2019</span><br><span class="line">[Wed Dec 23 22:03:50 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RIP: 0010:[&lt;ffffffffa638ce89&gt;]  [&lt;ffffffffa638ce89&gt;] kprobe_ftrace_handler+0x69/0x120</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RSP: 0018:ffff8ebe1e183c10  EFLAGS: 00000282</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RAX: 0000000000000001 RBX: 0000000000000004 RCX: ffffffffc0b9fc55</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RDX: 0000000000000001 RSI: ffffffffffffffe0 RDI: 0000000000000282</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RBP: ffff8ebe1e183c40 R08: 00000000359c2550 R09: 000000000000001f</span><br><span class="line">[Wed Dec 23 22:03:50 2020] R10: 00000000359c2550 R11: ffff8ebe1e183c88 R12: ffff8ebe3155b05c</span><br><span class="line">[Wed Dec 23 22:03:50 2020] R13: ffff8ebe3155b058 R14: ffff8ebe3af63b08 R15: 0000000000000001</span><br><span class="line">[Wed Dec 23 22:03:50 2020] FS:  0000000000000000(0000) GS:ffff8ebe3e2c0000(0000) knlGS:0000000000000000</span><br><span class="line">[Wed Dec 23 22:03:50 2020] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[Wed Dec 23 22:03:50 2020] CR2: 00007f9186d4dc70 CR3: 000000028aa10000 CR4: 00000000001607e0</span><br><span class="line">[Wed Dec 23 22:03:50 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5d62634&gt;] ftrace_ops_list_func+0xf4/0x120</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa6396b14&gt;] ftrace_regs_call+0x5/0x81</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5c6911b&gt;] ? arch_unoptimize_kprobes+0xdb/0xdb</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b97fb0&gt;] call_transmit+0x1d0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0ba51c9&gt;] __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:03:50 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:03:50 2020] Code: 75 24 49 c7 c6 a0 33 01 00 65 4c 03 35 71 43 c8 59 65 48 8b 05 51 66 c8 59 48 85 c0 74 24 4c 89 e7 e8 5c 37 00 00 48 89 df 57 9d &lt;0f&gt; 1f 44 00 00 48 83 c4 08 5b 41 5c 41 5d 41 5e 41 5f 5d c3 0f</span><br><span class="line">[Wed Dec 23 22:04:02 2020] INFO: rcu_sched self-detected stall on CPU &#123; 6&#125;  (t=600013 jiffies g=238339 c=238338 q=49819)</span><br><span class="line">[Wed Dec 23 22:04:02 2020] Task dump <span class="keyword">for</span> CPU 6:</span><br><span class="line">[Wed Dec 23 22:04:02 2020] kworker/u434:1  R  running task        0 70273      2 0x00000088</span><br><span class="line">[Wed Dec 23 22:04:02 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  &lt;IRQ&gt;  [&lt;ffffffffa5cdab18&gt;] sched_show_task+0xa8/0x110</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cde919&gt;] dump_cpu_task+0x39/0x70</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d58b90&gt;] rcu_dump_cpu_stacks+0x90/0xd0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d5c252&gt;] rcu_check_callbacks+0x442/0x730</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d10ae0&gt;] ? tick_sched_do_timer+0x50/0x50</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5caf9d6&gt;] update_process_times+0x46/0x80</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d10850&gt;] tick_sched_handle+0x30/0x70</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d10b19&gt;] tick_sched_timer+0x39/0x80</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5ccaa8e&gt;] __hrtimer_run_queues+0x10e/0x270</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5ccafef&gt;] hrtimer_interrupt+0xaf/0x1d0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc51&gt;] ? xs_tcp_send_request+0x1/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5c5caeb&gt;] local_apic_timer_interrupt+0x3b/0x60</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa63979c3&gt;] smp_apic_timer_interrupt+0x43/0x60</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6393efa&gt;] apic_timer_interrupt+0x16a/0x170</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  &lt;EOI&gt;  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa638ce89&gt;] ? kprobe_ftrace_handler+0x69/0x120</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5d62634&gt;] ftrace_ops_list_func+0xf4/0x120</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6396b14&gt;] ftrace_regs_call+0x5/0x81</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5c6911b&gt;] ? arch_unoptimize_kprobes+0xdb/0xdb</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b97fb0&gt;] call_transmit+0x1d0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0ba51c9&gt;] __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:30 2020] NMI watchdog: BUG: soft lockup - CPU<span class="comment">#6 stuck for 23s! [kworker/u434:1:70273]</span></span><br><span class="line">[Wed Dec 23 22:04:30 2020] Modules linked <span class="keyword">in</span>: rpcsec_gss_krb5 auth_rpcgss nfsv4 dns_resolver nfs lockd grace fscache dell_rbu bonding sunrpc iTCO_wdt iTCO_vendor_support mxm_wmi dcdbas vfat fat sb_edac intel_powerclamp coretemp intel_rapl iosf_mbi kvm_intel kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr joydev lpc_ich sg mei_me mei ipmi_si ipmi_devintf ipmi_msghandler wmi acpi_power_meter binfmt_misc ip_tables xfs sr_mod cdrom sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm bnx2x ahci drm mpt3sas crct10dif_pclmul crct10dif_common crc32c_intel libahci megaraid_sas mdio libata raid_class ptp drm_panel_orientation_quirks scsi_transport_sas pps_core libcrc32c</span><br><span class="line">[Wed Dec 23 22:04:30 2020] CPU: 6 PID: 70273 Comm: kworker/u434:1 Kdump: loaded Tainted: G             L ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Wed Dec 23 22:04:30 2020] Hardware name: Dell Inc. PowerEdge R630/0CNCJW, BIOS 2.11.0 11/02/2019</span><br><span class="line">[Wed Dec 23 22:04:30 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RIP: 0010:[&lt;ffffffffa638ce92&gt;]  [&lt;ffffffffa638ce92&gt;] kprobe_ftrace_handler+0x72/0x120</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RSP: 0018:ffff8ebe1e183c18  EFLAGS: 00000286</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RAX: 0000000000000001 RBX: ffff8ebe3af63b08 RCX: ffffffffc0b9fc55</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RDX: 0000000000000001 RSI: ffffffffffffffe0 RDI: 0000000000000282</span><br><span class="line">[Wed Dec 23 22:04:30 2020] RBP: ffff8ebe1e183c40 R08: 000000003968f6f0 R09: 000000000000001f</span><br><span class="line">[Wed Dec 23 22:04:30 2020] R10: 000000003968f6f0 R11: ffff8ebe1e183c88 R12: ffff8ebe1e183d00</span><br><span class="line">[Wed Dec 23 22:04:30 2020] R13: ffff8ebe1e183c88 R14: ffff8ebe3af63b08 R15: ffff8ebe1e183c00</span><br><span class="line">[Wed Dec 23 22:04:30 2020] FS:  0000000000000000(0000) GS:ffff8ebe3e2c0000(0000) knlGS:0000000000000000</span><br><span class="line">[Wed Dec 23 22:04:30 2020] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[Wed Dec 23 22:04:30 2020] CR2: 00007f9186d4dc70 CR3: 000000028aa10000 CR4: 00000000001607e0</span><br><span class="line">[Wed Dec 23 22:04:30 2020] Call Trace:</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5d62634&gt;] ftrace_ops_list_func+0xf4/0x120</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa6396b14&gt;] ftrace_regs_call+0x5/0x81</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5c6911b&gt;] ? arch_unoptimize_kprobes+0xdb/0xdb</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b9c38c&gt;] ? xprt_transmit+0x6c/0x360 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b97fb0&gt;] call_transmit+0x1d0/0x2c0 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0b97de0&gt;] ? call_decode+0x880/0x880 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0ba51c9&gt;] __rpc_execute+0x99/0x420 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa6385922&gt;] ? __schedule+0x402/0x840</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffc0ba5562&gt;] rpc_async_schedule+0x12/0x20 [sunrpc]</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cbe6bf&gt;] process_one_work+0x17f/0x440</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cbf7d6&gt;] worker_thread+0x126/0x3c0</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cbf6b0&gt;] ? manage_workers.isra.26+0x2a0/0x2a0</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cc6691&gt;] kthread+0xd1/0xe0</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa6392d37&gt;] ret_from_fork_nospec_begin+0x21/0x21</span><br><span class="line">[Wed Dec 23 22:04:30 2020]  [&lt;ffffffffa5cc65c0&gt;] ? insert_kthread_work+0x40/0x40</span><br><span class="line">[Wed Dec 23 22:04:30 2020] Code: 65 4c 03 35 71 43 c8 59 65 48 8b 05 51 66 c8 59 48 85 c0 74 24 4c 89 e7 e8 5c 37 00 00 48 89 df 57 9d 0f 1f 44 00 00 48 83 c4 08 &lt;5b&gt; 41 5c 41 5d 41 5e 41 5f 5d c3 0f 1f 00 49 83 c5 01 49 8b 8f</span><br><span class="line"></span><br><span class="line"><span class="comment">## loading external kernel module</span></span><br><span class="line">crash&gt; add-symbol-file /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0bf9000</span><br><span class="line">add symbol table from file <span class="string">&quot;/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko&quot;</span> at</span><br><span class="line">        .text_addr = 0xffffffffc0bf9000</span><br><span class="line">Reading symbols from /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko...Reading symbols from /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko.debug...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">or you could</span><br><span class="line"></span><br><span class="line">crash&gt; mod -s sunrpc /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line">     MODULE       NAME                            SIZE  OBJECT FILE</span><br><span class="line">ffffffffc0bd2300  sunrpc                        358543  /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko</span><br><span class="line"></span><br><span class="line"><span class="comment">### crash run script</span></span><br><span class="line">crash&gt; &lt; /tmp/test.sh</span><br><span class="line"></span><br><span class="line">crash&gt; struct -o rpc_task</span><br><span class="line">struct rpc_task &#123;</span><br><span class="line">    [0] atomic_t tk_count;</span><br><span class="line">    [4] int tk_status;</span><br><span class="line">    [8] struct list_head tk_task;</span><br><span class="line">   [24] void (*tk_callback)(struct rpc_task *);</span><br><span class="line">   [32] void (*tk_action)(struct rpc_task *);</span><br><span class="line">   [40] unsigned long tk_timeout;</span><br><span class="line">   [48] unsigned long tk_runstate;</span><br><span class="line">   [56] struct rpc_wait_queue *tk_waitqueue;</span><br><span class="line">        union &#123;</span><br><span class="line">            struct work_struct tk_work;</span><br><span class="line">            struct rpc_wait tk_wait;</span><br><span class="line">   [64] &#125; u;</span><br><span class="line">  [120] struct rpc_message tk_msg;</span><br><span class="line">  [152] void *tk_calldata;</span><br><span class="line">  [160] const struct rpc_call_ops *tk_ops;</span><br><span class="line">  [168] struct rpc_clnt *tk_client;</span><br><span class="line">  [176] struct rpc_xprt *tk_xprt;</span><br><span class="line">  [184] struct rpc_rqst *tk_rqstp;</span><br><span class="line">  [192] struct workqueue_struct *tk_workqueue;</span><br><span class="line">  [200] ktime_t tk_start;</span><br><span class="line">  [208] pid_t tk_owner;</span><br><span class="line">  [212] unsigned short tk_flags;</span><br><span class="line">  [214] unsigned short tk_timeouts;</span><br><span class="line">  [216] unsigned short tk_pid;</span><br><span class="line">  [218] unsigned char tk_priority : 2;</span><br><span class="line">  [218] unsigned char tk_garb_retry : 2;</span><br><span class="line">  [218] unsigned char tk_cred_retry : 2;</span><br><span class="line">  [218] unsigned char tk_rebind_retry : 2;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 224</span><br><span class="line"></span><br><span class="line">crash&gt; kmem -s</span><br><span class="line">CACHE            NAME                 OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE</span><br><span class="line">ffff8ece2ef38300 nfs_direct_cache         352          0         0      0    16k</span><br><span class="line">ffff8ece2ef38200 nfs_commit_data          696          4        46      1    32k</span><br><span class="line">ffff8ece2ef38100 nfs_read_data            888         32       216      6    32k</span><br><span class="line">ffff8ece2ef38000 nfs_inode_cache         1040        180       279      9    32k</span><br><span class="line"></span><br><span class="line">crash&gt; kmem -S nfs_inode_cache</span><br><span class="line"></span><br><span class="line">[Wed Dec 23 22:03:50 2020] Workqueue: rpciod rpc_async_schedule [sunrpc]</span><br><span class="line">[Wed Dec 23 22:03:50 2020] task: ffff8ebe3a03e2a0 ti: ffff8ebe1e180000 task.ti: ffff8ebe1e180000</span><br><span class="line">[Wed Dec 23 22:03:50 2020] RIP: 0010:[&lt;ffffffffa638ce89&gt;]  [&lt;ffffffffa638ce89&gt;] kprobe_ftrace_handler+0x69/0x120</span><br><span class="line"></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa6393efa&gt;] apic_timer_interrupt+0x16a/0x170</span><br><span class="line">[Wed Dec 23 22:04:02 2020]  &lt;EOI&gt;  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc] <span class="comment">## got bad value</span></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffa638ce89&gt;] ? kprobe_ftrace_handler+0x69/0x120 <span class="comment">## insert the error</span></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc55&gt;] ? xs_tcp_send_request+0x5/0x230 [sunrpc]  <span class="comment">## the normal return</span></span><br><span class="line">[Wed Dec 23 22:04:02 2020]  [&lt;ffffffffc0b9fc50&gt;] ? xs_tcp_write_space+0x70/0x70 [sunrpc]</span><br><span class="line"></span><br><span class="line"><span class="comment">##linux-3.10.0-1127.el7/tools/include/uapi/asm-generic/errno-base.h</span></span><br><span class="line">/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span><br><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define	EPERM		 1	/* Operation not permitted */</span></span><br><span class="line"><span class="comment">#define	ENOENT		 2	/* No such file or directory */</span></span><br><span class="line"><span class="comment">#define	ESRCH		 3	/* No such process */</span></span><br><span class="line"><span class="comment">#define	EINTR		 4	/* Interrupted system call */</span></span><br><span class="line"><span class="comment">#define	EIO		 5	/* I/O error */</span></span><br><span class="line"><span class="comment">#define	ENXIO		 6	/* No such device or address */</span></span><br><span class="line"><span class="comment">#define	E2BIG		 7	/* Argument list too long */</span></span><br><span class="line"><span class="comment">#define	ENOEXEC		 8	/* Exec format error */</span></span><br><span class="line"><span class="comment">#define	EBADF		 9	/* Bad file number */</span></span><br><span class="line"><span class="comment">#define	ECHILD		10	/* No child processes */</span></span><br><span class="line"><span class="comment">#define	EAGAIN		11	/* Try again */</span></span><br><span class="line"><span class="comment">#define	ENOMEM		12	/* Out of memory */</span></span><br><span class="line"><span class="comment">#define	EACCES		13	/* Permission denied */</span></span><br><span class="line"><span class="comment">#define	EFAULT		14	/* Bad address */</span></span><br><span class="line"><span class="comment">#define	ENOTBLK		15	/* Block device required */</span></span><br><span class="line"><span class="comment">#define	EBUSY		16	/* Device or resource busy */</span></span><br><span class="line"><span class="comment">#define	EEXIST		17	/* File exists */</span></span><br><span class="line"><span class="comment">#define	EXDEV		18	/* Cross-device link */</span></span><br><span class="line"><span class="comment">#define	ENODEV		19	/* No such device */</span></span><br><span class="line"><span class="comment">#define	ENOTDIR		20	/* Not a directory */</span></span><br><span class="line"><span class="comment">#define	EISDIR		21	/* Is a directory */</span></span><br><span class="line"><span class="comment">#define	EINVAL		22	/* Invalid argument */</span></span><br><span class="line"><span class="comment">#define	ENFILE		23	/* File table overflow */</span></span><br><span class="line"><span class="comment">#define	EMFILE		24	/* Too many open files */</span></span><br><span class="line"><span class="comment">#define	ENOTTY		25	/* Not a typewriter */</span></span><br><span class="line"><span class="comment">#define	ETXTBSY		26	/* Text file busy */</span></span><br><span class="line"><span class="comment">#define	EFBIG		27	/* File too large */</span></span><br><span class="line"><span class="comment">#define	ENOSPC		28	/* No space left on device */</span></span><br><span class="line"><span class="comment">#define	ESPIPE		29	/* Illegal seek */</span></span><br><span class="line"><span class="comment">#define	EROFS		30	/* Read-only file system */</span></span><br><span class="line"><span class="comment">#define	EMLINK		31	/* Too many links */</span></span><br><span class="line"><span class="comment">#define	EPIPE		32	/* Broken pipe */</span></span><br><span class="line"><span class="comment">#define	EDOM		33	/* Math argument out of domain of func */</span></span><br><span class="line"><span class="comment">#define	ERANGE		34	/* Math result not representable */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat linux-3.10.0-1127.el7/tools/include/uapi/asm-generic/errno.h</span></span><br><span class="line"></span><br><span class="line">/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span><br><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;asm-generic/errno-base.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define	EDEADLK		35	/* Resource deadlock would occur */</span></span><br><span class="line"><span class="comment">#define	ENAMETOOLONG	36	/* File name too long */</span></span><br><span class="line"><span class="comment">#define	ENOLCK		37	/* No record locks available */</span></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * This error code is special: arch syscall entry code will <span class="built_in">return</span></span><br><span class="line"> * -ENOSYS <span class="keyword">if</span> users try to call a syscall that doesn<span class="string">&#x27;t exist.  To keep</span></span><br><span class="line"><span class="string"> * failures of syscalls that really do exist distinguishable from</span></span><br><span class="line"><span class="string"> * failures due to attempts to use a nonexistent syscall, syscall</span></span><br><span class="line"><span class="string"> * implementations should refrain from returning -ENOSYS.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">#define	ENOSYS		38	/* Invalid system call number */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define	ENOTEMPTY	39	/* Directory not empty */</span></span><br><span class="line"><span class="string">#define	ELOOP		40	/* Too many symbolic links encountered */</span></span><br><span class="line"><span class="string">#define	EWOULDBLOCK	EAGAIN	/* Operation would block */</span></span><br><span class="line"><span class="string">#define	ENOMSG		42	/* No message of desired type */</span></span><br><span class="line"><span class="string">#define	EIDRM		43	/* Identifier removed */</span></span><br><span class="line"><span class="string">#define	ECHRNG		44	/* Channel number out of range */</span></span><br><span class="line"><span class="string">#define	EL2NSYNC	45	/* Level 2 not synchronized */</span></span><br><span class="line"><span class="string">#define	EL3HLT		46	/* Level 3 halted */</span></span><br><span class="line"><span class="string">#define	EL3RST		47	/* Level 3 reset */</span></span><br><span class="line"><span class="string">#define	ELNRNG		48	/* Link number out of range */</span></span><br><span class="line"><span class="string">#define	EUNATCH		49	/* Protocol driver not attached */</span></span><br><span class="line"><span class="string">#define	ENOCSI		50	/* No CSI structure available */</span></span><br><span class="line"><span class="string">#define	EL2HLT		51	/* Level 2 halted */</span></span><br><span class="line"><span class="string">#define	EBADE		52	/* Invalid exchange */</span></span><br><span class="line"><span class="string">#define	EBADR		53	/* Invalid request descriptor */</span></span><br><span class="line"><span class="string">#define	EXFULL		54	/* Exchange full */</span></span><br><span class="line"><span class="string">#define	ENOANO		55	/* No anode */</span></span><br><span class="line"><span class="string">#define	EBADRQC		56	/* Invalid request code */</span></span><br><span class="line"><span class="string">#define	EBADSLT		57	/* Invalid slot */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define	EDEADLOCK	EDEADLK</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define	EBFONT		59	/* Bad font file format */</span></span><br><span class="line"><span class="string">#define	ENOSTR		60	/* Device not a stream */</span></span><br><span class="line"><span class="string">#define	ENODATA		61	/* No data available */</span></span><br><span class="line"><span class="string">#define	ETIME		62	/* Timer expired */</span></span><br><span class="line"><span class="string">#define	ENOSR		63	/* Out of streams resources */</span></span><br><span class="line"><span class="string">#define	ENONET		64	/* Machine is not on the network */</span></span><br><span class="line"><span class="string">#define	ENOPKG		65	/* Package not installed */</span></span><br><span class="line"><span class="string">#define	EREMOTE		66	/* Object is remote */</span></span><br><span class="line"><span class="string">#define	ENOLINK		67	/* Link has been severed */</span></span><br><span class="line"><span class="string">#define	EADV		68	/* Advertise error */</span></span><br><span class="line"><span class="string">#define	ESRMNT		69	/* Srmount error */</span></span><br><span class="line"><span class="string">#define	ECOMM		70	/* Communication error on send */</span></span><br><span class="line"><span class="string">#define	EPROTO		71	/* Protocol error */</span></span><br><span class="line"><span class="string">#define	EMULTIHOP	72	/* Multihop attempted */</span></span><br><span class="line"><span class="string">#define	EDOTDOT		73	/* RFS specific error */</span></span><br><span class="line"><span class="string">#define	EBADMSG		74	/* Not a data message */</span></span><br><span class="line"><span class="string">#define	EOVERFLOW	75	/* Value too large for defined data type */</span></span><br><span class="line"><span class="string">#define	ENOTUNIQ	76	/* Name not unique on network */</span></span><br><span class="line"><span class="string">#define	EBADFD		77	/* File descriptor in bad state */</span></span><br><span class="line"><span class="string">#define	EREMCHG		78	/* Remote address changed */</span></span><br><span class="line"><span class="string">#define	ELIBACC		79	/* Can not access a needed shared library */</span></span><br><span class="line"><span class="string">#define	ELIBBAD		80	/* Accessing a corrupted shared library */</span></span><br><span class="line"><span class="string">#define	ELIBSCN		81	/* .lib section in a.out corrupted */</span></span><br><span class="line"><span class="string">#define	ELIBMAX		82	/* Attempting to link in too many shared libraries */</span></span><br><span class="line"><span class="string">#define	ELIBEXEC	83	/* Cannot exec a shared library directly */</span></span><br><span class="line"><span class="string">#define	EILSEQ		84	/* Illegal byte sequence */</span></span><br><span class="line"><span class="string">#define	ERESTART	85	/* Interrupted system call should be restarted */</span></span><br><span class="line"><span class="string">#define	ESTRPIPE	86	/* Streams pipe error */</span></span><br><span class="line"><span class="string">#define	EUSERS		87	/* Too many users */</span></span><br><span class="line"><span class="string">#define	ENOTSOCK	88	/* Socket operation on non-socket */</span></span><br><span class="line"><span class="string">#define	EDESTADDRREQ	89	/* Destination address required */</span></span><br><span class="line"><span class="string">#define	EMSGSIZE	90	/* Message too long */</span></span><br><span class="line"><span class="string">#define	EPROTOTYPE	91	/* Protocol wrong type for socket */</span></span><br><span class="line"><span class="string">#define	ENOPROTOOPT	92	/* Protocol not available */</span></span><br><span class="line"><span class="string">#define	EPROTONOSUPPORT	93	/* Protocol not supported */</span></span><br><span class="line"><span class="string">#define	ESOCKTNOSUPPORT	94	/* Socket type not supported */</span></span><br><span class="line"><span class="string">#define	EOPNOTSUPP	95	/* Operation not supported on transport endpoint */</span></span><br><span class="line"><span class="string">#define	EPFNOSUPPORT	96	/* Protocol family not supported */</span></span><br><span class="line"><span class="string">#define	EAFNOSUPPORT	97	/* Address family not supported by protocol */</span></span><br><span class="line"><span class="string">#define	EADDRINUSE	98	/* Address already in use */</span></span><br><span class="line"><span class="string">#define	EADDRNOTAVAIL	99	/* Cannot assign requested address */</span></span><br><span class="line"><span class="string">#define	ENETDOWN	100	/* Network is down */</span></span><br><span class="line"><span class="string">#define	ENETUNREACH	101	/* Network is unreachable */</span></span><br><span class="line"><span class="string">#define	ENETRESET	102	/* Network dropped connection because of reset */</span></span><br><span class="line"><span class="string">#define	ECONNABORTED	103	/* Software caused connection abort */</span></span><br><span class="line"><span class="string">#define	ECONNRESET	104	/* Connection reset by peer */</span></span><br><span class="line"><span class="string">#define	ENOBUFS		105	/* No buffer space available */</span></span><br><span class="line"><span class="string">#define	EISCONN		106	/* Transport endpoint is already connected */</span></span><br><span class="line"><span class="string">#define	ENOTCONN	107	/* Transport endpoint is not connected */</span></span><br><span class="line"><span class="string">#define	ESHUTDOWN	108	/* Cannot send after transport endpoint shutdown */</span></span><br><span class="line"><span class="string">#define	ETOOMANYREFS	109	/* Too many references: cannot splice */</span></span><br><span class="line"><span class="string">#define	ETIMEDOUT	110	/* Connection timed out */</span></span><br><span class="line"><span class="string">#define	ECONNREFUSED	111	/* Connection refused */</span></span><br><span class="line"><span class="string">#define	EHOSTDOWN	112	/* Host is down */</span></span><br><span class="line"><span class="string">#define	EHOSTUNREACH	113	/* No route to host */</span></span><br><span class="line"><span class="string">#define	EALREADY	114	/* Operation already in progress */</span></span><br><span class="line"><span class="string">#define	EINPROGRESS	115	/* Operation now in progress */</span></span><br><span class="line"><span class="string">#define	ESTALE		116	/* Stale file handle */</span></span><br><span class="line"><span class="string">#define	EUCLEAN		117	/* Structure needs cleaning */</span></span><br><span class="line"><span class="string">#define	ENOTNAM		118	/* Not a XENIX named type file */</span></span><br><span class="line"><span class="string">#define	ENAVAIL		119	/* No XENIX semaphores available */</span></span><br><span class="line"><span class="string">#define	EISNAM		120	/* Is a named type file */</span></span><br><span class="line"><span class="string">#define	EREMOTEIO	121	/* Remote I/O error */</span></span><br><span class="line"><span class="string">#define	EDQUOT		122	/* Quota exceeded */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define	ENOMEDIUM	123	/* No medium found */</span></span><br><span class="line"><span class="string">#define	EMEDIUMTYPE	124	/* Wrong medium type */</span></span><br><span class="line"><span class="string">#define	ECANCELED	125	/* Operation Canceled */</span></span><br><span class="line"><span class="string">#define	ENOKEY		126	/* Required key not available */</span></span><br><span class="line"><span class="string">#define	EKEYEXPIRED	127	/* Key has expired */</span></span><br><span class="line"><span class="string">#define	EKEYREVOKED	128	/* Key has been revoked */</span></span><br><span class="line"><span class="string">#define	EKEYREJECTED	129	/* Key was rejected by service */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* for robust mutexes */</span></span><br><span class="line"><span class="string">#define	EOWNERDEAD	130	/* Owner died */</span></span><br><span class="line"><span class="string">#define	ENOTRECOVERABLE	131	/* State not recoverable */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define ERFKILL		132	/* Operation not possible due to RF-kill */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#define EHWPOISON	133	/* Memory page has hardware error */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1.   Reserve an RPC call slot</span></span><br><span class="line"><span class="string">static void call_reserve(struct rpc_task *task)</span></span><br><span class="line"><span class="string">1b.  Grok the result of xprt_reserve() ,what is xprt_reserve() ? net/sunrpc/xprt.c: * xprt_reserve - allocate an RPC request slot</span></span><br><span class="line"><span class="string">     void xprt_reserve(struct rpc_task *task)</span></span><br><span class="line"><span class="string">static void call_reserveresult(struct rpc_task *task)</span></span><br><span class="line"><span class="string">1c.  Retry reserving an RPC call slot</span></span><br><span class="line"><span class="string">static void call_retry_reserve(struct rpc_task *task)</span></span><br><span class="line"><span class="string">2.   Bind and/or refresh the credentials</span></span><br><span class="line"><span class="string">   static void call_refresh(struct rpc_task *task)</span></span><br><span class="line"><span class="string">2a.  Process the results of a credential refresh</span></span><br><span class="line"><span class="string">   static void call_refreshresult(struct rpc_task *task)</span></span><br><span class="line"><span class="string">2b.  Allocate the buffer. For details, see sched.c:rpc_malloc. (Note: buffer memory is freed in xprt_release).</span></span><br><span class="line"><span class="string">   static void call_allocate(struct rpc_task *task)</span></span><br><span class="line"><span class="string">3.   Encode arguments of an RPC call</span></span><br><span class="line"><span class="string">        static void rpc_xdr_encode(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4.   Get the server port number if not yet set</span></span><br><span class="line"><span class="string">            static void call_bind(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4a.  Sort out bind result</span></span><br><span class="line"><span class="string">            static void call_bind_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4b.  Connect to the RPC server</span></span><br><span class="line"><span class="string">            static void call_connect(struct rpc_task *task)</span></span><br><span class="line"><span class="string">4c.  Sort out connect result</span></span><br><span class="line"><span class="string">            static void call_connect_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">5.   Transmit the RPC request, and wait for reply</span></span><br><span class="line"><span class="string">                static void call_transmit(struct rpc_task *task)</span></span><br><span class="line"><span class="string">5a.  Handle cleanup after a transmission</span></span><br><span class="line"><span class="string">                static void call_transmit_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">5b.  Send the backchannel RPC reply.  On error, drop the reply.  In addition, disconnect on connectivity errors.</span></span><br><span class="line"><span class="string">                static void call_bc_transmit(struct rpc_task *task)</span></span><br><span class="line"><span class="string">6.   Sort out the RPC call status</span></span><br><span class="line"><span class="string">                    static void call_status(struct rpc_task *task)</span></span><br><span class="line"><span class="string">6a.  Handle RPC timeout, We do not release the request slot, so we keep using the</span></span><br><span class="line"><span class="string">     same XID for all retransmits.</span></span><br><span class="line"><span class="string">                    static void call_timeout(struct rpc_task *task)</span></span><br><span class="line"><span class="string">7.   Decode the RPC reply</span></span><br><span class="line"><span class="string">                        static void call_decode(struct rpc_task *task)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   - rpc_async_schedule                                                                                                                       ▒</span></span><br><span class="line"><span class="string">      - 91.95% __rpc_execute                                                                                                                  ▒</span></span><br><span class="line"><span class="string">         - 83.19% call_transmit                                                                                                               ◆</span></span><br><span class="line"><span class="string">            - 41.82% xprt_transmit                                                                                                            ▒</span></span><br><span class="line"><span class="string">               - 35.74% xs_tcp_send_request                                                                                                   ▒</span></span><br><span class="line"><span class="string">                  - 32.08% xs_sendpages                                                                                                       ▒</span></span><br><span class="line"><span class="string">                     - 29.48% xs_send_kvec                                                                                                    ▒</span></span><br><span class="line"><span class="string">                        - 26.45% kernel_sendmsg                                                                                               ▒</span></span><br><span class="line"><span class="string">                           - 24.08% sock_sendmsg                                                                                              ▒</span></span><br><span class="line"><span class="string">                              - 16.47% inet_sendmsg                                                                                           ▒</span></span><br><span class="line"><span class="string">                                 - 14.92% tcp_sendmsg                                                                                         ▒</span></span><br><span class="line"><span class="string">                                      4.27% _raw_spin_lock_bh                                                                                 ▒</span></span><br><span class="line"><span class="string">                                    - 3.51% release_sock                                                                                      ▒</span></span><br><span class="line"><span class="string">                                       - 1.64% _raw_spin_unlock_bh                                                                            ▒</span></span><br><span class="line"><span class="string">                                            __local_bh_enable_ip                                                                              ▒</span></span><br><span class="line"><span class="string">                                    - 2.14% lock_sock_nested                                                                                  ▒</span></span><br><span class="line"><span class="string">                                       - 1.71% local_bh_enable                                                                                ▒</span></span><br><span class="line"><span class="string">                                            1.60% __local_bh_enable_ip</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h4 id="cp-stack-interrupt-by-nfs"><a href="#cp-stack-interrupt-by-nfs" class="headerlink" title="cp stack interrupt by nfs"></a>cp stack interrupt by nfs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[&lt;ffffffff8adbd691&gt;] wait_on_page_bit+0x81/0xa0</span><br><span class="line">[&lt;ffffffff8adbd7c1&gt;] __filemap_fdatawait_range+0x111/0x190</span><br><span class="line">[&lt;ffffffff8adbd854&gt;] filemap_fdatawait_range+0x14/0x30</span><br><span class="line">[&lt;ffffffff8adbfd36&gt;] filemap_write_and_wait_range+0x56/0x90</span><br><span class="line">[&lt;ffffffffc0717756&gt;] nfs_file_fsync+0x86/0x110 [nfs]</span><br><span class="line">[&lt;ffffffff8ae82cfe&gt;] vfs_fsync+0x2e/0x40</span><br><span class="line">[&lt;ffffffffc0717b96&gt;] nfs_file_flush+0x46/0x60 [nfs]</span><br><span class="line">[&lt;ffffffff8ae4a637&gt;] filp_close+0x37/0x90</span><br><span class="line">[&lt;ffffffff8ae6e2e8&gt;] put_files_struct+0x88/0xe0</span><br><span class="line">[&lt;ffffffff8ae6e3e9&gt;] exit_files+0x49/0x50</span><br><span class="line">[&lt;ffffffff8aca23e2&gt;] do_exit+0x2b2/0xa20</span><br><span class="line">[&lt;ffffffff8aca2bcf&gt;] do_group_exit+0x3f/0xa0</span><br><span class="line">[&lt;ffffffff8acb3aee&gt;] get_signal_to_deliver+0x1ce/0x5e0</span><br><span class="line">[&lt;ffffffff8ac2c527&gt;] do_signal+0x57/0x6f0</span><br><span class="line">[&lt;ffffffff8ac2cc32&gt;] do_notify_resume+0x72/0xc0</span><br><span class="line">[&lt;ffffffff8b39322f&gt;] int_signal+0x12/0x17</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</span><br></pre></td></tr></table></figure>

<h3 id="Fault-injection"><a href="#Fault-injection" class="headerlink" title="Fault-injection"></a>Fault-injection</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./failcmd.sh --<span class="built_in">times</span>=-1 --interval=1 --verbose=2</span><br><span class="line">failslab is not available</span><br></pre></td></tr></table></figure>

<h4 id="debug-example1"><a href="#debug-example1" class="headerlink" title="debug example1"></a>debug example1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">[Fri Jan 15 20:25:37 2021] ------------[ cut here ]------------</span><br><span class="line">[Fri Jan 15 20:25:37 2021] WARNING: CPU: 68 PID: 111577 at kernel/irq/manage.c:1452 free_irq+0x6a/0x90</span><br><span class="line">[Fri Jan 15 20:25:37 2021] Modules linked <span class="keyword">in</span>: netlink_diag mgc(OE) lustre(OE) lmv(OE) mdc(OE) fid(OE) osc(OE) lov(OE) fld(OE) ksocklnd(OE) ptlrpc(OE) obdclass(OE) lnet(OE) libcfs(OE) nfsv3 nfs_acl nfs lockd grace fscache pktgen ib_isert iscsi_target_mod ib_srpt bonding target_core_mod ib_srp scsi_transport_srp scsi_tgt ib_ipoib ib_umad mpt2sas raid_class mptctl mptbase rpcrdma rdma_ucm ib_uverbs ib_iser rdma_cm iw_cm ib_cm libiscsi scsi_transport_iscsi dell_rbu ses enclosure scsi_transport_sas amd64_edac_mod edac_mce_amd kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr dcdbas vfat fat joydev cdc_ether usbnet mii sg qedr ib_core megaraid_sas i2c_piix4 k10temp ipmi_si ipmi_devintf ipmi_msghandler pinctrl_amd i2c_designware_platform i2c_designware_core acpi_cpufreq</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  binfmt_misc auth_rpcgss sunrpc ip_tables ext4 mbcache jbd2 sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea crct10dif_pclmul crct10dif_common sysfillrect crc32c_intel qede ptp sysimgblt fb_sys_fops ttm pps_core ahci drm libahci qed libata drm_panel_orientation_quirks crc8 nfit libnvdimm [last unloaded: libcfs]</span><br><span class="line">[Fri Jan 15 20:25:37 2021] CPU: 68 PID: 111577 Comm: ifconfig Kdump: loaded Tainted: G        W  OE  ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Fri Jan 15 20:25:37 2021] Hardware name: Lenovo ThinkSystem SR665/7D2VCTO1WW, BIOS D8E110J-1.20 11/09/2020</span><br><span class="line">[Fri Jan 15 20:25:37 2021] Call Trace:</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b7ff85&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9149bd18&gt;] __warn+0xd8/0x100</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9149be5d&gt;] warn_slowpath_null+0x1d/0x20</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9155109a&gt;] free_irq+0x6a/0x90</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022b706&gt;] qede_sync_free_irqs+0x66/0xc0 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022eb06&gt;] qede_load+0x8a6/0x1150 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b8db6f&gt;] ? notifier_call_chain+0x4f/0x70</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022f6fe&gt;] qede_open+0x3e/0xb0 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a581b2&gt;] __dev_open+0xd2/0x150</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a584e3&gt;] __dev_change_flags+0xa3/0x180</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a585e9&gt;] dev_change_flags+0x29/0x60</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91ada523&gt;] devinet_ioctl+0x6e3/0x7e0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91adb645&gt;] inet_ioctl+0x75/0xa0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a3149b&gt;] sock_do_ioctl+0x2b/0x60</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a316bb&gt;] sock_ioctl+0x1eb/0x2d0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91662810&gt;] do_vfs_ioctl+0x3a0/0x5b0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b8d678&gt;] ? __do_page_fault+0x238/0x500</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91662ac1&gt;] SyS_ioctl+0xa1/0xc0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b92ed2&gt;] system_call_fastpath+0x25/0x2a</span><br><span class="line">[Fri Jan 15 20:25:37 2021] ---[ end trace 6abd3d242706b4fe ]---</span><br><span class="line"></span><br><span class="line">(gdb) list *free_irq+0x6a/0x90</span><br><span class="line">0xffffffff81151030 is <span class="keyword">in</span> free_irq (kernel/irq/manage.c:1443).</span><br><span class="line">1438	 *	This <span class="keyword">function</span> must not be called from interrupt context.</span><br><span class="line">1439	 *</span><br><span class="line">1440	 *	Returns the devname argument passed to request_irq.</span><br><span class="line">1441	 */</span><br><span class="line">1442	const void *free_irq(unsigned int irq, void *dev_id)</span><br><span class="line">1443	&#123;</span><br><span class="line">1444		struct irq_desc *desc = irq_to_desc(irq);</span><br><span class="line">1445		struct irqaction *action;</span><br><span class="line">1446		const char *devname;</span><br><span class="line">1447</span><br><span class="line">1448		<span class="keyword">if</span> (!desc || WARN_ON(irq_settings_is_per_cpu_devid(desc)))</span><br><span class="line">1449			<span class="built_in">return</span> NULL;</span><br><span class="line">1450</span><br><span class="line">1451	<span class="comment">#ifdef CONFIG_SMP</span></span><br><span class="line">1452		<span class="keyword">if</span> (WARN_ON(desc-&gt;affinity_notify))</span><br><span class="line">1453			desc-&gt;affinity_notify = NULL;</span><br><span class="line">1454	<span class="comment">#endif</span></span><br><span class="line">1455</span><br><span class="line">1456		action = __free_irq(irq, dev_id);</span><br><span class="line">1457		devname = action-&gt;name;</span><br><span class="line"></span><br><span class="line">crash&gt; struct irqaction</span><br><span class="line">struct irqaction &#123;</span><br><span class="line">    irq_handler_t handler;</span><br><span class="line">    void *dev_id;</span><br><span class="line">    void *percpu_dev_id;</span><br><span class="line">    struct irqaction *next;</span><br><span class="line">    irq_handler_t thread_fn;</span><br><span class="line">    struct task_struct *thread;</span><br><span class="line">    unsigned int irq;</span><br><span class="line">    unsigned int flags;</span><br><span class="line">    unsigned long thread_flags;</span><br><span class="line">    unsigned long thread_mask;</span><br><span class="line">    const char *name;</span><br><span class="line">    struct proc_dir_entry *dir;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 128</span><br><span class="line"></span><br><span class="line">$ cat test.bt</span><br><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;linux/interrupt.h&gt;</span></span><br><span class="line">kretprobe:free_irq &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pid: %d , cmd: %s, returned: %d\n&quot;</span>,pid, comm, retval);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:__free_irq &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pid: %d , cmd: %s, returned: %s\n&quot;</span>,pid, comm, str(((struct irqaction *)retval)-&gt;name) );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## show the device name</span></span><br><span class="line"></span><br><span class="line">$ ./test.bt</span><br><span class="line">Attaching 2 probes...</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-0</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511010040</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-1</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511009752</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-2</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511009464</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-3</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511009176</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-4</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008888</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-5</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008600</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-6</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008312</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: enp129s0f1-fp-7</span><br><span class="line">pid: 117014 , cmd: ifconfig, returned: -1511008024</span><br><span class="line"><span class="comment">## show the info when I restart network ,Got it</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## up failed</span></span><br><span class="line">$ systemctl restart network</span><br><span class="line">Job <span class="keyword">for</span> network.service failed because the control process exited with error code. See <span class="string">&quot;systemctl status network.service&quot;</span> and <span class="string">&quot;journalctl -xe&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line"><span class="comment">## try to up the device</span></span><br><span class="line">$ ifconfig enp129s0f1 up</span><br><span class="line">SIOCSIFFLAGS: Device or resource busy</span><br><span class="line"></span><br><span class="line">$ ls -1  /sys/class/net/</span><br><span class="line">bond0</span><br><span class="line">bonding_masters</span><br><span class="line">enp129s0f0</span><br><span class="line">enp129s0f1</span><br><span class="line">enp35s0f3u1u6</span><br><span class="line">ens9f0</span><br><span class="line">ens9f1</span><br><span class="line">lo</span><br></pre></td></tr></table></figure>

<h5 id="debug-example1-1"><a href="#debug-example1-1" class="headerlink" title="debug example1-1"></a>debug example1-1</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">struct tcp_info &#123;</span><br><span class="line">    __u8 tcpi_state;</span><br><span class="line">    __u8 tcpi_ca_state;</span><br><span class="line">    __u8 tcpi_retransmits;</span><br><span class="line">    __u8 tcpi_probes;</span><br><span class="line">    __u8 tcpi_backoff;</span><br><span class="line">    __u8 tcpi_options;</span><br><span class="line">    __u8 tcpi_snd_wscale : 4;</span><br><span class="line">    __u8 tcpi_rcv_wscale : 4;</span><br><span class="line">    __u32 tcpi_rto;</span><br><span class="line">    __u32 tcpi_ato;</span><br><span class="line">    __u32 tcpi_snd_mss;</span><br><span class="line">    __u32 tcpi_rcv_mss;</span><br><span class="line">    __u32 tcpi_unacked;</span><br><span class="line">    __u32 tcpi_sacked;</span><br><span class="line">    __u32 tcpi_lost;</span><br><span class="line">    __u32 tcpi_retrans;</span><br><span class="line">    __u32 tcpi_fackets;</span><br><span class="line">    __u32 tcpi_last_data_sent;</span><br><span class="line">    __u32 tcpi_last_ack_sent;</span><br><span class="line">    __u32 tcpi_last_data_recv;</span><br><span class="line">    __u32 tcpi_last_ack_recv;</span><br><span class="line">    __u32 tcpi_pmtu;</span><br><span class="line">    __u32 tcpi_rcv_ssthresh;</span><br><span class="line">    __u32 tcpi_rtt;</span><br><span class="line">    __u32 tcpi_rttvar;</span><br><span class="line">    __u32 tcpi_snd_ssthresh;</span><br><span class="line">    __u32 tcpi_snd_cwnd;</span><br><span class="line">    __u32 tcpi_advmss;</span><br><span class="line">    __u32 tcpi_reordering;</span><br><span class="line">    __u32 tcpi_rcv_rtt;</span><br><span class="line">    __u32 tcpi_rcv_space;</span><br><span class="line">    __u32 tcpi_total_retrans;</span><br><span class="line">    __u64 tcpi_pacing_rate;</span><br><span class="line">    __u64 tcpi_max_pacing_rate;</span><br><span class="line">    __u64 tcpi_bytes_acked;</span><br><span class="line">    __u64 tcpi_bytes_received;</span><br><span class="line">    __u32 tcpi_segs_out;</span><br><span class="line">    __u32 tcpi_segs_in;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ crash&gt; struct irqaction</span><br><span class="line">struct irqaction &#123;</span><br><span class="line">    irq_handler_t handler;</span><br><span class="line">    void *dev_id;</span><br><span class="line">    void *percpu_dev_id;</span><br><span class="line">    struct irqaction *next;</span><br><span class="line">    irq_handler_t thread_fn;</span><br><span class="line">    struct task_struct *thread;</span><br><span class="line">    unsigned int irq;</span><br><span class="line">    unsigned int flags;</span><br><span class="line">    unsigned long thread_flags;</span><br><span class="line">    unsigned long thread_mask;</span><br><span class="line">    const char *name;</span><br><span class="line">    struct proc_dir_entry *dir;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 128</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct irqaction *)0)-&gt;name</span><br><span class="line"><span class="variable">$1</span> = 72</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span>  &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myprobe __free_irq +72($retval):string&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ cat /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">r:kprobes/myprobe __free_irq arg1=+72(<span class="variable">$retval</span>):string</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/<span class="built_in">enable</span></span><br><span class="line">$ <span class="built_in">echo</span> &gt; /sys/kernel/debug/tracing/trace</span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line">name: myprobe</span><br><span class="line">ID: 1685</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:unsigned long __probe_func;       offset:8;       size:8; signed:0;</span><br><span class="line">        field:unsigned long __probe_ret_ip;     offset:16;      size:8; signed:0;</span><br><span class="line">        field:u64 arg1; offset:24;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> fmt: <span class="string">&quot;(%lx &lt;- %lx) arg1=0x%Lx&quot;</span>, REC-&gt;__probe_func, REC-&gt;__probe_ret_ip, REC-&gt;arg1</span><br><span class="line"></span><br><span class="line">$ ifconfig em3 down ; ifconfig em3 up</span><br><span class="line">$ cat /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 9/9   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">        ifconfig-25429 [009] d... 539865.798024: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;&quot;</span></span><br><span class="line">        ifconfig-25429 [009] d... 539865.798027: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;/4���&quot;</span></span><br><span class="line">        ifconfig-25429 [009] d... 539865.798030: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;X/4����b&quot;</span><span class="string">&#x27;���&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798032: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;�/4����b&quot;&#x27;</span>���<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798034: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span>/4���<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798036: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span></span><br><span class="line">                                                                                                   /4�����W/���<span class="string">&quot;</span></span><br><span class="line"><span class="string">/4�����W/���&quot;</span>fig-25429 [009] d... 539865.798039: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=<span class="string">&quot;X</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798041: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span>�/4���@�W/���<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-25429 [009] d... 539865.798043: myprobe: (free_irq+0x39/0x90 &lt;- __free_irq) arg1=&quot;</span>�/4���<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># return free_irq(const char *devname; return devname;) better than __free_irq</span></span><br><span class="line"><span class="string">$ echo &#x27;r:myprobe free_irq +0(<span class="variable">$retval</span>):string&#x27; &gt; /sys/kernel/debug/tracing/kprobe_events</span></span><br><span class="line"><span class="string">$ echo 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span></span><br><span class="line"><span class="string">$ echo &gt; /sys/kernel/debug/tracing/trace</span></span><br><span class="line"><span class="string">$ ifconfig em3 down; ifconfig em3 up</span></span><br><span class="line"><span class="string">$ cat /sys/kernel/debug/tracing/trace</span></span><br><span class="line"><span class="string"># tracer: nop</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># entries-in-buffer/entries-written: 9/9   #P:24</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="string">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="string">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="string">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="string">#                            ||| /     delay</span></span><br><span class="line"><span class="string">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="string">#              | |       |   ||||       |         |</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481195: myprobe: (bnx2x_free_msix_irqs.part.68+0xdd/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481197: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-0<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481199: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-1<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481202: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-2<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481204: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-3<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481206: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-4<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481208: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-5<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481210: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-6<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ifconfig-27232 [000] d... 541007.481212: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=&quot;</span>em3-fp-7<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### if I don &#x27;t convert to string</span></span><br><span class="line"><span class="string"># tracer: nop</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># entries-in-buffer/entries-written: 9/9   #P:24</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="string">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="string">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="string">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="string">#                            ||| /     delay</span></span><br><span class="line"><span class="string">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="string">#              | |       |   ||||       |         |</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630316: myprobe: (bnx2x_free_msix_irqs.part.68+0xdd/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342d4000</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630321: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0218</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630324: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0458</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630327: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0698</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630330: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f08d8</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630333: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0b18</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630335: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0d58</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630338: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f0f98</span></span><br><span class="line"><span class="string">        ifconfig-27486 [001] d... 541302.630341: myprobe: (bnx2x_free_msix_irqs.part.68+0xa9/0x1a0 [bnx2x] &lt;- free_irq) arg1=0xffff9717342f11d8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### ??? the question, How could I print the name from the hex addr ?</span></span><br><span class="line"><span class="string">crash&gt; kmem 0xffff9717342d4000</span></span><br><span class="line"><span class="string">      PAGE         PHYSICAL      MAPPING       INDEX CNT FLAGS</span></span><br><span class="line"><span class="string">ffffd92440d0b500 10342d4000                0        0  1 2fffff00004000 head</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">crash&gt; struct irqaction 0xffff9717342d4000</span></span><br><span class="line"><span class="string">struct irqaction &#123;</span></span><br><span class="line"><span class="string">  handler = 0x336d65,</span></span><br><span class="line"><span class="string">  dev_id = 0x0,</span></span><br><span class="line"><span class="string">  percpu_dev_id = 0x0,</span></span><br><span class="line"><span class="string">  next = 0xffff9717389a8010,</span></span><br><span class="line"><span class="string">  thread_fn = 0x0,</span></span><br><span class="line"><span class="string">  thread = 0x937fffff,</span></span><br><span class="line"><span class="string">  irq = 2466250752,</span></span><br><span class="line"><span class="string">  flags = 0,</span></span><br><span class="line"><span class="string">  thread_flags = 2466250752,</span></span><br><span class="line"><span class="string">  thread_mask = 100,</span></span><br><span class="line"><span class="string">  name = 0x3 &lt;Address 0x3 out of bounds&gt;,</span></span><br><span class="line"><span class="string">  dir = 0xffff971734360050</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h3 id="The-stack-work-flow"><a href="#The-stack-work-flow" class="headerlink" title="The stack work flow"></a>The stack work flow</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#6 [ffff885e484afcf0] vfs_open at ffffffff811dc250</span></span><br><span class="line"> <span class="comment">#7 [ffff885e484afd00] do_last at ffffffff811eb81d</span></span><br><span class="line"> <span class="comment">#8 [ffff885e484afdb0] path_openat at ffffffff811ee582</span></span><br><span class="line"> <span class="comment">#9 [ffff885e484afe48] do_filp_open at ffffffff811efd4b</span></span><br><span class="line"><span class="comment">#10 [ffff885e484aff18] do_sys_open at ffffffff811dd6f3</span></span><br><span class="line"><span class="comment">#11 [ffff885e484aff70] sys_open at ffffffff811dd80e  </span></span><br><span class="line"></span><br><span class="line">means</span><br><span class="line"></span><br><span class="line">sys_open</span><br><span class="line">  do_sys_open</span><br><span class="line">    do_filp_open</span><br><span class="line">      path_openat</span><br><span class="line">        do_last</span><br><span class="line">          vfs_open</span><br></pre></td></tr></table></figure>

<h3 id="show-pr-debug-the-small-write-amplification-with-linux-soft-raid5"><a href="#show-pr-debug-the-small-write-amplification-with-linux-soft-raid5" class="headerlink" title="show pr_debug, the small write amplification with linux soft raid5"></a>show pr_debug, the small write amplification with linux soft raid5</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Ei &#x27;CONFIG_DEBUG_FS|CONFIG_DYNAMIC_DEBUG&#x27; /boot/config-3.10.0-1062.18.1.el7.x86_64</span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DYNAMIC_DEBUG=y</span><br><span class="line"></span><br><span class="line">$ cat /proc/mdstat</span><br><span class="line">Personalities : [raid6] [raid5] [raid4]</span><br><span class="line">md127 : active raid5 nvme0n1p3[<span class="number">3</span>] nvme0n1p1[<span class="number">0</span>] nvme0n1p2[<span class="number">1</span>]</span><br><span class="line">      <span class="number">390344704</span> blocks super <span class="number">1.2</span> level <span class="number">5</span>, <span class="number">32</span>k chunk, algorithm <span class="number">2</span> [<span class="number">3</span>/<span class="number">3</span>] [UUU]</span><br><span class="line"></span><br><span class="line">unused devices: &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ cat fio.cfg</span><br><span class="line">[global]</span><br><span class="line">rw=randwrite</span><br><span class="line">ioengine=sync</span><br><span class="line">size=<span class="number">8</span>G</span><br><span class="line">numjobs=<span class="number">32</span></span><br><span class="line">group_reporting</span><br><span class="line">exitall</span><br><span class="line">time_based</span><br><span class="line">runtime=<span class="number">3600</span></span><br><span class="line">direct=<span class="number">1</span></span><br><span class="line">bssplit=<span class="number">8</span>K/<span class="number">100</span></span><br><span class="line">[rw]</span><br><span class="line">directory=/mnt</span><br><span class="line"></span><br><span class="line">                                                       ------------why read ?</span><br><span class="line">                                                       |</span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle|</span><br><span class="line">           <span class="number">0.36</span>    <span class="number">0.00</span>    <span class="number">4.42</span>   <span class="number">73.21</span>    <span class="number">0.00</span>   <span class="number">22.02</span>|</span><br><span class="line">                                                       |</span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">nvme0n1       <span class="number">47036.00</span>     <span class="number">0.00</span> <span class="number">47051.00</span> <span class="number">188169.00</span>   <span class="number">367.54</span>   <span class="number">735.04</span>     <span class="number">9.60</span>    <span class="number">39.26</span>    <span class="number">0.17</span>    <span class="number">0.55</span>    <span class="number">0.07</span>   <span class="number">0.00</span>  <span class="number">99.95</span></span><br><span class="line">nvme0n1p1     <span class="number">15598.00</span>     <span class="number">0.00</span> <span class="number">15602.50</span> <span class="number">62886.50</span>   <span class="number">121.88</span>   <span class="number">245.65</span>     <span class="number">9.59</span>    <span class="number">13.31</span>    <span class="number">0.17</span>    <span class="number">0.55</span>    <span class="number">0.08</span>   <span class="number">0.01</span> <span class="number">100.00</span></span><br><span class="line">nvme0n1p2     <span class="number">15752.50</span>     <span class="number">0.00</span> <span class="number">15755.00</span> <span class="number">62576.00</span>   <span class="number">123.08</span>   <span class="number">244.44</span>     <span class="number">9.61</span>    <span class="number">13.19</span>    <span class="number">0.17</span>    <span class="number">0.54</span>    <span class="number">0.08</span>   <span class="number">0.01</span> <span class="number">100.00</span></span><br><span class="line">nvme0n1p3     <span class="number">15685.50</span>     <span class="number">0.00</span> <span class="number">15691.50</span> <span class="number">62705.50</span>   <span class="number">122.57</span>   <span class="number">244.94</span>     <span class="number">9.60</span>    <span class="number">12.95</span>    <span class="number">0.17</span>    <span class="number">0.55</span>    <span class="number">0.07</span>   <span class="number">0.01</span> <span class="number">100.00</span></span><br><span class="line"></span><br><span class="line">$ bpftrace -e &#x27;kprobe:md* &#123;&#123;@[probe] = count()&#125; &#125;&#x27;</span><br><span class="line">@[kprobe:md_write_start]: <span class="number">425895</span></span><br><span class="line">@[kprobe:md_make_request]: <span class="number">430225</span></span><br><span class="line">@[kprobe:md_handle_request]: <span class="number">430950</span></span><br><span class="line">@[kprobe:md_write_inc]: <span class="number">851009</span></span><br><span class="line">@[kprobe:md_mergeable_bvec]: <span class="number">859830</span></span><br><span class="line">@[kprobe:md_write_end]: <span class="number">1278241</span></span><br><span class="line">@[kprobe:md_check_recovery]: <span class="number">1758916</span></span><br><span class="line">@[kprobe:md_wakeup_thread]: <span class="number">4295662</span></span><br><span class="line"></span><br><span class="line">Got the high latency by ftrace</span><br><span class="line">  <span class="number">12</span>)               |      handle_stripe [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |        analyse_stripe [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.022</span> us    |          r5l_log_disk_error [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.390</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |        r5c_finish_stripe_write_out [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.020</span> us    |        r5c_is_writeback [raid456]();</span><br><span class="line">  <span class="number">12</span>)               |        handle_stripe_dirtying [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |          schedule_reconstruction [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.147</span> us    |            r5c_release_extra_page [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.437</span> us    |          &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.739</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>)               |        raid_run_ops [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.022</span> us    |          _raw_spin_lock_irq();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.020</span> us    |          r5c_is_writeback [raid456]();</span><br><span class="line">  <span class="number">12</span>)               |          async_copy_data.isra<span class="number">.47</span> [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |            async_memcpy [async_memcpy]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |              __async_tx_find_channel [async_tx]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.022</span> us    |                dma_find_channel();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.260</span> us    |              &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |              async_tx_quiesce [async_tx]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |              dmaengine_unmap_put();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">1.790</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">2.071</span> us    |          &#125;</span><br><span class="line">  <span class="number">12</span>)               |          async_xor [async_xor]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |            __async_tx_find_channel [async_tx]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.023</span> us    |              dma_find_channel();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.262</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |            async_tx_quiesce [async_tx]();</span><br><span class="line">  <span class="number">12</span>)               |            xor_blocks [<span class="keyword">xor</span>]() &#123;</span><br><span class="line">  <span class="number">12</span>)               |              xor_avx_3 [<span class="keyword">xor</span>]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.021</span> us    |                irq_fpu_usable();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.039</span> us    |                __kernel_fpu_begin();</span><br><span class="line">  <span class="number">12</span>)               |                __kernel_fpu_end() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.057</span> us    |                  math_state_restore();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.291</span> us    |                &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">1.882</span> us    |              &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">2.137</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)               |            ops_complete_reconstruct [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.031</span> us    |              raid5_release_stripe [raid456]();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.323</span> us    |            &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">4.343</span> us    |          &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">7.464</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>)               |        ops_run_io [raid456]() &#123;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.023</span> us    |          _cond_resched();</span><br><span class="line">  <span class="number">12</span>)   <span class="number">0.329</span> us    |        &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.398</span> us   |      &#125;</span><br><span class="line"></span><br><span class="line">## it &#x27;s nvme dev, handle_stripe has the highest latency except some system default calls</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.330</span> us   |      &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.340</span> us   |      &#125;</span><br><span class="line">  <span class="number">12</span>)   <span class="number">9.921</span> us    |      &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.057</span> us   |      &#125;</span><br><span class="line">  <span class="number">12</span>) + <span class="number">10.239</span> us   |      &#125;</span><br><span class="line"></span><br><span class="line">$ echo <span class="number">8</span> <span class="number">4</span> <span class="number">1</span> <span class="number">7</span> &gt; /proc/sys/kernel/printk</span><br><span class="line">$ echo -n <span class="string">&quot;file raid5.c +p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">$ echo -n <span class="string">&quot;file raid5.c +pmflt&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">$ dmesg | grep <span class="string">&quot;Read_old block&quot;</span> -B <span class="number">4</span> -A <span class="number">4</span> </span><br><span class="line"></span><br><span class="line">##<span class="meta"># disable</span></span><br><span class="line">$ echo -n &#x27;file raid5.c -p&#x27; &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">$ echo -n <span class="string">&quot;file raid5.c -pmflt&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line"></span><br><span class="line">##<span class="meta"># single func</span></span><br><span class="line">$ echo <span class="string">&quot;func handle_stripe_dirtying +p&quot;</span> &gt;&gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">$ echo <span class="string">&quot;func handle_stripe_dirtying -p&quot;</span> &gt;&gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">[ <span class="number">6491.600465</span>] <span class="keyword">for</span> sector <span class="number">224878608</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6491.600939</span>] <span class="keyword">for</span> sector <span class="number">224878616</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6491.601260</span>] <span class="keyword">for</span> sector <span class="number">149425888</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6491.601584</span>] <span class="keyword">for</span> sector <span class="number">149425896</span> state <span class="number">0x2041</span>, rmw=<span class="number">2</span> rcw=<span class="number">0</span></span><br><span class="line">[ <span class="number">6496.311915</span>] <span class="keyword">for</span> sector <span class="number">195169064</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.312323</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">6496.312671</span>] <span class="keyword">for</span> sector <span class="number">195169072</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.313044</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">6496.313381</span>] <span class="keyword">for</span> sector <span class="number">195169080</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.313719</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">6496.314060</span>] <span class="keyword">for</span> sector <span class="number">195169088</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">6496.314416</span>] Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">[ <span class="number">1795.266077</span>] &lt;intr&gt; raid456:raid5_end_write_request:<span class="number">2636</span>: end_write_request <span class="number">123139960</span>/<span class="number">0</span>, count <span class="number">2</span>, uptodate: <span class="number">1.</span></span><br><span class="line">[ <span class="number">1795.266080</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">0</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">[ <span class="number">1795.266082</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4749</span>: locked=<span class="number">0</span> uptodate=<span class="number">0</span> to_read=<span class="number">0</span> to_write=<span class="number">1</span> failed=<span class="number">0</span> failed_num=<span class="number">-1</span>,<span class="number">-1</span></span><br><span class="line">[ <span class="number">1795.266084</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3919</span>: <span class="keyword">for</span> sector <span class="number">275011528</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">1795.266086</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3996</span>: Read_old block <span class="number">2</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">1795.266088</span>] [<span class="number">4448</span>] raid456:ops_run_io:<span class="number">1111</span>: ops_run_io: <span class="keyword">for</span> <span class="number">275011528</span> schedule op <span class="number">0</span> on disc <span class="number">2</span></span><br><span class="line">[ <span class="number">1795.266091</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4717</span>: handling stripe <span class="number">214788240</span>, state=<span class="number">0x2041</span> cnt=<span class="number">1</span>, pd_idx=<span class="number">0</span>, qd_idx=<span class="number">-1</span></span><br><span class="line">               , check:<span class="number">0</span>, reconstruct:<span class="number">5</span></span><br><span class="line">[ <span class="number">1795.266093</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">2</span>: state <span class="number">0x11</span> read           (null) write           (null) written           (null)</span><br><span class="line">--</span><br><span class="line">[ <span class="number">1795.266269</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">1</span>: state <span class="number">0x8</span> read           (null) write ffff928df71d5900 written           (null)</span><br><span class="line">[ <span class="number">1795.266271</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">0</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">[ <span class="number">1795.266273</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4749</span>: locked=<span class="number">0</span> uptodate=<span class="number">0</span> to_read=<span class="number">0</span> to_write=<span class="number">1</span> failed=<span class="number">0</span> failed_num=<span class="number">-1</span>,<span class="number">-1</span></span><br><span class="line">[ <span class="number">1795.266275</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3919</span>: <span class="keyword">for</span> sector <span class="number">72429152</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">1795.266277</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3996</span>: Read_old block <span class="number">0</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">1795.266279</span>] [<span class="number">4448</span>] raid456:ops_run_io:<span class="number">1111</span>: ops_run_io: <span class="keyword">for</span> <span class="number">72429152</span> schedule op <span class="number">0</span> on disc <span class="number">0</span></span><br><span class="line">[ <span class="number">1795.266283</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4717</span>: handling stripe <span class="number">72429160</span>, state=<span class="number">0x41</span> cnt=<span class="number">1</span>, pd_idx=<span class="number">2</span>, qd_idx=<span class="number">-1</span></span><br><span class="line">               , check:<span class="number">0</span>, reconstruct:<span class="number">0</span></span><br><span class="line">[ <span class="number">1795.266285</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">2</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">--</span><br><span class="line">[ <span class="number">1795.266291</span>] &lt;intr&gt; raid456:raid5_end_write_request:<span class="number">2636</span>: end_write_request <span class="number">224927640</span>/<span class="number">0</span>, count <span class="number">1</span>, uptodate: <span class="number">1.</span></span><br><span class="line">[ <span class="number">1795.266293</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">0</span>: state <span class="number">0x0</span> read           (null) write           (null) written           (null)</span><br><span class="line">[ <span class="number">1795.266296</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4749</span>: locked=<span class="number">0</span> uptodate=<span class="number">0</span> to_read=<span class="number">0</span> to_write=<span class="number">1</span> failed=<span class="number">0</span> failed_num=<span class="number">-1</span>,<span class="number">-1</span></span><br><span class="line">[ <span class="number">1795.266298</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3919</span>: <span class="keyword">for</span> sector <span class="number">72429160</span> state <span class="number">0x41</span>, rmw=<span class="number">2</span> rcw=<span class="number">1</span></span><br><span class="line">[ <span class="number">1795.266300</span>] [<span class="number">4448</span>] raid456:handle_stripe_dirtying:<span class="number">3996</span>: Read_old block <span class="number">0</span> <span class="keyword">for</span> Reconstruct</span><br><span class="line">[ <span class="number">1795.266302</span>] [<span class="number">4448</span>] raid456:ops_run_io:<span class="number">1111</span>: ops_run_io: <span class="keyword">for</span> <span class="number">72429160</span> schedule op <span class="number">0</span> on disc <span class="number">0</span></span><br><span class="line">[ <span class="number">1795.266305</span>] [<span class="number">4448</span>] raid456:handle_stripe:<span class="number">4717</span>: handling stripe <span class="number">104667968</span>, state=<span class="number">0x2041</span> cnt=<span class="number">1</span>, pd_idx=<span class="number">0</span>, qd_idx=<span class="number">-1</span></span><br><span class="line">               , check:<span class="number">0</span>, reconstruct:<span class="number">5</span></span><br><span class="line">[ <span class="number">1795.266307</span>] [<span class="number">4448</span>] raid456:analyse_stripe:<span class="number">4403</span>: check <span class="number">2</span>: state <span class="number">0x11</span> read           (null) write           (null) written           (null)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/drivers/md/raid5.c</span><br><span class="line">        <span class="comment">//raid456:handle_stripe_dirtying:3919: for sector 72429160 state 0x41, rmw=2 rcw=1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((rcw &lt; rmw || (rcw == rmw &amp;&amp; conf-&gt;rmw_level != PARITY_PREFER_RMW)) &amp;&amp; rcw &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* want reconstruct write, but need to get some data */</span></span><br><span class="line">                <span class="keyword">int</span> qread =<span class="number">0</span>;</span><br><span class="line">                rcw = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (i = disks; i--; ) &#123;</span><br><span class="line">                        <span class="class"><span class="keyword">struct</span> <span class="title">r5dev</span> *<span class="title">dev</span> = &amp;<span class="title">sh</span>-&gt;<span class="title">dev</span>[<span class="title">i</span>];</span></span><br><span class="line">                        <span class="keyword">if</span> (!test_bit(R5_OVERWRITE, &amp;dev-&gt;flags) &amp;&amp;</span><br><span class="line">                            i != sh-&gt;pd_idx &amp;&amp; i != sh-&gt;qd_idx &amp;&amp;</span><br><span class="line">                            !test_bit(R5_LOCKED, &amp;dev-&gt;flags) &amp;&amp;</span><br><span class="line">                            !(test_bit(R5_UPTODATE, &amp;dev-&gt;flags) ||</span><br><span class="line">                              test_bit(R5_Wantcompute, &amp;dev-&gt;flags))) &#123;</span><br><span class="line">                                rcw++;</span><br><span class="line">                                <span class="keyword">if</span> (test_bit(R5_Insync, &amp;dev-&gt;flags) &amp;&amp;</span><br><span class="line">                                    test_bit(STRIPE_PREREAD_ACTIVE,</span><br><span class="line">                                             &amp;sh-&gt;state)) &#123;</span><br><span class="line">                                        pr_debug(<span class="string">&quot;Read_old block &quot;</span></span><br><span class="line">                                                <span class="string">&quot;%d for Reconstruct\n&quot;</span>, i);</span><br><span class="line">                                        set_bit(R5_LOCKED, &amp;dev-&gt;flags);</span><br><span class="line">                                        set_bit(R5_Wantread, &amp;dev-&gt;flags);</span><br><span class="line">                                        s-&gt;locked++;</span><br><span class="line">                                        qread++;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        set_bit(STRIPE_DELAYED, &amp;sh-&gt;state);</span><br><span class="line">                                        set_bit(STRIPE_HANDLE, &amp;sh-&gt;state);</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (rcw &amp;&amp; conf-&gt;mddev-&gt;<span class="built_in">queue</span>)</span><br><span class="line">                        blk_add_trace_msg(conf-&gt;mddev-&gt;<span class="built_in">queue</span>, <span class="string">&quot;raid5 rcw %llu %d %d %d&quot;</span>,</span><br><span class="line">                                          (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)sh-&gt;sector,</span><br><span class="line">                                          rcw, qread, test_bit(STRIPE_DELAYED, &amp;sh-&gt;state));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>


<h3 id="kprobe-example"><a href="#kprobe-example" class="headerlink" title="kprobe example"></a><a target="_blank" rel="noopener" href="https://www.linuxjournal.com/content/oops-debugging-kernel-panics-0">kprobe example</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_module_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> *p = <span class="number">1</span>;</span><br><span class="line">printk(<span class="string">&quot;%d\n&quot;</span>, *p);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test_module_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(test_module_init);</span><br><span class="line">module_exit(test_module_exit);</span><br><span class="line"></span><br><span class="line">## Makefile</span><br><span class="line">obj-m += test-<span class="keyword">module</span>.o</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">    $(MAKE) -C/lib/modules/$(shell uname -r)/build M=$(PWD)</span><br><span class="line"></span><br><span class="line">$ sync &amp;&amp; sudo insmod test-<span class="keyword">module</span>.ko</span><br><span class="line">crash&gt; mod -s test ./test.o</span><br><span class="line">$ kmem -i</span><br></pre></td></tr></table></figure>

<h3 id="stap-show-all-local-parameters-could-be-print"><a href="#stap-show-all-local-parameters-could-be-print" class="headerlink" title="stap show all local parameters could be print"></a><a target="_blank" rel="noopener" href="https://github.com/baotiao/baotiao.github.com/blob/6448a8ba675cbb6ea9ec002c4d8792a2b50226d5/_posts/2017-06-14-systemtap-tips-and-example.md">stap show all local parameters could be print</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ stap -L &#x27;kernel.statement(&quot;si_mem_available@mm/page_alloc.c:*&quot;)&#x27;</span><br><span class="line">kernel.statement(<span class="string">&quot;si_mem_available@mm/page_alloc.c:3795&quot;</span>) $pages:<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>[]</span><br><span class="line">kernel.statement(<span class="string">&quot;si_mem_available@mm/page_alloc.c:3798&quot;</span>) $wmark_low:<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> $pages:<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>[] $zone:<span class="class"><span class="keyword">struct</span> <span class="title">zone</span>*</span></span><br><span class="line"><span class="class"><span class="title">kernel</span>.<span class="title">statement</span>(&quot;<span class="title">si_mem_available</span>@<span class="title">mm</span>/<span class="title">page_alloc</span>.<span class="title">c</span>:</span><span class="number">3803</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3804</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3806</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3807</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[] $zone:struct zone*</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3813</span><span class="string">&quot;) $available:long int $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3820</span><span class="string">&quot;) $pages:long unsigned int[] $zone:struct zone*</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3821</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3822</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3828</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3829</span><span class="string">&quot;) $_min2:long unsigned int $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3834</span><span class="string">&quot;) $available:long int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stap -L &#x27;process(&quot;</span>/usr/bin/bash<span class="string">&quot;).function(&quot;</span>skip_single_quoted<span class="string">&quot;)&#x27;</span></span><br><span class="line"><span class="string">process(&quot;</span>/usr/bin/bash<span class="string">&quot;).function(&quot;</span>skip_single_quoted@/usr/src/debug/bash<span class="number">-4.2</span>/subst.c:<span class="number">1022</span><span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Homer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/12/08/debug/">http://yoursite.com/2020/12/08/debug/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/debug/">debug</a><a class="post-meta__tags" href="/tags/trace/">trace</a></div><div class="post_share"><div class="social-share" data-image="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/28/hello-world/"><img class="prev-cover" src="https://homerl.github.io/img/machine-learning-3-robot-developer-working-programming-coding-ai-machine-learning-hello-world-512.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Hello World</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/24/bpftrace/"><img class="next-cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">bpftrace</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/07/24/bpftrace/" title="bpftrace"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-24</div><div class="title">bpftrace</div></div></a></div><div><a href="/2020/03/03/crash/" title="crash practice"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-03</div><div class="title">crash practice</div></div></a></div><div><a href="/2020/03/03/gdb/" title="GDB tips"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-03</div><div class="title">GDB tips</div></div></a></div><div><a href="/2019/10/31/bcc/" title="Trace by bcc tools"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-31</div><div class="title">Trace by bcc tools</div></div></a></div><div><a href="/2018/11/23/perf/" title="perf"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-23</div><div class="title">perf</div></div></a></div><div><a href="/2018/11/22/ftrace/" title="ftrace"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-22</div><div class="title">ftrace</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2022 By Homer</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '0b9d5b98d0a972b33cf7',
      clientSecret: '769efc11b32f6c0d03bcbf3ee800dfc4e2690459',
      repo: 'homerl.github.io',
      owner: 'homerl',
      admin: ['homerl'],
      id: '3840e06dc1ec8047c276227c0023cbf2',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>