<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>bpftrace | 己不由心，身又岂能由己</title><meta name="keywords" content="debug,trace"><meta name="author" content="Ginger"><meta name="copyright" content="Ginger"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="bcc tools12345678910111213141516171819202122$ .&#x2F;vfsstat 5 10TIME         READ&#x2F;s  WRITE&#x2F;s CREATE&#x2F;s   OPEN&#x2F;s  FSYNC&#x2F;s14:34:53:       575        7        0      537        014:34:58:       850        9">
<meta property="og:type" content="article">
<meta property="og:title" content="bpftrace">
<meta property="og:url" content="http://yoursite.com/2020/07/24/bpftrace/index.html">
<meta property="og:site_name" content="己不由心，身又岂能由己">
<meta property="og:description" content="bcc tools12345678910111213141516171819202122$ .&#x2F;vfsstat 5 10TIME         READ&#x2F;s  WRITE&#x2F;s CREATE&#x2F;s   OPEN&#x2F;s  FSYNC&#x2F;s14:34:53:       575        7        0      537        014:34:58:       850        9">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png">
<meta property="article:published_time" content="2020-07-24T06:13:15.000Z">
<meta property="article:modified_time" content="2020-10-11T07:43:50.423Z">
<meta property="article:author" content="Ginger">
<meta property="article:tag" content="debug">
<meta property="article:tag" content="trace">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><link rel="shortcut icon" href="/img/stout-shield.png"><link rel="canonical" href="http://yoursite.com/2020/07/24/bpftrace/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-10-11 15:43:50'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/huohuan.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">58</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#bcc-tools"><span class="toc-number">1.</span> <span class="toc-text">bcc tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list-all-events"><span class="toc-number">2.</span> <span class="toc-text">list all events</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#example"><span class="toc-number">3.</span> <span class="toc-text">example</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-file-name"><span class="toc-number">3.1.</span> <span class="toc-text">Show file name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-user-space-application"><span class="toc-number">3.2.</span> <span class="toc-text">trace user space application</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bcc-tools-1"><span class="toc-number">4.</span> <span class="toc-text">bcc tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memroy-allocators"><span class="toc-number">5.</span> <span class="toc-text">Memroy allocators</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Storage"><span class="toc-number">6.</span> <span class="toc-text">Storage</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#storage-example"><span class="toc-number">6.1.</span> <span class="toc-text">storage example</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">己不由心，身又岂能由己</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">bpftrace</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-07-24T06:13:15.000Z" title="Created 2020-07-24 14:13:15">2020-07-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-10-11T07:43:50.423Z" title="Updated 2020-10-11 15:43:50">2020-10-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Scripts/">Scripts</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="bcc-tools"><a href="#bcc-tools" class="headerlink" title="bcc tools"></a>bcc tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ./vfsstat 5 10</span><br><span class="line">TIME         READ/s  WRITE/s CREATE/s   OPEN/s  FSYNC/s</span><br><span class="line">14:34:53:       575        7        0      537        0</span><br><span class="line">14:34:58:       850        9        0      792        0</span><br><span class="line">14:35:03:       842        8        0      791        0</span><br><span class="line">14:35:08:       580        8        0      535        0</span><br><span class="line">14:35:13:       839        8        0      789        0</span><br><span class="line"></span><br><span class="line">$  bpftrace -e <span class="string">&#x27;kprobe:vfs_* &#123; @[probe] = count() &#125;&#x27;</span></span><br><span class="line">Attaching 53 probes...</span><br><span class="line">^C</span><br><span class="line">@[kprobe:vfs_llseek]: 1</span><br><span class="line">@[kprobe:vfs_fsync_range]: 33</span><br><span class="line">@[kprobe:vfs_iter_write]: 61</span><br><span class="line">@[kprobe:vfs_statfs]: 93</span><br><span class="line">@[kprobe:vfs_statx_fd]: 469</span><br><span class="line">@[kprobe:vfs_statx]: 2299</span><br><span class="line">@[kprobe:vfs_getattr_nosec]: 2872</span><br><span class="line">@[kprobe:vfs_getattr]: 2873</span><br><span class="line">@[kprobe:vfs_write]: 3754</span><br><span class="line">@[kprobe:vfs_open]: 4965</span><br><span class="line">@[kprobe:vfs_read]: 8020</span><br></pre></td></tr></table></figure>

<h3 id="list-all-events"><a href="#list-all-events" class="headerlink" title="list all events"></a>list all events</h3><a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -l </span><br><span class="line">$ bpftrace -l <span class="string">&#x27;*sleep*&#x27;</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;tracepoint:syscalls:sys_enter_*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># args is a pointer to a struct containing all the tracepoint arguments. This struct is automatically generated by bpftrace based tracepoint information. The members of this struct can be found with </span></span><br><span class="line">$ bpftrace -lv tracepoint:syscalls:sys_enter_open </span><br><span class="line">tracepoint:syscalls:sys_enter_open</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    const char * filename;</span><br><span class="line">    int flags;</span><br><span class="line">    umode_t mode;</span><br><span class="line"></span><br><span class="line"><span class="comment"># If BTF is available, it is also possible to list struct/union/emum definitions. For example:</span></span><br><span class="line">$ bpftrace -lv <span class="string">&quot;struct path&quot;</span></span><br><span class="line">BTF: using data from /sys/kernel/btf/vmlinux</span><br><span class="line">struct path &#123;</span><br><span class="line">        struct vfsmount *mnt;</span><br><span class="line">        struct dentry *dentry;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><p>@name    global<br>@name[key]    hash<br>@name[tid]    thread-local<br>$name    scratch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Timing Reads by Process</span></span><br><span class="line">                  ------Probe Types, Kernel dynamic <span class="keyword">function</span> instrumentation</span><br><span class="line">                  |                 ---------thread-local Variable, custom</span><br><span class="line">                  |                 |       -------------Builtin Variable</span><br><span class="line">                  |                 |       |      ---Builtin Variable                                ---Builtin Variable                    ---Builtin Function</span><br><span class="line">                  |                 |       |      |                                                  |            |                         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;kprobe:vfs_read &#123; @tttstart[tid] = nsecs; &#125; kretprobe:vfs_read /@tttstart[tid]/ &#123; @ns[comm] = hist(nsecs - @tttstart[tid]); delete(@tttstart[tid]); &#125;&#x27;</span></span><br><span class="line">                                                            |                                                 |</span><br><span class="line">                                                            |                                                 ---Builtin Function</span><br><span class="line">                                                            ---Probe Types, Kernel dynamic <span class="keyword">function</span> <span class="built_in">return</span> instrumentation</span><br><span class="line"></span><br><span class="line">$ cat path.bt</span><br><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;open path: %s\n&quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Show-file-name"><a href="#Show-file-name" class="headerlink" title="Show file name"></a>Show file name</h4><p>filename</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e &#x27;tracepoint:syscalls:sys_enter_openat &#123; printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); &#125;&#x27;</span><br><span class="line">$ bpftrace --include linux/path.h --include linux/dcache.h     -e &#x27;kprobe:vfs_open &#123; printf(&quot;open path: %s\n&quot;, str(((path *)arg0)-&gt;dentry-&gt;d_name.name)); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/path.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/dcache.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* wait fd2path/path to the new version https://github.com/iovisor/bpftrace/issues/29 */</span></span><br><span class="line"><span class="comment">/* only print parent dir name and file name */</span></span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open path:%s/%s,uid: %d,cmd %s, &quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_name.name), str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name), uid, comm);</span><br><span class="line">    @start = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;take ns: %d\n&quot;</span>, (nsecs - @start));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##<span class="meta"># fs/open.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_open - open the file at the given path</span></span><br><span class="line"><span class="comment"> * @path: path to open</span></span><br><span class="line"><span class="comment"> * @file: newly allocated file with f_flag initialized</span></span><br><span class="line"><span class="comment"> * @cred: credentials to use</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_open</span><span class="params">(<span class="keyword">const</span> struct path *path, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	file-&gt;f_path = *path;</span><br><span class="line">	<span class="keyword">return</span> do_dentry_open(file, d_backing_inode(path-&gt;dentry), <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/path.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/dcache.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line">	<span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> d_flags;		<span class="comment">/* protected by d_lock */</span></span><br><span class="line">	<span class="keyword">seqcount_t</span> d_seq;		<span class="comment">/* per dentry seqlock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span>	<span class="comment">/* lookup hash list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span>	<span class="comment">/* parent directory */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span>		<span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment">					 * negative */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> d_iname[DNAME_INLINE_LEN];	<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span>	<span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span>	<span class="comment">/* The root of the dentry tree */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> d_time;		<span class="comment">/* used by d_revalidate */</span></span><br><span class="line">	<span class="keyword">void</span> *d_fsdata;			<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span>		<span class="comment">/* LRU list */</span></span><br><span class="line">		<span class="keyword">wait_queue_head_t</span> *d_wait;	<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span>	<span class="comment">/* child of parent list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span>	<span class="comment">/* our children */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span>	<span class="comment">/* inode alias list */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span>	<span class="comment">/* only for in-lookup ones */</span></span><br><span class="line">	 	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">	&#125; d_u;</span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>path</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open path: %s\n&quot;</span>, str(((path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="trace-user-space-application"><a href="#trace-user-space-application" class="headerlink" title="trace user space application"></a><a target="_blank" rel="noopener" href="https://www.percona.com/sites/default/files/presentations/Scale18x-2020-bpfTrace-finally-dTrace-replacement.pdf">trace user space application</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   binaray file ------------         -----------the <span class="keyword">function</span> from hello_world</span><br><span class="line">                           |         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:~/hello_world:hello &#123;printf(&quot;%s\n&quot;, ustack());&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://blog.jcix.top/2019-12-04/bpftrace-profiling/">example</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;time.h&gt;</span></span><br><span class="line"> </span><br><span class="line">void sleep_func(int sleep_time_us)</span><br><span class="line">&#123;</span><br><span class="line">    usleep(sleep_time_us);</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int lower = 0, upper = 100;</span><br><span class="line">    srand(time(0));</span><br><span class="line">    <span class="keyword">for</span> (int k = 1000; k &gt; 0; k--) &#123;</span><br><span class="line">        int sleep_time_us = 0;</span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            sleep_time_us += rand() % (upper - lower) + lower;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;us: %d\n&quot;</span>, sleep_time_us);</span><br><span class="line">        sleep_func(sleep_time_us);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">------------------------------------ </span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line">uprobe:~/sleep_prog:sleep_func</span><br><span class="line">&#123;</span><br><span class="line">    @t_start=nsecs;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">uretprobe:~/sleep_prog:sleep_func</span><br><span class="line">/@t_start/</span><br><span class="line">&#123;</span><br><span class="line">    @my_hist = lhist(nsecs - @t_start, 0, 10000000, 50000);</span><br><span class="line">    clear(@t_start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@my_hist:</span><br><span class="line">[250000, 300000)       1 |                                                    |</span><br><span class="line">[300000, 350000)       6 |@@                                                  |</span><br><span class="line">[350000, 400000)      14 |@@@@@@                                              |</span><br><span class="line">[400000, 450000)      39 |@@@@@@@@@@@@@@@@                                    |</span><br><span class="line">[450000, 500000)      63 |@@@@@@@@@@@@@@@@@@@@@@@@@@@                         |</span><br><span class="line">[500000, 550000)     120 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[550000, 600000)      82 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 |</span><br><span class="line">[600000, 650000)      96 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           |</span><br><span class="line">[650000, 700000)      53 |@@@@@@@@@@@@@@@@@@@@@@                              |</span><br><span class="line">[700000, 750000)      18 |@@@@@@@                                             |</span><br><span class="line">[750000, 800000)       7 |@@@                                                 |</span><br><span class="line">[800000, 850000)       0 |                                                    |</span><br><span class="line">[850000, 900000)       0 |                                                    |</span><br><span class="line">[900000, 950000)       0 |                                                    |</span><br><span class="line">[950000, 1000000)       0 |                                                    |</span><br><span class="line">[1000000, 1050000)       0 |                                                    |</span><br><span class="line">[1050000, 1100000)       0 |                                                    |</span><br><span class="line">[1100000, 1150000)       0 |                                                    |</span><br><span class="line">[1150000, 1200000)       1 |                                                    |</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>uprobe:/bin/bash:readline (the function begining)<br>uretprobe:/bin/bash:readline (the function end)</p>
<p>/sys/kernel/debug/tracing/uprobe_events</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">root@mysql1:~<span class="comment"># bpftrace -e &#x27;uprobe:/usr/sbin/</span></span><br><span class="line">mysqld:dispatch_command &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">Could not resolve symbol: /usr/sbin/mysqld:dispatch_command</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@mysql1:~# nm -D /usr/sbin/mysqld | grep dispatch_command</span></span><br><span class="line"><span class="string">00000000005af770 T</span></span><br><span class="line"><span class="string">_Z16dispatch_command19enum_server_commandP3THDPcjbb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>uprobe:/usr/sbin/mysqld:_Z16dispatch_command19enum_server_commandP3THDPcjbb &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">select @@version_comment limit 1</span></span><br><span class="line"><span class="string">select 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;join(args-&gt;filename)&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,str(args-&gt;filename))&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[pid,comm]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[2423, in:imjournal]: 10</span></span><br><span class="line"><span class="string">@[338226, worker]: 12</span></span><br><span class="line"><span class="string">@[338161, qemu-kvm]: 19</span></span><br><span class="line"><span class="string">@[338161, CPU 0/KVM]: 20</span></span><br><span class="line"><span class="string">@[1898, NetworkManager]: 22</span></span><br><span class="line"><span class="string">@[338226, CPU 0/KVM]: 23</span></span><br><span class="line"><span class="string">@[2517288, sshd]: 24</span></span><br><span class="line"><span class="string">@[338513, CPU 1/KVM]: 24</span></span><br><span class="line"><span class="string">@[338226, qemu-kvm]: 29</span></span><br><span class="line"><span class="string">@[338161, CPU 3/KVM]: 42</span></span><br><span class="line"><span class="string">@[2801247, bpftrace]: 48</span></span><br><span class="line"><span class="string">@[338098, CPU 1/KVM]: 66</span></span><br><span class="line"><span class="string">@[338161, SPICE Worker]: 169</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_* &#123;@[probe,comm]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 320 probes...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_madvise, qemu-kvm]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_select, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_getpid, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_waitid, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, irqbalance]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_inotify_add_watch, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_ioctl, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_rt_sigreturn, bpftrace]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_pwrite64, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_fdatasync, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_read, sshd]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_write, sshd]: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[ksym(*(kaddr(<span class="string">&quot;sys_call_table&quot;</span>) + args-&gt;id * 8))]=count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[__x64_sys_inotify_add_watch]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_exit]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigreturn]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_getpid]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_madvise]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_pwrite64]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_fdatasync]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_recvmmsg]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_select]: 6</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigprocmask]: 8</span></span><br><span class="line"><span class="string">@[__x64_sys_clock_gettime]: 12</span></span><br><span class="line"><span class="string">@[__x64_sys_newfstat]: 34</span></span><br><span class="line"><span class="string">@[__x64_sys_close]: 36</span></span><br><span class="line"><span class="string">@[__x64_sys_openat]: 50</span></span><br><span class="line"><span class="string">@[__x64_sys_epoll_wait]: 70</span></span><br><span class="line"><span class="string">@[__x64_sys_futex]: 81</span></span><br><span class="line"><span class="string">@[__x64_sys_ppoll]: 108</span></span><br><span class="line"><span class="string">@[__x64_sys_read]: 297</span></span><br><span class="line"><span class="string">@[__x64_sys_write]: 327</span></span><br><span class="line"><span class="string">@[__x64_sys_ioctl]: 334</span></span><br><span class="line"><span class="string">@[__x64_sys_poll]: 430</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:99 /pid == 189/ &#123;@[ustack] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:49 &#123;@[ustack, kstack, comm] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[,</span></span><br><span class="line"><span class="string">    poll_idle+45</span></span><br><span class="line"><span class="string">    cpuidle_enter_state+115</span></span><br><span class="line"><span class="string">    cpuidle_enter+44</span></span><br><span class="line"><span class="string">    do_idle+566</span></span><br><span class="line"><span class="string">    cpu_startup_entry+111</span></span><br><span class="line"><span class="string">    start_secondary+423</span></span><br><span class="line"><span class="string">    secondary_startup_64+183</span></span><br><span class="line"><span class="string">, swapper/5]: 1</span></span><br><span class="line"><span class="string">@[</span></span><br><span class="line"><span class="string">    0x7f9e88814ab4</span></span><br><span class="line"><span class="string">    0x696765725f6b6c63</span></span><br><span class="line"><span class="string">,</span></span><br><span class="line"><span class="string">    pointer+521</span></span><br><span class="line"><span class="string">    vsnprintf+892</span></span><br><span class="line"><span class="string">    seq_vprintf+48</span></span><br><span class="line"><span class="string">    seq_printf+83</span></span><br><span class="line"><span class="string">    s_show+123</span></span><br><span class="line"><span class="string">    seq_read+745</span></span><br><span class="line"><span class="string">    proc_reg_read+60</span></span><br><span class="line"><span class="string">    vfs_read+145</span></span><br><span class="line"><span class="string">    ksys_read+79</span></span><br><span class="line"><span class="string">    do_syscall_64+91</span></span><br><span class="line"><span class="string">    entry_SYSCALL_64_after_hwframe+101</span></span><br><span class="line"><span class="string">, bpftrace]: 1</span></span><br></pre></td></tr></table></figure>

<p>uprobe example</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:/bin/bash:readline &#123; @ = count() &#125;&#x27;</span></span><br><span class="line">$ ./gethostlatency <span class="comment"># host resoltion calls latency (DNS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Get all _IO function from the system library</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;uprobe:/lib64/libc.so.6:_IO*&#x27;</span> | head</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fclose.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fgetpos.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_fgets.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_read</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_write</span><br></pre></td></tr></table></figure>


<p>Tracepoint</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ls <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing/events</span><br><span class="line">$ cat <span class="regexp">/sys/</span>kernel<span class="regexp">/debug/</span>tracing<span class="regexp">/events/</span>sched<span class="regexp">/sched_process_exec/</span>format</span><br><span class="line"><span class="attr">name:</span> sched_process_exec</span><br><span class="line"><span class="attr">ID:</span> <span class="number">305</span></span><br><span class="line"><span class="attr">format:</span></span><br><span class="line">	<span class="symbol">field:</span>unsigned <span class="keyword">short</span> common_type;	<span class="attr">offset:</span><span class="number">0</span>;	<span class="attr">size:</span><span class="number">2</span>;	<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line">	<span class="symbol">field:</span>unsigned <span class="keyword">char</span> common_flags;	<span class="attr">offset:</span><span class="number">2</span>;	<span class="attr">size:</span><span class="number">1</span>;	<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line">	<span class="symbol">field:</span>unsigned <span class="keyword">char</span> common_preempt_count;	<span class="attr">offset:</span><span class="number">3</span>;	<span class="attr">size:</span><span class="number">1</span>;	<span class="attr">signed:</span><span class="number">0</span>;</span><br><span class="line">	<span class="symbol">field:</span><span class="keyword">int</span> common_pid;	<span class="attr">offset:</span><span class="number">4</span>;	<span class="attr">size:</span><span class="number">4</span>;	<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="symbol">field:</span>__data_loc <span class="keyword">char</span>[] filename;	<span class="attr">offset:</span><span class="number">8</span>;	<span class="attr">size:</span><span class="number">4</span>;	<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line">	<span class="symbol">field:</span>pid_t pid;	<span class="attr">offset:</span><span class="number">12</span>;	<span class="attr">size:</span><span class="number">4</span>;	<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line">	<span class="symbol">field:</span>pid_t old_pid;	<span class="attr">offset:</span><span class="number">16</span>;	<span class="attr">size:</span><span class="number">4</span>;	<span class="attr">signed:</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">print <span class="attr">fmt:</span> <span class="string">&quot;filename=%s pid=%d old_pid=%d&quot;</span>, __get_str(filename), REC-&gt;pid, REC-&gt;old_pid</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;tracepoint:sched:sched_process_exec &#123;printf(&quot;exec by %s\n&quot;, comm); &#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Add USDT instrumentation</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="string">&quot;folly/tracing/StaticTracepoint.h&quot;</span></span></span><br><span class="line">readref -n usdt_sample_lib1/libusdt_sample_lib1.so</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;usdt:/tmp/tick:loop &#123;printf (&quot;got: %d\n&quot;, arg0); &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="bcc-tools-1"><a href="#bcc-tools-1" class="headerlink" title="bcc tools"></a>bcc tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">runqslower is BCC tools that lists instance of run queue latency exceeding a configurable threshold and show the process that suffered the latency and its duration</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./runqslower         <span class="comment"># trace run queue latency higher than 10000 us (default)</span></span><br><span class="line">    ./runqslower 1000    <span class="comment"># trace run queue latency higher than 1000 us</span></span><br><span class="line">    ./runqslower -p 123  <span class="comment"># trace pid 123 only</span></span><br><span class="line">[root@test-2643a /usr/share/bcc/tools]<span class="comment"># ./runqslower</span></span><br><span class="line">Tracing run queue latency higher than 10000 us</span><br><span class="line">TIME     COMM             PID           LAT(us)</span><br><span class="line">00:20:20 bwa              5836            22182</span><br><span class="line">00:20:22 sh               5844            12056</span><br><span class="line">00:20:22 bwa              5838            12061</span><br><span class="line">00:20:22 bwa              5835            13001</span><br><span class="line">00:20:22 bwa              5835            12109</span><br><span class="line"></span><br><span class="line">show the distribution of on-cpu time <span class="keyword">for</span> each thread wakeup</span><br><span class="line">tracing schduler contect switch events</span><br><span class="line">$ ./cpudist</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 209      |                                        |</span><br><span class="line">         2 -&gt; 3          : 16066    |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 125262   |****************************************|</span><br><span class="line">         8 -&gt; 15         : 59764    |*******************                     |</span><br><span class="line">        16 -&gt; 31         : 13689    |****                                    |</span><br><span class="line">        32 -&gt; 63         : 2320     |                                        |</span><br><span class="line"></span><br><span class="line"><span class="comment">#trace dd write</span></span><br><span class="line">$ ./cpudist -m -p 3826757</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     msecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 190      |****************************************|</span><br><span class="line">$ ./cpudist -p 3826757</span><br><span class="line">Tracing on-CPU time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 11       |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 35       |***************                         |</span><br><span class="line">         8 -&gt; 15         : 41       |******************                      |</span><br><span class="line">        16 -&gt; 31         : 36       |****************                        |</span><br><span class="line">        32 -&gt; 63         : 88       |****************************************|</span><br><span class="line">        64 -&gt; 127        : 32       |**************                          |</span><br><span class="line">       128 -&gt; 255        : 25       |***********                             |</span><br><span class="line">       256 -&gt; 511        : 13       |*****                                   |</span><br><span class="line">       512 -&gt; 1023       : 6        |**                                      |</span><br><span class="line">      1024 -&gt; 2047       : 2        |                                        |</span><br><span class="line"></span><br><span class="line"><span class="comment"># stack tracing as a list of function</span></span><br><span class="line">$ ./profile -p 3826757</span><br><span class="line">Sampling at 49 Hertz of PID 3826757 by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    b<span class="string">&#x27;_raw_spin_lock&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;_raw_spin_lock&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;dmu_buf_will_dirty_impl&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_attr_op&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_bulk_update_impl&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;sa_bulk_update&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b<span class="string">&#x27;__slab_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;__slab_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;kmem_cache_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;spl_kmem_cache_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_hdr_alloc&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_alloc_buf&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;arc_loan_buf&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b<span class="string">&#x27;dmu_tx_hold_sa&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;dmu_tx_hold_sa&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_write_common_iovec&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;zpl_iter_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;new_sync_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;vfs_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;ksys_write&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;do_syscall_64&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span></span><br><span class="line">    __libc_write</span><br><span class="line">    -                dd (3826757)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">show the <span class="built_in">read</span> requested size since entry to the syscall was <span class="keyword">in</span> instrumented</span><br><span class="line"></span><br><span class="line">$ ./argdist -H <span class="string">&#x27;t:syscalls:sys_exit_read():int:args-&gt;ret&#x27;</span></span><br><span class="line">[00:36:40]</span><br><span class="line">     args-&gt;ret           : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 1        |                                        |</span><br><span class="line">        16 -&gt; 31         : 0        |                                        |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 0        |                                        |</span><br><span class="line">       128 -&gt; 255        : 0        |                                        |</span><br><span class="line">       256 -&gt; 511        : 0        |                                        |</span><br><span class="line">       512 -&gt; 1023       : 0        |                                        |</span><br><span class="line">      1024 -&gt; 2047       : 0        |                                        |</span><br><span class="line">      2048 -&gt; 4095       : 0        |                                        |</span><br><span class="line">      4096 -&gt; 8191       : 0        |                                        |</span><br><span class="line">      8192 -&gt; 16383      : 3584     |****************************************|</span><br><span class="line"></span><br><span class="line">$  bpftrace -lv <span class="string">&#x27;tracepoint:syscalls:sys_exit_write&#x27;</span></span><br><span class="line">tracepoint:syscalls:sys_exit_write</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    long ret;</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_exit_write &#123; @ = hist(args-&gt;ret) &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">c^C</span><br><span class="line"></span><br><span class="line">@:</span><br><span class="line">[1]                    2 |                                                    |</span><br><span class="line">[2, 4)                 0 |                                                    |</span><br><span class="line">[4, 8)                 0 |                                                    |</span><br><span class="line">[8, 16)               45 |@                                                   |</span><br><span class="line">[16, 32)              18 |                                                    |</span><br><span class="line">[32, 64)               1 |                                                    |</span><br><span class="line">[64, 128)              0 |                                                    |</span><br><span class="line">[128, 256)             0 |                                                    |</span><br><span class="line">[256, 512)             0 |                                                    |</span><br><span class="line">[512, 1K)              0 |                                                    |</span><br><span class="line">[1K, 2K)               0 |                                                    |</span><br><span class="line">[2K, 4K)               0 |                                                    |</span><br><span class="line">[4K, 8K)               0 |                                                    |</span><br><span class="line">[8K, 16K)              0 |                                                    |</span><br><span class="line">[16K, 32K)             0 |                                                    |</span><br><span class="line">[32K, 64K)             0 |                                                    |</span><br><span class="line">[64K, 128K)            0 |                                                    |</span><br><span class="line">[128K, 256K)           0 |                                                    |</span><br><span class="line">[256K, 512K)           0 |                                                    |</span><br><span class="line">[512K, 1M)             0 |                                                    |</span><br><span class="line">[1M, 2M)            1558 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">$ ./funccount -i 1  <span class="string">&#x27;tcp_*&#x27;</span></span><br><span class="line">Tracing 282 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;tcp_*&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">tcp_drop                                    1</span><br><span class="line">tcp_validate_incoming                       1</span><br><span class="line">tcp_send_dupack                             1</span><br><span class="line">tcp_oow_rate_limited                        1</span><br><span class="line">tcp_write_wakeup                            3</span><br><span class="line">tcp_xmit_probe_skb                          3</span><br><span class="line">tcp_delack_timer                            4</span><br><span class="line">tcp_delack_timer_handler                    6</span><br><span class="line">tcp_write_timer                             6</span><br><span class="line">tcp_poll                                    6</span><br><span class="line">tcp_keepalive_timer                         7</span><br><span class="line">tcp_write_timer_handler                     7</span><br><span class="line">tcp_try_rmem_schedule                       7</span><br><span class="line">tcp_init_cwnd                               8</span><br><span class="line">tcp_urg                                    12</span><br><span class="line">tcp_data_queue                             15</span><br><span class="line">tcp_check_space                            30</span><br><span class="line">tcp_set_skb_tso_segs                       38</span><br><span class="line">tcp_nagle_check                            38</span><br><span class="line">tcp_ack                                    42</span><br><span class="line">tcp_stream_memory_free                     44</span><br><span class="line">tcp_send_mss                               54</span><br><span class="line">tcp_init_tso_segs                          54</span><br><span class="line">tcp_wfree                                  57</span><br><span class="line">tcp_event_new_data_sent                    72</span><br><span class="line"></span><br><span class="line">$ ./funccount -i 1  <span class="string">&#x27;get_page_from_freelist&#x27;</span></span><br><span class="line">Tracing 1 <span class="built_in">functions</span> <span class="keyword">for</span> <span class="string">&quot;get_page_from_freelist&quot;</span>... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">get_page_from_freelist                  14785</span><br><span class="line"></span><br><span class="line">FUNC                                    COUNT</span><br><span class="line">get_page_from_freelist                   7397</span><br><span class="line"></span><br><span class="line">$ ./execsnoop</span><br><span class="line">PCOMM            PID    PPID   RET ARGS</span><br><span class="line">ps               205430 205429   0 /usr/bin/ps aux</span><br><span class="line">grep             205431 205429   0 /usr/bin/grep nobody</span><br><span class="line">awk              205432 205429   0 /usr/bin/awk <span class="variable">$3</span>&gt;0 &#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;</span><br><span class="line">tail             205434 205429   0 /usr/bin/tail -n 1</span><br><span class="line">ls               205436 205435   0 /usr/bin/ls /proc/204067/fd</span><br><span class="line">grep             205437 205435   0 /usr/bin/grep -v dev</span><br><span class="line">grep             205438 205435   0 /usr/bin/grep -v socket</span><br><span class="line">wc               205439 205435   0 /usr/bin/wc -l</span><br><span class="line">sleep            205440 210303   0 /usr/bin/sleep 5</span><br><span class="line"></span><br><span class="line">$ ./syscount -p 204067</span><br><span class="line">Tracing syscalls, printing top 10... Ctrl+C to quit.</span><br><span class="line">^C[12:26:18]</span><br><span class="line">SYSCALL                   COUNT</span><br><span class="line">sched_yield              187351</span><br><span class="line"><span class="built_in">read</span>                      26216</span><br><span class="line">mprotect                   7533</span><br><span class="line">futex                      1863</span><br><span class="line">write                        24</span><br><span class="line"></span><br><span class="line">$ ./profile -F 49 -U -p 204067</span><br><span class="line">Sampling at 49 Hertz of PID 204067 by user stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    ParCompactionManager::follow_marking_stacks()</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    ParallelTaskTerminator::offer_termination(TerminatorTerminator*)</span><br><span class="line">    StealMarkingTask::do_it(GCTaskManager*, unsigned int)</span><br><span class="line">    GCTaskThread::run()</span><br><span class="line">    java_start(Thread*)</span><br><span class="line">    start_thread</span><br><span class="line">    -                java (204067)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">$ ./trace <span class="string">&#x27;c:malloc &quot;size = %d&quot;, arg1&#x27;</span></span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 100</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 22</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 32</span><br><span class="line">338289  338289  qemu-kvm        malloc           size = 22</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 100</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 22</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 32</span><br><span class="line">338619  338619  qemu-kvm        malloc           size = 22</span><br><span class="line">338098  338124  CPU 1/KVM       malloc           size = 32</span><br><span class="line"></span><br><span class="line">$ ./trace /lib64/libpthread-2.28.so:pthread_create</span><br><span class="line">PID     TID     COMM            FUNC</span><br><span class="line">338161  338161  qemu-kvm        pthread_create</span><br></pre></td></tr></table></figure>


<h3 id="Memroy-allocators"><a href="#Memroy-allocators" class="headerlink" title="Memroy allocators"></a>Memroy allocators</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Process                         kernel          Slab allocator    page allocator</span><br><span class="line">  |                               |                   |                |</span><br><span class="line">Segments    libc allocator     ext4/scsi module-----caches-----------free lists-------DRAM(physical)</span><br><span class="line">  |             |                                                      |</span><br><span class="line">Heap----------memory----------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Application                    virtual mem                              </span><br><span class="line">   |                               |   ----------------------------------------physical mem</span><br><span class="line">   |&lt;-----------------------------||   |                                            ^</span><br><span class="line">Allocator (libc)                  ||   V                                            |</span><br><span class="line">1.malloc()--------2a blk---------&gt;heap(from high to low)----&gt;3.lookup--mmu--&gt;4.page fault</span><br><span class="line">  free()       |                   |  |</span><br><span class="line">  realloc()    |                   V  |</span><br><span class="line">  calloc()     |                      ------------------5.page out------------&gt;swap device</span><br><span class="line">               |</span><br><span class="line">               -2b mmap/munmap---&gt;mappings                          </span><br><span class="line">                             (processs address space)</span><br></pre></td></tr></table></figure>
<p>tcmalloc and jemalloc provide their own allocator along with garbage collection</p>
<p>trace PMCs for memory I/O events</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$  perf <span class="built_in">stat</span> -e LLC-loads,LLC-load-misses -a -I 1000</span><br><span class="line"><span class="comment">#           time             counts unit events</span></span><br><span class="line">     1.005137445        559,247,421      LLC-loads</span><br><span class="line">     1.005137445        269,259,408      LLC-load-misses           <span class="comment">#   48.15% of all LL-cache hits</span></span><br><span class="line">     2.007241604        551,600,432      LLC-loads</span><br><span class="line">     2.007241604        267,976,111      LLC-load-misses           <span class="comment">#   48.25% of all LL-cache hits</span></span><br><span class="line">     3.009090791        552,723,650      LLC-loads</span><br><span class="line">     3.009090791        268,186,466      LLC-load-misses           <span class="comment">#   48.36% of all LL-cache hits</span></span><br><span class="line">     4.011116721        560,135,096      LLC-loads</span><br><span class="line">     4.011116721        268,988,337      LLC-load-misses           <span class="comment">#   48.39% of all LL-cache hits</span></span><br><span class="line">$ perf record -e L1-dcache-load-misses -c 100000 -a</span><br><span class="line">$ perf report -n --stdio</span><br></pre></td></tr></table></figure>

<h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">page cache &lt;--&gt; filesystem              RAW block device</span><br><span class="line">                   |                        |</span><br><span class="line">                   |                        |</span><br><span class="line">                   --------------------------</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     block device interface</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     Volume manager (<span class="keyword">if</span> used)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                     Device Mapper (<span class="keyword">if</span> used)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                         Block layer </span><br><span class="line">            classic scheduler  or  Multi queue scheduler</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                    Host Bus adaptor Driver(scsi)</span><br><span class="line">                              |</span><br><span class="line">                              V</span><br><span class="line">                        Disk devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># blk_fill_rwbs</span></span><br><span class="line">R: <span class="built_in">read</span>    </span><br><span class="line">W: Write    </span><br><span class="line">M: Metadata    </span><br><span class="line">S: Synchronous</span><br><span class="line">A: Readahead</span><br><span class="line">F: Flush or force unit access</span><br><span class="line">D: Discard</span><br><span class="line">E: Erase</span><br><span class="line">N: None</span><br><span class="line"></span><br><span class="line">IO scduler</span><br><span class="line">Noop/Dealine/CFQ</span><br><span class="line">blk-mq (linux 3.13)</span><br></pre></td></tr></table></figure>
<p>In the event of a system failure while there are active writes, the parity of a stripe may become inconsistent with the data. If this is not detected and repaired before a disk or block fails, data loss may ensue as incorrect parity will be used to reconstruct the missing block in that stripe. This potential vulnerability is sometimes known as the write hole. Battery-backed cache and similar techniques are commonly used to reduce the window of opportunity for this to occur. The same issue occurs for RAID-6.</p>
<h4 id="storage-example"><a href="#storage-example" class="headerlink" title="storage example"></a><a target="_blank" rel="noopener" href="https://www.informit.com/articles/article.aspx?p=2995360&seqNum=3#">storage example</a></h4><p>This tool needs to store a timestamp at the start of each I/O to record its duration (latency)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">################</span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @start[args-&gt;dev, args-&gt;sector] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/@start[args-&gt;dev, args-&gt;sector]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[args-&gt;dev, args-&gt;sector]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[args-&gt;dev, args-&gt;sector]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###############</span><br><span class="line"></span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                  |</span><br><span class="line">[<span class="number">128</span>, <span class="number">256</span>)             <span class="number">1</span> |@@@@@@@@@@@@@@@@@                                   |</span><br><span class="line">[<span class="number">256</span>, <span class="number">512</span>)             <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">512</span>, <span class="number">1</span>K)              <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">1</span>K, <span class="number">2</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">4</span>K, <span class="number">8</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">8</span>K, <span class="number">16</span>K)              <span class="number">3</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>


<p>Traces the full duration of the I/O</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12s %-16s %-6s %7s\n&quot;</span>, <span class="string">&quot;TIME(ms)&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;LAT(ms)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">        @iopid[arg0] = pid;</span><br><span class="line">        @iocomm[arg0] = comm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0] != <span class="number">0</span> &amp;&amp; @iopid[arg0] != <span class="number">0</span> &amp;&amp; @iocomm[arg0] != <span class="string">&quot;&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        $now = nsecs;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12u %-16s %-6d %7d\n&quot;</span>,</span><br><span class="line">            elapsed / <span class="number">1000000</span>, @iocomm[arg0], @iopid[arg0],</span><br><span class="line">            ($now - @start[arg0]) / <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span>(@start[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@iopid[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@iocomm[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">        clear(@iopid);</span><br><span class="line">        clear(@iocomm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME(ms)     <span class="function">COMM             PID    <span class="title">LAT</span><span class="params">(ms)</span></span></span><br><span class="line"><span class="function">4763         vim              55675        0</span></span><br><span class="line"><span class="function">4763         vim              55675        0</span></span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br><span class="line"><span class="number">6268</span>         kworker/u434:<span class="number">1</span>   <span class="number">46458</span>        <span class="number">0</span></span><br></pre></td></tr></table></figure>


<p>biosize</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @[args-&gt;comm] = hist(args-&gt;bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nI/O size (bytes) histograms by process name:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">3</span> probes...</span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">I/<span class="function">O <span class="title">size</span> <span class="params">(bytes)</span> histograms by process name:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line">@[kworker/u434:1]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[vim]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[kworker/<span class="number">21</span>:<span class="number">2</span>]:</span><br><span class="line">[<span class="number">8</span>, <span class="number">16</span>)                <span class="number">3</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>

<p>seeksize<br>show how many sectors that processes are requesting the disks to seek</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        printf(<span class="string">&quot;Tracing block I/O requested seeks... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (@last[args-&gt;dev]) &#123;</span><br><span class="line">                <span class="comment">// calculate requested seek distance</span></span><br><span class="line">                $last = @last[args-&gt;dev];</span><br><span class="line">                $dist = (args-&gt;sector - $last) &gt; <span class="number">0</span> ?</span><br><span class="line">                    args-&gt;sector - $last : $last - args-&gt;sector;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// store details</span></span><br><span class="line">                @sectors[args-&gt;comm] = hist($dist);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// save last requested position of disk head</span></span><br><span class="line">        @last[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">clear</span>(@last);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">3</span> probes...</span><br><span class="line">Tracing block I/O requested seeks... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@sectors[bash]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/<span class="number">15</span>:<span class="number">1</span>]:</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/u433:<span class="number">0</span>]:</span><br><span class="line">[<span class="number">256</span>M, <span class="number">512</span>M)           <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[vim]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[xfsaild/sda3]:</span><br><span class="line">[<span class="number">128</span>M, <span class="number">256</span>M)           <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[sync]:</span><br><span class="line">(..., <span class="number">0</span>)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[<span class="number">0</span>]                    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>

<p>biopattern<br>identify the pattern of I/O: random or sequential</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %5s %5s %8s %10s\n&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;%RND&quot;</span>, <span class="string">&quot;%SEQ&quot;</span>, <span class="string">&quot;COUNT&quot;</span>,</span><br><span class="line">            <span class="string">&quot;KBYTES&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (@lastsector[args-&gt;dev] == args-&gt;sector) &#123;</span><br><span class="line">                @sequential++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @random++;</span><br><span class="line">        &#125;</span><br><span class="line">        @bytes = @bytes + args-&gt;nr_sector * <span class="number">512</span>;</span><br><span class="line">        @lastsector[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interval:s:<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">        $count = @random + @sequential;</span><br><span class="line">        $div = $count;</span><br><span class="line">        <span class="keyword">if</span> ($div == <span class="number">0</span>) &#123;</span><br><span class="line">                $div = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%5d %5d %8d %10d\n&quot;</span>, @random * <span class="number">100</span> / $div,</span><br><span class="line">            @sequential * <span class="number">100</span> / $div, $count, @bytes / <span class="number">1024</span>);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@lastsector);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME      %RND  %SEQ    COUNT     KBYTES</span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">58</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">59</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>         <span class="number">16</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">00</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">01</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">03</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">04</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">05</span>    <span class="number">75</span>    <span class="number">25</span>        <span class="number">8</span>         <span class="number">48</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">06</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">07</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">08</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>biostacks</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O with init stacks. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @reqstack[arg0] = kstack;</span><br><span class="line">        @reqts[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@reqts[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs[@reqstack[arg0]] = hist(nsecs - @reqts[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@reqstack[arg0]);</span><br><span class="line">        <span class="keyword">delete</span>(@reqts[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@reqstack); clear(@reqts);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">5</span> probes...</span><br><span class="line">Tracing block I/O with init stacks. Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs[</span><br><span class="line">    blk_account_io_start+<span class="number">1</span></span><br><span class="line">    generic_make_request+<span class="number">327</span></span><br><span class="line">    submit_bio+<span class="number">112</span></span><br><span class="line">    xfs_submit_ioend.isra<span class="number">.12</span>+<span class="number">97</span></span><br><span class="line">    xfs_vm_writepages+<span class="number">127</span></span><br><span class="line">    do_writepages+<span class="number">33</span></span><br><span class="line">    __filemap_fdatawrite_range+<span class="number">101</span></span><br><span class="line">    filemap_write_and_wait_range+<span class="number">65</span></span><br><span class="line">    xfs_file_fsync+<span class="number">102</span></span><br><span class="line">    do_fsync+<span class="number">103</span></span><br><span class="line">    sys_fsync+<span class="number">16</span></span><br><span class="line">    system_call_fastpath+<span class="number">37</span></span><br><span class="line">]:</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>

<p>bioerr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">perf record -e block:block_rq_complete --filter &#x27;error != 0&#x27;</span><br><span class="line">cat /sys/kernel/debug/tracing/events/block/block_rq_complete/format</span><br><span class="line">bpftrace -e &#x27;kprobe:blk_status_to_errno /arg0/ &#123; @[arg0]++ &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue /args-&gt;dev == 0/ &#123; @[kstack]++ &#125;&#x27;</span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O errors. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/args-&gt;error != <span class="number">0</span>/</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;device: %d,%d, sector: %d, bytes: %d, flags: %s, error: %d\n&quot;</span>,</span><br><span class="line">            args-&gt;dev &gt;&gt; <span class="number">20</span>, args-&gt;dev &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">20</span>) - <span class="number">1</span>), args-&gt;sector,</span><br><span class="line">            args-&gt;nr_sector * <span class="number">512</span>, args-&gt;rwbs, args-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_OK 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NOTSUPP         ((__force blk_status_t)1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TIMEOUT         ((__force blk_status_t)2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NOSPC           ((__force blk_status_t)3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TRANSPORT       ((__force blk_status_t)4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_TARGET          ((__force blk_status_t)5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_NEXUS           ((__force blk_status_t)6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_MEDIUM          ((__force blk_status_t)7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_PROTECTION      ((__force blk_status_t)8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_RESOURCE        ((__force blk_status_t)9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLK_STS_IOERR           ((__force blk_status_t)10)</span></span><br></pre></td></tr></table></figure>

<p>mdflush<br>for tracing flush events from md</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/genhd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing md flush events... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %-6s %-16s %s&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;DEVICE&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:md_flush_request</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-6d %-16s %s\n&quot;</span>, pid, comm,</span><br><span class="line">            ((struct bio *)arg1)-&gt;bi_disk-&gt;disk_name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iosched<br>traces the time that requests were queued in the I/O scheduler</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;linux/blkdev.h&gt;</span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O schedulers. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:__elv_add_request</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg1] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="variable">$r</span> = (struct request *)arg0;</span><br><span class="line">        @usecs[<span class="variable">$r</span>-&gt;q-&gt;elevator-&gt;<span class="built_in">type</span>-&gt;elevator_name] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / 1000);</span><br><span class="line">        delete(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching 5 probes...</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Warning: could not attach probe kprobe:blk_start_request, skipping.</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Error attaching probe: <span class="string">&#x27;kprobe:__elv_add_request&#x27;</span></span><br></pre></td></tr></table></figure>

<p>scsilatency<br> to trace SCSI commands with latency distributions</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;scsi/scsi_cmnd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing scsi latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// SCSI opcodes from scsi/scsi_proto.h; add more mappings if desired:</span></span><br><span class="line">        @opcode[<span class="number">0x00</span>] = <span class="string">&quot;TEST_UNIT_READY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x03</span>] = <span class="string">&quot;REQUEST_SENSE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x08</span>] = <span class="string">&quot;READ_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0a</span>] = <span class="string">&quot;WRITE_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0b</span>] = <span class="string">&quot;SEEK_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x12</span>] = <span class="string">&quot;INQUIRY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x18</span>] = <span class="string">&quot;ERASE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x28</span>] = <span class="string">&quot;READ_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2a</span>] = <span class="string">&quot;WRITE_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2b</span>] = <span class="string">&quot;SEEK_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x35</span>] = <span class="string">&quot;SYNCHRONIZE_CACHE&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_init_io</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_done,</span><br><span class="line">kprobe:scsi_mq_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $cmnd = (struct scsi_cmnd *)arg0;</span><br><span class="line">        $opcode = *$cmnd-&gt;req.cmd &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$opcode, @opcode[$opcode]] = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start); clear(@opcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@usecs[<span class="number">74</span>, ]:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">9</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>

<p>scsiresult</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_OK          0x00    <span class="comment">/* NO error                                */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_NO_CONNECT  0x01    <span class="comment">/* Couldn&#x27;t connect before timeout period  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_BUS_BUSY    0x02    <span class="comment">/* BUS stayed busy through time out period */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_TIME_OUT    0x03    <span class="comment">/* TIMED OUT for other reason              */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DID_BAD_TARGET  0x04    <span class="comment">/* BAD target.    </span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">#!/usr/bin/bpftrace</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">BEGIN</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        printf(&quot;Tracing scsi command results. Hit Ctrl-C to end.\n&quot;);</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">        // host byte codes, from include/scsi/scsi.h:</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x00] = &quot;DID_OK&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x01] = &quot;DID_NO_CONNECT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x02] = &quot;DID_BUS_BUSY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x03] = &quot;DID_TIME_OUT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x04] = &quot;DID_BAD_TARGET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x05] = &quot;DID_ABORT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x06] = &quot;DID_PARITY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x07] = &quot;DID_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x08] = &quot;DID_RESET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x09] = &quot;DID_BAD_INTR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0a] = &quot;DID_PASSTHROUGH&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0b] = &quot;DID_SOFT_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0c] = &quot;DID_IMM_RETRY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0d] = &quot;DID_REQUEUE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0e] = &quot;DID_TRANSPORT_DISRUPTED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x0f] = &quot;DID_TRANSPORT_FAILFAST&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x10] = &quot;DID_TARGET_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x11] = &quot;DID_NEXUS_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x12] = &quot;DID_ALLOC_FAILURE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @host[0x13] = &quot;DID_MEDIUM_ERROR&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">        // status byte codes, from include/scsi/scsi_proto.h:</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x00] = &quot;SAM_STAT_GOOD&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x02] = &quot;SAM_STAT_CHECK_CONDITION&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x04] = &quot;SAM_STAT_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x08] = &quot;SAM_STAT_BUSY&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x10] = &quot;SAM_STAT_INTERMEDIATE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x14] = &quot;SAM_STAT_INTERMEDIATE_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x18] = &quot;SAM_STAT_RESERVATION_CONFLICT&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x22] = &quot;SAM_STAT_COMMAND_TERMINATED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x28] = &quot;SAM_STAT_TASK_SET_FULL&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x30] = &quot;SAM_STAT_ACA_ACTIVE&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @status[0x40] = &quot;SAM_STAT_TASK_ABORTED&quot;;</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        @[@host[(args-&gt;result &gt;&gt; 16) &amp; 0xff], @status[args-&gt;result &amp; 0xff]] =</span></span></span><br><span class="line"><span class="meta"><span class="comment">            count();</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">END</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#123;</span></span></span><br><span class="line"><span class="meta"><span class="comment">        clear(@status);</span></span></span><br><span class="line"><span class="meta"><span class="comment">        clear(@host);</span></span></span><br><span class="line"><span class="meta"><span class="comment">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">Attaching 3 probes...</span></span></span><br><span class="line"><span class="meta"><span class="comment">Tracing scsi command results. Hit Ctrl-C to end.</span></span></span><br><span class="line"><span class="meta"><span class="comment">^C</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">@[DID_OK, SAM_STAT_CHECK_CONDITION]: 1</span></span></span><br><span class="line"><span class="meta"><span class="comment">@[DID_OK, SAM_STAT_GOOD]: 1596</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">driver_byte &lt;&lt; 24 | host_byte &lt;&lt; 16 | msg_byte &lt;&lt; 8 | status_byte</span></span></span><br><span class="line"><span class="meta"><span class="comment"></span></span></span><br><span class="line"><span class="meta"><span class="comment">bpftrace -lv t:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int host_no;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int channel;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int id;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int lun;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    int result;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int opcode;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int cmd_len;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int data_sglen;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned int prot_sglen;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    unsigned char prot_op;</span></span></span><br><span class="line"><span class="meta"><span class="comment">    __data_loc unsigned char[] cmnd;</span></span></span><br></pre></td></tr></table></figure>

<p>nvmelatency<br>traces the nvme storage driver and shows command latencies by disk and nvme command opcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> bpftrace -e &#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/blkdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/nvme.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing nvme command latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// from linux/nvme.h:</span></span><br><span class="line">        @ioopcode[<span class="number">0x00</span>] = <span class="string">&quot;nvme_cmd_flush&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x01</span>] = <span class="string">&quot;nvme_cmd_write&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x02</span>] = <span class="string">&quot;nvme_cmd_read&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x04</span>] = <span class="string">&quot;nvme_cmd_write_uncor&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x05</span>] = <span class="string">&quot;nvme_cmd_compare&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x08</span>] = <span class="string">&quot;nvme_cmd_write_zeroes&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x09</span>] = <span class="string">&quot;nvme_cmd_dsm&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0d</span>] = <span class="string">&quot;nvme_cmd_resv_register&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0e</span>] = <span class="string">&quot;nvme_cmd_resv_report&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x11</span>] = <span class="string">&quot;nvme_cmd_resv_acquire&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x15</span>] = <span class="string">&quot;nvme_cmd_resv_release&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_setup_cmd</span><br><span class="line">&#123;</span><br><span class="line">        $req = (struct request *)arg1;</span><br><span class="line">        <span class="keyword">if</span> ($req-&gt;rq_disk) &#123;</span><br><span class="line">                @start[arg1] = nsecs;</span><br><span class="line">                @cmd[arg1] = arg2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @admin_commands = count();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_complete_rq</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $req = (struct request *)arg0;</span><br><span class="line">        $cmd = (struct nvme_command *)@cmd[arg0];</span><br><span class="line">        $disk = $req-&gt;rq_disk;</span><br><span class="line">        $opcode = $cmd-&gt;common.opcode &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$disk-&gt;disk_name, @ioopcode[$opcode]] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">delete</span>(@start[tid]); <span class="keyword">delete</span>(@cmd[tid]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@ioopcode); clear(@start); clear(@cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e &#x27;tracepoint:block:* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;kprobe:scsi* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @bytes = hist(args-&gt;bytes); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = sum(args-&gt;bytes); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_complete /args-&gt;error/ &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dev %d type %s error %d\n&quot;</span>, args-&gt;dev, args-&gt;rwbs, args-&gt;error); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;k:blk_start_plug &#123; @ts[arg0] = nsecs; &#125;</span><br><span class="line">    k:blk_flush_plug_list /@ts[arg0]/ &#123; @plug_ns = hist(nsecs - @ts[arg0]);</span><br><span class="line">    <span class="keyword">delete</span>(@ts[arg0]); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;k:blk_mq_start_request &#123; @swqueues = lhist(cpu, 0, 100, 1); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="comment">//IO type</span></span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = count(); &#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>not work in centos kernel</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/dcache.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_unlink,tracepoint:syscalls:sys_enter_unlinkat &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s deleted by command &#x27;%s&#x27; with pid %d\n&quot;</span>,</span><br><span class="line">            str(args-&gt;pathname), comm, pid);</span><br><span class="line">    $p = curtask-&gt;real_parent;</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        $i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; ... whose parent is &#x27;%s&#x27; command with pid %d\n&quot;</span>,</span><br><span class="line">               $p-&gt;comm,</span><br><span class="line">               $p-&gt;tgid);</span><br><span class="line">        $p = $p-&gt;parent;</span><br><span class="line">        <span class="keyword">if</span> ($p == <span class="number">0</span> || $p-&gt;tgid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WARNING: Kernel does <span class="keyword">not</span> support bounded loops. Depending on LLVMs loop unroll to generate loadable code.</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    ~~~~~</span><br><span class="line">Attaching <span class="number">2</span> probes...</span><br><span class="line"></span><br><span class="line">Error <span class="built_in">log</span>:</span><br><span class="line">back-edge from insn <span class="number">162</span> to <span class="number">78</span></span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Ginger</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/07/24/bpftrace/">http://yoursite.com/2020/07/24/bpftrace/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/debug/">debug</a><a class="post-meta__tags" href="/tags/trace/">trace</a></div><div class="post_share"><div class="social-share" data-image="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/11/hello-world/"><img class="prev-cover" src="/img/photo_by_spacex.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Hello World</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/22/network-benchmark-result/"><img class="next-cover" src="https://homerl.github.io/img/kisspng-computer-icons-benchmarking-computer-software-clip-5ad795b068f297.2882681215240780004299.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Network bencharmk results</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2019/10/31/bcc/" title="bcc tools"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-31</div><div class="title">bcc tools</div></div></a></div><div><a href="/2018/11/22/ftrace/" title="ftrace"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-22</div><div class="title">ftrace</div></div></a></div><div><a href="/2020/03/03/gdb/" title="GDB tips"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-03</div><div class="title">GDB tips</div></div></a></div><div><a href="/2018/11/23/perf/" title="perf"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-23</div><div class="title">perf</div></div></a></div><div><a href="/2016/04/01/blktrace/" title="Blktrace"><img class="cover" src="https://homerl.github.io/img/PROPELLER-2-1-1024x1024.png"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2016-04-01</div><div class="title">Blktrace</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2020 By Ginger</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '0b9d5b98d0a972b33cf7',
      clientSecret: '769efc11b32f6c0d03bcbf3ee800dfc4e2690459',
      repo: 'homerl.github.io',
      owner: 'homerl',
      admin: ['homerl'],
      id: 'f0059c5fd9b8cd079e50e55ff669d9e3',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>